<!DOCTYPE  html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Practical Deep Learning for Cloud, Mobile, and Edge</title><meta name="author" content="Anirudh Koul"/><style type="text/css"> * {margin:0; padding:0; text-indent:0; }
 h1 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 30pt; }
 .s1 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 15pt; }
 .s2 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 15pt; }
 .s3 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 15pt; }
 .s4 { color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 15pt; }
 .s5 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 15pt; }
 .s6 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 15pt; }
 .s7 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 15pt; }
 .s8 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 19pt; }
 .s9 { color: black; font-family:"Courier New", monospace; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12pt; }
 .s10 { color: black; font-family:"Courier New", monospace; font-style: italic; font-weight: bold; text-decoration: none; font-size: 12pt; }
 .s11 { color: #737373; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 15pt; }
 .s12 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12.5pt; }
 .s13 { color: #C67070; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 15pt; }
 .s15 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 19pt; }
 .s16 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 26.5pt; }
 .s17 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 .s18 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 .s19 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 11pt; }
 .s20 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 17pt; }
 .s21 { color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 13pt; }
 .s22 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 13pt; }
 .s23 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 17pt; }
 .s25 { color: #737373; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 13pt; }
 .s26 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11pt; }
 .s27 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11pt; }
 .s28 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 10pt; vertical-align: -2pt; }
 .s30 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 .s31 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11pt; vertical-align: 5pt; }
 .s32 { color: black; font-family:"Courier New", monospace; font-style: italic; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 .s33 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 11pt; }
 .s34 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11pt; }
 .s35 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11pt; vertical-align: 6pt; }
 .s36 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 11pt; }
 .s37 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 10pt; vertical-align: -2pt; }
 .s38 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 10pt; vertical-align: -3pt; }
 .s39 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 .s40 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 13pt; }
 .s42 { color: black; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10.5pt; }
 h2 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 29.5pt; }
 .p, p { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14.5pt; margin:0pt; }
 .s43 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt; }
 .s44 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14.5pt; }
 .s45 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14.5pt; }
 .s46 { color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt; }
 .s47 { color: black; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11.5pt; }
 .s48 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 12pt; }
 .s49 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12pt; }
 .s50 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12pt; }
 .s51 { color: #737373; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 14.5pt; }
 .s52 { color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12pt; }
 .s53 { color: black; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9.5pt; }
 .s54 { color: #069; font-family:"Courier New", monospace; font-style: normal; font-weight: bold; text-decoration: none; font-size: 9.5pt; }
 .s55 { color: #0CF; font-family:"Courier New", monospace; font-style: normal; font-weight: bold; text-decoration: none; font-size: 9.5pt; }
 .s56 { color: #000087; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9.5pt; }
 .s57 { color: #C30; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9.5pt; }
 .s58 { color: #F60; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9.5pt; }
 .s59 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11pt; vertical-align: 4pt; }
 .s60 { color: #34586B; font-family:"Courier New", monospace; font-style: italic; font-weight: normal; text-decoration: none; font-size: 9.5pt; }
 .s61 { color: #C0F; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9.5pt; }
 .s63 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14.5pt; }
 .s64 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12pt; }
 .s65 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 12pt; }
 .s66 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12pt; }
 .s68 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11pt; }
 .s69 { color: black; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9.5pt; }
 .s70 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 14.5pt; }
 .s71 { color: black; font-family:"Courier New", monospace; font-style: normal; font-weight: bold; text-decoration: none; font-size: 9.5pt; }
 .s73 { color: black; font-family:"Courier New", monospace; font-style: italic; font-weight: normal; text-decoration: none; font-size: 9.5pt; }
 .s74 { color: #000087; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 .s75 { color: black; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 .s76 { color: #C30; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 .s77 { color: #069; font-family:"Courier New", monospace; font-style: normal; font-weight: bold; text-decoration: none; font-size: 8.5pt; }
 .s78 { color: #F60; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 .s79 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12pt; }
 .s80 { color: #C30; font-family:"Courier New", monospace; font-style: normal; font-weight: bold; text-decoration: none; font-size: 9.5pt; }
 .s81 { color: #000087; font-family:"Courier New", monospace; font-style: italic; font-weight: normal; text-decoration: none; font-size: 9.5pt; }
 .s82 { color: #A00; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9.5pt; }
 h4 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 27.5pt; }
 .s83 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14pt; }
 .s84 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 18pt; }
 .s85 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14pt; }
 .s86 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 11.5pt; }
 .s87 { color: black; font-family:"Courier New", monospace; font-style: italic; font-weight: normal; text-decoration: none; font-size: 11pt; }
 .s88 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14pt; }
 .s89 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 18pt; }
 .s90 { color: black; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11pt; }
 .s91 { color: black; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9pt; }
 .s92 { color: black; font-family:"Courier New", monospace; font-style: italic; font-weight: normal; text-decoration: none; font-size: 9pt; }
 .s93 { color: #737373; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 14pt; }
 .s94 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11.5pt; }
 .s96 { color: #000087; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9pt; }
 .s97 { color: #C30; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9pt; }
 .s99 { color: #000087; font-family:"Courier New", monospace; font-style: normal; font-weight: bold; text-decoration: none; font-size: 9pt; }
 .s100 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14pt; }
 .s102 { color: #34586B; font-family:"Courier New", monospace; font-style: italic; font-weight: normal; text-decoration: none; font-size: 9pt; }
 .s103 { color: #069; font-family:"Courier New", monospace; font-style: normal; font-weight: bold; text-decoration: none; font-size: 9pt; }
 .s107 { color: black; font-family:"Courier New", monospace; font-style: normal; font-weight: bold; text-decoration: none; font-size: 9pt; }
 .s109 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 14pt; }
 .s110 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14pt; }
 .s111 { color: #99F; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9pt; }
 .s112 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 11.5pt; }
 .s113 { color: black; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8pt; }
 .s114 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 11.5pt; }
 .s115 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11.5pt; }
 .s116 { color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 13pt; }
 .s117 { color: black; font-family:"Segoe UI Symbol", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11pt; }
 .s118 { color: black; font-family:"Segoe UI Symbol", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11pt; vertical-align: -5pt; }
 .s119 { color: black; font-family:"Segoe UI Symbol", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11pt; }
 .s120 { color: #309; font-family:"Courier New", monospace; font-style: normal; font-weight: bold; text-decoration: none; font-size: 8.5pt; }
 .s121 { color: #A00; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 .s122 { color: #0CF; font-family:"Courier New", monospace; font-style: normal; font-weight: bold; text-decoration: none; font-size: 8.5pt; }
 .s125 { color: #C0F; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 .s126 { color: #069; font-family:"Courier New", monospace; font-style: normal; font-weight: bold; text-decoration: underline; font-size: 8.5pt; }
 .s127 { color: #C30; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: underline; font-size: 8.5pt; }
 .s128 { color: #34586B; font-family:"Courier New", monospace; font-style: italic; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 .s129 { color: black; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 .s130 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 10pt; }
 .s131 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 .s132 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 .s133 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 .s134 { color: black; font-family:"Courier New", monospace; font-style: normal; font-weight: bold; text-decoration: none; font-size: 8.5pt; }
 .s135 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: bold; text-decoration: none; font-size: 14.5pt; }
 .s136 { color: black; font-family:"Arial Unicode MS", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 .s137 { color: #309; font-family:"Courier New", monospace; font-style: normal; font-weight: bold; text-decoration: none; font-size: 9.5pt; }
 .s138 { color: #309; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9.5pt; }
 .s140 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12pt; }
 .s141 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 25.5pt; }
 .s142 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12.5pt; }
 .s143 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12.5pt; }
 .s144 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 16.5pt; }
 .s145 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 10.5pt; }
 .s146 { color: #737373; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 12.5pt; }
 .s147 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10.5pt; }
 .s148 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12.5pt; }
 .s149 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 10.5pt; }
 .s150 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10.5pt; }
 .s151 { color: black; font-family:"Segoe UI Symbol", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10.5pt; }
 .s152 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 16.5pt; }
 .s153 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 10.5pt; }
 .s154 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10.5pt; }
 .s155 { color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 10.5pt; }
 .s156 { color: black; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 .s159 { color: #C30; font-family:"Courier New", monospace; font-style: normal; font-weight: bold; text-decoration: none; font-size: 8.5pt; }
 .s160 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12.5pt; }
 .s161 { color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12.5pt; }
 .s162 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10.5pt; }
 .s163 { color: black; font-family:"Courier New", monospace; font-style: normal; font-weight: bold; text-decoration: none; font-size: 7.5pt; }
 .s164 { color: black; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10.5pt; }
 .s165 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 25pt; }
 .s166 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 16pt; }
 .s167 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 16pt; }
 .s168 { color: black; font-family:"Courier New", monospace; font-style: italic; font-weight: normal; text-decoration: none; font-size: 8pt; }
 .s169 { color: #069; font-family:"Courier New", monospace; font-style: normal; font-weight: bold; text-decoration: none; font-size: 8pt; }
 .s170 { color: #96F; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8pt; }
 .s172 { color: #34586B; font-family:"Courier New", monospace; font-style: italic; font-weight: normal; text-decoration: none; font-size: 8pt; }
 .s174 { color: #F60; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8pt; }
 .s175 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 12.5pt; }
 .s176 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 10.5pt; }
 .s177 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 20pt; }
 .s178 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 8pt; }
 .s179 { color: #737373; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 10pt; }
 .s180 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8pt; }
 .s181 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 13pt; }
 .s182 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 10pt; }
 .s183 { color: #C67070; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 10pt; }
 .s185 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 8pt; }
 .s186 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 8pt; }
 .s187 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8pt; }
 .s188 { color: black; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 6.5pt; }
 .s190 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 10pt; }
 .s192 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 .s193 { color: black; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 6pt; }
 .s195 { color: black; font-family:"Times New Roman", serif; font-style: normal; font-weight: normal; text-decoration: underline; font-size: 8.5pt; }
 h3 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 29pt; }
 .s196 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 18.5pt; }
 .s197 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 18.5pt; }
 .s198 { color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12pt; }
 .s199 { color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12pt; }
 .s201 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12pt; }
 .s202 { color: black; font-family:"Courier New", monospace; font-style: italic; font-weight: normal; text-decoration: none; font-size: 11.5pt; }
 .s203 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 26pt; }
 .s204 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: bold; text-decoration: none; font-size: 13pt; }
 .s205 { color: #C30; font-family:"Courier New", monospace; font-style: italic; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 .s206 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9.5pt; vertical-align: -3pt; }
 .s207 { color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14pt; }
 .s208 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 15pt; }
 .a, a { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 15pt; }
 .s209 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 15pt; }
 .s210 { color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 15pt; }
 li {display: block; }
 #l1 {padding-left: 0pt;counter-reset: c1 1; }
 #l1> li>*:first-child:before {counter-increment: c1; content: counter(c1, decimal)" "; color: black; font-style: normal; font-weight: normal; text-decoration: none; }
 #l1> li:first-child>*:first-child:before {counter-increment: c1 0;  }
 #l2 {padding-left: 0pt;counter-reset: c2 53; }
 #l2> li>*:first-child:before {counter-increment: c2; content: counter(c1, decimal)"."counter(c2, decimal)" "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11pt; }
 #l2> li:first-child>*:first-child:before {counter-increment: c2 0;  }
 #l3 {padding-left: 0pt;counter-reset: c3 1; }
 #l3> li>*:first-child:before {counter-increment: c3; content: counter(c3, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 #l3> li:first-child>*:first-child:before {counter-increment: c3 0;  }
 li {display: block; }
 #l4 {padding-left: 0pt;counter-reset: d1 1; }
 #l4> li>*:first-child:before {counter-increment: d1; content: counter(d1, decimal)" "; color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 #l4> li:first-child>*:first-child:before {counter-increment: d1 0;  }
 #l5 {padding-left: 0pt;counter-reset: d2 1; }
 #l5> li>*:first-child:before {counter-increment: d2; content: counter(d2, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14.5pt; }
 #l5> li:first-child>*:first-child:before {counter-increment: d2 0;  }
 li {display: block; }
 #l6 {padding-left: 0pt;counter-reset: e1 3; }
 #l6> li>*:first-child:before {counter-increment: e1; content: "("counter(e1, lower-latin)") "; color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12pt; }
 #l6> li:first-child>*:first-child:before {counter-increment: e1 0;  }
 #l7 {padding-left: 0pt;counter-reset: e2 1; }
 #l7> li>*:first-child:before {counter-increment: e2; content: counter(e2, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14.5pt; }
 #l7> li:first-child>*:first-child:before {counter-increment: e2 0;  }
 li {display: block; }
 #l8 {padding-left: 0pt;counter-reset: f1 1; }
 #l8> li>*:first-child:before {counter-increment: f1; content: counter(f1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14.5pt; }
 #l8> li:first-child>*:first-child:before {counter-increment: f1 0;  }
 li {display: block; }
 #l9 {padding-left: 0pt;counter-reset: g1 1; }
 #l9> li>*:first-child:before {counter-increment: g1; content: counter(g1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14.5pt; }
 #l9> li:first-child>*:first-child:before {counter-increment: g1 0;  }
 li {display: block; }
 #l10 {padding-left: 0pt;counter-reset: h1 1; }
 #l10> li>*:first-child:before {counter-increment: h1; content: counter(h1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14pt; }
 #l10> li:first-child>*:first-child:before {counter-increment: h1 0;  }
 li {display: block; }
 #l11 {padding-left: 0pt;counter-reset: i1 1; }
 #l11> li>*:first-child:before {counter-increment: i1; content: counter(i1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14pt; }
 #l11> li:first-child>*:first-child:before {counter-increment: i1 0;  }
 li {display: block; }
 #l12 {padding-left: 0pt;counter-reset: j1 50; }
 #l12> li>*:first-child:before {counter-increment: j1; content: counter(j1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14pt; }
 #l12> li:first-child>*:first-child:before {counter-increment: j1 0;  }
 #l13 {padding-left: 0pt;counter-reset: j2 1; }
 #l13> li>*:first-child:before {counter-increment: j2; content: counter(j2, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14pt; }
 #l13> li:first-child>*:first-child:before {counter-increment: j2 0;  }
 li {display: block; }
 #l14 {padding-left: 0pt;counter-reset: k1 1; }
 #l14> li>*:first-child:before {counter-increment: k1; content: counter(k1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14pt; }
 #l14> li:first-child>*:first-child:before {counter-increment: k1 0;  }
 li {display: block; }
 #l15 {padding-left: 0pt;counter-reset: l1 1; }
 #l15> li>*:first-child:before {counter-increment: l1; content: counter(l1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14.5pt; }
 #l15> li:first-child>*:first-child:before {counter-increment: l1 0;  }
 li {display: block; }
 #l16 {padding-left: 0pt;counter-reset: m1 1; }
 #l16> li>*:first-child:before {counter-increment: m1; content: counter(m1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14.5pt; }
 #l16> li:first-child>*:first-child:before {counter-increment: m1 0;  }
 li {display: block; }
 #l17 {padding-left: 0pt;counter-reset: n1 3; }
 #l17> li>*:first-child:before {counter-increment: n1; content: counter(n1, decimal)") "; color: black; font-style: normal; font-weight: normal; text-decoration: none; }
 #l17> li:first-child>*:first-child:before {counter-increment: n1 0;  }
 #l18 {padding-left: 0pt;counter-reset: n2 1; }
 #l18> li>*:first-child:before {counter-increment: n2; content: counter(n2, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 #l18> li:first-child>*:first-child:before {counter-increment: n2 0;  }
 #l19 {padding-left: 0pt;counter-reset: o1 1; }
 #l19> li>*:first-child:before {counter-increment: o1; content: counter(o1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 #l19> li:first-child>*:first-child:before {counter-increment: o1 0;  }
 #l20 {padding-left: 0pt;counter-reset: p1 0; }
 #l20> li>*:first-child:before {counter-increment: p1; content: counter(p1, decimal)" "; color: black; font-style: normal; font-weight: normal; text-decoration: none; }
 #l20> li:first-child>*:first-child:before {counter-increment: p1 0;  }
 #l21 {padding-left: 0pt;counter-reset: p2 1; }
 #l21> li>*:first-child:before {counter-increment: p2; content: counter(p1, decimal)"."counter(p2, decimal)" "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 #l21> li:first-child>*:first-child:before {counter-increment: p2 0;  }
 #l22 {padding-left: 0pt; }
 #l22> li>*:first-child:before {content: "– "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11pt; }
 #l23 {padding-left: 0pt; }
 #l23> li>*:first-child:before {content: "– "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11pt; }
 #l24 {padding-left: 0pt; }
 #l24> li>*:first-child:before {content: "– "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11pt; }
 #l25 {padding-left: 0pt;counter-reset: p3 1; }
 #l25> li>*:first-child:before {counter-increment: p3; content: counter(p3, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 #l25> li:first-child>*:first-child:before {counter-increment: p3 0;  }
 #l26 {padding-left: 0pt;counter-reset: s1 23; }
 #l26> li>*:first-child:before {counter-increment: s1; content: counter(s1, decimal)". "; color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14.5pt; }
 #l26> li:first-child>*:first-child:before {counter-increment: s1 0;  }
 #l27 {padding-left: 0pt;counter-reset: s2 1; }
 #l27> li>*:first-child:before {counter-increment: s2; content: counter(s2, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12.5pt; }
 #l27> li:first-child>*:first-child:before {counter-increment: s2 0;  }
 #l28 {padding-left: 0pt;counter-reset: t1 1; }
 #l28> li>*:first-child:before {counter-increment: t1; content: counter(t1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12.5pt; }
 #l28> li:first-child>*:first-child:before {counter-increment: t1 0;  }
 #l29 {padding-left: 0pt;counter-reset: u1 1; }
 #l29> li>*:first-child:before {counter-increment: u1; content: counter(u1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12.5pt; }
 #l29> li:first-child>*:first-child:before {counter-increment: u1 0;  }
 #l30 {padding-left: 0pt;counter-reset: v1 1; }
 #l30> li>*:first-child:before {counter-increment: v1; content: counter(v1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12.5pt; }
 #l30> li:first-child>*:first-child:before {counter-increment: v1 0;  }
 #l31 {padding-left: 0pt;counter-reset: w1 11; }
 #l31> li>*:first-child:before {counter-increment: w1; content: counter(w1, lower-latin)" "; color: black; font-style: normal; font-weight: normal; text-decoration: none; }
 #l31> li:first-child>*:first-child:before {counter-increment: w1 0;  }
 #l32 {padding-left: 0pt;counter-reset: w2 13; }
 #l32> li>*:first-child:before {counter-increment: w2; content: counter(w1, lower-latin)"-"counter(w2, lower-latin)" "; color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 11.5pt; }
 #l32> li:first-child>*:first-child:before {counter-increment: w2 0;  }
 #l33 {padding-left: 0pt;counter-reset: w3 1; }
 #l33> li>*:first-child:before {counter-increment: w3; content: counter(w3, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12.5pt; }
 #l33> li:first-child>*:first-child:before {counter-increment: w3 0;  }
 #l34 {padding-left: 0pt;counter-reset: x1 1; }
 #l34> li>*:first-child:before {counter-increment: x1; content: counter(x1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 #l34> li:first-child>*:first-child:before {counter-increment: x1 0;  }
 #l35 {padding-left: 0pt;counter-reset: y1 1; }
 #l35> li>*:first-child:before {counter-increment: y1; content: counter(y1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 #l35> li:first-child>*:first-child:before {counter-increment: y1 0;  }
 #l36 {padding-left: 0pt;counter-reset: z1 1; }
 #l36> li>*:first-child:before {counter-increment: z1; content: counter(z1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 #l36> li:first-child>*:first-child:before {counter-increment: z1 0;  }
 #l37 {padding-left: 0pt;counter-reset: c1 1; }
 #l37> li>*:first-child:before {counter-increment: c1; content: counter(c1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 #l37> li:first-child>*:first-child:before {counter-increment: c1 0;  }
 #l38 {padding-left: 0pt;counter-reset: d1 1; }
 #l38> li>*:first-child:before {counter-increment: d1; content: counter(d1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 #l38> li:first-child>*:first-child:before {counter-increment: d1 0;  }
 #l39 {padding-left: 0pt;counter-reset: e1 1; }
 #l39> li>*:first-child:before {counter-increment: e1; content: counter(e1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 #l39> li:first-child>*:first-child:before {counter-increment: e1 0;  }
 #l40 {padding-left: 0pt;counter-reset: f1 1; }
 #l40> li>*:first-child:before {counter-increment: f1; content: counter(f1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12.5pt; }
 #l40> li:first-child>*:first-child:before {counter-increment: f1 0;  }
 #l41 {padding-left: 0pt;counter-reset: g1 1; }
 #l41> li>*:first-child:before {counter-increment: g1; content: counter(g1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12.5pt; }
 #l41> li:first-child>*:first-child:before {counter-increment: g1 0;  }
 #l42 {padding-left: 0pt;counter-reset: g2 1; }
 #l42> li>*:first-child:before {counter-increment: g2; content: counter(g2, lower-latin)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12.5pt; }
 #l42> li:first-child>*:first-child:before {counter-increment: g2 0;  }
 #l43 {padding-left: 0pt;counter-reset: h1 1; }
 #l43> li>*:first-child:before {counter-increment: h1; content: counter(h1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12.5pt; }
 #l43> li:first-child>*:first-child:before {counter-increment: h1 0;  }
 #l44 {padding-left: 0pt;counter-reset: i1 1; }
 #l44> li>*:first-child:before {counter-increment: i1; content: counter(i1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12.5pt; }
 #l44> li:first-child>*:first-child:before {counter-increment: i1 0;  }
 #l45 {padding-left: 0pt;counter-reset: i2 1; }
 #l45> li>*:first-child:before {counter-increment: i2; content: counter(i2, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12.5pt; }
 #l45> li:first-child>*:first-child:before {counter-increment: i2 0;  }
 #l46 {padding-left: 0pt;counter-reset: j1 1; }
 #l46> li>*:first-child:before {counter-increment: j1; content: counter(j1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12.5pt; }
 #l46> li:first-child>*:first-child:before {counter-increment: j1 0;  }
 #l47 {padding-left: 0pt;counter-reset: k1 1; }
 #l47> li>*:first-child:before {counter-increment: k1; content: counter(k1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 #l47> li:first-child>*:first-child:before {counter-increment: k1 0;  }
 #l48 {padding-left: 0pt;counter-reset: l1 1; }
 #l48> li>*:first-child:before {counter-increment: l1; content: counter(l1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 #l48> li:first-child>*:first-child:before {counter-increment: l1 0;  }
 #l49 {padding-left: 0pt;counter-reset: m1 1; }
 #l49> li>*:first-child:before {counter-increment: m1; content: counter(m1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8pt; }
 #l49> li:first-child>*:first-child:before {counter-increment: m1 0;  }
 #l50 {padding-left: 0pt;counter-reset: n1 1; }
 #l50> li>*:first-child:before {counter-increment: n1; content: counter(n1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 #l50> li:first-child>*:first-child:before {counter-increment: n1 0;  }
 #l51 {padding-left: 0pt;counter-reset: o1 1; }
 #l51> li>*:first-child:before {counter-increment: o1; content: counter(o1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 #l51> li:first-child>*:first-child:before {counter-increment: o1 0;  }
 #l52 {padding-left: 0pt;counter-reset: o2 1; }
 #l52> li>*:first-child:before {counter-increment: o2; content: counter(o2, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14.5pt; }
 #l52> li:first-child>*:first-child:before {counter-increment: o2 0;  }
 li {display: block; }
 #l53 {padding-left: 0pt;counter-reset: p1 1; }
 #l53> li>*:first-child:before {counter-increment: p1; content: counter(p1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14.5pt; }
 #l53> li:first-child>*:first-child:before {counter-increment: p1 0;  }
 li {display: block; }
 #l54 {padding-left: 0pt;counter-reset: q1 1; }
 #l54> li>*:first-child:before {counter-increment: q1; content: counter(q1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14.5pt; }
 #l54> li:first-child>*:first-child:before {counter-increment: q1 0;  }
 li {display: block; }
 #l55 {padding-left: 0pt; }
 #l55> li>*:first-child:before {content: "- "; color: black; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9.5pt; }
 li {display: block; }
 #l56 {padding-left: 0pt;counter-reset: s1 25; }
 #l56> li>*:first-child:before {counter-increment: s1; content: counter(s1, lower-latin)") "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 #l56> li:first-child>*:first-child:before {counter-increment: s1 0;  }
 #l57 {padding-left: 0pt;counter-reset: s2 1; }
 #l57> li>*:first-child:before {counter-increment: s2; content: counter(s2, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 #l57> li:first-child>*:first-child:before {counter-increment: s2 0;  }
 li {display: block; }
 #l58 {padding-left: 0pt;counter-reset: t1 1; }
 #l58> li>*:first-child:before {counter-increment: t1; content: counter(t1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 #l58> li:first-child>*:first-child:before {counter-increment: t1 0;  }
 li {display: block; }
 #l59 {padding-left: 0pt;counter-reset: u1 1; }
 #l59> li>*:first-child:before {counter-increment: u1; content: counter(u1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 #l59> li:first-child>*:first-child:before {counter-increment: u1 0;  }
 li {display: block; }
 #l60 {padding-left: 0pt;counter-reset: v1 1; }
 #l60> li>*:first-child:before {counter-increment: v1; content: counter(v1, decimal)". "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 #l60> li:first-child>*:first-child:before {counter-increment: v1 0;  }
 li {display: block; }
 #l61 {padding-left: 0pt;counter-reset: w1 20; }
 #l61> li>*:first-child:before {counter-increment: w1; content: counter(w1, lower-latin)"- "; color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 14pt; }
 #l61> li:first-child>*:first-child:before {counter-increment: w1 0;  }
 #l62 {padding-left: 0pt;counter-reset: w2 1; }
 #l62> li>*:first-child:before {counter-increment: w2; content: counter(w2, decimal)". "; color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 15pt; }
 #l62> li:first-child>*:first-child:before {counter-increment: w2 0;  }
 table, tbody {vertical-align: top; overflow: visible; }
</style></head><body><p style="text-indent: 0pt;text-align: left;"><span><img width="794" height="1123" alt="image" src="KerasTensorFlow2019/Image_001.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><h1 style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">Practical Deep Learning for Cloud, Mobile, and Edge</h1><p class="s1" style="padding-top: 7pt;padding-left: 52pt;text-indent: 0pt;line-height: 109%;text-align: center;">Real-World AI and Computer-Vision Projects Using Python, Keras, and TensorFlow</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 18pt;text-indent: 0pt;text-align: center;">Anirudh Koul, Siddha Ganju, and Meher Kasam</p><p class="s3" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Practical Deep Learning for Cloud, Mobile, and Edge</p><p class="s1" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">by Anirudh Koul, Siddha Ganju, and Meher Kasam</p><p class="s1" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Copyright © 2020 Anirudh Koul, Siddha Ganju, Meher Kasam. All rights reserved.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Printed in the United States of America.</p><p class="s1" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Published by O’Reilly Media, Inc., 1005 Gravenstein Highway North, Sebastopol, CA 95472.</p><p style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="http://oreilly.com/" class="s6" target="_blank">O’Reilly books may be purchased for educational, business, or sales promotional use. Online editions are also available for most titles (</a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 15pt;">http://oreilly.com</span><a href="mailto:corporate@oreilly.com" class="s6" target="_blank">). For more information, contact our corporate/institutional sales department: 800-998-9938 or </a><a href="mailto:corporate@oreilly.com" class="s5" target="_blank">corporate@oreilly.com</a><a href="mailto:corporate@oreilly.com" class="s6" target="_blank">.</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_002.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_003.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_004.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_005.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_006.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_007.png"/></span></p><p class="s1" style="padding-top: 5pt;padding-left: 37pt;text-indent: 0pt;line-height: 187%;text-align: left;">Acquisitions Editor: Rachel Roumeliotis Development Editor: Nicole Tache Production Editor: Christopher Faucher Copyeditor: Octal Publishing, LLC Proofreader: Christina Edwards Indexer: Judith McConville</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_008.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_009.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_010.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_011.png"/></span></p><p class="s1" style="padding-left: 37pt;text-indent: 0pt;line-height: 187%;text-align: left;">Interior Designer: David Futato Cover Designer: Karen Montgomery Illustrator: Rebecca Demarest October 2019: First Edition</p><p class="s3" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Revision History for the First Edition</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_012.png"/></span></p><p class="s1" style="padding-top: 6pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">2019-10-14: First Release</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s1" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="http://oreilly.com/catalog/errata.csp?isbn=9781492034865" class="s6" target="_blank">See </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 15pt;">http://oreilly.com/catalog/errata.csp?isbn=9781492034865 </span>for release details.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">The O’Reilly logo is a registered trademark of O’Reilly Media, Inc. <i>Practical Deep Learning for Cloud, Mobile, and Edge</i>, the cover image, and related trade dress are trademarks of O’Reilly Media, Inc.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">The views expressed in this work are those of the authors, and do not represent the publisher’s views. While the publisher and the authors have used good faith efforts to ensure that the information and instructions contained in this work are accurate, the publisher and the authors disclaim all responsibility for errors or omissions, including without limitation responsibility for damages resulting from the use of or reliance on this work. Use of the information and instructions contained in this work is at your own risk. If any code samples or other technology this work contains or describes is subject to open source licenses or the intellectual property rights of others, it is your responsibility to ensure that your use thereof complies with such licenses and/or rights.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 144%;text-align: left;">978-1-492-03486-5 [LSI]</p><h1 style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark0">Preface</a><a name="bookmark14">&zwnj;</a></h1><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="588" height="1" alt="image" src="KerasTensorFlow2019/Image_013.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s1" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">We are experiencing a renaissance of artificial intelligence, and everyone and their neighbor wants to be a part of this movement. That’s quite likely why you are browsing through this book. There are tons of books about deep learning out there. So you might ask us, very reasonably, why does this book even exist? We’ll get to that in just a second.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: justify;">During our own deep learning journeys since 2013 (while building products at companies including Microsoft, NVIDIA, Amazon, and Square), we witnessed dramatic shifts in this landscape.</p><p class="s1" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Constantly evolving research was a given and a lack of mature tooling was a reality of life.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">While growing and learning from the community, we noticed a lack of clear guidance on how to convert research to an end product for everyday users. After all, the end user is somewhere in front of a web browser, a smartphone, or an edge device. This often involved countless hours of hacking and experimentation, extensively searching through blogs, GitHub issue threads, and Stack Overflow answers, and emailing authors of packages to get esoteric knowledge, as well as occasional “Aha!” moments. Even the books on the market tended to focus more on theory or how to use a specific tool. The best we could hope to learn from the available books was to build a toy example.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">To fill this gap between theory and practice, we originally started giving talks on taking artificial intelligence from research to the end user with a particular focus on practical applications. The talks were structured to showcase motivating examples, as well as different levels of complexity based on skill level (from a hobbyist to a Google-scale engineer) and effort involved in deploying deep learning in production. We discovered that beginners and experts alike found value in these talks.</p><p class="s1" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Over time, the landscape thankfully became accessible to beginners and more tooling became available. Great online material like Fast.ai and DeepLearning.ai made understanding how to train AI models easier than ever. Books also cornered the market on teaching fundamentals using deep learning frameworks such as TensorFlow and PyTorch. But even with all of this, the wide chasm between theory and production remained largely unaddressed. And we wanted to bridge this gap. Thus, the book you are now reading.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Using approachable language as well as ready-to-run fun projects in computer vision, the book starts off with simple classifiers assuming no knowledge of machine learning and AI, gradually building to add complexity, improve accuracy and speed, scale to millions of users, deploy on a wide variety of hardware and software, and eventually culminate in using reinforcement learning to build a miniature self-driving car.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Nearly every chapter begins with a motivating example, establishes the questions upfront that one might ask through the process of building a solution, and discusses multiple approaches for solving problems, each with varying levels of complexity and effort involved. If you are seeking a quick solution, you might end up just reading a few pages of a chapter and be done. Someone wanting to gain a deeper understanding of the subject should read the entire chapter. Of course, everyone should peruse the case studies included in these chapters for two reasons — they are fun to read and they showcase how people in the industry are using the concepts discussed in the chapter to build real products.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">We also discuss many of the practical concerns faced by deep learning practitioners and industry professionals in building real- world applications using the cloud, browsers, mobile, and edge devices. We compiled a number of practical “tips and tricks,” as well as life lessons in this book to encourage our readers to build applications that can make someone’s day just a little bit better.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1">To the Backend/Frontend/Mobile Software Developer</a><a name="bookmark15">&zwnj;</a></p><p class="s1" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">You are quite likely a proficient programmer already. Even if Python is an unfamiliar language to you, we expect that you will be able to pick it up easily and get started in no time. Best of all, we don’t expect you to have any background in machine learning and AI; that’s what we are here for! We believe that you will gain value from the book’s focus on the following areas:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_014.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_015.png"/></span></p><p class="s1" style="padding-top: 5pt;padding-left: 37pt;text-indent: 0pt;line-height: 187%;text-align: left;">How to build user-facing AI products How to train models quickly</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_016.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_017.png"/></span></p><p class="s1" style="padding-left: 37pt;text-indent: 0pt;line-height: 187%;text-align: left;">How to minimize the code and effort required in prototyping How to make models more performant and energy efficient</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_018.png"/></span></p><p class="s1" style="padding-left: 37pt;text-indent: 0pt;text-align: left;">How to operationalize and scale, and estimate the costs involved</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_019.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Discovering how AI is applied in the industry with 40+ case studies and real-world examples</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_020.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Developing a broad-spectrum knowledge of deep learning</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_021.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Developing a generalized skill set that can be applied on new frameworks (e.g., PyTorch), domains (e.g., healthcare, robotics), input modalities (e.g., video, audio, text), and tasks (e.g., image segmentation, one-shot learning)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark2">To the Data Scientist</a><a name="bookmark16">&zwnj;</a></p><p class="s1" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">You might already be proficient at machine learning and potentially know how to train deep learning models. Good news! You can further enrich your skill set and deepen your knowledge in the field in order to build real products. This book will help inform your everyday work and beyond by covering how to:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_022.png"/></span></p><p class="s1" style="padding-top: 5pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Speed up your training, including on multinode clusters</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_023.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Build an intuition for developing and debugging models, including hyperparameter tuning, thus dramatically improving model accuracy</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_024.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Understand how your model works, uncover bias in the data, and automatically determine the best hyperparameters as well as model architecture using AutoML</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_025.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Learn tips and tricks used by other data scientists, including gathering data quickly, tracking your experiments in an organized manner, sharing your models with the world, and being up to date on the best available models for your task</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_026.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Use tools to deploy and scale your best model to real users, even automatically (without involving a DevOps team)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark3">To the Student</a><a name="bookmark17">&zwnj;</a></p><p class="s1" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">This is a great time to be considering a career in AI — it’s turning out to be the next revolution in technology after the internet and smartphones. A lot of strides have been made, and a lot remains to be discovered. We hope that this book can serve as your first step in whetting your appetite for a career in AI and, even better, developing deeper theoretical knowledge. And the best part is that you don’t have to spend a lot of money to buy expensive hardware. In fact, you can train on powerful hardware entirely for free from your web browser (thank you, Google Colab!). With this book, we hope you will:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_027.png"/></span></p><p class="s1" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Aspire to a career in AI by developing a portfolio of interesting projects</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_028.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Learn from industry practices to help prepare for internships and job opportunities</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_029.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Unleash your creativity by building fun applications like an autonomous car</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_030.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Become an AI for Good champion by using your creativity to solve the most pressing problems faced by humanity</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark4">To the Teacher</a><a name="bookmark18">&zwnj;</a></p><p class="s1" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">We believe that this book can nicely supplement your coursework with fun, real-world projects. We’ve covered every step of the deep learning pipeline in detail, along with techniques on how to execute each step effectively and efficiently. Each of the projects we present in the book can make for great collaborative or individual work in the classroom throughout the semester.</p><p class="s1" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s6" target="_blank">Eventually, we will be releasing PowerPoint Presentation Slides on </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 15pt;">http://PracticalDeepLearning.ai </span>that can accompany coursework.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark5">To the Robotics Enthusiast</a><a name="bookmark19">&zwnj;</a></p><p class="s1" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Robotics is exciting. If you’re a robotics enthusiast, we don’t really need to convince you that adding intelligence to robots is the way to go. Increasingly capable hardware platforms such as Raspberry Pi, NVIDIA Jetson Nano, Google Coral, Intel Movidius, PYNQ-Z2, and others are helping drive innovation in the robotics space. As we grow towards Industry 4.0, some of these platforms will become more and more relevant and ubiquitous. With this book, you will:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_031.png"/></span></p><p class="s1" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Learn how to build and train AI, and then bring it to the edge</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_032.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Benchmark and compare edge devices on performance, size, power, battery, and costs</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_033.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Understand how to choose the optimal AI algorithm and device for a given scenario</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_034.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Learn how other makers are building creative robots and machines</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_035.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Learn how to build further progress in the field and showcase your work</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark6">What to Expect in Each Chapter</a><a name="bookmark20">&zwnj;</a></p><p style="padding-top: 17pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark58" class="s4">Chapter 1, Exploring the Landscape of Artificial Intelligence</a></p><p class="s1" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">We take a tour of this evolving landscape, from the 1950s to today, analyze the ingredients that make for a perfect deep learning recipe, get familiar with common AI terminology and datasets, and take a peek into the world of responsible AI.</p><p style="padding-top: 10pt;padding-left: 37pt;text-indent: -30pt;text-align: left;"><a href="#bookmark166" class="s4">Chapter 2, What’s in the Picture: Image Classification with Keras</a></p><p class="s1" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">We delve into the world of image classification in a mere five lines of Keras code. We then learn what neural networks are paying attention to while making predictions by overlaying heatmaps on videos. Bonus: we hear the motivating personal journey of François Chollet, the creator of Keras, illustrating the impact a single individual can have.</p><p style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark227" class="s4">Chapter 3, Cats Versus Dogs: Transfer Learning in 30 Lines with Keras</a></p><p class="s1" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">We use transfer learning to reuse a previously trained network on a new custom classification task to get near state- of-the-art accuracy in a matter of minutes. We then slice and dice the results to understand how well it is classifying. Along the way, we build a common machine learning pipeline, which is repurposed throughout the book. Bonus: we hear from Jeremy Howard, cofounder of fast.ai, on how hundreds of thousands of students use transfer learning to jumpstart their AI journey.</p><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark323" class="s4">Chapter 4, Building a Reverse Image Search Engine: Understanding Embeddings</a></p><p class="s1" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Like Google Reverse Image Search, we explore how one can use embeddings — a contextual representation of an image to find similar images in under ten lines. And then the fun starts when we explore different strategies and algorithms to speed this up at scale, from thousands to several million images, and making them searchable in microseconds.</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark458" class="s4">Chapter 5, From Novice to Master Predictor: Maximizing Convolutional Neural Network Accuracy</a></p><p class="s1" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">We explore strategies to maximize the accuracy that our classifier can achieve, with the help of a range of tools including TensorBoard, the What-If Tool, tf-explain, TensorFlow Datasets, AutoKeras, and AutoAugment. Along the way, we conduct experiments to develop an intuition of what parameters might or might not work for your AI task.</p><p style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark599" class="s4">Chapter 6, Maximizing Speed and Performance of TensorFlow: A Handy Checklist</a></p><p class="s1" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">We take the speed of training and inference into hyperdrive by going through a checklist of 30 tricks to reduce as many inefficiencies as possible and maximize the value of your current hardware.</p><p style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark730" class="s4">Chapter 7, Practical Tools, Tips, and Tricks</a></p><p class="s1" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">We diversify our practical skills in a variety of topics and tools, ranging from installation, data collection, experiment management, visualizations, and keeping track of state-of- the-art research all the way to exploring further avenues for building the theoretical foundations of deep learning.</p><p style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark828" class="s4">Chapter 8, Cloud APIs for Computer Vision: Up and Running in 15 Minutes</a></p><p class="s1" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Work smart, not hard. We utilize the power of cloud AI platforms from Google, Microsoft, Amazon, IBM, and Clarifai in under 15 minutes. For tasks not solved with existing APIs, we then use custom classification services to train classifiers without coding. And then we pit them against each other in an open benchmark — you might be surprised who won.</p><p style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark955" class="s4">Chapter 9, Scalable Inference Serving on Cloud with TensorFlow Serving and KubeFlow</a></p><p class="s1" style="padding-top: 3pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">We take our custom trained model to the cloud/on-premises to scalably serve from hundreds to millions of requests. We explore Flask, Google Cloud ML Engine, TensorFlow Serving, and KubeFlow, showcasing the effort, scenario, and cost- benefit analysis.</p><p style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1065" class="s4">Chapter 10, AI in the Browser with TensorFlow.js and ml5.js</a></p><p class="s1" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Every single individual who uses a computer or a smartphone uniformly has access to one software program — their browser. Reach all those users with browser-based deep learning libraries including TensorFlow.js and ml5.js. Guest author Zaid Alyafeai walks us through techniques and tasks such as body pose estimation, generative adversarial networks (GANs), image-to-image translation with Pix2Pix, and more, running not on a server but in the browser itself.</p><p class="s1" style="padding-left: 37pt;text-indent: 0pt;text-align: left;">Bonus: hear from key contributors to TensorFlow.js and ml5.js on how the projects incubated.</p><p style="padding-top: 10pt;padding-left: 37pt;text-indent: -30pt;text-align: left;"><a href="#bookmark1183" class="s4">Chapter 11, Real-Time Object Classification on iOS with Core ML</a></p><p class="s1" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">We explore the landscape of deep learning on mobile, with a sharp focus on the Apple ecosystem with Core ML. We benchmark models on different iPhones, investigate strategies to reduce app size and energy impact, and look into dynamic model deployment, training on device, and how professional apps are built.</p><p style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1295" class="s4">Chapter 12, Not Hotdog on iOS with Core ML and Create ML</a></p><p class="s7" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Silicon Valley<span class="s1">’s Not Hotdog app (from HBO) is considered the “Hello World” of mobile AI, so we pay tribute by building a real-time version in not one, not two, but three different ways.</span></p><p style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1389" class="s4">Chapter 13, Shazam for Food: Developing Android Apps with TensorFlow Lite and ML Kit</a></p><p class="s1" style="padding-top: 3pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">We bring AI to Android with the help of TensorFlow Lite. We then look at cross-platform development using ML Kit (which is built on top of TensorFlow Lite) and Fritz to explore the end-to-end development life cycle for building a self-</p><p class="s1" style="padding-left: 37pt;text-indent: 0pt;text-align: left;">improving AI app. Along the way we look at model versioning, A/B testing, measuring success, dynamic updates, model optimization, and other topics. Bonus: we get to hear about the rich experience of Pete Warden (technical lead for Mobile and Embedded TensorFlow) in bringing AI to edge devices.</p><p style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1540" class="s4">Chapter 14, Building the Purrfect Cat Locator App with TensorFlow Object Detection API</a></p><p class="s1" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">We explore four different methods for locating the position of objects within images. We take a look at the evolution of object detection over the years, and analyze the tradeoffs between speed and accuracy. This builds the base for case studies such as crowd counting, face detection, and autonomous cars.</p><p style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1666" class="s4">Chapter 15, Becoming a Maker: Exploring Embedded AI at the Edge</a></p><p class="s1" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Guest author Sam Sterckval brings deep learning to low- power devices as he showcases a range of AI-capable edge devices with varying processing power and cost including Raspberry Pi, NVIDIA Jetson Nano, Google Coral, Intel Movidius, and PYNQ-Z2 FPGA, opening the doors for robotics and maker projects. Bonus: hear from the NVIDIA Jetson Nano team on how people are building creative robots quickly from their open source recipe book.</p><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1751" class="s4">Chapter 16, Simulating a Self-Driving Car Using End-to-End Deep Learning with Keras</a></p><p class="s1" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Using the photorealistic simulation environment of Microsoft AirSim, guest authors Aditya Sharma and Mitchell Spryn guide us in training a virtual car by driving it first within the environment and then teaching an AI model to replicate its behavior. Along the way, this chapter covers a number of concepts that are applicable in the autonomous car industry.</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1861" class="s4">Chapter 17, Building an Autonomous Car in Under an Hour: Reinforcement Learning with AWS DeepRacer</a></p><p class="s1" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Moving from the virtual to the physical world, guest author Sunil Mallya showcases how AWS DeepRacer, a miniature car, can be assembled, trained, and raced in under an hour. And with the help of reinforcement learning, the car learns to drive on its own, penalizing its mistakes and maximizing success. We learn how to apply this knowledge to races from the Olympics of AI Driving to RoboRace (using full-sized autonomous cars). Bonus: hear from Anima Anandkumar (NVIDIA) and Chris Anderson (founder of DIY Robocars) on where the self-driving automotive industry is headed.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark7">Conventions Used in This Book</a><a name="bookmark21">&zwnj;</a></p><p class="s1" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark22">The following typographical conventions are used in this book:</a></p><p class="s7" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Italic</p><p class="s1" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Indicates new terms, URLs, email addresses, filenames, and file extensions.</p><p class="s9" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Constant width</p><p class="s1" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Used for program listings, as well as within paragraphs to refer to program elements such as variable or function names, databases, data types, environment variables, statements, and keywords.</p><p class="s10" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Constant width bold</p><p class="s1" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Shows commands or other text that should be typed literally by the user.</p><p class="s9" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Constant width italic</p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="87" alt="image" src="KerasTensorFlow2019/Image_036.png"/></span></p><p class="s11" style="padding-top: 10pt;padding-left: 159pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s12" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">This element signifies a tip or suggestion.</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="87" alt="image" src="KerasTensorFlow2019/Image_037.png"/></span></p><p class="s11" style="padding-top: 10pt;padding-left: 159pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s12" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">This element signifies a general note.</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="87" alt="image" src="KerasTensorFlow2019/Image_038.png"/></span></p><p class="s13" style="padding-top: 10pt;padding-left: 159pt;text-indent: 0pt;text-align: center;">WARNING</p><p class="s12" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">This element indicates a warning or caution.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s1" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Shows text that should be replaced with user-supplied values or by values determined by context.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark8">Using Code Examples</a><a name="bookmark23">&zwnj;</a></p><p class="s1" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s6" target="_blank" name="bookmark24">Supplemental material (code examples, exercises, etc.) is available for download at </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 15pt;">http://PracticalDeepLearning.ai</span><a href="mailto:PracticalDLBook@gmail.com" class="s6" target="_blank">. If you have a technical question or a problem using the code examples, please send email to </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 15pt;">PracticalDLBook@gmail.com</span>.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">This book is here to help you get your job done. In general, if example code is offered with this book, you may use it in your programs and documentation. You do not need to contact us for permission unless you’re reproducing a significant portion of the code. For example, writing a program that uses several chunks of code from this book does not require permission. Selling or distributing examples from O’Reilly books does require permission. Answering a question by citing this book and quoting example code does not require permission. Incorporating a significant amount of example code from this book into your product’s documentation does require permission.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">We appreciate, but generally do not require, attribution. An attribution usually includes the title, author, publisher, and ISBN. For example: “<i>Practical Deep Learning for Cloud, Mobile, and Edge </i>by Anirudh Koul, Siddha Ganju, and Meher Kasam (O’Reilly). Copyright 2020 Anirudh Koul, Siddha Ganju, Meher Kasam, 978-1-492-03486-5.”</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="mailto:permissions@oreilly.com" class="s6" target="_blank">If you feel your use of code examples falls outside fair use or the permission given above, feel free to contact us at </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 15pt;">permissions@oreilly.com</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark9">O’Reilly Online Learning</a><a name="bookmark25">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="127" alt="image" src="KerasTensorFlow2019/Image_039.png"/></span></p><p class="s11" style="padding-top: 10pt;padding-left: 159pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s161" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="http://oreilly.com/" class="s160" target="_blank">For more than 40 years, </a>O’Reilly Media <span class="s12">has provided technology and business training, knowledge, and insight to help companies succeed.</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s1" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="http://www.oreilly.com/" class="s6" target="_blank">Our unique network of experts and innovators share their knowledge and expertise through books, articles, conferences, and our online learning platform. O’Reilly’s online learning platform gives you on-demand access to live training courses, in- depth learning paths, interactive coding environments, and a vast collection of text and video from O’Reilly and 200+ other publishers. For more information, please visit </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 15pt;">http://oreilly.com</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark10">How to Contact Us</a><a name="bookmark26">&zwnj;</a></p><p class="s1" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark27">Please address comments and questions concerning this book to the publisher:</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_040.png"/></span></p><p class="s1" style="padding-top: 5pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">O’Reilly Media, Inc.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_041.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_042.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;line-height: 187%;text-align: left;">1005 Gravenstein Highway North Sebastopol, CA 95472</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_043.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_044.png"/></span></p><p class="s1" style="padding-left: 37pt;text-indent: 0pt;line-height: 187%;text-align: left;">800-998-9938 (in the United States or Canada) 707-829-0515 (international or local)</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_045.png"/></span></p><p class="s1" style="padding-left: 37pt;text-indent: 0pt;text-align: left;">707-829-0104 (fax)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s1" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="https://oreil.ly/practical-deep-learning" class="s6" target="_blank">O’Reilly has a web page for this book, where we list errata, examples, and any additional information. You can access this page at </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 15pt;">https://oreil.ly/practical-deep-learning</span><a href="http://practicaldeeplearning.ai/" class="s6" target="_blank">. The authors have a website for this book as well: </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 15pt;">http://PracticalDeepLearning.ai</span>.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="mailto:bookquestions@oreilly.com" class="s6" target="_blank">Email </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 15pt;">bookquestions@oreilly.com </span><a href="mailto:PracticalDLBook@gmail.com" class="s6" target="_blank">to comment or ask technical questions about this book; email </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 15pt;">PracticalDLBook@gmail.com </span>to contact the authors about this book.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="http://www.oreilly.com/" class="s6" target="_blank">For more information about our books, courses, conferences, and news, see our website at </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 15pt;">http://www.oreilly.com</span>.</p><p style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="http://facebook.com/oreilly" class="s6" target="_blank">Find us on Facebook: </a><a href="http://facebook.com/oreilly" class="s4" target="_blank">http://facebook.com/oreilly</a></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="http://twitter.com/oreillymedia" class="s6" target="_blank">Follow us on Twitter: </a><a href="http://twitter.com/oreillymedia" class="s4" target="_blank">http://twitter.com/oreillymedia</a></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="http://www.youtube.com/oreillymedia" class="s6" target="_blank">Watch us on YouTube: </a><a href="http://www.youtube.com/oreillymedia" class="s4" target="_blank">http://www.youtube.com/oreillymedia</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark11">Acknowledgments</a><a name="bookmark28">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;"><a name="bookmark12">Group Acknowledgments</a><a name="bookmark29">&zwnj;</a></p><p class="s1" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: justify;">We’d like to thank the following people for their immense help throughout our journey in writing this book. Without them, this book would not be possible.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">This book came to life because of our development editor Nicole Taché’s efforts. She rooted for us throughout our journey and provided important guidance at each step of the process. She helped us prioritize the right material (believe it or not, the book was going to be even larger!) and ensured that we were on track. She was reader number one for every single draft that we had written, so our goal first and foremost was ensuring that she was able to follow the content, despite her being new to AI. We’re immensely grateful for her support.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">We also want to thank the rest of the O’Reilly team including our production editor Christopher Faucher who worked tireless hours on a tight schedule to ensure that this book made it to the printing press on time. We are also grateful to our copy editor Bob Russell who really impressed us with his lightning-fast edits and his attention to detail. He made us realize the importance of paying attention to English grammar in school (though a few years too late, we’re afraid). We also want to acknowledge Rachel Roumeliotis (VP of Content Strategy) and Olivia MacDonald (Managing Editor for Development) for believing in the project and for offering their continued support.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Huge thanks are in order for our guest authors who brought in their technical expertise to share their passion for this field with our readers. Aditya Sharma and Mitchell Spryn (from Microsoft) showed us that our love for playing video racing games can be put to good use to train autonomous cars by driving them in a simulated environment (with AirSim). Sunil Mallya (from Amazon) helped bring this knowledge to the physical world by demonstrating that all it takes is one hour to assemble and get a miniature autonomous car (AWS DeepRacer) to navigate its way around a track using reinforcement learning. Sam Sterckval (from</p><p class="s1" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Edgise) summarized the vast variety of embedded AI hardware available in the market, so we can get a leg up on our next robotics project. And finally, Zaid Alyafeai (from King Fahd University) demonstrated that browsers are no less capable of running serious interactive AI models (with the help of TensorFlow.js and ml5js).</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">The book is in its current shape because of timely feedback from our amazing technical reviewers, who worked tirelessly on our drafts, pointed out any technical inaccuracies they came across, and gave us suggestions on better conveying our ideas. Due to their feedback (and the ever-changing APIs of TensorFlow), we ended up doing a rewrite of a majority of the book from the original prerelease. We thank Margaret Maynard-Reid (Google Developer Expert for Machine Learning, you might have read her work while reading TensorFlow documentation), Paco Nathan (35+ years industry veteran at Derwin Inc., who introduced Anirudh to the world of public speaking), Andy Petrella (CEO and Founder at Kensu and creator of SparkNotebook whose technical insights stood up to his reputation), and Nikhita Koul (Senior Data Scientist at Adobe who read and suggested improvements after every iteration, effectively reading a few thousand pages, thus making the content significantly more approachable) for their detailed reviews of each chapter. Additionally, we also had a lot of help from reviewers with expertise in specific topics be it AI in the browser, mobile development, or autonomous cars. The chapter- wise reviewer list (in alphabetical order) is as follows:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_046.png"/></span></p><p class="s1" style="padding-top: 4pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Chapter 1: Dharini Chandrasekaran, Sherin Thomas</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_047.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Chapter 2: Anuj Sharma, Charles Kozierok, Manoj Parihar, Pankesh Bamotra, Pranav Kant</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_048.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Chapter 3: Anuj Sharma, Charles Kozierok, Manoj Parihar, Pankesh Bamotra, Pranav Kant</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_049.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Chapter 4: Anuj Sharma, Manoj Parihar, Pankesh Bamotra, Pranav Kant</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_050.png"/></span></p><p class="s1" style="padding-top: 3pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Chapter 6: Gabriel Ibagon, Jiri Simsa, Max Katz, Pankesh Bamotra</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_051.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_052.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_053.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;line-height: 187%;text-align: left;">Chapter 7: Pankesh Bamotra Chapter 8: Deepesh Aggarwal Chapter 9: Pankesh Bamotra</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_054.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_055.png"/></span></p><p class="s1" style="padding-left: 37pt;text-indent: 0pt;line-height: 187%;text-align: left;">Chapter 10: Brett Burley, Laurent Denoue, Manraj Singh Chapter 11: David Apgar, James Webb</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_056.png"/></span></p><p class="s1" style="padding-left: 37pt;text-indent: 0pt;text-align: left;">Chapter 12: David Apgar</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_057.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Chapter 13: Jesse Wilson, Salman Gadit</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_058.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Chapter 14: Akshit Arora, Pranav Kant, Rohit Taneja, Ronay Ak</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_059.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Chapter 15: Geertrui Van Lommel, Joke Decubber, Jolien De Cock, Marianne Van Lommel, Sam Hendrickx</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_060.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Chapter 16: Dario Salischiker, Kurt Niebuhr, Matthew Chan, Praveen Palanisamy</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_061.png"/></span></p><p class="s1" style="padding-top: 15pt;padding-left: 37pt;text-indent: 0pt;text-align: left;">Chapter 17: Kirtesh Garg, Larry Pizette, Pierre Dumas, Ricardo Sueiras, Segolene Dessertine-panhard, Sri Elaprolu, Tatsuya Arai</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s1" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">We have short excerpts throughout the book from creators who gave us a little peek into their world, and how and why they built the project for which they are most known. We are grateful to François Chollet, Jeremy Howard, Pete Warden, Anima Anandkumar, Chris Anderson, Shanqing Cai, Daniel Smilkov, Cristobal Valenzuela, Daniel Shiffman, Hart Woolery, Dan Abdinoor, Chitoku Yato, John Welsh, and Danny Atsmo.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark13">Personal Acknowledgments</a><a name="bookmark30">&zwnj;</a></p><p class="s1" style="padding-top: 7pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">“I would like to thank my family — Arbind, Saroj, and Nikhita who gave me the support, resources, time, and freedom to pursue my passions. To all the hackers and researchers at Microsoft, Aira, and Yahoo who stood with me in turning ideas to prototypes to products, it’s not the successes but the hiccups which taught us a lot during our journey together. Our trials and tribulations provided glorious material for this book, enough to exceed our original estimate by an extra 250 pages! To my academic families at Carnegie Mellon, Dalhousie, and Thapar University, you taught me more than just academics (unlike what my GPA might suggest). And to the blind and low-vision community, you inspired me daily to work in the AI field by demonstrating that armed with the right tools, people are truly limitless.”</p><p class="s1" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">Anirudh</p><p class="s1" style="padding-top: 7pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">“My grandfather, an author himself, once told me, ‘Authoring a book is harder than I thought and more rewarding than I could have ever imagined.’ I am eternally grateful to my grandparents and family, Mom, Dad, and Shriya for advocating seeking out knowledge and helping me become the person I am today. To my wonderful collaborators and mentors from Carnegie Mellon University, CERN, NASA FDL, Deep Vision, NITH, and NVIDIA who were with me throughout my journey, I am indebted to them for teaching and helping develop a scientific temperament. To my friends, who I hope still remember me, as I’ve been pretty invisible as of late, I would like to say a big thanks for being incredibly patient. I hope to see you all around. To my friends who selflessly reviewed chapters of the book and acted as a sounding board, a huge thank you — without you, the book would not have taken shape.”</p><p class="s1" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">Siddha</p><p class="s1" style="padding-top: 3pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">“I am indebted to my parents Rajagopal and Lakshmi for their unending love and support starting from the very beginning and their strong will to provide me with a good life and education. I am grateful to my professors from UF and VNIT who taught me well and made me glad that I majored in CS. I am thankful to my incredibly supportive partner Julia Tanner who, for nearly two years, had to endure nights and weekends of unending Skype calls with my coauthors, as well as my several terrible jokes (some of which unfortunately made it into this book). I’d also like to acknowledge the role of my wonderful manager Joel Kustka in supporting me during the process of writing this book. A shout out to my friends who were incredibly understanding when I couldn’t hang out with them as often as they would have liked me to.”</p><p class="s1" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">Meher</p><p class="s1" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Last but not least, thank you to the makers of Grammarly, which empowered people with mediocre English grades to become published authors!</p><p class="s16" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark31">Chapter 1. Exploring the Landscape of Artificial Intelligence</a><a name="bookmark58">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_062.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s39" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark59" class="s30">Following are the words from Dr. May Carson’s (</a>Figure 1-1<span style=" color: #000;">) seminal paper on the changing role of artificial intelligence (AI) in human life in the twenty- first century:</span></p><p class="s17" style="padding-top: 6pt;padding-left: 13pt;text-indent: 0pt;text-align: left;">Artificial Intelligence has often been termed as the electricity of the 21st century. Today, artificial intelligent programs will have the power to drive all forms of industry (including health), design medical devices and build new types of products and services, including robots and automobiles. As AI is advancing, organizations are already working to ensure those artificial intelligence programs can do their job and, importantly, avoid mistakes or dangerous accidents. Organizations need AI, but they also recognize that not everything they can do with AI is a good idea.</p><p class="s17" style="padding-left: 13pt;text-indent: 0pt;text-align: left;">We have had extensive studies of what it takes to operate artificial intelligence using these techniques and policies. The main conclusion is that the amount of money spent on AI programs per person, per year versus the amount used to research, build and produce them is roughly equal. That seems obvious, but it’s not entirely true.</p><p class="s17" style="padding-left: 13pt;text-indent: 0pt;text-align: left;">First, AI systems need support and maintenance to help with their functions. In order to be truly reliable, they need people to have the skills to run them and to help them perform some of their tasks. It’s essential that AI organizations provide workers to do the complex tasks needed by those services. It’s also important to understand the people who are doing those jobs, especially once AI is more complex than humans. For example, people will most often work in jobs requiring advanced knowledge but are not necessarily skilled in working with systems that need to be built and maintained.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="534" height="539" alt="image" src="KerasTensorFlow2019/Image_063.jpg"/></span></p><p class="s19" style="padding-top: 5pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark59">Figure 1-1. Dr. May Carson</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark32">An Apology</a><a name="bookmark60">&zwnj;</a></p><p class="s116" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://talktotransformer.com/" class="s30" target="_blank" name="bookmark61">We now have to come clean and admit that everything in this chapter up to now was entirely fake. Literally everything! All of the text (other than the first italicized sentence, which was written by us as a seed) was generated using the GPT-2 model (built by Adam King) on the website </a>TalkToTransformer.com<a href="http://onitools.moe/" class="s30" target="_blank">. The name of the author was generated using the “Nado Name Generator” on the website </a>Onitools.moe<a href="http://thispersondoesnotexist.com/" class="s30" target="_blank">. At least the picture of the author must be real, right? Nope, the picture was generated from the website </a>ThisPersonDoesNotExist.com <span class="s17">which shows us new pictures of nonexistent people each time we reload the page using the magic of Generative Adversarial Networks (GANs).</span></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Although we feel ambivalent, to say the least, about starting this entire book on a dishonest note, we thought it was important to showcase the state-of-the-art of AI when you, our reader, least expected it. It is, frankly, mind-boggling and amazing and terrifying at the same time to see what AI is already capable of. The fact that it can create sentences out of thin air that are more intelligent and eloquent than some world leaders is...let’s just say big league.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">That being said, one thing AI can’t appropriate from us just yet is the ability to be fun. We’re hoping that those first three fake paragraphs will be the driest in this entire book. After all, we don’t want to be known as “the authors more boring than a machine.”</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark33">The Real Introduction</a><a name="bookmark62">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark63">Recall that time you saw a magic show during which a trick dazzled you enough to think, “How the heck did they do that?!” Have you ever wondered the same about an AI application that made the news? In this book, we want to equip you with the knowledge and tools to not only deconstruct but also build a similar one.</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Through accessible, step-by-step explanations, we dissect real-world applications that use AI and showcase how you would go about creating them on a wide variety of platforms — from the cloud to the browser to smartphones to edge AI devices, and finally landing on the ultimate challenge currently in AI: autonomous cars.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In most chapters, we begin with a motivating problem and then build an end-to-end solution one step at a time. In the earlier portions of the book, we develop the necessary skills to build the brains of the AI. But that’s only half the battle. The true value of building AI is in creating usable applications. And we’re not talking about toy prototypes here. We want you to construct software that can be used in the real world by real people for improving their lives. Hence, the word “Practical” in the book title. To that effect, we discuss various options that are available to us and choose the appropriate options based on performance, energy consumption, scalability, reliability, and privacy trade-offs.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In this first chapter, we take a step back to appreciate this moment in AI history. We explore the meaning of AI, specifically in the context of deep learning and the sequence of events that led to deep learning becoming one of the most groundbreaking areas of technological progress in the early twenty-first century. We also examine the core components underlying a complete deep learning solution, to set us up for the subsequent chapters in which we actually get our hands dirty.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">So our journey begins here, with a very fundamental question.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark34">What Is AI?</a><a name="bookmark64">&zwnj;</a></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark68" class="s30">Throughout this book, we use the terms “artificial intelligence,” “machine learning,” and “deep learning” frequently, sometimes interchangeably. But in the strictest technical terms, they mean different things. Here’s a synopsis of each (see also </a>Figure 1-2<span style=" color: #000;">):</span></p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">AI</p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark65">This gives machines the capabilities to mimic human behavior. IBM’s Deep Blue is a recognizable example of AI.</a></p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Machine learning</p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark66">This is the branch of AI in which machines use statistical techniques to learn from previous information and experiences. The goal is for the machine to take action in the future based on learning observations from the past. If you watched IBM’s Watson take on Ken Jennings and Brad Rutter on </a><i>Jeopardy!</i>, you saw machine learning in action. More relatably, the next time a spam email doesn’t reach your inbox, you can thank machine learning.</p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Deep learning</p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark67">This is a subfield of machine learning in which deep, multilayered neural networks are used to make predictions, especially excelling in computer vision, speech recognition, natural language understanding, and so on.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 32pt;text-indent: 0pt;text-align: left;"><span><img width="525" height="526" alt="image" src="KerasTensorFlow2019/Image_064.jpg"/></span></p><p class="s19" style="padding-top: 7pt;padding-left: 37pt;text-indent: 0pt;text-align: left;"><a name="bookmark68">Figure 1-2. The relationship between AI, machine learning, and deep learning</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark69">Throughout this book, we primarily focus on deep learning.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark35">Motivating Examples</a><a name="bookmark70">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 110%;text-align: left;"><a href="#bookmark156" class="s30" name="bookmark71">Let’s cut to the chase. What compelled us to write this book? Why did you spend your hard-earned money</a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; vertical-align: 4pt;">1 </span>buying this book? Our motivation was simple: to get more people involved in the world of AI. The fact that you’re reading this book means that our job is already halfway done.<a name="bookmark72">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">However, to really pique your interest, let’s take a look at some stellar examples that demonstrate what AI is already capable of doing:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_065.png"/></span></p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">“DeepMind’s AI agents conquer human pros at StarCraft II”: <i>The Verge</i>, 2019</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_066.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">“AI-Generated Art Sells for Nearly Half a Million Dollars at Christie’s”:</p><p class="s22" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">AdWeek<span class="s17">, 2018</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_067.png"/></span></p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">“AI Beats Radiologists in Detecting Lung Cancer”: <i>American Journal of Managed Care</i>, 2019</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_068.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">“Boston Dynamics Atlas Robot Can Do Parkour”: <i>ExtremeTech</i>, 2018</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_069.png"/></span></p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">“Facebook, Carnegie Mellon build first AI that beats pros in 6-player poker”: <i>ai.facebook.com</i>, 2019</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_070.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">“Blind users can now explore photos by touch with Microsoft’s Seeing AI”: <i>TechCrunch</i>, 2019</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_071.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">“IBM’s Watson supercomputer defeats humans in final Jeopardy match”: <i>VentureBeat</i>, 2011</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_072.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">“Google’s ML-Jam challenges musicians to improvise and collaborate with AI”: <i>VentureBeat</i>, 2019</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_073.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">“Mastering the Game of Go without Human Knowledge”: <i>Nature</i>, 2017</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_074.png"/></span></p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">“Chinese AI Beats Doctors in Diagnosing Brain Tumors”: <i>Popular Mechanics</i>, 2018</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_075.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">“Two new planets discovered using artificial intelligence”: <i>Phys.org</i>, 2019</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_076.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">“Nvidia’s latest AI software turns rough doodles into realistic landscapes”: <i>The Verge</i>, 2019</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">These applications of AI serve as our North Star. The level of these achievements is the equivalent of a gold-medal-winning Olympic</p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">performance. However, applications solving a host of problems in the real world is the equivalent of completing a 5K race. Developing these applications doesn’t require years of training, yet doing so provides the developer immense satisfaction when crossing the finish line. We are here to coach you through that 5K.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Throughout this book, we intentionally prioritize breadth. The field of AI is changing so quickly that we can only hope to equip you with the proper mindset and array of tools. In addition to tackling individual problems, we will look at how different, seemingly unrelated problems have fundamental overlaps that we can use to our advantage. As an example, sound recognition uses Convolutional Neural Networks (CNNs), which are also the basis for modern computer vision. We touch upon practical aspects of multiple areas so you will be able to go from 0 to 80 quickly to tackle real- world problems. If we’ve generated enough interest that you decide you then want to go from 80 to 95, we’d consider our goal achieved. As the oft- used phrase goes, we want to “democratize AI.”</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">It’s important to note that much of the progress in AI happened in just the past few years — it’s difficult to overstate that. To illustrate how far we’ve come along, take this example: five years ago, you needed a Ph.D. just to get your foot in the door of the industry. Five years later, you don’t even need a Ph.D. to write an entire book on the subject. (Seriously, check our profiles!)</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Although modern applications of deep learning seem pretty amazing, they did not get there all on their own. They stood on the shoulders of many giants of the industry who have been pushing the limits for decades.</p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark73">Indeed, we can’t fully appreciate the significance of this time without looking at the entire history.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark36">A Brief History of AI</a><a name="bookmark74">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark75">Let’s go back in time a little bit: our whole universe was in a hot dense state. Then nearly 14 billion years ago expansion started, wait...okay, we don’t have to go back that far (but now we have the song stuck in your head for the rest of the day, right?). It was really just 70 years ago when the first seeds of AI were planted. Alan Turing, in his 1950 paper, “Computing Machinery and Intelligence,” first asked the question “Can machines think?” This really gets into a larger philosophical debate of sentience and what it means to be human. Does it mean to possess the ability to compose a concerto and know that you’ve composed it? Turing found that framework rather restrictive and instead proposed a test: if a human cannot distinguish a machine from another human, does it really matter? An AI that can mimic a human is, in essence, human.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark37">Exciting Beginnings</a><a name="bookmark76">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The term “artificial intelligence” was coined by John McCarthy in 1956 at the Dartmouth Summer Research Project. Physical computers weren’t even really a thing back then, so it’s remarkable that they were able to discuss futuristic areas such as language simulation, self-improving learning machines, abstractions on sensory data, and more. Much of it was theoretical, of course. This was the first time that AI became a field of research rather than a single project.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="536" height="218" alt="image" src="KerasTensorFlow2019/Image_077.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark78">Throughout this book, we repeat the phrase </a><i>neural network</i>. What is a neural network? It is a simplified model of the human brain. Much like the brain, it has <i>neurons </i>that activate when encountering something familiar. The different neurons are connected via connections (corresponding to synapses in our brain) that help information flow from one neuron to another.</p><p class="s68" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a href="#bookmark79" style=" color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11pt;">In </a>Figure 1-3<span style=" color: #000;">, we can see an example of the simplest neural network: a perceptron. Mathematically, the perceptron can be expressed as follows:</span></p><p class="s19" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">output = f(x<span class="s28">1</span>, x<span class="s28">2</span>, x<span class="s28">3</span>) = x<span class="s28">1 </span>w<span class="s28">1 </span>+ x<span class="s28">2 </span>w<span class="s28">2 </span>+ x<span class="s28">3 </span>w<span class="s28">3 </span>+ b</p><p style="text-indent: 0pt;text-align: left;"/><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark77">The paper “Perceptron: A Perceiving and Recognizing Automaton” in 1957 by Frank Rosenblatt laid the foundation for deep neural networks. He postulated that it should be feasible to construct an electronic or electromechanical system that will learn to recognize similarities between patterns of optical, electrical, or tonal information. This system would function similar to the human brain. Rather than using a rule-based model (which was standard for the algorithms at the time), he proposed using statistical models to make predictions.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 38pt;text-indent: 0pt;text-align: left;"><span><img width="506" height="294" alt="image" src="KerasTensorFlow2019/Image_078.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark79">Figure 1-3. An example of a perceptron</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In 1965, Ivakhnenko and Lapa published the first working neural network in their paper “Group Method of Data Handling — A Rival Method of Stochastic Approximation.” There is some controversy in this area, but Ivakhnenko is regarded by some as the father of deep learning.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Around this time, bold predictions were made about what machines would be capable of doing. Machine translation, speech recognition, and more would be performed better than humans. Governments around the world were excited and began opening up their wallets to fund these projects.</p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">This gold rush started in the late 1950s and was alive and well into the mid-1970s.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark38">The Cold and Dark Days</a><a name="bookmark80">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark81">With millions of dollars invested, the first systems were put into practice. It turned out that a lot of the original prophecies were unrealistic. Speech recognition worked only if it was spoken in a certain way, and even then, only for a limited set of words. Language translation turned out to be heavily erroneous and much more expensive than what it would cost a human to do. Perceptrons (essentially single-layer neural networks) quickly hit a cap for making reliable predictions. This limited their usefulness for most problems in the real world. This is because they are linear functions, whereas problems in the real world often require a nonlinear classifier for accurate predictions. Imagine trying to fit a line to a curve!</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">So what happens when you over-promise and under-deliver? You lose funding. The Defense Advanced Research Project Agency, commonly known as DARPA (yeah, those people; the ones who built the ARPANET, which later became the internet), funded a lot of the original projects in the United States. However, the lack of results over nearly two decades increasingly frustrated the agency. It was easier to land a man on the moon than to get a usable speech recognizer!</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Similarly, across the pond, the Lighthill Report was published in 1974, which said, “The general-purpose robot is a mirage.” Imagine being a Brit in 1974 watching the bigwigs in computer science debating on the BBC as to whether AI is a waste of resources. As a consequence, AI research was decimated in the United Kingdom and subsequently across the world, destroying many careers in the process. This phase of lost faith in AI lasted about two decades and came to be known as the “AI Winter.” If only Ned Stark had been around back then to warn them.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark39">A Glimmer of Hope</a><a name="bookmark82">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark85" class="s30" name="bookmark83">Even during those freezing days, there was some groundbreaking work done in this field. Sure, perceptrons — being linear functions — had limited capabilities. How could one fix that? By chaining them in a network, such that the output of one (or more) perceptron is the input to one (or more) perceptron. In other words, a multilayer neural network, as illustrated in </a><span style=" color: #8E0012;">Figure 1-4</span>. The higher the number of layers, the more the nonlinearity it would learn, resulting in better predictions. There is just one issue: how does one train it? Enter Geoffrey Hinton and friends. They published a technique called <i>backpropagation </i>in 1986 in the paper “Learning representations by back-propagating errors.” How does it work? Make a prediction, see how far off the prediction is from reality, and propagate back the magnitude of the error into the network so it can learn to fix it. You repeat this process until the error becomes insignificant. A simple yet powerful concept. We use the term backpropagation repeatedly throughout this book.<a name="bookmark84">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 43pt;text-indent: 0pt;text-align: left;"><span><img width="514" height="179" alt="image" src="KerasTensorFlow2019/Image_079.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a href="https://oreil.ly/Jn-T6" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 11pt;" target="_blank" name="bookmark85">Figure 1-4. An example multilayer neural network (</a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 11pt;">image source</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark86">In 1989, George Cybenko provided the first proof of the </a><i>Universal Approximation Theorem</i>, which states that a neural network with a single hidden layer is theoretically capable of modeling any problem. This was remarkable because it meant that neural networks could (at least in theory) outdo any machine learning approach. Heck, it could even mimic the human brain. But all of this was only on paper. The size of this network would quickly pose limitations in the real world. This could be overcome somewhat by using multiple hidden layers and training the network with… wait for it…backpropagation!</p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark88" class="s30" name="bookmark87">On the more practical side of things, a team at Carnegie Mellon University built the first-ever autonomous vehicle, NavLab 1, in 1986 (</a>Figure 1-5<span style=" color: #000;">). It</span></p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">initially used a single-layer neural network to control the angle of the steering wheel. This eventually led to NavLab 5 in 1995. During a demonstration, a car drove all but 50 of the 2,850-mile journey from Pittsburgh to San Diego on its own. NavLab got its driver’s license before many Tesla engineers were even born!</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 117pt;text-indent: 0pt;text-align: left;"><span><img width="296" height="355" alt="image" src="KerasTensorFlow2019/Image_080.jpg"/></span></p><p class="s19" style="padding-top: 5pt;padding-left: 33pt;text-indent: 0pt;text-align: left;"><a href="https://oreil.ly/b2Bnn" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 11pt;" target="_blank" name="bookmark88">Figure 1-5. The autonomous NavLab 1 from 1986 in all its glory (</a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 11pt;">image source</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Another standout example from the 1980s was at the United States Postal Service (USPS). The service needed to sort postal mail automatically according to the postal codes (ZIP codes) they were addressed to.</p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark89">Because a lot of the mail has always been handwritten, optical character recognition (OCR) could not be used. To solve this problem, Yann LeCun et al. used handwritten data from the National Institute of Standards and Technology (NIST) to demonstrate that neural networks were capable of recognizing these handwritten digits in their paper “Backpropagation Applied to Handwritten Zip Code Recognition.” The agency’s network, LeNet, became what the USPS used for decades to automatically scan and sort the mail. This was remarkable because it was the first convolutional neural network that really worked in the wild. Eventually, in the 1990s, banks would use an evolved version of the model called LeNet- 5 to read handwritten numbers on checks. This laid the foundation for modern computer vision.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 93pt;text-indent: 0pt;text-align: left;"><span><img width="382" height="377" alt="image" src="KerasTensorFlow2019/Image_081.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="536" height="184" alt="image" src="KerasTensorFlow2019/Image_082.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s68" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a href="#bookmark90" style=" color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11pt;">Those of you who have read about the MNIST dataset might have already noticed a connection to the NIST mention we just made. That is because the MNIST dataset essentially consists of a subset of images from the original NIST dataset that had some modifications (the “M” in “MNIST”) applied to them to ease the train and test process for the neural network. Modifications, some of which you can see in </a>Figure 1-6<span style=" color: #000;">, included resizing them to 28 x 28 pixels, centering the digit in that area, antialiasing, and so on.</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s19" style="padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark90">Figure 1-6. A sample of handwritten digits from the MNIST dataset</a><a name="bookmark91">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">A few others kept their research going, including Jürgen Schmidhuber, who proposed networks like the Long Short-Term Memory (LSTM) with promising applications for text and speech.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">At that point, even though the theories were becoming sufficiently advanced, results could not be demonstrated in practice. The main reason was that it was too computationally expensive for the hardware back then and scaling them for larger tasks was a challenge. Even if by some miracle the hardware was available, the data to realize its full potential was certainly not easy to come by. After all, the internet was still in its dial-up</p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">phase. Support Vector Machines (SVMs), a machine learning technique introduced for classification problems in 1995, were faster and provided reasonably good results on smaller amounts of data, and thus had become the norm.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">As a result, AI and deep learning’s reputation was poor. Graduate students were warned against doing deep learning research because this is the field “where smart scientists would see their careers end.” People and companies working in the field would use alternative words like informatics, cognitive systems, intelligent agents, machine learning, and others to dissociate themselves from the AI name. It’s a bit like when the U.S. Department of War was rebranded as the Department of Defense to be more palatable to the people.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark40">How Deep Learning Became a Thing</a><a name="bookmark92">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark93">Luckily for us, the 2000s brought high-speed internet, smartphone cameras, video games, and photo-sharing sites like Flickr and Creative Commons (bringing the ability to legally reuse other people’s photos). People in massive numbers were able to quickly take photos with a device in their pockets and then instantly upload. The data lake was filling up, and gradually there were ample opportunities to take a dip. The 14 million- image ImageNet dataset was born from this happy confluence and some tremendous work by (then Princeton’s) Fei-Fei Li and company.</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">During the same decade, PC and console gaming became really serious. Gamers demanded better and better graphics from their video games.</p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">This, in turn, pushed Graphics Processing Unit (GPU) manufacturers such as NVIDIA to keep improving their hardware. The key thing to remember here is that GPUs are damn good at matrix operations. Why is that the case? Because the math demands it! In computer graphics, common tasks such as moving objects, rotating them, changing their shape, adjusting their lighting, and so on all use matrix operations. And GPUs specialize in doing them. And you know what else needs a lot of matrix calculations?</p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Neural networks. It’s one big happy coincidence.</p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark94">With ImageNet ready, the annual ImageNet Large Scale Visual Recognition Challenge (ILSVRC) was set up in 2010 to openly challenge researchers to come up with better techniques for classifying this data. A subset of 1,000 categories consisting of approximately 1.2 million images was available to push the boundaries of research. The state-of-the-art computer-vision techniques like Scale-Invariant Feature Transform (SIFT)</a></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">+ SVM yielded a 28% (in 2010) and a 25% (2011) top-5 error rate (i.e., if one of the top five guesses ranked by probability matches, it’s considered accurate).</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">And then came 2012, with an entry on the leaderboard that nearly halved the error rate down to 16%. Alex Krizhevsky, Ilya Sutskever (who eventually founded OpenAI), and Geoffrey Hinton from the University of Toronto submitted that entry. Aptly called AlexNet, it was a CNN that was inspired by LeNet-5. Even at just eight layers, AlexNet had a massive 60 million parameters and 650,000 neurons, resulting in a 240 MB model. It was trained over one week using two NVIDIA GPUs. This single event took everyone by surprise, proving the potential of CNNs that snowballed into the modern deep learning era.</p><p class="s39" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark96" class="s18" name="bookmark95">Figure 1-7</a> <span style=" color: #000;">quantifies the progress that CNNs have made in the past decade. We saw a 40% year-on-year decrease in classification error rate among ImageNet LSVRC–winning entries since the arrival of deep learning in 2012. As CNNs grew deeper, the error continued to decrease.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 41pt;text-indent: 0pt;text-align: left;"><span><img width="500" height="293" alt="image" src="KerasTensorFlow2019/Image_083.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark96">Figure 1-7. Evolution of winning entries at ImageNet LSVRC</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;"><a href="#bookmark98" class="s30" name="bookmark97">Keep in mind we are vastly simplifying the history of AI, and we are surely glossing over some of the details. Essentially, it was a confluence of data, GPUs, and better techniques that led to this modern era of deep learning. And the progress kept expanding further into newer territories. As </a><a href="#bookmark98" class="s18">Table 1- 1 </a><a href="#bookmark98" class="s30">highlights, what was in the realm of science fiction is already a reality.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s22" style="padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark98">Table 1-1. A highlight reel of the modern deep learning era</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="131" alt="image" src="KerasTensorFlow2019/Image_084.png"/></span></p><p class="s26" style="text-indent: 0pt;line-height: 12pt;text-align: left;">Error rate for speech recognition went down 25%</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="text-indent: 0pt;line-height: 12pt;text-align: left;">Researchers begin tinkering with deep learning on a variety of tasks</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s26" style="text-indent: 0pt;text-align: left;">word2vec brings context to words and phrases, getting one step closer to understanding meanings</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="text-indent: 0pt;line-height: 12pt;text-align: left;">2013</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-top: 9pt;padding-bottom: 3pt;padding-left: 41pt;text-indent: -31pt;text-align: left;">2012 Neural network from Google Brain team starts recognizing cats after watching YouTube videos</p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_085.png"/></span></p><p class="s31" style="padding-top: 2pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">2014 <span class="s26">GANs invented</span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_086.png"/></span></p><p class="s26" style="padding-top: 11pt;padding-left: 68pt;text-indent: 0pt;text-align: left;">Skype translates speech in real time</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_087.png"/></span></p><p class="s26" style="padding-left: 68pt;text-indent: 0pt;text-align: left;">Eugene Goostman, a chatbot, passes the Turing Test</p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="196" alt="image" src="KerasTensorFlow2019/Image_088.png"/></span></p><p class="s26" style="text-indent: 0pt;line-height: 12pt;text-align: left;">Visual Question Answering allows asking questions based on images</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="text-indent: 0pt;text-align: left;">Microsoft ResNet beats humans in image accuracy, trains 1,000-layer network</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s26" style="text-indent: 0pt;line-height: 189%;text-align: left;">Baidu’s Deep Speech 2 does end-to-end speech recognition Gmail launches Smart Reply</p><p class="s26" style="text-indent: 0pt;text-align: left;">YOLO (You Only Look Once) does object detection in real time</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="text-indent: 0pt;line-height: 12pt;text-align: left;">2015</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_089.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_090.png"/></span></p><p class="s26" style="padding-top: 3pt;padding-bottom: 2pt;padding-left: 68pt;text-indent: 0pt;line-height: 195%;text-align: left;">Sequence-to-sequence learning with neural networks invented Image captioning translates images to sentences</p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_091.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_092.png"/></span></p><p class="s26" style="padding-top: 7pt;padding-left: 68pt;text-indent: -58pt;line-height: 195%;text-align: left;">2016 AlphaGo wins against professional human Go players Google WaveNets help generate realistic audio</p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_093.png"/></span></p><p class="s26" style="padding-left: 18pt;text-indent: 0pt;line-height: 12pt;text-align: center;">Microsoft achieves human parity in conversational speech recognition</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="179" alt="image" src="KerasTensorFlow2019/Image_094.png"/></span></p><p class="s26" style="text-indent: 0pt;line-height: 12pt;text-align: left;">Pix2Pix allows generating images from sketches</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="text-indent: 0pt;line-height: 195%;text-align: left;">AlphaGo Zero learns to play Go itself in 3 days Capsule Nets fix flaws in CNNs</p><p class="s26" style="text-indent: 0pt;line-height: 12pt;text-align: left;">Tensor Processing Units (TPUs) introduced</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s26" style="text-indent: 0pt;text-align: left;">California allows sale of autonomous cars</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="text-indent: 0pt;line-height: 12pt;text-align: left;">2017</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_095.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_096.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_097.png"/></span></p><p class="s26" style="padding-top: 7pt;padding-left: 68pt;text-indent: -58pt;line-height: 192%;text-align: justify;">2018 AI designs AI better than humans with Neural Architecture Search Google Duplex demo makes restaurant reservations on our behalf Deepfakes swap one face for another in videos</p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="200" alt="image" src="KerasTensorFlow2019/Image_098.png"/></span></p><p class="s26" style="text-indent: 0pt;line-height: 12pt;text-align: left;">AI by the Allen Institute passes 12th-grade science test with 80% score</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="text-indent: 0pt;line-height: 193%;text-align: left;">OpenAI Five crushes Dota2 world champions StyleGan generates photorealistic images OpenAI GPT-2 generates realistic text passages Fujitsu trains ImageNet in 75 seconds</p><p class="s26" style="text-indent: 0pt;text-align: left;">Microsoft invests $1 billion in OpenAI</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="text-indent: 0pt;line-height: 12pt;text-align: left;">2019</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_099.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_100.png"/></span></p><p class="s26" style="padding-bottom: 2pt;padding-left: 68pt;text-indent: 0pt;line-height: 195%;text-align: justify;">Google’s BERT succeeds humans in language understanding tasks DawnBench and MLPerf established to benchmark AI training</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 9pt;text-align: left;"><span><img width="586" height="12" alt="image" src="KerasTensorFlow2019/Image_101.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Hopefully, you now have a historical context of AI and deep learning and have an understanding of why this moment in time is significant. It’s important to recognize the rapid rate at which progress is happening in this area. But as we have seen so far, this was not always the case.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark99">The original estimate for achieving real-world computer vision was “one summer” back in the 1960s, according to two of the field’s pioneers. They were off by only half a century! It’s not easy being a futurist. A study by Alexander Wissner-Gross observed that it took 18 years on average between when an algorithm was proposed and the time it led to a breakthrough. On the other hand, that gap was a mere three years on average between when a dataset was made available and the breakthrough it helped achieve! Look at any of the breakthroughs in the past decade. The dataset that enabled that breakthrough was very likely made available just a few years prior.</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Data was clearly the limiting factor. This shows the crucial role that a good dataset can play for deep learning. However, data is not the only factor.</p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark100">Let’s look at the other pillars that make up the foundation of the perfect deep learning solution.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark41">Recipe for the Perfect Deep Learning Solution</a><a name="bookmark101">&zwnj;</a></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark103" class="s30" name="bookmark102">Before Gordon Ramsay starts cooking, he ensures he has all of the ingredients ready to go. The same goes for solving a problem using deep learning (</a>Figure 1-8<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 32pt;text-indent: 0pt;text-align: left;"><span><img width="481" height="555" alt="image" src="KerasTensorFlow2019/Image_102.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark103">Figure 1-8. Ingredients for the perfect deep learning solution</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">And here’s your deep learning <i>mise en place</i>!</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s32" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Dataset + Model + Framework + Hardware = Deep Learning Solution</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Let’s look into each of these in a little more detail.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark42">Datasets</a><a name="bookmark104">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark105">Just like Pac-Man is hungry for dots, deep learning is hungry for data — lots and lots of data. It needs this amount of data to spot meaningful patterns that can help make robust predictions. Traditional machine learning was the norm in the 1980s and 1990s because it would function even with few hundreds to thousands of examples. In contrast, Deep Neural Networks (DNNs), when built from scratch, would need orders more data for typical prediction tasks. The upside here is far better predictions.</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In this century, we are having a data explosion with quintillions of bytes of data being created every single day — images, text, videos, sensor data, and more. But to make effective use of this data, we need labels. To build a sentiment classifier to know whether an Amazon review is positive or negative, we need thousands of sentences and an assigned emotion for each. To train a face segmentation system for a Snapchat lens, we need the precise location of eyes, lips, nose, and so forth on thousands of images. To train a self-driving car, we need video segments labeled with the human driver’s reactions on controls such as the brakes, accelerator, steering wheel, and so forth. These labels act as teachers to our AI and are far more valuable than unlabeled data alone.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark106">Getting labels can be pricey. It’s no wonder that there is an entire industry around crowdsourcing labeling tasks among thousands of workers. Each label might cost from a few cents to dollars, depending on the time spent by the workers to assign it. For example, during the development of the Microsoft COCO (Common Objects in Context) dataset, it took roughly three seconds to label the name of each object in an image, approximately 30 seconds to place a bounding box around each object, and 79 seconds to draw the outlines for each object. Repeat that hundreds of thousands of times and you can begin to fathom the costs around some of the larger datasets. Some labeling companies like Appen and Scale AI are already valued at more than a billion dollars each.</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We might not have a million dollars in our bank account. But luckily for us, two good things happened in this deep learning revolution:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_103.png"/></span></p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">Gigantic labeled datasets have been generously made public by major companies and universities.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_104.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;"><a name="bookmark107">A technique called </a><i>transfer learning, </i><a href="#bookmark458" class="s30">which allows us to tune our models to datasets with even hundreds of examples — as long as our model was originally trained on a larger dataset similar to our current set. We use this repeatedly in the book, including in </a><a href="#bookmark458" class="s18">Chapter 5</a> where</p><p class="s17" style="padding-top: 3pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">we experiment and prove even a few tens of examples can get us decent performance with this technique. Transfer learning busts the myth that big data is necessary for training a good model. Welcome to the world of <i>tiny data</i>!</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s39" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark108">Table 1-2 </a><span style=" color: #000;">showcases some of the popular datasets out there today for a variety of deep learning tasks.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s33" style="padding-left: 9pt;text-indent: 0pt;text-align: left;"><a name="bookmark109">Data type</a></p><p class="s22" style="padding-top: 4pt;padding-left: 49pt;text-indent: 0pt;text-align: left;">Table 1-2. A diverse range of public datasets</p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="1" alt="image" src="KerasTensorFlow2019/Image_105.png"/></span></p><p class="s33" style="padding-top: 10pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Name Details</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_106.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s26" style="padding-top: 3pt;padding-left: 56pt;text-indent: -46pt;text-align: left;">Image Open Images V4</p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="99" alt="image" src="KerasTensorFlow2019/Image_107.png"/></span></p><p class="s26" style="text-indent: 0pt;text-align: left;">Contains bounding boxes, segmentation, and five captions per image</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="text-indent: 0pt;line-height: 12pt;text-align: left;">330,000 images with 80 object categories</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="text-indent: 0pt;text-align: left;">Microsoft COCO</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-top: 5pt;padding-left: 56pt;text-indent: 0pt;text-align: left;">(from Google)</p><p class="s26" style="padding-top: 3pt;padding-left: 21pt;text-indent: 0pt;text-align: left;">Nine million images in 19,700 categories</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_108.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_109.png"/></span></p><p class="s26" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">1.74 Million images with 600 categories (bounding boxes)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s26" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Video YouTube-</p><p class="s26" style="padding-left: 56pt;text-indent: 0pt;text-align: left;">8M</p><p class="s26" style="padding-top: 4pt;padding-left: 21pt;text-indent: 0pt;text-align: left;">6.1 million videos, 3,862 classes, 2.6 billion audio-visual features</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_110.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_111.png"/></span></p><p class="s26" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">3.0 labels/video</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="440" height="178" alt="image" src="KerasTensorFlow2019/Image_112.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_113.png"/></span></p><ol id="l1"><ol id="l2"><li><p class="s26" style="padding-left: 45pt;text-indent: -24pt;text-align: left;">TB of randomly sampled videos</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:6.65632pt" cellspacing="0"><tr style="height:133pt"><td style="width:47pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" rowspan="2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 7pt;padding-left: 3pt;padding-right: 6pt;text-indent: 0pt;text-align: left;">Video, images</p></td><td style="width:395pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 7pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">BDD100K 100,000 driving videos over 1,100 hours</p><p class="s35" style="padding-top: 10pt;padding-left: 3pt;padding-right: 31pt;text-indent: 0pt;line-height: 57%;text-align: left;">(from UC <span class="s34">100,000 images with bounding boxes for 10 categories Berkeley)</span></p><p class="s34" style="padding-top: 4pt;padding-left: 95pt;text-indent: 0pt;text-align: left;">100,000 images with lane markings</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s34" style="padding-left: 95pt;padding-right: 31pt;text-indent: 0pt;line-height: 195%;text-align: left;">100,000 images with drivable-area segmentation 10,000 images with pixel-level instance segmentation</p></td></tr><tr style="height:46pt"><td style="width:395pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;padding-right: 31pt;text-indent: 0pt;text-align: left;">Waymo 3,000 driving scenes totaling 16.7 hours of video data, 600,000 Open    frames, approximately 25 million 3D bounding boxes, and 22 Dataset million 2D bounding boxes</p></td></tr><tr style="height:19pt"><td style="width:47pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Text</p></td><td style="width:395pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">SQuAD 150,000 Question and Answer snippets from Wikipedia</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="62" alt="image" src="KerasTensorFlow2019/Image_114.png"/></span></p><p class="s26" style="text-indent: 0pt;text-align: left;">Several million satellite images (100 nautical mile width and height), along with eight spectral bands (15- to 60-meter spatial resolution)</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="text-indent: 0pt;text-align: left;">Satellite Landsat data Data</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-top: 2pt;padding-left: 56pt;text-indent: 0pt;text-align: left;">Yelp Reviews</p><p class="s26" style="padding-top: 2pt;padding-left: 21pt;text-indent: 0pt;text-align: left;">Five million Yelp reviews</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="1" alt="image" src="KerasTensorFlow2019/Image_115.png"/></span></p><p class="s33" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Data type</p><p class="s33" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Name Details</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_116.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_117.png"/></span></p><p class="s26" style="padding-top: 3pt;padding-left: 56pt;text-indent: -46pt;text-align: left;">Audio Google AudioSet</p><p class="s26" style="padding-top: 3pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">2,084,320 10-second sound clips from YouTube with 632 categories</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 53pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="524" height="1" alt="image" src="KerasTensorFlow2019/Image_118.png"/></span></p><p class="s26" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">LibriSpeech 1,000 hours of read English speech</p><p style="padding-left: 53pt;text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark43">Model Architecture</a><a name="bookmark110">&zwnj;</a></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark112" class="s30" name="bookmark111">At a high level, a model is just a function. It takes in one or more inputs and gives an output. The input might be in the form of text, images, audio, video, and more. The output is a prediction. A good model is one whose predictions reliably match the expected reality. The model’s accuracy on a dataset is a major determining factor as to whether it’s suitable for use in a real-world application. For many people, this is all they really need to know about deep learning models. But it’s when we peek into the inner workings of a model that it becomes really interesting (</a>Figure 1-9<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><span><img width="498" height="105" alt="image" src="KerasTensorFlow2019/Image_119.jpg"/></span></p><p class="s19" style="padding-top: 7pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark112">Figure 1-9. A black box view of a deep learning model</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Inside the model is a graph that consists of nodes and edges. Nodes represent mathematical operations, whereas edges represent how the data flows from one node to another. In other words, if the output of one node can become the input to one or more nodes, the connections between those nodes are represented by edges. The structure of this graph determines the potential for accuracy, its speed, how much resources it consumes (memory, compute, and energy), and the type of input it’s capable of processing.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark113">The layout of the nodes and edges is known as the </a><i>architecture </i>of the model. Essentially, it’s a blueprint. Now, the blueprint is only half the picture. We still need the actual building. Training is the process that utilizes this blueprint to construct that building. We train a model by repeatedly 1) feeding it input data, 2) getting outputs from it, 3) monitoring how far these predictions are from the expected reality (i.e., the labels associated with the data), and then, 4) propagating the magnitude of error back to the model so that it can progressively learn to correct itself. This training process is performed iteratively until we are satisfied with the accuracy of the predictions.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark114">The result from this training is a set of numbers (also known as weights) that is assigned to each of the nodes. These weights are necessary parameters for the nodes in the graph to operate on the input given to them. Before the training begins, we usually assign random numbers as</a></p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">weights. The goal of the training process is essentially to gradually tune the values of each set of these weights until they, in conjunction with their corresponding nodes, produce satisfactory predictions.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">To understand weights a little better, let’s examine the following dataset with two inputs and one output:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s22" style="padding-left: 159pt;text-indent: 0pt;text-align: center;">Table 1-3. Example dataset</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:166.968pt" cellspacing="0"><tr style="height:20pt"><td style="width:40pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s36" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">input<span class="s37">1</span></p></td><td style="width:40pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s36" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">input<span class="s37">2</span></p></td><td style="width:41pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s36" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">output</p></td></tr><tr style="height:19pt"><td style="width:40pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">1</p></td><td style="width:40pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">6</p></td><td style="width:41pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">20</p></td></tr><tr style="height:19pt"><td style="width:40pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2</p></td><td style="width:40pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">5</p></td><td style="width:41pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">19</p></td></tr><tr style="height:19pt"><td style="width:40pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">3</p></td><td style="width:40pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">4</p></td><td style="width:41pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">18</p></td></tr><tr style="height:19pt"><td style="width:40pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">4</p></td><td style="width:40pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">3</p></td><td style="width:41pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">17</p></td></tr><tr style="height:19pt"><td style="width:40pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">5</p></td><td style="width:40pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2</p></td><td style="width:41pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">16</p></td></tr><tr style="height:19pt"><td style="width:40pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">6</p></td><td style="width:40pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">1</p></td><td style="width:41pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">15</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Using linear algebra (or guesswork in our minds), we can deduce that the equation governing this dataset is:</p><p class="s22" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">output = f(input<span class="s38">1</span>, input<span class="s38">2</span><span class="s17">) = 2 x </span>input<span class="s38">1 </span><span class="s17">+ 3 x </span>input<span class="s38">2</span></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In this case, the weights for this mathematical operation are 2 and 3. A deep neural network has millions of such weight parameters.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Depending on the types of nodes used, different themes of model architectures will be better suited for different kinds of input data. For example, CNNs are used for image and audio, whereas Recurrent Neural Networks (RNNs) and LSTM are often used in text processing.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In general, training one of these models from scratch can take a pretty significant amount of time, potentially weeks. Luckily for us, many researchers have already done the difficult work of training them on a generic dataset (like ImageNet) and have made them available for everyone to use. What’s even better is that we can take these available models and tune them to our specific dataset. This process is called transfer learning and accounts for the vast majority of needs by practitioners.</p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark115" class="s30">Compared to training from scratch, transfer learning provides a two-fold advantage: significantly reduced training time a (few minutes to hours instead of weeks), and it can work with a substantially smaller dataset (hundreds to thousands of data samples instead of millions). </a><a href="#bookmark115" class="s18">Table </a>1-4 <span style=" color: #000;">shows some famous examples of model architectures.</span></p><p class="s22" style="padding-top: 3pt;padding-left: 211pt;text-indent: -126pt;text-align: left;"><a name="bookmark115">Table 1-4. Example model architectures over the years</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 71pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="413" height="1" alt="image" src="KerasTensorFlow2019/Image_120.png"/></span></p><p class="s33" style="padding-top: 1pt;padding-bottom: 3pt;padding-left: 75pt;text-indent: 0pt;text-align: left;">Task Example model architectures</p><p style="padding-left: 71pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="413" height="1" alt="image" src="KerasTensorFlow2019/Image_121.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="415" height="27" alt="image" src="KerasTensorFlow2019/Image_122.png"/></span></p><p class="s26" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Text classification BERT (2018), XLNet (2019)</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-top: 1pt;padding-bottom: 3pt;padding-left: 75pt;text-indent: 0pt;text-align: left;">Image classification ResNet-152 (2015), MobileNet (2017)</p><p style="text-indent: 0pt;text-align: left;"><span><img width="415" height="27" alt="image" src="KerasTensorFlow2019/Image_123.png"/></span></p><p class="s26" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Image translation Pix2Pix (2017)</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-top: 2pt;padding-bottom: 3pt;padding-left: 75pt;text-indent: 0pt;text-align: left;">Image segmentation U-Net (2015), DeepLabV3 (2018)</p><p style="text-indent: 0pt;text-align: left;"><span><img width="415" height="27" alt="image" src="KerasTensorFlow2019/Image_124.png"/></span></p><p class="s26" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Speech generation WaveNet (2016)</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-top: 2pt;padding-bottom: 3pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">Object detection         YOLO9000 (2016), Mask R-CNN (2017)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s39" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark115" class="s30">Each one of the models from </a><a href="#bookmark115" class="s18">Table </a>1-4 <span style=" color: #000;">has a published accuracy metric on reference datasets (e.g., ImageNet for classification, MS COCO for detection). Additionally, these architectures have their own characteristic resource requirements (model size in megabytes, computation requirements in floating-point operations, or FLOPS).</span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="536" height="148" alt="image" src="KerasTensorFlow2019/Image_125.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">When Kaiming He et al. came up with the 152-layer ResNet architecture in 2015 — a feat of its day considering the previous largest GoogLeNet model consisted of 22 layers — there was just one question on everyone’s mind: “Why not 153 layers?” The reason, as it turns out, was that Kaiming ran out of GPU memory!</p><p style="text-indent: 0pt;text-align: left;"/><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We explore transfer learning in-depth in the upcoming chapters. Now, let’s look at the kinds of deep learning frameworks and services that are available to us.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark44">Frameworks</a><a name="bookmark116">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark117">There are several deep learning libraries out there that help us train our models. Additionally, there are frameworks that specialize in using those trained models to make predictions (or </a><i>inference</i>), optimizing for where the application resides.</p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark118" class="s30">Historically, as is the case with software generally, many libraries have come and gone — Torch (2002), Theano (2007), Caffe (2013), Microsoft Cognitive Toolkit (2015), Caffe2 (2017) — and the landscape has been evolving rapidly. Learnings from each have made the other libraries easier to pick up, driven interest, and improved productivity for beginners and experts alike. </a>Table 1-5 <span style=" color: #000;">looks at some of the popular ones.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s22" style="padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark118">Table 1-5. Popular deep learning frameworks</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:31.9336pt" cellspacing="0"><tr style="height:19pt"><td style="width:150pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s36" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Framework</p></td><td style="width:84pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s36" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Best suited for</p></td><td style="width:157pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s36" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Typical target platform</p></td></tr><tr style="height:19pt"><td style="width:150pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">TensorFlow (including Keras)</p></td><td style="width:84pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Training</p></td><td style="width:157pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Desktops, servers</p></td></tr><tr style="height:19pt"><td style="width:150pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">PyTorch</p></td><td style="width:84pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Training</p></td><td style="width:157pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Desktops, servers</p></td></tr><tr style="height:19pt"><td style="width:150pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">MXNet</p></td><td style="width:84pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Training</p></td><td style="width:157pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Desktops, servers</p></td></tr><tr style="height:19pt"><td style="width:150pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">TensorFlow Serving</p></td><td style="width:84pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Inference</p></td><td style="width:157pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Servers</p></td></tr><tr style="height:19pt"><td style="width:150pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">TensorFlow Lite</p></td><td style="width:84pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Inference</p></td><td style="width:157pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Mobile and embedded devices</p></td></tr><tr style="height:19pt"><td style="width:150pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">TensorFlow.js</p></td><td style="width:84pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Inference</p></td><td style="width:157pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Browsers</p></td></tr><tr style="height:19pt"><td style="width:150pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">ml5.js</p></td><td style="width:84pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Inference</p></td><td style="width:157pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Browsers</p></td></tr><tr style="height:19pt"><td style="width:150pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Core ML</p></td><td style="width:84pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Inference</p></td><td style="width:157pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Apple devices</p></td></tr><tr style="height:19pt"><td style="width:150pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Xnor AI2GO</p></td><td style="width:84pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Inference</p></td><td style="width:157pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Embedded devices</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s40" style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark45">TensorFlow</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark119">In 2011, Google Brain developed the DNN library DistBelief for internal research and engineering. It helped train Inception (2014’s winning entry to the ImageNet Large Scale Visual Recognition Challenge) as well as helped improve the quality of speech recognition within Google products. Heavily tied into Google’s infrastructure, it was not easy to configure and to share code with external machine learning enthusiasts. Realizing the limitations, Google began working on a second-generation distributed machine learning framework, which promised to be general-purpose, scalable, highly performant, and portable to many hardware platforms. And the best part, it was open source. Google called it TensorFlow and announced its release on November 2015.</a></p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">TensorFlow delivered on a lot of these aforementioned promises, developing an end-to-end ecosystem from development to deployment, and it gained a massive following in the process. With more than 100,000 stars on GitHub, it shows no signs of stopping. However, as adoption gained, users of the library rightly criticized it for not being easy enough to use. As the joke went, TensorFlow was a library by Google engineers, of Google engineers, for Google engineers, and if you were smart enough to use TensorFlow, you were smart enough to get hired there.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">But Google was not alone here. Let’s be honest. Even as late as 2015, it was a given that working with deep learning libraries would inevitably be an unpleasant experience. Forget even working on these; installing some of these frameworks made people want to pull their hair out. (Caffe users out there — does this ring a bell?)</p><p class="s40" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark46">Keras</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark120">As an answer to the hardships faced by deep learning practitioners, François Chollet released the open source framework Keras in March 2015, and the world hasn’t been the same since. This solution suddenly made deep learning accessible to beginners. Keras provided an intuitive and easy-to-use interface for coding, which would then use other deep learning libraries as the backend computational framework. Starting with Theano as its first backend, Keras encouraged rapid prototyping and reduced the number of lines of code. Eventually, this abstraction expanded to other frameworks including Cognitive Toolkit, MXNet, PlaidML, and, yes, TensorFlow.</a></p><p class="s40" style="padding-top: 13pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark47">PyTorch</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark121">In parallel, PyTorch started at Facebook early in 2016, where engineers had the benefit of observing TensorFlow’s limitations. PyTorch supported native Python constructs and Python debugging right off the bat, making it flexible and easier to use, quickly becoming a favorite among AI researchers. It is the second-largest end-to-end deep learning system.</a></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Facebook additionally built Caffe2 to take PyTorch models and deploy them to production to serve more than a billion users. Whereas PyTorch drove research, Caffe2 was primarily used in production. In 2018, Caffe2 was absorbed into PyTorch to make a full framework.</p><p class="s40" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark48">A continuously evolving landscape</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Had this story ended with the ease of Keras and PyTorch, this book would not have the word “TensorFlow” in the subtitle. The TensorFlow team recognized that if it truly wanted to broaden the tool’s reach and</p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">democratize AI, it needed to make the tool easier. So it was welcome news when Keras was officially included as part of TensorFlow, offering the best of both worlds. This allowed developers to use Keras for defining the model and training it, and core TensorFlow for its high-performance data pipeline, including distributed training and ecosystem to deploy. It was a match made in heaven! And to top it all, TensorFlow 2.0 (released in 2019) included support for native Python constructs and eager execution, as we saw in PyTorch.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark122">With so many competing frameworks available, the question of portability inevitability arises. Imagine a new research paper published with the state- of-the-art model being made public in PyTorch. If we didn’t work in PyTorch, we would be locked out of the research and would have to reimplement and train it. Developers like to be able to share models freely and not be restricted to a specific ecosystem. Organically, many developers wrote libraries to convert model formats from one library to another. It was a simple solution, except that it led to a combinatorial explosion of conversion tools that lacked official support and sufficient quality due to the sheer number of them. To address this issue, the Open Neural Network Exchange (ONNX) was championed by Microsoft and Facebook, along with major players in the industry. ONNX provided a specification for a common model format that was readable and writable by a number of popular libraries officially. Additionally, it provided converters for libraries that did not natively support this format. This allowed developers to train in one framework and do inferences in a different framework.</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark123">Apart from these frameworks, there are several Graphical User Interface (GUI) systems that make code-free training possible. Using transfer learning, they generate trained models quickly in several formats useful for inference. With point-and-click interfaces, even your grandma can now train a neural network!</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s22" style="padding-left: 169pt;text-indent: -30pt;text-align: left;">Table 1-6. Popular GUI-based model training tools</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 127pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="264" height="1" alt="image" src="KerasTensorFlow2019/Image_126.png"/></span></p><p class="s33" style="padding-top: 1pt;padding-bottom: 3pt;padding-left: 130pt;text-indent: 0pt;text-align: left;">Service Platform</p><p style="padding-left: 127pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="264" height="1" alt="image" src="KerasTensorFlow2019/Image_127.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="267" height="27" alt="image" src="KerasTensorFlow2019/Image_128.png"/></span></p><p class="s26" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">Google AutoML Web-based</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-top: 1pt;padding-bottom: 3pt;padding-left: 130pt;text-indent: 0pt;text-align: left;">Microsoft CustomVision.AI Web-based</p><p style="text-indent: 0pt;text-align: left;"><span><img width="267" height="27" alt="image" src="KerasTensorFlow2019/Image_129.png"/></span></p><p class="s26" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">IBM Visual Recognition Web-based</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-top: 2pt;padding-bottom: 3pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">Clarifai                                 Web-based</p><p class="s26" style="padding-top: 2pt;padding-bottom: 3pt;padding-left: 130pt;text-indent: 0pt;text-align: left;">Apple Create ML macOS</p><p style="padding-left: 127pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="264" height="1" alt="image" src="KerasTensorFlow2019/Image_130.png"/></span></p><p style="padding-left: 127pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="264" height="1" alt="image" src="KerasTensorFlow2019/Image_131.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="267" height="27" alt="image" src="KerasTensorFlow2019/Image_132.png"/></span></p><p class="s26" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">NVIDIA DIGITS Desktop</p><p style="text-indent: 0pt;text-align: left;"/><p class="s33" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 16pt;text-indent: 0pt;text-align: center;">Service                               Platform</p><p class="s26" style="padding-top: 2pt;padding-bottom: 3pt;padding-left: 12pt;text-indent: 0pt;text-align: center;">Runway ML                         Desktop</p><p style="padding-left: 127pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="264" height="1" alt="image" src="KerasTensorFlow2019/Image_133.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark124">So why did we choose TensorFlow and Keras as the primary frameworks for this book? Considering the sheer amount of material available, including documentation, Stack Overflow answers, online courses, the vast community of contributors, platform and device support, industry adoption, and, yes, open jobs available (approximately three times as many TensorFlow-related roles compared to PyTorch in the United States), TensorFlow and Keras currently dominate the landscape when it comes to frameworks. It made sense for us to select this combination. That said, the techniques discussed in the book are generalizable to other libraries, as well. Picking up a new framework shouldn’t take you too long. So, if you really want to move to a company that uses PyTorch exclusively, don’t hesitate to apply there.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark49">Hardware</a><a name="bookmark125">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark126">In 1848, when James W. Marshall discovered gold in California, the news spread like wildfire across the United States. Hundreds of thousands of people stormed to the state to begin mining for riches. This was known as the </a><i>California Gold Rush</i>. Early movers were able to extract a decent chunk, but the latecomers were not nearly as lucky. But the rush did not stop for many years. Can you guess who made the most money throughout this period? The shovel makers!</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Cloud and hardware companies are the shovel makers of the twenty-first century. Don’t believe us? Look at the stock performance of Microsoft and NVIDIA in the past decade. The only difference between 1849 and now is the mind-bogglingly large amount of shovel choices available to us.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;">Given the variety of hardware available, it is important to make the correct choices for the constraints imposed by resource, latency, budget, privacy, and legal requirements of the application.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Depending on how your application interacts with the user, the inference phase usually has a user waiting at the other end for a response. This imposes restrictions on the type of hardware that can be used as well as the location of the hardware. For example, a Snapchat lens cannot run on the cloud due to the network latency issues. Additionally, it needs to run in close to real time to provide a good user experience (UX), thus setting a minimum requirement on the number of frames processed per second (typically &gt;15 fps). On the other hand, a photo uploaded to an image library such as Google Photos does not need immediate image categorization done on it. A few seconds or few minutes of latency is acceptable.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Going to the other extreme, training takes a lot more time; anywhere between minutes to hours to days. Depending on our training scenario, the real value of better hardware is enabling faster experimentation and more iterations. For anything more serious than basic neural networks, better hardware can make a mountain of difference. Typically, GPUs would speed things up by 10 to 15 times compared to CPUs, and at a much higher performance per watt, reducing the wait time for our experiment to finish from a week to a few hours. This can be the difference in watching a documentary about the Grand Canyon (two hours) versus actually making the trip to visit the Grand Canyon (four days).</p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark127" class="s30">Following are a few fundamental hardware categories to choose from and how they are typically characterized (see also </a>Figure 1-10<span style=" color: #000;">):</span></p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;">Central Processing Unit (CPU)</p><p class="s17" style="padding-top: 3pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">Cheap, flexible, slow. For example, Intel Core i9-9900K.</p><p class="s22" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">GPU</p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;line-height: 107%;text-align: left;">High throughput, great for batching to utilize parallel processing, expensive. For example, NVIDIA GeForce RTX 2080 Ti.</p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Field-Programmable Gate Array (FPGA)</p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;line-height: 107%;text-align: left;">Fast, low power, reprogrammable for custom solutions, expensive. Known companies include Xilinx, Lattice Semiconductor, Altera (Intel). Because of the ability to run in seconds and configurability to any AI model, Microsoft Bing runs the majority of its AI on FPGAs.</p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Application-Specific Integrated Circuit (ASIC)</p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;line-height: 107%;text-align: left;">Custom-made chip. Extremely expensive to design, but inexpensive when built for scale. Just like in the pharmaceutical industry, the first item costs the most due to the R&amp;D effort that goes into designing and making it. Producing massive quantities is rather inexpensive. Specific examples include the following:</p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Tensor Processing Unit (TPU)</p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;line-height: 107%;text-align: left;">ASIC specializing in operations for neural networks, available on Google Cloud only.</p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Edge TPU</p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">Smaller than a US penny, accelerates inference on the edge.</p><p class="s22" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Neural Processing Unit (NPU)</p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;line-height: 107%;text-align: left;">Often used by smartphone manufacturers, this is a dedicated chip for accelerating neural network inference.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 32pt;text-indent: 0pt;text-align: left;"><span><img width="520" height="285" alt="image" src="KerasTensorFlow2019/Image_134.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 206pt;text-indent: -197pt;text-align: left;"><a name="bookmark127">Figure 1-10. Comparison of different types of hardware relative to flexibility, performance, and cost</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_135.png"/></span></p><p class="s17" style="padding-top: 6pt;padding-left: 33pt;text-indent: -26pt;line-height: 142%;text-align: left;">Let’s look at a few scenarios for which each one would be used: Getting started with training → CPU</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_136.png"/></span></p><p class="s17" style="padding-top: 7pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">Training large networks → GPUs and TPUs</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_137.png"/></span></p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">Inference on smartphones → Mobile CPU, GPU, Digital Signal Processor (DSP), NPU</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_138.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">Wearables (e.g., smart glasses, smartwatches) → Edge TPU, NPUs</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_139.png"/></span></p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">Embedded AI projects (e.g., flood surveying drone, autonomous wheelchair) → Accelerators like Google Coral, Intel Movidius with Raspberry Pi, or GPUs like NVIDIA Jetson Nano, all the way down to</p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">$15 microcontrollers (MCUs) for wake word detection in smart speakers</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark128">As we go through the book, we will closely explore many of these.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark50">Responsible AI</a><a name="bookmark129">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark130">So far, we have explored the power and the potential of AI. It shows great promise to enhance our abilities, to make us more productive, to give us superpowers.</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">But with great power comes great responsibility.</p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">As much as AI can help humanity, it also has equal potential to harm us when not designed with thought and care (either intentionally or unintentionally). The AI is not to blame; rather, it’s the AI’s designers.</p><p class="s17" style="padding-top: 5pt;padding-left: 33pt;text-indent: -26pt;text-align: left;">Consider some real incidents that made the news in the past few years.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_140.png"/></span></p><p class="s17" style="padding-top: 6pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">“<u> </u><a href="#bookmark131" class="s30">can allegedly determine whether you’re a terrorist just by analyzing your face” (</a><span style=" color: #8E0012;">Figure 1-11</span>): <i>Computer World</i>, 2016</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_141.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">“AI is sending people to jail — and getting it wrong”: <i>MIT Tech Review</i>, 2019</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_142.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">“<u> </u>supercomputer recommended ‘unsafe and incorrect’ cancer treatments, internal documents show”: <i>STAT News</i>, 2018</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_143.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">“<u> </u>built an AI tool to hire people but had to shut it down because it was discriminating against women”: <i>Business Insider</i>, 2018</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_144.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">“<u> </u>AI study: Major object recognition systems favor people with more money”: <i>VentureBeat</i>, 2019</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_145.png"/></span></p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">“</p><p style="padding-left: 37pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="40" height="1" alt="image" src="KerasTensorFlow2019/Image_146.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="39" height="1" alt="image" src="KerasTensorFlow2019/Image_147.png"/></span></p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">later,</p><p class="s17" style="padding-top: 4pt;padding-left: 29pt;text-indent: -28pt;text-align: left;">labeled black people ‘gorillas’” <i>USA Today</i>, 2015. “Two years solves ‘racist algorithm’ problem by purging ‘gorilla’ label</p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">from image classifier”: <i>Boing Boing</i>, 2018</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_148.png"/></span></p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">“<u> </u>silences its new A.I. bot Tay, after Twitter users teach it racism”:</p><p class="s22" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">TechCrunch<span class="s17">, 2016</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_149.png"/></span></p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">“AI Mistakes Bus-Side Ad for Famous CEO, Charges Her With Jaywalking”: <i>Caixin Global</i>, 2018</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_150.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">“<u> </u>to drop Pentagon AI contract after employee objections to the ‘business of war’”: <i>Washington Post</i>, 2018</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_151.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">“Self-driving<u> </u>death car ‘spotted pedestrian six seconds before mowing down and killing her’”: <i>The Sun</i>, 2018</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="532" height="257" alt="image" src="KerasTensorFlow2019/Image_152.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 38pt;text-indent: 0pt;text-align: left;"><a name="bookmark131">Figure 1-11. Startup claiming to classify people based on their facial structure</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Can you fill in the blanks here? We’ll give you some options — Amazon, Microsoft, Google, IBM, and Uber. Go ahead and fill them out. We’ll wait.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">There’s a reason we kept them blank. It’s to recognize that it’s not a problem belonging to a specific individual or a company. This is everyone’s problem. And although these things happened in the past, and might not reflect the current state, we can learn from them and try not to make the same mistakes. The silver lining here is that everyone learned from these mistakes.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We, as developers, designers, architects, and leaders of AI, have the responsibility to think beyond just the technical problem at face value. Following are just a handful of topics that are relevant to any problem we solve (AI or otherwise). They must not take a backseat.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark51">Bias</a><a name="bookmark132">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark133">Often in our everyday work, we bring in our own biases, knowingly or unknowingly. This is the result of a multitude of factors including our environment, upbringing, cultural norms, and even our inherent nature. After all, AI and the datasets that power them were not created in a vacuum — they were created by human beings with their own biases. Computers don’t magically create bias on their own, they reflect and amplify existing ones.</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Take the example from the early days of the YouTube app when the developers noticed that roughly 10% of uploaded videos were upside- down. Maybe if that number had been lower, say 1%, it could have been brushed off as user error. But 10% was too high a number to be ignored. Do you know who happens to make up 10% of the population? Left- handed people! These users were holding their phones in the opposite orientation as their right-handed peers. But the engineers at YouTube had not accounted for that case during the development and testing of their mobile app, so YouTube uploaded videos to its server in the same orientation for both left-handed and right-handed users.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">This problem could have been caught much earlier if the developers had even a single left-handed person on the team. This simple example demonstrates the importance of diversity. Handedness is just one small attribute that defines an individual. Numerous other factors, often outside their control, often come into play. Factors such as gender, skin tone, economic status, disability, country of origin, speech patterns, or even something as trivial as hair length can determine life-changing outcomes for someone, including how an algorithm treats them.</p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://oreil.ly/ySfNv" class="s30" target="_blank" name="bookmark134">Google’s </a><a href="https://oreil.ly/ySfNv" class="s18" target="_blank">machine learning glossary</a> <span style=" color: #000;">lists several forms of bias that can affect a machine learning pipeline. The following are just some of them:</span></p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Selection bias</p><p class="s17" style="padding-top: 3pt;padding-left: 33pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark135">The dataset is not representative of the distribution of the real-world problem and is skewed toward a subset of categories. For example, in many virtual assistants and smart home speakers, some spoken accents are overrepresented, whereas other accents have no data at all in the training dataset, resulting in a poor UX for large chunks of the world’s population.</a></p><p class="s39" style="padding-left: 33pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a href="#bookmark136" class="s30">Selection bias can also happen because of co-occurrence of concepts. For example, Google Translate, when used to translate the sentences “She is a doctor. He is a nurse” into a gender-neutral language such as Turkish and then back, switches the genders, as demonstrated in </a>Figure 1-12<span style=" color: #000;">. This is likely because the dataset contains a large sample of co-occurrences of male pronouns and the word “doctor,” and female pronouns and the word “nurse.”</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 30pt;text-indent: 0pt;text-align: left;"><span><img width="526" height="133" alt="image" src="KerasTensorFlow2019/Image_153.jpg"/></span></p><p class="s19" style="padding-top: 7pt;padding-left: 213pt;text-indent: -193pt;text-align: left;"><a name="bookmark136">Figure 1-12. Google Translate reflecting the underlying bias in data (as of September 2019)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s22" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Implicit bias</p><p class="s39" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;line-height: 106%;text-align: left;"><a href="#bookmark139" class="s30" name="bookmark137">This type of bias creeps in because of implicit assumptions that we all make when we see something. Consider the highlighted portion in </a>Figure 1-13<a href="#bookmark157" class="s30">. Anyone shown it might assume with a high amount of certainty that those stripes belong to a zebra. In fact, given how much ImageNet-trained networks are biased toward textures,</a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; vertical-align: 4pt;">2 </span><span style=" color: #000;">most of them will classify the full image as a zebra. Except that we know that the image is of a sofa upholstered in a zebra-like fabric.</span><a name="bookmark138">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><span><img width="535" height="396" alt="image" src="KerasTensorFlow2019/Image_154.jpg"/></span></p><p class="s19" style="padding-top: 5pt;padding-left: 47pt;text-indent: 0pt;text-align: left;"><a href="https://oreil.ly/Xg4MP" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 11pt;" target="_blank" name="bookmark139">Figure 1-13. Zebra sofa by Glen Edelson (</a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 11pt;">image source</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s22" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Reporting bias</p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark140">Sometimes the loudest voices in the room are the most extreme ones and dominate the conversation. One good look at Twitter might make it seem as if the world is ending, whereas most people are busy leading mundane lives. Unfortunately, boring does not sell.</a></p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">In-group/out-group bias</p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark141">An annotator from East Asia might look at a picture of the Statue of Liberty and give it tags like “America” or “United States,” whereas someone from the US might look at the same picture and assign more granular tags such as “New York” or “Liberty Island.” It’s human nature to see one’s own groups with nuance while seeing other groups as more homogenous, and that reflects in our datasets, as well.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark52">Accountability and Explainability</a><a name="bookmark142">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark143">Imagine, in the late 1800s, Mr. Karl Benz told you that he invented this four-wheeled device that could transport you quicker than anything else in existence. Except he had no idea how it worked. All he knew was that it</a></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">consumed a highly flammable liquid that exploded several times inside it to propel it forward. What caused it to move? What caused it to stop? What stopped it from burning the person sitting inside it? He had no answers. If this was the origin story of the car, you’d probably not want to get into that contraption.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;">This is precisely what is happening with AI right now. Previously, with traditional machine learning, data scientists had to manually pick features (predictive variables) from data, from which a machine learning model then would learn. This manual selection process, although cumbersome and restrictive, gave them more control and insight into how the prediction came about. However, with deep learning, these features are automatically selected. Data scientists are able to build models by providing lots of data, and these models somehow end up making predictions reliably — most of the time. But the data scientist doesn’t know exactly how the model works, what features it learned, under what circumstances the model works, and, more importantly, the circumstances under which it doesn’t work. This approach might be acceptable when Netflix is recommending TV shows to us based on what we’ve already watched (although we’re fairly certain they have the line <span class="s42">recommendations.append(&quot;Stranger Things&quot;) </span>in their code somewhere). But AI does a lot more than just recommend movies these days. Police and judicial systems are beginning to rely on algorithms to decide whether someone poses a risk to society and whether they should be detained before their trial. The lives and freedoms of many people are at stake. We simply must not outsource important decision making to an unaccountable black box. Thankfully, there’s momentum to change that with investments in <i>Explainable AI</i>, wherein the model would be able to not just provide predictions but also account for the factors that caused it to make a certain prediction, and reveal areas of limitations.</p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Additionally, cities (such as New York) are beginning to make their algorithms accountable to the public by recognizing that the public has a right to know what algorithms they use for vital decision making and how they work, allowing reviews and audits by experts, improving expertise in government agencies to better evaluate each system they add, and by providing mechanisms to dispute a decision made by an algorithm.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark53">Reproducibility</a><a name="bookmark144">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark145">Research performed in the scientific field gains wide acceptance by the community only when it’s reproducible; that is, anyone studying the research should be able to replicate the conditions of the test and obtain the same results. Unless we can reproduce a model’s past results, we cannot hold it accountable when using it in the future. In the absence of reproducibility, research is vulnerable to </a><i>p-hacking </i>— tweaking the parameters of an experiment until the desired results are obtained. It’s vital for researchers to extensively document their experimental conditions, including the dataset(s), benchmarks, and algorithms, and declare the hypothesis they will be testing prior to performing an experiment. Trust in institutions is at an all-time low and research that is not grounded in reality, yet sensationalized by the media, can erode that trust even more.</p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Traditionally, replicating a research paper was considered a dark art because many implementation details are left out. The uplifting news is that researchers are now gradually beginning to use publicly available benchmarks (as opposed to their privately constructed datasets) and open sourcing the code they used for their research. Members of the community can piggyback on this code, prove it works, and make it better, thereby leading to newer innovations rapidly.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark54">Robustness</a><a name="bookmark146">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark147">There’s an entire area of research on one-pixel attacks on CNNs. Essentially, the objective is to find and modify a single pixel in an image to make a CNN predict something entirely different. For example, changing a single pixel in a picture of an apple might result in a CNN classifying it as a dog. A lot of other factors can influence predictions, such as noise, lighting conditions, camera angle, and more that would not have affected a human’s ability to make a similar call. This is particularly relevant for self- driving cars, where it would be possible for a bad actor on a street to modify the input the car sees in order to manipulate it into doing bad things. In fact, Tencent’s Keen Security Lab was able to exploit a vulnerability in Tesla’s AutoPilot by strategically placing small stickers on the road, which led it to change lanes and drive into the oncoming lane.</a></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Robust AI that is capable of withstanding noise, slight deviations, and intentional manipulation is necessary if we are to be able to trust it.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark55">Privacy</a><a name="bookmark148">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark149">In the pursuit of building better and better AI, businesses need to collect lots of data. Unfortunately, sometimes they overstep their bounds and collect information overzealously beyond what is necessary for the task at hand. A business might believe that it is using the data it collects only for good. But what if it is acquired by a company that does not have the same ethical boundaries for data use? The consumer’s information could be used for purposes beyond the originally intended goals. Additionally, all that data collected in one place makes it an attractive target for hackers, who steal personal information and sell it on the black market to criminal enterprises. Moreover, governments are already overreaching in an attempt to track each and every individual.</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">All of this is at odds to the universally recognized human right of privacy. What consumers desire is having transparency into what data is being collected about them, who has access to it, how it’s being used, and mechanisms to opt out of the data collection process, as well to delete data that was already collected on them.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">As developers, we want to be aware of all the data we are collecting, and ask ourselves whether a piece of data is even necessary to be collected in the first place. To minimize the data we collect, we could implement privacy-aware machine learning techniques such as Federated Learning (used in Google Keyboard) that allow us to train networks on the users’ devices without having to send any of the Personally Identifiable Information (PII) to a server.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark150">It turns out that in many of the aforementioned headlines at the beginning of this section, it was the bad PR fallout that brought mainstream awareness of these topics, introduced accountability, and caused an industry-wide shift in mindset to prevent repeats in the future. We must continue to hold ourselves, academics, industry leaders, and politicians accountable at every misstep and act swiftly to fix the wrongs. Every decision we make and every action we take has the potential to set a precedent for decades to come. As AI becomes ubiquitous, we need to come together to ask the tough questions and find answers for them if we want to minimize the potential harm while reaping the maximum benefits.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark56">Summary</a><a name="bookmark151">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">This chapter explored the landscape of the exciting world of AI and deep learning. We traced the timeline of AI from its humble origins, periods of great promise, through the dark AI winters, and up to its present-day resurgence. Along the way, we answered the question of why it’s different this time. We then looked at the necessary ingredients to build a deep learning solution, including datasets, model architectures, frameworks, and hardware. This sets us up for further exploration in the upcoming chapters. We hope you enjoy the rest of the book. It’s time to dig in!</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark57">Frequently Asked Questions</a><a name="bookmark152">&zwnj;</a></p><ol id="l3"><li><p class="s17" style="padding-top: 5pt;padding-left: 52pt;text-indent: -15pt;text-align: left;"><a name="bookmark153">I’m just getting started. Do I need to spend a lot of money on buying powerful hardware?</a></p><p class="s39" style="padding-left: 52pt;text-indent: 0pt;text-align: left;"><a href="#bookmark154" class="s30">Luckily for you, you can get started even with your web browser. All of our scripts are available online, and can be run on free GPUs courtesy of the kind people at Google Colab (</a>Figure 1-14<span style=" color: #000;">), who are generously making powerful GPUs available for free (up to 12 hours at a time). This should get you started. As you become better at it by performing more experiments (especially in a professional capacity or on large datasets), you might want to get a GPU either by renting one on the cloud (Microsoft Azure, Amazon Web Services (AWS), Google Cloud Platform (GCP), and others) or purchasing the hardware. Watch out for those electricity bills, though!</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 53pt;text-indent: 0pt;text-align: left;"><span><img width="532" height="325" alt="image" src="KerasTensorFlow2019/Image_155.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 231pt;text-indent: -161pt;text-align: left;"><a name="bookmark154">Figure 1-14. Screenshot of a notebook on GitHub running on Colab inside Chrome</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-top: 9pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Colab is great, but I already have a powerful computer that I purchased for playing &lt;insert name of video game&gt;. How should I set up my environment?</p><p class="s17" style="padding-left: 52pt;text-indent: 0pt;text-align: left;">The ideal setup involves Linux, but Windows and macOS work, too. For most chapters, you need the following:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_156.png"/></span></p><p class="s17" style="padding-top: 5pt;padding-left: 79pt;text-indent: 0pt;text-align: left;">Python 3 and PIP</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_157.png"/></span></p><p class="s42" style="padding-top: 3pt;padding-left: 79pt;text-indent: 0pt;text-align: left;">tensorflow <span class="s17">or </span>tensorflow-gpu <span class="s17">PIP package (version 2 or greater)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_158.png"/></span></p><p class="s17" style="padding-left: 79pt;text-indent: 0pt;text-align: left;">Pillow</p><p class="s17" style="padding-left: 79pt;text-indent: 0pt;text-align: left;">We like keeping things clean and self-contained, so we recommend using Python virtual environments. You should use the virtual environment whenever you install a package or run a script or a notebook.</p><p class="s17" style="padding-left: 79pt;text-indent: 0pt;text-align: left;">If you do not have a GPU, you are done with the setup.</p><p class="s17" style="padding-left: 79pt;text-indent: 0pt;text-align: left;">If you have an NVIDIA GPU, you would want to install the appropriate drivers, then CUDA, then cuDNN, then <span class="s42">tensorflow-gpu </span><a href="https://oreil.ly/93oon" class="s30" target="_blank">package. If you’re using Ubuntu, there’s an easier solution than installing these packages manually, which can be tedious and error prone even for the best of us: simply install the entire environment with just one line using </a><a href="https://oreil.ly/93oon" class="s18" target="_blank">Lambda Stack</a><a href="https://oreil.ly/93oon" class="s30" target="_blank">.</a></p><p class="s17" style="padding-left: 79pt;text-indent: 0pt;text-align: left;">Alternatively, you could install all of your packages using Anaconda Distribution, which works equally well for Windows, Mac, and Linux.</p></li><li><p class="s17" style="padding-top: 13pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Where will I find the code used in this book? You’ll find ready-to-run examples at<a href="http://practicaldeeplearning.ai/" class="s18" target="_blank"> </a><span class="s116">http://PracticalDeepLearning.ai</span>.</p></li><li><p class="s17" style="padding-top: 13pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">What are the minimal prerequisites to be able to read this book?</p><p class="s17" style="padding-left: 52pt;text-indent: 0pt;text-align: left;">A Ph.D. in areas including Calculus, Statistical Analysis, Variational Autoencoders, Operations Research, and so on...are definitely <i>not </i>necessary to be able to read this book (had you a little nervous, didn’t we?). Some basic coding skills, familiarity with Python, a healthy amount of curiosity, and a sense of humor should go a long way in the process of absorbing the material. Although a beginner- level understanding of mobile development (with Swift and/or Kotlin) will help, we’ve designed the examples to be self-sufficient and easy enough to be deployed by someone who has never written a mobile app previously.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 52pt;text-indent: -15pt;text-align: left;">What frameworks will we be using?</p><p class="s17" style="padding-left: 52pt;text-indent: 0pt;text-align: left;">Keras + TensorFlow for training. And chapter by chapter, we explore different inference frameworks.</p></li><li><p class="s17" style="padding-top: 13pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Will I be an expert when I finish this book?</p><p class="s17" style="padding-left: 52pt;text-indent: 0pt;text-align: left;">If you follow along, you’ll have the know-how on a wide variety of topics all the way from training to inference, to maximizing performance. Even though this book primarily focuses on computer vision, you can bring the same know-how to other areas such as text, audio, and so on and get up to speed very quickly.</p></li><li><p class="s17" style="padding-top: 3pt;padding-left: 52pt;text-indent: -15pt;text-align: justify;">Who is the cat from earlier in the chapter?</p><p class="s17" style="padding-left: 52pt;text-indent: 0pt;text-align: justify;">That is Meher’s cat, Vader. He will be making multiple cameos throughout this book. And don’t worry, he has already signed a model release form.</p></li><li><p class="s17" style="padding-top: 13pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Can I contact you?</p></li></ol></li></ol></ol><p class="s39" style="padding-left: 52pt;text-indent: 0pt;text-align: left;"><a href="mailto:PracticalDLBook@gmail.com" class="s30" target="_blank" name="bookmark155">Sure. Drop us an email at </a>PracticalDLBook@gmail.com <a href="https://www.twitter.com/PracticalDLBook" class="s30" target="_blank">with any questions, corrections, or whatever, or tweet to us </a><a href="https://www.twitter.com/PracticalDLBook" class="s18" target="_blank">@PracticalDLBook</a><span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="2" alt="image" src="KerasTensorFlow2019/Image_159.png"/></span></p><ol id="l4"><li><p class="s26" style="padding-top: 5pt;padding-left: 23pt;text-indent: -10pt;text-align: left;"><a name="bookmark156">If you’re reading a pirated copy, consider us disappointed in you.</a><a name="bookmark157">&zwnj;</a></p></li><li><p style="padding-top: 6pt;padding-left: 23pt;text-indent: -10pt;text-align: left;"><a href="https://arxiv.org/pdf/1811.12231.pdf" class="s27">Robert Geirhos et al.</a></p><h2 style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark158">Chapter 2. What’s in the Picture: Image Classification with Keras</a><a name="bookmark166">&zwnj;</a></h2><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="588" height="1" alt="image" src="KerasTensorFlow2019/Image_160.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">If you have skimmed through deep learning literature, you might have come across a barrage of academic explanations laced with intimidating mathematics. Don’t worry. We will ease you into practical deep learning with an example of classifying images with just a few lines of code.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In this chapter, we take a closer look at the Keras framework, discuss its place in the deep learning landscape, and then use it to classify a few images using existing state-of-the-art classifiers. We visually investigate how these classifiers operate by using <i>heatmaps</i>. With these heatmaps, we make a fun project in which we classify objects in videos.</p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark101" class="s63" name="bookmark167">Recall from the </a>“Recipe for the Perfect Deep Learning Solution” <span style=" color: #000;">that we need four ingredients to create our deep learning recipe: hardware, dataset, framework, and model. Let’s see how each of these comes into play in this chapter:</span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_161.png"/></span></p><p style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">We begin with the easy one: <i>hardware</i><a href="http://practicaldeeplearning.ai/" class="s63" target="_blank">. Even an inexpensive laptop would suffice for what we we’re doing in this chapter. Alternatively, you can run the code in this chapter by opening the GitHub notebook (see </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">http://PracticalDeepLearning.ai</span>) in Colab. This is just a matter of a few mouse clicks.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_162.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Because we won’t be training a neural network just yet, we don’t need a <i>dataset </i>(other than a handful of sample photos to test with).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_163.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Next, we come to the <i>framework</i>. This chapter’s title has Keras in it, so that is what we will be using for now. In fact, we use Keras for our training needs throughout a good part of the book.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_164.png"/></span></p><p style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">One way to approach a deep learning problem is to obtain a dataset, write the code to train it, spend a lot of time and energy (both human and electrical) in training that model, and then use it for making predictions. But we are not gluttons for punishment. So, we will use a <i>pretrained model </i>instead. After all, the research community has already spent blood, sweat, and tears training and publishing many of the standard models that are now publicly available. We will be reusing one of the more famous models called ResNet-50, the little sibling of ResNet-152 that won the ILSVRC in 2015.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">You will get hands-on with some code in this chapter. As we all know, the best way to learn is by doing. You might be wondering, though, what’s the theory behind this? That comes in later chapters, in which we delve deeper into the nuts and bolts of CNNs using this chapter as a foundation.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark159">Introducing Keras</a><a name="bookmark168">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark58" class="s63" name="bookmark169">As </a><span style=" color: #8E0012;">Chapter 1 </span><a href="http://kaggle.com/" class="s63" target="_blank">discussed, Keras started in 2015 as an easy-to-use abstraction layer over other libraries, making rapid prototyping possible. This made the learning curve a lot less steep for beginners of deep learning. At the same time, it made deep learning experts more productive by helping them rapidly iterate on experiments. In fact, the majority of the winning teams on </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">Kaggle.com </span>(which hosts data science competitions) have used Keras. Eventually, in 2017, the full implementation of Keras was available directly in TensorFlow, thereby combining the high scalability, performance, and vast ecosystem of TensorFlow with the ease of Keras. On the web, we often see the TensorFlow version of Keras referred to as <span class="s47">tf.keras</span>.</p><p class="s45" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark227" class="s63">In this chapter and </a>Chapter 3<a href="#bookmark458" class="s63">, we write all of the code exclusively in Keras. That includes boilerplate functions such as file reading, image manipulation (augmentation), and so on. We do this primarily for ease of learning. From </a>Chapter 5 <span style=" color: #000;">onward, we begin to gradually use more of the native performant TensorFlow functions directly for more configurability and control.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="467" alt="image" src="KerasTensorFlow2019/Image_165.png"/></span></p><p class="s48" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">FROM THE CREATOR’S DESK</p><p class="s49" style="padding-top: 6pt;padding-left: 18pt;text-indent: 0pt;line-height: 108%;text-align: left;">By François Chollet, creator of Keras, AI researcher, and author of <i>Deep Learning with Python</i></p><p class="s49" style="padding-top: 5pt;padding-left: 18pt;text-indent: 0pt;line-height: 108%;text-align: left;">I originally started Keras for my own use. At the time, in late 2014 and early 2015, there weren’t any good options for deep learning frameworks with solid usability and strong support for both RNNs and convnets. Back then, I wasn’t deliberately trying to democratize deep learning, I was just building what I wanted for myself. But as time went by, I saw lots of people pick up deep learning through Keras, and use it to solve many different problems I didn’t even know existed. To me, that has been really fascinating. It made me realize that deep learning can be deployed, in transformative ways, to far more domains than what machine learning researchers are aware of.</p><p class="s49" style="padding-left: 18pt;text-indent: 0pt;line-height: 108%;text-align: left;">There are so many people out there that could benefit from using these technologies in their work. Because of that, I’ve grown to care a lot about making deep learning accessible to as many people as possible. That’s the only way we’re going to deploy AI to the full extent of its potential — by making it broadly available. Today, in TensorFlow 2.0, the Keras API consolidates the power of deep learning in a spectrum of really productive and enjoyable workflows, suited to a variety of user profiles, from research to applications, including deployment. I’m looking forward to seeing what you’ll build with it!</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark160">Predicting an Image’s Category</a><a name="bookmark170">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark171">In layperson’s terms, image classification answers the question: “what object does this image contain?” More specifically, “This image contains </a><i>X </i>object with what probability,” where <i>X </i>is from a predefined list of categories of objects. If the probability is higher than a minimum threshold, the image is likely to contain one or more instances of <i>X</i>.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">A simple image classification pipeline would consist of the following steps:</p><ol id="l5"><li><p style="padding-top: 5pt;padding-left: 58pt;text-indent: -16pt;text-align: left;">Load an image.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 58pt;text-indent: -16pt;text-align: left;">Resize it to a predefined size such as 224 x 224 pixels.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 58pt;text-indent: -16pt;text-align: left;">Scale the values of the pixel to the range [0,1] or [–1,1],</p><p style="padding-left: 58pt;text-indent: 0pt;text-align: left;">a.k.a. normalization.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 58pt;text-indent: -16pt;text-align: left;">Select a pretrained model.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 58pt;text-indent: -16pt;text-align: left;">Run the pretrained model on the image to get a list of category predictions and their respective probabilities.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 58pt;text-indent: -16pt;text-align: left;">Display a few of the highest probability categories.</p></li></ol></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="149" alt="image" src="KerasTensorFlow2019/Image_166.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s140" target="_blank">The GitHub link is provided on the website </a><span class="s198">http://PracticalDeepLearning.ai</span>. Navigate to <span class="s53">code/chapter-2 </span>where you will find the Jupyter notebook <span class="s53">1-predict-class.ipynb </span>that has all the steps detailed.</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark172">We begin by importing all of the necessary modules from the Keras and Python packages:</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">tensorflow </span>as <span style=" color: #0CF;">tf</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">tf.keras.applications.resnet50 </span>import <span class="s56">preprocess_input</span><span class="s53">, </span><span class="s56">decode_predictions</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">tf.keras.preprocessing </span>import <span class="s56">image</span></p><p class="s54" style="padding-top: 4pt;padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">numpy </span>as <span style=" color: #0CF;">np</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">matplotlib.pyplot </span>as <span style=" color: #0CF;">plt</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark173" class="s63">Next, we load and display the image that we want to classify (see </a>Figure 2-1<span style=" color: #000;">):</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">img_path <span style=" color: #000;">= </span><span style=" color: #C30;">&quot;../../sample-images/cat.jpg&quot;</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">img </span>= <span style=" color: #000087;">image</span>.<span style=" color: #000087;">load_img</span>(<span style=" color: #000087;">img_path</span>, <span style=" color: #000087;">target_size</span>=(<span style=" color: #F60;">224</span>, <span style=" color: #F60;">224</span>)) <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">imshow</span>(<span style=" color: #000087;">img</span>)</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">plt<span style=" color: #000;">.</span>show<span style=" color: #000;">()</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 30pt;text-indent: 0pt;text-align: left;"><span><img width="545" height="523" alt="image" src="KerasTensorFlow2019/Image_167.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark173">Figure 2-1. Plot showing the contents of the input file</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Yup, it’s a cat (although the filename kind of gave it away). And that’s what our model should ideally be predicting.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="227" alt="image" src="KerasTensorFlow2019/Image_168.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s48" style="padding-left: 115pt;text-indent: 0pt;text-align: center;">A BRIEF REFRESHER ON IMAGES</p><p class="s49" style="padding-top: 7pt;padding-left: 11pt;text-indent: 0pt;line-height: 108%;text-align: left;">Before we dive into how images are processed, it would be good to take a look at how images store information. At the most basic level, an image is a collection of pixels that are laid out in a rectangular grid. Depending on the type of image, each pixel can consist of 1 to 4 parts (also known as <i>components </i>or <i>channels</i>). For the images we’re using, these components represent the intensities of the colors red, green, and blue (RGB). They are typically 8 bits in length, so their values range between 0 and 255 (i.e., 2<span class="s59">8</span><span class="s26"> </span>– 1).</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark174">Before feeding any image to Keras, we want to convert it to a standard format. This is because pretrained models expect the input to be of a specific size. The standardization in our case involves resizing the image to 224 x 224 pixels.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Most deep learning models expect a batch of images as input. But what do we do when we have just one image? We create a batch of one image, of course! That essentially involves making an array consisting of that one object. Another way to look at this is to expand the number of dimensions from three (representing the three channels of the image) to four (the extra one for the length of the array itself).</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">If that is not clear, consider this scenario: for a batch of 64 images of size 224 x 224 pixels, each containing three channels (RGB), the object representing that batch would have a shape 64 x 224 x 224 x 3. In the code that follows, where we’d be using only one 224 x 224 x 3 image, we’d create a batch of just that image by expanding the dimensions from three to four. The shape of this newly created batch would be 1 x 224 x 224 x 3:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">img_array <span style=" color: #000;">= </span>image<span style=" color: #000;">.</span>img_to_array<span style=" color: #000;">(</span>img<span style=" color: #000;">)</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">img_batch </span>= <span style=" color: #000087;">np</span>.<span style=" color: #000087;">expand_dims</span>(<span style=" color: #000087;">img_array</span>, <span style=" color: #000087;">axis</span>=<span style=" color: #F60;">O</span>) <span class="s60"># Increase the number of dimensions</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 113%;text-align: left;"><a name="bookmark175">In machine learning, models perform best when they are fed with data within a consistent range. Ranges typically include [0,1] and [–1,1]. Given that image pixel values are between 0 and 255, running the </a><span class="s47">preprocess_input </span>function from Keras on input images will normalize each pixel to a standard range. <i>Normalization </i>or</p><p class="s43" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">feature scaling <span class="p">is one of the core steps in preprocessing images to make them suitable for deep learning.</span></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark176">Now comes the model. We will be using a </a><i>Convolutional Neural Network </i>(CNN) called ResNet-50. The very first question we should ask is, “Where will I find the model?” Of course, we could hunt for it on the internet to find something that is compatible with our deep learning framework (Keras). <i>But ain’t nobody got time for that! </i>Luckily, Keras loves to make things easy and provides it to us in a single function call. After we call this function for the first time, the model will be downloaded from a remote server and cached locally:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">model <span style=" color: #000;">= </span>tf<span style=" color: #000;">.</span>keras<span style=" color: #000;">.</span>applications<span style=" color: #000;">.</span>resnet5O<span style=" color: #000;">.</span>ResNet5O<span style=" color: #000;">()</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 114%;text-align: left;"><a name="bookmark177">When predicting with this model, the results include probability predictions for each class. Keras also provides the </a><span class="s47">decode_predictions </span>function, which tells us the probability of each category of objects contained in the image.</p><p style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Now, let’s see the entire code in one handy function:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">def </span><span style=" color: #C0F;">classify</span>(<span style=" color: #000087;">img_path</span>):</p><p class="s53" style="padding-left: 45pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">img </span>= <span style=" color: #000087;">image</span>.<span style=" color: #000087;">load_img</span>(<span style=" color: #000087;">img_path</span>, <span style=" color: #000087;">target_size</span>=(<span style=" color: #F60;">224</span>, <span style=" color: #F60;">224</span>)) <span style=" color: #000087;">model </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">applications</span>.<span style=" color: #000087;">resnet5O</span>.<span style=" color: #000087;">ResNet5O</span>() <span style=" color: #000087;">img_array </span>= <span style=" color: #000087;">image</span>.<span style=" color: #000087;">img_to_array</span>(<span style=" color: #000087;">img</span>)</p><p class="s53" style="padding-left: 45pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">img_batch </span>= <span style=" color: #000087;">np</span>.<span style=" color: #000087;">expand_dims</span>(<span style=" color: #000087;">img_array</span>, <span style=" color: #000087;">axis</span>=<span style=" color: #F60;">O</span>) <span style=" color: #000087;">img_preprocessed </span>= <span style=" color: #000087;">preprocess_input</span>(<span style=" color: #000087;">img_batch</span>) <span style=" color: #000087;">prediction </span>= <span style=" color: #000087;">model</span>.<span style=" color: #000087;">predict</span>(<span style=" color: #000087;">img_preprocessed</span>) <span style=" color: #366;">print</span>(<span style=" color: #000087;">decode_predictions</span>(<span style=" color: #000087;">prediction</span>, <span style=" color: #000087;">top</span>=<span style=" color: #F60;">3</span>)[<span style=" color: #F60;">O</span>])</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">classify</span>(<span style=" color: #C30;">&quot;../../sample-images/cat.jpg&quot;</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-top: 6pt;padding-left: 27pt;text-indent: -5pt;text-align: left;">[(&#39;nO2123O45&#39;, &#39;tabby&#39;, O.5OOO9364), (&#39;nO2124O75&#39;, &#39;Egyptian_cat&#39;, O.2169O978), (&#39;nO2123159&#39;, &#39;tiger_cat&#39;, O.2O61722)]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark180" class="s63" name="bookmark178">The predicted categories for this image are various types of felines. Why doesn’t it simply predict the word “cat,” instead? The short answer is that the ResNet-50 model was trained on a granular dataset with many categories and does not include the more general “cat.” We investigate this dataset in more detail a little later, but first, let’s load another sample image (see </a><a href="#bookmark180" class="s44">Figure 2- 2</a><a href="#bookmark180" class="s63">):</a><a name="bookmark179">&zwnj;</a></p><p class="s56" style="padding-top: 4pt;padding-left: 21pt;text-indent: 0pt;text-align: left;">img_path <span style=" color: #000;">= </span><span style=" color: #C30;">&#39;../../sample-images/dog.jpg&#39;</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">img </span>= <span style=" color: #000087;">image</span>.<span style=" color: #000087;">load_img</span>(<span style=" color: #000087;">img_path</span>, <span style=" color: #000087;">target_size</span>=(<span style=" color: #F60;">224</span>, <span style=" color: #F60;">224</span>)) <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">imshow</span>(<span style=" color: #000087;">img</span>)</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">plt<span style=" color: #000;">.</span>show<span style=" color: #000;">()</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 30pt;text-indent: 0pt;text-align: left;"><span><img width="545" height="523" alt="image" src="KerasTensorFlow2019/Image_169.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark180">Figure 2-2. Plot showing the contents of the file dog.jpg</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;">And, again, we run our handy function from earlier:</p><p class="s53" style="padding-top: 1pt;padding-left: 21pt;text-indent: 0pt;line-height: 30pt;text-align: left;"><span style=" color: #000087;">classify</span>(<span style=" color: #C30;">&quot;../../sample-images/dog.jpg&quot;</span>) [(u&#39;nO2113186&#39;, u&#39;Cardigan&#39;, O.8O9839),</p><p class="s53" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">(u&#39;nO2113O23&#39;, u&#39;Pembroke&#39;, O.17665945), (u&#39;nO211O8O6&#39;, u&#39;basenji&#39;, O.OO421661O5)]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">As expected, we get different breeds of canines (and not just the “dog” category). If you are unfamiliar with the Corgi breed of dogs,</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">the word “corgi” literally means “dwarf dog” in Welsh. The Cardigan and Pembroke are subbreeds of the Corgi family, which happen to look pretty similar to one another. It’s no wonder our model thinks that way, too.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Notice the predicted probability of each category. Usually, the prediction with the highest probability is considered the answer. Alternatively, any value over a predefined threshold can be considered as the answer, too. In the dog example, if we set a threshold of 0.5, Cardigan would be our answer.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="597" height="644" alt="image" src="KerasTensorFlow2019/Image_170.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="185" alt="image" src="KerasTensorFlow2019/Image_171.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s79" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark181" class="s140" name="bookmark182">You can follow along with the code in this chapter and execute it interactively without any installations in the browser itself with Google Colab. Simply find the “Run on Colab” link at the top of each notebook on GitHub that you’d like to experiment with. Then, click the “Run Cell” button; this should execute the code within that cell, as shown in </a><a href="#bookmark181" class="s64">Figure </a>2-3<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s50" style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark181">Figure 2-3. Running the notebook on Google Colab using the browser</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark161">Investigating the Model</a><a name="bookmark183">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark184">We got the predictions from our model, great! But what factors led to those predictions? There are a few questions that we need to ask here:</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_172.png"/></span></p><p style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">What dataset was the model trained on?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_173.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Are there other models that I can use? How good are they? Where can I get them?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_174.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Why does my model predict what it predicts?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;">We look into the answers to each of these questions in this section.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark162">ImageNet Dataset</a><a name="bookmark185">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://www.image-net.org/" class="s63" target="_blank" name="bookmark186">Let’s investigate the ImageNet dataset on which ResNet-50 was trained. </a>ImageNet<a href="#bookmark187" class="s63">, as the name suggests, is a network of images; that is, a dataset of images organized as a network, as demonstrated in </a>Figure 2-4<span style=" color: #000;">. It is arranged in a hierarchical manner (like the WordNet hierarchy) such that the parent node encompasses a collection of images of all different varieties possible within that parent. For example, within the “animal” parent node, there are fish, birds, mammals, invertebrates, and so on.</span></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Each category has multiple subcategories, and these have subsubcategories, and so forth. For example, the category “American water spaniel” is eight levels from the root. The dog category contains 189 total subcategories in five hierarchical levels.</p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark188" class="s63">Visually, we developed the tree diagram shown in </a>Figure 2-5 <span style=" color: #000;">to help you to understand the wide variety of high-level entities that the ImageNet dataset contains. This treemap also shows the relative percentage of different categories that make up the ImageNet dataset.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="599" height="447" alt="image" src="KerasTensorFlow2019/Image_175.jpg"/></span></p><p class="s50" style="padding-top: 4pt;padding-left: 35pt;text-indent: 0pt;text-align: left;"><a name="bookmark187">Figure 2-4. The categories and subcategories in the ImageNet dataset</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="587" height="315" alt="image" src="KerasTensorFlow2019/Image_176.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark188">Figure 2-5. Treemap of ImageNet and its classes</a></p><p class="s45" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark58" class="s63" name="bookmark189">The ImageNet dataset was the basis for the famous ILSVRC that started in 2010 to benchmark progress in computer vision and challenge researchers to innovate on tasks including object classification. Recall from </a>Chapter 1 <span style=" color: #000;">that the ImageNet challenge saw submissions that drastically improved in accuracy each year. When it started out, the error rate was nearly 30%. And now, it is 2.2%, already better than how an average human would perform at this task. This dataset and challenge are considered the single biggest reasons for the recent advancements in computer vision.</span></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark190">Wait, AI has better-than-human accuracy? If the dataset was created by humans, won’t humans have 100% accuracy? Well, the dataset was created by experts, with each image verified by multiple people. Then Stanford researcher (and now of Tesla fame) Andrej Karpathy attempted to figure out how much a normal human would fare on ImageNet-1000. Turns out he achieved an accuracy of 94.9%, well short of the 100% we all expected. Andrej painstakingly spent a week going over 1,500 images, spending approximately one minute per image in tagging it. How did he misclassify 5.1% of the images? The reasons are a bit subtle:</a></p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Fine-grained recognition</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark191">For many people, it is really tough to distinguish a Siberian husky from a Alaskan Malamute. Someone who is really familiar with dog breeds would be able to tell them apart because they look for finer-level details that distinguish both breeds. It turns out that neural networks are capable of learning those finer-level details much more easily than humans.</a></p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Category unawareness</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark192">Not everyone is aware of all the 120 breeds of dogs and most certainly not each one of the 1,000 classes. But the AI is. After all, it was trained on it.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="146" alt="image" src="KerasTensorFlow2019/Image_177.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Similar to ImageNet, speech datasets like Switchboard report a 5.1% error rate for speech transcription (coincidentally the same number as ImageNet). It’s clear that humans have a limit, and AI is gradually beating us.</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark193">One of the other key reasons for this fast pace of improvement was that researchers were openly sharing models trained on datasets like ImageNet. In the next section, we learn about model reuse in more detail.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark163">Model Zoos</a><a name="bookmark194">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark195">A model zoo is a place where organizations or individuals can publicly upload models that they have built for others to reuse and improve upon. These models can be trained using any framework (e.g., Keras, TensorFlow, MXNet), for any task (classification, detection, etc.), or trained on any dataset (e.g., ImageNet, Street View House Numbers (SVHN)).</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The tradition of model zoos started with Caffe, one of the first deep learning frameworks, developed at the University of California, Berkeley. Training a deep learning model from scratch on a multimillion-image database requires weeks of training time and lots of GPU computational energy, making it a difficult task. The research community recognized this as a bottleneck, and the organizations that participated in the ImageNet competition open sourced their trained models on Caffe’s website. Other frameworks soon followed suit.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">When starting out on a new deep learning project, it’s a good idea to first explore whether there’s already a model that performs a similar task and was trained on a similar dataset.</p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://keras.io/applications/" class="s63" target="_blank">The </a>model zoo <a href="#bookmark196" class="s63">in Keras is a collection of various architectures trained using the Keras framework on the ImageNet dataset. We tabulate their details in </a>Table 2-1<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s43" style="padding-left: 203pt;text-indent: -175pt;text-align: left;"><a name="bookmark196">Table 2-1. Architectural details of select pretrained ImageNet models</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:7.19243pt" cellspacing="0"><tr style="height:36pt"><td style="width:90pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Model</p></td><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 27pt;text-indent: 0pt;text-align: left;">Size</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 8pt;text-indent: 0pt;line-height: 108%;text-align: left;">Top-1 accuracy</p></td><td style="width:83pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;line-height: 108%;text-align: left;">Top-5 accuracy</p></td><td style="width:86pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">Parameters</p></td><td style="width:44pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Depth</p></td></tr><tr style="height:36pt"><td style="width:90pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">VGG16</p></td><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 27pt;text-indent: 0pt;text-align: left;">528</p><p class="s66" style="padding-top: 1pt;padding-left: 27pt;text-indent: 0pt;text-align: left;">MB</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 8pt;text-indent: 0pt;text-align: left;">0.713</p></td><td style="width:83pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">0.901</p></td><td style="width:86pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">138,357,544</p></td><td style="width:44pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">23</p></td></tr><tr style="height:36pt"><td style="width:90pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">VGG19</p></td><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 27pt;text-indent: 0pt;text-align: left;">549</p><p class="s66" style="padding-top: 1pt;padding-left: 27pt;text-indent: 0pt;text-align: left;">MB</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 8pt;text-indent: 0pt;text-align: left;">0.713</p></td><td style="width:83pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">0.9</p></td><td style="width:86pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">143,667,240</p></td><td style="width:44pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">26</p></td></tr><tr style="height:36pt"><td style="width:90pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">ResNet-50</p></td><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 27pt;text-indent: 0pt;text-align: left;">98</p><p class="s66" style="padding-top: 1pt;padding-left: 27pt;text-indent: 0pt;text-align: left;">MB</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 8pt;text-indent: 0pt;text-align: left;">0.749</p></td><td style="width:83pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">0.921</p></td><td style="width:86pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">25,636,712</p></td><td style="width:44pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">50</p></td></tr></table><table style="border-collapse:collapse;margin-left:7.19243pt" cellspacing="0"><tr style="height:36pt"><td style="width:114pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Model</p></td><td style="width:37pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Size</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 8pt;text-indent: 0pt;line-height: 108%;text-align: left;">Top-1 accuracy</p></td><td style="width:83pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;line-height: 108%;text-align: left;">Top-5 accuracy</p></td><td style="width:86pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">Parameters</p></td><td style="width:44pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 4pt;text-indent: 0pt;text-align: left;">Depth</p></td></tr><tr style="height:36pt"><td style="width:114pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">ResNet-101</p></td><td style="width:37pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">171</p><p class="s66" style="padding-top: 1pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">MB</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 8pt;text-indent: 0pt;text-align: left;">0.764</p></td><td style="width:83pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">0.928</p></td><td style="width:86pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">44,707,176</p></td><td style="width:44pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 4pt;text-indent: 0pt;text-align: left;">101</p></td></tr><tr style="height:36pt"><td style="width:114pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">ResNet-152</p></td><td style="width:37pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">232</p><p class="s66" style="padding-top: 1pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">MB</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 8pt;text-indent: 0pt;text-align: left;">0.766</p></td><td style="width:83pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">0.931</p></td><td style="width:86pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">60,419,944</p></td><td style="width:44pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 4pt;text-indent: 0pt;text-align: left;">152</p></td></tr><tr style="height:36pt"><td style="width:114pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">InceptionV3</p></td><td style="width:37pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">92</p><p class="s66" style="padding-top: 1pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">MB</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 8pt;text-indent: 0pt;text-align: left;">0.779</p></td><td style="width:83pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">0.937</p></td><td style="width:86pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">23,851,784</p></td><td style="width:44pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 4pt;text-indent: 0pt;text-align: left;">159</p></td></tr><tr style="height:36pt"><td style="width:114pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">InceptionResNetV2</p></td><td style="width:37pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">215</p><p class="s66" style="padding-top: 1pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">MB</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 8pt;text-indent: 0pt;text-align: left;">0.803</p></td><td style="width:83pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">0.953</p></td><td style="width:86pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">55,873,736</p></td><td style="width:44pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 4pt;text-indent: 0pt;text-align: left;">572</p></td></tr><tr style="height:36pt"><td style="width:114pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">NASNetMobile</p></td><td style="width:37pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">23</p><p class="s66" style="padding-top: 1pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">MB</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 8pt;text-indent: 0pt;text-align: left;">0.744</p></td><td style="width:83pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">0.919</p></td><td style="width:86pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">5,326,716</p></td><td style="width:44pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 4pt;text-indent: 0pt;text-align: left;">—</p></td></tr><tr style="height:36pt"><td style="width:114pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">NASNetLarge</p></td><td style="width:37pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">343</p><p class="s66" style="padding-top: 1pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">MB</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 8pt;text-indent: 0pt;text-align: left;">0.825</p></td><td style="width:83pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">0.96</p></td><td style="width:86pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">88,949,818</p></td><td style="width:44pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 4pt;text-indent: 0pt;text-align: left;">—</p></td></tr><tr style="height:36pt"><td style="width:114pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">MobileNet</p></td><td style="width:37pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">16</p><p class="s66" style="padding-top: 1pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">MB</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 8pt;text-indent: 0pt;text-align: left;">0.704</p></td><td style="width:83pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">0.895</p></td><td style="width:86pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">4,253,864</p></td><td style="width:44pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 4pt;text-indent: 0pt;text-align: left;">88</p></td></tr><tr style="height:36pt"><td style="width:114pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">MobileNetV2</p></td><td style="width:37pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">14</p><p class="s66" style="padding-top: 1pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">MB</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 8pt;text-indent: 0pt;text-align: left;">0.713</p></td><td style="width:83pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">0.901</p></td><td style="width:86pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">3,538,984</p></td><td style="width:44pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 4pt;text-indent: 0pt;text-align: left;">88</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The column “Top-1 accuracy” indicates how many times the best guess was the correct answer, and the column “Top-5 accuracy” indicates how many times at least one out of five guesses were correct. The “Depth” of the network indicates how many layers are present in the network. The “Parameters” column indicates the size of the model; that is, how many individual weights the model has: the more parameters, the “heavier” the model is, and the slower it is to make predictions. In this book, we often use ResNet-50 (the most common architecture cited in research papers for high accuracy) and MobileNet (for a good balance between speed, size, and accuracy).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark164">Class Activation Maps</a><a name="bookmark197">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark198">Image saliency, usually famous in UX research, is trying to answer the question “What part of the image are users paying attention to?” This is facilitated with the help of eye-tracking studies and represented in heatmaps. For example, big, bold fonts or people’s faces usually get more attention than backgrounds. It’s easy to guess how useful these heatmaps would be to designers and advertisers, who can then adapt their content to maximize users’ attention. Taking inspiration from this human version of saliency, wouldn’t it be great to learn which part of the image the neural network is paying attention to? That’s precisely what we will be experimenting with.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;">In our experiment, we will be overlaying a <i>class activation map </i>(or colloquially a <i>heatmap</i>) on top of a video in order to understand what the network pays attention to. The heatmap tells us something like “In this picture, these pixels were responsible for the prediction of the class <span class="s47">dog </span><a href="#bookmark199" class="s63">where “dog” was the category with the highest probability. The “hot” pixels are represented with warmer colors such as red, orange, and yellow, whereas the “cold” pixels are represented using blue. The “hotter” a pixel is, the higher the signal it provides toward the prediction. </a><span style=" color: #8E0012;">Figure 2-6 </span>gives us a clearer picture. (If you’re reading the print version, refer to the book’s GitHub for the original color image.)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="295" alt="image" src="KerasTensorFlow2019/Image_178.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark199">Figure 2-6. Original image of a dog and its generated heatmap</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s63" target="_blank">In the GitHub repository (see </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">http://PracticalDeepLearning.ai</span>), navigate to <i>code/chapter-2</i>. There, you’ll find a handy Jupyter notebook, <i>2-class-activation-map-on-video.ipynb, </i>which describes the following steps:</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">First, we need to install <span class="s47">keras-vis </span>using <span class="s47">pip</span>:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ pip install keras-vis --user</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We then run the visualization script on a single image to generate the heatmap for it:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ python visualization.py --process image --path ../sample- images/dog.jpg</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We should see a newly created file called <i>dog-output.jpg </i><a href="#bookmark199" class="s63">that shows a side-by-side view of the original image and its heatmap. As we can see from </a><span style=" color: #8E0012;">Figure 2-6</span>, the right half of the image indicates the “areas of heat” along with the correct prediction of a “Cardigan” (i.e., Welsh Corgi).</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Next, we want to visualize the heatmap for frames in a video. For that, we need <span class="s47">FFmpeg</span>, an open source multimedia framework. You</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://www.ffmpeg.org/" class="s63" target="_blank">can find the download binary as well as the installation instructions for your operating system at </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">https://www.ffmpeg.org</span>.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 114%;text-align: left;">We use <span class="s47">ffmpeg </span>to split up a video into individual frames (at 25 frames per second) and then run our visualization script on each of those frames. We must first create a directory to store these frames and pass its name as part of the <span class="s47">ffmpeg </span>command:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ mkdir kitchen</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ ffmpeg -i video/kitchen-input.mov -vf fps=25 kitchen/thumb%O4d.jpg - hide_banner</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We then run the visualization script with the path of the directory containing the frames from the previous step:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ python visualization.py --process video --path kitchen/</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We should see a newly created <i>kitchen-output </i>directory that contains all of the heatmaps for the frames from the input directory.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Finally, compile a video from those frames using <span class="s47">ffmpeg</span>:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ ffmpeg -framerate 25 -i kitchen-output/result-%O4d.jpg kitchen- output.mp4</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Perfect! The result is the original video side by side with a copy of the heatmap overlaid on it. This is a useful tool, in particular, to discover whether the model has learned the correct features or if it picked up stray artifacts during its training.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Imagine generating heatmaps to analyze the strong points and shortfalls of our trained model or a pretrained model.</p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://www.twitter.com/PracticalDLBook" class="s63" target="_blank">You should try this experiment out on your own by shooting a video with your smartphone camera and running the aforementioned scripts on the file. Don’t forget to post your videos on Twitter, tagging </a>@PracticalDLBook<span style=" color: #000;">!</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="534" alt="image" src="KerasTensorFlow2019/Image_179.png"/></span></p><p class="s51" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s49" style="padding-top: 6pt;padding-left: 35pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark204" class="s140" name="bookmark200">Heatmaps are a great way to visually detect bias in the data. The quality of a model’s predictions depends heavily on the data on which it was trained. If the data is biased, that will reflect in the predictions. A great example of this is (although probably an urban legend) one in which the US Army wanted to use neural networks to detect enemy tanks camouflaged in trees.</a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11pt; vertical-align: 4pt;">1 </span>The researchers who were building the model took photographs — 50% containing camouflaged tanks and 50% with just trees. Model training yielded 100% accuracy. A cause for celebration? That sadly wasn’t the case when the US Army tested it. The model had performed very poorly — no better than random guesses. Investigation revealed that photos with the tanks were taken on cloudy (overcast) days and those without the tanks on clear, sunny days. And the neural network model began looking for the sky instead of the tank. If the researchers had visualized the model using heatmaps, they would have caught that issue pretty early.</p><p class="s49" style="padding-top: 5pt;padding-left: 35pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark201">As we collect data, we must be vigilant at the outset of potential bias that can pollute our model’s learning. For example, when collecting images to build a food classifier, we should verify that the other artifacts such as plates and utensils are not being learned as food.</a></p><p class="s49" style="padding-left: 35pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark202">Otherwise, the presence of chopsticks might get our food classified as chow mein. Another term to define this is </a><i>co-occurrence</i>. Food very frequently co-occurs with cutlery. So watch out for these artifacts seeping into your classifier’s training.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark165">Summary</a><a name="bookmark203">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In this chapter, we got a glimpse of the deep learning universe using Keras. It’s an easy-to-use yet powerful framework that we use in the next several chapters. We observed that there is often no need to collect millions of images and use powerful GPUs to train a custom model because we can use a pretrained model to predict the category of an image. By diving deeper into datasets like ImageNet, we learned the kinds of categories these pretrained models can predict. We also learned about finding these models in model zoos that exist for most frameworks.</p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark227" class="s63">In </a>Chapter 3<span style=" color: #000;">, we explore how we can tweak an existing pretrained model to make predictions on classes of input for which it was not originally intended. As with the current chapter, our approach is geared toward obtaining output without needing millions of images and lots of hardware resources to train a classifier.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="581" height="2" alt="image" src="KerasTensorFlow2019/Image_180.png"/></span></p><p class="s49" style="padding-top: 6pt;padding-left: 25pt;text-indent: -11pt;line-height: 108%;text-align: left;"><a href="https://oreil.ly/-svD0" class="s27" target="_blank" name="bookmark204">1 </a><span style=" color: #8E0012;">“Artificial Intelligence as a Positive and Negative Factor in Global Risk” </span>by Eliezer Yudkowsky in <i>Global Catastrophic Risks </i>(Oxford University Press).</p><h2 style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;"><a name="bookmark205">Chapter 3. Cats Versus Dogs: Transfer Learning in 30 Lines with Keras</a><a name="bookmark227">&zwnj;</a></h2><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="588" height="1" alt="image" src="KerasTensorFlow2019/Image_181.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark228" class="s63">Imagine that we want to learn how to play the melodica, a wind instrument in the form of a handheld keyboard. Without a musical background, and the melodica being our very first instrument, it might take us a few months to become proficient at playing it. In contrast, if we were already skilled at playing another instrument, such as the piano, it might just take a few days, given how similar the two instruments are. Taking the learnings from one task and fine tuning them on a similar task is something we often do in real life (as illustrated in </a>Figure 3-1<span style=" color: #000;">). The more similar the two tasks are, the easier it is to adapt the learning from one task to the other.</span></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We can apply this phenomenon from real life to the world of deep learning. Starting a deep learning project can be relatively quick when using a pretrained model, which reuses the knowledge that it learned during its training, and adapt it to the task at hand. This process is known as <i>transfer learning</i>.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In this chapter, we use transfer learning to modify existing models by training our own classifier in minutes using Keras. By the end of this chapter, we will have several tools in our arsenal to create high-accuracy image classifiers for any task.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="578" height="253" alt="image" src="KerasTensorFlow2019/Image_182.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark228">Figure 3-1. Transfer learning in real life</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark206">Adapting Pretrained Models to New Tasks</a><a name="bookmark229">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark230">Before we discuss the process of transfer learning, let’s quickly take a step back and review the primary reasons for the boom in deep learning:</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_183.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_184.png"/></span></p><p style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;line-height: 191%;text-align: left;">Availability of bigger and better-quality datasets like ImageNet Better compute available; i.e., faster and cheaper GPUs</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_185.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Better algorithms (model architecture, optimizer, and training procedure)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_186.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Availability of pretrained models that have taken months to train but can be quickly reused</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The last point is probably one of the biggest reasons for the widespread adoption of deep learning by the masses. If every training task took a month, not more than a handful of researchers with deep pockets would be working in this area. Thanks to transfer learning, the underappreciated hero of training models, we can now modify an existing model to suit our task in as little as a few minutes.</p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark166" class="s63">For example, we saw in </a>Chapter 2 <span style=" color: #000;">that the pretrained ResNet-50 model, which is trained on ImageNet, can predict feline and canine breeds, among thousands of other categories. So, if we just want to classify between the high-level “cat” and “dog” categories (and not the lower-level breeds), we can begin with the ResNet-50 model and quickly retrain this model to classify cats and dogs. All we need to do is show it a dataset with these two categories during training, which should take anywhere between a few minutes to a few hours. In comparison, if we had to train a cat versus dog model without a pretrained model, it could take several hours to days.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s48" style="padding-left: 115pt;text-indent: 0pt;text-align: center;">FROM THE CREATOR’S DESK</p><p class="s49" style="padding-top: 7pt;padding-left: 11pt;text-indent: 0pt;text-align: left;">By Jeremy Howard, cofounder of fast.ai and former chief scientist at Kaggle</p><p class="s49" style="padding-top: 6pt;padding-left: 11pt;text-indent: 0pt;line-height: 108%;text-align: left;">Hundreds of thousands of students have studied deep learning through fast.ai. Our goal is to get them up and running as quickly as possible, solving real problems quickly. So what’s the first thing we teach? It’s transfer learning!</p><p class="s198" style="padding-top: 5pt;padding-left: 11pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="http://forums.fast.ai/" class="s140" target="_blank">Thousands of students have now shared their success stories on our forum (</a>http://forums.fast.ai<span class="s49">) describing how with as few as 30 images they have created 100% accurate image classifiers. We’ve also heard from students that have broken academic records in many domains and created commercially valuable models using this simple technique.</span></p><p class="s49" style="padding-top: 5pt;padding-left: 11pt;text-indent: 0pt;line-height: 108%;text-align: left;">Five years ago, I created Enlitic, the first company to focus on deep learning for medicine. As an initial proof of concept, I decided to develop a lung tumor classifier from CT scans. You can probably guess what technique we used...yes, it was transfer learning! In our open source fast.ai library we make transfer learning trivially easy — it’s just three lines of code, and the most important best practices are built in.</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="404" alt="image" src="KerasTensorFlow2019/Image_187.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark207">A Shallow Dive into Convolutional Neural Networks</a><a name="bookmark231">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark232">We have been using the term “model” to refer to the part of AI that makes our predictions. In deep learning for computer vision, that model is usually a special type of neural network called a CNN. Although we explore CNNs in greater detail later in the book, we look at them very briefly in relation to training them via transfer learning here.</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark58" class="s63">In machine learning, we need to convert data into a set of discernible features and then add a classification algorithm to classify them. It’s the same with CNNs. They consist of two parts: convolutional layers and fully connected layers. The job of the convolutional layers is to take the large number of pixels of an image and convert them into a much smaller representation; that is, features. The fully connected layers convert these features into probabilities. A fully connected layer is really a neural network with hidden layers, as we saw in </a>Chapter 1<a href="#bookmark233" class="s63">. In summary, the convolutional layers act as feature extractors, whereas the fully connected layers act as classifiers. </a>Figure 3-2 <span style=" color: #000;">shows a high-level overview of a CNN.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 14pt;text-indent: 0pt;text-align: left;"><span><img width="574" height="307" alt="image" src="KerasTensorFlow2019/Image_188.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark233">Figure 3-2. A high-level overview of a CNN</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark234">Imagine that we want to detect a human face. We might want to use a CNN to classify an image and determine whether it contains a face. Such a CNN would be composed of several layers connected one after another. These layers represent mathematical operations. The output of one layer is the input to the next. The first (or the lowermost) layer is the input layer, where the input image is fed. The last (or the topmost) layer is the output layer, which gives the predictions.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The way it works is the image is fed into the CNN and passes through a series of layers, with each performing a mathematical operation and passing the result to the subsequent layer. The resulting output is a list of object classes and their probabilities. For example, categories like ball — 65%, grass — 20%, and so on. If the output for an image contains a “face” class with a 70% probability, we conclude that there is a 70% likelihood that the image contains a human face.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="264" alt="image" src="KerasTensorFlow2019/Image_189.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">An intuitive (and overly simplified) way to look at CNNs is to see them as a series of filters. As the word filter implies, each layer acts as a sieve of information, letting something “pass through” only if it recognizes it. (If you have heard of high-pass and low-pass filters in electronics, this might seem familiar.) We say that the layer was “activated” for that information. Each layer is activated for visual patterns resembling parts of cats, dogs, cars, and so forth. If a layer does not recognize information (due to what it learned while training), its output is close to zero. CNNs are the “bouncers” of the deep learning world!</p><p style="text-indent: 0pt;text-align: left;"/><p class="s45" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark235" class="s63">In the facial detection example, lower-level layers (</a>Figure 3-3<a href="#bookmark235" class="s63">, a; layers that are closer to the input image) are “activated” for simpler shapes; for example, edges and curves. Because these layers activate only for basic shapes, they can be easily reused for a different purpose than face recognition such as detecting a car (every image is composed of edges and curves, after all). Middle- level layers (</a>Figure 3-3 <a href="#bookmark235" class="s63">b) are activated for more complex shapes such as eyes, noses, and lips. These layers are not nearly as reusable as the lower-level layers. They might not be as useful for detecting a car, but might still be useful for detecting animals. And higher-level layers (</a>Figure 3-3 <span style=" color: #000;">c) are activated for even more complex shapes; for example, most of the human face. These layers tend to be more task-specific and thus the least reusable across other image classification problems.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 8pt;text-indent: 0pt;text-align: left;"><span><img width="584" height="266" alt="image" src="KerasTensorFlow2019/Image_190.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 13pt;text-indent: 0pt;text-align: left;"><a name="bookmark235">Figure 3-3. (a) Lower-level activations, followed by (b) midlevel activations and</a></p><ol id="l6"><li><p class="s50" style="padding-top: 1pt;padding-left: 11pt;text-indent: 2pt;line-height: 108%;text-align: left;">upper-layer activations (image source: Convolutional Deep Belief Networks for Scalable Unsupervised Learning of Hierarchical Representations, Lee et al.,</p><p class="s50" style="padding-left: 18pt;text-indent: 0pt;line-height: 14pt;text-align: center;">ICML 2009)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The complexity and power of what a layer can recognize increases as we approach the final layers. Conversely, the reusability of a layer decreases as we get closer to the output. This will become apparent very soon when we look at what these layers learn.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark208">Transfer Learning</a><a name="bookmark236">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark237">If we want to transfer knowledge from one model to another, we want to reuse more of the </a><i>generic </i>layers (closer to the input) and fewer of the <i>task-specific </i><a href="#bookmark238" class="s63">layers (closer to the output). In other words, we want to remove the last few layers (typically the fully connected layers) so that we can utilize the more generic ones, and add layers that are geared toward our specific classification task. Once training begins, the generic layers (which form the majority of our new model) are kept frozen (i.e., they are unmodifiable), whereas the newly added task-specific layers are allowed to be modified. This is how transfer learning helps quickly train new models. </a><span style=" color: #8E0012;">Figure 3-4 </span>illustrates this process for a pretrained model trained for task X adapted to task Y.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span><img width="545" height="345" alt="image" src="KerasTensorFlow2019/Image_191.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark238">Figure 3-4. An overview of transfer learning</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark209">Fine Tuning</a><a name="bookmark239">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark240">Basic transfer learning gets us only so far. We usually add only two to three fully connected layers after the generic layers to make the new classifier model. If we want higher accuracy, we must allow more layers to be trained. This means unfreezing some of the layers that would have otherwise been frozen in transfer learning.</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">This is known as <i>fine tuning</i><a href="#bookmark241" class="s63">. </a><span style=" color: #8E0012;">Figure 3-5 </span>shows an example where some convolutional layers near the head/top are unfrozen and trained for the task at hand.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 24pt;text-indent: 0pt;text-align: left;"><span><img width="551" height="291" alt="image" src="KerasTensorFlow2019/Image_192.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark241">Figure 3-5. Fine tuning a convolutional neural network</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">It’s obvious that compared to basic transfer learning, more layers are tweaked to our dataset during fine tuning. Because a higher number of layers have adapted to our task compared to transfer learning, we can achieve greater accuracy for our task. The decision on how many layers to fine tune is dependent on the amount of data at hand as well as the similarity of the target task to the original dataset on which the pretrained model was trained.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We often hear data scientists saying, “I fine tuned the model,” which means that they took a pretrained model, removed task-</p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="146" alt="image" src="KerasTensorFlow2019/Image_193.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">In daily lingo, transfer learning and fine tuning are used interchangeably. When spoken, transfer learning is used more as a general concept, whereas fine tuning is referred to as its implementation.</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">specific layers and added new ones, froze the lower layers, and trained the upper part of the network on the new dataset they had.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark210">How Much to Fine Tune</a><a name="bookmark242">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">How many layers of a CNN should we fine tune? This can be guided by the following two factors:</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">How much data do we have?</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;">If we have a couple hundred labeled images, it would be difficult to train and test a freshly defined model from scratch (i.e., define a model architecture with random seed weights) because we need a lot more data. The danger of training with such a small amount of data is that these powerful networks might potentially memorize it, leading to undesirable overfitting (which we explore later in the chapter). Instead, we will borrow a pretrained network and fine tune the last few layers. But if we had a million labeled images, it would be feasible to fine tune all layers of the network and, if necessary, train from scratch. So, the amount of task-specific data dictates whether we can fine tune, and how much.</p><p class="s43" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">How similar is the data?</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;">If the task-specific data is similar to the data used for the pretrained network, we can fine tune the last few layers. But if our task is identifying different bones in an X-ray image and we want to start out from an ImageNet trained network, the high dissimilarity between regular ImageNet images and X-ray images would require nearly all layers to be trained.</p><p class="s45" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark243" class="s63">To summarize, </a>Table 3-1 <span style=" color: #000;">offers an easy-to-follow cheat sheet.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s43" style="padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark243">Table 3-1. Cheatsheet for when and how to fine tune</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="581" height="1" alt="image" src="KerasTensorFlow2019/Image_194.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s48" style="padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">Large amount of training data</p><p class="s48" style="padding-top: 2pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">High similarity among datasets</p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="1" alt="image" src="KerasTensorFlow2019/Image_195.png"/></span></p><p class="s49" style="padding-top: 6pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">Fine tune all layers</p><p class="s48" style="padding-top: 2pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Low similarity among datasets</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s49" style="padding-left: 10pt;text-indent: 0pt;text-align: left;">Train from scratch, or fine tune all layers</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="581" height="1" alt="image" src="KerasTensorFlow2019/Image_196.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="69" alt="image" src="KerasTensorFlow2019/Image_197.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 108%;text-align: left;">Small   <span class="s49">Fine tune last   Tough luck! Train on a smaller network with </span>amount of  <span class="s49">few layers   heavy data augmentation or somehow get </span>training data <span class="s49">more data</span></p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="1" alt="image" src="KerasTensorFlow2019/Image_198.png"/></span></p><p class="s48" style="padding-top: 3pt;padding-left: 99pt;text-indent: 0pt;line-height: 108%;text-align: left;">High similarity among datasets</p><p class="s48" style="padding-top: 3pt;padding-left: 35pt;text-indent: 0pt;text-align: left;">Low similarity among datasets</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark244">Enough theory, let’s see it in action.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark211">Building a Custom Classifier in Keras with Transfer Learning</a><a name="bookmark245">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark246">As promised, it’s time to build our state-of-the-art classifier in 30 lines or less. At a high level, we will use the following steps:</a></p><ol id="l7"><li><p style="padding-top: 5pt;padding-left: 58pt;text-indent: -16pt;text-align: left;">Organize the data. Download labeled images of cats and dogs and then divide the images into training and validation folders.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 58pt;text-indent: -16pt;text-align: left;">Build the data pipeline. Define a pipeline for reading data, including preprocessing the images (e.g., resizing) and grouping multiple images together into batches.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 58pt;text-indent: -16pt;text-align: left;">Augment the data. In the absence of a ton of training images, make small changes (augmentation) like rotation, zooming, and so on to increase variation in training data.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 58pt;text-indent: -16pt;text-align: left;">Define the model. Take a pretrained model, remove the last few task-specific layers, and append a new classifier layer. Freeze the weights of original layers (i.e., make them unmodifiable). Select an optimizer algorithm and a metric to track (like accuracy).</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 58pt;text-indent: -16pt;text-align: left;">Train and test. Train for a few iterations until our validation accuracy is high. Save the model to eventually load as part of any application for predictions.</p></li></ol></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">This will all make sense pretty soon. Let’s explore this process in detail.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s48" style="padding-left: 186pt;text-indent: -170pt;line-height: 108%;text-align: left;">SOLVING THE WORLD’S MOST PRESSING COMPUTER-VISION PROBLEM</p><p class="s198" style="padding-top: 5pt;padding-left: 11pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="http://petfinder.com/" class="s140" target="_blank">In early 2014, Microsoft Research was figuring out how to solve the world’s most pressing problem at the time: “Differentiating cats and dogs.” (Where else would we have gotten the idea for this chapter?) Keep in mind that it was a much more difficult computer-vision problem back then. To facilitate this effort, Microsoft Research released the Asirra (Animal Species Image Recognition for Restricting Access) dataset. The motivation behind the Asirra dataset was to develop a sufficiently challenging CAPTCHA system. More than three million images, labeled by animal shelters throughout the United States, were provided by </a><a href="http://petfinder.com/" class="s52" target="_blank">Petfinder.com</a> <span class="s49">to Microsoft Research. When this problem was initially introduced, the highest possible accuracy attained was around 80%. By using deep learning, in just a few weeks, it went to 98%! This (now relatively easy) task shows the power of deep learning.</span></p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="321" alt="image" src="KerasTensorFlow2019/Image_199.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark212">Organize the Data</a><a name="bookmark247">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark248">It’s essential to understand the distinction between train, validation, and test data. Let’s look at a real-world analogy of a student preparing for standardized exams (e.g., SAT in the US, the Gaokao in China, JEE in India, CSAT in Korea, etc.). The in-class instruction and homework assignments are analogous to the training process. The quizzes, midterms, and other tests in school are the equivalent to the validation — the student is able to take them frequently, assess performance, and make improvements in their study plan. They’re ultimately optimizing for their performance in the final standardized exam for which they get only one chance. The final exam is equivalent to the test set — the student does not get an opportunity to improve here (ignoring the ability to retake the test). This is their one shot at showing what they have learned.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Similarly, our aim is to give the best predictions in the real world. To enable this, we divide our data into three parts: train, validation, and test. A typical distribution would be 80% for train, 10% for validation, and 10% for test. Note that we randomly divide our data into these three sets in order to ensure the least amount of <i>bias </i>that might creep in unknowingly. The final accuracy of the model is determined by the accuracy on the <i>test set</i>, much like the student’s score is determined only on their performance on the standardized exam.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The model learns from the training data and uses the validation set to evaluate its performance. Machine learning practitioners take this performance as feedback to find opportunities to improve their models on a continuous basis, similar to how students improve their preparation with the help of quizzes. There are several knobs that we can tune to improve performance; for example, the number of layers to train.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://kaggle.com/" class="s63" target="_blank">In many research competitions (including </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">Kaggle.com</span>), contestants receive a test set that is separate from the data they can use for building the model. This ensures uniformity across the competition when it comes to reporting accuracy. It is up to the</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">contestants to divide the available data into training and validation sets. Similarly, during our experiments in this book, we will continue to divide data in these two sets, keeping in mind that a test dataset is still essential to report real-world numbers.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark249">So why even use a validation set? Data is sometimes difficult to obtain, so why not use all the available samples for training, and then report accuracy on them? Sure, when the model begins to learn, it will gradually give higher accuracy predictions on the training dataset (called training accuracy). But because they are so powerful, deep neural networks can potentially memorize the training data, even resulting in 100% accuracy on the training data sometimes. However, its real-world performance will be quite poor. It’s like if the student knew the questions that would be on the exam before taking it. This is why a validation set, not used to train the model, gives a realistic assessment of the model performance. Even though we might assign 10-15% of the data as a validation set, it will go a long way in guiding us on how good our model really is.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">For the training process, we need to store our dataset in the proper folder structure. We’ll divide the images into two sets: training and validation. For an image file, Keras will automatically assign the name of the <i>class </i>(category) based on its parent folder name.</p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Figure 3-6 <span style=" color: #000;">depicts the ideal structure to recreate.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 144pt;text-indent: 0pt;text-align: left;"><span><img width="225" height="268" alt="image" src="KerasTensorFlow2019/Image_200.jpg"/></span></p><p class="s50" style="padding-top: 7pt;padding-left: 182pt;text-indent: -163pt;line-height: 108%;text-align: left;"><a name="bookmark250">Figure 3-6. Example directory structure of the training and validation data for different classes</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The following sequence of commands can help download the data and achieve this directory structure:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><a href="http://www.kaggle.com/c/dogs-vs-cats-redux-kernels-edition/" class="s69" target="_blank">$ wget </a>https://www.kaggle.com/c/dogs-vs-cats-redux-kernels-edition/ download/train.zip</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ unzip train.zip</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ mv train data</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ cd data</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ mkdir train val</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ mkdir train/cat train/dog</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ mkdir val/cat val/dog</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The 25,000 files within the data folder are prefixed with “cat” and “dog.” Now, move the files into their respective directories. To keep our initial experiment short, we pick 250 random files per class and place them in training and validation folders. We can increase/decrease this number anytime, to experiment with a trade-off between accuracy and speed:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ ls | grep cat | sort -R | head -25O | xargs -I {} mv {} train/cat/</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ ls | grep dog | sort -R | head -25O | xargs -I {} mv {} train/dog/</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ ls | grep cat | sort -R | head -25O | xargs -I {} mv {} val/cat/</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ ls | grep dog | sort -R | head -25O | xargs -I {} mv {} val/dog/</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark213">Build the Data Pipeline</a><a name="bookmark251">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark252">To start off with our Python program, we begin by importing the necessary packages:</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">tensorflow </span>as <span style=" color: #0CF;">tf</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">tf.keras.preprocessing.image </span>import <span class="s56">ImageDataGenerator</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">tf.keras.models </span>import <span class="s56">Model</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">from </span><span class="s55">tf.keras.layers </span><span class="s54">import </span>Input<span style=" color: #000;">, </span>Flatten<span style=" color: #000;">, </span>Dense<span style=" color: #000;">, </span>Dropout<span style=" color: #000;">,</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">GlobalAveragePooling2D</p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">tf.keras.applications.mobilenet </span>import <span class="s56">MobileNet</span><span class="s53">, </span><span class="s56">preprocess_input</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">math</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Place the following lines of configuration right after the import statements, which we can modify based on our dataset:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">TRAIN_DATA_DIR <span style=" color: #000;">= </span><span style=" color: #C30;">&#39;data/train_data/&#39; </span>VALIDATION_DATA_DIR <span style=" color: #000;">= </span><span style=" color: #C30;">&#39;data/val_data/&#39; </span>TRAIN_SAMPLES <span style=" color: #000;">= </span><span style=" color: #F60;">5OO</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">VALIDATION_SAMPLES <span style=" color: #000;">= </span><span style=" color: #F60;">5OO </span>NUM_CLASSES <span style=" color: #000;">= </span><span style=" color: #F60;">2</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">IMG_WIDTH</span>, <span style=" color: #000087;">IMG_HEIGHT </span>= <span style=" color: #F60;">224</span>, <span style=" color: #F60;">224</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">BATCH_SIZE <span style=" color: #000;">= </span><span style=" color: #F60;">64</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark214">Number of Classes</a><a name="bookmark253">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">With two classes to distinguish between, we can treat this problem as one of the following:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_201.png"/></span></p><p style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">A binary classification task</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_202.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">A multiclass classification task</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s70" style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark215">Binary classification</a></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark254">As a binary classification task, it’s important to note that “cat versus dog is really “cat versus not cat.” A dog would be classified as a “not cat” much like a desk or a ball would. For a given image, the model will give a single probability value corresponding to the “cat” class — hence the probability of “not cat” is 1 - </a><i>P(cat)</i>. If the probability is higher than 0.5, we predict it as “cat”; otherwise, “not cat.” To keep things simple, we assume that it’s guaranteed that the test set would contain only images of either cats or dogs.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="165" alt="image" src="KerasTensorFlow2019/Image_203.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Keras processes the input data in the alphabetical order of the folder names. Because “cat” comes before “dog” alphabetically, our first class for prediction is “cat.” For a multiclass task, we can apply the same concept and infer each class identifier (index) based on the folder sort order. Note that the class index starts at 0 for the first class.</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Because “cat versus not cat” is a binary classification task, we set the number of classes to 1; that is, “cat.” Anything that cannot be classified as “cat” will be classified as “not cat.”</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s70" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark216">Multiclass classification</a></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark255">In a hypothetical world that had only cats and dogs and nothing else, a “not cat” would always be a dog. So the label “not cat” could simply be replaced with the label “dog.” However, in the real world, we have more than two types of objects. As explained before, a ball or a sofa would also be classified as “dog,” which would be incorrect. Hence, for a real-world scenario, treating this</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">as a multiclass classification task instead of a binary classification task is far more useful. As a multiclass classification task, we predict separate probability values for each class, and the highest one is our winner. In the case of “cat versus dog,” we set the number of classes to two. To keep our code reusable for future tasks, we will treat this as a multiclassification task.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark217">Batch Size</a><a name="bookmark256">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark257">At a high level, the training process includes the following steps:</a></p><ol id="l8"><li><p style="padding-top: 7pt;padding-left: 58pt;text-indent: -16pt;text-align: left;">Make predictions on images (<i>forward pass</i>).</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 58pt;text-indent: -16pt;text-align: left;">Determine which predictions were incorrect and propagate back the difference between the prediction and the true value (<i>backpropagation</i>).</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 58pt;text-indent: -16pt;text-align: left;">Rinse and repeat until the predictions become sufficiently accurate.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">It’s quite likely that the initial iteration would have close to 0% accuracy. Repeating the process several times, however, can yield a highly accurate model (&gt;90%).</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The batch size defines how many images are seen by the model at a time. It’s important that each batch has a good variety of images from different classes in order to prevent large fluctuations in the accuracy metric between iterations. A sufficiently large batch size would be necessary for that. However, it’s important not to set the batch size too large; a batch that is too large might not fit in GPU memory, resulting in an “out of memory” crash. Usually, batch sizes are set as powers of 2. A good number to start with is 64 for most problems, and we can play with the number by increasing or decreasing it.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark218">Data Augmentation</a><a name="bookmark258">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="165" alt="image" src="KerasTensorFlow2019/Image_204.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Often, when we attempt to train a neural network on a small amount of data, the result is a model that performs extremely well on the training data itself but makes rather poor predictions on data that it has not seen before. Such a model would be described as an <i>overfitted </i>model and the problem itself is known as <i>overfitting</i>.</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark259">Usually, when we hear deep learning, we associate it with millions of images. So, 500 images like what we have might be a low number for real-world training. While these deep neural networks are powerful, a little too powerful for small quantities of data, the danger of a limited set of training images is that the neural network might memorize our training data, and show great prediction performance on the training set, but bad accuracy on the validation set. In other words, the model has overtrained and does not generalize on previously unseen images. And we definitely don’t want that.</a><a name="bookmark260">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark262" class="s44" name="bookmark261">Figure 3-7</a> <span style=" color: #000;">illustrates this phenomenon for a distribution of points close to a sine curve (with little noise). The dots represent the training data visible to our network, and the crosses represent the testing data that was not seen during training. On one extreme (underfitting), an unsophisticated model, such as a linear predictor, will not be able to represent the underlying distribution well and a high error rate on both the training data and the test data will result. On the other extreme (overfitting), a powerful model (such as a deep neural network) might have the capacity to memorize the training data, which would result in a really low error on the training data, but still a high error on the testing data. What we want is the happy middle where the training error and the testing error are both modestly low, which ideally ensures that our model will perform just as well in the real world as it does during training.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 12pt;text-indent: 0pt;text-align: left;"><span><img width="571" height="220" alt="image" src="KerasTensorFlow2019/Image_205.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 212pt;text-indent: -191pt;line-height: 108%;text-align: left;"><a name="bookmark262">Figure 3-7. Underfitting, overfitting, and ideal fitting for points close to a sine curve</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">With great power comes great responsibility. It’s our responsibility to ensure that our powerful deep neural network does not overfit on our data. Overfitting is common when we have little training data. We can reduce this likelihood in a few different ways:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_206.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_207.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_208.png"/></span></p><p style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;line-height: 191%;text-align: left;">Somehow get more data Heavily augment existing data Fine tune fewer layers</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">There are often situations for which there’s not enough data available. Perhaps we’re working on a niche problem and data is difficult to come by. But there are a few ways that we can artificially augment our dataset for classification:</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Rotation</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;">In our example, we might want to rotate the 500 images randomly by 20 degrees in either direction, yielding up to 20,000 possible unique images.</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Random Shift</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Shift the images slightly to the left, or to the right.</p><p class="s43" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Zoom</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Zoom in and out slightly of the image.</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;"><a name="bookmark263">By combining rotation, shifting, and zooming, the program can generate an almost infinite number of unique images. This important step is called </a><i>data augmentation</i>. Data augmentation is useful not only for adding more data, but also for training more robust models for real-world scenarios. For example, not all images have the cat properly centered in the middle or at a perfect 0-degree angle. Keras provides the <span class="s47">ImageDataGenerator </span><a href="#bookmark264" class="s63">function that augments the data while it is being loaded from the directory. To illustrate what data augmentations of images look like, </a><a href="#bookmark264" class="s44">Figure 3- 8 </a><a href="https://oreil.ly/KYA9O" class="s63" target="_blank">showcases example augmentations generated by the </a><span style=" color: #8E0012;">imgaug </span>library for a sample image. (Note that we will not be using imgaug for our actual training.)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="594" height="594" alt="image" src="KerasTensorFlow2019/Image_209.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 26pt;text-indent: 0pt;text-align: left;"><a name="bookmark264">Figure 3-8. Possible image augmentations generated from a single image</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 113%;text-align: left;">Colored images usually have three channels: red, green, and blue. Each channel has an intensity value ranging from 0 to 255. To normalize it (i.e., scale down the value to between 0 and 1), we use the <span class="s47">preprocess_input </span>function (which, among other things, divides each pixel by 255):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">train_datagen <span style=" color: #000;">= </span>ImageDataGenerator<span style=" color: #000;">(</span>preprocessing_function<span style=" color: #000;">=</span>preprocess_input<span style=" color: #000;">,</span></p><p class="s53" style="padding-left: 229pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">rotation_range</span>=<span style=" color: #F60;">2O</span>, <span style=" color: #000087;">width_shift_range</span>=<span style=" color: #F60;">O.2</span>, <span style=" color: #000087;">height_shift_range</span>=<span style=" color: #F60;">O.2</span>, <span style=" color: #000087;">zoom_range</span>=<span style=" color: #F60;">O.2</span>)</p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="146" alt="image" src="KerasTensorFlow2019/Image_210.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Sometimes knowing the label of a training image can be useful in determining appropriate ways of augmenting it. For example, when training a digit recognizer, you might be okay with augmentation by flipping vertically for an image of the digit “8,” but not for “6” and “9.”</p><p style="text-indent: 0pt;text-align: left;"/><p class="s56" style="padding-top: 4pt;padding-left: 21pt;text-indent: 0pt;text-align: left;">val_datagen <span style=" color: #000;">= </span>ImageDataGenerator<span style=" color: #000;">(</span>preprocessing_function<span style=" color: #000;">=</span>preprocess_input<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Unlike our training set, we don’t want to augment our validation set. The reason is that with dynamic augmentation, the validation set would keep changing in each iteration, and the resulting accuracy metric would be inconsistent and difficult to compare across other iterations.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark265">It’s time to load the data from its directories. Training one image at a time can be pretty inefficient, so we can batch them into groups. To introduce more randomness during the training process, we’ll keep shuffling the images in each batch. To bring reproducibility during multiple runs of the same program, we’ll give the random number generator a seed value:</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">train_generator <span style=" color: #000;">= </span>train_datagen<span style=" color: #000;">.</span>flow_from_directory<span style=" color: #000;">(</span></p><p class="s56" style="padding-left: 164pt;text-indent: 0pt;text-align: left;">TRAIN_DATA_DIR<span style=" color: #000;">,</span></p><p class="s53" style="padding-left: 164pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">target_size</span>=(<span style=" color: #000087;">IMG_WIDTH</span>, <span style=" color: #000087;">IMG_HEIGHT</span>), <span style=" color: #000087;">batch_size</span>=<span style=" color: #000087;">BATCH_SIZE</span>, <span style=" color: #000087;">shuffle</span>=<span class="s54">True</span>,</p><p class="s53" style="padding-left: 164pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">seed</span>=<span style=" color: #F60;">12345</span>, <span style=" color: #000087;">class_mode</span>=<span style=" color: #C30;">&#39;categorical&#39;</span>)</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">validation_generator <span style=" color: #000;">= </span>val_datagen<span style=" color: #000;">.</span>flow_from_directory<span style=" color: #000;">(</span></p><p class="s56" style="padding-left: 164pt;text-indent: 0pt;text-align: left;">VALIDATION_DATA_DIR<span style=" color: #000;">,</span></p><p class="s53" style="padding-left: 164pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">target_size</span>=(<span style=" color: #000087;">IMG_WIDTH</span>, <span style=" color: #000087;">IMG_HEIGHT</span>), <span style=" color: #000087;">batch_size</span>=<span style=" color: #000087;">BATCH_SIZE</span>, <span style=" color: #000087;">shuffle</span>=<span class="s54">False</span>, <span style=" color: #000087;">class_mode</span>=<span style=" color: #C30;">&#39;categorical&#39;</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark219">Model Definition</a><a name="bookmark266">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark267">Now that the data is taken care of, we come to the most crucial component of our training process: the model. In the code that follows, we reuse a CNN previously trained on the ImageNet dataset (MobileNet in our case), throw away the last few layers, called fully connected layers (i.e., ImageNet-specific classifier layers), and replace them with our own classifier suited to the task at hand.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;">For transfer learning, we “freeze” the weights of the original model; that is, set those layers as unmodifiable, so only the layers of the new classifier (that we’ll add) can be modified. We use MobileNet here to keep things fast, but this method will work just as well for any neural network. The following lines include a few terms such as <span class="s47">Dense</span>, <span class="s47">Dropout</span><a href="#bookmark1980" class="s63">, and so on. Although we won’t explore them in this chapter, you can find explanations in </a><span style=" color: #8E0012;">Appendix A</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">def <span class="s61">model_maker</span><span class="s53">():</span></p><p class="s53" style="padding-left: 21pt;text-indent: 23pt;text-align: left;"><span style=" color: #000087;">base_model </span>= <span style=" color: #000087;">MobileNet</span>(<span style=" color: #000087;">include_top</span>=<span class="s54">False</span>, <span style=" color: #000087;">input_shape </span>= (<span style=" color: #000087;">IMG_WIDTH</span>,<span style=" color: #000087;">IMG_HEIGHT</span>,<span style=" color: #F60;">3</span>))</p><p class="s56" style="padding-left: 69pt;text-indent: -23pt;text-align: left;"><span class="s54">for </span>layer <span class="s71">in </span>base_model<span style=" color: #000;">.</span>layers<span style=" color: #000;">[:]: </span>layer<span style=" color: #000;">.</span>trainable <span style=" color: #000;">= </span><span class="s54">False </span><span class="s60"># Freeze the layers</span></p><p class="s53" style="padding-left: 45pt;text-indent: 0pt;text-align: left;"><span style=" color: #366;">input </span>= <span style=" color: #000087;">Input</span>(<span style=" color: #000087;">shape</span>=(<span style=" color: #000087;">IMG_WIDTH</span>, <span style=" color: #000087;">IMG_HEIGHT</span>, <span style=" color: #F60;">3</span>)) <span style=" color: #000087;">custom_model </span>= <span style=" color: #000087;">base_model</span>(<span style=" color: #366;">input</span>)</p><p class="s53" style="padding-left: 45pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">custom_model </span>= <span style=" color: #000087;">GlobalAveragePooling2D</span>()(<span style=" color: #000087;">custom_model</span>) <span style=" color: #000087;">custom_model </span>= <span style=" color: #000087;">Dense</span>(<span style=" color: #F60;">64</span>, <span style=" color: #000087;">activation</span>=<span style=" color: #C30;">&#39;relu&#39;</span>)(<span style=" color: #000087;">custom_model</span>) <span style=" color: #000087;">custom_model </span>= <span style=" color: #000087;">Dropout</span>(<span style=" color: #F60;">O.5</span>)(<span style=" color: #000087;">custom_model</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 23pt;text-align: left;"><span style=" color: #000087;">predictions </span>= <span style=" color: #000087;">Dense</span>(<span style=" color: #000087;">NUM_CLASSES</span>, <span style=" color: #000087;">activation</span>=<span style=" color: #C30;">&#39;softmax&#39;</span>) (<span style=" color: #000087;">custom_model</span>)</p><p class="s53" style="padding-left: 45pt;text-indent: 0pt;text-align: left;"><span class="s54">return </span><span style=" color: #000087;">Model</span>(<span style=" color: #000087;">inputs</span>=<span style=" color: #366;">input</span>, <span style=" color: #000087;">outputs</span>=<span style=" color: #000087;">predictions</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark220">Train the Model</a><a name="bookmark268">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark221">Set Training Parameters</a><a name="bookmark269">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark270">With both the data and model ready, all we have left to do is train the model. This is also known as </a><i>fitting the model to the data</i>. For training a model, we need to select and modify a few different training parameters.</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Loss function</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark271">The </a><span class="s47">loss </span>function is the penalty we impose on the model for incorrect predictions during the training process. It is the value of this function that we seek to <i>minimize</i>. For example, in a task to predict house prices, the <span class="s47">loss </span>function could be the root-mean-square error.</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Optimizer</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark272">This is an algorithm that helps minimize the </a><span class="s47">loss </span>function. We use Adam, one of the fastest optimizers out there.</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Learning rate</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark273">Learning is incremental. The learning rate tells the optimizer how big of a step to take toward the solution; in other words, where the loss is minimum. Take too big of a step, and we end up wildly swinging and overshooting our target. Take too small a step, and it can take a really long time before eventually arriving at the target loss value. It is important to set an optimal learning rate to ensure that we reach our learning goal in a reasonable amount of time. In our example, we set the learning rate at 0.001.</a></p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Metric</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark274">Choose a metric to judge the performance of the trained model. Accuracy is a good explainable metric, especially when the classes are not imbalanced (i.e., roughly equal amounts of data for each class). Note that this metric is not related to the </a><span class="s47">loss </span>function and is mainly used for reporting and not as feedback for the model.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In the following piece of code, we create the custom model using the <span class="s47">model_maker </span>function that we wrote earlier. We use the</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">parameters described here to customize this model further for our task of cats versus dogs:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">model </span>= <span style=" color: #000087;">model_maker</span>() <span style=" color: #000087;">model</span>.<span style=" color: #000087;">compile</span>(<span style=" color: #000087;">loss</span>=<span style=" color: #C30;">&#39;categorical_crossentropy&#39;</span>,</p><p class="s53" style="padding-left: 104pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">optimizer</span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">train</span>.<span style=" color: #000087;">Adam</span>(<span style=" color: #000087;">lr</span>=<span style=" color: #F60;">O.OO1</span>), <span style=" color: #000087;">metrics</span>=[<span style=" color: #C30;">&#39;acc&#39;</span>])</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">num_steps </span>= <span style=" color: #000087;">math</span>.<span style=" color: #000087;">ceil</span>(<span style=" color: #366;">float</span>(<span style=" color: #000087;">TRAIN_SAMPLES</span>)/<span style=" color: #000087;">BATCH_SIZE</span>) <span style=" color: #000087;">model</span>.<span style=" color: #000087;">fit_generator</span>(<span style=" color: #000087;">train_generator</span>,</p><p class="s53" style="padding-left: 140pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">steps_per_epoch </span>= <span style=" color: #000087;">num_steps</span>, <span style=" color: #000087;">epochs</span>=<span style=" color: #F60;">1O</span>,</p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="125" alt="image" src="KerasTensorFlow2019/Image_211.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">You might have noticed the term epoch in the preceding code. One epoch represents a full training step where the network has gone over the entire dataset. One epoch may consist of several minibatches.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s56" style="padding-left: 140pt;text-indent: 0pt;text-align: left;">validation_data <span style=" color: #000;">= </span>validation_generator<span style=" color: #000;">, </span>validation_steps <span style=" color: #000;">= </span>num_steps<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark222">Start Training</a><a name="bookmark275">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Run this program and let the magic begin. If you don’t have a GPU, brew a cup of coffee while you wait — it might take 5 to 10 minutes. Or why wait, when you can run the notebooks of this chapter (posted on GitHub) on Colab with a GPU runtime for free?</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;">When complete, notice that there are four statistics: <span class="s47">loss </span>and <span class="s47">acc </span>on both the training and validation data. We are rooting for <span class="s47">val_acc:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&gt; Epoch 1/1OO 7/7 [====] - 5s -</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">loss: O.6888 - acc: O.6756 - val_loss: O.2786 - val_acc: O.9O18</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&gt; Epoch 2/1OO 7/7 [====] - 5s -</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">loss: O.2915 - acc: O.9O19 - val_loss: O.2O22 - val_acc: O.922O</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&gt; Epoch 3/1OO 7/7 [====] - 4s -</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">loss: O.1851 - acc: O.9158 - val_loss: O.1356 - val_acc: O.9427</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&gt; Epoch 4/1OO 7/7 [====] - 4s -</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">loss: O.15O9 - acc: O.9341 - val_loss: O.1451 - val_acc: O.94O4</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&gt; Epoch 5/1OO 7/7 [====] - 4s -</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">loss: O.1455 - acc: O.9464 - val_loss: O.1637 - val_acc: O.9381</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&gt; Epoch 6/1OO 7/7 [====] - 4s -</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">loss: O.1366 - acc: O.9431 - val_loss: O.2319 - val_acc: O.9151</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&gt; Epoch 7/1OO 7/7 [====] - 4s -</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">loss: O.O983 - acc: O.96O6 - val_loss: O.142O - val_acc: O.9495</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&gt; Epoch 8/1OO 7/7 [====] - 4s -</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">loss: O.O841 - acc: O.9731 - val_loss: O.1423 - val_acc: O.9518</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&gt; Epoch 9/1OO 7/7 [====] - 4s -</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">loss: O.O714 - acc: O.9839 - val_loss: O.1564 - val_acc: O.95O9</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&gt; Epoch 1O/1OO 7/7 [====] - 5s -</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">loss: O.O848 - acc: O.9677 - val_loss: O.O882 - val_acc: O.97O2</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark276">All it took was 5 seconds in the very first epoch to reach 90% accuracy on the validation set, with just 500 training images. Not bad! And by the 10th step, we observe about 97% </a><i>validation accuracy</i>. That’s the power of transfer learning.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Let us take a moment to appreciate what happened here. With just 500 images, we were able to reach a high level of accuracy in a matter of a few seconds and with very little code. In contrast, if we did not have a model previously trained on ImageNet, getting an accurate model might have needed training time anywhere between a couple of hours to a few days, and tons more data.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark277">That’s all the code we need to train a state-of-the-art classifier on any problem. Place data into folders with the name of the class,</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 117%;text-align: left;">and change the corresponding values in the configuration variables. In case our task has more than two classes, we should use <span class="s47">categorical_crossentropy </span>as the <span class="s47">loss </span>function and replace the <span class="s47">activation </span>function in the last layer with <span class="s47">softmax</span><a href="#bookmark278" class="s63">. </a><a href="#bookmark278" class="s44">Table </a><span style=" color: #8E0012;">3-2 </span>illustrates this.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s43" style="padding-left: 11pt;text-indent: 0pt;text-align: left;"><a name="bookmark278">Table 3-2. Deciding the loss and activation type based on the task</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="581" height="1" alt="image" src="KerasTensorFlow2019/Image_212.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">Classification type</p><p class="s48" style="padding-top: 2pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">Class mode</p><p class="s48" style="padding-top: 2pt;padding-left: 156pt;text-indent: -145pt;line-height: 108%;text-align: left;">Loss Activation on the last layer</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="581" height="1" alt="image" src="KerasTensorFlow2019/Image_213.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="50" alt="image" src="KerasTensorFlow2019/Image_214.png"/></span></p><p class="s49" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 108%;text-align: left;">Multiclass, single categorical categorical_crossentropy softmax label</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="padding-top: 2pt;padding-bottom: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">1 or 2 classes binary binary_crossentropy sigmoid</p><p class="s49" style="padding-top: 2pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">Multiclass, multilabel</p><p class="s49" style="padding-top: 2pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">categorical binary_crossentropy sigmoid</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="581" height="1" alt="image" src="KerasTensorFlow2019/Image_215.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark279">Before we forget, save the model that you just trained so that we can use it later:</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">model.save(&#39;model.h5&#39;)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark223">Test the Model</a><a name="bookmark280">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 114%;text-align: left;"><a name="bookmark281">Now that we have a trained model, we might eventually want to use it later for our application. We can now load this model anytime and classify an image. </a><span class="s47">load_model</span>, as its name suggests, loads the model:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">from </span><span class="s55">tf.keras.models </span><span class="s54">import </span><span style=" color: #000087;">load_model model </span>= <span style=" color: #000087;">load_model</span>(<span style=" color: #C30;">&#39;model.h5&#39;</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Now let’s try loading our original sample images and see what results we get:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">img_path <span style=" color: #000;">= </span><span style=" color: #C30;">&#39;../../sample_images/dog.jpg&#39;</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">img </span>= <span style=" color: #000087;">image</span>.<span style=" color: #000087;">load_img</span>(<span style=" color: #000087;">img_path</span>, <span style=" color: #000087;">target_size</span>=(<span style=" color: #F60;">224</span>,<span style=" color: #F60;">224</span>)) <span style=" color: #000087;">img_array </span>= <span style=" color: #000087;">image</span>.<span style=" color: #000087;">img_to_array</span>(<span style=" color: #000087;">img</span>) <span style=" color: #000087;">expanded_img_array </span>= <span style=" color: #000087;">np</span>.<span style=" color: #000087;">expand_dims</span>(<span style=" color: #000087;">img_array</span>, <span style=" color: #000087;">axis</span>=<span style=" color: #F60;">O</span>)</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">preprocessed_img <span style=" color: #000;">= </span>preprocess_input<span style=" color: #000;">(</span>expanded_img_array<span style=" color: #000;">) </span><span class="s60"># Preprocess the image</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">prediction </span>= <span style=" color: #000087;">model</span>.<span style=" color: #000087;">predict</span>(<span style=" color: #000087;">preprocessed_img</span>) <span style=" color: #366;">print</span>(<span style=" color: #000087;">prediction</span>) <span style=" color: #366;">print</span>(<span style=" color: #000087;">validation_generator</span>.<span style=" color: #000087;">class_indices</span>) [[<span style=" color: #F60;">O.99677O6</span>]]</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">{<span style=" color: #C30;">&#39;dog&#39;</span>: <span style=" color: #F60;">1</span>, <span style=" color: #C30;">&#39;cat&#39;</span>: <span style=" color: #F60;">O</span>}</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Printing the value of the probability, we see that it is 0.996. This is the probability of the given image belonging to the class “1,” which is a dog. Because the probability is greater than 0.5, the image is predicted as a dog.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">That’s all that we need to train our own classifiers. Throughout this book, you can expect to reuse this code for training with minimal modifications. You can also reuse this code in your own projects.</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Play with the number of epochs and images, and observe how it affects the accuracy. Also, we should play with any other data we can find online. It doesn’t get easier than that!</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark224">Analyzing the Results</a><a name="bookmark282">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark283">With our trained model, we can analyze how it’s performing on the validation dataset. Beyond the more straightforward accuracy metrics, looking at the actual images of mispredictions should give an intuition as to whether the example was truly challenging or whether our model is not sophisticated enough.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">There are three questions that we want to answer for each category (cat, dog):</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_216.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_217.png"/></span></p><p style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;line-height: 191%;text-align: left;">Which images are we most confident about being a cat/dog? Which images are we least confident about being a cat/dog?</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_218.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Which images have incorrect predictions in spite of being highly confident?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Before we get to that, let’s get predictions over the entire validation dataset. First, we set the pipeline configuration correctly:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># VARIABLES</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">IMG_WIDTH</span>, <span style=" color: #000087;">IMG_HEIGHT </span>= <span style=" color: #F60;">224</span>, <span style=" color: #F60;">224</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">VALIDATION_DATA_DIR <span style=" color: #000;">= </span><span style=" color: #C30;">&#39;data/val_data/&#39;</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">VALIDATION_BATCH_SIZE <span style=" color: #000;">= </span><span style=" color: #F60;">64</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># DATA GENERATORS</p><p class="s56" style="padding-left: 69pt;text-indent: -47pt;text-align: left;">validation_datagen <span style=" color: #000;">= </span>ImageDataGenerator<span style=" color: #000;">( </span>preprocessing_function<span style=" color: #000;">=</span>preprocess_input<span style=" color: #000;">)</span></p><p class="s56" style="padding-left: 69pt;text-indent: -47pt;text-align: left;">validation_generator <span style=" color: #000;">= </span>validation_datagen<span style=" color: #000;">.</span>flow_from_directory<span style=" color: #000;">( </span>VALIDATION_DATA_DIR<span style=" color: #000;">,</span></p><p class="s53" style="padding-left: 69pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">target_size</span>=(<span style=" color: #000087;">IMG_WIDTH</span>, <span style=" color: #000087;">IMG_HEIGHT</span>), <span style=" color: #000087;">batch_size</span>=<span style=" color: #000087;">VALIDATION_BATCH_SIZE</span>, <span style=" color: #000087;">shuffle</span>=<span class="s54">False</span>, <span style=" color: #000087;">class_mode</span>=<span style=" color: #C30;">&#39;categorical&#39;</span>)</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">ground_truth <span style=" color: #000;">= </span>validation_generator<span style=" color: #000;">.</span>classes</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Then, we get the predictions:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">predictions <span style=" color: #000;">= </span>model<span style=" color: #000;">.</span>predict_generator<span style=" color: #000;">(</span>validation_generator<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">To make our analysis easier, we make a dictionary storing the image index to the prediction and ground truth (the expected prediction) for each image:</p><p class="s60" style="padding-top: 4pt;padding-left: 21pt;text-indent: 0pt;text-align: left;"># prediction_table is a dict with index, prediction, ground truth</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">prediction_table <span style=" color: #000;">= {}</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">for </span>index<span style=" color: #000;">, </span>val <span class="s71">in </span><span style=" color: #366;">enumerate</span><span style=" color: #000;">(</span>predictions<span style=" color: #000;">):</span></p><p class="s60" style="padding-left: 45pt;text-indent: 0pt;text-align: left;"># get argmax index</p><p class="s56" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">index_of_highest_probability <span style=" color: #000;">= </span>np<span style=" color: #000;">.</span>argmax<span style=" color: #000;">(</span>val<span style=" color: #000;">) </span>value_of_highest_probability <span style=" color: #000;">= </span>val<span style=" color: #000;">[</span>index_of_highest_probability<span style=" color: #000;">] </span>prediction_table<span style=" color: #000;">[</span>index<span style=" color: #000;">] = [</span>value_of_highest_probability<span style=" color: #000;">,</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">index_of_highest_probability<span style=" color: #000;">, </span>ground_truth<span style=" color: #000;">[</span>index<span style=" color: #000;">]]</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">assert </span><span style=" color: #366;">len</span>(<span style=" color: #000087;">predictions</span>) == <span style=" color: #366;">len</span>(<span style=" color: #000087;">ground_truth</span>) == <span style=" color: #366;">len</span>(<span style=" color: #000087;">prediction_table</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">For the next two code blocks, we provide boilerplate code, which we reuse regularly throughout the book.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The following is the signature of the helper function we’ll use to find the images with the highest/lowest probability value for a given category. Additionally, we will be using another helper function, - <span class="s47">display</span>(), to output the images as a grid on-screen:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 45pt;text-indent: -23pt;text-align: left;"><span class="s54">def </span><span style=" color: #C0F;">display</span>(<span style=" color: #000087;">sorted_indices</span>, <span style=" color: #000087;">message</span>): <span style=" color: #000087;">similar_image_paths </span>= [] <span style=" color: #000087;">distances </span>= []</p><p class="s56" style="padding-left: 69pt;text-indent: -23pt;text-align: left;"><span class="s54">for </span>name<span style=" color: #000;">, </span>value <span class="s71">in </span>sorted_indices<span style=" color: #000;">: [</span>probability<span style=" color: #000;">, </span>predicted_index<span style=" color: #000;">, </span>gt<span style=" color: #000;">] = </span>value</p><p class="s56" style="padding-left: 69pt;text-indent: 0pt;text-align: left;">similar_image_paths<span style=" color: #000;">.</span>append<span style=" color: #000;">(</span>VALIDATION_DATA_DIR <span style=" color: #000;">+ </span>fnames<span style=" color: #000;">[</span>name<span style=" color: #000;">]) </span>distances<span style=" color: #000;">.</span>append<span style=" color: #000;">(</span>probability<span style=" color: #000;">)</span></p><p class="s56" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">plot_images<span style=" color: #000;">(</span>similar_image_paths<span style=" color: #000;">, </span>distances<span style=" color: #000;">, </span>message<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">This function is defined the book’s Github website (see</p><p style="padding-top: 1pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">http://PracticalDeepLearning.ai</span>), at <i>code/chapter-3</i>).</p><p class="s45" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark284" class="s63">Now the fun starts! Which images are we most confident contain dogs? Let’s find images with the highest prediction probability (i.e., closest to 1.0; see </a>Figure 3-9<span style=" color: #000;">) with the predicted class dog (i.e., 1):</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Most confident predictions of &#39;dog&#39;</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">indices </span>= <span style=" color: #000087;">get_images_with_sorted_probabilities</span>(<span style=" color: #000087;">prediction_table</span>, <span style=" color: #000087;">get_highest_probability</span>=<span class="s54">True</span>, <span style=" color: #000087;">label</span>=<span style=" color: #F60;">1</span>, <span style=" color: #000087;">number_of_items</span>=<span style=" color: #F60;">1O</span>, <span style=" color: #000087;">only_false_predictions</span>=<span class="s54">False</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">message </span>= <span style=" color: #C30;">&#39;Images with the highest probability of containing dogs&#39; </span><span style=" color: #000087;">display</span>(<span style=" color: #000087;">indices</span>[:<span style=" color: #F60;">1O</span>], <span style=" color: #000087;">message</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 11pt;text-indent: 0pt;text-align: left;"><span><img width="578" height="295" alt="image" src="KerasTensorFlow2019/Image_219.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 49pt;text-indent: 0pt;text-align: left;"><a name="bookmark284">Figure 3-9. Images with the highest probability of containing dogs</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">These images are indeed very dog-like. One of the reasons the probability is so high may be the fact that the images contain multiple dogs, as well as clear, unambiguous views. Now let’s try to find which images we are least confident contain dogs (see</p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Figure 3-10<span style=" color: #000;">):</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Least confident predictions of &#39;dog&#39;</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">indices </span>= <span style=" color: #000087;">get_images_with_sorted_probabilities</span>(<span style=" color: #000087;">prediction_table</span>, <span style=" color: #000087;">get_highest_probability</span>=<span class="s54">False</span>, <span style=" color: #000087;">label</span>=<span style=" color: #F60;">1</span>, <span style=" color: #000087;">number_of_items</span>=<span style=" color: #F60;">1O</span>, <span style=" color: #000087;">only_false_predictions</span>=<span class="s54">False</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">message </span>= <span style=" color: #C30;">&#39;Images with the lowest probability of containing dogs&#39; </span><span style=" color: #000087;">display</span>(<span style=" color: #000087;">indices</span>[:<span style=" color: #F60;">1O</span>], <span style=" color: #000087;">message</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 11pt;text-indent: 0pt;text-align: left;"><span><img width="585" height="279" alt="image" src="KerasTensorFlow2019/Image_220.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 48pt;text-indent: 0pt;text-align: left;"><a name="bookmark285">Figure 3-10. Images with the lowest probability of containing dogs</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">To repeat, these are the images our classifier is most unsure of containing a dog. Most of these predictions are at the tipping point (i.e., 0.5 probability) to be the majority prediction. Keep in mind the probability of being a cat is just slightly smaller, around 0.49.</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Compared to the previous set of images, the animals appearing in these images are often smaller and less clear. And these images often result in mispredictions — only 2 of the 10 images were correctly predicted. One possible way to do better here is to train with a larger set of images.</p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark458" class="s63">If you are concerned about these misclassifications, worry not. A simple trick to improve the classification accuracy is to have a higher threshold for accepting a classifier’s results, say 0.75. If the classifier is unsure of an image category, its results are withheld. In </a>Chapter 5<span style=" color: #000;">, we look at how to find an optimal threshold.</span></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark286" class="s63">Speaking of mispredictions, they are obviously expected when the classifier has low confidence (i.e., near 0.5 probability for a two- class problem). But what we don’t want is to mispredict when our classifier is really sure of its predictions. Let’s check which images the classifier is confident contain dogs in spite of them being cats (see </a><a href="#bookmark286" class="s44">Figure </a>3-11<span style=" color: #000;">):</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Incorrect predictions of &#39;dog&#39;</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">indices <span style=" color: #000;">= </span>get_images_with_sorted_probabilities<span style=" color: #000;">(</span>prediction_table<span style=" color: #000;">,</span></p><p class="s53" style="padding-top: 4pt;padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">get_highest_probability</span>=<span class="s54">True</span>, <span style=" color: #000087;">label</span>=<span style=" color: #F60;">1</span>, <span style=" color: #000087;">number_of_items</span>=<span style=" color: #F60;">1O</span>, <span style=" color: #000087;">only_false_predictions</span>=<span class="s54">True</span>)</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">message <span style=" color: #000;">= </span><span style=" color: #C30;">&#39;Images of cats with the highest probability of containing dogs&#39;</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">display</span>(<span style=" color: #000087;">indices</span>[:<span style=" color: #F60;">1O</span>], <span style=" color: #000087;">message</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="585" height="279" alt="image" src="KerasTensorFlow2019/Image_221.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 26pt;text-indent: 0pt;text-align: left;"><a name="bookmark286">Figure 3-11. Images of cats with the highest probability of containing dogs</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Hmm…turns out half of these images contain both cats and dogs, and our classifier is correctly predicting the dog category because they are bigger in size in these images. Thus, it’s not the classifier but the data that is incorrect here. This often happens in large datasets. The remaining half often contains unclear and relatively smaller objects (but ideally we want lower confidence for these difficult-to-identify images).</p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark287" class="s63">Repeating the same set of questions for the cat class, which images are more cat-like (see </a>Figure 3-12<span style=" color: #000;">)?</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Most confident predictions of &#39;cat&#39;</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">indices </span>= <span style=" color: #000087;">get_images_with_sorted_probabilities</span>(<span style=" color: #000087;">prediction_table</span>, <span style=" color: #000087;">get_highest_probability</span>=<span class="s54">True</span>, <span style=" color: #000087;">label</span>=<span style=" color: #F60;">O</span>, <span style=" color: #000087;">number_of_items</span>=<span style=" color: #F60;">1O</span>, <span style=" color: #000087;">only_false_predictions</span>=<span class="s54">False</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">message </span>= <span style=" color: #C30;">&#39;Images with the highest probability of containing cats&#39; </span><span style=" color: #000087;">display</span>(<span style=" color: #000087;">indices</span>[:<span style=" color: #F60;">1O</span>], <span style=" color: #000087;">message</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 11pt;text-indent: 0pt;text-align: left;"><span><img width="578" height="302" alt="image" src="KerasTensorFlow2019/Image_222.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 47pt;text-indent: 0pt;text-align: left;"><a name="bookmark287">Figure 3-12. Images with the highest probability of containing cats</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark288" class="s63">Interestingly, many of these have multiple cats. This affirms our previous hypothesis that multiple clear, unambiguous views of cats can give higher probabilities. On the other hand, which images are we most unsure about containing cats (see </a>Figure 3-13<span style=" color: #000;">)?</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Least confident predictions of &#39;cat&#39;</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">indices </span>= <span style=" color: #000087;">get_images_with_sorted_probabilities</span>(<span style=" color: #000087;">prediction_table</span>, <span style=" color: #000087;">get_highest_probability</span>=<span class="s54">False</span>, <span style=" color: #000087;">label</span>=<span style=" color: #F60;">O</span>, <span style=" color: #000087;">number_of_items</span>=<span style=" color: #F60;">1O</span>, <span style=" color: #000087;">only_false_predictions</span>=<span class="s54">False</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">message </span>= <span style=" color: #C30;">&#39;Images with the lowest probability of containing cats&#39; </span><span style=" color: #000087;">display</span>(<span style=" color: #000087;">indices</span>[:<span style=" color: #F60;">1O</span>], <span style=" color: #000087;">message</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="585" height="306" alt="image" src="KerasTensorFlow2019/Image_223.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 50pt;text-indent: 0pt;text-align: left;"><a name="bookmark288">Figure 3-13. Images with the lowest probability of containing cats</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark288" class="s63">As seen previously, the key object size is small, and some of the images are quite unclear, meaning that there is too much contrast in some cases or the object is too bright, something not in line with most of the training images. For example, the camera flash in the eighth (dog.6680) and tenth (dog.1625) images in </a>Figure 3-13 <span style=" color: #000;">makes the dog difficult to recognize. The sixth image contains a dog in front of a sofa of the same color. Two images contain cages.</span></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark289" class="s63">Lastly, which images is our classifier mistakenly sure of containing cats (see </a>Figure 3-14<span style=" color: #000;">)?</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Incorrect predictions of &#39;cat&#39;</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">indices </span>= <span style=" color: #000087;">get_images_with_sorted_probabilities</span>(<span style=" color: #000087;">prediction_table</span>, <span style=" color: #000087;">get_highest_probability</span>=<span class="s54">True</span>, <span style=" color: #000087;">label</span>=<span style=" color: #F60;">O</span>, <span style=" color: #000087;">number_of_items</span>=<span style=" color: #F60;">1O</span>, <span style=" color: #000087;">only_false_predictions</span>=<span class="s54">True</span>)</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">message <span style=" color: #000;">= </span><span style=" color: #C30;">&#39;Images of dogs with the highest probability of containing cats&#39;</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">display</span>(<span style=" color: #000087;">indices</span>[:<span style=" color: #F60;">1O</span>], <span style=" color: #000087;">message</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 12pt;text-indent: 0pt;text-align: left;"><span><img width="578" height="293" alt="image" src="KerasTensorFlow2019/Image_224.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 25pt;text-indent: 0pt;text-align: left;"><a name="bookmark289">Figure 3-14. Images of dogs with the highest probability of containing cats</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark289" class="s63">These mispredictions are what we want to reduce. Some of them are clearly wrong, whereas others are understandably confusing images. The sixth image (dog.4334) in </a>Figure 3-14 <span style=" color: #000;">seems to be incorrectly labeled as a dog. The seventh and tenth images are difficult to distinguish against the background. The first and tenth lack enough texture within them to give the classifier enough identification power. And some of the dogs are too small, like the second and fourth.</span></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Going over the various analyses, we can summarize that mispredictions can be caused by low illumination, unclear, difficult- to-distinguish backgrounds, lack of texture, and smaller occupied area with regard to the image.</p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark458" class="s63" name="bookmark290">Analyzing our predictions is a great way to understand what our model has learned and what it’s bad at, and highlights opportunities to enhance its predictive power. Increasing the size of the training examples and more robust augmentation will help in improving the classification. It’s also important to note that showing real-world images to our model (images that look similar to the scenario where our app will be used) will help improve its accuracy drastically. In </a>Chapter 5<span style=" color: #000;">, we make the classifier more robust.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark225">Further Reading</a><a name="bookmark291">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s63" target="_blank" name="bookmark292">To help understand neural networks and CNNs better, </a>our website <a href="#bookmark293" class="s63">features a learning guide which includes recommended resources like video lectures, blogs, and, more interestingly, interactive visual tools which allow you to play with different scenarios in the browser without the need to install any packages. If you’re a first-time learner of deep learning, we highly recommend this guide in order to strengthen your foundational knowledge. It covers the theory that you will need to build the intuition to solve future problems. We use Google’s TensorFlow Playground (</a>Figure 3-15<a href="#bookmark294" class="s63">) for neural networks and Andrej Karpathy’s ConvNetJS (</a>Figure 3-16<span style=" color: #000;">) for CNNs.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="322" alt="image" src="KerasTensorFlow2019/Image_225.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 50pt;text-indent: 0pt;text-align: left;"><a name="bookmark293">Figure 3-15. Building a neural network in TensorFlow Playground</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 12pt;text-indent: 0pt;text-align: left;"><span><img width="592" height="580" alt="image" src="KerasTensorFlow2019/Image_226.jpg"/></span></p><p class="s50" style="padding-top: 3pt;padding-left: 167pt;text-indent: -145pt;line-height: 108%;text-align: left;"><a name="bookmark294">Figure 3-16. Defining a CNN and visualizing the output of each layer during training in ConvNetJS</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1980" class="s63" name="bookmark295">We additionally have a short guide in </a>Appendix A<span style=" color: #000;">, which summarizes convolutional neural networks, as a ready reference.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark226">Summary</a><a name="bookmark296">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In this chapter, we introduced the concept of transfer learning. We reused a pretrained model to build our own cats versus dogs classifier in under 30 lines of code and with barely 500 images, reaching state-of-the-art accuracy in a few minutes. By writing this code, we also debunk the myth that we need millions of images and powerful GPUs to train our classifier (though they help).</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Hopefully, with these skills, you might be able to finally answer the age-old question of who let the dogs out.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In the next couple of chapters, we use this learning to understand CNNs in more depth and take the model accuracy to the next level.</p><h2 style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark297">Chapter 4. Building a Reverse Image Search Engine: Understanding Embeddings</a><a name="bookmark323">&zwnj;</a></h2><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="588" height="1" alt="image" src="KerasTensorFlow2019/Image_227.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark324">Bob just bought a new home and is looking to fill it up with some fancy modern furniture. He’s flipping endlessly through furniture catalogs and visiting furniture showrooms, but hasn’t yet landed on something he likes. Then one day, he spots the sofa of his dreams</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">— a unique L-shaped white contemporary sofa in an office reception. The good news is that he knows what he wants. The bad news is that he doesn’t know where to buy it from. The brand and model number is not written on the sofa. Asking the office manager doesn’t help either. So, he takes a few photos from different angles to ask around in local furniture shops, but tough luck: no one knows this particular brand. And searching on the internet with keywords like “white L-shaped,” “modern sofa” gives him thousands of results, but not the one he’s looking for.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Alice hears Bob’s frustration and asks, “Why don’t you try reverse image search?” Bob uploads his images on Google and Bing’s Reverse Image Search and quickly spots a similar-looking image on an online shopping website. Taking this more perfect image from the website, he does a few more reverse image searches and finds other websites offering the same sofa at cheaper prices. After a few minutes of being online, Bob has officially ordered his dream sofa!</p><p class="s43" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark325">Reverse image search </a><span class="p">(or as it is more technically known, </span>instance retrieval<span class="p">) enables developers and researchers to build scenarios beyond simple keyword search. From discovering visually similar objects on Pinterest to recommending similar songs on Spotify to camera-based product search on Amazon, a similar class of technology under the hood is used. Sites like TinEye alert photographers on copyright infringement when their photographs</span></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">are posted without consent on the internet. Even face recognition in several security systems uses a similar concept to ascertain the identity of the person.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The best part is, with the right knowledge, you can build a working replica of many of these products in a few hours. So let’s dig right in!</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Here’s what we’re doing in this chapter:</p><ol id="l9"><li><p style="padding-top: 7pt;padding-left: 58pt;text-indent: -16pt;text-align: left;">Performing feature extraction and similarity search on Caltech101 and Caltech256 datasets</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 58pt;text-indent: -16pt;text-align: left;">Learning how to scale to large datasets (up to billions of images)</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 58pt;text-indent: -16pt;text-align: left;">Making the system more accurate and optimized</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 58pt;text-indent: -16pt;text-align: left;">Analyzing case studies to see how these concepts are used in mainstream products</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark298">Image Similarity</a><a name="bookmark326">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark327">The first and foremost question is: given two images, are they similar or not?</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">There are several approaches to this problem. One approach is to compare patches of areas between two images. Although this can help find exact or near-exact images (that might have been cropped), even a slight rotation would result in dissimilarity. By storing the hashes of the patches, duplicates of an image can be found. One use case for this approach would be the identification of plagiarism in photographs.</p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark328" class="s63">Another naive approach is to calculate the histogram of RGB values and compare their similarities. This might help find near- similar images captured in the same environment without much change in the contents. For example, in </a>Figure 4-1<span style=" color: #000;">, this technique is used in image deduplication software aimed at finding bursts of photographs on your hard disk, so you can select the best one and delete the rest. Of course, there is an increasing possibility of false positives as your dataset grows. Another downside to this approach is that small changes to the color, hue, or white balance would make recognition more difficult.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="592" height="398" alt="image" src="KerasTensorFlow2019/Image_228.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 41pt;text-indent: 0pt;text-align: left;"><a name="bookmark328">Figure 4-1. RGB histogram-based “Similar Image Detector” program</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">A more robust traditional computer vision-based approach is to find visual features near edges using algorithms like Scale-Invariant Feature Transform (SIFT), Speeded Up Robust Features (SURF), and Oriented FAST and Rotated BRIEF (ORB) and then compare the number of similar features that are common between the two photos. This helps you go from a generic image-level understanding to a relatively robust object-level understanding.</p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark329" class="s63">Although this is great for images with rigid objects that have less variation like the printed sides of a box of cereal, which almost always look the same, it’s less helpful for comparing deformable objects like humans and animals, which can exhibit different poses. As an example, you can see the features being displayed on the camera-based product search experience on the Amazon app. The app displays these features in the form of blue dots (</a>Figure 4-2<span style=" color: #000;">).</span></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">When it sees a sufficient number of features, it sends them to the Amazon servers to retrieve product information.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="598" height="850" alt="image" src="KerasTensorFlow2019/Image_229.jpg"/></span></p><p class="s50" style="padding-top: 6pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a name="bookmark329">Figure 4-2. Product scanner in Amazon app with visual features highlighted</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Going deeper, another approach is to find the category (e.g., sofa) of an image using deep learning and then find other images within the same category. This is equivalent to extracting metadata from an image so that it can then be indexed and used in a typical text query-based search. This can be easily scaled by using the metadata in open source search engines like ElasticSearch. Many ecommerce sites show recommendations based on tags extracted from an image while performing a query-based search internally.</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">As you would expect, by extracting the tags, we lose certain information like color, pose, relationships between objects in the scene, and so on. Additionally, a major disadvantage of this approach is that it requires enormous volumes of labeled data to train the classifier for extracting these labels on new images. And every time a new category needs to be added, the model needs to be retrained.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Because our aim is to search among millions of images, what we ideally need is a way to summarize the information contained in the millions of pixels in an image into a smaller representation (of say a few thousand dimensions), and have this summarized representation be close together for similar objects and further away for dissimilar items.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark166" class="s63" name="bookmark330">Luckily, deep neural networks come to the rescue. As we saw in </a><span style=" color: #8E0012;">Chapter 2 </span><a href="#bookmark227" class="s63">and </a><span style=" color: #8E0012;">Chapter 3</span>, the CNNs take an image input and convert it into feature vectors of a thousand dimensions, which then act as input to a classifier that outputs the top identities to which the image might belong (say dog or cat). The <i>feature vectors </i>(also called <i>embeddings </i>or <i>bottleneck features</i>) are essentially a collection of a few thousand floating-point values. Going through the convolution and pooling layers in a CNN is basically an act of reduction, to filter the information contained in the image to its most important and salient constituents, which in turn form the bottleneck features. Training the CNN molds these values in such a way that items belonging to the same class have small Euclidean distance between them (or simply the square root of the sum of squares of the difference between corresponding values) and items from different classes are separated by larger distances. This</p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="146" alt="image" src="KerasTensorFlow2019/Image_230.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">An ideal way to find similar images would be to use <i>transfer learning</i>. For example, pass the images through a pretrained convolutional neural network like ResNet-50, extract the features, and then use a metric to calculate the error rate like the Euclidean distance.</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">is an important property that helps solve so many problems where a classifier can’t be used, especially in unsupervised problems because of a lack of adequate labeled data.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark331">Enough talk, let’s code!</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark299">Feature Extraction</a><a name="bookmark332">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark333">An image is worth a thousand </a><s>words</s> features.</p><p class="s45" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s63" target="_blank">In this section, we play with and understand the concepts of feature extraction, primarily with the Caltech 101 dataset (131 MB, approximately 9,000 images), and then eventually with Caltech 256 (1.2 GB, approximately 30,000 images). Caltech 101, as the name suggests, consists of roughly 9,000 images in 101 categories, with about 40 to 800 images per category. It’s important to note that there is a 102nd category called “BACKGROUND_Google” consisting of random images not contained in the first 101 categories, which needs to be deleted before we begin experimenting. Remember that all of the code we are writing is also available in the </a>GitHub repository<span style=" color: #000;">.</span></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Let’s download the dataset:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><a href="http://www.vision.caltech.edu/Image_Datasets/Caltech1O1/" class="s69" target="_blank">$ wget</a> http://www.vision.caltech.edu/Image_Datasets/Caltech1O1/ 1O1_ObjectCategories.tar.gz</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ tar -xvf 1O1_ObjectCategories.tar.gz</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ mv 1O1_ObjectCategories caltech1O1</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ rm -rf caltech1O1/BACKGROUND_Google</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Now, import all of the necessary modules:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">numpy </span>as <span style=" color: #0CF;">np</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">numpy.linalg </span>import <span class="s56">norm</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">pickle</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">tqdm </span>import <span class="s56">tqdm</span><span class="s53">, </span><span class="s56">tqdm_notebook</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">os </span>import <span style=" color: #0CF;">time</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">tf.keras.preprocessing </span>import <span class="s56">image</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">tf.keras.applications.resnet50 </span>import <span class="s56">ResNet5O</span><span class="s53">, </span><span class="s56">preprocess_input</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Load the ResNet-50 model without the top classification layers, so we get only the <i>bottleneck features. </i>Then define a function that takes an image path, loads the image, resizes it to proper dimensions supported by ResNet-50, extracts the features, and then normalizes them:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">model </span>= <span style=" color: #000087;">ResNet5O</span>(<span style=" color: #000087;">weights</span>=<span style=" color: #C30;">&#39;imagenet&#39;</span>, <span style=" color: #000087;">include_top</span>=<span class="s54">False</span>,</p><p class="s53" style="padding-left: 122pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">input_shape</span>=(<span style=" color: #F60;">224</span>, <span style=" color: #F60;">224</span>, <span style=" color: #F60;">3</span>))</p><p class="s53" style="padding-top: 4pt;padding-left: 45pt;text-indent: -23pt;text-align: left;"><span class="s54">def </span><span style=" color: #C0F;">extract_features</span>(<span style=" color: #000087;">img_path</span>, <span style=" color: #000087;">model</span>): <span style=" color: #000087;">input_shape </span>= (<span style=" color: #F60;">224</span>, <span style=" color: #F60;">224</span>, <span style=" color: #F60;">3</span>)</p><p class="s53" style="padding-left: 69pt;text-indent: -23pt;text-align: left;"><span style=" color: #000087;">img </span>= <span style=" color: #000087;">image</span>.<span style=" color: #000087;">load_img</span>(<span style=" color: #000087;">img_path</span>, <span style=" color: #000087;">target_size</span>=( <span style=" color: #000087;">input_shape</span>[<span style=" color: #F60;">O</span>], <span style=" color: #000087;">input_shape</span>[<span style=" color: #F60;">1</span>]))</p><p class="s53" style="padding-left: 45pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">img_array </span>= <span style=" color: #000087;">image</span>.<span style=" color: #000087;">img_to_array</span>(<span style=" color: #000087;">img</span>) <span style=" color: #000087;">expanded_img_array </span>= <span style=" color: #000087;">np</span>.<span style=" color: #000087;">expand_dims</span>(<span style=" color: #000087;">img_array</span>, <span style=" color: #000087;">axis</span>=<span style=" color: #F60;">O</span>)</p><p class="s56" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">preprocessed_img <span style=" color: #000;">= </span>preprocess_input<span style=" color: #000;">(</span>expanded_img_array<span style=" color: #000;">) </span>features <span style=" color: #000;">= </span>model<span style=" color: #000;">.</span>predict<span style=" color: #000;">(</span>preprocessed_img<span style=" color: #000;">) </span>flattened_features <span style=" color: #000;">= </span>features<span style=" color: #000;">.</span>flatten<span style=" color: #000;">()</span></p><p class="s56" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">normalized_features <span style=" color: #000;">= </span>flattened_features <span style=" color: #000;">/ </span>norm<span style=" color: #000;">(</span>flattened_features<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="108" alt="image" src="KerasTensorFlow2019/Image_231.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 115%;text-align: left;">The function defined in the previous example is the <span class="s53">key </span>function that we use for almost every feature extraction need in Keras.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s54" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">return <span class="s56">normalized_features</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark334">That’s it! Let’s see the feature-length that the model generates:</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">features </span>= <span style=" color: #000087;">extract_features</span>(<span style=" color: #C30;">&#39;../../sample_images/cat.jpg&#39;</span>, <span style=" color: #000087;">model</span>) <span style=" color: #366;">print</span>(<span style=" color: #366;">len</span>(<span style=" color: #000087;">features</span>))</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;">annoy</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&gt; 2O48</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="165" alt="image" src="KerasTensorFlow2019/Image_232.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">If your model is trained or fine tuned on a dataset that is not similar to ImageNet, redefine the “preprocess_input(img)” step accordingly. The mean values used in the function are particular to the ImageNet dataset. Each model in Keras has its own preprocessing function so make sure you are using the right one.</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The ResNet-50 model generated 2,048 features from the provided image. Each feature is a floating-point value between 0 and 1.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Now it’s time to extract features for the entire dataset. First, we get all the filenames with this handy function, which recursively looks for all the image files (defined by their extensions) under a directory:</p><p class="s53" style="padding-top: 4pt;padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">extensions </span>= [<span style=" color: #C30;">&#39;.jpg&#39;</span>, <span style=" color: #C30;">&#39;.JPG&#39;</span>, <span style=" color: #C30;">&#39;.jpeg&#39;</span>, <span style=" color: #C30;">&#39;.JPEG&#39;</span>, <span style=" color: #C30;">&#39;.png&#39;</span>, <span style=" color: #C30;">&#39;.PNG&#39;</span>]</p><p class="s53" style="padding-left: 45pt;text-indent: -23pt;text-align: left;"><span class="s54">def </span><span style=" color: #C0F;">get_file_list</span>(<span style=" color: #000087;">root_dir</span>): <span style=" color: #000087;">file_list </span>= []</p><p class="s56" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">counter <span style=" color: #000;">= </span><span style=" color: #F60;">1</span></p><p class="s56" style="padding-left: 45pt;text-indent: 0pt;text-align: left;"><span class="s54">for </span>root<span style=" color: #000;">, </span>directories<span style=" color: #000;">, </span>filenames <span class="s71">in </span>os<span style=" color: #000;">.</span>walk<span style=" color: #000;">(</span>root_dir<span style=" color: #000;">):</span></p><p class="s56" style="padding-left: 69pt;text-indent: 0pt;text-align: left;"><span class="s54">for </span>filename <span class="s71">in </span>filenames<span style=" color: #000;">:</span></p><p class="s56" style="padding-left: 116pt;text-indent: -23pt;text-align: left;"><span class="s54">if </span><span style=" color: #366;">any</span><span style=" color: #000;">(</span>ext <span class="s71">in </span>filename <span class="s54">for </span>ext <span class="s71">in </span>extensions<span style=" color: #000;">): </span>file_list<span style=" color: #000;">.</span>append<span style=" color: #000;">(</span>os<span style=" color: #000;">.</span>path<span style=" color: #000;">.</span>join<span style=" color: #000;">(</span>root<span style=" color: #000;">, </span>filename<span style=" color: #000;">)) </span>counter <span style=" color: #000;">+= </span><span style=" color: #F60;">1</span></p><p class="s54" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">return <span class="s56">file_list</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Then, we provide the path to our dataset and call the function:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># path to the datasets</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">root_dir </span>= <span style=" color: #C30;">&#39;../../datasets/caltech1O1&#39; </span><span style=" color: #000087;">filenames </span>= <span style=" color: #366;">sorted</span>(<span style=" color: #000087;">get_file_list</span>(<span style=" color: #000087;">root_dir</span>))</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We now define a variable that will store all of the features, go through all filenames in the dataset, extract their features, and append them to the previously defined variable:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">feature_list <span style=" color: #000;">= []</span></p><p class="s53" style="padding-left: 45pt;text-indent: -23pt;text-align: left;"><span class="s54">for </span><span style=" color: #000087;">i </span><b>in </b><span style=" color: #000087;">tqdm_notebook</span>(<span style=" color: #366;">range</span>(<span style=" color: #366;">len</span>(<span style=" color: #000087;">filenames</span>))): <span style=" color: #000087;">feature_list</span>.<span style=" color: #000087;">append</span>(<span style=" color: #000087;">extract_features</span>(<span style=" color: #000087;">filenames</span>[<span style=" color: #000087;">i</span>], <span style=" color: #000087;">model</span>))</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="171" alt="image" src="KerasTensorFlow2019/Image_233.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;">To get a better sense of time, use the super handy tool <span class="s53">tqdm</span><a href="#bookmark335" class="s140">, which shows a progress meter (</a><span style=" color: #8E0012;">Figure 4-3</span>) along with the speed per iteration as well as the time that has passed and expected finishing time. In Python, wrap an iterable with <span class="s53">tqdm; </span>for example, <span class="s53">tqdm(range(1O))</span>. Its Jupyter Notebook variant is <span class="s53">tqdm_notebook</span>.</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">On a CPU, this should take under an hour. On a GPU, only a few minutes.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 8pt;text-indent: 0pt;text-align: left;"><span><img width="576" height="22" alt="image" src="KerasTensorFlow2019/Image_234.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark335">Figure 4-3. Progress bar shown with </a><span class="s73">tqdm_notebook</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Finally, write these features to a pickle file so that we can use them in the future without having to recalculate them:</p><p class="s53" style="padding-top: 4pt;padding-left: 21pt;text-indent: 0pt;text-align: left;">pickle.dump(feature_list, open(&#39;data/features-caltech1O1- resnet.pickle&#39;, &#39;wb&#39;))</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">pickle.dump(filenames, open(&#39;data/filenames-caltech1O1.pickle&#39;,&#39;wb&#39;))</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark336">That’s all folks! We’re done with the feature extraction part.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark300">Similarity Search</a><a name="bookmark337">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark338">Given a photograph, our aim is to find another photo in our dataset similar to the current one. We begin by loading the precomputed features:</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">filenames = pickle.load(open(&#39;data/filenames-caltech1O1.pickle&#39;, &#39;rb&#39;)) feature_list = pickle.load(open(&#39;data/features-caltech1O1- resnet.pickle&#39;, &#39;rb&#39;))</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 114%;text-align: left;"><a name="bookmark339">We’ll use Python’s machine learning library </a><span class="s47">scikit-learn </span>for finding <i>nearest neighbors </i>of the query features; that is, features that represent a query image. We train a nearest-neighbor model using the brute-force algorithm to find the nearest five neighbors based on Euclidean distance (to install <span class="s47">scikit-learn </span>on your system, use <span class="s47">pip3 install sklearn)</span>:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">sklearn.neighbors </span>import <span class="s56">NearestNeighbors</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">neighbors </span>= <span style=" color: #000087;">NearestNeighbors</span>(<span style=" color: #000087;">n_neighbors</span>=<span style=" color: #F60;">5</span>, <span style=" color: #000087;">algorithm</span>=<span style=" color: #C30;">&#39;brute&#39;</span>, <span style=" color: #000087;">metric</span>=<span style=" color: #C30;">&#39;euclidean&#39;</span>).<span style=" color: #000087;">fit</span>(<span style=" color: #000087;">feature_list</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">distances</span>, <span style=" color: #000087;">indices </span>= <span style=" color: #000087;">neighbors</span>.<span style=" color: #000087;">kneighbors</span>([<span style=" color: #000087;">feature_list</span>[<span style=" color: #F60;">O</span>]])</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark340">Now you have both the indices and distances of the nearest five neighbors of the very first query feature (which represents the first image). Notice the quick execution of the first step — the training step. Unlike training most machine learning models, which can take from several minutes to hours on large datasets, instantiating the nearest-neighbor model is instantaneous because at training time there isn’t much processing. This is also called </a><i>lazy learning </i>because all the processing is deferred to classification or inference time.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Now that we know the indices, let’s see the actual image behind that feature. First, we pick an image to query, located at say, index</p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;">= 0:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">matplotlib.pyplot </span>as <span style=" color: #0CF;">plt </span>import <span style=" color: #0CF;">matplotlib.image </span>as <span style=" color: #0CF;">mpimg</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">%<span style=" color: #000087;">matplotlib inline </span><span class="s60"># Show the plots as a cell within the Jupyter Notebooks</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">plt</span>.<span style=" color: #000087;">imshow</span>(<span style=" color: #000087;">mpimg</span>.<span style=" color: #000087;">imread</span>(<span style=" color: #000087;">filenames</span>[<span style=" color: #F60;">O</span>]))</p><p class="s45" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Figure 4-4 <span style=" color: #000;">shows the result.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 42pt;text-indent: 0pt;text-align: left;"><span><img width="505" height="344" alt="image" src="KerasTensorFlow2019/Image_235.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark341">Figure 4-4. The query image from the Caltech-101 dataset</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Now, let’s examine the nearest neighbors by plotting the first result.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">plt</span>.<span style=" color: #000087;">imshow</span>(<span style=" color: #000087;">mpimg</span>.<span style=" color: #000087;">imread</span>(<span style=" color: #000087;">filenames</span>[<span style=" color: #000087;">indices</span>[<span style=" color: #F60;">O</span>]]))</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Figure 4-5 <span style=" color: #000;">shows that result.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 42pt;text-indent: 0pt;text-align: left;"><span><img width="505" height="344" alt="image" src="KerasTensorFlow2019/Image_236.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark342">Figure 4-5. The nearest neighbor to our query image</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Wait, isn’t that a duplicate? Actually, the nearest index will be the image itself because that is what is being queried:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 45pt;text-indent: -23pt;text-align: left;"><span class="s54">for </span><span style=" color: #000087;">i </span><b>in </b><span style=" color: #366;">range</span>(<span style=" color: #F60;">5</span>): <span style=" color: #366;">print</span>(<span style=" color: #000087;">distances</span>[<span style=" color: #F60;">O</span>][<span style=" color: #000087;">i</span>])</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">O.O O.8285478 O.849847 O.8529O18</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">This is also confirmed by the fact that the distance of the first result is zero. Now let’s plot the real first nearest neighbor:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">plt.imshow(mpimg.imread(filenames[indices[1]]))</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark343" class="s63">Take a look at the result this time in </a>Figure 4-6<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 42pt;text-indent: 0pt;text-align: left;"><span><img width="505" height="344" alt="image" src="KerasTensorFlow2019/Image_237.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark343">Figure 4-6. The second nearest neighbor of the queried image</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">This definitely looks like a similar image. It captured a similar concept, has the same image category (faces), same gender, and similar background with pillars and vegetation. In fact, it’s the same person!</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 114%;text-align: left;">We would probably use this functionality regularly, so we have already built a helper function <span class="s47">plot_images() </span>that visualizes several query images with their nearest neighbors. Now let’s call this function to visualize the nearest neighbors of six random images.</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 16pt;text-align: left;">Also, note that every time you run the following piece of code, the</p><p class="s45" style="padding-top: 1pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark344" class="s63">displayed images will be different (</a>Figure 4-7<span style=" color: #000;">) because the displayed images are indexed by a random integer.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">for </span><span style=" color: #000087;">i </span><b>in </b><span style=" color: #366;">range</span>(<span style=" color: #F60;">6</span>):</p><p class="s53" style="padding-left: 45pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">random_image_index </span>= <span style=" color: #000087;">random</span>.<span style=" color: #000087;">randint</span>(<span style=" color: #F60;">O</span>,<span style=" color: #000087;">num_images</span>) <span style=" color: #000087;">distances</span>, <span style=" color: #000087;">indices </span>=</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">neighbors<span style=" color: #000;">.</span>kneighbors<span style=" color: #000;">([</span>featureList<span style=" color: #000;">[</span>random_image_index<span style=" color: #000;">]])</span></p><p class="s60" style="padding-left: 45pt;text-indent: 0pt;text-align: left;"># don&#39;t take the first closest image as it will be the same image</p><p class="s56" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">similar_image_paths <span style=" color: #000;">= [</span>filenames<span style=" color: #000;">[</span>random_image_index<span style=" color: #000;">]] +</span></p><p class="s53" style="padding-left: 176pt;text-indent: 0pt;text-align: left;">[<span style=" color: #000087;">filenames</span>[<span style=" color: #000087;">indices</span>[<span style=" color: #F60;">O</span>][<span style=" color: #000087;">i</span>]] <span class="s54">for </span><span style=" color: #000087;">i </span><b>in</b></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #366;">range</span>(<span style=" color: #F60;">1</span>,<span style=" color: #F60;">4</span>)]</p><p class="s53" style="padding-left: 45pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">plot_images</span>(<span style=" color: #000087;">similar_image_paths</span>, <span style=" color: #000087;">distances</span>[<span style=" color: #F60;">O</span>])</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="599" height="739" alt="image" src="KerasTensorFlow2019/Image_238.jpg"/></span></p><p class="s50" style="padding-top: 5pt;padding-left: 10pt;text-indent: 0pt;text-align: left;"><a name="bookmark344">Figure 4-7. Nearest neighbor for different images returns similar-looking images</a><a name="bookmark345">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark301">Visualizing Image Clusters with t-SNE</a><a name="bookmark346">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark347">Let’s step up the game by visualizing the entire dataset!</a></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">To do this, we need to reduce the dimensions of the feature vectors because it’s not possible to plot a 2,048-dimension vector (the feature-length) in two dimensions (the paper). The t-distributed stochastic neighbor embedding (t-SNE) algorithm reduces the</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">high-dimensional feature vector to 2D, providing a bird’s-eye view of the dataset, which is helpful in recognizing clusters and nearby images. t-SNE is difficult to scale to large datasets, so it is a good idea to reduce the dimensionality using Principal Component Analysis (PCA) and then call t-SNE:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Perform PCA over the features</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">num_feature_dimensions<span style=" color: #000;">=</span><span style=" color: #F60;">1OO </span><span class="s60"># Set the number of features </span>pca <span style=" color: #000;">= </span>PCA<span style=" color: #000;">(</span>n_components <span style=" color: #000;">= </span>num_feature_dimensions<span style=" color: #000;">) </span>pca<span style=" color: #000;">.</span>fit<span style=" color: #000;">(</span>featureList<span style=" color: #000;">)</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">feature_list_compressed <span style=" color: #000;">= </span>pca<span style=" color: #000;">.</span>transform<span style=" color: #000;">(</span>featureList<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># For speed and clarity, we&#39;ll analyze about first half of the dataset.</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">selected_features </span>= <span style=" color: #000087;">feature_list_compressed</span>[:<span style=" color: #F60;">4OOO</span>] <span style=" color: #000087;">selected_class_ids </span>= <span style=" color: #000087;">class_ids</span>[:<span style=" color: #F60;">4OOO</span>] <span style=" color: #000087;">selected_filenames </span>= <span style=" color: #000087;">filenames</span>[:<span style=" color: #F60;">4OOO</span>]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">tsne_results </span>= <span style=" color: #000087;">TSNE</span>(<span style=" color: #000087;">n_components</span>=<span style=" color: #F60;">2</span>,<span style=" color: #000087;">verbose</span>=<span style=" color: #F60;">1</span>,<span style=" color: #000087;">metric</span>=<span style=" color: #C30;">&#39;euclidean&#39;</span>)</p><p class="s53" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">.<span style=" color: #000087;">fit_transform</span>(<span style=" color: #000087;">selected_features</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Plot a scatter plot from the generated t-SNE results</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">colormap </span>= <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">cm</span>.<span style=" color: #000087;">get_cmap</span>(<span style=" color: #C30;">&#39;coolwarm&#39;</span>)</p><p class="s53" style="padding-left: 110pt;text-indent: -89pt;text-align: left;"><span style=" color: #000087;">scatter_plot </span>= <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">scatter</span>(<span style=" color: #000087;">tsne_results</span>[:,<span style=" color: #F60;">O</span>],<span style=" color: #000087;">tsne_results</span>[:,<span style=" color: #F60;">1</span>], <span style=" color: #000087;">c </span>= <span style=" color: #000087;">selected_class_ids</span>, <span style=" color: #000087;">cmap</span>=<span style=" color: #000087;">colormap</span>)</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">plt<span style=" color: #000;">.</span>colorbar<span style=" color: #000;">(</span>scatter_plot<span style=" color: #000;">) </span>plt<span style=" color: #000;">.</span>show<span style=" color: #000;">()</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark348">We discuss PCA in more detail in later sections. In order to scale to larger dimensions, use Uniform Manifold Approximation and Projection (UMAP).</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Figure 4-8 <span style=" color: #000;">shows clusters of similar classes, and how they are spread close to one another.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 13pt;text-indent: 0pt;text-align: left;"><span><img width="590" height="457" alt="image" src="KerasTensorFlow2019/Image_239.jpg"/></span></p><p class="s50" style="padding-top: 8pt;padding-left: 103pt;text-indent: -82pt;line-height: 108%;text-align: left;"><a name="bookmark349">Figure 4-8. t-SNE visualizing clusters of image features, where each cluster represents one object class in the same color</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 114%;text-align: left;"><a href="#bookmark349" class="s63">Each color in </a>Figure 4-8 <span style=" color: #000;">indicates a different class. To make it even more clear, we can use another helper function, </span><span class="s47">plot_images_in_2d()</span><a href="#bookmark350" class="s63">, to plot the images in these clusters, as demonstrated in </a><a href="#bookmark350" class="s44">Figure </a>4-9<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 10pt;text-indent: 0pt;text-align: left;"><span><img width="586" height="582" alt="image" src="KerasTensorFlow2019/Image_240.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 192pt;text-indent: -184pt;line-height: 108%;text-align: left;"><a name="bookmark350">Figure 4-9. t-SNE visualization showing image clusters; similar images are in the same cluster</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;"><a href="#bookmark350" class="s63">Neat! There is a clearly demarcated cluster of human faces, flowers, vintage cars, ships, bikes, and a somewhat spread-out cluster of land and marine animals. There are lots of images on top of one another, which makes </a>Figure 4-9 <span style=" color: #000;">a tad bit confusing, so let’s try to plot the t-SNE as clear tiles with the helper function </span><span class="s47">tsne_to_grid_plotter_manual()</span><a href="#bookmark351" class="s63">, the results of which you can see in </a><a href="#bookmark351" class="s44">Figure </a>4-10<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 2pt;text-indent: 0pt;text-align: center;"><span style=" color: #000087;">tsne_to_grid_plotter_manual</span>(<span style=" color: #000087;">tsne_results</span>[:,<span style=" color: #F60;">O</span>], <span style=" color: #000087;">tsne_results</span>[:,<span style=" color: #F60;">1</span>],</p><p class="s56" style="padding-left: 52pt;text-indent: 0pt;text-align: center;">selected_filenames<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 12pt;text-indent: 0pt;text-align: left;"><span><img width="568" height="557" alt="image" src="KerasTensorFlow2019/Image_241.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 204pt;text-indent: -181pt;line-height: 108%;text-align: left;"><a name="bookmark351">Figure 4-10. t-SNE visualization with tiled images; similar images are close together</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">This is definitely much clearer. We can see similar images are colocated within the clusters of human faces, chairs, bikes, airplanes, ships, laptops, animals, watches, flowers, tilted minarets, vintage cars, anchor signs, and cameras, all close to their own kind. Birds of a feather indeed do flock together!</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="308" alt="image" src="KerasTensorFlow2019/Image_242.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="284" alt="image" src="KerasTensorFlow2019/Image_243.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s79" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="https://projector.tensorflow.org/" class="s140" target="_blank">2D clusters are great, but visualizing them in 3D would look stellar. It would be even better if they could be rotated, zoomed in and out, and manipulated using the mouse without any coding. And bonus points if the data could be searched interactively, revealing its neighbors. The </a><a href="https://projector.tensorflow.org/" class="s64" target="_blank">TensorFlow Embedding projector</a> <a href="#bookmark352" class="s140">does all this and more in a browser- based GUI tool. The preloaded embeddings from image and text datasets are helpful in getting a better intuition of the power of embeddings. And, as </a><a href="#bookmark352" class="s64">Figure </a>4-11 <span style=" color: #000;">shows, it’s reassuring to see deep learning figure out that John Lennon, Led Zeppelin, and Eric Clapton happen to be used in a similar context to the Beatles in the English language.</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s50" style="padding-top: 4pt;padding-left: 25pt;text-indent: -10pt;line-height: 108%;text-align: left;"><a name="bookmark352">Figure 4-11. TensorFlow Embedding projector showing a 3D representation of 10,000 common English words and highlighting words related to “Beatles”</a><a name="bookmark353">&zwnj;</a><a name="bookmark354">&zwnj;</a><a name="bookmark355">&zwnj;</a><a name="bookmark356">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark302">Improving the Speed of Similarity Search</a><a name="bookmark357">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark358">There are several opportunities to improve the speed of the similarity search step. For similarity search, we can make use of two strategies: either reduce the feature-length, or use a better algorithm to search among the features. Let’s examine each of these strategies individually.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark303">Length of Feature Vectors</a><a name="bookmark359">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark362" class="s63" name="bookmark360">Ideally, we would expect that the smaller the amount of data in which to search, the faster the search should be. Recall that the ResNet-50 model gives 2,048 features. With each feature being a 32-bit floating-point, each image is represented by an 8 KB feature vector. For a million images, that equates to nearly 8 GB. Imagine how slow it would be to search among 8 GB worth of features. To give us a better picture of our scenario, </a>Table 4-1 <span style=" color: #000;">gives the feature- lengths that we get from different models.</span><a name="bookmark361">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s43" style="padding-left: 185pt;text-indent: -154pt;text-align: left;"><a name="bookmark362">Table 4-1. Top 1% accuracy and feature-lengths for different CNN models</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:19.8026pt" cellspacing="0"><tr style="height:21pt"><td style="width:73pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Model</p></td><td style="width:156pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Bottleneck feature-length</p></td><td style="width:187pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Top-1% accuracy on ImageNet</p></td></tr><tr style="height:21pt"><td style="width:73pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">VGG16</p></td><td style="width:156pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">512</p></td><td style="width:187pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">71.5%</p></td></tr><tr style="height:21pt"><td style="width:73pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">VGG19</p></td><td style="width:156pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">512</p></td><td style="width:187pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">72.7%</p></td></tr><tr style="height:21pt"><td style="width:73pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">MobileNet</p></td><td style="width:156pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">1024</p></td><td style="width:187pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">66.5%</p></td></tr><tr style="height:21pt"><td style="width:73pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">InceptionV3</p></td><td style="width:156pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2048</p></td><td style="width:187pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">78.8%</p></td></tr><tr style="height:21pt"><td style="width:73pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">ResNet-50</p></td><td style="width:156pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2048</p></td><td style="width:187pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">75.9%</p></td></tr><tr style="height:21pt"><td style="width:73pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Xception</p></td><td style="width:156pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2048</p></td><td style="width:187pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">79.0%</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="383" alt="image" src="KerasTensorFlow2019/Image_244.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Under the hood, many models available in <span class="s53">tf.keras.applications </span>yield several thousand features. For example, InceptionV3 yields features in the shape of 1 x 5 x 5 x 2048, which translates to 2,048 feature maps of 5 x 5 convolutions, resulting in a total of 51,200 features. Hence, it becomes essential to reduce this large vector by using an average or max-pooling layer. The pooling layer will condense each convolution (e.g., 5 x 5 layer) into a single value. This can be defined during model instantiation as follows:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 21pt;text-indent: 0pt;line-height: 108%;text-align: left;"><span style=" color: #000087;">model </span>= <span style=" color: #000087;">InceptionV3</span>(<span style=" color: #000087;">weights</span>=<span style=" color: #C30;">&#39;imagenet&#39;</span>, <span style=" color: #000087;">include_top</span>=<span class="s77">False</span>, <span style=" color: #000087;">input_shape </span>= (<span style=" color: #F60;">224</span>,<span style=" color: #F60;">224</span>,<span style=" color: #F60;">3</span>), <span style=" color: #000087;">pooling</span>=<span style=" color: #C30;">&#39;max&#39;</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s79" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark363" class="s140">For models that yield a large number of features, you will usually find that all code examples make use of this pooling option. </a><a href="#bookmark363" class="s64">Table </a>4-2 <span style=" color: #000;">shows the before and after effect of max pooling on the number of features in different models.</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s43" style="padding-top: 4pt;padding-left: 164pt;text-indent: -115pt;text-align: left;"><a name="bookmark363">Table 4-2. Number of features before and after pooling for different models</a><a name="bookmark364">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:41.3141pt" cellspacing="0"><tr style="height:21pt"><td style="width:73pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Model</p></td><td style="width:155pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;"># features before pooling</p></td><td style="width:144pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;"># features after pooling</p></td></tr><tr style="height:21pt"><td style="width:73pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">ResNet-50</p></td><td style="width:155pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">[1,1,1,2048] = 2048</p></td><td style="width:144pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2048</p></td></tr><tr style="height:21pt"><td style="width:73pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">InceptionV3</p></td><td style="width:155pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">[1,5,5,2048] = 51200</p></td><td style="width:144pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2048</p></td></tr><tr style="height:21pt"><td style="width:73pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">MobileNet</p></td><td style="width:155pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">[1,7,7,1024] = 50176</p></td><td style="width:144pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">1024</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">As we can see, almost all the models generate a large number of features. Imagine how much faster the search would be if we could reduce to a mere 100 features (a whopping reduction of 10 to 20 times!) without compromising the quality of the results. Apart from just the size, this is an even bigger improvement for big data scenarios, for which the data can be loaded into RAM all at once instead of periodically loading parts of it, thus giving an even bigger speedup. PCA will help us make this happen.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark304">Reducing Feature-Length with PCA</a><a name="bookmark365">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark366">PCA is a statistical procedure that questions whether features representing the data are equally important. Are some of the features redundant enough that we can get similar classification results even after removing those features? PCA is considered one of the go-to techniques for dimensionality reduction. Note that it does not eliminate redundant features; rather, it generates a new set of features that are a linear combination of the input features.</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">These linear features are orthogonal to one another, which is why all the redundant features are absent. These features are known as <i>principal components.</i></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;">Performing PCA is pretty simple. Using the <span class="s47">scikit-learn </span>library, execute the following:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">sklearn.decomposition.PCA </span>as <span style=" color: #0CF;">PCA</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">num_feature_dimensions<span style=" color: #000;">=</span><span style=" color: #F60;">1OO</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">pca <span style=" color: #000;">= </span>PCA<span style=" color: #000;">(</span>n_components <span style=" color: #000;">= </span>num_feature_dimensions<span style=" color: #000;">) </span>pca<span style=" color: #000;">.</span>fit<span style=" color: #000;">(</span>feature_list<span style=" color: #000;">)</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">feature_list_compressed <span style=" color: #000;">= </span>pca<span style=" color: #000;">.</span>transform<span style=" color: #000;">(</span>feature_list<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">PCA can also tell us the relative importance of each feature. The very first dimension has the most variance and the variance keeps on decreasing as we go on:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Explain the importance of first 20 features</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #366;">print</span>(<span style=" color: #000087;">pca</span>.<span style=" color: #000087;">explained_variance_ratio_</span>[<span style=" color: #F60;">O</span>:<span style=" color: #F60;">2O</span>])</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-top: 6pt;padding-left: 33pt;text-indent: -11pt;text-align: left;">[ O.O732OO23 O.O5273142 O.O431O822 O.O3494248 O.O2166119 O.O2O5O37 O.O1974325 O.O1739547 O.O1611573 O.O1548918 O.O145O421</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">O.O1311OO5</p><p class="s53" style="padding-left: 21pt;text-indent: 11pt;text-align: left;">O.O12OO541 O.O113O84 O.O11O3872 O.OO99O4O5 O.OO973481 O.OO929487</p><p class="s53" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">O.OO915592 O.OO89256 ]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Hmm, why did we pick 100 dimensions from the original 2,048? Why not 200? PCA is representing our original feature vector but in reduced dimensions. Each new dimension has diminishing returns in representing the original vector (i.e., the new dimension might not explain the data much) and takes up valuable space. We can balance between how well the original data is explained versus</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">how much we want to reduce it. Let’s visualize the importance of say the first 200 dimensions.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">pca </span>= <span style=" color: #000087;">PCA</span>(<span style=" color: #F60;">2OO</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">pca</span>.<span style=" color: #000087;">fit</span>(<span style=" color: #000087;">feature_list</span>) <span style=" color: #000087;">matplotlib</span>.<span style=" color: #000087;">style</span>.<span style=" color: #000087;">use</span>(<span style=" color: #C30;">&#39;seaborn&#39;</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">plt</span>.<span style=" color: #000087;">plot</span>(<span style=" color: #366;">range</span>(<span style=" color: #F60;">1</span>,<span style=" color: #F60;">2O1</span>),<span style=" color: #000087;">pca</span>.<span style=" color: #000087;">explained_variance_ratio_</span>,<span style=" color: #C30;">&#39;o--&#39;</span>, <span style=" color: #000087;">markersize</span>=<span style=" color: #F60;">4</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">plt</span>.<span style=" color: #000087;">title </span>(<span style=" color: #C30;">&#39;Variance for each PCA dimension&#39;</span>) <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">xlabel</span>(<span style=" color: #C30;">&#39;PCA Dimensions&#39;</span>) <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">ylabel</span>(<span style=" color: #C30;">&#39;Variance&#39;</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">plt</span>.<span style=" color: #000087;">grid</span>(<span class="s54">True</span>) <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">show</span>()</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Figure 4-12 <span style=" color: #000;">presents the results.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 10pt;text-indent: 0pt;text-align: left;"><span><img width="581" height="403" alt="image" src="KerasTensorFlow2019/Image_245.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark367">Figure 4-12. Variance for each PCA dimension</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The individual variance will tell us how important the newly added features are. For example, after the first 100 dimensions, the additional dimensions don’t add much variance (almost equal to 0) and can be neglected. Without even checking the accuracy it is safe to assume that the PCA with 100 dimensions will be a robust</p><p class="s45" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark368" class="s63">model. Another way to look at this is to visualize how much of the original data is explained by the limited number of features by finding the cumulative variance (see </a>Figure 4-13<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">plt</span>.<span style=" color: #000087;">plot</span>(<span style=" color: #366;">range</span>(<span style=" color: #F60;">1</span>,<span style=" color: #F60;">2O1</span>),<span style=" color: #000087;">pca</span>.<span style=" color: #000087;">explained_variance_ratio_</span>.<span style=" color: #000087;">cumsum</span>(),<span style=" color: #C30;">&#39;o--&#39;</span>, <span style=" color: #000087;">markersize</span>=<span style=" color: #F60;">4</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">plt</span>.<span style=" color: #000087;">title </span>(<span style=" color: #C30;">&#39;Cumulative Variance with each PCA dimension&#39;</span>) <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">xlabel</span>(<span style=" color: #C30;">&#39;PCA Dimensions&#39;</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">plt</span>.<span style=" color: #000087;">ylabel</span>(<span style=" color: #C30;">&#39;Variance&#39;</span>) <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">grid</span>(<span class="s54">True</span>) <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">show</span>()</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 10pt;text-indent: 0pt;text-align: left;"><span><img width="581" height="403" alt="image" src="KerasTensorFlow2019/Image_246.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark368">Figure 4-13. Cumulative variance with each PCA dimension</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;">As expected, adding 100 dimensions (from 100 to 200) adds only</p><p style="padding-top: 1pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">0.1 variance and begins to gradually plateau. For reference, using the full 2,048 features would result in a cumulative variance of 1.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The number of dimensions in PCA is an important parameter that we can tune to the problem at hand. One way to directly justify a good threshold is to find a good balance between the number of features and its effect on accuracy versus speed:</p><p class="s53" style="padding-top: 4pt;padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">pca_dimensions </span>= [<span style=" color: #F60;">1</span>,<span style=" color: #F60;">2</span>,<span style=" color: #F60;">3</span>,<span style=" color: #F60;">4</span>,<span style=" color: #F60;">5</span>,<span style=" color: #F60;">1O</span>,<span style=" color: #F60;">2O</span>,<span style=" color: #F60;">5O</span>,<span style=" color: #F60;">75</span>,<span style=" color: #F60;">1OO</span>,<span style=" color: #F60;">15O</span>,<span style=" color: #F60;">2OO</span>]</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">pca_accuracy <span style=" color: #000;">= [] </span>pca_time <span style=" color: #000;">= []</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">for </span>dimensions <span class="s71">in </span>pca_dimensions<span style=" color: #000;">:</span></p><p class="s60" style="padding-left: 45pt;text-indent: 0pt;text-align: left;"># Perform PCA</p><p class="s56" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">pca <span style=" color: #000;">= </span>PCA<span style=" color: #000;">(</span>n_components <span style=" color: #000;">= </span>dimensions<span style=" color: #000;">) </span>pca<span style=" color: #000;">.</span>fit<span style=" color: #000;">(</span>feature_list<span style=" color: #000;">)</span></p><p class="s56" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">feature_list_compressed <span style=" color: #000;">= </span>pca<span style=" color: #000;">.</span>transform<span style=" color: #000;">(</span>feature_list<span style=" color: #000;">[:]) </span><span class="s60"># Calculate accuracy over the compressed features </span>accuracy<span style=" color: #000;">, </span>time_taken <span style=" color: #000;">=</span></p><p class="s56" style="padding-left: 45pt;text-indent: -23pt;text-align: left;">accuracy_calculator<span style=" color: #000;">(</span>feature_list_compressed<span style=" color: #000;">[:]) </span>pca_time<span style=" color: #000;">.</span>append<span style=" color: #000;">(</span>time_taken<span style=" color: #000;">) </span>pca_accuracy<span style=" color: #000;">.</span>append<span style=" color: #000;">(</span>accuracy<span style=" color: #000;">)</span></p><p class="s53" style="padding-left: 21pt;text-indent: 23pt;text-align: left;"><span style=" color: #366;">print</span>(<span style=" color: #C30;">&quot;For PCA Dimensions = &quot;</span>, <span style=" color: #000087;">dimensions</span>, <span style=" color: #C30;">&quot;,</span><span class="s80">\t</span><span style=" color: #C30;">Accuracy = &quot;</span>,<span style=" color: #000087;">accuracy</span>,<span style=" color: #C30;">&quot;%&quot;</span>,</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #C30;">&quot;,</span><span class="s80">\t</span><span style=" color: #C30;">Time = &quot;</span>, <span style=" color: #000087;">pca_time</span>[-<span style=" color: #F60;">1</span>])</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark369" class="s63">We visualize these results using the graph in </a>Figure 4-14 <span style=" color: #000;">and see that after a certain number of dimensions an increase in dimensions does not lead to higher accuracy:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">plt</span>.<span style=" color: #000087;">plot</span>(<span style=" color: #000087;">pca_time</span>, <span style=" color: #000087;">pca_accuracy</span>,<span style=" color: #C30;">&#39;o--&#39;</span>, <span style=" color: #000087;">markersize</span>=<span style=" color: #F60;">4</span>)</p><p class="s53" style="padding-left: 45pt;text-indent: -23pt;text-align: left;"><span class="s54">for </span><span style=" color: #000087;">label</span>, <span style=" color: #000087;">x</span>, <span style=" color: #000087;">y </span><b>in </b><span style=" color: #366;">zip</span>(<span style=" color: #000087;">pca_dimensions</span>, <span style=" color: #000087;">pca_time</span>,<span style=" color: #000087;">pca_accuracy</span>): <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">annotate</span>(<span style=" color: #000087;">label</span>, <span style=" color: #000087;">xy</span>=(<span style=" color: #000087;">x</span>, <span style=" color: #000087;">y</span>), <span style=" color: #000087;">ha</span>=<span style=" color: #C30;">&#39;right&#39;</span>, <span style=" color: #000087;">va</span>=<span style=" color: #C30;">&#39;bottom&#39;</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">plt</span>.<span style=" color: #000087;">title </span>(<span style=" color: #C30;">&#39;Test Time vs Accuracy for each PCA dimension&#39;</span>) <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">xlabel</span>(<span style=" color: #C30;">&#39;Test Time&#39;</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">plt</span>.<span style=" color: #000087;">ylabel</span>(<span style=" color: #C30;">&#39;Accuracy&#39;</span>) <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">grid</span>(<span class="s54">True</span>) <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">show</span>()</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 11pt;text-indent: 0pt;text-align: left;"><span><img width="577" height="409" alt="image" src="KerasTensorFlow2019/Image_247.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark369">Figure 4-14. Test time versus accuracy for each PCA dimension</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">As is visible in the graph, there is little improvement in accuracy after increasing beyond a feature-length of 100 dimensions. With almost 20 times fewer dimensions (100) than the original (2,048), this offers drastically higher speed and less time on almost any search algorithm, while achieving similar (and sometimes slightly better) accuracy. Hence, 100 would be an ideal feature-length for this dataset. This also means that the first 100 dimensions contain the most information about the dataset.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark370">There are a number of benefits to using this reduced representation, like efficient use of computational resources, noise removal, better generalization due to fewer dimensions, and improved performance for machine learning algorithms learning on this data. By reducing the distance calculation to the most important features, we can also improve the result accuracy slightly. This is because previously all the 2,048 features were contributing equally in the distance calculation, whereas now, only</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">the most important 100 features get their say. But, more importantly, it saves us from the <i>curse of dimensionality</i>. It’s observed that as the number of dimensions increases, the ratio of the Euclidean distance between the two closest points and the two furthest points tends to become 1. In very high-dimensional space, the majority of points from a real-world dataset seem to be a similar distance away from one another, and the Euclidean distance metric begins to fail in discerning similar versus dissimilar items. PCA helps bring sanity back.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark371">You can also experiment with different distances like Minkowski distance, Manhattan distance, Jaccardian distance, and weighted Euclidean distance (where the weight is the contribution of each feature as explained in </a><span class="s47">pca.explained_variance_ratio_</span>).</p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark372">Now, let’s turn our minds toward using this reduced set of features to make our search even faster.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark305">Scaling Similarity Search with Approximate Nearest Neighbors</a><a name="bookmark373">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark374">What do we want? Nearest neighbors. What is our baseline? Brute-force search. Although convenient to implement in two lines, it goes over each element and hence scales linearly with data size (number of items as well as the number of dimensions). Having PCA take our feature vector from a length of 2,048 to 100 will not only yield a 20-times reduction in data size, but also result in an increase in speed of 20 times when using brute force. PCA does pay off!</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Let’s assume similarity searching a small collection of 10,000 images, now represented with 100 feature-length vectors, takes approximately 1 ms. Even though this looks fast for 10,000 items, in a real production system with larger data, perhaps 10 million items, this will take more than a second to search. Our system might not be able to fulfill more than one query per second per CPU core. If you receive 100 requests per second from users, even running on multiple CPU cores of the machine (and loading the search index per thread), you would need multiple machines to be able to serve the traffic. In other words, an inefficient algorithm means money, lots of money, spent on hardware.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Brute force is our baseline for every comparison. As in most algorithmic approaches, brute force is the slowest approach. Now that we have our baseline set, we will explore approximate nearest-neighbor algorithms. Instead of guaranteeing the correct result as with the brute-force approach, approximation algorithms <i>generally </i>get the correct result because they are...well,</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">approximations. Most of the algorithms offer some form of tuning to balance between correctness and speed. It is possible to evaluate the quality of the results by comparing against the results of the brute-force baseline.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark306">Approximate Nearest-Neighbor Benchmark</a><a name="bookmark375">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://ann-benchmarks.com/" class="s63" target="_blank" name="bookmark376">There are several approximate nearest-neighbor (ANN) libraries out there, including well-known ones like Spotify’s Annoy, FLANN, Facebook’s Faiss, Yahoo’s NGT, and NMSLIB. Benchmarking each of them would be a tedious task (assuming you get past installing some of them). Luckily, the good folks at </a><a href="http://ann-benchmarks.com/" class="s46" target="_blank">ann- benchmarks.com </a><a href="#bookmark377" class="s63">(Martin Aumueller, Erik Bernhardsson, and Alec Faitfull) have done the legwork for us in the form of reproducible benchmarks on 19 libraries on large public datasets. We’ll pick the comparisons on a dataset of feature embeddings representing words (instead of images) called GloVe. This 350 MB dataset consists of 400,000 feature vectors representing words in 100 dimensions. </a><span style=" color: #8E0012;">Figure 4-15 </span>showcases their raw performance when tuned for correctness. Performance is measured in the library’s ability to respond to queries each second. Recall that a measure of correctness is the fraction of top-<i>n </i>closest items returned with respect to the real top-<i>n </i>closest items. This ground truth is measured by brute-force search.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span><img width="566" height="386" alt="image" src="KerasTensorFlow2019/Image_248.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s198" style="padding-top: 4pt;padding-left: 21pt;text-indent: 0pt;text-align: left;"><a href="http://ann-benchmarks.com/" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12pt;" target="_blank" name="bookmark377">Figure 4-15. Comparison of ANN libraries (data from </a>ann-benchmarks.com<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The strongest performers on this dataset return close to several thousand queries per second at the acceptable 0.8 recall. To put this in perspective, our brute-force search performs under 1 query per second. At the fastest, some of these libraries (like NGT) can return north of 15,000 results per second (albeit at a low recall, making it impractical for usage).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark307">Which Library Should I Use?</a><a name="bookmark378">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">It goes without saying that the library you use will end up depending heavily on your scenario. Each library presents a trade- off between search speed, accuracy, size of index, memory consumption, hardware use (CPU/GPU), and ease of setup.</p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Table 4-3 <span style=" color: #000;">presents a synopsis of different scenarios and recommendations as to which library might be work best for each scenario.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s43" style="padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark379">Table 4-3. ANN library recommendations</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="581" height="1" alt="image" src="KerasTensorFlow2019/Image_249.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="1" alt="image" src="KerasTensorFlow2019/Image_250.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-left: 8pt;text-indent: 0pt;text-align: center;">Scenario                                                                               Recommendation</p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="50" alt="image" src="KerasTensorFlow2019/Image_251.png"/></span></p><p class="s49" style="text-indent: 0pt;line-height: 14pt;text-align: left;">Use NGT</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="text-indent: 0pt;line-height: 108%;text-align: left;">I have a large dataset (up to 10 million entries or several thousand dimensions) and care utmost about speed.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="padding-top: 7pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">I want to experiment quickly in Python without too much setup but I also care about fast speed.</p><p class="s49" style="padding-top: 7pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">Use Annoy or NMSLIB</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="89" alt="image" src="KerasTensorFlow2019/Image_252.png"/></span></p><p class="s49" style="padding-top: 2pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">I have a ridiculously large dataset (100 million-plus entries) and have a cluster of GPUs, too.</p><p class="s49" style="padding-top: 6pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">I want to set a ground-truth baseline with 100% correctness. Then immediately move to a faster library, impress my boss with the orders of magnitude speedup, and get a bonus.</p><p class="s49" style="padding-top: 2pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Use Faiss</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s49" style="padding-left: 5pt;text-indent: 0pt;line-height: 108%;text-align: left;">Use brute-force approach</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s63" target="_blank" name="bookmark380">We offer much more detailed examples in code of several libraries on the book’s GitHub website (see </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">http://PracticalDeepLearning.ai</span>), but for our purposes here, we’ll showcase our go-to library, Annoy, in detail and compare it with brute-force search on a synthetic dataset. Additionally, we briefly touch on Faiss and NGT.<a name="bookmark381">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark308">Creating a Synthetic Dataset</a><a name="bookmark382">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">To make an apples-to-apples comparison between different libraries, we first create a million-item dataset composed of random floating-point values with mean 0 and variance 1. Additionally, we pick a random feature vector as our query to find the nearest neighbors:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">num_items <span style=" color: #000;">= </span><span style=" color: #F60;">1OOOOOO </span>num_dimensions <span style=" color: #000;">= </span><span style=" color: #F60;">1OO</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">dataset </span>= <span style=" color: #000087;">np</span>.<span style=" color: #000087;">random</span>.<span style=" color: #000087;">randn</span>(<span style=" color: #000087;">num_items</span>, <span style=" color: #000087;">num_dimensions</span>) <span style=" color: #000087;">dataset </span>/= <span style=" color: #000087;">np</span>.<span style=" color: #000087;">linalg</span>.<span style=" color: #000087;">norm</span>(<span style=" color: #000087;">dataset</span>, <span style=" color: #000087;">axis</span>=<span style=" color: #F60;">1</span>).<span style=" color: #000087;">reshape</span>(-<span style=" color: #F60;">1</span>, <span style=" color: #F60;">1</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">random_index </span>= <span style=" color: #000087;">random</span>.<span style=" color: #000087;">randint</span>(<span style=" color: #F60;">O</span>,<span style=" color: #000087;">num_items</span>) <span style=" color: #000087;">query </span>= <span style=" color: #000087;">dataset</span>[<span style=" color: #000087;">random_index</span>]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark309">Brute Force</a><a name="bookmark383">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;"><a name="bookmark384">First, we calculate the time for searching with the brute-force algorithm. It goes through the entire data serially, calculating the distance between the query and current item one at a time. We use the </a><span class="s47">timeit </span>command for calculating the time. First, we create the search index to retrieve the five nearest neighbors and then search with a query:<a name="bookmark385">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">neighbors </span>= <span style=" color: #000087;">NearestNeighbors</span>(<span style=" color: #000087;">n_neighbors</span>=<span style=" color: #F60;">5</span>, <span style=" color: #000087;">algorithm</span>=<span style=" color: #C30;">&#39;brute&#39;</span>, <span style=" color: #000087;">metric</span>=<span style=" color: #C30;">&#39;euclidean&#39;</span>).<span style=" color: #000087;">fit</span>(<span style=" color: #000087;">dataset</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">%<span style=" color: #000087;">timeit distances</span>, <span style=" color: #000087;">indices </span>= <span style=" color: #000087;">neighbors</span>.<span style=" color: #000087;">kneighbors</span>([<span style=" color: #000087;">query</span>])</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="229" alt="image" src="KerasTensorFlow2019/Image_253.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 110%;text-align: left;">The <span class="s53">timeit </span>command is a handy tool. To benchmark the time of a single operation, prefix it with this command. Compared to the time command, which runs a statement for one time, <span class="s53">timeit </span>runs the subsequent line multiple times to give more precise aggregated statistics along with the standard deviation. By default, it turns off garbage collection, making independent timings more comparable. That said, this might not reflect timings in real production loads where garbage collection is turned on.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s53" style="padding-top: 6pt;padding-left: 21pt;text-indent: 0pt;text-align: left;">&gt; 177 ms ± 136 μs per loop (mean ± std. dev. of 7 runs, 1OOO loops each)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark310">Annoy</a><a name="bookmark386">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark387">Annoy </a><span style=" color: #000;">(Approximate Nearest Neighbors Oh Yeah) is a C++ library with Python bindings for searching nearest neighbors.</span></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Synonymous with speed, it was released by Spotify and is used in production to serve its music recommendations. In contrast to its name, it’s actually fun and easy to use.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">To use Annoy, we install it using <span class="s47">pip</span>:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ pip install annoy</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">It’s fairly straightforward to use. First, we build a search index with two hyperparameters: the number of dimensions of the dataset and the number of trees:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">annoy </span>import <span class="s56">AnnoyIndex</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">annoy_index <span style=" color: #000;">= </span>AnnoyIndex<span style=" color: #000;">(</span>num_dimensions<span style=" color: #000;">) </span><span class="s60"># Length of item vector that will be</span></p><p class="s81" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">indexed</p><p class="s56" style="padding-left: 45pt;text-indent: -23pt;text-align: left;"><span class="s54">for </span>i <span class="s71">in </span><span style=" color: #366;">range</span><span style=" color: #000;">(</span>num_items<span style=" color: #000;">): </span>annoy_index<span style=" color: #000;">.</span>add_item<span style=" color: #000;">(</span>i<span style=" color: #000;">, </span>dataset<span style=" color: #000;">[</span>i<span style=" color: #000;">])</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">annoy_index</span>.<span style=" color: #000087;">build</span>(<span style=" color: #F60;">4O</span>) <span class="s60"># 40 trees</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Now let’s find out the time it takes to search the five nearest neighbors of one image:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">%<span style=" color: #000087;">timeit indexes</span>=<span style=" color: #000087;">t</span>.<span style=" color: #000087;">get_nns_by_vector</span>(<span style=" color: #000087;">query</span>, <span style=" color: #F60;">5</span>, <span style=" color: #000087;">include_distances</span>=<span class="s54">True</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-top: 6pt;padding-left: 21pt;text-indent: 0pt;text-align: left;">&gt; 34.9 μs ± 165 ns per loop (mean ± std. dev. of 7 runs, 1OOOO loops each)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Now that is blazing fast! To put this in perspective, even for our million-item dataset, this can serve almost 28,000 requests on a single CPU core. Considering most CPUs have multiple cores, it should be able to handle more than 100,000 requests on a single system. The best part is that it lets you share the same index in memory between multiple processes. Thus, the biggest index can be equivalent to the size of your overall RAM, making it possible to serve multiple requests on a single system.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="126" alt="image" src="KerasTensorFlow2019/Image_254.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Wondering about how many trees to use? More trees give higher precision, but larger indexes. Usually, no more than 50 trees are required to attain the highest precision.</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Other benefits include that it generates a modestly sized index. Moreover, it decouples creating indexes from loading them, so you can create an index on one machine, pass it around, and then on your serving machine load it in memory and serve it.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark311">NGT</a><a name="bookmark388">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark389">Yahoo Japan’s Neighborhood Graph and Tree (NGT) library currently leads most benchmarks and is best suited for large datasets (in millions of items) with large dimensions (in several thousands). Although the library has existed since 2016, its real entry into the industry benchmark scene happened in 2018 with the implementation of the ONNG algorithm (short for Optimization of indexing based on </a><i>k</i>-Nearest Neighbor Graph for proximity).</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Considering multiple threads might be running NGT on a server, it can place the index in shared memory with the help of memory mapped files, helping to reduce memory usage as well as increase load time.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark312">Faiss</a><a name="bookmark390">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark391">Faiss is Facebook’s efficient similarity search library. It can scale to billions of vectors in RAM on a single server by storing a compressed representation of the vectors (compact quantization codes) instead of the original values. It’s especially suited for dense vectors. It shines particularly on machines with GPUs by storing the index on GPU memory (VRAM). This works on both single-GPU and multi-GPU setups. It provides the ability to configure performance based on search time, accuracy, memory usage, and indexing time. It’s one of the fastest known implementations of ANN search on GPU. Hey, if it’s good enough for Facebook, it’s good enough for most of us (as long as we have enough data).</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;"><a name="bookmark392">While showing the entire process is beyond the scope of this book, we recommend installing Faiss using Anaconda or using its Docker containers to quickly get started.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark313">Improving Accuracy with Fine Tuning</a><a name="bookmark393">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark394">Many of the pretrained models were trained on the ImageNet dataset. Therefore, they provide an incredible starting point for similarity computations in most situations. That said, if you tuned these models to adapt to your specific problem, they would perform even more accurately at finding similar images.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In this portion of the chapter, we identify the worst-performing categories, visualize them with t-SNE, fine tune, and then see how their t-SNE graph changes.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">What is a good metric to check whether you are indeed getting similar images?</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Painful option 1</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;">Go through the entire dataset one image at a time, and manually score whether the returned images indeed look similar.</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Happier option 2</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;">Simply calculate accuracy. That is, for an image belonging to category <i>X</i>, are the similar images belonging to the same category? We will refer to this similarity accuracy.</p><p style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;">So, what are our worst-performing categories? And why are they the worst? To answer this, we have predefined a helper function <span class="s47">worst_classes</span>. For every image in the dataset, it finds the nearest neighbors using the brute-force algorithm and then returns six classes with the least accuracy. To see the effects of fine tuning, we run our analysis on a more difficult dataset: Caltech-256.</p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Calling this function unveils the least-accurate classes:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">names_of_worst_classes_before_finetuning<span style=" color: #000;">, </span>accuracy_per_class_before_finetuning <span style=" color: #000;">= </span>worst_classes<span style=" color: #000;">(</span>feature_list<span style=" color: #000;">[:])</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">Accuracy is 56.54</p><p class="s53" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">Top 6 incorrect classifications O59.drinking-straw Accuracy: 11.76% 135.mailbox  Accuracy: 16.O3%</p><p class="s53" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">1O8.hot-dog  Accuracy: 16.72%</p><p class="s53" style="padding-top: 4pt;padding-left: 45pt;text-indent: 0pt;text-align: left;">163.playing-card Accuracy: 17.29%</p><p class="s53" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">195.soda-can Accuracy: 19.68% 125.knife Accuracy: 2O.53%</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="217" alt="image" src="KerasTensorFlow2019/Image_255.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s79" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: justify;"><a href="https://oreil.ly/cnoiE" class="s140" target="_blank">To enhance the visibility of the graph we can define different markers and different colors for each class. Matplotlib provides a wide variety of </a>markers <a href="https://oreil.ly/Jox4B" class="s140" target="_blank">and </a>colors<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 21pt;text-indent: 0pt;line-height: 108%;text-align: left;"><span style=" color: #000087;">markers </span>= [ <span style=" color: #C30;">&quot;^&quot;</span>, <span style=" color: #C30;">&quot;.&quot;</span>,<span style=" color: #C30;">&quot;s&quot;</span>, <span style=" color: #C30;">&quot;o&quot;</span>,<span style=" color: #C30;">&quot;x&quot;</span>, <span style=" color: #C30;">&quot;P&quot; </span>] <span style=" color: #000087;">colors </span>= [<span style=" color: #C30;">&#39;red&#39;</span>, <span style=" color: #C30;">&#39;blue&#39;</span>, <span style=" color: #C30;">&#39;fuchsia&#39;</span>, <span style=" color: #C30;">&#39;green&#39;</span>, <span style=" color: #C30;">&#39;purple&#39;</span>, <span style=" color: #C30;">&#39;orange&#39;</span>]</p><p style="text-indent: 0pt;text-align: left;"/><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark396" class="s63" name="bookmark395">To see why they are performing so poorly on certain classes, we’ve plotted a t-SNE graph to visualize the embeddings in 2D space, which you can see in </a>Figure 4-16<span style=" color: #000;">. To prevent overcrowding on our plot, we use only 50 items from each of the 6 classes.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 10pt;text-indent: 0pt;text-align: left;"><span><img width="573" height="458" alt="image" src="KerasTensorFlow2019/Image_256.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 179pt;text-indent: -158pt;line-height: 108%;text-align: left;"><a name="bookmark396">Figure 4-16. t-SNE visualization of feature vectors of least-accurate classes before fine tuning</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Aah, these feature vectors are all over the place and on top of one another. Using these feature vectors in other applications such as classification might not be a good idea because it would be difficult to find a clean plane of separation between them. No wonder they performed so poorly in this nearest neighbor–based classification test.</p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark397" class="s63">What do you think will be the result if we repeat these steps with the fine-tuned model? We reckon something interesting; let’s take a look at </a>Figure 4-17 <span style=" color: #000;">to see.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="584" height="430" alt="image" src="KerasTensorFlow2019/Image_257.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 198pt;text-indent: -191pt;line-height: 108%;text-align: left;"><a name="bookmark397">Figure 4-17. t-SNE visualization of feature vectors of least-accurate classes after fine tuning</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark227" class="s63" name="bookmark398">This is so much cleaner. With just a little bit of fine tuning as shown in </a>Chapter 3<span style=" color: #000;">, the embeddings begin to group together. Compare the noisy/scattered embeddings of the pretrained models against those of the fine-tuned model. A machine learning classifier would be able to find a plane of separation between these classes with much more ease, hence yielding better classification accuracy as well as more similar images when not using a classifier. And, remember, these were the classes with the highest misclassifications; imagine how nicely the classes with originally higher accuracy would be after fine tuning.</span></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Previously, the pretrained embeddings achieved 56% accuracy. The new embeddings after fine tuning deliver a whopping 87% accuracy! A little magic goes a long way.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The one limitation for fine tuning is the requirement of labeled data, which is not always present. So depending on your use case, you</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">might need to label some amount of data.</p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">There’s a small unconventional training trick involved, though, which we discuss in the next section.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark314">Fine Tuning Without Fully Connected Layers</a><a name="bookmark399">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">As we already know, a neural network comprises three parts:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_258.png"/></span></p><p style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Convolutional layers, which end up generating the feature vectors</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_259.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_260.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 191%;text-align: left;">Fully connected layers The final classifier layer</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Fine tuning, as the name suggests, involves tweaking a neural network lightly to adapt to a new dataset. It usually involves stripping off the fully connected layers (top layers), substituting them with new ones, and then training this newly composed neural network using this dataset. Training in this manner will cause two things:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_261.png"/></span></p><p style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">The weights in all the newly added fully connected layers will be significantly affected.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_262.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">The weights in the convolutional layers will be only slightly changed.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The fully connected layers do a lot of the heavy lifting to get maximum classification accuracy. As a result, the majority of the network that generates the feature vectors will change insignificantly. Thus, the feature vectors, despite fine tuning, will show little change.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Our aim is for similar-looking objects to have closer feature vectors, which fine tuning as described earlier fails to accomplish. By forcing all of the task-specific learning to happen in the convolutional layers, we can see much better results. How do we achieve that? <i>By removing all of the fully connected layers and placing a classifier layer directly after the convolutional layers (which generate the feature vectors). </i>This model is optimized for similarity search rather than classification.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">To compare the process of fine tuning a model optimized for classification tasks as opposed to similarity search, let’s recall how</p><p class="s45" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark227" class="s63">we fine tuned our model in </a>Chapter 3 <span style=" color: #000;">for classification:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">from </span><span class="s55">tf.keras.applications.resnet50 </span><span class="s54">import </span><span style=" color: #000087;">ResNet5O model </span>= <span style=" color: #000087;">ResNet5O</span>(<span style=" color: #000087;">weights</span>=<span style=" color: #C30;">&#39;imagenet&#39;</span>, <span style=" color: #000087;">include_top</span>=<span class="s54">False</span>, <span style=" color: #000087;">input_shape </span>= (<span style=" color: #F60;">224</span>,<span style=" color: #F60;">224</span>,<span style=" color: #F60;">3</span>))</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #366;">input </span>= <span style=" color: #000087;">Input</span>(<span style=" color: #000087;">shape</span>=(<span style=" color: #F60;">224</span>, <span style=" color: #F60;">224</span>, <span style=" color: #F60;">3</span>)) <span style=" color: #000087;">x </span>= <span style=" color: #000087;">model</span>(<span style=" color: #366;">input</span>)</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">x <span style=" color: #000;">= </span>GlobalAveragePooling2D<span style=" color: #000;">()(</span>x<span style=" color: #000;">)</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">x </span>= <span style=" color: #000087;">Dense</span>(<span style=" color: #F60;">64</span>, <span style=" color: #000087;">activation</span>=<span style=" color: #C30;">&#39;relu&#39;</span>)(<span style=" color: #000087;">x</span>) <span style=" color: #000087;">x </span>= <span style=" color: #000087;">Dropout</span>(<span style=" color: #F60;">O.5</span>)(<span style=" color: #000087;">x</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">x </span>= <span style=" color: #000087;">Dense</span>(<span style=" color: #000087;">NUM_CLASSES</span>, <span style=" color: #000087;">activation</span>=<span style=" color: #C30;">&#39;softmax&#39;</span>)(<span style=" color: #000087;">x</span>) <span style=" color: #000087;">model_classification_optimized </span>= <span style=" color: #000087;">Model</span>(<span style=" color: #000087;">inputs</span>=<span style=" color: #366;">input</span>, <span style=" color: #000087;">outputs</span>=<span style=" color: #000087;">x</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">And here’s how we fine tune our model for similarity search. Note the missing hidden dense layer in the middle:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">from </span><span class="s55">tf.keras.applications.resnet50 </span><span class="s54">import </span><span style=" color: #000087;">ResNet5O model </span>= <span style=" color: #000087;">ResNet5O</span>(<span style=" color: #000087;">weights</span>=<span style=" color: #C30;">&#39;imagenet&#39;</span>, <span style=" color: #000087;">include_top</span>=<span class="s54">False</span>, <span style=" color: #000087;">input_shape </span>= (<span style=" color: #F60;">224</span>,<span style=" color: #F60;">224</span>,<span style=" color: #F60;">3</span>))</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #366;">input </span>= <span style=" color: #000087;">Input</span>(<span style=" color: #000087;">shape</span>=(<span style=" color: #F60;">224</span>, <span style=" color: #F60;">224</span>, <span style=" color: #F60;">3</span>)) <span style=" color: #000087;">x </span>= <span style=" color: #000087;">model</span>(<span style=" color: #366;">input</span>)</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">x <span style=" color: #000;">= </span>GlobalAveragePooling2D<span style=" color: #000;">()(</span>x<span style=" color: #000;">)</span></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># No dense or dropout layers</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">x </span>= <span style=" color: #000087;">Dense</span>(<span style=" color: #000087;">NUM_CLASSES</span>, <span style=" color: #000087;">activation</span>=<span style=" color: #C30;">&#39;softmax&#39;</span>)(<span style=" color: #000087;">x</span>) <span style=" color: #000087;">model_similarity_optimized </span>= <span style=" color: #000087;">Model</span>(<span style=" color: #000087;">inputs</span>=<span style=" color: #366;">input</span>, <span style=" color: #000087;">outputs</span>=<span style=" color: #000087;">x</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 117%;text-align: left;">After fine tuning, to use the <span class="s47">model_similarity_optimized </span>for extracting features instead of giving probabilities for classes, simply <span class="s47">pop </span>(i.e., remove) the last layer:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">model_similarity_optimized<span style=" color: #000;">.</span>layers<span style=" color: #000;">.</span>pop<span style=" color: #000;">()</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">model </span>= <span style=" color: #000087;">Model</span>(<span style=" color: #000087;">model_similarity_optimized</span>.<span style=" color: #000087;">input</span>, <span style=" color: #000087;">model_similarity_optimized</span>.<span style=" color: #000087;">layers</span>[-<span style=" color: #F60;">1</span>].<span style=" color: #000087;">output</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 118%;text-align: left;"><a name="bookmark400">The key thing to appreciate here is if you used the regular fine- tuning process, we would get lower similarity accuracy than </a><span class="s47">model_similarity_optimized</span>. Obviously, we would want to use <span class="s47">model_classification_optimized </span>for classification scenarios and <span class="s47">model_similarity_optimized </span>for extracting embeddings for similarity search.</p><p style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark401">With all this knowledge, you can now make both a fast and accurate similarity system for any scenario you are working on. It’s time to see how the giants in the AI industry build their products.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark315">Siamese Networks for One-Shot Face Verification</a><a name="bookmark402">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark403">A face verification system is usually trying to ascertain — given two images of faces — whether the two images are of the same person. This is a high-precision binary classifier that needs to robustly work with different lighting, clothing, hairstyles, backgrounds, and facial expressions. To make things more challenging, although there might be images of many people in, for instance an employee database, there might be only a handful of images of the same person available. Similarly, signature identification in banks and product identification on Amazon suffer the same challenge of limited images per item.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">How would you go about training such a classifier? Picking embeddings from a model like ResNet pretrained on ImageNet might not discern these fine facial attributes. One approach is to put each person as a separate class and then train like we usually train a regular network. Two key issues arise:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_263.png"/></span></p><p style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">If we had a million individuals, training for a million categories is not feasible.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_264.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Training with a few images per class will lead to overtraining.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark405" class="s63" name="bookmark404">Another thought: instead of teaching different categories, we could teach a network to directly compare and decide whether a pair of images are similar or dissimilar by giving guidance on their similarity during training. And this is the key idea behind Siamese networks. Take a model, feed in two images, extract two embeddings, and then calculate the distance between the two embeddings. If the distance is under a threshold, consider them similar, else not. By feeding a pair of images with the associated label, similar or dissimilar, and training the network end to end, the embeddings begin to capture the fine-grained representation of the inputs. This approach, shown in </a><span style=" color: #8E0012;">Figure 4-18</span>, of directly optimizing for the distance metric is called <i>metric learning</i>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;text-align: left;"><span><img width="564" height="230" alt="image" src="KerasTensorFlow2019/Image_265.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 126pt;text-indent: -109pt;line-height: 108%;text-align: left;"><a name="bookmark405">Figure 4-18. A Siamese network for signature verification; note that the same CNN was used for both input images</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark406">We could extend this idea and even feed three images. Pick one anchor image, pick another positive sample (of the same category), and another negative sample (of a different category). Let’s now train this network to directly optimize for the distance between similar items to be minimized and the distance between dissimilar items to be maximized. This loss function that helps us achieve this is called a </a><i>triplet loss </i>function. In the previous case with a pair of images, the loss function is called a <i>contrastive loss </i>function. The triplet loss function tends to give better results.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark407">After the network is trained, we need only one reference image of a face for deciding at test time whether the person is the same.</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">This methodology opens the doors for <i>one-shot learning</i>. Other common uses include signature and logo recognition. One remarkably creative application by Saket Maheshwary and Hemant Misra is to use a Siamese network for matching résumés with job applicants by calculating the semantic similarity between the two.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark316">Case Studies</a><a name="bookmark408">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark409">Let’s look at a few interesting examples that show how what we have learned so far is applied in the industry.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark317">Flickr</a><a name="bookmark410">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark412" class="s63" name="bookmark411">Flickr is one of the largest photo-sharing websites, especially popular among professional photographers. To help photographers find inspiration as well as showcase content the users might find interesting, Flickr produced a similarity search feature based on the same semantic meaning. As demonstrated in </a>Figure 4-19<span style=" color: #000;">, exploring a desert pattern leads to several similarly patterned results. Under the hood, Flickr adopted an ANN algorithm called Locally Optimized Product Quantization (LOPQ), which has been open sourced in Python as well as Spark implementations.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="596" height="256" alt="image" src="KerasTensorFlow2019/Image_266.jpg"/></span></p><p class="s198" style="padding-top: 6pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a href="https://code.flickr.com/" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12pt;" target="_blank" name="bookmark412">Figure 4-19. Similar patterns of a desert photo (</a>image source<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark318">Pinterest</a><a name="bookmark413">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://like.com/" class="s63" target="_blank" name="bookmark414">Pinterest is an application used widely for its visual search capabilities, more specifically in its features called Similar Pins and Related Pins. Other companies like Baidu and Alibaba have launched similar visual search systems. Also, Zappos, Google Shopping, and </a>like.com <span style=" color: #000;">are using computer vision for recommendation.</span></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark415" class="s63">Within Pinterest “women’s fashion” is one of the most popular themes of pins and the Similar Looks feature (</a>Figure 4-20<span style=" color: #000;">) helps people discover similar products. Additionally, Pinterest also reports that its Related Pins feature increased its repin rate. Not every pin on Pinterest has associated metadata, which makes recommendation a difficult cold-start problem due to lack of context. Pinterest developers solved this cold-start problem by using the visual features for generating the related pins.</span></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Additionally, Pinterest implements an incremental fingerprinting service that generates new digital signatures if either a new image is uploaded or if there is feature evolution (due to improvements or modifications in the underlying models by the engineers).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="596" height="624" alt="image" src="KerasTensorFlow2019/Image_267.jpg"/></span></p><p class="s50" style="padding-top: 6pt;padding-left: 165pt;text-indent: -138pt;line-height: 108%;text-align: left;"><a name="bookmark415">Figure 4-20. The Similar Looks feature of the Pinterest application (image source: Pinterest blog)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark319">Celebrity Doppelgangers</a><a name="bookmark416">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark417">Website applications like </a><i>Celebslike.me</i><a href="#bookmark418" class="s63">, which went viral in 2015, look for the nearest neighbor among celebrities, as shown in </a><span style=" color: #8E0012;">Figure 4-21</span>. A similar viral approach was taken by the Google Arts &amp; Culture app in 2018, which shows the nearest existing portrait to your face. Twins or not is another application with a similar aim.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="376" alt="image" src="KerasTensorFlow2019/Image_268.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 41pt;text-indent: -26pt;line-height: 108%;text-align: left;"><a name="bookmark418">Figure 4-21. Testing our friend Pete Warden’s photo (technical lead for mobile and embedded TensorFlow at Google) on the celebslike.me website</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark320">Spotify</a><a name="bookmark419">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark421" class="s63" name="bookmark420">Spotify uses nearest neighbors for recommending music and creating automatic playlists and radio stations based on the current set of songs being played. Usually, collaborative filtering techniques, which are employed for recommending content like movies on Netflix, are content agnostic; that is, the recommendation happens because large groups of users with similar tastes are watching similar movies or listening to similar songs. This presents a problem for new and not yet popular content because users will keep getting recommendations for existing popular content. This is also referred to as the aforementioned cold-start problem. The solution is to use the latent understanding of the content. Similar to images, we can create feature vectors out of music using MFCC features (Mel Frequency Cepstral Coefficients), which in turn generates a 2D spectrogram that can be thought of as an image and can be used to generate features. Songs are divided into three-second fragments, and their spectrograms are used to generate features. These features are then averaged together to represent the complete song. </a><a href="#bookmark421" class="s44">Figure 4- 22 </a>shows artists whose songs are projected in specific areas. We can discern hip-hop (upper left), rock (upper right), pop (lower left), and electronic music (lower right). As already discussed, Spotify uses Annoy in the background.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="598" height="374" alt="image" src="KerasTensorFlow2019/Image_269.jpg"/></span></p><p class="s50" style="padding-top: 5pt;padding-left: 13pt;text-indent: 0pt;line-height: 108%;text-align: center;"><a name="bookmark421">Figure 4-22. t-SNE visualization of the distribution of predicted usage patterns, using latent factors predicted from audio (image source: “Deep content-based music recommendation” by Aaron van den Oord, Sander Dieleman, Benjamin Schrauwen, NIPS 2013)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark321">Image Captioning</a><a name="bookmark422">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark424" class="s63" name="bookmark423">Image captioning is the science of translating an image into a sentence (as illustrated in </a>Figure 4-23<span style=" color: #000;">). Going beyond just object tagging, this requires a deeper visual understanding of the entire image and relationships between objects. To train these models, an open source dataset called MS COCO was released in 2014, which consists of more than 300,000 images along with object categories, sentence descriptions, visual question-answer pairs, and object segmentations. It serves as a benchmark for a yearly competition to see progress in image captioning, object detection, and segmentation.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="590" height="310" alt="image" src="KerasTensorFlow2019/Image_270.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 172pt;text-indent: -161pt;line-height: 108%;text-align: left;"><a name="bookmark424">Figure 4-23. Image captioning feature in Seeing AI: the Talking Camera App for the blind community</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">A common strategy applied in the first year of the challenge (2015) was to append a language model (LSTM/RNN) with a CNN in such a way that the output of a CNN feature vector is taken as the input to the language model (LSTM/RNN). This combined model was trained jointly in an end-to-end manner, leading to very impressive results that stunned the world. Although every research lab was trying to beat one another, it was later found that doing a simple</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">nearest-neighbor search could yield state-of-the-art results. For a given image, find similar images based on similarity of the embeddings. Then, note the common words in the captions of the similar images, and print the caption containing the most common words. In short, a lazy approach would still beat the state-of-the-art one, and this exposed a critical bias in the dataset.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark425">This bias has been coined the </a><i>Giraffe-Tree </i><a href="#bookmark426" class="s63">problem by Larry Zitnick. Do an image search for “giraffe” on a search engine. Look closely: in addition to giraffe, is there grass in almost every image? Chances are you can describe the majority of these images as “A giraffe standing in a grass field.” Similarly, if a query image like the photo on the far left in </a><span style=" color: #8E0012;">Figure 4-24 </span>contains a giraffe and a tree, almost all similar images (right) can be described as “a giraffe standing in the grass, next to a tree.” Even without a deeper understanding of the image, one would arrive at the correct caption using a simple nearest-neighbor search. This shows that to measure the real intelligence of a system, we need more semantically novel/original images in the test set.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="595" height="347" alt="image" src="KerasTensorFlow2019/Image_271.jpg"/></span></p><p class="s50" style="padding-top: 7pt;padding-left: 28pt;text-indent: 0pt;line-height: 108%;text-align: center;"><a name="bookmark426">Figure 4-24. The Giraffe-Tree problem (image source: Measuring Machine Intelligence Through Visual Question Answering, C. Lawrence Zitnick, Aishwarya Agrawal, Stanislaw Antol, Margaret Mitchell, Dhruv Batra, Devi Parikh)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark427">In short, don’t underestimate a simple nearest-neighbor approach!</a><a name="bookmark428">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark322">Summary</a><a name="bookmark429">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Now we are at the end of a successful expedition where we explored locating similar images with the help of embeddings. We took this one level further by exploring how to scale searches from a few thousand to a few billion documents with the help of ANN algorithms and libraries including Annoy, NGT, and Faiss. We also learned that fine tuning the model to your dataset can improve the accuracy and representative power of embeddings in a supervised setting. To top it all off, we looked at how to use Siamese networks, which use the power of embeddings to do one-shot learning, such as for face verification systems. We finally examined how nearest- neighbor approaches are used in various use cases across the industry. Nearest neighbors are a simple yet powerful tool to have in your toolkit.</p><h2 style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark430">Chapter 5. From Novice to Master Predictor: Maximizing Convolutional Neural Network Accuracy</a><a name="bookmark458">&zwnj;</a></h2><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="581" height="1" alt="image" src="KerasTensorFlow2019/Image_272.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark58" class="s63" name="bookmark459">In </a>Chapter 1<span style=" color: #000;">, we looked at the importance of responsible AI development. One of the aspects we discussed was the importance of robustness of our models. Users can trust what we build only if they can be assured that the AI they encounter on a day-to-day basis is accurate and reliable. Obviously, the context of the application matters a lot. It would be okay for a food classifier to misclassify pasta as bread on occasion. But it would be dangerous for a self-driving car to misclassify a pedestrian as a street lane. The main goal of this chapter is thus a rather important one — to build more accurate models.</span></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In this chapter, you will develop an intuition for recognizing opportunities to improve your model’s accuracy the next time you begin training one. We first look at the tools that will ensure that you won’t be going in blind. After that, for a good chunk of this chapter, we take a very experimental approach by setting up a baseline, isolating individual parameters to tweak, and observing their effect on model performance and training speed. A lot of the code we use in this chapter is all aggregated in a single Jupyter Notebook, along with an actionable checklist with interactive examples. It is meant to be highly reusable should you choose to incorporate it in your next training script.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We explore several questions that tend to come up during model training:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_273.png"/></span></p><p style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">I am unsure whether to use transfer learning or building from scratch to train my own network. What is the preferred approach for my scenario?</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_274.png"/></span></p><p style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">What is the least amount of data that I can supply to my training pipeline to get acceptable results?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_275.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">I want to ensure that the model is learning the correct thing and not picking up spurious correlations. How can I get visibility into that?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_276.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">How can I ensure that I (or someone else) will obtain the same results from my experiments every single time they are run? In other words, how do I ensure reproducibility of my experiments?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_277.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Does changing the aspect ratio of the input images have an impact on the predictions?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_278.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Does reducing input image size have a significant effect on prediction results?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_279.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">If I use transfer learning, what percentage of layers should I fine tune to achieve my preferred balance of training time versus accuracy?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_280.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Alternatively, if I were to train from scratch, how many layers should I have in my model?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_281.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">What is the appropriate “learning rate” to supply during model training?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_282.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">There are too many things to remember. Is there a way to automate all of this work?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark460">We will try to answer these questions one by one in the form of experiments on a few datasets. Ideally, you should be able to look at the results, read the takeaways, and gain some insight into the concept that the experiment was testing. If you’re feeling more adventurous, you can choose to perform the experiments yourself using the Jupyter Notebook.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark431">Tools of the Trade</a><a name="bookmark461">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark462">One of the main priorities of this chapter is to reduce the code and effort involved during experimentation while trying to gain insights into the process in order to reach high accuracy. An arsenal of tools exists that can assist us in making this journey more pleasant:</a></p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">TensorFlow Datasets</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;">Quick and easy access to around 100 datasets in a performant manner. All well-known datasets are available starting from the smallest MNIST (a few megabytes) to the largest MS COCO, ImageNet, and Open Images (several hundred gigabytes). Additionally, medical datasets like the Colorectal Histology and Diabetic Retinopathy are also available.</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">TensorBoard</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;">Close to 20 easy-to-use methods to visualize many aspects of training, including visualizing the graph, tracking experiments, and inspecting the images, text, and audio data that pass through the network during training.</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">What-If Tool</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark463">Run experiments in parallel on separate models and tease out differences in them by comparing their performance on specific data points. Edit individual data points to see how that affects the model training.</a></p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">tf-explain</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark464">Analyze decisions made by the network to identify bias and inaccuracies in the dataset. Additionally, use heatmaps to visualize what parts of the image the network activated on.</a></p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Keras Tuner</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark465">A library built for </a><span class="s47">tf.keras </span>that enables automatic tuning of hyperparameters in TensorFlow 2.0.</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">AutoKeras</p><p style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark466">Automates Neural Architecture Search (NAS) across different tasks like image, text, and audio classification and image detection.</a></p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">AutoAugment</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark467">Utilizes reinforcement learning to improve the amount and diversity of data in an existing training dataset, thereby increasing accuracy.</a></p><p style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Let’s now explore these tools in greater detail.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark432">TensorFlow Datasets</a><a name="bookmark468">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark469">TensorFlow Datasets is a collection of nearly 100 ready-to-use datasets that can quickly help build high-performance input data pipelines for training TensorFlow models. Instead of downloading and manipulating data sets manually and then figuring out how to read their labels, TensorFlow Datasets standardizes the data format so that it’s easy to swap one dataset with another, often with just a single line of code change. As you will see later on, doing things like breaking the dataset down into training, validation, and testing is also a matter of a single line of code. We will additionally be exploring TensorFlow Datasets from a performance point of view in the next chapter.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">You can list all of the available datasets by using the following command (in the interest of conserving space, only a small subset of the full output is shown in this example):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">tensorflow_datasets </span>as <span style=" color: #0CF;">tfds</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #366;">print</span>(<span style=" color: #000087;">tfds</span>.<span style=" color: #000087;">list_builders</span>())</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-top: 6pt;padding-left: 21pt;text-indent: 0pt;text-align: left;">[&#39;amazon_us_reviews&#39;, &#39;bair_robot_pushing_small&#39;, &#39;bigearthnet&#39;, &#39;caltech1O1&#39;,</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&#39;cats_vs_dogs&#39;, &#39;celeb_a&#39;, &#39;imagenet2O12&#39;, … , &#39;open_images_v4&#39;, &#39;oxford_flowers1O2&#39;, &#39;stanford_dogs&#39;,&#39;voc2OO7&#39;, &#39;wikipedia&#39;, &#39;wmt_translate&#39;,</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&#39;xnli&#39;]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Let’s see how simple it is to load a dataset. We will plug this into a full working pipeline later:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Import necessary packages</p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">tensorflow_datasets </span>as <span style=" color: #0CF;">tfds</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Downloading and loading the dataset</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">dataset </span>= <span style=" color: #000087;">tfds</span>.<span style=" color: #000087;">load</span>(<span style=" color: #000087;">name</span>=<span style=" color: #C30;">&quot;cats_vs_dogs&quot;</span>, <span style=" color: #000087;">split</span>=<span style=" color: #000087;">tfds</span>.<span style=" color: #000087;">Split</span>.<span style=" color: #000087;">TRAIN</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Building a performance data pipeline</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">dataset </span>= <span style=" color: #000087;">dataset</span>.<span style=" color: #000087;">map</span>(<span style=" color: #000087;">preprocess</span>).<span style=" color: #000087;">cache</span>().<span style=" color: #000087;">repeat</span>().<span style=" color: #000087;">shuffle</span>(<span style=" color: #F60;">1O24</span>).<span style=" color: #000087;">batch</span>(<span style=" color: #F60;">32</span>). <span style=" color: #000087;">prefetch</span>(<span style=" color: #000087;">tf</span>.<span style=" color: #000087;">data</span>.<span style=" color: #000087;">experimental</span>.<span style=" color: #000087;">AUTOTUNE</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">model<span style=" color: #000;">.</span>fit<span style=" color: #000;">(</span>dataset<span style=" color: #000;">, ...)</span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s53" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 115%;text-align: left;">tfds <span class="s49">generates a lot of progress bars, and they take up a lot of screen space — using </span>tfds.disable_progress_bar() <span class="s49">might be a good idea.</span></p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="110" alt="image" src="KerasTensorFlow2019/Image_283.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark433">TensorBoard</a><a name="bookmark470">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;"><a name="bookmark471">TensorBoard is a one-stop-shop for all of your visualization needs, offering close to 20 tools to understand, inspect, and improve your model’s training.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;">Traditionally, to track experiment progress, we save the values of loss and accuracy per epoch and then, when done, plot it using <span class="s47">matplotlib</span>. The downside with that approach is that it’s not real time. Our usual options are to watch for the training progress in text. Additionally, after the training is done, we need to write additional code to make the graph in <span class="s47">matplotlib</span><a href="#bookmark472" class="s63">. TensorBoard solves these and more pressing issues by offering a real-time dashboard (</a><span style=" color: #8E0012;">Figure 5-1</span>) that helps us visualize all logs (such as train/validation accuracy and loss) to assist in understanding the progression of training. Another benefit it offers is the ability to compare our current experiment’s progress with the previous experiment, so we can see how a change in parameters affected our overall accuracy.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="593" height="337" alt="image" src="KerasTensorFlow2019/Image_284.jpg"/></span></p><p class="s50" style="padding-top: 7pt;padding-left: 48pt;text-indent: -37pt;line-height: 108%;text-align: left;"><a name="bookmark472">Figure 5-1. TensorBoard default view showcasing real-time training metrics (the lightly shaded lines represent the accuracy from the previous run)</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">To enable TensorBoard to visualize our training and models, we need to log information about our training with the help of summary writer:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">summary_writer </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">summary</span>.<span style=" color: #000087;">FileWriter</span>(<span style=" color: #C30;">&#39;./logs&#39;</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;">To follow our training in real time, we need to load TensorBoard before the model training begins. We can load TensorBoard by using the following commands:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Get TensorBoard to run</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">%<span style=" color: #000087;">load_ext tensorboard</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Start TensorBoard</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">%<span style=" color: #000087;">tensorboard </span>--<span style=" color: #000087;">logdir </span>./<span style=" color: #000087;">log</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark473" class="s63">As more TensorFlow components need a visual user interface, they reuse TensorBoard by becoming embeddable plug-ins within it. You’ll notice the Inactive drop-down menu on TensorBoard; that’s where you can see all the different profiles or tools that TensorFlow offers. </a>Table 5-1 <span style=" color: #000;">showcases a handful of the wide variety of tools available.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s48" style="padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark473">TensorBoard plug-in name</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="69" alt="image" src="KerasTensorFlow2019/Image_285.png"/></span></p><p class="s49" style="text-indent: 0pt;line-height: 108%;text-align: left;">Visualize user-defined custom metrics. For example, different weights for different classes, which might not be a readily available metric.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="text-indent: 0pt;line-height: 108%;text-align: left;">Custom Scalar</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="padding-top: 6pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">Default Scalar</p><p class="s43" style="padding-top: 4pt;padding-left: 24pt;text-indent: 0pt;text-align: left;">Table 5-1. Plugins for TensorBoard</p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="1" alt="image" src="KerasTensorFlow2019/Image_286.png"/></span></p><p class="s48" style="padding-top: 11pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Description</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="1" alt="image" src="KerasTensorFlow2019/Image_287.png"/></span></p><p class="s49" style="padding-left: 5pt;text-indent: 0pt;text-align: left;">Visualize scalar values such as classification accuracy.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="30" alt="image" src="KerasTensorFlow2019/Image_288.png"/></span></p><p class="s49" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Audio Visualize audio data.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="padding-top: 2pt;padding-bottom: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Image View the output from each layer by clicking the Images tab.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="30" alt="image" src="KerasTensorFlow2019/Image_289.png"/></span></p><p class="s49" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Graphs Shows the model architecture graphically.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="padding-top: 2pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">Debugging tools</p><p class="s49" style="padding-top: 2pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">Allows debugging visually and setting conditional breakpoints (e.g., tensor contains Nan or Infinity).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s49" style="padding-top: 2pt;padding-left: 94pt;text-indent: -83pt;line-height: 108%;text-align: justify;">Histograms Show the changes in the weight distribution in the layers of a model as the training progresses. This is especially useful for checking the effect of compressing a model with quantization.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="30" alt="image" src="KerasTensorFlow2019/Image_290.png"/></span></p><p class="s49" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Projector Visualize projections using t-SNE, PCA, and others.</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="1" alt="image" src="KerasTensorFlow2019/Image_291.png"/></span></p><p class="s48" style="padding-top: 3pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">TensorBoard plug-in name</p><p class="s48" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Description</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="30" alt="image" src="KerasTensorFlow2019/Image_292.png"/></span></p><p class="s49" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">PR curves Plot precision-recall curves.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="padding-top: 2pt;padding-bottom: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Text Visualize text data.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="69" alt="image" src="KerasTensorFlow2019/Image_293.png"/></span></p><p class="s49" style="text-indent: 0pt;line-height: 108%;text-align: justify;">Visualize the gradients and activations of a model in real time during training. It allows seeing them filter by filter, and allows them to be exported as images or even as a video.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="text-indent: 0pt;line-height: 14pt;text-align: left;">Beholder</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="padding-top: 2pt;padding-bottom: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Profile Benchmark speed of all operations and layers in a model.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="69" alt="image" src="KerasTensorFlow2019/Image_294.png"/></span></p><p class="s49" style="text-indent: 0pt;line-height: 108%;text-align: left;">Find out which params and at what values are the most important, allow logging of the entire parameter server (discussed in detail in this chapter).</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="text-indent: 0pt;line-height: 14pt;text-align: left;">HParams</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="padding-top: 2pt;padding-bottom: 2pt;padding-left: 94pt;text-indent: -83pt;line-height: 108%;text-align: left;">What-If Tool For investigating the model by slicing and dicing the data and checking its performance. Especially helpful for discovering bias.</p><p class="s49" style="padding-top: 2pt;padding-bottom: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Mesh Visualize 3D data (including point clouds).</p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="581" height="1" alt="image" src="KerasTensorFlow2019/Image_295.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark323" class="s63">It should be noted that TensorBoard is not TensorFlow specific, and can be used with other frameworks like PyTorch, scikit-learn, and more, depending on the plugin used. To make a plugin work, we need to write the specific metadata that we want to visualize. For example, TensorBoard embeds the TensorFlow Projector tool within to cluster images, text, or audio using t-SNE (which we examined in detail in </a>Chapter 4<a href="#bookmark474" class="s63">). Apart from calling TensorBoard, we need to write the metadata like the feature embeddings of our image, so that TensorFlow Projector can use it to do clustering, as demonstrated in </a>Figure 5-2<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="308" alt="image" src="KerasTensorFlow2019/Image_296.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 139pt;text-indent: -125pt;line-height: 108%;text-align: left;"><a name="bookmark474">Figure 5-2. TensorFlow Embedding Projector showcasing data in clusters (can be run as a TensorBoard plugin)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark434">What-If Tool</a><a name="bookmark475">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark476">What if we could inspect our AI model’s predictions with the help of visualizations? What if we could find the best threshold for our model to maximize precision and recall? What if we could slice and dice the data along with the predictions our model made to see what it’s great at and where there are opportunities to improve?</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">What if we could compare two models to figure out which is indeed better? What if we could do all this and more, with a few clicks in the browser? Sounds appealing for sure! The What-If Tool</p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark477" class="s63">(</a>Figure 5-3 <a href="#bookmark478" class="s63">and </a>Figure 5-4<span style=" color: #000;">) from Google’s People + AI Research (PAIR) initiative helps open up the black box of AI models to enable model and data explainability.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="600" height="509" alt="image" src="KerasTensorFlow2019/Image_297.jpg"/></span></p><p class="s50" style="padding-top: 4pt;padding-left: 27pt;text-indent: -19pt;line-height: 108%;text-align: left;"><a name="bookmark477">Figure 5-3. What-If Tool’s datapoint editor makes it possible to filter and visualize data according to annotations of the dataset and labels from the classifier</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="589" height="242" alt="image" src="KerasTensorFlow2019/Image_298.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 11pt;text-indent: 0pt;line-height: 108%;text-align: center;"><a name="bookmark478">Figure 5-4. PR curves in the Performance and Fairness section of the What-If Tool help to interactively select the optimal threshold to maximize precision and recall</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 113%;text-align: left;">To use the What-If Tool, we need the dataset and a model. As we just saw, TensorFlow Datasets makes downloading and loading the data (in the <span class="s47">tfrecord </span>format) relatively easy. All we need to do is to locate the data file. Additionally, we want to save the model in the same directory:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Save model for What If Tool</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">tf</span>.<span style=" color: #000087;">saved_model</span>.<span style=" color: #000087;">save</span>(<span style=" color: #000087;">model</span>, <span style=" color: #C30;">&quot;/tmp/model/1/&quot;</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;">It’s best to perform the following lines of code in a local system rather than a Colab notebook because the integration between Colab and the What-If Tool is still evolving.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;">Let’s start TensorBoard:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ mkdir tensorboard</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ tensorboard --logdir ./log --alsologtostderr</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Now, in a new terminal, let’s make a directory for all of our What-If Tool experiments:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ mkdir what-if-stuff</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Move the trained model and TFRecord data here. The overall directory structure looks something like this:</p><p class="s53" style="padding-top: 4pt;padding-left: 21pt;text-indent: 0pt;text-align: left;">$ tree .</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">├── colo</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">│ └── model</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">│ └── 1</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">│ ├── assets</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">│ ├── saved_model.pb</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">│ └── variables</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We’ll serve the model using Docker within the newly created directory:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ sudo docker run -p 85OO:85OO \</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">--mount type=bind,source=/home/{<i>your_username</i>}/what-if- stuff/colo/model/,</p><p class="s53" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">target=/models/colo \</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">-e MODEL_NAME=colo -t tensorflow/serving</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;">A word of caution: the port must be <span class="s47">85OO </span>and all parameters must be spelled exactly as shown in the preceding example.</p><p class="s45" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark479" class="s63">Next, at the far right, click the settings button (the gray gear icon) and add the values listed in </a>Table 5-2<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s43" style="padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark479">Table 5-2. Configurations for the What-If Tool</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="581" height="1" alt="image" src="KerasTensorFlow2019/Image_299.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-bottom: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Parameter Value</p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="581" height="1" alt="image" src="KerasTensorFlow2019/Image_300.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="55" alt="image" src="KerasTensorFlow2019/Image_301.png"/></span></p><p class="s75" style="text-indent: 0pt;text-align: left;">/models/colo</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="text-indent: 0pt;line-height: 108%;text-align: left;">Model name</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="padding-top: 3pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">Inference address</p><p class="s75" style="padding-top: 7pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">ip_addr:85OO</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="50" alt="image" src="KerasTensorFlow2019/Image_302.png"/></span></p><p class="s50" style="text-indent: 0pt;line-height: 107%;text-align: left;">/home/{<span class="s32">your_username</span>}/what_if_stuff/colo/models/colo.tfrec <span class="s49">(Note: this must be an absolute path)</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="text-indent: 0pt;line-height: 108%;text-align: left;">Path to examples</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="padding-top: 2pt;padding-bottom: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Model type Classification</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark480" class="s63">We can now open the What-If Tool in the browser within TensorBoard, as depicted in </a>Figure 5-5<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 26pt;text-indent: 0pt;text-align: left;"><span><img width="545" height="506" alt="image" src="KerasTensorFlow2019/Image_303.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark480">Figure 5-5. Setup window for the What-If Tool</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark481" class="s63">The What-If Tool can also be used to visualize datasets according to different bins, as shown in </a><span style=" color: #8E0012;">Figure 5-6</span>. We can also use the tool to determine the better performing model out of multiple models on the same dataset using the <span class="s47">set_compare_estimator_and_feature_spec </span>function.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">witwidget.notebook.visualization </span>import <span class="s56">WitConfigBuilder</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># features are the test examples that we want to load into the tool</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">models <span style=" color: #000;">= [</span>model2<span style=" color: #000;">, </span>model3<span style=" color: #000;">, </span>model4<span style=" color: #000;">] </span>config_builder <span style=" color: #000;">=</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">WitConfigBuilder<span style=" color: #000;">(</span>test_examples<span style=" color: #000;">).</span>set_estimator_and_feature_spec<span style=" color: #000;">(</span>model1<span style=" color: #000;">, </span>features<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">for </span>each_model <span class="s71">in </span>models<span style=" color: #000;">:</span></p><p class="s56" style="padding-top: 4pt;padding-left: 27pt;text-indent: 17pt;text-align: left;">config_builder <span style=" color: #000;">= </span>config_builder<span style=" color: #000;">.</span>set_compare_estimator_and_feature_spec<span style=" color: #000;">(</span>each_model<span style=" color: #000;">,</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">features<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="342" alt="image" src="KerasTensorFlow2019/Image_304.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 126pt;text-indent: -111pt;line-height: 108%;text-align: left;"><a name="bookmark481">Figure 5-6. The What-If tool enables using multiple metrics, data visualization, and many more things under the sun</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark483" class="s63">Now, we can load TensorBoard, and then, in the Visualize section, choose the model we want to compare, as shown in </a>Figure 5-7<span style=" color: #000;">.</span></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark482">This tool has many features to explore!</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="595" height="348" alt="image" src="KerasTensorFlow2019/Image_305.jpg"/></span></p><p class="s50" style="padding-top: 8pt;padding-left: 51pt;text-indent: 0pt;text-align: left;"><a name="bookmark483">Figure 5-7. Choose the model to compare using the What-If Tool</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark435">tf-explain</a><a name="bookmark484">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark485">Deep learning models have traditionally been black boxes, and up until now, we usually learn about their performance by watching the class probabilities and validation accuracies. To make these models more interpretable and explainable, heatmaps come to the rescue. By showing the area of an image that leads to the prediction with higher intensity, heatmaps can help visualize their learning. For example, an animal often seen in surroundings with snow might be getting high-accuracy predictions, but if the dataset has only that animal with snow as the background, the model might just be paying attention to the snow as the distinctive pattern instead of the animal. Such a dataset demonstrates bias, making the predictions not too robust when the classifier is put in the real world (and potentially dangerous!). Heatmaps can be especially useful to explore such bias, as often spurious correlations can seep in if the dataset is not carefully curated.</a></p><p class="s47" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;">tf-explain <span class="p">(by Raphael Meudec) helps understand the results and inner workings of a neural network with the help of such visualizations, removing the veil on bias in datasets. We can add multiple types of callbacks while training or use its core API to generate TensorFlow events that can later be loaded into TensorBoard. For inference, all we need to do is pass an image, its ImageNet object ID along with a model into tf-explain’s functions.</span></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 117%;text-align: left;">You must supply the object ID because <span class="s47">tf.explain </span>needs to know what is activated for that particular class. A few different visualization approaches are available with <span class="s47">tf.explain</span>:</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Grad CAM</p><p class="s45" style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a href="#bookmark486" class="s63">The Gradient-weighted Class Activation Mapping (Grad CAM) visualizes how parts of the image affect the neural network’s output by looking into the activation maps. A heatmap (illustrated in </a>Figure 5-8<span style=" color: #000;">) is generated based on the gradients of the object ID from the last convolutional layer. Grad CAM is largely a broad-spectrum heatmap generator given that it is robust to noise and can be used on an array of CNN models.</span></p><p class="s43" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Occlusion Sensitivity</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;">Occludes a part of the image (using a small square patch placed randomly) to establish how robust the network is. If the prediction is still correct, on average, the network is robust.</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;">The area in the image that is the warmest (i.e., red) has the most effect on the prediction when occluded.</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Activations</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Visualizes the activations for the convolutional layers.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="309" alt="image" src="KerasTensorFlow2019/Image_306.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 43pt;text-indent: 0pt;text-align: left;"><a name="bookmark486">Figure 5-8. Visualizations on images using MobileNet and tf-explain</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark487">As demonstrated in the code example that follows, such visualizations can be built with very little code. By taking a video, generating individual frames, and running tf-explain with Grad CAM and joining them together, we can build a detailed understanding of how these neural networks would react to moving camera angles.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">tf_explain.core.grad_cam </span>import <span class="s56">GradCAM</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">From tf<span style=" color: #000;">.</span>keras<span style=" color: #000;">.</span>applications<span style=" color: #000;">.</span>MobileNet <span class="s54">import </span><span class="s55">MobileNet</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">model </span>= <span style=" color: #000087;">MobileNet</span>(<span style=" color: #000087;">weights</span>=<span style=" color: #C30;">&#39;imagenet&#39;</span>, <span style=" color: #000087;">include_top</span>=<span class="s54">True</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Set Grad CAM System</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">explainer <span style=" color: #000;">= </span>GradCAM<span style=" color: #000;">()</span></p><p class="s56" style="padding-top: 4pt;padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s60"># Image Processing </span>IMAGE_PATH <span style=" color: #000;">= </span><span style=" color: #C30;">&#39;dog.jpg&#39; </span>dog_index <span style=" color: #000;">= </span><span style=" color: #F60;">263</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">img </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">preprocessing</span>.<span style=" color: #000087;">image</span>.<span style=" color: #000087;">load_img</span>(<span style=" color: #000087;">IMAGE_PATH</span>, <span style=" color: #000087;">target_size</span>= (<span style=" color: #F60;">224</span>, <span style=" color: #F60;">224</span>))</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">img </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">preprocessing</span>.<span style=" color: #000087;">image</span>.<span style=" color: #000087;">img_to_array</span>(<span style=" color: #000087;">img</span>) <span style=" color: #000087;">data </span>= ([<span style=" color: #000087;">img</span>], <span class="s54">None</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Passing the image through Grad CAM</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">grid </span>= <span style=" color: #000087;">explainer</span>.<span style=" color: #000087;">explain</span>(<span style=" color: #000087;">data</span>, <span style=" color: #000087;">model</span>, <span style=" color: #C30;">&#39;conv1&#39;</span>, <span style=" color: #000087;">index</span>) <span style=" color: #000087;">name </span>= <span style=" color: #000087;">IMAGE_PATH</span>.<span style=" color: #000087;">split</span>(<span style=" color: #C30;">&quot;.jpg&quot;</span>)[<span style=" color: #F60;">O</span>] <span style=" color: #000087;">explainer</span>.<span style=" color: #000087;">save</span>(<span style=" color: #000087;">grid</span>, <span style=" color: #C30;">&#39;/tmp&#39;</span>, <span style=" color: #000087;">name </span>+ <span style=" color: #C30;">&#39;_grad_cam.png&#39;</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark436">Common Techniques for Machine Learning Experimentation</a><a name="bookmark488">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;"><a name="bookmark489">The first few chapters focused on training the model. The following sections, however, contain a few more things to keep in the back of your mind while running your training experiments.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark437">Data Inspection</a><a name="bookmark490">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark492" class="s63" name="bookmark491">Data inspection’s first biggest hurdle is determining the structure of the data. TensorFlow Datasets has made this step relatively easy because all of the available datasets are in the same format and structure and can be used in a performant way. All we need to do is load the dataset into the What-If Tool and use the various options already present to inspect the data. As an example, on the SMILE dataset, we can visualize the dataset according to its annotations, such as images of people wearing eyeglasses and those without eyeglasses, as illustrated in </a>Figure 5-9<span style=" color: #000;">. We observe that a wider distribution of the dataset has images of people wearing no eyeglasses, thus uncovering bias in the data due to an unbalanced dataset. This can be solved by modifying the weights of the metrics accordingly, through the tool.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="383" alt="image" src="KerasTensorFlow2019/Image_307.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 198pt;text-indent: -162pt;line-height: 108%;text-align: left;"><a name="bookmark492">Figure 5-9. Slicing and dividing the data based on predictions and real categories</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark438">Breaking the Data: Train, Validation, Test</a><a name="bookmark493">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark494">Splitting a dataset into train, validation, and test is pretty important because we want to report the results on an unseen dataset by the classifier (i.e., the test dataset). TensorFlow Datasets makes it easy to download, load, and split the dataset into these three parts. Some datasets already come with three default splits. Alternatively, the data can be split by percentages. The following code showcases using a default split:</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">dataset_name <span style=" color: #000;">= </span><span style=" color: #C30;">&quot;cats_vs_dogs&quot;</span></p><p class="s53" style="padding-left: 140pt;text-indent: -118pt;text-align: left;"><span style=" color: #000087;">train</span>, <span style=" color: #000087;">info_train </span>= <span style=" color: #000087;">tfds</span>.<span style=" color: #000087;">load</span>(<span style=" color: #000087;">dataset_name</span>, <span style=" color: #000087;">split</span>=<span style=" color: #000087;">tfds</span>.<span style=" color: #000087;">Split</span>.<span style=" color: #000087;">TRAIN</span>, <span style=" color: #000087;">with_info</span>=<span class="s54">True</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 120%;text-align: left;">The cats-and-dogs dataset in <span class="s47">tfds </span>has only the train split predefined. Similar to this, some datasets in TensorFlow Datasets do not have a <span class="s47">validation </span>split. For those datasets, we take a small percentage of samples from the predefined <span class="s47">training </span>set and treat it as the <span class="s47">validation </span>set. To top it all off, splitting the dataset using the <span class="s47">weighted_splits </span>takes care of randomizing and shuffling data between the splits:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Load the dataset</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">dataset_name <span style=" color: #000;">= </span><span style=" color: #C30;">&quot;cats_vs_dogs&quot;</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s60"># Dividing data into train (80), val (10) and test (10) </span><span style=" color: #000087;">split_train</span>, <span style=" color: #000087;">split_val</span>, <span style=" color: #000087;">split_test </span>= <span style=" color: #000087;">tfds</span>.<span style=" color: #000087;">Split</span>.<span style=" color: #000087;">TRAIN</span>.<span style=" color: #000087;">subsplit</span>(<span style=" color: #000087;">weighted</span>=[<span style=" color: #F60;">8O</span>, <span style=" color: #F60;">1O</span>,</p><p class="s58" style="padding-left: 241pt;text-indent: 0pt;text-align: left;">1O<span style=" color: #000;">])</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">train</span>, <span style=" color: #000087;">info_train </span>= <span style=" color: #000087;">tfds</span>.<span style=" color: #000087;">load</span>(<span style=" color: #000087;">dataset_name</span>, <span style=" color: #000087;">split</span>=<span style=" color: #000087;">split_train </span>, <span style=" color: #000087;">with_info</span>=<span class="s54">True</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">val</span>, <span style=" color: #000087;">info_val </span>= <span style=" color: #000087;">tfds</span>.<span style=" color: #000087;">load</span>(<span style=" color: #000087;">dataset_name</span>, <span style=" color: #000087;">split</span>=<span style=" color: #000087;">split_val</span>, <span style=" color: #000087;">with_info</span>=<span class="s54">True</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">test</span>, <span style=" color: #000087;">info_test </span>= <span style=" color: #000087;">tfds</span>.<span style=" color: #000087;">load</span>(<span style=" color: #000087;">dataset_name</span>, <span style=" color: #000087;">split</span>=<span style=" color: #000087;">split_test</span>, <span style=" color: #000087;">with_info</span>=<span class="s54">True</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark439">Early Stopping</a><a name="bookmark495">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;"><a name="bookmark496">Early stopping helps to avoid overtraining of the network by keeping a lookout for the number of epochs that show limited improvement. Assuming a model is set to train for 1,000 epochs and reaches 90% accuracy at the 10</a><span class="s31">th </span>epoch and stops improving any further for the next 10 epochs, it might be a waste of resources to train any further. If the number of epochs exceeds a predefined threshold called <span class="s47">patience</span>, training is stopped even if there might still be more epochs left to train. In other words, early stopping decides the point at which the training would no longer be useful and stops training. We can change the metric using the <span class="s47">monitor </span>parameter and add early stopping to our list of callbacks for the model:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s60"># Define Early Stopping callback </span><span style=" color: #000087;">earlystop_callback </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">callbacks</span>.<span style=" color: #000087;">EarlyStopping</span>(<span style=" color: #000087;">monitor</span>=<span style=" color: #C30;">&#39;val_acc&#39;</span>,</p><p class="s53" style="padding-left: 265pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">min_delta</span>=<span style=" color: #F60;">O.OOO1</span>, <span style=" color: #000087;">patience</span>=<span style=" color: #F60;">1O</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-top: 5pt;padding-left: 21pt;text-indent: 0pt;text-align: left;"># Add to the training model</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">model<span style=" color: #000;">.</span>fit_generator<span style=" color: #000;">(... </span>callbacks<span style=" color: #000;">=[</span>earlystop_callback<span style=" color: #000;">])</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark440">Reproducible Experiments</a><a name="bookmark497">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark498">Train a network once. Then, train it again, without changing any code or parameters. You might notice that the accuracies in two subsequent runs came out slightly different, even if no change was made in code. This is due to random variables. To make experiments reproducible across runs, we want to control this randomization. Initialization of weights of models, randomized shuffling of data, and so on all utilize randomization algorithms. We know that random number generators can be made reproducible by initializing a seed and that’s exactly what we will do. Various frameworks have their own ways of setting a random seed, some of which are shown here:</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Seed for Tensorflow</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">tf</span>.<span style=" color: #000087;">random</span>.<span style=" color: #000087;">set_seed</span>(<span style=" color: #F60;">1234</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s60"># Seed for Numpy </span><span class="s54">import </span><span class="s55">numpy </span><span class="s54">as </span><span class="s55">np </span><span style=" color: #000087;">np</span>.<span style=" color: #000087;">random</span>.<span style=" color: #000087;">seed</span>(<span style=" color: #F60;">1234</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Seed for Keras</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">seed <span style=" color: #000;">= </span><span style=" color: #F60;">1234</span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="126" alt="image" src="KerasTensorFlow2019/Image_308.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark499">It is necessary to set a seed in all the frameworks and subframeworks that are being used, as seeds are not transferable between frameworks.</a></p><p style="text-indent: 0pt;text-align: left;"/><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">fit</span>(<span style=" color: #000087;">train_data</span>, <span style=" color: #000087;">augment</span>=<span class="s54">True</span>, <span style=" color: #000087;">seed</span>=<span style=" color: #000087;">seed</span>) <span style=" color: #000087;">flow_from_dataframe</span>(<span style=" color: #000087;">train_dataframe</span>, <span style=" color: #000087;">shuffle</span>=<span class="s54">True</span>, <span style=" color: #000087;">seed</span>=<span style=" color: #000087;">seed</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark441">End-to-End Deep Learning Example Pipeline</a><a name="bookmark500">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s63" target="_blank" name="bookmark501">Let’s combine several tools and build a skeletal backbone, which will serve as our pipeline in which we will add and remove parameters, layers, functionality, and various other addons to really understand what is happening. Following the code on the book’s GitHub website (see </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">http://PracticalDeepLearning.ai</span>), you can interactively run this code for more than 100 datasets in your browser with Colab. Additionally, you can modify it for most classification tasks.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark442">Basic Transfer Learning Pipeline</a><a name="bookmark502">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark503">First, let’s build this end-to-end example for transfer learning.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Import necessary packages</p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">tensorflow </span>as <span style=" color: #0CF;">tf</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">tensorflow_datasets </span>as <span style=" color: #0CF;">tfds</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># tfds makes a lot of progress bars, which takes up a lot of screen space, hence</p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># disabling them</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;line-height: 206%;text-align: left;"><span style=" color: #000087;">tfds</span>.<span style=" color: #000087;">disable_progress_bar</span>() <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">random</span>.<span style=" color: #000087;">set_seed</span>(<span style=" color: #F60;">1234</span>)</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s60"># Variables </span>BATCH_SIZE <span style=" color: #000;">= </span><span style=" color: #F60;">32 </span>NUM_EPOCHS<span style=" color: #000;">= </span><span style=" color: #F60;">2O </span>IMG_H <span style=" color: #000;">= </span>IMG_W <span style=" color: #000;">= </span><span style=" color: #F60;">224 </span>IMG_SIZE <span style=" color: #000;">= </span><span style=" color: #F60;">224</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">LOG_DIR <span style=" color: #000;">= </span><span style=" color: #C30;">&#39;./log&#39; </span>SHUFFLE_BUFFER_SIZE <span style=" color: #000;">= </span><span style=" color: #F60;">1O24 </span>IMG_CHANNELS <span style=" color: #000;">= </span><span style=" color: #F60;">3</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">dataset_name <span style=" color: #000;">= </span><span style=" color: #C30;">&quot;oxford_flowers1O2&quot;</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">def </span><span style=" color: #C0F;">preprocess</span>(<span style=" color: #000087;">ds</span>):</p><p class="s53" style="padding-left: 33pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">x </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">image</span>.<span style=" color: #000087;">resize_with_pad</span>(<span style=" color: #000087;">ds</span>[<span style=" color: #C30;">&#39;image&#39;</span>], <span style=" color: #000087;">IMG_SIZE</span>, <span style=" color: #000087;">IMG_SIZE</span>) <span style=" color: #000087;">x </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">cast</span>(<span style=" color: #000087;">x</span>, <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">float32</span>)</p><p class="s53" style="padding-left: 33pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">x </span>= (<span style=" color: #000087;">x</span>/<span style=" color: #F60;">127.5</span>) - <span style=" color: #F60;">1</span></p><p class="s53" style="padding-left: 33pt;text-indent: 0pt;text-align: left;"><span class="s54">return </span><span style=" color: #000087;">x</span>, <span style=" color: #000087;">ds</span>[<span style=" color: #C30;">&#39;label&#39;</span>]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">def </span><span style=" color: #C0F;">augmentation</span>(<span style=" color: #000087;">image</span>,<span style=" color: #000087;">label</span>):</p><p class="s53" style="padding-left: 33pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">image </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">image</span>.<span style=" color: #000087;">random_brightness</span>(<span style=" color: #000087;">image</span>, .<span style=" color: #F60;">1</span>)</p><p class="s53" style="padding-left: 33pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">image </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">image</span>.<span style=" color: #000087;">random_contrast</span>(<span style=" color: #000087;">image</span>, <span style=" color: #000087;">lower</span>=<span style=" color: #F60;">O.O</span>, <span style=" color: #000087;">upper</span>=<span style=" color: #F60;">1.O</span>) <span style=" color: #000087;">image </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">image</span>.<span style=" color: #000087;">random_flip_left_right</span>(<span style=" color: #000087;">image</span>)</p><p class="s56" style="padding-left: 33pt;text-indent: 0pt;text-align: left;"><span class="s54">return </span>image<span style=" color: #000;">, </span>label</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">def </span><span style=" color: #C0F;">get_dataset</span>(<span style=" color: #000087;">dataset_name</span>):</p><p class="s53" style="padding-left: 33pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">split_train</span>, <span style=" color: #000087;">split_val </span>= <span style=" color: #000087;">tfds</span>.<span style=" color: #000087;">Split</span>.<span style=" color: #000087;">TRAIN</span>.<span style=" color: #000087;">subsplit</span>(<span style=" color: #000087;">weighted</span>=[<span style=" color: #F60;">9</span>,<span style=" color: #F60;">1</span>]) <span style=" color: #000087;">train</span>, <span style=" color: #000087;">info_train </span>= <span style=" color: #000087;">tfds</span>.<span style=" color: #000087;">load</span>(<span style=" color: #000087;">dataset_name</span>, <span style=" color: #000087;">split</span>=<span style=" color: #000087;">split_train </span>,</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">with_info</span>=<span class="s54">True</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 11pt;text-align: left;"><span style=" color: #000087;">val</span>, <span style=" color: #000087;">info_val </span>= <span style=" color: #000087;">tfds</span>.<span style=" color: #000087;">load</span>(<span style=" color: #000087;">dataset_name</span>, <span style=" color: #000087;">split</span>=<span style=" color: #000087;">split_val</span>, <span style=" color: #000087;">with_info</span>=<span class="s54">True</span>)</p><p class="s53" style="padding-left: 33pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">NUM_CLASSES </span>= <span style=" color: #000087;">info_train</span>.<span style=" color: #000087;">features</span>[<span style=" color: #C30;">&#39;label&#39;</span>].<span style=" color: #000087;">num_classes </span><span class="s54">assert </span><span style=" color: #000087;">NUM_CLASSES </span>&gt;= <span style=" color: #000087;">info_val</span>.<span style=" color: #000087;">features</span>[<span style=" color: #C30;">&#39;label&#39;</span>].<span style=" color: #000087;">num_classes NUM_EXAMPLES </span>= <span style=" color: #000087;">info_train</span>.<span style=" color: #000087;">splits</span>[<span style=" color: #C30;">&#39;train&#39;</span>].<span style=" color: #000087;">num_examples </span>* <span style=" color: #F60;">O.9</span></p><p class="s53" style="padding-left: 33pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">IMG_H</span>, <span style=" color: #000087;">IMG_W</span>, <span style=" color: #000087;">IMG_CHANNELS </span>= <span style=" color: #000087;">info_train</span>.<span style=" color: #000087;">features</span>[<span style=" color: #C30;">&#39;image&#39;</span>].<span style=" color: #000087;">shape train </span>= <span style=" color: #000087;">train</span>.<span style=" color: #000087;">map</span>(<span style=" color: #000087;">preprocess</span>).<span style=" color: #000087;">cache</span>().</p><p class="s56" style="padding-left: 33pt;text-indent: 47pt;text-align: left;">repeat<span style=" color: #000;">().</span>shuffle<span style=" color: #000;">(</span>SHUFFLE_BUFFER_SIZE<span style=" color: #000;">).</span>batch<span style=" color: #000;">(</span>BATCH_SIZE<span style=" color: #000;">) </span>train <span style=" color: #000;">= </span>train<span style=" color: #000;">.</span>map<span style=" color: #000;">(</span>augmentation<span style=" color: #000;">)</span></p><p class="s56" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">train <span style=" color: #000;">= </span>train<span style=" color: #000;">.</span>prefetch<span style=" color: #000;">(</span>tf<span style=" color: #000;">.</span>data<span style=" color: #000;">.</span>experimental<span style=" color: #000;">.</span>AUTOTUNE<span style=" color: #000;">)</span></p><p class="s56" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">val <span style=" color: #000;">= </span>val<span style=" color: #000;">.</span>map<span style=" color: #000;">(</span>preprocess<span style=" color: #000;">).</span>cache<span style=" color: #000;">().</span>repeat<span style=" color: #000;">().</span>batch<span style=" color: #000;">(</span>BATCH_SIZE<span style=" color: #000;">) </span>val <span style=" color: #000;">= </span>val<span style=" color: #000;">.</span>prefetch<span style=" color: #000;">(</span>tf<span style=" color: #000;">.</span>data<span style=" color: #000;">.</span>experimental<span style=" color: #000;">.</span>AUTOTUNE<span style=" color: #000;">)</span></p><p class="s56" style="padding-left: 33pt;text-indent: 0pt;text-align: left;"><span class="s54">return </span>train<span style=" color: #000;">, </span>info_train<span style=" color: #000;">, </span>val<span style=" color: #000;">, </span>info_val<span style=" color: #000;">, </span>IMG_H<span style=" color: #000;">, </span>IMG_W<span style=" color: #000;">, </span>IMG_CHANNELS<span style=" color: #000;">,</span></p><p class="s56" style="padding-left: 75pt;text-indent: 0pt;text-align: left;">NUM_CLASSES<span style=" color: #000;">, </span>NUM_EXAMPLES</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">train<span style=" color: #000;">, </span>info_train<span style=" color: #000;">, </span>val<span style=" color: #000;">, </span>info_val<span style=" color: #000;">, </span>IMG_H<span style=" color: #000;">, </span>IMG_W<span style=" color: #000;">, </span>IMG_CHANNELS<span style=" color: #000;">,</span></p><p class="s56" style="padding-top: 4pt;padding-left: 21pt;text-indent: 0pt;text-align: left;">NUM_CLASSES<span style=" color: #000;">,</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: justify;">NUM_EXAMPLES <span style=" color: #000;">= </span>get_dataset<span style=" color: #000;">(</span>dataset_name<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: justify;"># Allow TensorBoard callbacks</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: justify;">tensorboard_callback <span style=" color: #000;">= </span>tf<span style=" color: #000;">.</span>keras<span style=" color: #000;">.</span>callbacks<span style=" color: #000;">.</span>TensorBoard<span style=" color: #000;">(</span>LOG_DIR<span style=" color: #000;">,</span></p><p class="s53" style="padding-left: 342pt;text-indent: 0pt;text-align: justify;"><span style=" color: #000087;">histogram_freq</span>=<span style=" color: #F60;">1</span>, <span style=" color: #000087;">write_graph</span>=<span class="s54">True</span>, <span style=" color: #000087;">write_grads</span>=<span class="s54">True</span>,</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-top: 5pt;padding-left: 21pt;text-indent: 0pt;line-height: 206%;text-align: left;"><span style=" color: #000087;">batch_size</span>=<span style=" color: #000087;">BATCH_SIZE</span>, <span style=" color: #000087;">write_images</span>=<span class="s54">True</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 39pt;text-indent: -17pt;text-align: left;"><span class="s54">def </span><span style=" color: #C0F;">transfer_learn</span>(<span style=" color: #000087;">train</span>, <span style=" color: #000087;">val</span>, <span style=" color: #000087;">unfreeze_percentage</span>, <span style=" color: #000087;">learning_rate</span>): <span style=" color: #000087;">mobile_net </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">applications</span>.<span style=" color: #000087;">ResNet5O</span>(<span style=" color: #000087;">input_shape</span>=(<span style=" color: #000087;">IMG_SIZE</span>,</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">IMG_SIZE<span style=" color: #000;">,</span></p><p class="s53" style="padding-left: 39pt;text-indent: 77pt;text-align: left;"><span style=" color: #000087;">IMG_CHANNELS</span>), <span style=" color: #000087;">include_top</span>=<span class="s54">False</span>) <span style=" color: #000087;">mobile_net</span>.<span style=" color: #000087;">trainable</span>=<span class="s54">False</span></p><p class="s60" style="padding-left: 39pt;text-indent: 0pt;text-align: left;"># Unfreeze some of the layers according to the dataset being used</p><p class="s53" style="padding-left: 39pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">num_layers </span>= <span style=" color: #366;">len</span>(<span style=" color: #000087;">mobile_net</span>.<span style=" color: #000087;">layers</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 17pt;text-align: left;"><span class="s54">for </span><span style=" color: #000087;">layer_index </span><b>in </b><span style=" color: #366;">range</span>(<span style=" color: #366;">int</span>(<span style=" color: #000087;">num_layers </span>- <span style=" color: #000087;">unfreeze_percentage</span>*<span style=" color: #000087;">num_layers</span>),</p><p class="s56" style="padding-left: 116pt;text-indent: 77pt;text-align: left;">num_layers <span style=" color: #000;">): </span>mobile_net<span style=" color: #000;">.</span>layers<span style=" color: #000;">[</span>layer_index<span style=" color: #000;">].</span>trainable <span style=" color: #000;">= </span><span class="s54">True</span></p><p class="s56" style="padding-left: 39pt;text-indent: 0pt;text-align: left;">model_with_transfer_learning <span style=" color: #000;">= </span>tf<span style=" color: #000;">.</span>keras<span style=" color: #000;">.</span>Sequential<span style=" color: #000;">([</span>mobile_net<span style=" color: #000;">,</span></p><p class="s53" style="padding-left: 176pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">GlobalAveragePooling2D</span>(), <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">Flatten</span>(), <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">Dense</span>(<span style=" color: #F60;">64</span>), <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">Dropout</span>(<span style=" color: #F60;">O.3</span>), <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">Dense</span>(<span style=" color: #000087;">NUM_CLASSES</span>,</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-top: 5pt;padding-left: 33pt;text-indent: -11pt;text-align: left;"><span style=" color: #000087;">activation</span>=<span style=" color: #C30;">&#39;softmax&#39;</span>)],) <span style=" color: #000087;">model_with_transfer_learning</span>.<span style=" color: #000087;">compile</span>(</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 134pt;text-indent: -112pt;text-align: left;"><span style=" color: #000087;">optimizer</span>=<span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">optimizers</span>.<span style=" color: #000087;">Adam</span>(<span style=" color: #000087;">learning_rate</span>=<span style=" color: #000087;">learning_rate</span>), <span style=" color: #000087;">loss</span>=<span style=" color: #C30;">&#39;sparse_categorical_crossentropy&#39;</span>, <span style=" color: #000087;">metrics</span>=[<span style=" color: #C30;">&quot;accuracy&quot;</span>])</p><p class="s56" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">model_with_transfer_learning<span style=" color: #000;">.</span>summary<span style=" color: #000;">() </span>earlystop_callback <span style=" color: #000;">= </span>tf<span style=" color: #000;">.</span>keras<span style=" color: #000;">.</span>callbacks<span style=" color: #000;">.</span>EarlyStopping<span style=" color: #000;">(</span></p><p class="s53" style="padding-left: 229pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">monitor</span>=<span style=" color: #C30;">&#39;val_accuracy&#39;</span>, <span style=" color: #000087;">min_delta</span>=<span style=" color: #F60;">O.OOO1</span>, <span style=" color: #000087;">patience</span>=<span style=" color: #F60;">5</span>)</p><p class="s56" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">model_with_transfer_learning<span style=" color: #000;">.</span>fit<span style=" color: #000;">(</span>train<span style=" color: #000;">,</span></p><p class="s56" style="padding-left: 229pt;text-indent: 0pt;text-align: left;">epochs<span style=" color: #000;">=</span>NUM_EPOCHS<span style=" color: #000;">,</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">steps_per_epoch</span>=<span style=" color: #366;">int</span>(<span style=" color: #000087;">NUM_EXAMPLES</span>/<span style=" color: #000087;">BATCH_SIZE</span>),</p><p class="s53" style="padding-left: 229pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">validation_data</span>=<span style=" color: #000087;">val</span>, <span style=" color: #000087;">validation_steps</span>=<span style=" color: #F60;">1</span>, <span style=" color: #000087;">validation_freq</span>=<span style=" color: #F60;">1</span>, <span style=" color: #000087;">callbacks</span>=[<span style=" color: #000087;">tensorboard_callback</span>,</p><p class="s56" style="padding-left: 294pt;text-indent: 0pt;text-align: left;">earlystop_callback<span style=" color: #000;">])</span></p><p class="s54" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">return <span class="s56">model_with_transfer_learning</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Start TensorBoard</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">%<span style=" color: #000087;">tensorboard </span>--<span style=" color: #000087;">logdir </span>./<span style=" color: #000087;">log</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Select the last % layers to be trained while using the transfer learning</p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># technique. These layers are the closest to the output layers.</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">unfreeze_percentage <span style=" color: #000;">= .</span><span style=" color: #F60;">33 </span>learning_rate <span style=" color: #000;">= </span><span style=" color: #F60;">O.OO1</span></p><p class="s56" style="padding-top: 4pt;padding-left: 21pt;text-indent: 0pt;text-align: left;">model <span style=" color: #000;">= </span>transfer_learn<span style=" color: #000;">(</span>train<span style=" color: #000;">, </span>val<span style=" color: #000;">, </span>unfreeze_percentage<span style=" color: #000;">, </span>learning_rate<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark443">Basic Custom Network Pipeline</a><a name="bookmark504">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Apart from transfer learning on state-of-the-art models, we can also experiment and develop better intuitions by building our own custom network. Only the model needs to be swapped in the previously defined transfer learning code:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">def <span class="s61">create_model</span><span class="s53">():</span></p><p class="s53" style="padding-left: 51pt;text-indent: -17pt;text-align: left;"><span style=" color: #000087;">model </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">Sequential</span>([ <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">Conv2D</span>(<span style=" color: #F60;">32</span>, (<span style=" color: #F60;">3</span>, <span style=" color: #F60;">3</span>), <span style=" color: #000087;">activation</span>=<span style=" color: #C30;">&#39;relu&#39;</span>,</p><p class="s53" style="padding-left: 51pt;text-indent: 29pt;text-align: left;"><span style=" color: #000087;">input_shape</span>=(<span style=" color: #000087;">IMG_SIZE</span>, <span style=" color: #000087;">IMG_SIZE</span>, <span style=" color: #000087;">IMG_CHANNELS</span>)), <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">MaxPool2D</span>(<span style=" color: #000087;">pool_size</span>=(<span style=" color: #F60;">2</span>, <span style=" color: #F60;">2</span>)),</p><p class="s53" style="padding-left: 51pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">Conv2D</span>(<span style=" color: #F60;">32</span>, (<span style=" color: #F60;">3</span>, <span style=" color: #F60;">3</span>), <span style=" color: #000087;">activation</span>=<span style=" color: #C30;">&#39;relu&#39;</span>),</p><p class="s53" style="padding-left: 51pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">MaxPool2D</span>(<span style=" color: #000087;">pool_size</span>=(<span style=" color: #F60;">2</span>, <span style=" color: #F60;">2</span>)),</p><p class="s53" style="padding-left: 51pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">Conv2D</span>(<span style=" color: #F60;">32</span>, (<span style=" color: #F60;">3</span>, <span style=" color: #F60;">3</span>), <span style=" color: #000087;">activation</span>=<span style=" color: #C30;">&#39;relu&#39;</span>),</p><p class="s53" style="padding-left: 51pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">MaxPool2D</span>(<span style=" color: #000087;">pool_size</span>=(<span style=" color: #F60;">2</span>, <span style=" color: #F60;">2</span>)), <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">Dropout</span>(<span style=" color: #000087;">rate</span>=<span style=" color: #F60;">O.3</span>), <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">Flatten</span>(), <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">Dense</span>(<span style=" color: #F60;">128</span>, <span style=" color: #000087;">activation</span>=<span style=" color: #C30;">&#39;relu&#39;</span>), <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">Dropout</span>(<span style=" color: #000087;">rate</span>=<span style=" color: #F60;">O.3</span>),</p><p class="s53" style="padding-left: 51pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">Dense</span>(<span style=" color: #000087;">NUM_CLASSES</span>, <span style=" color: #000087;">activation</span>=<span style=" color: #C30;">&#39;softmax&#39;</span>)</p><p class="s53" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">])</p><p class="s54" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">return <span class="s56">model</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 33pt;text-indent: -11pt;text-align: left;"><span class="s54">def </span><span style=" color: #C0F;">scratch</span>(<span style=" color: #000087;">train</span>, <span style=" color: #000087;">val</span>, <span style=" color: #000087;">learning_rate</span>): <span style=" color: #000087;">model </span>= <span style=" color: #000087;">create_model</span>()</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">model<span style=" color: #000;">.</span>compile<span style=" color: #000;">(</span>optimizer<span style=" color: #000;">=</span>tf<span style=" color: #000;">.</span>keras<span style=" color: #000;">.</span>optimizers<span style=" color: #000;">.</span>Adam<span style=" color: #000;">(</span>learning_rate<span style=" color: #000;">=</span>learning</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">_rate<span style=" color: #000;">),</span></p><p class="s53" style="padding-left: 122pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">loss</span>=<span style=" color: #C30;">&#39;sparse_categorical_crossentropy&#39;</span>, <span style=" color: #000087;">metrics</span>=[<span style=" color: #C30;">&#39;accuracy&#39;</span>])</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 122pt;text-indent: -89pt;text-align: left;"><span style=" color: #000087;">earlystop_callback </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">callbacks</span>.<span style=" color: #000087;">EarlyStopping</span>( <span style=" color: #000087;">monitor</span>=<span style=" color: #C30;">&#39;val_accuracy&#39;</span>, <span style=" color: #000087;">min_delta</span>=<span style=" color: #F60;">O.OOO1</span>,</p><p class="s53" style="padding-left: 122pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">patience</span>=<span style=" color: #F60;">5</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">model<span style=" color: #000;">.</span>fit<span style=" color: #000;">(</span>train<span style=" color: #000;">,</span></p><p class="s53" style="padding-left: 87pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">epochs</span>=<span style=" color: #000087;">NUM_EPOCHS</span>, <span style=" color: #000087;">steps_per_epoch</span>=<span style=" color: #366;">int</span>(<span style=" color: #000087;">NUM_EXAMPLES</span>/<span style=" color: #000087;">BATCH_SIZE</span>), <span style=" color: #000087;">validation_data</span>=<span style=" color: #000087;">val</span>,</p><p class="s53" style="padding-left: 87pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">validation_steps</span>=<span style=" color: #F60;">1</span>, <span style=" color: #000087;">validation_freq</span>=<span style=" color: #F60;">1</span>,</p><p class="s56" style="padding-left: 87pt;text-indent: 0pt;text-align: left;">callbacks<span style=" color: #000;">=[</span>tensorboard_callback<span style=" color: #000;">, </span>earlystop_callback<span style=" color: #000;">])</span></p><p class="s54" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">return <span class="s56">model</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark505">Now, it’s time to use our pipeline for various experiments.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark444">How Hyperparameters Affect Accuracy</a><a name="bookmark506">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark507">In this section, we aim to modify various parameters of a deep learning pipeline one at a time — from the number of layers fine- tuned, to the choice of the activation function used — and see its effect primarily on validation accuracy. Additionally, when relevant, we also observe its effect on the speed of training and time to reach the best accuracy (i.e., convergence).</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Our experimentation setup is as follows:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_309.png"/></span></p><p style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">To reduce experimentation time, we have used a faster architecture — MobileNet — in this chapter.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_310.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">We reduced the input image resolution to 128 x 128 pixels to further speed up training. In general, we would recommend using a higher resolution (at least 224 x 224) for production systems.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_311.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Early stopping is applied to stop experiments if they don’t increase in accuracy for 10 consecutive epochs.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_312.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">For training with transfer learning, we generally unfreeze the last 33% of the layers.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_313.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Learning rate is set to 0.001 with Adam optimizer.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_314.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">We’re mostly using the Oxford Flowers 102 dataset for testing, unless otherwise stated. We chose this dataset because it is reasonably difficult to train on due to the large number of classes it contains (102) and the similarities between many of the classes that force networks to develop a fine-grained understanding of features in order to do well.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_315.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">To make apples-to-apples comparisons, we take the maximum accuracy value in a particular experiment and normalize all other accuracy values within that experiment with respect to this maximum value.</p><p class="s45" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s63" target="_blank">Based on these and other experiments, we have compiled a checklist of actionable tips to implement in your next model training adventure. These are available on the book’s GitHub (see </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">http://PracticalDeepLearning.ai</span><a href="https://twitter.com/PracticalDLBook" class="s63" target="_blank">) along with interactive visualizations. If you have more tips, feel free to tweet them </a>@PracticalDLBook <span style=" color: #000;">or submit a pull request.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark445">Transfer Learning Versus Training from Scratch</a><a name="bookmark508">&zwnj;</a></p><p class="s43" style="padding-top: 17pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Experimental setup</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark509">Train two models: one using transfer learning, and one from scratch on the same dataset.</a></p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Datasets used</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Oxford Flowers 102, Colorectal Histology</p><p class="s43" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Architectures used</p><p class="s45" style="padding-top: 4pt;padding-left: 6pt;text-indent: 29pt;line-height: 142%;text-align: left;"><a href="#bookmark510" class="s63">Pretrained MobileNet, Custom model </a>Figure 5-10 <span style=" color: #000;">shows the results.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 14pt;text-indent: 0pt;text-align: left;"><span><img width="575" height="184" alt="image" src="KerasTensorFlow2019/Image_316.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 180pt;text-indent: -160pt;line-height: 108%;text-align: left;"><a name="bookmark510">Figure 5-10. Comparing transfer learning versus training a custom model on different datasets</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Here are the key takeaways:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_317.png"/></span></p><p style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Transfer learning leads to a quicker rise in accuracy during training by reusing previously learned features.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_318.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Although it is expected that transfer learning (based on pretrained models on ImageNet) would work when the target dataset is also of natural imagery, the patterns learned in the early layers by a network work surprisingly well for datasets beyond ImageNet. That does not necessarily mean that it will yield the best results, but it can get close. When the images match more real-world images that the model was pretrained on, we get relatively quick improvement in accuracy.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark446">Effect of Number of Layers Fine-Tuned in Transfer Learning</a><a name="bookmark511">&zwnj;</a></p><p class="s43" style="padding-top: 16pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Experimental setup</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark512">Vary the percentage of trainable layers from 0 to 100%</a></p><p class="s43" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Dataset used</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Oxford Flowers 102</p><p class="s43" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Architecture used</p><p class="s45" style="padding-top: 4pt;padding-left: 6pt;text-indent: 29pt;line-height: 142%;text-align: left;"><a href="#bookmark513" class="s63">Pretrained MobileNet </a>Figure 5-11 <span style=" color: #000;">shows the results.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 16pt;text-indent: 0pt;text-align: left;"><span><img width="573" height="284" alt="image" src="KerasTensorFlow2019/Image_319.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark513">Figure 5-11. Effect of % layers fine-tuned on model accuracy</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Here are the key takeaways:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_320.png"/></span></p><p style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">The higher the number of layers fine-tuned, the fewer epochs it took to reach convergence and the higher the accuracy.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_321.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">The higher the number of layers fine-tuned, the more time it took per epoch for training, due to more computation and updates involved.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_322.png"/></span></p><p style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">For a dataset that required fine-grained understanding of images, making more layers task specific by unfreezing them was the key to a better model.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark447">Effect of Data Size on Transfer Learning</a><a name="bookmark514">&zwnj;</a></p><p class="s43" style="padding-top: 17pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Experimental setup</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark515">Add one image per class at a time</a></p><p class="s43" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Dataset used</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Cats versus dogs</p><p class="s43" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Architecture used</p><p class="s45" style="padding-top: 4pt;padding-left: 6pt;text-indent: 29pt;line-height: 142%;text-align: left;"><a href="#bookmark516" class="s63">Pretrained MobileNet </a>Figure 5-12 <span style=" color: #000;">shows the results.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;text-align: left;"><span><img width="584" height="328" alt="image" src="KerasTensorFlow2019/Image_323.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 26pt;text-indent: 0pt;text-align: left;"><a name="bookmark516">Figure 5-12. Effect of the amount of data per category on model accuracy</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Here are the key takeaways:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_324.png"/></span></p><p style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Even with only three images in each class, the model was able to predict with close to 90% accuracy. This shows how powerful transfer learning can be in reducing data requirements.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_325.png"/></span></p><p style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Because ImageNet has several cats and dogs, pretrained networks on ImageNet suited our dataset much more easily. More difficult datasets like Oxford Flowers 102 might require a much higher number of images to achieve similar accuracies.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark448">Effect of Learning Rate</a><a name="bookmark517">&zwnj;</a></p><p class="s43" style="padding-top: 17pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Experimental setup</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark518">Vary the learning rate between .1, .01, .001, and .0001</a></p><p class="s43" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Dataset used</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Oxford Flowers 102</p><p class="s43" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Architecture used</p><p class="s45" style="padding-top: 4pt;padding-left: 6pt;text-indent: 29pt;line-height: 142%;text-align: left;"><a href="#bookmark519" class="s63">Pretrained MobileNet </a>Figure 5-13 <span style=" color: #000;">shows the results.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span><img width="560" height="327" alt="image" src="KerasTensorFlow2019/Image_326.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 10pt;padding-left: 192pt;text-indent: -149pt;line-height: 108%;text-align: left;"><a name="bookmark519">Figure 5-13. Effect of learning rate on model accuracy and speed of convergence</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Here are the key takeaways:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_327.png"/></span></p><p style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Too high of a learning rate, and the model might never converge.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_328.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Too low a learning rate results in a long time taken to convergence.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_329.png"/></span></p><p style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Striking the right balance is crucial in training quickly.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark449">Effect of Optimizers</a><a name="bookmark520">&zwnj;</a></p><p class="s43" style="padding-top: 17pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Experimental setup</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark521">Experiment with available optimizers including AdaDelta, AdaGrad, Adam, Gradient Descent, Momentum, and RMSProp</a></p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Dataset used</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Oxford Flowers 102</p><p class="s43" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Architecture used</p><p class="s45" style="padding-top: 4pt;padding-left: 6pt;text-indent: 29pt;line-height: 142%;text-align: left;"><a href="#bookmark522" class="s63">Pretrained MobileNet </a>Figure 5-14 <span style=" color: #000;">shows the results.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 16pt;text-indent: 0pt;text-align: left;"><span><img width="570" height="269" alt="image" src="KerasTensorFlow2019/Image_330.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 34pt;text-indent: 0pt;text-align: left;"><a name="bookmark522">Figure 5-14. Effect of different optimizers on the speed of convergence</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Here are the key takeaways:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_331.png"/></span></p><p style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Adam is a great choice for faster convergence to high accuracy.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_332.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">RMSProp is usually better for RNN tasks.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark450">Effect of Batch Size</a><a name="bookmark523">&zwnj;</a></p><p class="s43" style="padding-top: 17pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Experimental setup</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark524">Vary batch sizes in powers of two</a></p><p class="s43" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Dataset used</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Oxford Flowers 102</p><p class="s43" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Architecture used</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Pretrained</p><p class="s45" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Figure 5-15 <span style=" color: #000;">shows the results.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;text-align: left;"><span><img width="561" height="307" alt="image" src="KerasTensorFlow2019/Image_333.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 30pt;text-indent: 0pt;text-align: left;"><a name="bookmark525">Figure 5-15. Effect of batch size on accuracy and speed of convergence</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Here are the key takeaways:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_334.png"/></span></p><p style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">The higher the batch size, the more the instability in results from epoch to epoch, with bigger rises and drops. But higher accuracy also leads to more efficient GPU utilization, so faster speed per epoch.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_335.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Too low a batch size slows the rise in accuracy.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_336.png"/></span></p><p style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">16/32/64 are good to start batch sizes with.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark451">Effect of Resizing</a><a name="bookmark526">&zwnj;</a></p><p class="s43" style="padding-top: 17pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Experimental setup</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark527">Change image size to 128x128, 224x224</a></p><p class="s43" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Dataset used</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Oxford Flowers 102</p><p class="s43" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Architecture used</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Pretrained</p><p class="s45" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Figure 5-16 <span style=" color: #000;">shows the results.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span><img width="567" height="297" alt="image" src="KerasTensorFlow2019/Image_337.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark528">Figure 5-16. Effect of image size on accuracy</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Here are the key takeaways:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_338.png"/></span></p><p style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Even with a third of the pixels, there wasn’t a significant difference in validation accuracies. On the one hand, this shows the robustness of CNNs. It might partly be because the Oxford Flowers 102 dataset has close-ups of flowers visible.</p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">For datasets in which the objects have much smaller portions in an image, the results might be lower.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark452">Effect of Change in Aspect Ratio on Transfer Learning</a><a name="bookmark529">&zwnj;</a></p><p class="s43" style="padding-top: 16pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Experimental Setup</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark530">Take images of various aspect ratios (width:height ratio) and resize them to a square (1:1 aspect ratio).</a></p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Dataset Used</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Cats vs. Dogs</p><p class="s43" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Architecture Used</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Pretrained</p><p class="s45" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Figure 5-17 <span style=" color: #000;">shows the results.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="210" alt="image" src="KerasTensorFlow2019/Image_339.jpg"/></span></p><p class="s50" style="padding-top: 8pt;padding-left: 8pt;text-indent: 0pt;text-align: left;"><a name="bookmark531">Figure 5-17. Distribution of aspect ratio and corresponding accuracies in images</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Here are the key takeaways:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_340.png"/></span></p><p style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Most common aspect ratio is 4:3; that is, 1.33, whereas our neural networks are generally trained at 1:1 ratio.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_341.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: justify;"><a name="bookmark532">Neural networks are relatively robust to minor modifications in aspect ratio brought upon by resizing to a square shape. Even up to 2.0 ratio gives decent results.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark453">Tools to Automate Tuning for Maximum Accuracy</a><a name="bookmark533">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark534">As we have seen since the rise of the nineteenth century, automation has always led to an increase in productivity. In this section, we investigate tools that can help us automate the search for the best model.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark454">Keras Tuner</a><a name="bookmark535">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark536">With so many potential combinations of hyperparameters to tune, coming up with the best model can be a tedious process. Often two or more parameters might have correlated effects on the overall speed of convergence as well as validation accuracy, so tuning one at a time might not lead to the best model. And if curiosity gets the best of us, we might want to experiment on all the hyperparameters together.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Keras Tuner comes in to automate this hyperparameter search. We define a search algorithm, the potential values that each parameter can take (e.g., discrete values or a range), our target object to maximize (e.g., validation accuracy), and sit back to see the program start training. Keras Tuner conducts multiple experiments changing the parameters on our behalf, storing the metadata of the best model. The following code example adapted from Keras Tuner documentation showcases searching through the different model architectures (varying in the number of layers between 2 and 10) as well as varying the learning rate (between 0.1 and 0.001):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">tensorflow </span>import <span class="s56">keras</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">tensorflow.keras </span>import <span class="s56">layers</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">numpy </span>as <span style=" color: #0CF;">np</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">kerastuner.engine.hypermodel </span>import <span class="s56">HyperModel</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">kerastuner.engine.hyperparameters </span>import <span class="s56">HyperParameters</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Input data</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">(<span style=" color: #000087;">x</span>, <span style=" color: #000087;">y</span>), (<span style=" color: #000087;">val_x</span>, <span style=" color: #000087;">val_y</span>) = <span style=" color: #000087;">keras</span>.<span style=" color: #000087;">datasets</span>.<span style=" color: #000087;">mnist</span>.<span style=" color: #000087;">load_data</span>() <span style=" color: #000087;">x </span>= <span style=" color: #000087;">x</span>.<span style=" color: #000087;">astype</span>(<span style=" color: #C30;">&#39;float32&#39;</span>) / <span style=" color: #F60;">255.</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">val_x </span>= <span style=" color: #000087;">val_x</span>.<span style=" color: #000087;">astype</span>(<span style=" color: #C30;">&#39;float32&#39;</span>) / <span style=" color: #F60;">255.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Defining hyper parameters</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">hp </span>= <span style=" color: #000087;">HyperParameters</span>() <span style=" color: #000087;">hp</span>.<span style=" color: #000087;">Choice</span>(<span style=" color: #C30;">&#39;learning_rate&#39;</span>, [<span style=" color: #F60;">O.1</span>, <span style=" color: #F60;">O.OO1</span>]) <span style=" color: #000087;">hp</span>.<span style=" color: #000087;">Int</span>(<span style=" color: #C30;">&#39;num_layers&#39;</span>, <span style=" color: #F60;">2</span>, <span style=" color: #F60;">1O</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Defining model with expandable number of layers</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">def </span><span style=" color: #C0F;">build_model</span>(<span style=" color: #000087;">hp</span>):</p><p class="s53" style="padding-left: 45pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">model </span>= <span style=" color: #000087;">keras</span>.<span style=" color: #000087;">Sequential</span>() <span style=" color: #000087;">model</span>.<span style=" color: #000087;">add</span>(<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">Flatten</span>(<span style=" color: #000087;">input_shape</span>=(<span style=" color: #F60;">28</span>, <span style=" color: #F60;">28</span>))) <span class="s54">for </span><span style=" color: #000087;">_ </span><b>in </b><span style=" color: #366;">range</span>(<span style=" color: #000087;">hp</span>.<span style=" color: #000087;">get</span>(<span style=" color: #C30;">&#39;num_layers&#39;</span>)):</p><p class="s53" style="padding-left: 45pt;text-indent: 23pt;text-align: left;"><span style=" color: #000087;">model</span>.<span style=" color: #000087;">add</span>(<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">Dense</span>(<span style=" color: #F60;">32</span>, <span style=" color: #000087;">activation</span>=<span style=" color: #C30;">&#39;relu&#39;</span>)) <span style=" color: #000087;">model</span>.<span style=" color: #000087;">add</span>(<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">Dense</span>(<span style=" color: #F60;">1O</span>, <span style=" color: #000087;">activation</span>=<span style=" color: #C30;">&#39;softmax&#39;</span>)) <span style=" color: #000087;">model</span>.<span style=" color: #000087;">compile</span>(</p><p class="s53" style="padding-top: 4pt;padding-left: 69pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">optimizer</span>=<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">optimizers</span>.<span style=" color: #000087;">Adam</span>(<span style=" color: #000087;">hp</span>.<span style=" color: #000087;">get</span>(<span style=" color: #C30;">&#39;learning_rate&#39;</span>)), <span style=" color: #000087;">loss</span>=<span style=" color: #C30;">&#39;sparse_categorical_crossentropy&#39;</span>, <span style=" color: #000087;">metrics</span>=[<span style=" color: #C30;">&#39;accuracy&#39;</span>])</p><p class="s54" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">return <span class="s56">model</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">hypermodel <span style=" color: #000;">= </span>RandomSearch<span style=" color: #000;">(</span></p><p class="s56" style="padding-left: 98pt;text-indent: 0pt;text-align: left;">build_model<span style=" color: #000;">,</span></p><p class="s53" style="padding-left: 98pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">max_trials</span>=<span style=" color: #F60;">2O</span>, <span class="s60"># Number of combinations allowed</span></p><p class="s53" style="padding-left: 98pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">hyperparameters</span>=<span style=" color: #000087;">hp</span>, <span style=" color: #000087;">allow_new_entries</span>=<span class="s54">False</span>, <span style=" color: #000087;">objective</span>=<span style=" color: #C30;">&#39;val_accuracy&#39;</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">hypermodel<span style=" color: #000;">.</span>search<span style=" color: #000;">(</span>x<span style=" color: #000;">=</span>x<span style=" color: #000;">,</span></p><p class="s53" style="padding-left: 98pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">y</span>=<span style=" color: #000087;">y</span>, <span style=" color: #000087;">epochs</span>=<span style=" color: #F60;">5</span>,</p><p class="s56" style="padding-left: 98pt;text-indent: 0pt;text-align: left;">validation_data<span style=" color: #000;">=(</span>val_x<span style=" color: #000;">, </span>val_y<span style=" color: #000;">))</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Show summary of overall best model</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">hypermodel<span style=" color: #000;">.</span>results_summary<span style=" color: #000;">()</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Each experiment will show values like this:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">&gt; Hp values:</p><p class="s53" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">|-learning_rate: O.OO1</p><p class="s53" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">|-num_layers: 6</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">┌──────────────┬────────────┬───────────────┐</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">│ Name │ Best model │ Current model │</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">├──────────────┼────────────┼───────────────┤</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">│ accuracy │ O.9911 │ O.9911 │</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">│ loss │ O.O292 │ O.O292 │</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">│ val_loss │ O.227 │ O.227 │</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">│ val_accuracy │ O.94O6 │ O.94O6 │</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">└──────────────┴────────────┴───────────────┘</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">On the experiment end, the result summary gives a snapshot of the experiments conducted so far, and saves more metadata.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">Hypertuning complete - results in ./untitled_project [Results summary]</p><p class="s53" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">|-Results in ./untitled_project</p><p class="s53" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">|-Ran 2O trials</p><p class="s53" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">|-Ran 2O executions (1 per trial)</p><p class="s53" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">|-Best val_accuracy: O.94O6</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://keras-tuner.appspot.com/" class="s63" target="_blank">Another big benefit is the ability to track experiments online in real time and get notifications on their progress by visiting </a><a href="http://keras-tuner.appspot.com/" class="s46" target="_blank">http://keras- tuner.appspot.com</a>, getting an API key (from Google App Engine), and entering the following line in our Python program along with the real API key:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">tuner<span style=" color: #000;">.</span>enable_cloud<span style=" color: #000;">(</span>api_key<span style=" color: #000;">=</span>api_key<span style=" color: #000;">)</span></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Due to the potentially large combinatorial space, random search is preferred to grid search as a more practical way to get to a good solution on a limited experimentation budget. But there are faster ways, including Hyperband (Lisha Li et al.), whose implementation is also available in Keras Tuner.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark537">For computer-vision problems, Keras Tuner includes ready-to-use tunable applications like HyperResNet.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark455">AutoAugment</a><a name="bookmark538">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark539">Another example hyperparameter are augmentations. Which augmentations to use? How much magnitude to augment? Would combining one too many make matters worse? Instead of leaving these decisions to humans, we can let AI decide. AutoAugment utilizes reinforcement learning to come up with the best combination of augmentations (like translation, rotation, shearing) and the probabilities and magnitudes to apply, to maximize the validation accuracy. (The method was applied by Ekin D. Cubuk et al. to come up with the new state-of-the-art ImageNet validation numbers.) By learning the best combination of augmentation parameters on ImageNet, we can readily apply it to our problem.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Applying the prelearned augmentation strategy from ImageNet is pretty simple:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">PIL </span>import <span class="s56">Image</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">from </span><span class="s55">autoaugment </span><span class="s54">import </span><span style=" color: #000087;">ImageNetPolicy img </span>= <span style=" color: #000087;">Image</span>.<span style=" color: #000087;">open</span>(<span style=" color: #C30;">&quot;cat.jpg&quot;</span>)</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">policy <span style=" color: #000;">= </span>ImageNetPolicy<span style=" color: #000;">()</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">imgs </span>= [<span style=" color: #000087;">policy</span>(<span style=" color: #000087;">img</span>) <span class="s54">for </span><span style=" color: #000087;">_ </span><b>in </b><span style=" color: #366;">range</span>(<span style=" color: #F60;">8</span>) ]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Figure 5-18 <span style=" color: #000;">displays the results.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="587" height="290" alt="image" src="KerasTensorFlow2019/Image_342.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 136pt;text-indent: -106pt;line-height: 108%;text-align: left;"><a name="bookmark540">Figure 5-18. Output of augmentation strategies learned by reinforcement learning on the ImageNet dataset</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark456">AutoKeras</a><a name="bookmark541">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark542">With AI automating more and more jobs, it is no surprise it can finally automate designing AI architectures, too. NAS approaches utilize reinforcement learning to join together mini-architectural blocks until they are able to maximize the objective function; in other words, our validation accuracy. The current state-of-the-art networks are all based on NAS, leaving human-designed architectures in the dust. Research in this area started showing promising results in 2017, with a bigger focus on making train faster in 2018. And now with AutoKeras (Haifeng Jin et al.), we can also apply this state-of-the-art technique on our particular datasets in a relatively accessible manner.</a><a name="bookmark543">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Generating new model architectures with AutoKeras is a matter of supplying our images and associated labels as well as a time limit by which to finish running the jobs. Internally, it implements several optimization algorithms, including a Bayesian optimization approach to search for an optimal architecture:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s82" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">!<span style=" color: #000087;">pip3 install autokeras</span></p><p class="s82" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">!<span style=" color: #000087;">pip3 install graphviz</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">keras.datasets </span>import <span class="s56">mnist</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">autokeras.image.image_supervised </span>import <span class="s56">ImageClassifier</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">(<span style=" color: #000087;">x_train</span>, <span style=" color: #000087;">y_train</span>), (<span style=" color: #000087;">x_test</span>, <span style=" color: #000087;">y_test</span>) = <span style=" color: #000087;">mnist</span>.<span style=" color: #000087;">load_data</span>() <span style=" color: #000087;">x_train </span>= <span style=" color: #000087;">x_train</span>.<span style=" color: #000087;">reshape</span>(<span style=" color: #000087;">x_train</span>.<span style=" color: #000087;">shape </span>+ (<span style=" color: #F60;">1</span>,))</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">x_test </span>= <span style=" color: #000087;">x_test</span>.<span style=" color: #000087;">reshape</span>(<span style=" color: #000087;">x_test</span>.<span style=" color: #000087;">shape </span>+ (<span style=" color: #F60;">1</span>,))</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">clf </span>= <span style=" color: #000087;">ImageClassifier</span>(<span style=" color: #000087;">path</span>=<span style=" color: #C30;">&quot;.&quot;</span>,<span style=" color: #000087;">verbose</span>=<span class="s54">True</span>, <span style=" color: #000087;">augment</span>=<span class="s54">False</span>) <span style=" color: #000087;">clf</span>.<span style=" color: #000087;">fit</span>(<span style=" color: #000087;">x_train</span>, <span style=" color: #000087;">y_train</span>, <span style=" color: #000087;">time_limit</span>= <span style=" color: #F60;">3O </span>* <span style=" color: #F60;">6O</span>) <span class="s60"># 30 minutes </span><span style=" color: #000087;">clf</span>.<span style=" color: #000087;">final_fit</span>(<span style=" color: #000087;">x_train</span>, <span style=" color: #000087;">y_train</span>, <span style=" color: #000087;">x_test</span>, <span style=" color: #000087;">y_test</span>, <span style=" color: #000087;">retrain</span>=<span class="s54">True</span>) <span style=" color: #000087;">y </span>= <span style=" color: #000087;">clf</span>.<span style=" color: #000087;">evaluate</span>(<span style=" color: #000087;">x_test</span>, <span style=" color: #000087;">y_test</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #366;">print</span>(<span style=" color: #000087;">y</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Save the model as a pickle file</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;line-height: 206%;text-align: left;"><span style=" color: #000087;">clf</span>.<span style=" color: #000087;">export_autokeras_model</span>(<span style=" color: #C30;">&quot;model.pkl&quot;</span>) <span style=" color: #000087;">visualize</span>(<span style=" color: #C30;">&#39;.&#39;</span>)</p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark544">Post-training, we are all eager to learn how the new model architecture looks. Unlike most of the cleaner-looking images we generally get to see, this will look pretty obfuscated to understand or print out. But what we do find faith in is that it yields high accuracy.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark457">Summary</a><a name="bookmark545">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s63" target="_blank">In this chapter, we saw a range of tools and techniques to help investigate opportunities to improve our CNN accuracy. Building a case for iterative experimentation, you learned how tuning hyperparameters can bring about optimal performance. And with so many hyperparameters to choose from, we then looked at automated approaches, including AutoKeras, AutoAugment, and Keras Tuner. Best of all, the core code for this chapter combining multiple tools in a single Colab file is available online on the book’s GitHub (see </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">http://PracticalDeepLearning.ai</span>) and can easily be tuned to more than 100 datasets with a single line change and run online in the browser. Additionally, we compiled a checklist of actionable tips along with interactive experiments hosted online to help give your model a little extra edge. We hope that the material covered in this chapter will help make your models more robust, reduce bias, make them more explainable, and ultimately contribute to the responsible development of AI.</p><h4 style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 106%;text-align: left;"><a name="bookmark546">Chapter 6. Maximizing Speed and Performance of TensorFlow: A Handy Checklist</a><a name="bookmark599">&zwnj;</a></h4><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="582" height="1" alt="image" src="KerasTensorFlow2019/Image_343.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Life is all about making do with what we have, and optimization is the name of the game.</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">It’s not about having everything — it’s about using your resources wisely. Maybe we really want to buy that Ferrari, but our budget allows for a Toyota. You know what, though? With the right kinds of performance tuning, we can make that bad boy race at NASCAR!</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Let’s look at this in terms of the deep learning world. Google, with its engineering might and TPU pods capable of boiling the ocean, set a speed record by training ImageNet in just about 30 minutes! And yet, just a few months later, a ragtag team of three researchers (Andrew Shaw, Yaroslav Bulatov, and Jeremy Howard), with $40 in their pockets using a public cloud, were able to train ImageNet in only 18 minutes!</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">The lesson we can draw from these examples is that the amount of resources that you have is not nearly as important as using them to their maximum potential. It’s all about doing more with less. In that spirit, this chapter is meant to serve as a handy checklist of potential performance optimizations that we can make when building all stages of the deep learning pipelines, and will be useful throughout the book. Specifically, we will discuss optimizations related to data preparation, data reading, data augmentation, training, and finally inference.</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">And the story starts and ends with two words...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s84" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark547">GPU Starvation</a><a name="bookmark600">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark601">A commonly asked question by AI practitioners is, “Why is my training so slow?” The answer more often than not is GPU starvation.</a></p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">GPUs are the lifelines of deep learning. They can also be the most expensive component in a computer system. In light of that, we want to fully utilize them. This means that a GPU should not need to wait for data to be available from other components for processing. Rather, when the GPU is ready to process, the preprocessed data should already be available at its doorstep and ready to go. Yet, the reality is that the CPU, memory, and storage are frequently the performance bottlenecks, resulting in suboptimal utilization of the GPU. In other words, we want the GPU to be the bottleneck, not the other way round.</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Buying expensive GPUs for thousands of dollars can be worthwhile, but only if the GPU is the bottleneck to begin with. Otherwise, we might as well burn the cash.</p><p class="s100" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark602" class="s110">To illustrate this better, consider </a>Figure 6-1<span style=" color: #000;">. In a deep learning pipeline, the CPU and GPU work in collaboration, passing data to each other.</span></p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">The CPU reads the data, performs preprocessing steps including augmentations, and then passes it on to the GPU for training. Their collaboration is like a relay race, except one of the relay runners is an Olympic athlete, waiting for a high school track runner to pass the baton. The more time the GPU stays idle, the more wasted resources.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><span><img width="559" height="56" alt="image" src="KerasTensorFlow2019/Image_344.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s86" style="padding-top: 4pt;padding-left: 29pt;text-indent: 0pt;text-align: left;"><a name="bookmark602">Figure 6-1. GPU starvation, while waiting for CPU to finish preparing the data</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">A large portion of this chapter is devoted to reducing the idle time of the GPU and the CPU.</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">A logical question to ask is: how do we know whether the GPU is starving? Two handy tools can help us answer this question:</p><p class="s87" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">nvidia-smi</p><p class="s83" style="padding-top: 3pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">This command shows GPU statistics including utilization.</p><p class="s88" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">TensorFlow Profiler + TensorBoard</p><p class="s83" style="padding-top: 3pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">This visualizes program execution interactively in a timeline within TensorBoard.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark548">nvidia-smi</a><a name="bookmark603">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;"><a name="bookmark604">Short for NVIDIA System Management Interface program, </a><span class="s90">nvidia-smi </span>provides detailed statistics about our precious GPUs, including memory, utilization, temperature, power wattage, and more. It’s a geek’s dream come true.</p><p class="s83" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Let’s take it for a test drive:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">$ nvidia-smi</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s100" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Figure 6-2 <span style=" color: #000;">shows the result.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><span><img width="562" height="313" alt="image" src="KerasTensorFlow2019/Image_345.jpg"/></span></p><p class="s86" style="padding-top: 5pt;padding-left: 41pt;text-indent: 0pt;text-align: left;"><a name="bookmark605">Figure 6-2. Terminal output of </a><span class="s92">nvidia-smi </span>highlighting the GPU utilization</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">While training a network, the key figure we are interested in is the GPU utilization, defined in the documentation as the percent of time over the past second during which <i>one or more </i>kernels was executing on the GPU. Fifty-one percent is frankly not that great. But this is utilization at the moment in time when <span class="s90">nvidia-smi </span>is called. How do we continuously monitor these numbers? To better understand the GPU usage, we can refresh the utilization metrics every half a second with the <span class="s90">watch </span>command (it’s worth memorizing this command):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">$ watch -n .5 nvidia-smi</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="533" height="118" alt="image" src="KerasTensorFlow2019/Image_346.png"/></span></p><p class="s93" style="padding-top: 9pt;padding-left: 179pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s94" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;">Although GPU utilization is a good proxy for measuring the efficiency of our pipeline, it does not alone measure how well we’re using the GPU, because the work could still be using a small fraction of the GPU’s resources.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s83" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Because staring at the terminal screen with the number jumping around is not the most optimal way to analyze, we can instead poll the GPU utilization every second and dump that into a file. Run this for about 30 seconds while any GPU-related process is running on our system and stop it by pressing Ctrl+C:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">$ nvidia-smi --query-gpu=utilization.gpu --format=csv,noheader,nounits -f gpu_utilization.csv -l 1</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Now, calculate the median GPU utilization from the file generated:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="533" height="118" alt="image" src="KerasTensorFlow2019/Image_347.png"/></span></p><p class="s93" style="padding-top: 9pt;padding-left: 179pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s94" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="https://www.gnu.org/software/datamash/" style=" color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11.5pt;" target="_blank">Datamash is a handy command-line tool that performs basic numeric, textual, and statistical operations on textual data files. You can find instructions to install it at </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 11.5pt;">https://www.gnu.org/software/datamash/</span>.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">$ sort -n gpu_utilization.csv | grep -v &#39;^O$&#39; | datamash median 1</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s90" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;"><a name="bookmark606">nvidia-smi </a><span class="s83">is the most convenient way to check our GPU utilization on the command line. Could we get a deeper analysis? It turns out, for advanced users, TensorFlow provides a powerful set of tools.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark549">TensorFlow Profiler + TensorBoard</a><a name="bookmark607">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="533" height="100" alt="image" src="KerasTensorFlow2019/Image_348.png"/></span></p><p class="s93" style="padding-top: 9pt;padding-left: 179pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s94" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">As of this writing, TensorBoard is fully supported only in Google Chrome and might not show the profile view in other browsers, like Firefox.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark608">TensorFlow ships with </a><span class="s90">tfprof </span><a href="#bookmark609" class="s110">(</a><span style=" color: #8E0012;">Figure 6-3</span>), the TensorFlow profiler to help analyze and understand the training process at a much deeper level, such as generating a detailed model analysis report for each operation in our model. But the command line can be a bit daunting to navigate. Luckily, TensorBoard, a suite of browser-based visualization tools for TensorFlow, includes a plugin for the profiler that lets us interactively debug the network with a few mouse clicks. This includes Trace Viewer, a feature that shows events in a timeline. It helps investigate how resources are being used precisely at a given period of time and spot inefficiencies.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><span><img width="558" height="120" alt="image" src="KerasTensorFlow2019/Image_349.jpg"/></span></p><p class="s86" style="padding-top: 6pt;padding-left: 69pt;text-indent: -51pt;text-align: left;"><a name="bookmark609">Figure 6-3. Profiler’s timeline in TensorBoard shows an idle GPU while the CPU is processing as well as CPU idling while the GPU is processing</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">TensorBoard, by default, has the profiler enabled. Activating TensorBoard involves a simple callback function:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">tensorboard_callback </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">callbacks</span>.<span style=" color: #000087;">TensorBoard</span>(<span style=" color: #000087;">log_dir</span>=<span style=" color: #C30;">&quot;/tmp&quot;</span>,</p><p class="s91" style="padding-left: 321pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">profile_batch</span>=<span style=" color: #F60;">7</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s96" style="padding-top: 5pt;padding-left: 20pt;text-indent: 0pt;text-align: left;">model<span style=" color: #000;">.</span>fit<span style=" color: #000;">(</span>train_data<span style=" color: #000;">,</span></p><p class="s91" style="padding-left: 76pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">steps_per_epoch</span>=<span style=" color: #F60;">1O</span>, <span style=" color: #000087;">epochs</span>=<span style=" color: #F60;">2</span>,</p><p class="s91" style="padding-left: 76pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">callbacks</span>=[<span class="s99">tensorboard_callback</span>])</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 119%;text-align: left;">When initializing the callback, unless <span class="s90">profile_batch </span>is explicitly specified, it profiles the second batch. Why the second batch? Because</p><p style="text-indent: 0pt;text-align: left;"><span><img width="533" height="176" alt="image" src="KerasTensorFlow2019/Image_350.png"/></span></p><p class="s93" style="padding-top: 9pt;padding-left: 179pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s94" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 107%;text-align: left;">It bears reiterating that profiling using TensorBoard is best suited for power users of TensorFlow. If you are just starting out, you are better off using <span class="s91">nvidia-smi</span>. (Although <span class="s91">nvidia-smi </span>is a far more capable than just providing GPU utilization info, which is typically how most practitioners use it.) For users wanting even deeper access to their hardware utilization metrics, NVIDIA Nsight is a great tool.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s83" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">the first batch is usually slower than the rest due to some initialization overhead.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark610">Alright. With these tools at our disposal, we know that our program needs some tuning and has room for efficiency improvements. We look at those areas one by one in the next few sections.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s84" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark550">How to Use This Checklist</a><a name="bookmark611">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark612">In business, an oft-quoted piece of advice is “You can’t improve what you can’t measure.” This applies to deep learning pipelines, as well. Tuning performance is like a science experiment. You set up a baseline run, tune a knob, measure the effect, and iterate in the direction of improvement. The items on the following checklist are our knobs — some are quick and easy, whereas others are more involved.</a></p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">To use this checklist effectively, do the following:</p><ol id="l10"><li><p class="s83" style="padding-top: 6pt;padding-left: 55pt;text-indent: -15pt;text-align: left;">Isolate the part of the pipeline that you want to improve.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s83" style="padding-left: 55pt;text-indent: -15pt;text-align: left;">Find a relevant point on the checklist.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s83" style="padding-left: 55pt;text-indent: -15pt;text-align: left;">Implement, experiment, and observe if runtime is reduced. If not reduced, ignore change.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s83" style="padding-left: 55pt;text-indent: -15pt;text-align: left;">Repeat steps 1 through 3 until the checklist is exhausted.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Some of the improvements might be minute, some more drastic. But the cumulative effect of all these changes should hopefully result in faster, more efficient execution and best of all, more bang for the buck for your hardware. Let’s look at each area of the deep learning pipeline step by step, including data preparation, data reading, data augmentation, training, and, finally, inference.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s84" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark551">Performance Checklist</a><a name="bookmark613">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark552">Data Preparation</a><a name="bookmark614">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_351.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_352.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_353.png"/></span></p><p style="padding-top: 5pt;padding-left: 34pt;text-indent: 0pt;line-height: 186%;text-align: left;"><a href="#bookmark622" class="s85" name="bookmark615">“Store as </a><a href="#bookmark624" class="s85">TFRecords” </a><a href="#bookmark626" class="s85">“Reduce Size of Input Data” “Use TensorFlow Datasets”</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark553">Data Reading</a><a name="bookmark616">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_354.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_355.png"/></span></p><p style="padding-top: 5pt;padding-left: 34pt;text-indent: 0pt;line-height: 186%;text-align: left;"><a href="#bookmark634" class="s85">“Use tf.data” “Prefetch Data”</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_356.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_357.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_358.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_359.png"/></span></p><p style="padding-left: 34pt;text-indent: 0pt;line-height: 186%;text-align: left;"><a href="#bookmark639" class="s85">“Parallelize CPU Processing” </a><a href="#bookmark642" class="s85">“Parallelize I/O and Processing” </a><a href="#bookmark644" class="s85">“Enable Nondeterministic Ordering” “Cache Data”</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_360.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_361.png"/></span></p><p style="padding-left: 34pt;text-indent: 0pt;line-height: 186%;text-align: left;"><a href="#bookmark653" class="s85">“Turn on Experimental Optimizations” “Autotune Parameter Values”</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark554">Data Augmentation</a><a name="bookmark617">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_362.png"/></span></p><p style="padding-top: 5pt;padding-left: 34pt;text-indent: 0pt;text-align: left;"><a href="#bookmark658" class="s85">“Use GPU for Augmentation”</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark555">Training</a><a name="bookmark618">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_363.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_364.png"/></span></p><p style="padding-top: 5pt;padding-left: 34pt;text-indent: 0pt;line-height: 186%;text-align: left;"><a href="#bookmark667" class="s85">“Use Automatic Mixed Precision” “Use Larger Batch Size”</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_365.png"/></span></p><p style="padding-left: 34pt;text-indent: 0pt;line-height: 16pt;text-align: left;"><a href="#bookmark670" class="s85">“Use Multiples of Eight”</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_366.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_367.png"/></span></p><p style="padding-left: 34pt;text-indent: 0pt;line-height: 186%;text-align: left;"><a href="#bookmark676" class="s85">“Find the Optimal Learning Rate” “Use tf.function”</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_368.png"/></span></p><p style="padding-left: 41pt;text-indent: -7pt;line-height: 134%;text-align: left;"><a href="#bookmark680" class="s85">“Overtrain, and Then Generalize” “Use progressive sampling”</a></p><p style="padding-top: 8pt;padding-left: 41pt;text-indent: 0pt;line-height: 186%;text-align: left;"><a href="#bookmark684" class="s85">“Use progressive augmentation” “Use progressive resizing”</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_369.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_370.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_371.png"/></span></p><p style="padding-left: 34pt;text-indent: 0pt;line-height: 186%;text-align: left;"><a href="#bookmark688" class="s85">“Install an Optimized Stack for the Hardware” </a><a href="#bookmark691" class="s85">“Optimize the Number of Parallel CPU Threads” “Use Better Hardware”</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_372.png"/></span></p><p style="padding-left: 34pt;text-indent: 0pt;line-height: 16pt;text-align: left;"><a href="#bookmark693" class="s85">“Distribute Training”</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_373.png"/></span></p><p style="padding-left: 34pt;text-indent: 0pt;text-align: left;"><a href="#bookmark696" class="s85">“Examine Industry Benchmarks”</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark556">Inference</a><a name="bookmark619">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_374.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_375.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_376.png"/></span></p><p style="padding-top: 5pt;padding-left: 34pt;text-indent: 0pt;line-height: 186%;text-align: left;"><a href="#bookmark709" class="s85">“Use an Efficient Model” </a><a href="#bookmark713" class="s85">“Quantize the Model” “Prune the Model”</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="533" height="137" alt="image" src="KerasTensorFlow2019/Image_377.png"/></span></p><p class="s93" style="padding-top: 9pt;padding-left: 179pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s94" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="http://practicaldeeplearning.ai/" style=" color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11.5pt;" target="_blank">A printable version of this checklist is available at </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11.5pt;">http://PracticalDeepLearning.ai</span>. Feel free to use it as a reference next time you train or deploy a model. Or even better, spread the cheer by sharing with your friends, colleagues, and more importantly, your manager.</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_378.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_379.png"/></span></p><p style="padding-left: 34pt;text-indent: 0pt;line-height: 186%;text-align: left;"><a href="#bookmark718" class="s85">“Use Fused Operations” “Enable GPU Persistence”</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s84" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark557">Data Preparation</a><a name="bookmark620">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark621">There are a few optimizations that we can make even before we do any kind of training, and they have to do with how we prepare our data.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark558">Store as TFRecords</a><a name="bookmark622">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark623">Image datasets typically consist of thousands of tiny files, each file measuring a few kilobytes. And our training pipeline must read each file individually. Doing this thousands of times has significant overhead, causing a slowdown of the training process. That problem is even more severe in the case of spinning hard drives, for which the magnetic head needs to seek to the beginning of each file. This problem is further exacerbated when the files are stored on a remote storage service like the cloud. And there lies our first hurdle!</a></p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: justify;">To speed up the reads, one idea is to combine thousands of files into a handful of larger files. And that’s exactly what TFRecord does. It stores data in efficient Protocol Buffer (protobuf) objects, making them quicker to read. Let’s see how to create TFRecord files:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s102" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"># Create TFRecord files</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s103" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">tensorflow </span>as <span style=" color: #0CF;">tf </span>from <span style=" color: #0CF;">PIL </span>import <span class="s96">Image </span>import <span style=" color: #0CF;">numpy </span>as <span style=" color: #0CF;">np </span>import <span style=" color: #0CF;">io</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">cat </span>= <span style=" color: #C30;">&quot;cat.jpg&quot; </span><span style=" color: #000087;">img_name_to_labels </span>= {<span style=" color: #C30;">&#39;cat&#39; </span>: <span style=" color: #F60;">O</span>}</p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">img_in_string </span>= <span style=" color: #366;">open</span>(<span style=" color: #000087;">cat</span>, <span style=" color: #C30;">&#39;rb&#39;</span>).<span style=" color: #000087;">read</span>() <span style=" color: #000087;">label_for_img </span>= <span style=" color: #000087;">img_name_to_labels</span>[<span style=" color: #C30;">&#39;cat&#39;</span>]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 26pt;text-indent: -5pt;text-align: left;"><span class="s103">def </span><span style=" color: #C0F;">getTFRecord</span>(<span style=" color: #000087;">img</span>, <span style=" color: #000087;">label</span>): <span style=" color: #000087;">feature </span>= {</p><p class="s91" style="padding-left: 42pt;text-indent: 0pt;text-align: left;"><span style=" color: #C30;">&#39;label&#39;</span>: <span style=" color: #000087;">_int64_feature</span>(<span style=" color: #000087;">label</span>), <span style=" color: #C30;">&#39;image_raw&#39;</span>: <span style=" color: #000087;">_bytes_feature</span>(<span style=" color: #000087;">img</span>),</p><p class="s91" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">}</p><p class="s96" style="padding-left: 26pt;text-indent: 0pt;text-align: left;"><span class="s103">return </span>tf<span style=" color: #000;">.</span>train<span style=" color: #000;">.</span>Example<span style=" color: #000;">(</span>features<span style=" color: #000;">=</span>tf<span style=" color: #000;">.</span>train<span style=" color: #000;">.</span>Features<span style=" color: #000;">(</span>feature<span style=" color: #000;">=</span>feature<span style=" color: #000;">))</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span class="s103">with </span><span style=" color: #000087;">tf</span>.<span style=" color: #000087;">compat</span>.<span style=" color: #000087;">v1</span>.<span style=" color: #000087;">python_io</span>.<span style=" color: #000087;">TFRecordWriter</span>(<span style=" color: #C30;">&#39;img.tfrecord&#39;</span>) <span class="s103">as </span><span style=" color: #000087;">writer</span>:</p><p class="s91" style="padding-left: 42pt;text-indent: -11pt;text-align: left;"><span class="s103">for </span><span style=" color: #000087;">filename</span>, <span style=" color: #000087;">label </span><b>in </b><span style=" color: #000087;">img_name_to_labels</span>.<span style=" color: #000087;">items</span>(): <span style=" color: #000087;">image_string </span>= <span style=" color: #366;">open</span>(<span style=" color: #000087;">filename</span>, <span style=" color: #C30;">&#39;rb&#39;</span>).<span style=" color: #000087;">read</span>() <span style=" color: #000087;">tf_example </span>= <span style=" color: #000087;">getTFRecord</span>(<span style=" color: #000087;">image_string</span>, <span style=" color: #000087;">label</span>) <span style=" color: #000087;">writer</span>.<span style=" color: #000087;">write</span>(<span style=" color: #000087;">tf_example</span>.<span style=" color: #000087;">SerializeToString</span>())</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Now, let’s take a look at reading these TFRecord files:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s102" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"># Reading TFRecord files</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">dataset </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">data</span>.<span style=" color: #000087;">TFRecordDataset</span>(<span style=" color: #C30;">&#39;img.tfrecord&#39;</span>) <span style=" color: #000087;">ground_truth_info </span>= {</p><p class="s91" style="padding-left: 31pt;text-indent: 0pt;text-align: left;"><span style=" color: #C30;">&#39;label&#39;</span>: <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">compat</span>.<span style=" color: #000087;">v1</span>.<span style=" color: #000087;">FixedLenFeature</span>([], <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">int64</span>), <span style=" color: #C30;">&#39;image_raw&#39;</span>: <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">compat</span>.<span style=" color: #000087;">v1</span>.<span style=" color: #000087;">FixedLenFeature</span>([], <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">string</span>),</p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">}</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span class="s103">def </span><span style=" color: #C0F;">map_operation</span>(<span style=" color: #000087;">read_data</span>):</p><p class="s96" style="padding-left: 31pt;text-indent: 0pt;text-align: left;"><span class="s103">return </span>tf<span style=" color: #000;">.</span>compat<span style=" color: #000;">.</span>v1<span style=" color: #000;">.</span>parse_single_example<span style=" color: #000;">(</span>read_data<span style=" color: #000;">, </span>ground_truth_info<span style=" color: #000;">)</span></p><p class="s96" style="padding-top: 4pt;padding-left: 20pt;text-indent: 0pt;text-align: left;">imgs <span style=" color: #000;">= </span>dataset<span style=" color: #000;">.</span>map<span style=" color: #000;">(</span>map_operation<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s96" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span class="s103">for </span>image_features <span class="s107">in </span>imgs<span style=" color: #000;">:</span></p><p class="s91" style="padding-left: 31pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">image_raw </span>= <span style=" color: #000087;">image_features</span>[<span style=" color: #C30;">&#39;image_raw&#39;</span>].<span style=" color: #000087;">numpy</span>() <span style=" color: #000087;">label </span>= <span style=" color: #000087;">image_features</span>[<span style=" color: #C30;">&#39;label&#39;</span>].<span style=" color: #000087;">numpy</span>()</p><p class="s96" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">image <span style=" color: #000;">= </span>Image<span style=" color: #000;">.</span>open<span style=" color: #000;">(</span>io<span style=" color: #000;">.</span>BytesIO<span style=" color: #000;">(</span>image_raw<span style=" color: #000;">)) </span>image<span style=" color: #000;">.</span>show<span style=" color: #000;">()</span></p><p class="s91" style="padding-left: 31pt;text-indent: 0pt;text-align: left;"><span style=" color: #366;">print</span>(<span style=" color: #000087;">label</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">So, why not join all of the data in a single file, like say for ImageNet? Although reading thousands of tiny files harms performance due to the overhead involved, reading gigantic files is an equally bad idea. They reduce our ability to make parallel reads and parallel network calls. The sweet spot to shard (divide) a large dataset in TFRecord files lies at around 100 MB.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark559">Reduce Size of Input Data</a><a name="bookmark624">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark625">Image datasets with large images need to be resized before passing through to the GPU. This means the following:</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_380.png"/></span></p><p class="s83" style="padding-top: 4pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">Repeated CPU cycles at every iteration</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_381.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">Repeated I/O bandwidth being consumed at a larger rate than needed in our data pipeline</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">One good strategy to save compute cycles is to perform common preprocessing steps once on the entire dataset (like resizing) and then saving the results in TFRecord files for all future runs.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark560">Use TensorFlow Datasets</a><a name="bookmark626">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark627">For commonly used public datasets, from MNIST (11 MB) to CIFAR- 100 (160 MB) all the way to MS COCO (38 GB) and Google Open Images (565 GB), it’s quite an effort to download the data (often spread across multiple zipped files). Imagine your frustration if after downloading 95% of the file slowly, the connection becomes spotty and breaks. This is not unusual because these files are typically hosted on university servers, or are downloaded from various sources like Flickr (as is the case with ImageNet 2012, which gives us the URLs from which to download 150 GB-plus of images). A broken connection might mean having to start all over again.</a></p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">If you think that was tedious, the real challenge actually begins only after you successfully download the data. For every new dataset, we now need to hunt through the documentation to determine how the data is formatted and organized, so we can begin reading and processing appropriately. Then, we need to split the data into training, validation, and test sets (preferably converting to TFRecords). And when the data is so large as to not fit in memory, we will need to do some manual jiu- jitsu to read it and feed it efficiently to the training pipeline. We never said it was easy.</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Alternately, we could skip all the pain by consuming the high- performance, ready-to-use TensorFlow Datasets package. With several famous datasets available, it downloads, splits, and feeds our training pipeline using best practices in a few lines.</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Let’s look at which datasets are available.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s103" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">tensorflow_datasets </span>as <span style=" color: #0CF;">tfds</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s102" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"># See available datasets</p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #366;">print</span>(<span style=" color: #000087;">tfds</span>.<span style=" color: #000087;">list_builders</span>())</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-top: 6pt;padding-left: 20pt;text-indent: 0pt;text-align: left;">===== Output =====</p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">[&#39;abstract_reasoning&#39;, &#39;bair_robot_pushing_small&#39;, &#39;caltech1O1&#39;, &#39;cats_vs_dogs&#39;,</p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">&#39;celeb_a&#39;, &#39;celeb_a_hq&#39;, &#39;chexpert&#39;, &#39;cifar1O&#39;, &#39;cifar1OO&#39;, &#39;cifar1O_corrupted&#39;,</p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">&#39;cnn_dailymail&#39;, &#39;coco2O14&#39;, &#39;colorectal_histology&#39;, &#39;colorectal_histology_large&#39;, &#39;cycle_gan&#39; ...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">There are more than 100 datasets as of this writing, and that number is steadily increasing. Now, let’s download, extract, and make an efficient</p><p class="s83" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;">pipeline using the training set of CIFAR-10:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">train_dataset </span>= <span style=" color: #000087;">tfds</span>.<span style=" color: #000087;">load</span>(<span style=" color: #000087;">name</span>=<span style=" color: #C30;">&quot;cifar1OO&quot;</span>, <span style=" color: #000087;">split</span>=<span style=" color: #000087;">tfds</span>.<span style=" color: #000087;">Split</span>.<span style=" color: #000087;">TRAIN</span>) <span style=" color: #000087;">train_dataset </span>= <span style=" color: #000087;">train_dataset</span>.<span style=" color: #000087;">shuffle</span>(<span style=" color: #F60;">2O48</span>).<span style=" color: #000087;">batch</span>(<span style=" color: #F60;">64</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: justify;"><a name="bookmark628">That’s it! The first time we execute the code, it will download and cache the dataset on our machine. For every future run, it will skip the network download and directly read from the cache.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s84" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark561">Data Reading</a><a name="bookmark629">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark630">Now that the data is prepared, let’s look for opportunities to maximize the throughput of the data reading pipeline.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark562">Use tf.data</a><a name="bookmark631">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 110%;text-align: left;"><a name="bookmark632">We could choose to manually read every file from our dataset with Python’s built-in I/O library. We could simply call </a><span class="s90">open </span>for each file and we’d be good to go, right? The main downside in this approach is that our GPU would be bottlenecked by our file reads. Every time we read a file, the GPU needs to wait. Every time the GPU starts processing its input, we wait before we read the next file from disk. Seems rather wasteful, doesn’t it?</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;">If there’s only one thing you can take away from this chapter, let it be this: <span class="s90">tf.data </span>is the way to go for building a high-performance training pipeline. In the next few sections, we explore several aspects of <span class="s90">tf.data </span>that you can exploit to improve training speed.</p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark633">Let’s set up a base pipeline for reading data:</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">files </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">data</span>.<span style=" color: #000087;">Dataset</span>.<span style=" color: #000087;">list_files</span>(<span style=" color: #C30;">&quot;./training_data/*.tfrecord&quot;</span>) <span style=" color: #000087;">dataset </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">data</span>.<span style=" color: #000087;">TFRecordDataset</span>(<span style=" color: #000087;">files</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">dataset </span>= <span style=" color: #000087;">dataset</span>.<span style=" color: #000087;">shuffle</span>(<span style=" color: #F60;">2O48</span>)</p><p class="s91" style="padding-left: 115pt;text-indent: 0pt;text-align: left;">.<span style=" color: #000087;">repeat</span>()</p><p class="s91" style="padding-left: 115pt;text-indent: 0pt;text-align: left;">.<span style=" color: #000087;">map</span>(<span class="s103">lambda </span><span style=" color: #000087;">item</span>: <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">io</span>.<span style=" color: #000087;">parse_single_example</span>(<span style=" color: #000087;">item</span>,</p><p class="s96" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">features<span style=" color: #000;">))</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">.<span style=" color: #000087;">map</span>(<span style=" color: #000087;">_resize_image</span>)</p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">.<span style=" color: #000087;">batch</span>(<span style=" color: #F60;">64</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark563">Prefetch Data</a><a name="bookmark634">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark635">In the pipeline we discussed earlier, the GPU waits for the CPU to generate data, and then the CPU waits for the GPU to finish computation before generating data for the next cycle. This circular dependency causes idle time for both CPU and GPU, which is inefficient.</a></p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 119%;text-align: left;">The <span class="s90">prefetch </span>function helps us here by delinking the production of the data (by the CPU) from the consumption of the data (by the GPU).</p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 14pt;text-align: left;"><a name="bookmark636">Using a background thread, it allows data to be passed </a><i>asynchronously</i></p><p class="s83" style="padding-top: 1pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">into an intermediate buffer, where it is readily available for a GPU to consume. The CPU now carries on with the next computation instead of waiting for the GPU. Similarly, as soon as the GPU is finished with its previous computation, and there’s data readily available in the buffer, it starts processing.</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 119%;text-align: left;">To use it, we can simply call <span class="s90">prefetch </span>on our dataset at the very end of our pipeline along with a <span class="s90">buffer_size </span>parameter (which is the maximum amount of data that can be stored). Usually <span class="s90">buffer_size </span>is a small number; <span class="s90">1 </span>is good enough in many cases:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">dataset </span>= <span style=" color: #000087;">dataset</span>.<span style=" color: #000087;">prefetch</span>(<span style=" color: #000087;">buffer_size</span>=<span style=" color: #F60;">16</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">In just a few pages, we show you how to find an optimal value for this parameter.</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">In summary, if there’s an opportunity to overlap CPU and GPU computations, <span class="s90">prefetch </span>will automatically exploit it.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark564">Parallelize CPU Processing</a><a name="bookmark637">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;"><a name="bookmark638">It would be a waste to have a CPU with multiple cores but doing all of our processing on only one of them. Why not take advantage of the rest? This is exactly where the </a><span class="s90">num_parallel_calls </span>argument in the <span class="s90">map </span>function comes in handy:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s96" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">dataset <span style=" color: #000;">= </span>dataset<span style=" color: #000;">.</span>map<span style=" color: #000;">(</span><span class="s103">lambda </span>item<span style=" color: #000;">: </span>tf<span style=" color: #000;">.</span>io<span style=" color: #000;">.</span>parse_single_example<span style=" color: #000;">(</span>item<span style=" color: #000;">, </span>features<span style=" color: #000;">),</span></p><p class="s99" style="padding-left: 143pt;text-indent: 0pt;text-align: left;">num_parallel_calls<span style=" color: #000;">=</span><span style=" color: #F60;">4</span><span class="s91">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;">This starts multiple threads to parallelize processing of the <span class="s90">map() </span>function. Assuming that there is no heavy application running in the background, we will want to set <span class="s90">num_parallel_calls </span>to the number of CPU cores on our system. Anything more will potentially degrade the performance due to the overhead of context switching.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark565">Parallelize I/O and Processing</a><a name="bookmark639">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark640">Reading files from disk or worse, over a network, is a huge cause of bottlenecks. We might possess the best CPU and GPU in the world, but if we don’t optimize our file reads, it would all be for naught. One solution that addresses this problem is to parallelize both I/O and subsequent processing (also known as </a><i>interleaving</i>).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">dataset </span>= <span style=" color: #000087;">files</span>.<span style=" color: #000087;">interleave</span>(<span style=" color: #000087;">map_func</span>, <span style=" color: #000087;">num_parallel_calls</span>=<span style=" color: #F60;">4</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">In this command, two things are happening:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_382.png"/></span></p><p class="s83" style="padding-top: 6pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">The input data is acquired in parallel (by default equal to the number of cores on the system).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_383.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;"><a name="bookmark641">On the acquired data, setting the </a><span class="s90">num_parallel_calls </span>parameter allows the <span class="s90">map_func </span>function to execute on multiple parallel threads and read from the incoming data asynchronously.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 115%;text-align: left;">If <span class="s90">num_parallel_calls </span>was not specified, even if the data were read in parallel, <span class="s90">map_func </span>would run synchronously on a single thread. As long as <span class="s90">map_func </span>runs faster than the rate at which the input data is coming in, there will not be a problem. We definitely want to set <span class="s90">num_parallel_calls </span>higher if <span class="s90">map_func </span>becomes a bottleneck.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark566">Enable Nondeterministic Ordering</a><a name="bookmark642">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark643">For many datasets, the reading order is not important. After all, we might be randomizing their ordering anyway. By default, when reading files in parallel, </a><span class="s90">tf.data </span>still attempts to produce their outputs in a <i>fixed round-robin order</i>. The disadvantage is that we might encounter a “straggler” along the way (i.e., an operation that takes a lot longer than others, such as a slow file read, and holds up all other operations). It’s like a grocery store line where the person in front of us insists on using cash with the exact change, whereas everyone else uses a credit card. So instead of blocking all the subsequent operations that are ready to give output, we skip over the stragglers until they are done with their processing. This breaks the ordering while reducing wasted cycles waiting for the handful of slower operations:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s96" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">options <span style=" color: #000;">= </span>tf<span style=" color: #000;">.</span>data<span style=" color: #000;">.</span>Options<span style=" color: #000;">() </span>options<span style=" color: #000;">.</span>experimental_deterministic <span style=" color: #000;">= </span><span class="s103">False</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">dataset </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">data</span>.<span style=" color: #000087;">Dataset</span>.<span style=" color: #000087;">list_files</span>(<span style=" color: #C30;">&quot;./training_data/&quot;</span>) <span style=" color: #000087;">dataset </span>= <span style=" color: #000087;">dataset</span>.<span style=" color: #000087;">with_options</span>(<span style=" color: #000087;">options</span>)</p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">dataset </span>= <span style=" color: #000087;">dataset</span>.<span style=" color: #000087;">interleave</span>(<span style=" color: #000087;">tf</span>.<span style=" color: #000087;">data</span>.<span style=" color: #000087;">TFRecordDataset</span>, <span style=" color: #000087;">num_parallel_calls</span>=<span style=" color: #F60;">4</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;"><a name="bookmark567">Cache Data</a><a name="bookmark644">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: justify;"><a name="bookmark645">The </a><span class="s90">Dataset.cache() </span>function allows us to make a copy of data either in memory or as a file on disk. There are two reasons why you might want to cache a dataset:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_384.png"/></span></p><p class="s83" style="padding-top: 4pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">To avoid repeatedly reading from disk after the first epoch. This is obviously effective only when the cache is in memory and can fit in the available RAM.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_385.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">To avoid having to repeatedly perform expensive CPU operations on data (e.g., resizing large images to a smaller size).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="533" height="138" alt="image" src="KerasTensorFlow2019/Image_386.png"/></span></p><p class="s93" style="padding-top: 9pt;padding-left: 179pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s94" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Cache is best used for data that is not going to change. It is recommended to place <span class="s91">cache() </span>before any random augmentations and shuffling; otherwise, caching at the end will result in exactly the same data and order in every run.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s83" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Depending on our scenario, we can use one of the two following lines:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s96" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">dataset <span style=" color: #000;">= </span>dataset<span style=" color: #000;">.</span>cache<span style=" color: #000;">() </span><span class="s102"># in-memory</span></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">dataset </span>= <span style=" color: #000087;">dataset</span>.<span style=" color: #000087;">cache</span>(<span style=" color: #000087;">filename</span>=<span style=" color: #C30;">&#39;tmp.cache&#39;</span>) <span class="s102"># on-disk</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="533" height="139" alt="image" src="KerasTensorFlow2019/Image_387.png"/></span></p><p class="s93" style="padding-top: 9pt;padding-left: 179pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s94" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark624" style=" color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11.5pt;">In the </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11.5pt;">“Reduce Size of Input Data”</span>, we mentioned preprocessing the data and saving it as TFRecord files as input to future data pipelines. Using the <span class="s107">cache() </span>function directly after the preprocessing step in your pipeline would give a similar performance with a single word change in code.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">It’s worth noting that in-memory cache is volatile and hence only shows performance improvements in the second epoch of every run. On the other hand, file-based cache will make every run faster (beyond the very first epoch of the first run).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark568">Turn on Experimental Optimizations</a><a name="bookmark646">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="533" height="81" alt="image" src="KerasTensorFlow2019/Image_388.png"/></span></p><p class="s93" style="padding-top: 9pt;padding-left: 179pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s94" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Here’s a quick refresher on filter and map operations:</p><p style="text-indent: 0pt;text-align: left;"/><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark647">TensorFlow has many built-in optimizations, often initially experimental and turned off by default. Depending on your use case, you might want to turn on some of them to squeeze out just a little more performance from your pipeline. Many of these optimizations are detailed in the documentation for </a><span class="s90">tf.data.experimental.OptimizationOptions</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s88" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Filter</p><p class="s83" style="padding-top: 4pt;padding-left: 34pt;text-indent: 0pt;text-align: left;"><a name="bookmark648">A filter operation goes through a list element by element and grabs those that match a given condition. The condition is supplied as a lambda operation that returns a boolean value.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s88" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Map</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="text-indent: 0pt;text-align: left;"><a name="bookmark649">A map operation simply takes in an element, performs a computation, and returns an output. For example, resizing an image.</a></p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Let’s look at a few experimental optimizations that are available to us, including examples of two consecutive operations that could benefit from being fused together as one single operation.</p><p class="s109" style="padding-top: 13pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark569">Filter fusion</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark650">Sometimes, we might want to filter based on multiple attributes. Maybe we want to use only images that have both a dog and a cat. Or, in a census dataset, only look at families above a certain income threshold who also live within a certain distance to the city center. </a><span class="s90">filter_fusion </span>can help speed up such scenarios. Consider the following example:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">dataset </span>= <span style=" color: #000087;">dataset</span>.<span style=" color: #000087;">filter</span>(<span class="s103">lambda </span><span style=" color: #000087;">x</span>: <span style=" color: #000087;">x </span>&lt; <span style=" color: #F60;">1OOO</span>).<span style=" color: #000087;">filter</span>(<span class="s103">lambda </span><span style=" color: #000087;">x</span>: <span style=" color: #000087;">x </span>% <span style=" color: #F60;">3 </span>== <span style=" color: #F60;">O</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">The first filter performs a full pass over the entire dataset and returns elements that are less than 1,000. On this output, the second filter does another pass to further remove elements not divisible by three. Instead of doing two passes over many of the same elements, we could instead</p><p class="s83" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 114%;text-align: left;">combine both the filter operations into one pass using an <span class="s90">AND </span>operation. That is precisely what the <span class="s90">filter_fusion </span>option enables — combining multiple filter operations into one pass. By default, it is turned off. You can enable it by using the following statement:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s96" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">options <span style=" color: #000;">= </span>tf<span style=" color: #000;">.</span>data<span style=" color: #000;">.</span>Options<span style=" color: #000;">() </span>options<span style=" color: #000;">.</span>experimental_optimization<span style=" color: #000;">.</span>filter_fusion <span style=" color: #000;">= </span><span class="s103">True </span>dataset <span style=" color: #000;">= </span>dataset<span style=" color: #000;">.</span>with_options<span style=" color: #000;">(</span>options<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s109" style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark570">Map and filter fusion</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark651">Consider the following example:</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">dataset </span>= <span style=" color: #000087;">dataset</span>.<span style=" color: #000087;">map</span>(<span class="s103">lambda </span><span style=" color: #000087;">x</span>: <span style=" color: #000087;">x </span>* <span style=" color: #000087;">x</span>).<span style=" color: #000087;">filter</span>(<span class="s103">lambda </span><span style=" color: #000087;">x</span>: <span style=" color: #000087;">x </span>% <span style=" color: #F60;">2 </span>== <span style=" color: #F60;">O</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 113%;text-align: left;">In this example, the <span class="s90">map </span>function does a full pass on the entire dataset to calculate the square of every element. Then, the <span class="s90">filter </span>function discards the odd elements. Rather than doing two passes (more so in this particularly wasteful example), we could simply fuse the map and filter operations together by turning on the <span class="s90">map_and_filter_fusion </span>option so that they operate as a single unit:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s96" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">options<span style=" color: #000;">.</span>experimental_optimization<span style=" color: #000;">.</span>map_and_filter_fusion <span style=" color: #000;">= </span><span class="s103">True</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s109" style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark571">Map fusion</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark652">Similar to the aforementioned two examples, fusing two or more map operations prevents multiple passes from being performed on the same data and instead combines them in a single pass:</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s96" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">options<span style=" color: #000;">.</span>experimental_optimization<span style=" color: #000;">.</span>map_fusion <span style=" color: #000;">= </span><span class="s103">True</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark572">Autotune Parameter Values</a><a name="bookmark653">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark654">You might have noticed that many of the code examples in this section have hardcoded values for some of the parameters. For the combination of the problem and hardware at hand, you can tune them for maximum efficiency. How to tune them? One obvious way is to manually tweak the parameters one at a time and isolate and observe the impact of each of them on the overall performance until we get the precise parameter set. But the number of knobs to tune quickly gets out of hand due to the combinatorial explosion. If this wasn’t enough, our finely tuned script wouldn’t necessarily be as efficient on another machine due to differences in hardware such as the number of CPU cores, GPU availability, and so on. And even on the same system, depending on resource usage by other programs, these knobs might need to be adjusted over different runs.</a></p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;">How do we solve this? We do the opposite of manual tuning: autotuning. Using hill-climbing optimization algorithms (which are a type of heuristic-driven search algorithms), this option automatically finds the ideal parameter combination for many of the <span class="s90">tf.data </span>function parameters. Simply use <span class="s90">tf.data.experimental.AUTOTUNE </span>instead of manually assigning numbers. It’s the one parameter to rule them all.</p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 16pt;text-align: left;">Consider the following example:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s96" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">dataset <span style=" color: #000;">= </span>dataset<span style=" color: #000;">.</span>prefetch<span style=" color: #000;">(</span>buffer_size<span style=" color: #000;">=</span>tf<span style=" color: #000;">.</span>data<span style=" color: #000;">.</span>experimental<span style=" color: #000;">.</span>AUTOTUNE<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;"><a name="bookmark655">Isn’t that an elegant solution? We can do that for several other function calls in the </a><span class="s90">tf.data </span>pipeline. The following is an example of combining together several optimizations from the section “Data Reading” to make a high-performance data pipeline:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s96" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">options <span style=" color: #000;">= </span>tf<span style=" color: #000;">.</span>data<span style=" color: #000;">.</span>Options<span style=" color: #000;">() </span>options<span style=" color: #000;">.</span>experimental_deterministic <span style=" color: #000;">= </span><span class="s103">False</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">dataset </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">data</span>.<span style=" color: #000087;">Dataset</span>.<span style=" color: #000087;">list_files</span>(<span style=" color: #C30;">&quot;/path/*.tfrecord&quot;</span>) <span style=" color: #000087;">dataset </span>= <span style=" color: #000087;">dataset</span>.<span style=" color: #000087;">with_options</span>(<span style=" color: #000087;">options</span>)</p><p class="s96" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">dataset <span style=" color: #000;">= </span>files<span style=" color: #000;">.</span>interleave<span style=" color: #000;">(</span>tf<span style=" color: #000;">.</span>data<span style=" color: #000;">.</span>TFRecordDataset<span style=" color: #000;">,</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s96" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">num_parallel_calls<span style=" color: #000;">=</span>tf<span style=" color: #000;">.</span>data<span style=" color: #000;">.</span>experimental<span style=" color: #000;">.</span>AUTOTUNE<span style=" color: #000;">) </span>dataset <span style=" color: #000;">= </span>dataset<span style=" color: #000;">.</span>map<span style=" color: #000;">(</span>preprocess<span style=" color: #000;">,</span></p><p class="s96" style="padding-left: 20pt;text-indent: 122pt;text-align: left;">num_parallel_calls<span style=" color: #000;">=</span>tf<span style=" color: #000;">.</span>data<span style=" color: #000;">.</span>experimental<span style=" color: #000;">.</span>AUTOTUNE<span style=" color: #000;">) </span>dataset <span style=" color: #000;">= </span>dataset<span style=" color: #000;">.</span>cache<span style=" color: #000;">()</span></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">dataset </span>= <span style=" color: #000087;">dataset</span>.<span style=" color: #000087;">repeat</span>() <span style=" color: #000087;">dataset </span>= <span style=" color: #000087;">dataset</span>.<span style=" color: #000087;">shuffle</span>(<span style=" color: #F60;">2O48</span>)</p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">dataset </span>= <span style=" color: #000087;">dataset</span>.<span style=" color: #000087;">batch</span>(<span style=" color: #000087;">batch_size</span>=<span style=" color: #F60;">64</span>)</p><p class="s96" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">dataset <span style=" color: #000;">= </span>dataset<span style=" color: #000;">.</span>prefetch<span style=" color: #000;">(</span>buffer_size<span style=" color: #000;">=</span>tf<span style=" color: #000;">.</span>data<span style=" color: #000;">.</span>experimental<span style=" color: #000;">.</span>AUTOTUNE<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s84" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark573">Data Augmentation</a><a name="bookmark656">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark657">Sometimes, we might not have sufficient data to run our training pipeline. Even if we did, we might still want to manipulate the images to improve the robustness of our model — with the help of data augmentation. Let’s see whether we can make this step any faster.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark574">Use GPU for Augmentation</a><a name="bookmark658">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Data preprocessing pipelines can be elaborate enough that you could write an entire book about them. Image transformation operations such as resizing, cropping, color transformations, blurring, and so on are commonly performed on the data immediately after it’s read from disk into memory. Given that these are all matrix transformation operations, they might do well on a GPU.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="533" height="100" alt="image" src="KerasTensorFlow2019/Image_389.png"/></span></p><p class="s93" style="padding-top: 9pt;padding-left: 179pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s94" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">As of August 2019, there are efforts underway to convert Keras image augmentation to be GPU accelerated, as well.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">OpenCV, Pillow, and the built-in Keras augmentation functionality are the most commonly used libraries in computer vision for working on images. There’s one major limitation here, though. Their image processing is primarily CPU based (although you can compile OpenCV to work with CUDA), which means that the pipeline might not be fully utilizing the underlying hardware to its true potential.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">There are a few different GPU-bound options that we can explore.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s109" style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark575">tf.image built-in augmentations</a></p><p class="s90" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;"><a name="bookmark659">tf.image </a><span class="s83">provides some handy augmentation functions that we can seamlessly plug into a </span>tf.data <span class="s83">pipeline. Some of the methods include image flipping, color augmentations (hue, saturation, brightness, contrast), zooming, and rotation. Consider the following example, which changes the hue of an image:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">updated_image </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">image</span>.<span style=" color: #000087;">adjust_hue</span>(<span style=" color: #000087;">image</span>, <span style=" color: #000087;">delta </span>= <span style=" color: #F60;">O.2</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;">The downside to relying on <span class="s90">tf.image </span>is that the functionality is much more limited compared to OpenCV, Pillow, and even Keras. For example, the built-in function for image rotation in <span class="s90">tf.image </span>only supports rotating images by 90 degrees counter-clockwise. If we need to be able to rotate by an arbitrary amount, such as 10 degrees, we’d need to manually build that functionality. Keras, on the other hand, provides that functionality out of the box.</p><p class="s83" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark660">As another alternative to the </a><span class="s90">tf.data </span><a href="#bookmark661" class="s110">pipeline, the NVIDIA Data Loading Library (DALI) offers a fast data loading and preprocessing pipeline accelerated by GPU processing. As shown in </a><span style=" color: #8E0012;">Figure 6-4</span>, DALI implements several common steps including resizing an image and augmenting an image in the GPU, immediately before the training.</p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">DALI works with multiple deep learning frameworks including TensorFlow, PyTorch, MXNet, and others, offering portability of the preprocessing pipelines.</p><p class="s109" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark576">NVIDIA DALI</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="543" height="64" alt="image" src="KerasTensorFlow2019/Image_390.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s86" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark661">Figure 6-4. The NVIDIA DALI pipeline</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Additionally, even JPEG decoding (a relatively heavy task) can partially make use of the GPU, giving it an additional boost. This is done using nvJPEG, a GPU-accelerated library for JPEG decoding. For multi-GPU tasks, this scales near linearly as the number of GPUs increases.</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark662">NVIDIAs efforts culminated in a record-breaking MLPerf entry (which benchmarks machine learning hardware, software, and services), training a ResNet-50 model in 80 seconds.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s84" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark577">Training</a><a name="bookmark663">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark664">For those beginning their performance optimization journey, the quickest wins come from improving the data pipelines, which is relatively easy. For a training pipeline that is already being fed data fast, let’s investigate optimizations for our actual training step.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark578">Use Automatic Mixed Precision</a><a name="bookmark665">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">“<i>One line to make your training two to three times faster!</i>”</p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark709" class="s110" name="bookmark666">Weights in deep learning models are typically stored in single-precision; that is, 32-bit floating point, or as it’s more commonly referenced: FP32. Putting these models in memory-constrained devices such as mobile phones can be challenging to accommodate. A simple trick to make models smaller is to convert them from single-precision (FP32) to half- precision (FP16). Sure, the representative power of these weights goes down, but as we demonstrate later in this chapter (</a><a href="#bookmark709" class="s85">“Quantize the Model”</a>), neural networks are resilient to small changes, much like they are resilient to noise in images. Hence, we get the benefits of a more efficient model without sacrificing much accuracy. In fact, we can even reduce the representation to 8-bit integers (INT8) without a significant loss in accuracy, as we will see in some upcoming chapters.</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">So, if we can use reduced-precision representation during inference, could we do the same during training, as well? Going from 32-bit to 16- bit representation would effectively mean double the memory bandwidth available, double the model size, or double the batch size can be accommodated. Unfortunately, it turns out that using FP16 naïvely <i>during training </i>can potentially lead to a significant loss in model accuracy and might not even converge to an optimal solution. This happens because of FP16’s limited range for representing numbers.</p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Due to a lack of adequate precision, any updates to the model during training, if sufficiently small, will cause an update to not even register. Imagine adding 0.00006 to a weight value of 1.1. With FP32, the weight would be correctly updated to 1.10006. With FP16, however, the weight would remain 1.1. Conversely, any activations from layers such as Rectified Linear Unit (ReLU) could be high enough for FP16 to overflow and hit infinity (<span class="s90">NaN </span>in Python).</p><p class="s83" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">The easy answer to these challenges is to use automatic mixed- precision training. In this method, we store the model in FP32 as a master copy and perform the forward/backward passes of training in FP16. After each training step is performed, the final update from that step is then scaled back up to FP32 before it is applied to the master copy. This helps avoid the pitfalls of FP16 arithmetic and results in a lower memory footprint, and faster training (experiments have shown increases in speed by two to three times), while achieving similar</p><p class="s83" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">accuracy levels as training solely in FP32. It is noteworthy that newer GPU architectures like the NVIDIA Volta and Turing especially optimize FP16 operations.</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">To enable mixed precision during training, we simply need to add the following line to the beginning of our Python script:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">os.environ[&#39;TF_ENABLE_AUTO_MIXED_PRECISION&#39;] = &#39;1&#39;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark579">Use Larger Batch Size</a><a name="bookmark667">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark668">Instead of using the entire dataset for training in one batch, we train with several minibatches of data. This is done for two reasons:</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_391.png"/></span></p><p class="s83" style="padding-top: 4pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">Our full data (single batch) might not fit in the GPU RAM.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_392.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">We can achieve similar training accuracy by feeding many smaller batches, just as you would by feeding fewer larger batches.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 110%;text-align: left;">Having smaller minibatches might not fully utilize the available GPU memory, so it’s vital to experiment with this parameter, see its effect on the GPU utilization (using the <span class="s90">nvidia-smi </span>command), and choose the batch size that maximizes the utilization. Consumer GPUs like the NVIDIA 2080 Ti ship with 11 GB of GPU memory, which is plenty for efficient models like MobileNet family.</p><p class="s100" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark669" class="s110">For example on hardware with the 2080 Ti graphics card, using 224 x 224 resolution images and MobileNetV2 model, the GPU can accommodate a batch size up to 864. </a>Figure 6-5 <span style=" color: #000;">shows the effect of varying batch sizes from 4 to 864, on both the GPU utilization (solid line) as well as the time per epoch (dashed line). As we can see in the figure, the higher the batch size, the higher the GPU utilization, leading to a shorter training time per epoch.</span></p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Even at our max batch size of 864 (before running out of memory allocation), the GPU utilization does not cross 85%. This means that the GPU was fast enough to handle the computations of our otherwise very efficient data pipeline. Replacing MobileNetV2 with a heavier ResNet-50 model immediately increased GPU to 95%.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 28pt;text-indent: 0pt;text-align: left;"><span><img width="523" height="305" alt="image" src="KerasTensorFlow2019/Image_393.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="533" height="174" alt="image" src="KerasTensorFlow2019/Image_394.png"/></span></p><p class="s93" style="padding-top: 9pt;padding-left: 179pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s94" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Even though we showcased batch sizes up to a few hundreds, large industrial training loads distributed across multiple nodes often use much larger batch sizes with the help of a technique called Layer-wise Adaptive Rate Scaling (LARS). For example, Fujitsu Research trained a ResNet-50 network to 75% Top-1 accuracy on ImageNet in a mere 75 seconds. Their ammunition? 2048 Tesla V100 GPUs and a whopping batch size of 81,920!</p><p style="text-indent: 0pt;text-align: left;"/><p class="s86" style="padding-top: 4pt;padding-left: 21pt;text-indent: -3pt;text-align: left;"><a name="bookmark669">Figure 6-5. Effect of varying batch size on time per epoch (seconds) as well as on percentage GPU utilization (Log scales have been used for both X- and Y-axes.)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark580">Use Multiples of Eight</a><a name="bookmark670">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark671">Most of the computations in deep learning are in the form of “matrix multiply and add.” Although it’s an expensive operation, specialized hardware has increasingly been built in the past few years to optimize for its performance. Examples include Google’s TPUs and NVIDIA’s Tensor Cores (which can be found in the Turing and Volta architectures). Turing GPUs provide both Tensor Cores (for FP16 and INT8 operations) as well as CUDA cores (for FP32 operations), with the Tensor Cores delivering significantly higher throughput. Due to their specialized nature, Tensor Cores require that certain parameters within the data supplied to them be divisible by eight. Here are just three such parameters:</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_395.png"/></span></p><p class="s83" style="padding-top: 5pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">The number of channels in a convolutional filter</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_396.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">The number of neurons in a fully connected layer and the inputs to this layer</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_397.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">The size of minibatches</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s100" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="https://oreil.ly/KoEkM" class="s110" target="_blank">If these parameters are not divisible by eight, the GPU CUDA cores will be used as the fallback accelerator instead. In an </a>experiment <span style=" color: #000;">reported by NVIDIA, simply changing the batch size from 4,095 to 4,096 resulted in an increase in throughput of five times. Keep in mind that using multiples of eight (or 16 in the case of INT8 operations), in addition to using automatic mixed precision, is the bare minimum requirement to activate the Tensor Cores. For higher efficiency, the recommended values are in fact multiples of 64 or 256. Similarly, Google recommends multiples of 128 when using TPUs for maximum efficiency.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark581">Find the Optimal Learning Rate</a><a name="bookmark672">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark673">One hyperparameter that greatly affects our speed of convergence (and accuracy) is the learning rate. The ideal result of training is the global minimum; that is, the point of least loss. Too high a learning rate can cause our model to overshoot the global minimum (like a wildly swinging pendulum) and potentially never converge. Too low a learning rate can cause convergence to take too long because the learning algorithm will take very small steps toward the minimum. Finding the right initial learning rate can make a world of difference.</a></p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">The naive way to find the ideal initial learning rate is to try a few different learning rates (such as 0.00001, 0.0001, 0.001, 0.01, 0.1) and find one that starts converging quicker than others. Or, even better, perform grid search over a range of values. This approach has two problems: 1) depending on the granularity, it might find a decent value, but it might not be the most optimal value; and 2) we need to train multiple times, which can be time consuming.</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">In Leslie N. Smith’s 2015 paper, “Cyclical Learning Rates for Training Neural Networks,” he describes a much better strategy to find this optimal learning rate. In summary:</p><ol id="l11"><li><p class="s83" style="padding-top: 4pt;padding-left: 55pt;text-indent: -15pt;text-align: left;">Start with a really low learning rate and gradually increase it until reaching a prespecified maximum value.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s83" style="padding-left: 55pt;text-indent: -15pt;text-align: left;">At each learning rate, observe the loss — first it will be stagnant, then it will begin going down and then eventually go back up.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s83" style="padding-left: 55pt;text-indent: -15pt;text-align: left;">Calculate the rate of decrease of loss (first derivative) at each learning rate.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s83" style="padding-left: 55pt;text-indent: -15pt;text-align: left;">Select the point with the highest rate of decrease of loss.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s100" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: justify;"><a href="https://oreil.ly/il_BI" class="s110" target="_blank">It sounds like a lot of steps, but thankfully we don’t need to write code for it. The </a>keras_lr_finder <span style=" color: #000;">library by Pavel Surmenok gives us a handy function to find it:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s96" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">lr_finder <span style=" color: #000;">= </span>LRFinder<span style=" color: #000;">(</span>model<span style=" color: #000;">)</span></p><p class="s91" style="padding-left: 104pt;text-indent: -83pt;text-align: left;"><span style=" color: #000087;">lr_finder</span>.<span style=" color: #000087;">find</span>(<span style=" color: #000087;">x_train</span>, <span style=" color: #000087;">y_train</span>, <span style=" color: #000087;">start_lr</span>=<span style=" color: #F60;">O.OOO1</span>, <span style=" color: #000087;">end_lr</span>=<span style=" color: #F60;">1O</span>, <span style=" color: #000087;">batch_size</span>=<span style=" color: #F60;">512</span>, <span style=" color: #000087;">epochs</span>=<span style=" color: #F60;">5</span>)</p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">lr_finder</span>.<span style=" color: #000087;">plot_loss</span>(<span style=" color: #000087;">n_skip_beginning</span>=<span style=" color: #F60;">2O</span>, <span style=" color: #000087;">n_skip_end</span>=<span style=" color: #F60;">5</span>)</p><p class="s100" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Figure 6-6 <span style=" color: #000;">shows the plot of loss versus learning rate. It becomes evident that a learning rate of 10–4 or 10–3 might be too low (owing to barely any drop in loss), and similarly, above 1 might be too high (because of the rapid increase in loss).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 24pt;text-indent: 0pt;text-align: left;"><span><img width="545" height="373" alt="image" src="KerasTensorFlow2019/Image_398.jpg"/></span></p><p class="s86" style="padding-top: 7pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a name="bookmark674">Figure 6-6. A graph showing the change in loss as the learning rate is increased</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark675" class="s110">What we are most interested in is the point of the greatest decrease in loss. After all, we want to minimize the time we spend in getting to the least loss during training. In </a><span style=" color: #8E0012;">Figure 6-7</span>, we plot the <i>rate of change </i>of loss — the derivative of the loss with regard to the learning rate:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s102" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"># Show Simple Moving Average over 20 points to smoothen the graph</p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">lr_finder</span>.<span style=" color: #000087;">plot_loss_change</span>(<span style=" color: #000087;">sma</span>=<span style=" color: #F60;">2O</span>, <span style=" color: #000087;">n_skip_beginning</span>=<span style=" color: #F60;">2O</span>, <span style=" color: #000087;">n_skip_end</span>=<span style=" color: #F60;">5</span>,</p><p class="s91" style="padding-left: 170pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">y_lim</span>=(-<span style=" color: #F60;">O.O1</span>, <span style=" color: #F60;">O.O1</span>))</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 23pt;text-indent: 0pt;text-align: left;"><span><img width="545" height="353" alt="image" src="KerasTensorFlow2019/Image_399.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s86" style="padding-top: 4pt;padding-left: 202pt;text-indent: -171pt;text-align: left;"><a name="bookmark675">Figure 6-7. A graph showing the rate of change in loss as the learning rate is increased</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">These figures show that values around 0.1 would lead to the fastest decrease in loss, and hence we would choose it as our optimal learning rate.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark582">Use tf.function</a><a name="bookmark676">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark677">Eager execution mode, which is turned on by default in TensorFlow 2.0, allows users to execute code line by line and immediately see the results. This is immensely helpful in development and debugging. This is in contrast to TensorFlow 1.x, for which the user had to build all operations as a graph and then execute them in one go to see the results. This made debugging a nightmare!</a></p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Does the added flexibility from eager execution come at a cost? Yes, a tiny one, typically in the order of microseconds, which can essentially be ignored for large compute-intensive operations, like training ResNet-</p><ol id="l12"><li><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">But where there are many small operations, eager execution can have a sizable impact.</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">We can overcome this by two approaches:</p><p class="s88" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Disabling eager execution</p><p class="s83" style="padding-top: 4pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">For TensorFlow 1.x, not enabling eager execution will let the system optimize the program flow as a graph and run it faster.</p><p class="s88" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Use <span class="s87">tf.function</span></p><p class="s83" style="padding-top: 3pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">In TensorFlow 2.x, you cannot disable eager execution (there is a compatibility API, but we shouldn’t be using that for anything other than migration from TensorFlow 1.x). Instead, any function that could benefit from a speedup by executing in graph mode can simply be annotated with <span class="s90">@tf.function</span>. It’s worth noting that any function that is called within an annotated function will also run in graph mode. This gives us the advantage of speedup from graph- based execution without sacrificing the debugging capabilities of eager execution. Typically, the best speedup is observed on short computationally intensive tasks:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">conv_layer </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">Conv2D</span>(<span style=" color: #F60;">224</span>, <span style=" color: #F60;">3</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span class="s103">def </span><span style=" color: #C0F;">non_tf_func</span>(<span style=" color: #000087;">image</span>):</p><p class="s91" style="padding-left: 31pt;text-indent: 0pt;text-align: left;"><span class="s103">for </span><span style=" color: #000087;">_ </span><b>in </b><span style=" color: #366;">range</span>(<span style=" color: #F60;">1</span>,<span style=" color: #F60;">3</span>):</p><p class="s96" style="padding-left: 65pt;text-indent: 0pt;text-align: left;">conv_layer<span style=" color: #000;">(</span>image<span style=" color: #000;">)</span></p><p class="s103" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">return</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s111" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">@tf<span style=" color: #000;">.</span><span style=" color: #000087;">function</span></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span class="s103">def </span><span style=" color: #C0F;">tf_func</span>(<span style=" color: #000087;">image</span>):</p><p class="s91" style="padding-left: 31pt;text-indent: 0pt;text-align: left;"><span class="s103">for </span><span style=" color: #000087;">_ </span><b>in </b><span style=" color: #366;">range</span>(<span style=" color: #F60;">1</span>,<span style=" color: #F60;">3</span>):</p><p class="s96" style="padding-left: 65pt;text-indent: 0pt;text-align: left;">conv_layer<span style=" color: #000;">(</span>image<span style=" color: #000;">)</span></p><p class="s103" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">return</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">mat </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">zeros</span>([<span style=" color: #F60;">1</span>, <span style=" color: #F60;">1OO</span>, <span style=" color: #F60;">1OO</span>, <span style=" color: #F60;">1OO</span>])</p><p class="s96" style="padding-top: 4pt;padding-left: 20pt;text-indent: 0pt;text-align: left;"><span class="s102"># Warm up </span>non_tf_func<span style=" color: #000;">(</span>mat<span style=" color: #000;">) </span>tf_func<span style=" color: #000;">(</span>mat<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 76pt;text-indent: -55pt;text-align: left;"><span style=" color: #366;">print</span>(<span style=" color: #C30;">&quot;Without @tf.function:&quot;</span>, <span style=" color: #000087;">timeit</span>.<span style=" color: #000087;">timeit</span>(<span class="s103">lambda</span>: <span style=" color: #000087;">non_tf_func</span>(<span style=" color: #000087;">mat</span>), <span style=" color: #000087;">number</span>=<span style=" color: #F60;">1OOOO</span>), <span style=" color: #C30;">&quot; seconds&quot;</span>)</p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #366;">print</span>(<span style=" color: #C30;">&quot;With @tf.function:&quot;</span>, <span style=" color: #000087;">timeit</span>.<span style=" color: #000087;">timeit</span>(<span class="s103">lambda</span>: <span style=" color: #000087;">tf_func</span>(<span style=" color: #000087;">mat</span>), <span style=" color: #000087;">number</span>=<span style=" color: #F60;">1OOOO</span>),</p><p class="s97" style="padding-left: 76pt;text-indent: 0pt;text-align: left;">&quot;seconds&quot;<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-top: 6pt;padding-left: 20pt;text-indent: 0pt;text-align: left;">=====Output=====</p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">Without @tf.function: 7.234O16112O519O4 seconds With @tf.function: O.751O97829O811181 seconds</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;">As we can see in our contrived example, simply attributing a function with <span class="s90">@tf.function </span>has given us a speedup of 10 times, from 7.2 seconds to 0.7 seconds.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark583">Overtrain, and Then Generalize</a><a name="bookmark678">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark679">In machine learning, overtraining on a dataset is considered to be harmful. However, we will demonstrate that we can use overtraining in a controlled fashion to our advantage to make training faster.</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="533" height="355" alt="image" src="KerasTensorFlow2019/Image_400.png"/></span></p><p class="s93" style="padding-top: 9pt;padding-left: 179pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s94" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">To further clarify the idea of overtraining and then generalizing, let’s look at an imperfect analogy of language learning. Suppose that you want to learn French. One way is to throw a book of vocabulary and grammar at you and expect you to memorize everything. Sure, you might go through the book every day and maybe in a few years, you might be able to speak some French. But this would not be the optimal way to learn.</p><p class="s94" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Alternatively, we could look at how language learning programs approach this process. These programs introduce you to only a small set of words and grammatical rules initially. After you have learned them, you will be able to speak some broken French. Maybe you could ask for a cup of coffee at a restaurant or ask for directions at a bus stop. At this point, you will be introduced constantly to a larger set of words and rules, and this will help you to improve over time.</p><p class="s94" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">This process is similar to how our model would learn gradually with more and more data.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">As the saying goes, “The perfect is the enemy of the good.” We don’t want our network to be perfect right off the bat. In fact, we wouldn’t even want it to be any good initially. What we really want instead is for it to be learning <i>something </i>quickly, even if imperfectly. Because then we have a good baseline that we can fine tune to its highest potential. And experiments have shown that we can get to the end of the journey faster than training conventionally.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: justify;">How do we force a network to learn quickly and imperfectly? Make it overtrain on our data. The following three strategies can help.</p><p class="s109" style="padding-top: 13pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;"><a name="bookmark584">Use progressive sampling</a><a name="bookmark680">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: justify;"><a name="bookmark681">One approach to overtrain and then generalize is to progressively show more and more of the original training set to the model. Here’s a simple implementation:</a></p><ol id="l13"><li><p class="s83" style="padding-top: 4pt;padding-left: 55pt;text-indent: -15pt;text-align: justify;">Take a sample of the dataset (say, roughly 10%).</p></li><li><p class="s83" style="padding-top: 3pt;padding-left: 55pt;text-indent: -15pt;text-align: left;">Train the network until it converges; in other words, until it begins to perform well on the training set.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s83" style="padding-left: 55pt;text-indent: -15pt;text-align: left;">Train on a larger sample (or even the entire training set).</p></li></ol></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">By repeatedly showing a smaller sample of the dataset, the network will learn features much more quickly, but only related to the sample shown. Hence, it would tend to overtrain, usually performing better on the training set compared to the test set. When that happens, exposing the training process to the entire dataset will tend to generalize its learning, and eventually the test set performance would increase.</p><p class="s109" style="padding-top: 13pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark585">Use progressive augmentation</a><a name="bookmark682">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark683">Another approach is to train on the entire dataset with little to no data augmentation at first, and then progressively increase the degree of augmentation.</a></p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">By showing the unaugmented images repeatedly, the network would learn patterns faster, and by progressively increasing the degree of augmentation, it would become more robust.</p><p class="s109" style="padding-top: 13pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark586">Use progressive resizing</a><a name="bookmark684">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark685">Another approach, made famous by Jeremy Howard from fast.ai (which offers free courses on AI), is progressive resizing. The key idea behind this approach is to train first on images scaled down to smaller pixel size, and then progressively fine tune on larger and larger sizes until the original image size is reached.</a></p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Images resized by half along both the width and height have a 75% reduction in pixels, and theoretically could lead to an increase in training speed of four times over the original images. Similarly, resizing to a quarter of the original height and width can in the best case lead to 16-times reduction (at a lower accuracy). Smaller images have fewer details visible, forcing the network to instead learn higher-level features including broad shapes and colors. Then, training with larger images will help the network learn the finer details, progressively increasing the test accuracy, as well. Just like a child is taught the high-level concepts first and then progressively exposed to more details in later years, the same concept is applied here to CNNs.</p><p class="s93" style="padding-top: 9pt;padding-left: 179pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s94" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;">You can experiment with a combination of any of these methods or even build your own creative methods such as training on a subset of classes and then generalizing to all the classes later.</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="533" height="118" alt="image" src="KerasTensorFlow2019/Image_401.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark587">Install an Optimized Stack for the Hardware</a><a name="bookmark686">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark687">Hosted binaries for open source packages are usually built to run on a variety of hardware and software configurations. These packages try to appeal to the least common denominator. When we do </a><span class="s90">pip install </span>on a package, we end up downloading and installing this general-purpose, works-for-everyone binary. This convenience comes at the expense of not being able to take advantage of the specific features offered by a particular hardware stack. This issue is one of the big reasons to avoid installing prebuilt binaries and instead opt for building packages from source.</p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 110%;text-align: left;">As an example, Google has a single TensorFlow package on <span class="s90">pip </span>that can run on an old Sandy Bridge (second-generation Core i3) laptop as well as a powerful 16-core Intel Xeon server. Although convenient, the downside of this is that this package does not take advantage of the highly powerful hardware of the Xeon server. Hence, for CPU-based training and inference, Google recommends compiling TensorFlow from source to best optimize for the hardware at hand.</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">One way to do this manually is by setting the configuration flags for the hardware before building the source code. For example, to enable support for AVX2 and SSE 4.2 instruction sets, we can simply execute the following build command (note the extra <span class="s90">m </span>character ahead of each instruction set in the command):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">$ bazel build -c opt --copt=<b>-mavx2 </b>--copt=<b>-msse4.2</b></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">//tensorflow/tools/pip_package:build_pip_package</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">How do you check which CPU features are available? Use the following command (Linux only):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">$ lscpu | grep Flags</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">Flags: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36</p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc cpuid aperfmperf pni pclmulqdq dtes64 monitor ds_cpl vmx est tm2 ssse3 sdbg fma cx16</p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">xtpr pdcm pcid dca sse4_1 <b>sse4_2 </b>x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand lahf_lm abm 3dnowprefetch</p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">cpuid_fault epb cat_l3 cdp_l3 invpcid_single pti intel_ppin ssbd ibrs ibpb stibp</p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 hle <b>avx2 </b>smep bmi2</p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">erms invpcid rtm cqm rdt_a rdseed adx smap intel_pt xsaveopt cqm_llc</p><p class="s91" style="padding-top: 4pt;padding-left: 20pt;text-indent: 0pt;text-align: left;">cqm_occup_llc cqm_mbm_total cqm_mbm_local dtherm ida arat pln pts md_clear flush_l1d</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s100" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="https://anaconda.com/" class="s110" target="_blank">Building TensorFlow from source with the appropriate instruction set specified as build flags should result in a substantial increase in speed. The downside here is that building from source can take quite some time, at least a couple of hours. Alternatively, we can use Anaconda to download and install a highly optimized variant of TensorFlow, built by Intel on top of their Math Kernel Library for Deep Neural Networks (MKL-DNN). The installation process is pretty straightforward. First, we install the </a>Anaconda <span style=" color: #000;">package manager. Then, we run the following command:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s92" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"># For Linux and Mac</p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">$ conda install tensorflow</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s92" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"># For Windows</p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">$ conda install tensorflow-mkl</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">On Xeon CPUs, MKL-DNN often provides upward of two-times speedup in inference.</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 110%;text-align: left;">How about optimization for GPUs? Because NVIDIA abstracts away the differences between the various GPU internals with the CUDA library, there is usually no need to build from source. Instead, we could simply install a GPU variant of TensorFlow from <span class="s90">pip </span>(<span class="s90">tensorflow-gpu </span><a href="https://oreil.ly/4AUxp" class="s110" target="_blank">package). We recommend the </a><span style=" color: #8E0012;">Lambda Stack </span>one-liner installer for convenience (along with NVIDIA drivers, CUDA, and cuDNN).</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">For training and inference on the cloud, AWS, Microsoft Azure, and GCP all provide GPU machine images of TensorFlow optimized for their hardware. It’s quick to spin up multiple instances and get started.</p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Additionally, NVIDIA offers GPU-accelerated containers for on- premises and cloud setups.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark588">Optimize the Number of Parallel CPU Threads</a><a name="bookmark688">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark689">Compare the following two examples:</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s102" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"># Example 1</p><p class="s96" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">X <span style=" color: #000;">= </span>tf<span style=" color: #000;">.</span>multiply<span style=" color: #000;">(</span>A<span style=" color: #000;">, </span>B<span style=" color: #000;">) </span>Y <span style=" color: #000;">= </span>tf<span style=" color: #000;">.</span>multiply<span style=" color: #000;">(</span>C<span style=" color: #000;">, </span>D<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s102" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"># Example 2</p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">X </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">multiply</span>(<span style=" color: #000087;">A</span>, <span style=" color: #000087;">B</span>) <span style=" color: #000087;">Y </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">multiply</span>(<span class="s99">X</span>, <span style=" color: #000087;">C</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">There are a couple of areas in these examples where we can exploit inherent parallelism:</p><p class="s88" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Between operations</p><p class="s83" style="padding-top: 4pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">In example 1, the calculation of Y does not depend on the calculation of X. This is because there is no shared data between those two operations, and thus both of them can execute in parallel on two separate threads.</p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">In contrast, in example 2, the calculation of Y depends on the outcome of the first operation (X), and so the second statement cannot execute until the first statement completes execution.</p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">The configuration for the maximum number of threads that can be used for interoperation parallelism is set using the following statement:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s96" style="padding-left: 48pt;text-indent: 0pt;text-align: left;">tf<span style=" color: #000;">.</span>config<span style=" color: #000;">.</span>threading<span style=" color: #000;">.</span>set_inter_op_parallelism_threads<span style=" color: #000;">(</span>num_threads<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 6pt;padding-left: 34pt;text-indent: 0pt;text-align: justify;">The recommended number of threads is equal to the number of CPUs (sockets) on the machine. This value can be obtained by using the <span class="s90">lscpu </span>command (Linux only).</p><p class="s88" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Per-operation level</p><p class="s83" style="padding-top: 3pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">We can also exploit the parallelism within a single operation. Operations such as matrix multiplications are inherently parallelizable.</p><p class="s100" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">Figure 6-8 <span style=" color: #000;">demonstrates a simple matrix multiplication operation. It’s clear that the overall product can be split into four independent calculations. After all, the product between one row of a matrix and one column of another matrix does not depend on the calculations for the other rows and columns. Each of those splits could potentially get its own thread and all four of them could execute at the same time.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 39pt;text-indent: 0pt;text-align: left;"><span><img width="552" height="57" alt="image" src="KerasTensorFlow2019/Image_402.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s86" style="padding-top: 4pt;padding-left: 175pt;text-indent: -108pt;text-align: left;"><a name="bookmark690">Figure 6-8. A matrix multiplication for A x B operation with one of the multiplications highlighted</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">The configuration for the number of threads that can be used for intraoperation parallelism is set using the following statement:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s96" style="padding-left: 48pt;text-indent: 0pt;text-align: left;">tf<span style=" color: #000;">.</span>config<span style=" color: #000;">.</span>threading<span style=" color: #000;">.</span>set_intra_op_parallelism_threads<span style=" color: #000;">(</span>num_threads<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 6pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">The recommended number of threads is equal to the number of cores per CPU. You can obtain this value by using the <span class="s90">lscpu </span>command on Linux.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark589">Use Better Hardware</a><a name="bookmark691">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark692">If you have already maximized performance optimizations and still need faster training, you might be ready for some new hardware. Replacing spinning hard drives with SSDs can go a long way, as can adding one or more better GPUs. And let’s not forget, sometimes the CPU can be the culprit.</a></p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">In fact, you might not need to spend much money: public clouds like AWS, Azure, and GCP all provide the ability to rent powerful configurations for a few dollars per hour. Best of all, they come with optimized TensorFlow stacks preinstalled.</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Of course, if you have the cash to spend or have a rather generous expense account, you could just skip this entire chapter and buy the 2- petaFLOPS NVIDIA DGX-2. Weighing in at 163 kgs (360 pounds), its 16 V100 GPUs (with a total of 81,920 CUDA cores) consume 10 kW of power — the equivalent of seven large window air conditioners. And all it costs is $400,000!</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 93pt;text-indent: 0pt;text-align: left;"><span><img width="373" height="255" alt="image" src="KerasTensorFlow2019/Image_403.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s86" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">Figure 6-9. The $400,000 NVIDIA DGX-2 deep learning system</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark590">Distribute Training</a><a name="bookmark693">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">“<i>Two lines to scale training horizontally!</i>”</p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark694">On a single machine with a single GPU, there’s only so far that we can go. Even the beefiest GPUs have an upper limit in compute power.</a></p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Vertical scaling can take us only so far. Instead, we look to scale horizontally — distribute computation across processors. We can do this across multiple GPUs, TPUs, or even multiple machines. In fact, that is exactly what researchers at Google Brain did back in 2012, using 16,000 processors to run a neural network built to look at cats on YouTube.</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">In the dark days of the early 2010s, training on ImageNet used to take anywhere from several weeks to months. Multiple GPUs would speed things up, but few people had the technical know-how to configure such a setup. It was practically out of reach for beginners. Luckily, we live in the day of TensorFlow 2.0, in which setting up distributed training is a matter of introducing two lines of code:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s96" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">mirrored_strategy <span style=" color: #000;">= </span>tf<span style=" color: #000;">.</span>distribute<span style=" color: #000;">.</span>MirroredStrategy<span style=" color: #000;">()</span></p><p class="s96" style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span class="s103">with </span>mirrored_strategy<span style=" color: #000;">.</span>scope<span style=" color: #000;">():</span></p><p class="s91" style="padding-left: 31pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">model </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">applications</span>.<span style=" color: #000087;">ResNet5O</span>() <span style=" color: #000087;">model</span>.<span style=" color: #000087;">compile</span>(<span style=" color: #000087;">loss</span>=<span style=" color: #C30;">&quot;mse&quot;</span>, <span style=" color: #000087;">optimizer</span>=<span style=" color: #C30;">&quot;sgd&quot;</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Training speed increases nearly proportionally (90–95%) in relation to the number of GPUs added. As an example, if we added four GPUs (of similar compute power), we would notice an increase of &gt;3.6 times speedup ideally.</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Still, a single system can only support a limited number of GPUs. How about multiple nodes, each with multiple GPUs? Similar to <span class="s90">MirroredStrategy</span>, we can use <span class="s90">MultiWorkerMirroredStrategy</span><a href="#bookmark695" class="s110">. This is quite useful when building a cluster on the cloud. </a><span style=" color: #8E0012;">Table 6-1 </span>presents a couple of distribution strategies for different use cases.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s88" style="padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark695">Table 6-1. Recommended distribution strategies</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 39pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="502" height="1" alt="image" src="KerasTensorFlow2019/Image_404.png"/></span></p><p class="s112" style="padding-top: 2pt;padding-bottom: 3pt;padding-left: 42pt;text-indent: 0pt;text-align: left;">Strategy Use case</p><p style="padding-left: 39pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="497" height="1" alt="image" src="KerasTensorFlow2019/Image_405.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="502" height="35" alt="image" src="KerasTensorFlow2019/Image_406.png"/></span></p><p class="s113" style="padding-top: 6pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">MultiWorkerMirroredStrategy <span class="s94">Multiple nodes with one or more GPUs each</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s113" style="padding-top: 6pt;padding-left: 42pt;text-indent: 0pt;text-align: left;">MirroredStrategy <span class="s94">Single node with two or more GPUs</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="533" height="333" alt="image" src="KerasTensorFlow2019/Image_407.png"/></span></p><p class="s93" style="padding-top: 9pt;padding-left: 179pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s94" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">The open source Horovod library from Uber is another high-performance and easy-to-use distribution framework. Many of the record benchmark performances seen in the next section require distributed training on several nodes, and Horovod’s performance helped them get the edge. It is worth noting that the majority of the industry uses Horovod particularly because distributed training on earlier versions of TensorFlow was a much more involved process. Additionally, Horovod works with all major deep learning libraries with minimal amount of code change or expertise. Often configured through the command line, running a distributed program on four nodes, each with four GPUs, can be done in a single command line:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s113" style="padding-left: 19pt;text-indent: 0pt;line-height: 108%;text-align: left;">$ horovodrun -np 16 -H server1:4,server2:4,server3:4,server4:4 python train.py</p><p style="text-indent: 0pt;text-align: left;"/><p class="s83" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 110%;text-align: left;">To get the cluster nodes to communicate with one another for <span class="s90">MultiWorkerMirroredStrategy</span>, we need to configure the <span class="s90">TF_CONFIG </span>environment variable on every single host. This requires setting up a JSON object that contains the IP addresses and ports of all other hosts in the cluster. Manually managing this can be error prone, and this is where orchestration frameworks like Kubernetes really shine.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark591">Examine Industry Benchmarks</a><a name="bookmark696">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark697">Three things were universally popular in the 1980s — long hair, the Walkman, and database benchmarks. Much like the current hype of deep learning, database software was similarly going through a phase of making bold promises, some of which were marketing hype. To put these companies to the test, a few benchmarks were introduced, more famously among them was the Transaction Processing Council (TPC) benchmark. When someone needed to buy database software, they could rely on this public benchmark to decide where to spend their company’s budget. This competition fueled rapid innovation, increasing speed and performance per dollar, moving the industry ahead faster than anticipated.</a></p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Inspired by TPC and other benchmarks, a few system benchmarks were created to standardize performance reporting in machine learning.</p><p class="s88" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">DAWNBench</p><p class="s83" style="padding-top: 4pt;padding-left: 34pt;text-indent: 0pt;text-align: left;"><a name="bookmark698">Stanford’s DAWNBench benchmarks time and cost to get a model to 93% Top-5 accuracy on ImageNet. Additionally, it also does a time and cost leaderboard on inference time. It’s worth appreciating the rapid pace of performance improvement for training such a massive network. When DAWNBench originally started in September 2017, the reference entry trained in 13 days at a cost of $2,323.39. In just one and a half years since then, although the cheapest training costs as low as $12, the fastest training time is 2 minutes 43 seconds. Best of all, most entries contain the training source code and optimizations that can be studied and replicated by us. This gives further guidance on the effects of hyperparameters and how we can use the cloud for cheap and fast training without breaking the bank.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s88" style="padding-left: 63pt;text-indent: -45pt;text-align: left;"><a name="bookmark699">Table 6-2. Entries on DAWNBench as of August 2019, sorted by the least cost for training a model to 93% Top-5 accuracy</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="582" height="1" alt="image" src="KerasTensorFlow2019/Image_408.png"/></span></p><p class="s112" style="padding-top: 2pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Cost (USD)</p><p class="s112" style="padding-top: 2pt;padding-left: 8pt;text-indent: 0pt;text-align: left;">Training time</p><p class="s112" style="padding-top: 2pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Model Hardware Framework</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="582" height="1" alt="image" src="KerasTensorFlow2019/Image_409.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s94" style="padding-top: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">$12.60 2:44:31 ResNet-50</p><p class="s94" style="padding-top: 6pt;padding-left: 104pt;text-indent: 0pt;text-align: left;">Google Cloud TPU</p><p class="s94" style="padding-top: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">GCP n1-standard- 2, Cloud TPU</p><p class="s94" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">TensorFlow 1.11</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="582" height="1" alt="image" src="KerasTensorFlow2019/Image_410.png"/></span></p><table style="border-collapse:collapse;margin-left:6.87191pt" cellspacing="0"><tr style="height:17pt"><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s114" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 13pt;text-align: left;">Cost</p></td><td style="width:53pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s114" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 13pt;text-align: left;">Training</p></td><td style="width:116pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s114" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 13pt;text-align: left;">Model</p></td><td style="width:137pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s114" style="padding-top: 2pt;padding-left: 41pt;text-indent: 0pt;line-height: 13pt;text-align: left;">Hardware</p></td><td style="width:93pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s114" style="padding-top: 2pt;padding-left: 7pt;text-indent: 0pt;line-height: 13pt;text-align: left;">Framework</p></td></tr><tr style="height:18pt"><td style="width:42pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s114" style="padding-left: 3pt;text-indent: 0pt;text-align: left;">(USD)</p></td><td style="width:53pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s114" style="padding-left: 3pt;text-indent: 0pt;text-align: left;">time</p></td><td style="width:116pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:137pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:93pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:64pt"><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 7pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">$20.89</p></td><td style="width:53pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 7pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">1:42:23</p></td><td style="width:116pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 1pt;padding-left: 3pt;padding-right: 43pt;text-indent: 0pt;line-height: 20pt;text-align: left;">ResNet-50 Setu Chokshi (MS AI MVP)</p></td><td style="width:137pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 7pt;padding-left: 41pt;text-indent: 0pt;text-align: left;">Azure ND40s_v2</p></td><td style="width:93pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 7pt;padding-left: 7pt;text-indent: 0pt;text-align: left;">PyTorch 1.0</p></td></tr><tr style="height:22pt"><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s115" style="padding-top: 7pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">$42.66</p></td><td style="width:53pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s115" style="padding-top: 7pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">1:44:34</p></td><td style="width:116pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s115" style="padding-top: 7pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">ResNet-50 v1</p></td><td style="width:137pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s115" style="padding-top: 7pt;padding-left: 41pt;text-indent: 0pt;line-height: 12pt;text-align: left;">8*V100 (single</p></td><td style="width:93pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s115" style="padding-top: 7pt;padding-left: 7pt;text-indent: 0pt;line-height: 12pt;text-align: left;">TensorFlow</p></td></tr></table><p class="s94" style="padding-top: 6pt;padding-left: 104pt;text-indent: 0pt;line-height: 147%;text-align: left;">GE Healthcare (Min Zhang)</p><p class="s94" style="padding-top: 6pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">$48.48 0:29:43 ResNet-50</p><p class="s94" style="padding-top: 6pt;padding-left: 104pt;text-indent: 0pt;text-align: left;">Andrew Shaw, Yaroslav Bulatov, Jeremy Howard</p><p class="s94" style="padding-top: 1pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">p3.16x large)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="80" alt="image" src="KerasTensorFlow2019/Image_411.png"/></span></p><p class="s94" style="padding-top: 7pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">32 * V100</p><p class="s94" style="padding-top: 6pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">(4x - AWS p3.16x</p><p class="s94" style="padding-left: 10pt;text-indent: 0pt;text-align: left;">large)</p><p class="s94" style="padding-top: 1pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">1.11 + Horovod</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s94" style="padding-top: 7pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Ncluster + PyTorch 0.5</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s88" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">MLPerf</p><p class="s100" style="padding-top: 3pt;padding-left: 34pt;text-indent: 0pt;text-align: left;"><a href="#bookmark699" class="s110" name="bookmark700">Similar to DAWNBench, MLPerf is aimed at repeatable and fair testing of AI system performance. Although newer than DAWNBench, this is an industry consortium with much wider support, especially on the hardware side. It runs challenges for both training and inference in two divisions: open and closed. The closed division trains the same model with the same optimizers, so the raw hardware performance can be compared apples-to-apples. The open division, on the other hand, allows using faster models and optimizers to allow for more rapid progress. Compared to the more cost-effective entries in DAWNBench in </a>Table 6-2<a href="#bookmark701" class="s110">, the top performers on MLPerf as shown in </a>Table 6-3 <span style=" color: #000;">might be a bit out of reach for most of us. The top-performing NVIDIA DGX SuperPod, composed of 96 DGX-2H with a total of 1,536 V100 GPUs, costs in the $35 to $40 million range. Even though 1,024 Google TPUs might themselves cost in the several millions, they are each available to rent on the cloud at $8/hour on-demand pricing (as of August 2019), resulting in a net cost of under $275 for the less- than two minutes of training time.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s88" style="padding-left: 53pt;text-indent: 0pt;text-align: center;"><a name="bookmark701">Table 6-3. Key closed-division entries on DAWNBench as of August 2019, showing training time for a ResNet-50 model to get to 75.9% Top-1 accuracy</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:43.7593pt" cellspacing="0"><tr style="height:19pt"><td style="width:89pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s114" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Time (minutes)</p></td><td style="width:62pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s114" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Submitter</p></td><td style="width:73pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s114" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Hardware</p></td><td style="width:72pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s114" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Accelerator</p></td><td style="width:100pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s114" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;"># of accelerators</p></td></tr><tr style="height:19pt"><td style="width:89pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">1.28</p></td><td style="width:62pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Google</p></td><td style="width:73pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">TPUv3</p></td><td style="width:72pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">TPUv3</p></td><td style="width:100pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">1,024</p></td></tr><tr style="height:19pt"><td style="width:89pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">1.33</p></td><td style="width:62pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">NVIDIA</p></td><td style="width:73pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">96x DGX-2H</p></td><td style="width:72pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Tesla V100</p></td><td style="width:100pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">1,536</p></td></tr><tr style="height:19pt"><td style="width:89pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">8,831.3</p></td><td style="width:62pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Reference</p></td><td style="width:73pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Pascal P100</p></td><td style="width:72pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Pascal P100</p></td><td style="width:100pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">1</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark702">Although both the aforementioned benchmarks highlight training as well as inference (usually on more powerful devices), there are other inference-specific competitions on low-power devices, with the aim to maximize accuracy and speed while reducing power consumption. Held at annual conferences, here are some of these competitions:</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_412.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_413.png"/></span></p><p class="s83" style="padding-top: 4pt;padding-left: 34pt;text-indent: 0pt;line-height: 186%;text-align: left;">LPIRC: Low-Power Image Recognition Challenge EDLDC: Embedded Deep Learning Design Contest</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_414.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;line-height: 16pt;text-align: left;">System Design Contest at Design Automation Conference (DAC)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s84" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark592">Inference</a><a name="bookmark703">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: justify;"><a name="bookmark704">Training our model is only half the game. We eventually need to serve the predictions to our users. The following points guide you to making your serving side more performant.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark593">Use an Efficient Model</a><a name="bookmark705">&zwnj;</a></p><p class="s100" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark707" class="s110" name="bookmark706">Deep learning competitions have traditionally been a race to come up with the highest accuracy model, get on top of the leaderboard, and get the bragging rights. But practitioners live in a different world — the world of serving their users quickly and efficiently. With devices like smartphones, edge devices, and servers with thousands of calls per second, being efficient on all fronts (model size and computation) is critically needed. After all, many machines would not be capable of serving a half gigabyte VGG-16 model, which happens to need 30 billion operations to execute, for not even that high of accuracy. Among the wide variety of pretrained architectures available, some are on the higher end of accuracy but large and resource intensive, whereas others provide modest accuracy but are much lighter. Our goal is to pick the architecture that can deliver the highest accuracy for the available computational power and memory budget of our inference device. In </a>Figure 6-10<span style=" color: #000;">, we want to pick models in the upper-left zone.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 30pt;text-indent: 0pt;text-align: left;"><span><img width="540" height="373" alt="image" src="KerasTensorFlow2019/Image_415.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s86" style="padding-top: 4pt;padding-left: 13pt;text-indent: 0pt;text-align: center;"><a name="bookmark707">Figure 6-10. Comparing different models for size, accuracy, and operations per second (adapted from “An Analysis of Deep Neural Network Models for Practical Applications” by Alfredo Canziani, Adam Paszke, and Eugenio Culurciello)</a></p><p class="s100" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark707" class="s110">Usually, the approximately 15 MB MobileNet family is the go-to model for efficient smartphone runtimes, with more recent versions like MobileNetV2 and MobileNetV3 being better than their predecessors. Additionally, by varying the hyperparameters of the MobileNet models like depth multiplier, the number of computations can be further reduced, making it ideal for real-time applications. Since 2017, the task of generating the most optimal architecture to maximize accuracy has also been automated with NAS. It has helped discover new (rather obfuscated looking) architectures that have broken the ImageNet accuracy metric multiple times. For example, FixResNeXt (based on PNASNet architecture at 829 MB) reaches a whopping 86.4% Top-1 accuracy on ImageNet. So, it was natural for the research community to ask whether NAS helps find architecture that’s tuned for mobile, maximizing accuracy while minimizing computations. The answer is a resounding yes — resulting in faster and better models, optimized for the hardware at hand. As an example, MixNet (July 2019) outperforms many state-of-the-art models. Note how we went from billions of floating-point operations to millions (</a>Figure 6-10 <a href="#bookmark708" class="s110">and </a>Figure 6-11<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span><img width="552" height="324" alt="image" src="KerasTensorFlow2019/Image_416.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s86" style="padding-top: 4pt;padding-left: 42pt;text-indent: -20pt;text-align: left;"><a name="bookmark708">Figure 6-11. Comparison of several mobile-friendly models in the paper “MixNet: Mixed Depthwise Convolution Kernels” by Mingxing Tan and Quoc V. Le</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">As practitioners, where can we find current state-of-the-art models? <i>PapersWithCode.com/SOTA </i>showcases leaderboards on several AI problems, comparing paper results over time, along with the model</p><p style="text-indent: 0pt;text-align: left;"><span><img width="533" height="100" alt="image" src="KerasTensorFlow2019/Image_417.png"/></span></p><p class="s93" style="padding-top: 9pt;padding-left: 179pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s94" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="https://oreil.ly/Piq40" style=" color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11.5pt;" target="_blank">Shortly after Google AI researchers publish a paper, they release the model used in the paper on the </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11.5pt;">TensorFlow Models </span>repository.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s83" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">code. Of particular interest would be the models with a low number of parameters that achieve high accuracies. For example, EfficientNet gets an amazing Top-1 84.4% accuracy with 66 million parameters, so it could be an ideal candidate for running on servers. Additionally, the ImageNet test metrics are on 1,000 classes, whereas our case might just require classification on a few classes. For those cases, a much smaller model would suffice. Models listed in Keras Application (<i>tf.keras.applications</i>), TensorFlow Hub, and TensorFlow Models usually carry many variations (input image sizes, depth multipliers, quantizations, etc.).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark594">Quantize the Model</a><a name="bookmark709">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">“<i>Represent 32-bit weights to 8-bit integer, get 2x faster, 4x smaller models</i>”</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark710">Neural networks are driven primarily by matrix–matrix multiplications. The arithmetic involved tends to be rather forgiving in that small deviations in values do not cause a significant swing in output. This makes neural networks fairly robust to noise. After all, we want to be able to recognize an apple in a picture, even in less-than-perfect lighting. When we quantize, we essentially take advantage of this “forgiving” nature of neural networks.</a></p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;">Before we look at the different quantization techniques, let’s first try to build an intuition for it. To illustrate quantized representations with a simple example, we’ll convert 32-bit floating-point weights to INT8 (8-bit integer) using <i>linear quantization</i>. Obviously, FP32 represents 232 values (hence, 4 bytes to store), whereas INT8 represents 28 = 256 values (1 byte). To quantize:</p><ol id="l14"><li><p class="s83" style="padding-top: 3pt;padding-left: 55pt;text-indent: -15pt;text-align: left;">Find the minimum and maximum values represented by FP32 weights in the neural network.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s83" style="padding-left: 55pt;text-indent: -15pt;text-align: left;">Divide this range into 256 intervals, each corresponding to an INT8 value.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s83" style="padding-left: 55pt;text-indent: -15pt;text-align: left;">Calculate a scaling factor that converts an INT8 (integer) back to a FP32. For example, if our original range is from 0 to 1, and INT8 numbers are 0 to 255, the scaling factor will be 1/256.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s83" style="padding-left: 55pt;text-indent: -15pt;text-align: left;">Replace FP32 numbers in each interval with the INT8 value. Additionally, store the scaling factor for the inference stage where we convert INT8 values back to FP32 values. This scaling factor only needs to be stored once for the entire group of quantized values.</p></li><li><p class="s100" style="padding-top: 13pt;padding-left: 55pt;text-indent: -15pt;text-align: left;"><a href="#bookmark711" class="s110">During inference calculations, multiply the INT8 values by the scaling factor to convert it back to a floating-point representation. </a>Figure 6-12 <span style=" color: #000;">illustrates an example of linear quantization for the interval [0, 1].</span></p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 44pt;text-indent: 0pt;text-align: left;"><span><img width="515" height="72" alt="image" src="KerasTensorFlow2019/Image_418.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s86" style="padding-top: 4pt;padding-left: 124pt;text-indent: -101pt;text-align: left;"><a name="bookmark711">Figure 6-12. Quantizing from a 0 to 1 32-bit floating-point range down to an 8-bit integer range for reduced storage space</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">There are a few different ways to quantize our models, the simplest one being reducing the bit representation of the weights from 32-bit to 16-bit or lower. As might be evident, converting 32-bit to 16-bit means half the memory size is needed to store a model. Similarly, converting to 8-bit would require a quarter of the size. So why not convert it to 1-bit and save 32x the size? Well, although the models are forgiving up to a certain extent, with each reduction, we will notice a drop in accuracy.</p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">This reduction in accuracy grows exponentially beyond a certain threshold (especially below 8 bits). To go below and still have a useful working model (like a 1-bit representation), we’d need to follow a special conversion process to convert them to binarized neural networks. XNOR.ai, a deep learning startup, has famously been able to bring this technique to production. The Microsoft Embedded Learning Library (ELL) similarly provides such tools, which have a lot of value for edge devices like the Raspberry Pi.</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">There are numerous benefits to quantization:</p><p class="s88" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Improved memory usage</p><p class="s83" style="padding-top: 4pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">By quantizing to 8-bit integer representation (INT8), we typically get a 75% reduction in model size. This makes it more convenient to store and load the model in memory.</p><p class="s88" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Improved performance</p><p class="s83" style="padding-top: 4pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">Integer operations are faster than floating-point operations. Additionally, the savings in memory usage reduces the likelihood of having to unload the model from RAM during execution, which also has the added benefit of decreased power consumption.</p><p class="s88" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Portability</p><p class="s83" style="padding-top: 4pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">Edge devices such as Internet of Things devices might not support floating-point arithmetic, so it would be untenable to keep the model as a floating-point in such situations.</p><p class="s83" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Most inference frameworks provide a way to quantize, including Core ML Tools from Apple, TensorRT from NVIDIA (for servers), and TensorFlow Lite, as well as the TensorFlow Model Optimization Toolkit from Google. With TensorFlow Lite, models can be quantized after training during conversion (called post-training quantization). To minimize accuracy losses even further, we can use the TensorFlow Model Optimization Toolkit during training. This process is called <i>quantization-aware training</i>.</p><p class="s100" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="https://oreil.ly/me4-I" class="s110" target="_blank">It would be useful to measure the benefit provided by quantization. Metrics from the </a>TensorFlow Lite Model optimization <a href="#bookmark712" class="s110">benchmarks (shown in </a>Table 6-4<span style=" color: #000;">) give us a hint, comparing 1) unquantized, 2) post- training quantized, and 3) quantization-aware trained models. The performance was measured on a Google Pixel 2 device.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s88" style="padding-left: 41pt;text-indent: -28pt;text-align: left;"><a name="bookmark712">Table 6-4. Effects of different quantization strategies (8-bit) on models (source: TensorFlow Lite model optimization documentation)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="582" height="1" alt="image" src="KerasTensorFlow2019/Image_419.png"/></span></p><table style="border-collapse:collapse" cellspacing="0"><tr style="height:21pt"><td style="width:141pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:68pt"><p class="s114" style="padding-top: 2pt;padding-left: 8pt;text-indent: 0pt;text-align: left;">MobileNet</p></td><td style="width:76pt"><p class="s114" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">MobileNetV2</p></td><td style="width:73pt"><p class="s114" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">InceptionV3</p></td></tr><tr style="height:27pt"><td style="width:141pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s114" style="padding-top: 8pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Original</p></td><td style="width:68pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 8pt;padding-left: 8pt;text-indent: 0pt;text-align: left;">0.709</p></td><td style="width:76pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 8pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">0.719</p></td><td style="width:73pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 8pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">0.78</p></td></tr><tr style="height:28pt"><td style="width:141pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s114" style="padding-top: 7pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Post-training quantized</p></td><td style="width:68pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 7pt;padding-left: 8pt;text-indent: 0pt;text-align: left;">0.657</p></td><td style="width:76pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 7pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">0.637</p></td><td style="width:73pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 7pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">0.772</p></td></tr><tr style="height:36pt"><td style="width:141pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s114" style="padding-top: 7pt;padding-left: 3pt;text-indent: 0pt;line-height: 14pt;text-align: left;">Quantization-aware training</p></td><td style="width:68pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s115" style="padding-top: 7pt;padding-left: 8pt;text-indent: 0pt;text-align: left;">0.7</p></td><td style="width:76pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s115" style="padding-top: 7pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">0.709</p></td><td style="width:73pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s115" style="padding-top: 7pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">0.775</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"/><p class="s112" style="padding-top: 2pt;padding-bottom: 3pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Model</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="582" height="1" alt="image" src="KerasTensorFlow2019/Image_420.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s112" style="padding-left: 10pt;text-indent: 0pt;text-align: left;">Top-1 accuracy</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:6.52392pt" cellspacing="0"><tr style="height:25pt"><td style="width:83pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" rowspan="3" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s114" style="padding-left: 3pt;text-indent: 0pt;text-align: left;">Latency (ms)</p></td><td style="width:141pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s114" style="padding-top: 7pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Original</p></td><td style="width:49pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 7pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">124</p></td><td style="width:67pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 7pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">89</p></td><td style="width:101pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 7pt;padding-left: 32pt;text-indent: 0pt;text-align: left;">1130</p></td></tr><tr style="height:25pt"><td style="width:141pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s114" style="padding-top: 7pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Post-training quantized</p></td><td style="width:49pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 7pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">112</p></td><td style="width:67pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 7pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">98</p></td><td style="width:101pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 7pt;padding-left: 32pt;text-indent: 0pt;text-align: left;">845</p></td></tr><tr style="height:39pt"><td style="width:141pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s114" style="padding-top: 7pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Quantization-aware training</p></td><td style="width:49pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 7pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">64</p></td><td style="width:67pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 7pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">54</p></td><td style="width:101pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 7pt;padding-left: 32pt;text-indent: 0pt;text-align: left;">543</p></td></tr></table><p class="s112" style="padding-top: 8pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Size (MB) Original <span class="s94">16.9 14 95.7</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:6.52392pt" cellspacing="0"><tr style="height:25pt"><td style="width:83pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:104pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s114" style="padding-top: 7pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Optimized</p></td><td style="width:85pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 7pt;padding-left: 45pt;text-indent: 0pt;text-align: left;">4.3</p></td><td style="width:69pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 7pt;padding-left: 22pt;padding-right: 28pt;text-indent: 0pt;text-align: center;">3.6</p></td><td style="width:100pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 7pt;padding-left: 30pt;text-indent: 0pt;text-align: left;">23.9</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">So, what do these numbers indicate? After quantization using TensorFlow Lite to INT8, we see roughly a four-times reduction in size, approximately two-times speedup in run time, and less than 1% change in accuracy. Not bad!</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">More extreme form of quantization, like 1-bit binarized neural networks (like XNOR-Net), claim a whopping 58-times speedup with roughly 32-</p><p class="s83" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">times smaller size when tested on AlexNet, with a 22% loss in accuracy.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark595">Prune the Model</a><a name="bookmark713">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark714">Pick a number. Multiply it by 0. What do we get? Zero. Multiply your pick again by a small value neighboring 0, like 10–6, and we’ll still get an insignificant value. If we replace such tiny weights (→ 0) in a model with 0 itself, it should have little effect on the model’s predictions. This is called </a><i>magnitude-based weight pruning, </i>or simply pruning, and is a form of <i>model compression</i>. Logically, putting a weight of 0 between two nodes in a fully connected layer is equivalent to deleting the edge between them. This makes a model with dense connections sparser.</p><p class="s83" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">As it happens, a large chunk of the weights in a model are close to 0. Pruning the model will result in many of those weights being set to 0. This happens with little impact to accuracy. Although this does not save any space by itself, it introduces a ton of redundancy that can be exploited when it comes time to save the model to disk in a compressed format such as ZIP. (It is worth noting that compression algorithms thrive on repeating patterns. The more the repetition, the higher the compressibility.) The end result is that our model can often be compressed by four times. Of course, when we finally need to use the model, it would need to be uncompressed before loading in memory for inference.</p><p class="s100" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark715" class="s110">The TensorFlow team observed the accuracy loss shown in </a>Table 6-5 <span style=" color: #000;">while pruning the models. As expected, more efficient models like MobileNet observe higher (though still small) accuracy loss when compared with comparatively bigger models like InceptionV3.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s88" style="padding-left: 192pt;text-indent: -108pt;text-align: left;"><a name="bookmark715">Table 6-5. Model accuracy loss versus pruning percentage</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:52.8071pt" cellspacing="0"><tr style="height:20pt"><td style="width:68pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s114" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Model</p></td><td style="width:53pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s114" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Sparsity</p></td><td style="width:228pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s114" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Accuracy loss against original accuracy</p></td></tr><tr style="height:20pt"><td style="width:68pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">InceptionV3</p></td><td style="width:53pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">50%</p></td><td style="width:228pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">0.1%</p></td></tr><tr style="height:20pt"><td style="width:68pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">InceptionV3</p></td><td style="width:53pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">75%</p></td><td style="width:228pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2.5%</p></td></tr><tr style="height:20pt"><td style="width:68pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">InceptionV3</p></td><td style="width:53pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">87.5%</p></td><td style="width:228pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">4.5%</p></td></tr><tr style="height:20pt"><td style="width:68pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">MobileNet</p></td><td style="width:53pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">50%</p></td><td style="width:228pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s115" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2%</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Keras provides APIs to prune our model. This process can be done iteratively during training. Train a model normally or pick a pretrained model. Then, periodically prune the model and continue training.</p><p class="s83" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Having enough epochs between the periodic prunes allows the model to recover from any damage due to introducing so much sparsity. The amount of sparsity and number of epochs between prunes can be treated as hyperparameters to be tuned.</p><p class="s100" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="https://oreil.ly/JJms2" class="s110" target="_blank">Another way of implementing this is by using </a>Tencent’s PocketFlow <span style=" color: #000;">tool, a one-line command that provides several other pruning strategies implemented in recent research papers.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark596">Use Fused Operations</a><a name="bookmark716">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark717">In any serious CNN, the convolutional layer and batch normalization layer frequently appear together. They are kind of the Laurel and Hardy of CNN layers. Fundamentally, they are both linear operations. Basic linear algebra tells us that combining two or more linear operations will also result in a linear operation. By combining convolutional and batch normalization layers, we not only reduce the number of computations, but also decrease the amount of time spent in data transfer, both between main memory and GPU, and main memory and CPU registers/cache. Making them one operation prevents an extra roundtrip. Luckily, for inference purposes, most inference frameworks either automatically do this fusing step or provide model converters (like TensorFlow Lite) to make this optimization while converting the model to the inference format.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark597">Enable GPU Persistence</a><a name="bookmark718">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark719">Loading and initializing the GPU drivers take time. You might have noticed a delay every time a training or inference job was initiated. For frequent, short jobs, the overhead can become relatively expensive quickly. Imagine an image classification program for which the classification takes 10 seconds, 9.9 of which were spent in loading the driver. What we need is for the GPU driver to stay preinitialized in the background, and be ready for whenever our training jobs start. And that’s where the NVIDIA GPU Persistence Daemon comes to the rescue:</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s91" style="padding-left: 20pt;text-indent: 0pt;text-align: left;">$ nvidia-persistenced --user <i>{YOUR_USERNAME}</i></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark720">Our GPUs will use a bit more wattage during idle time, but they will be ready and available the next time a program is launched.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s84" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark598">Summary</a><a name="bookmark721">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">In this chapter, we explored different avenues for improving the speed and performance of our deep learning pipeline, from storing and reading the data to inference. A slow data pipeline often leads to a GPU starving for data, resulting in idle cycles. With several of the simple optimizations we discussed, our hardware can be put to its maximum efficiency. The handy checklist can serve as a ready reference. Feel free to make a copy for your desk (or your refrigerator). With these learnings, we hope to see your entry among the top performers of the MLPerf benchmark list.</p><h2 style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark722">Chapter 7. Practical Tools, Tips, and Tricks</a><a name="bookmark730">&zwnj;</a></h2><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="581" height="1" alt="image" src="KerasTensorFlow2019/Image_421.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark731">This chapter contains material that we, your authors, have encountered during our professional work as well as while working on this book, primarily during experimentation. The material covered here doesn’t necessarily fit in any single chapter; rather, it’s material that deep learning practitioners could find useful on a day-to-day basis across a variety of tasks. In line with the “practical” theme, these questions cover a range of helpful pragmatic guidelines across topics including setting up an environment, training, model interoperability, data collection and labeling, code quality, managing experiments, team collaboration practices, privacy, and further exploration topics.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s63" target="_blank">Due to the fast-changing pace of the AI field, this chapter is a small subset of the “living” document hosted on the book’s Github repository (see </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">http://PracticalDeepLearning.ai</span>) at <i>code/chapter-9</i><a href="https://www.twitter.com/PracticalDLBook" class="s63" target="_blank">, where it is constantly evolving. If you have more questions or, even better, answers that might help other readers, feel free to tweet them </a><span style=" color: #8E0012;">@PracticalDLBook </span>or submit a pull request.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark723">Installation</a><a name="bookmark732">&zwnj;</a></p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark733">Q: </a><i>I came across an interesting and useful Jupyter Notebook on GitHub. Making the code run will require cloning the repository, installing packages, setting up the environment, and more steps. Is there an instant way to run it interactively?</i></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://mybinder.org/" class="s63" target="_blank">Simply enter the Git repository URL into Binder (</a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">mybinder.org</span>), which will turn it into a collection of interactive notebooks. Under the hood, it will search for a dependency file, like <i>requirements.txt </i>or <i>environment.yml </i>in the repository’s root directory. This will be used to build a Docker image, to help run the notebook interactively in your browser.</p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark734">Q: </a><i>What is the quickest way to get my deep learning setup running on a fresh Ubuntu machine with NVIDIA GPUs?</i></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;">Life would be great if <span class="s47">pip install tensorflow-gpu </span>would solve everything. However, that’s far from reality. On a freshly installed Ubuntu machine, listing all the installation steps would take at least three pages and more than an hour to follow, including installing NVIDIA GPU drivers, CUDA, cuDNN, Python, TensorFlow, and other packages. And then it requires carefully checking the version interoperability between CUDA, cuDNN and TensorFlow. More often than not, this ends in a broken system. A world of pain to say the least!</p><p style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Wouldn’t it be great if two lines could solve all of this effortlessly? Ask, and ye shall receive:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ sudo apt update &amp;&amp; sudo ubuntu-drivers autoinstall &amp;&amp; sudo reboot</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ export LAMBDA_REPO=$(mktemp) \ &amp;&amp; wget -O${LAMBDA_REPO} \</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">https://lambdalabs.com/static/misc/lambda-stack-repo.deb \ &amp;&amp; sudo dpkg -i ${LAMBDA_REPO} &amp;&amp; rm -f ${LAMBDA_REPO} \</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&amp;&amp; sudo apt-get update &amp;&amp; sudo apt-get install -y lambda-stack-cuda \ &amp;&amp; sudo reboot</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;">The first line ensures that all the drivers are updated. The second line is brought to us by the Lambda Labs, a San Francisco–based deep learning hardware and cloud provider. The command sets up</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">the Lambda Stack, which installs TensorFlow, Keras, PyTorch, Caffe, Caffe2, Theano, CUDA, cuDNN, and NVIDIA GPU drivers. Because the company needs to install the same deep learning packages on thousands of machines, it automated the process with a one-line command and then open sourced it so that others can also make use of it.</p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>What is the fastest way to install TensorFlow on a Windows PC?</i></p><ol id="l15"><li><p style="padding-top: 5pt;padding-left: 58pt;text-indent: -16pt;text-align: left;"><a name="bookmark735">Install Anaconda Python 3.7.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 58pt;text-indent: -16pt;text-align: left;">On the command line, run <span class="s47">conda install tensorflow-gpu</span>.</p></li><li><p style="padding-top: 14pt;padding-left: 58pt;text-indent: -16pt;text-align: left;">If you do not have GPUs, run <span class="s47">conda install tensorflow</span>.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">One additional benefit of a CPU-based Conda installation is that it installs Intel MKL optimized TensorFlow, running faster than the version we get by using <span class="s47">pip install tensorflow</span>.</p><p class="s70" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>I have an AMD GPU. Could I benefit from GPU speedups in TensorFlow on my existing system?</i></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark736">Although the majority of the deep learning world uses NVIDIA GPUs, there is a growing community of people running on AMD hardware with the help of the ROCm stack. Installation using the command line is simple:</a></p><ol id="l16"><li><p class="s47" style="padding-top: 5pt;padding-left: 58pt;text-indent: -16pt;line-height: 124%;text-align: left;">sudo apt install rocm-libs miopen-hip cxlactivitylogger</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s47" style="padding-left: 58pt;text-indent: -16pt;text-align: left;">sudo apt install wget python3-pip</p></li><li><p class="s47" style="padding-top: 14pt;padding-left: 58pt;text-indent: -16pt;text-align: left;">pip3 install --user tensorflow-rocm</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s70" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>Forget installation, where can I get preinstalled deep learning containers?</i></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark737">Docker is synonymous with setting up environments. Docker helps run isolated containers that are bundled with tools, libraries, and configuration files. There are several deep learning Docker containers available while selecting your virtual machine (VM) from major cloud providers AWS, Microsoft Azure, GCP, Alibaba, etc.)</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark738">that are ready to start working. NVIDIA also freely provides NVIDIA GPU Cloud containers, which are the same high-performance containers used to break training speed records on the MLPerf benchmarks. You can even run these containers on your desktop machine.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark724">Training</a><a name="bookmark739">&zwnj;</a></p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>I don’t like having to stare at my screen constantly to check whether my training finished. Can I get a notification alert on my phone, instead?</i></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://oreil.ly/uX3qb" class="s63" target="_blank" name="bookmark740">Use </a>Knock Knock<span style=" color: #000;">, a Python library that, as the name suggests, notifies you when your training ends (or your program crashes) by sending alerts on email, Slack, or even Telegram! Best of all, it requires adding only two lines of code to your training script. No more opening your program a thousand times to check whether the training has finished.</span></p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>I prefer graphics and visualizations over plain text. Can I get real-time visualizations for my training process?</i></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark741">FastProgress progress bar (originally developed for fast.ai by Sylvain Gugger) comes to the rescue.</a></p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>I conduct a lot of experiments iteratively and often lose track of what changed between each experiment as well as the effect of the change. How do I manage my experiments in a more organized manner?</i></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark742">Software development has had the ability to keep a historical log of changes through version control. Machine learning, unfortunately, did not have the same luxury. That’s changing now with tools like Weights and Biases, and Comet.ml. They allow you to keep track of multiple runs and to log training curves, hyperparameters, outputs, models, notes, and more with just two lines of code added to your Python script. Best of all, through the power of the cloud, you can conveniently track experiments even if you are away from the machine, and share the results with others.</a></p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>How do I check whether TensorFlow is using the GPU(s) on my machine?</i></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark743">Use the following handy command:</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">tf<span style=" color: #000;">.</span>test<span style=" color: #000;">.</span>is_gpu_available<span style=" color: #000;">()</span></p><p class="s70" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>I have multiple GPUs on my machine. I don’t want my training script to consume all of them. How do I restrict my script to run on only a specific GPU?</i></p><p class="s43" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a name="bookmark744">Use </a><span class="s47">CUDA_VISIBLE_DEVICES=GPU_ID</span><span class="p">. Simply prefix the training script command as follows:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #A00;">$ </span>CUDA_VISIBLE_DEVICES<span style=" color: #000;">=</span>GPU_ID python train<span style=" color: #000;">.</span>py</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Alternatively, write the following lines early on in your training script:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">os</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">os</span>.<span style=" color: #000087;">environ</span>[<span style=" color: #C30;">&quot;CUDA_VISIBLE_DEVICES&quot;</span>]=<span style=" color: #C30;">&quot;GPU_ID&quot;</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s47" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 118%;text-align: left;">GPU_ID <span class="p">can have values such as 0, 1, 2, and so on. You can see these IDs (along with GPU usage) using the </span>nvidia-smi <span class="p">command. For assigning to multiple GPUs, use a comma-separated list of IDs.</span></p><p class="s70" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>Sometimes it feels like there are too many knobs to adjust when training. Can it be done automatically, instead, to get the best accuracy?</i></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark745">There are many options for automated hyperparameter tuning, including Keras-specific Hyperas and Keras Tuner, and more generic frameworks such as Hyperopt and Bayesian optimization that perform extensive experimentation to maximize our objective (i.e., maximizing accuracy in our case) more intelligently than simple grid searches.</a></p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>ResNet and MobileNet work well enough for my use case. Is it possible to build a model architecture that can achieve even higher accuracy for my scenario?</i></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark746">Three words: Neural Architecture Search (NAS). Let the algorithm find the best architecture for you. NAS can be accomplished through packages like Auto-Keras and AdaNet.</a></p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Q: <i>How do I go about debugging my TensorFlow script?</i></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark747">The answer is in the question: TensorFlow Debugger (</a><span class="s47">tfdbg)</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark725">Model</a><a name="bookmark748">&zwnj;</a></p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>I want to quickly know the input and output layers of my model without writing code. How can I accomplish that?</i></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark749">Use Netron. It graphically shows your model, and on clicking any layer, provides details on the architecture.</a></p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>I need to publish a research paper. Which tool should I use to draw my organic, free-range, gluten-free model architecture?</i></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark750">MS Paint, obviously! No, we’re just kidding. We are fans of NN- SVG as well as PlotNeuralNet for creating high-quality CNN diagrams.</a></p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Q: <i>Is there a one-stop shop for all models?</i></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="http://paperswithcode.com/" class="s63" target="_blank" name="bookmark751">Indeed! Explore </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">PapersWithCode.com</span>, <i>ModelZoo.co</i>, and</p><p class="s43" style="padding-top: 1pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">ModelDepot.io <span class="p">for some inspiration.</span></p><p class="s70" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>I’ve finished training my model. How can I make it available for others to use?</i></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark752">You can begin by making the model available for download from GitHub. And then list it on the model zoos mentioned in the previous answer. For even wider adoption, upload it to TensorFlow Hub (</a><i>tfhub.dev</i>).</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In addition to the model, you should publish a “model card,” which is essentially like a résumé of the model. It’s a short report that details author information, accuracy metrics, and the dataset it was benchmarked on. Additionally, it provides guidance on potential biases and out-of-scope uses.</p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>I have a model previously trained in framework X, but I need to use it in framework Y. Do I need to waste time retraining it in framework Y?</i></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark753">Nope. All you need is the power of the ONNX. For models not in the TensorFlow ecosystem, most major deep learning libraries support saving them in ONNX format, which can then be converted to the TensorFlow format. Microsoft’s MMdnn can help in this conversion.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark726">Data</a><a name="bookmark754">&zwnj;</a></p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Q: <i>Could I collect hundreds of images on a topic in a few minutes?</i></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark755">Yes, you can collect hundreds of images in three minutes or less with a Chrome extension called Fatkun Batch Download Image. Simply search for a keyword in your favorite image search engine, filter images by the correct usage rights (e.g., Public Domain), and press the Fatkun extension to download all images. See</a></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Chapter 12<span style=" color: #000;">, where we use it to build a Not Hotdog app.</span></p><p class="s45" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://flickr.com/" class="s63" target="_blank">Bonus tip: to download from a single website, search for a keyword followed by site:website_address. For example, “horse site:</a>flickr.com<span style=" color: #000;">.”</span></p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>Forget the browser. How do I scrape Google for images using the command line?</i></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ pip install google_images_download</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ googleimagesdownload -k=horse -l=5O -r=labeled-for-reuse</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s47" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 114%;text-align: left;"><a name="bookmark756">-k</a><span class="p">, </span>-l<span class="p">, and </span>-r <span class="p">are shorthand for </span>keyword<span class="p">, </span>limit <span class="p">(number of images), and </span>usage_rights<span class="p">, respectively. This is a powerful tool with many options for controlling and filtering what images to download from Google searches. Plus, instead of just loading the thumbnails shown by Google Images, it saves the original images linked by the search engine. For saving more than 100 images, install the </span>selenium <span class="p">library along with </span>chromedriver<span class="p">.</span></p><p class="s70" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;">Q: <i>Those were not enough for collecting images. I need more control. What other tools can help me download data in more custom ways beyond the search engine?</i></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;"><a name="bookmark757">With a GUI (no programming needed):</a></p><p style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="http://scrapestorm.com/" class="s46">ScrapeStorm.com</a></p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark758">Easy GUI to identify rules for elements to extract</a></p><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="http://webscraper.io/" class="s46">WebScraper.io</a></p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark759">Chrome-based scraping extension, especially for extracting structured output from single websites</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="http://80legs.com/" class="s46">80legs.com</a></p><p style="padding-top: 4pt;padding-left: 6pt;text-indent: 29pt;line-height: 142%;text-align: left;"><a name="bookmark760">Cloud-based scalable scraper, for parallel, large tasks Python-based programmatic tools:</a></p><p style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="http://scrapy.org/" class="s46">Scrapy.org</a></p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark761">For more programmable controls on scraping, this is one of the most famous scrapers. Compared to building your own naive scraper to explore websites, it offers throttling rate by domain, proxy, and IP; can handle </a><i>robots.txt</i>; offers flexibility in browser headers to show to web servers; and takes care of several possible edge cases.</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">InstaLooter</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark762">A Python-based tool for scraping Instagram.</a></p><p class="s70" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>I have the images for the target classes, but now need images for the negative (not item/background) class. Any quick ways to build a big dataset of negative classes?</i></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark763">ImageN </a><span style=" color: #000;">offers 1,000 images — 5 random images for 200 ImageNet categories — which you can use as the negative class. If you need more, download a random sample programmatically from ImageNet.</span></p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Q: <i>How can I search for a prebuilt dataset that suits my needs?</i></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark764">Try Google Dataset Search, </a><i>VisualData.io</i><a href="http://datasetlist.com/" class="s63" target="_blank">, and </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">DatasetList.com</span>.</p><p class="s70" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>For datasets like ImageNet, downloading, figuring out the format, and then loading them for training takes far too much time. Is there an easy way to read popular datasets?</i></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 113%;text-align: left;"><a name="bookmark765">TensorFlow Datasets is a growing collection of datasets ready to use with TensorFlow. It includes ImageNet, COCO (37 GB), and Open Images (565 GB) among others. These datasets are exposed as </a><span class="s47">tf.data.Datasets</span>, along with performant code to feed them in your training pipeline.</p><p class="s70" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>Training on the millions of ImageNet images will take a long, long time. Is there a smaller representative dataset I could try training on, to quickly experiment and iterate with?</i></p><p class="s45" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://oreil.ly/NpYBe" class="s63" target="_blank" name="bookmark766">Try </a>Imagenette<span style=" color: #000;">. Built by Jeremy Howard from fast.ai, this 1.4 GB dataset contains only 10 classes instead of 1,000.</span></p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>What are the largest readily available datasets that I could use for training?</i></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_422.png"/></span></p><p style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark767">Tencent ML Images: 17.7 million images with 11,000 category labels</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_423.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark768">Open Images V4 (from Google): 9 million images in 19.7 K categories</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_424.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark769">BDD100K (from UC Berkeley): Images from 100,000 driving videos, over 1,100 hours</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_425.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark770">YFCC100M (from Yahoo): 99.2 million images</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s70" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>What are some of the readily available large video datasets I could use?</i></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="581" height="1" alt="image" src="KerasTensorFlow2019/Image_426.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-bottom: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Name Details</p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="581" height="1" alt="image" src="KerasTensorFlow2019/Image_427.png"/></span></p><p class="s49" style="padding-top: 8pt;padding-left: 136pt;text-indent: -125pt;line-height: 108%;text-align: left;"><a name="bookmark771">YouTube-8M 6.1 million videos, 3,862 classes, 2.6 billion audio-visual features</a></p><p class="s49" style="padding-top: 5pt;padding-left: 136pt;text-indent: 0pt;text-align: left;">3.0 labels/video</p><p class="s49" style="padding-top: 6pt;padding-left: 136pt;text-indent: 0pt;text-align: left;">1.53 terabytes of randomly sampled videos</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="133" alt="image" src="KerasTensorFlow2019/Image_428.png"/></span></p><p class="s49" style="padding-top: 4pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">Something Something</p><p class="s49" style="padding-top: 5pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">(from Twenty Billion Neurons)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s49" style="padding-left: 10pt;text-indent: 0pt;text-align: left;">Jester</p><p class="s49" style="padding-top: 7pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">(from Twenty Billion Neurons)</p><p class="s49" style="padding-top: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">221,000 videos in 174 action classes</p><p class="s49" style="padding-top: 6pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">For example, “Pouring water into wine glass but missing so it spills next to it”</p><p class="s49" style="padding-top: 5pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">Humans performing predefined actions with everyday objects</p><p class="s49" style="padding-top: 12pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">148,000 videos in 27 classes</p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="1" alt="image" src="KerasTensorFlow2019/Image_429.png"/></span></p><p class="s49" style="padding-top: 6pt;padding-left: 10pt;text-indent: 0pt;line-height: 151%;text-align: left;">For example, “Zooming in with two fingers” Predefined hand gestures in front of a webcam</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s70" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>Are those the largest labeled datasets ever assembled in the history of time?</i></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark772">Nope! Companies like Facebook and Google curate their own private datasets that are much larger than the public ones we can</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;">play with:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_430.png"/></span></p><p style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Facebook: 3.5 billion Instagram images with noisy labels (first reported in 2018)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_431.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Google – JFT-300M: 300 million images with noisy labels (first reported in 2017)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;">Sadly, unless you’re an employee at one of these companies, you can’t really access these datasets. Nice recruiting tactic, we must say.</p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;">Q: <i>How can I get help annotating data?</i></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark773">There are several companies out there that can assist with labeling different kinds of annotations. A few worth mentioning include SamaSource, Digital Data Divide, and iMerit, which employ people who otherwise have limited opportunities, eventually creating positive socioeconomic change through employment in underprivileged communities.</a></p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Q: <i>Is there a versioning tool for datasets, like Git is for code?</i></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark774">Qri and Quilt can help version control our datasets, aiding in reproducibility of experiments.</a></p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>What if I don’t have access to a large dataset for my unique problem?</i></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark775">Try to develop a synthetic dataset for training! For example, find a realistic 3D model of the object of interest and place it in realistic environments using a 3D framework such as Unity. Adjust the lighting and camera position, zoom, and rotation to take snapshots of this object from many angles, generating an endless supply of training data. Alternatively, companies like AI.Reverie, CVEDIA, Neuromation, Cognata, Mostly.ai, and DataGen Tech provide realistic simulations for training needs. One big benefit of synthesized training data is that the labeling process is built into the synthesization process. After all, you would know what you are creating. This automatic labeling can save a lot of money and effort, compared to manual labeling.</a><a name="bookmark776">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark727">Privacy</a><a name="bookmark777">&zwnj;</a></p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>How do I develop a more privacy-preserving model without going down the cryptography rabbit hole?</i></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark778">TensorFlow Encrypted might be the solution you’re looking for. It enables development using encrypted data, which is relevant, especially if you are on the cloud. Internally, lots of secure multiparty computation and homomorphic encryptions result in privacy-preserving machine learning.</a></p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Q: <i>Can I keep my model under wraps from prying eyes?</i></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Well, unless you are on the cloud, weights are visible and can be reverse engineered. Use the Fritz library for protecting your model’s IP when deployed on smartphones.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark728">Education and Exploration</a><a name="bookmark779">&zwnj;</a></p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>I want to become an AI expert. Beyond this book, where should I invest my time to learn more?</i></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark780">There are several resources on the internet to learn deep learning in depth. We highly recommend these video lectures from some of the best teachers, covering a variety of application areas from computer vision to natural language processing.</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_432.png"/></span></p><p style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark781">Fast.ai (by Jeremy Howard and Rachel Thomas) features a free 14-video lecture series, taking a more learn-by-doing approach in PyTorch. Along with the course comes an ecosystem of tools and an active community that has led to many breakthroughs in the form of research papers and ready-to-use code (like three lines of code to train a state-of- the-art network using the fast.ai library).</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_433.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark782">Deeplearning.ai (by Andrew Ng) features a five-course “Deep Learning Specialization.” It’s free of cost (although you could pay a small fee to get a certificate) and will solidify your theoretical foundation further. Dr. Ng’s first Coursera course on machine learning has taught more than two million students, and this series continues the tradition of highly approachable content loved by beginners and experts alike.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_434.png"/></span></p><p class="s45" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a href="http://oreilly.com/" class="s63" target="_blank" name="bookmark783">We would be remiss if we didn’t encourage you to note </a>O’Reilly’s Online Learning <span style=" color: #000;">platform in this list. Helping more than two million users advance their careers, it contains hundreds of books, videos, live online trainings, and keynotes given by leading thinkers and practitioners at O’Reilly’s AI and data conferences.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s70" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Q: <i>Where can I find interesting notebooks to learn from?</i></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark784">Google Seedbank is a collection of interactive machine learning examples. Built on top of Google Colaboratory, these Jupyter notebooks can be run instantly without any installations. Some interesting examples include:</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_435.png"/></span></p><p style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Generating audio with GANs</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_436.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_437.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_438.png"/></span></p><p style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 191%;text-align: left;">Action recognition on video Generating Shakespeare-esque text Audio-style transfer</p><p class="s70" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Q: <i>Where can I learn about the state of the art for a specific topic?</i></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;"><a name="bookmark785">Considering how fast the state of the art moves in AI, SOTAWHAT is a handy command-line tool to search research papers for the latest models, datasets, tasks, and more. For example, to look up the latest results on ImageNet, use </a><span class="s47">sotawhat imagenet </span><a href="http://paperswithcode.com/sota" class="s63" target="_blank">on the command line. Additionally, </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">paperswithcode.com/sota </span>also features repositories for papers, their source code, and released models, along with an interactive visual timeline of benchmarks.</p><p class="s70" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>I am reading a paper on Arxiv and I really like it. Do I need to write code from scratch?</i></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://arxiv.org/" class="s63" target="_blank" name="bookmark786">Not at all! The ResearchCode Chrome extension makes it easy to find code when browsing </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">arxiv.org </span><a href="http://researchcode.com/" class="s63" target="_blank">or Google Scholar. All it takes is a press of the extension button. You can also look up code without installing the extension on the </a><a href="http://researchcode.com/" class="s46" target="_blank">ResearchCode.com</a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;"> </span>website.</p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Q: <i>I don’t want to write any code, but I still want to interactively experiment with a model using my camera. How can I do that?</i></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://runwayml.com/" class="s44" target="_blank" name="bookmark787">Runway ML</a> <span style=" color: #000;">is an easy-to-use yet powerful GUI tool that allows you to download models (from the internet or your own) and use the webcam or other input, such as video files, to see the output interactively. This allows further combining and remixing outputs of models to make new creations. And all of this happens with just a few mouse clicks; hence, it’s attracting a large artist community!</span></p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Q: <i>8-1If I can test without code, can I train without code, too?</i></p><p class="s45" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark828" class="s63" name="bookmark788">We discuss this in detail in </a>Chapter 8 <a href="#bookmark1295" class="s63">(web-based) and </a>Chapter 12 <a href="http://customvision.ai/" class="s63" target="_blank">(desktop-based). To keep it short, tools such as Microsoft’s </a>CustomVision.ai<span style=" color: #000;">, Google’s Cloud AutoML Vision, Clarifai, Baidu EZDL, and Apple’s Create ML provide drag-and-drop training capabilities. Some of these tools take as little as a few seconds to do the training.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark729">One Last Question</a><a name="bookmark789">&zwnj;</a></p><p class="s70" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Q: <i>Tell me a great deep learning prank?</i></p><p class="s45" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark791" class="s63" name="bookmark790">Print and hang poster shown in </a>Figure 7-1 <a href="http://keras4kindergartners.com/" class="s63" target="_blank">from </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">keras4kindergartners.com </span><span style=" color: #000;">near the watercooler, and watch people’s reactions.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="599" height="775" alt="image" src="KerasTensorFlow2019/Image_439.jpg"/></span></p><p style="padding-top: 5pt;padding-left: 19pt;text-indent: 0pt;text-align: left;"><a href="http://keras4kindergartners.com/" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12pt;" target="_blank" name="bookmark791">Figure 7-1. Satirical poster on the state of AI from </a><a href="http://keras4kindergartners.com/" class="s52" target="_blank">keras4kindergartners.com</a></p><p class="s16" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark792">Chapter 8. Cloud APIs for Computer Vision: Up and Running in 15 Minutes</a><a name="bookmark828">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_440.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark829">Due to repeated incidents of near meltdown at the nearby nuclear power plant, the library of the city of Springfield (we are not allowed to mention the state) decided that it was too risky to store all their valuable archives in physical form. After hearing that the library from their rival city of Shelbyville started digitizing their records, they wanted to get in on the game as well. After all, their collection of articles such as “Old man yells at cloud” and “Local man thinks wrestling is real” and the hundred-year-old iconic photographs of the Gorge and the statue of the city’s founder Jebediah Springfield are irreplaceable. In addition to making their archives resilient to catastrophes, they would make their archives easily searchable and retrievable. And, of course, the residents of Springfield now would be able to access all of this material from the comfort of their living room couches.</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The first step in digitizing documents is, of course, scanning. That’s the easy part. Then starts the real challenge — processing and understanding all of this visual imagery. The team in Springfield had a few different options in front of them.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_441.png"/></span></p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">Perform manual data entry for every single page and every single photograph. Given that the city has more than 200 years of rich history, it would take a really long time, and would be error prone and expensive. It would be quite an ordeal to transcribe all of that material.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_442.png"/></span></p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">Hire a team of data scientists to build an image understanding system. That would be a much better approach, but there’s just one tiny hitch in the plan. For a library that runs on charitable donations, hiring a team of data scientists would quickly exhaust its budget. A single data scientist might not only be the highest-paid employee at the library, they might also be the highest-earning worker in the entire city of Springfield (barring the wealthy industrialist Montgomery Burns).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_443.png"/></span></p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">Get someone who knows enough coding to use the intelligence of ready-to-use vision APIs.</p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Logically they went with the quick and inexpensive third option. They had a stroke of luck, too. Martin Prince, an industrious fourth grader from Springfield Elementary who happened to know some coding, volunteered to build out the system for them. Although Martin did not know much deep learning (he’s just 10 years old, after all), he did know how to do some general coding, including making REST API calls using Python. And that was all he really needed to know. In fact, it took him just under 15 minutes to figure out how to make his first API call.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Martin’s <i>modus operandi </i>was simple: send a scanned image to the cloud API, get a prediction back, and store it in a database for future retrieval. And obviously, repeat this process for every single record the library owned. He just needed to select the correct tool for the job.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">All the big names — Amazon, Google, IBM, Microsoft — provide a similar set of computer-vision APIs that label images, detect and recognize faces and celebrities, identify similar images, read text, and sometimes even discern handwriting. Some of them even provide the ability to train our own classifier without having to write a single line of code. Sounds really convenient!</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In the background, these companies are constantly working to improve the state of the art in computer vision. They have spent millions in acquiring and labeling datasets with a granular taxonomy much beyond the ImageNet dataset. We might as well make good use of their researchers’ blood, sweat, and tears (and electricity bills).</p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark458" class="s30">The ease of use, speed of onboarding and development, the variety of functionality, richness of tags, and competitive pricing make cloud-based APIs difficult to ignore. And all of this without the need to hire an expensive data science team. Chapters </a>Chapter 5 <a href="#bookmark599" class="s30">and </a>Chapter 6 <span style=" color: #000;">optimized for accuracy and performance, respectively; this chapter essentially optimizes for human resources.</span></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In this chapter, we explore several cloud-based visual recognition APIs. We compare them all both quantitatively as well as qualitatively. This should hopefully make it easier to choose the one that best suits your target application. And if they still don’t match your needs, we’ll investigate how to train a custom classifier with just a few clicks.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark830">(In the interest of full disclosure, some of the authors of this book were previously employed at Microsoft, whose offerings are discussed here. We have attempted not to let that bias our results by building reproducible experiments and justifying our methodology.)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark793">The Landscape of Visual Recognition APIs</a><a name="bookmark831">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark832">Let’s explore some of the different visual recognition APIs out there.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark794">Clarifai</a><a name="bookmark833">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="536" height="148" alt="image" src="KerasTensorFlow2019/Image_444.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Fun fact: While investigating a classifier to detect NSFW (Not Safe For Work) images, it became important to understand and debug what was being learned by the CNN in order to reduce false positives. This led Clarifai to invent a visualization technique to expose which images stimulate feature maps at any layer in the CNN. As they say, necessity is the mother of invention.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark835" class="s30" name="bookmark834">Clarifai (</a>Figure 8-1<span style=" color: #000;">) was the winner of the 2013 ILSVRC classification task. Started by Matthew Zeiler, a graduate student from New York University, this was one of the first visual recognition API companies out there.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s40" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark795">What’s unique about this API?</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">It offers multilingual tagging in more than 23 languages, visual similarity search among previously uploaded photographs, face-based multicultural appearance classifier, photograph aesthetic scorer, focus scorer, and embedding vector generation to help us build our own reverse-image search. It also offers recognition in specialized domains including clothing and fashion, travel and hospitality, and weddings. Through its public API, the image tagger supports 11,000 concepts.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="531" height="253" alt="image" src="KerasTensorFlow2019/Image_445.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark835">Figure 8-1. Sample of Clarifai’s results</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark796">Microsoft Cognitive Services</a><a name="bookmark836">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://how-old.net/" class="s30" target="_blank" name="bookmark837">With the creation of ResNet-152 in 2015, Microsoft was able to win seven tasks at the ILSVRC, the COCO Image Captioning Challenge as well as the Emotion Recognition in the Wild challenge, ranging from classification and detection (localization) to image descriptions. And most of this research was translated to cloud APIs. Originally starting out as Project Oxford from Microsoft Research in 2015, it was eventually renamed Cognitive Services in 2016. It’s a comprehensive set of more than 50 APIs ranging from vision, natural language processing, speech, search, knowledge graph linkage, and more. Historically, many of the same libraries were being run at divisions at Xbox and Bing, but they are now being exposed to developers externally. Some viral applications showcasing creative ways developers use these APIs include </a><span class="s116">how-old.net </span>(How Old Do I Look?), Mimicker Alarm (which requires making a particular facial expression in order to defuse the morning alarm), and <i>CaptionBot.ai</i>.</p><p class="s40" style="padding-top: 13pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark797">What’s unique about this API?</a></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark838" class="s30">As illustrated in </a>Figure 8-2<span style=" color: #000;">, the API offers image captioning, handwriting understanding, and headwear recognition. Due to many enterprise customers, Cognitive Services does not use customer image data for improving its services.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="534" height="198" alt="image" src="KerasTensorFlow2019/Image_446.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark838">Figure 8-2. Sample of Microsoft Cognitive Services results</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark798">Google Cloud Vision</a><a name="bookmark839">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark840">Google provided the winning entry at the 2014 ILSVRC with the help of the 22-layer GoogLeNet, which eventually paved the way for the now-staple Inception architectures. Supplementing the Inception models, in December 2015, Google released a suite of Vision APIs. In the world of deep learning, having large amounts of data is definitely an advantage to improve one’s classifier, and Google has a lot of consumer data. For example, with learnings from Google Street View, you should expect relatively good performance in real-world text extraction tasks, like on billboards.</a></p><p class="s40" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark799">What’s unique about this API?</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark841" class="s30">For human faces, it provides the most detailed facial key points (</a><a href="#bookmark841" class="s18">Figure 8-</a></p><ol id="l17"><li><p class="s17" style="padding-top: 1pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">including roll, tilt, and pan to accurately localize the facial features. The APIs also return similar images on the web to the given input. A simple way to try out the performance of Google’s system without writing code is by uploading photographs to Google Photos and searching through the tags.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="531" height="236" alt="image" src="KerasTensorFlow2019/Image_447.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark841">Figure 8-3. Sample of Google Cloud Vision’s results</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark800">Amazon Rekognition</a><a name="bookmark842">&zwnj;</a></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark844" class="s30" name="bookmark843">No, that title is not a typo. Amazon Rekognition API (</a>Figure 8-4<span style=" color: #000;">) is largely based on Orbeus, a Sunnyvale, California-based startup that was acquired by Amazon in late 2015. Founded in 2012, its chief scientist also had winning entries in the ILSVRC 2014 detection challenge. The same APIs were used to power PhotoTime, a famous photo organization app. The API’s services are available as part of the AWS offerings. Considering most companies already offer photo analysis APIs, Amazon is doubling down on video recognition offerings to offer differentiation.</span></p><p class="s40" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark801">What’s unique about this API?</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">License plate recognition, video recognition APIs, and better end-to-end integration examples of Rekognition APIs with AWS offerings like Kinesis Video Streams, Lambda, and others. Also, Amazon’s API is the only one that can determine whether the subject’s eyes are open or closed.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="534" height="211" alt="image" src="KerasTensorFlow2019/Image_448.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark844">Figure 8-4. Sample of Amazon Rekognition’s results</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark802">IBM Watson Visual Recognition</a><a name="bookmark845">&zwnj;</a></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark847" class="s30" name="bookmark846">Under the Watson brand, IBM’s Visual Recognition offering started in early 2015. After purchasing AlchemyAPI, a Denver-based startup, AlchemyVision has been used for powering the Visual Recognition APIs (</a>Figure 8-5<span style=" color: #000;">). Like others, IBM also offers custom classifier training.</span></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Surprisingly, Watson does not offer optical character recognition yet.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 30pt;text-indent: 0pt;text-align: left;"><span><img width="529" height="655" alt="image" src="KerasTensorFlow2019/Image_449.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark847">Figure 8-5. Sample of IBM Watson’s Visual Recognition results</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark803">Algorithmia</a><a name="bookmark848">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark849">Algorithmia is a marketplace for hosting algorithms as APIs on the cloud. Founded in 2013, this Seattle-based startup has both its own in-house algorithms as well as those created by others (in which case creators earn revenue based on the number of calls). In our experience, this API did tend to have the slowest response time.</a></p><p class="s40" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark804">What’s unique about this API?</a></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark850" class="s30">Colorization service for black and white photos (</a>Figure 8-6<span style=" color: #000;">), image stylization, image similarity, and the ability to run these services on- premises, or on any cloud provider.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="535" height="355" alt="image" src="KerasTensorFlow2019/Image_450.jpg"/></span></p><p class="s19" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark850">Figure 8-6. Sample of Algorithmia’s style transfer results</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">With so many offerings, it can be overwhelming to choose a service. There are many reasons why we might choose one over another. Obviously, the biggest factors for most developers would be accuracy and price. Accuracy is the big promise that the deep learning revolution brings, and many applications require it on a consistent basis. Price of the service might be an additional factor to consider. We might also choose a service provider because our company already has a billing account with it, and it would take additional effort to integrate a different service provider. Speed of the API response might be another factor, especially if the user is waiting on</p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark851">the other end for a response. Because many of these API calls can be abstracted, it’s easy to switch between different providers.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark805">Comparing Visual Recognition APIs</a><a name="bookmark852">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark853">To aid our decision making, let’s compare these APIs head to head. In this section, we examine service offerings, cost, and accuracy of each.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark806">Service Offerings</a><a name="bookmark854">&zwnj;</a></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark856" class="s18" name="bookmark855">Table 8-1</a> <span style=" color: #000;">lists what services are being offered by each cloud provider.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s22" style="padding-left: 10pt;text-indent: 0pt;text-align: left;"><a name="bookmark856">Table 8-1. Comparison shopping of vision API providers (as of Aug. 2019)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_451.png"/></span></p><p class="s33" style="padding-top: 1pt;padding-left: 79pt;text-indent: 0pt;text-align: left;">Algorithmia Amazon</p><p class="s33" style="padding-left: 148pt;text-indent: 0pt;text-align: left;">Rekognition</p><p class="s33" style="padding-top: 1pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Clarifai Microsoft</p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="1" alt="image" src="KerasTensorFlow2019/Image_452.png"/></span></p><p class="s33" style="padding-left: 55pt;text-indent: 0pt;text-align: left;">Cognitive Services</p><p class="s33" style="padding-top: 1pt;padding-left: 8pt;text-indent: 0pt;text-align: left;">Google Cloud Vision</p><p class="s33" style="padding-top: 1pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">IBM Watson Visual Recognition</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="52" alt="image" src="KerasTensorFlow2019/Image_453.png"/></span></p><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="text-indent: 0pt;text-align: left;">Image detection</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-left: 9pt;text-indent: 0pt;text-align: left;">Image classification</p><p class="s117" style="padding-top: 9pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">✔ ✔ ✔ ✔ ✔ ✔</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="52" alt="image" src="KerasTensorFlow2019/Image_454.png"/></span></p><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="text-indent: 0pt;text-align: left;">Face recognition</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-top: 6pt;padding-bottom: 3pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">OCR <span class="s117">✔ ✔ ✔ ✔</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="52" alt="image" src="KerasTensorFlow2019/Image_455.png"/></span></p><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="text-indent: 0pt;text-align: left;">Logo recognition</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;line-height: 147%;text-align: left;">Emotion recognition</p><p class="s117" style="padding-top: 2pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">✔ ✔ ✔ ✔</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="59" alt="image" src="KerasTensorFlow2019/Image_456.png"/></span></p><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="text-indent: 0pt;line-height: 12pt;text-align: left;">Celebrity</p><p class="s26" style="padding-top: 5pt;text-indent: 0pt;text-align: left;">recognition</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-top: 6pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Landmark recognition</p><p class="s117" style="padding-top: 5pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">✔ ✔ ✔ ✔</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s26" style="padding-top: 6pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Multilingual <span class="s117">✔</span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="52" alt="image" src="KerasTensorFlow2019/Image_457.png"/></span></p><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="text-indent: 0pt;text-align: left;">Image description</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-bottom: 3pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">tagging</p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="52" alt="image" src="KerasTensorFlow2019/Image_458.png"/></span></p><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="text-indent: 0pt;text-align: left;">Thumbnail <span class="s117">✔</span></p><p class="s26" style="text-indent: 0pt;text-align: left;">generation</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-top: 6pt;padding-bottom: 3pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Handwriting <span class="s117">✔ ✔</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="69" alt="image" src="KerasTensorFlow2019/Image_459.png"/></span></p><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s117" style="text-indent: 0pt;text-align: left;">✔</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="text-indent: 0pt;text-align: left;">Custom classification training</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Content moderation</p><p class="s117" style="padding-top: 2pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">✔ ✔ ✔ ✔ ✔</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s26" style="padding-top: 2pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Custom <span class="s118">✔ ✔</span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="496" height="1" alt="image" src="KerasTensorFlow2019/Image_460.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="1" alt="image" src="KerasTensorFlow2019/Image_461.png"/></span></p><p class="s26" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">detector training</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="93" height="1" alt="image" src="KerasTensorFlow2019/Image_462.png"/></span></p><p class="s33" style="padding-top: 7pt;padding-left: 1pt;text-indent: 0pt;text-align: left;">Algorithmia Amazon</p><p class="s33" style="padding-left: 69pt;text-indent: 0pt;text-align: left;">Rekognition</p><p class="s33" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Clarifai Microsoft</p><p class="s33" style="padding-left: 55pt;text-indent: 0pt;text-align: left;">Cognitive Services</p><p class="s33" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Google Cloud Vision</p><p class="s33" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">IBM Watson Visual Recognition</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_463.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:6.65632pt" cellspacing="0"><tr style="height:51pt"><td style="width:59pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s34" style="padding-top: 7pt;padding-left: 3pt;padding-right: 19pt;text-indent: 0pt;text-align: justify;">Mobile custom models</p></td><td style="width:149pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:51pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s119" style="padding-top: 6pt;padding-left: 4pt;text-indent: 0pt;text-align: left;">✔</p></td><td style="width:59pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s119" style="padding-top: 6pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">✔</p></td><td style="width:52pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s119" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">✔</p></td><td style="width:72pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:16pt"><td style="width:59pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Free tier</p></td><td style="width:149pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 14pt;text-indent: 0pt;line-height: 12pt;text-align: left;">5,000 5,000</p></td><td style="width:51pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 4pt;text-indent: 0pt;line-height: 12pt;text-align: left;">5,000</p></td><td style="width:59pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">5,000</p></td><td style="width:52pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 5pt;text-indent: 0pt;line-height: 12pt;text-align: left;">1,000</p></td><td style="width:72pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s34" style="padding-top: 2pt;padding-left: 4pt;text-indent: 0pt;line-height: 12pt;text-align: left;">7,500</p></td></tr><tr style="height:14pt"><td style="width:59pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:149pt"><p class="s34" style="padding-left: 14pt;text-indent: 0pt;line-height: 12pt;text-align: left;">requests per requests per</p></td><td style="width:51pt"><p class="s34" style="padding-left: 4pt;text-indent: 0pt;line-height: 12pt;text-align: left;">requests</p></td><td style="width:59pt"><p class="s34" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">requests</p></td><td style="width:52pt"><p class="s34" style="padding-left: 5pt;text-indent: 0pt;line-height: 12pt;text-align: left;">requests</p></td><td style="width:72pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:14pt"><td style="width:59pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:149pt"><p class="s34" style="padding-left: 14pt;text-indent: 0pt;line-height: 12pt;text-align: left;">month month</p></td><td style="width:51pt"><p class="s34" style="padding-left: 4pt;text-indent: 0pt;line-height: 12pt;text-align: left;">per</p></td><td style="width:59pt"><p class="s34" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">per month</p></td><td style="width:52pt"><p class="s34" style="padding-left: 5pt;text-indent: 0pt;line-height: 12pt;text-align: left;">per</p></td><td style="width:72pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:17pt"><td style="width:59pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:149pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:51pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-left: 4pt;text-indent: 0pt;text-align: left;">month</p></td><td style="width:59pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:52pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s34" style="padding-left: 5pt;text-indent: 0pt;text-align: left;">month</p></td><td style="width:72pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">That’s a mouthful of services already up and running, ready to be used in our application. Because numbers and hard data help make decisions easier, it’s time to analyze these services on two factors: cost and accuracy.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark807">Cost</a><a name="bookmark857">&zwnj;</a></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark859" class="s30" name="bookmark858">Money doesn’t grow on trees (yet), so it’s important to analyze the economics of using off-the-shelf APIs. Taking a heavy-duty example of querying these APIs at about 1 query per second (QPS) service for one full month (roughly 2.6 million requests per month), </a>Figure 8-7 <span style=" color: #000;">presents a comparison of the different providers sorted by estimated costs (as of August 2019).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 39pt;text-indent: 0pt;text-align: left;"><span><img width="515" height="302" alt="image" src="KerasTensorFlow2019/Image_464.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark859">Figure 8-7. A cost comparison of different cloud-based vision APIs</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Although for most developers, this is an extreme scenario, this would be a pretty realistic load for large corporations. We will eventually compare these prices against running our own service in the cloud to make sure we get the most bang for the buck fitting our scenario.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">That said, many developers might find negligible charges, considering that all of the cloud providers we look at here have a free tier of 5,000 calls per month (except Google Vision, which gives only 1,000 calls per month for free), and then roughly $1 per 1,000 calls.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark808">Accuracy</a><a name="bookmark860">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark861">In a world ruled by marketing departments who claim their organizations to be the market leaders, how do we judge who is actually the best? What we need are common metrics to compare these service providers on some external datasets.</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">To showcase building a reproducible benchmark, we assess the text extraction quality using the COCO-Text dataset, which is a subset of the MS COCO dataset. This 63,686-image set contains text in daily life settings, like on a banner, street sign, number on a bus, price tag in a grocery store, designer shirt, and more. This real-world imagery makes it a relatively tough set to test against. We use the Word Error Rate (WER) as our benchmarking metric. To keep things simple, we ignore the position of the word and focus only on whether a word is present (i.e., bag of words). To be a match, the entire word must be correct.</p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark862" class="s30">In the COCO-Text validation dataset, we pick all images with one or more instances of legible text (full-text sequences without interruptions) and compare text instances of more than one-character length. We then send these images to various cloud vision APIs. </a>Figure 8-8 <span style=" color: #000;">presents the results.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 38pt;text-indent: 0pt;text-align: left;"><span><img width="513" height="299" alt="image" src="KerasTensorFlow2019/Image_465.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark862">Figure 8-8. WER for different text extraction APIs as of August 2019</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Considering how difficult the dataset is, these results are remarkable. Most state-of-the-art text extraction tools from earlier in the decade would not cross the 10% mark. This shows the power of deep learning. On a subset</p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">of manually tested images, we also noticed a year-on-year improvement in the performance of some of these APIs, which is another benefit enjoyed by cloud-based APIs.</p><p class="s116" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s30" target="_blank">As always, all of the code that we used for our experiment is hosted on GitHub (see </a>http://PracticalDeepLearning.ai<span class="s17">.</span></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The results of our analysis depend significantly on the dataset we choose as well as our metrics. Depending on our dataset (which is in turn influenced by our use case) as well as our minimum quality metrics, our results can vary. Additionally, service providers are constantly improving their services in the background. As a consequence, these results are not set in stone and improve over time. These results can be replicated on any dataset with the scripts on GitHub.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark809">Bias</a><a name="bookmark863">&zwnj;</a></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark58" class="s30" name="bookmark864">In </a>Chapter 1<span style=" color: #000;">, we explored how bias can creep into datasets and how it can have real-life consequences for people. The APIs we explore in this chapter are no exception. Joy Buolamwini, a researcher at the MIT Media Lab, discovered that among Microsoft, IBM, and Megvii (also known as Face++), none were able to detect her face and gender accurately.</span></p><p class="s39" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark865" class="s30">Wondering if she had unique facial features that made her undetectable to these APIs, she (working along with Timnit Gebru) compiled faces of members of legislative branches from six countries with a high representation of women, building the Pilot Parliaments Benchmark (PPB; see </a>Figure 8-9<span style=" color: #000;">). She chose members from three African countries and three European countries to test for how the APIs performed on different skin tones. If you haven’t been living under a rock, you can already see where this is going.</span></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">She observed that the APIs performed fairly well overall at accuracies between 85% and 95%. It was only when she started slicing the data across the different categories that she observed there was a massive amount of difference in the accuracies for each. She first observed that there was a significant difference between detection accuracies of men and women. She also observed that breaking down by skin tone, the difference in the detection accuracy was even larger. Then, finally, taking both gender and skin tone into consideration, the differences grew painfully starker between the worse detected group (darker females) and the best detected group (lighter males). For example, in the case of IBM, the detection accuracy of African women was a mere 65.3%, whereas the same API gave a 99.7% accuracy for European men. A whopping 34.4% difference! Considering many of these APIs are used by law enforcement, the consequences of bias seeping in might have life or death consequences.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="531" height="175" alt="image" src="KerasTensorFlow2019/Image_466.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 183pt;text-indent: -173pt;text-align: left;"><a name="bookmark865">Figure 8-9. Averaged faces among different gender and skin tone, from Pilot Parliaments Benchmark (PPB)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Following are a few insights we learned from this study:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_467.png"/></span></p><p class="s17" style="padding-top: 6pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">The algorithm is only as good as the data on which it’s trained. And this shows the need for diversity in the training dataset.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_468.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">Often the aggregate numbers don’t always reveal the true picture. The bias in the dataset is apparent only when slicing it across different subgroups.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_469.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">The bias does not belong to any specific company; rather, it’s an industry-wide phenomenon.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_470.png"/></span></p><p class="s39" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;"><a href="#bookmark866" class="s30">These numbers are not set in stone and reflect only the time at which the experiment was performed. As evident from the drastic change in numbers between 2017 (</a>Figure 8-10<a href="#bookmark867" class="s30">) and a subsequent study in 2018 (</a><a href="#bookmark867" class="s18">Figure </a>8-11<span style=" color: #000;">), these companies are taking bias removal from their datasets quite seriously.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_471.png"/></span></p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">Researchers putting commercial companies to the test with public benchmarks results in industry-wide improvements (even if for the fear of bad PR, then so be it).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="534" height="135" alt="image" src="KerasTensorFlow2019/Image_472.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 216pt;text-indent: -208pt;text-align: left;"><a name="bookmark866">Figure 8-10. Face detection comparison across APIs, tested in April and May 2017 on the PPB</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="533" height="211" alt="image" src="KerasTensorFlow2019/Image_473.jpg"/></span></p><p class="s19" style="padding-top: 5pt;padding-left: 125pt;text-indent: -96pt;text-align: left;"><a name="bookmark867">Figure 8-11. Face detection comparison across APIs in August 2018 on the PPB, conducted by Inioluwa Deborah Raji et al.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark868" class="s30">How about bias in image-tagging APIs? Facebook AI Research pondered over the question “Does Object Recognition Work for Everyone?” in a paper by the same title (Terrance DeVries et al.). The group tested multiple cloud APIs in February 2019 on Dollar Street, a diverse collection of images of household items from 264 different homes across 50 countries (</a><a href="#bookmark868" class="s18">Figure </a>8-12<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="523" height="686" alt="image" src="KerasTensorFlow2019/Image_474.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 176pt;text-indent: -165pt;text-align: left;"><a name="bookmark868">Figure 8-12. Image-tagging API performance on geographically diverse images from the Dollar Street dataset</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Here are some of the key learnings from this test:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_475.png"/></span></p><p class="s39" style="padding-top: 6pt;padding-left: 33pt;text-indent: 0pt;text-align: left;"><a href="#bookmark869" class="s30">Accuracy of object classification APIs was significantly lower in images from regions with lower income levels, as illustrated in </a>Figure 8-13<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_476.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">Datasets such as ImageNet, COCO, and OpenImages severely undersample images from Africa, India, China, and Southeast Asia,</p><p class="s17" style="padding-top: 3pt;padding-left: 33pt;text-indent: 0pt;text-align: justify;">hence leading to lower performance on images from the non-Western world.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_477.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: justify;">Most of the datasets were collected starting with keyword searches in English, omitting images that mentioned the same object with phrases in other languages.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 33pt;text-indent: 0pt;text-align: left;"><span><img width="508" height="436" alt="image" src="KerasTensorFlow2019/Image_478.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 104pt;text-indent: -93pt;text-align: left;"><a name="bookmark869">Figure 8-13. Average accuracy (and standard deviation) of six cloud APIs versus income of the household where the images were collected</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark870">In summary, depending on the scenario for which we want to use these cloud APIs, we should build our own benchmarks and test them periodically to evaluate whether these APIs are appropriate for the use case.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark810">Getting Up and Running with Cloud APIs</a><a name="bookmark871">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark872">Calling these cloud services requires minimal code. At a high level, get an API key, load the image, specify the intent, make a POST request with the proper encoding (e.g., base64 for the image), and receive the results. Most of the cloud providers offer software development kits (SDKs) and sample code showcasing how to call their services. They additionally provide pip- installable Python packages to further simplify calling them. If you’re using Amazon Rekognition, we highly recommend using its </a><span class="s42">pip </span>package.</p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Let’s reuse our thrilling image to test-run these services.</p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">First, let’s try it on Microsoft Cognitive Services. Get an API key and replace it in the following code (the first 5,000 calls are free — more than enough for our experiments):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;line-height: 206%;text-align: left;">cognitive_services_tagimage(&#39;DogAndBaby.jpg&#39;) Results:</p><p class="s75" style="padding-top: 6pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">{</p><p class="s120" style="padding-left: 41pt;text-indent: 0pt;text-align: left;">&quot;description&quot;<span class="s75">: {</span></p><p class="s75" style="padding-left: 62pt;text-indent: 0pt;text-align: left;"><span class="s120">&quot;tags&quot;</span>: [<span style=" color: #C30;">&quot;person&quot;</span>, <span style=" color: #C30;">&quot;indoor&quot;</span>, <span style=" color: #C30;">&quot;sitting&quot;</span>, <span style=" color: #C30;">&quot;food&quot;</span>, <span style=" color: #C30;">&quot;table&quot;</span>, <span style=" color: #C30;">&quot;little&quot;</span>,</p><p class="s76" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">&quot;small&quot;<span style=" color: #000;">, </span>&quot;dog&quot;<span style=" color: #000;">, </span>&quot;child&quot;<span style=" color: #000;">, </span>&quot;looking&quot;<span style=" color: #000;">, </span>&quot;eating&quot;<span style=" color: #000;">, </span>&quot;baby&quot;<span style=" color: #000;">, </span>&quot;young&quot;<span style=" color: #000;">, </span>&quot;front&quot;<span style=" color: #000;">,</span></p><p class="s76" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">&quot;feeding&quot;<span style=" color: #000;">, </span>&quot;holding&quot;<span style=" color: #000;">, </span>&quot;playing&quot;<span style=" color: #000;">, </span>&quot;plate&quot;<span style=" color: #000;">, </span>&quot;boy&quot;<span style=" color: #000;">, </span>&quot;girl&quot;<span style=" color: #000;">, </span>&quot;cake&quot;<span style=" color: #000;">, </span>&quot;bowl&quot;<span style=" color: #000;">,</span></p><p class="s76" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">&quot;woman&quot;<span style=" color: #000;">, </span>&quot;kitchen&quot;<span style=" color: #000;">, </span>&quot;standing&quot;<span style=" color: #000;">, </span>&quot;birthday&quot;<span style=" color: #000;">, </span>&quot;man&quot;<span style=" color: #000;">, </span>&quot;pizza&quot;<span style=" color: #000;">],</span></p><p class="s120" style="padding-left: 62pt;text-indent: 0pt;text-align: left;">&quot;captions&quot;<span class="s75">: [{</span></p><p class="s75" style="padding-left: 83pt;text-indent: 0pt;text-align: left;"><span class="s120">&quot;text&quot;</span>: <span style=" color: #C30;">&quot;a little girl sitting at a table with a dog&quot;</span>,</p><p class="s120" style="padding-left: 83pt;text-indent: 0pt;text-align: left;">&quot;confidence&quot;<span class="s75">: </span><span class="s78">O.84265453815486435</span></p><p class="s75" style="padding-left: 62pt;text-indent: 0pt;text-align: left;">}]</p><p class="s75" style="padding-left: 41pt;text-indent: 0pt;text-align: left;">},</p><p class="s75" style="padding-left: 41pt;text-indent: 0pt;text-align: left;"><span class="s120">&quot;requestId&quot;</span>: <span style=" color: #C30;">&quot;1a32c16f-fda2-4adf-99b3-9c4bf9e11a6O&quot;</span>,</p><p class="s120" style="padding-left: 41pt;text-indent: 0pt;text-align: left;">&quot;metadata&quot;<span class="s75">: {</span></p><p class="s75" style="padding-left: 62pt;text-indent: 0pt;text-align: left;"><span class="s120">&quot;height&quot;</span>: <span style=" color: #F60;">427</span>,</p><p class="s75" style="padding-left: 62pt;text-indent: 0pt;text-align: left;"><span class="s120">&quot;width&quot;</span>: <span style=" color: #F60;">64O</span>,</p><p class="s120" style="padding-left: 62pt;text-indent: 0pt;text-align: left;">&quot;format&quot;<span class="s75">: </span><span class="s76">&quot;Jpeg&quot;</span></p><p class="s75" style="padding-left: 41pt;text-indent: 0pt;text-align: left;">}</p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">}</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">“A little girl sitting at a table with a dog” — pretty close! There are other options to generate more detailed results, including a probability along with each tag.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="536" height="202" alt="image" src="KerasTensorFlow2019/Image_479.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Although the ImageNet dataset is primarily tagged with nouns, many of these services go beyond and return verbs like “eating,” “sitting,” “jumping.” Additionally, they might contain adjectives like “red.” Chances are, these might not be appropriate for our application. We might want to filter out these adjectives and verbs. One option is to check their linguistic type against Princeton’s WordNet. This is available in Python with the Natural Language Processing Toolkit (NLTK). Additionally, we might want to filter out words like “indoor” and “outdoor” (often shown by Clarifai and Cognitive Services).</p><p style="text-indent: 0pt;text-align: left;"/><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Now, let’s test the same image using Google Vision APIs. Get an API key from their website and use it in the following code (and rejoice, because the first 1,000 calls are free):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;line-height: 206%;text-align: left;">google_cloud_tagimage(&#39;DogAndBaby.jpg&#39;) Results:</p><p class="s75" style="padding-top: 6pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">{</p><p class="s120" style="padding-left: 25pt;text-indent: 0pt;text-align: left;">&quot;responses&quot;<span class="s75">: [</span></p><p class="s75" style="padding-left: 41pt;text-indent: 0pt;text-align: left;">{</p><p class="s120" style="padding-left: 51pt;text-indent: 0pt;text-align: left;">&quot;labelAnnotations&quot;<span class="s75">: [</span></p><p class="s75" style="padding-left: 62pt;text-indent: 0pt;text-align: left;">{</p><p class="s75" style="padding-left: 72pt;text-indent: 0pt;text-align: left;"><span class="s120">&quot;mid&quot;</span>: <span style=" color: #C30;">&quot;/m/Obt9lr&quot;</span>, <span class="s120">&quot;description&quot;</span>: <span style=" color: #C30;">&quot;dog&quot;</span>, <span class="s120">&quot;score&quot;</span>: <span style=" color: #F60;">O.951O77</span>,</p><p class="s120" style="padding-left: 72pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&quot;topicality&quot;<span class="s75">: </span><span class="s78">O.951O77</span></p><p class="s75" style="padding-left: 62pt;text-indent: 0pt;text-align: left;">},</p><p class="s75" style="padding-left: 62pt;text-indent: 0pt;text-align: left;">{</p><p class="s75" style="padding-left: 72pt;text-indent: 0pt;text-align: left;"><span class="s120">&quot;mid&quot;</span>: <span style=" color: #C30;">&quot;/m/O6zO4&quot;</span>, <span class="s120">&quot;description&quot;</span>: <span style=" color: #C30;">&quot;skin&quot;</span>, <span class="s120">&quot;score&quot;</span>: <span style=" color: #F60;">O.923O451</span>,</p><p class="s120" style="padding-left: 72pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&quot;topicality&quot;<span class="s75">: </span><span class="s78">O.923O451</span></p><p class="s75" style="padding-left: 62pt;text-indent: 0pt;text-align: left;">},</p><p class="s75" style="padding-left: 62pt;text-indent: 0pt;text-align: left;">{</p><p class="s75" style="padding-left: 72pt;text-indent: 0pt;text-align: left;"><span class="s120">&quot;mid&quot;</span>: <span style=" color: #C30;">&quot;/m/O1z5f&quot;</span>,</p><p class="s75" style="padding-left: 72pt;text-indent: 0pt;text-align: left;"><span class="s120">&quot;description&quot;</span>: <span style=" color: #C30;">&quot;dog like mammal&quot;</span>,</p><p class="s75" style="padding-left: 72pt;text-indent: 0pt;text-align: left;"><span class="s120">&quot;score&quot;</span>: <span style=" color: #F60;">O.88359463</span>,</p><p class="s120" style="padding-left: 72pt;text-indent: 0pt;text-align: left;">&quot;topicality&quot;<span class="s75">: </span><span class="s78">O.88359463</span></p><p class="s75" style="padding-left: 62pt;text-indent: 0pt;text-align: left;">},</p><p class="s75" style="padding-left: 62pt;text-indent: 0pt;text-align: left;">{</p><p class="s75" style="padding-left: 72pt;text-indent: 0pt;text-align: left;"><span class="s120">&quot;mid&quot;</span>: <span style=" color: #C30;">&quot;/m/O1f5gx&quot;</span>, <span class="s120">&quot;description&quot;</span>: <span style=" color: #C30;">&quot;eating&quot;</span>, <span class="s120">&quot;score&quot;</span>: <span style=" color: #F60;">O.7258142</span>,</p><p class="s120" style="padding-left: 72pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&quot;topicality&quot;<span class="s75">: </span><span class="s78">O.7258142</span></p><p class="s75" style="padding-left: 62pt;text-indent: 0pt;text-align: left;">}</p><p class="s121" style="padding-left: 19pt;text-indent: 0pt;text-align: left;"># other objects</p><p class="s75" style="padding-left: 51pt;text-indent: 0pt;text-align: left;">]</p><p class="s75" style="padding-left: 41pt;text-indent: 0pt;text-align: left;">}</p><p class="s75" style="padding-left: 25pt;text-indent: 0pt;text-align: left;">]</p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">}</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Wasn’t that a little too easy? These APIs help us get to state-of-the-art results without needing a Ph.D. — in just 15 minutes!</p><p class="s25" style="padding-top: 9pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Even though these services return tags and image captions with probabilities, it’s up to the developer to determine a threshold. Usually, 60% and 40% are good thresholds for image tags and image captions, respectively.</p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">It’s also important to communicate the probability to the end-user from a UX standpoint. For example, if the result confidence is &gt;80%, we might say prefix the tags with “This image <i>contains </i>” For &lt;80%, we might want to change that</p><p class="s26" style="padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark873">prefix to “This image </a><i>may contain…</i>” to reflect the lower confidence in the result.</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="536" height="209" alt="image" src="KerasTensorFlow2019/Image_480.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark811">Training Our Own Custom Classifier</a><a name="bookmark874">&zwnj;</a></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark227" class="s30" name="bookmark875">Chances are these services were not quite sufficient to meet the requirements of our use case. Suppose that the photograph we sent to one of these services responded with the tag “dog.” We might be more interested in identifying the breed of the dog. Of course, we can follow </a>Chapter 3 <span style=" color: #000;">to train our own classifier in Keras. But wouldn’t it be more awesome if we didn’t need to write a single line of code? Help is on the way.</span></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">A few of these cloud providers give us the ability to train our own custom classifier by merely using a drag-and-drop interface. The pretty user interfaces provide no indication that under the hood they are using transfer learning. As a result, Cognitive Services Custom Vision, Google AutoML, Clarifai, and IBM Watson all provide us the option for custom training.</p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Additionally, some of them even allow building custom detectors, which can identify the location of objects with a bounding box. The key process in all of them being the following:</p><ol id="l18"><li><p class="s17" style="padding-top: 4pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Upload images</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 52pt;text-indent: -15pt;text-align: left;">Label them</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 52pt;text-indent: -15pt;text-align: left;">Train a model</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 52pt;text-indent: -15pt;text-align: left;">Evaluate the model</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 52pt;text-indent: -15pt;text-align: left;">Publish the model as a REST API</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 52pt;text-indent: -15pt;text-align: left;">Bonus: Download a mobile-friendly model for inference on smartphones and edge devices</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s39" style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="https://www.customvision.ai/" class="s30" target="_blank">Let’s see a step-by-step example of Microsoft’s </a>Custom Vision<span style=" color: #000;">.</span></p><ol id="l19"><li><p class="s22" style="padding-top: 6pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Create a project <a href="#bookmark876" class="s30">(</a><span class="s39">Figure 8-14</span><span class="s17">): Choose a domain that best describes our use case. For most purposes, “General” would be optimal. For more specialized scenarios, we might want to choose a relevant domain.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 64pt;text-indent: 0pt;text-align: left;"><span><img width="501" height="709" alt="image" src="KerasTensorFlow2019/Image_481.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark876">Figure 8-14. Creating a new project in Custom Vision</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 8pt;padding-left: 52pt;text-indent: 0pt;text-align: left;">As an example, if we have an ecommerce website with photos of products against a pure white background, we might want to select the “Retail” domain. If we intend to run this model on a mobile phone eventually, we should choose the “Compact” version of the</p><p class="s17" style="padding-top: 3pt;padding-left: 52pt;text-indent: 0pt;text-align: left;">model, instead; it is smaller in size with only a slight loss in accuracy.</p></li><li><p class="s22" style="padding-top: 13pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Upload <a href="#bookmark877" class="s30">(</a><span class="s39">Figure 8-15</span><span class="s17">): For each category, upload images and tag them. It’s important to upload at least 30 photographs per category. For our test, we uploaded more than 30 images of Maltese dogs and tagged them appropriately.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 53pt;text-indent: 0pt;text-align: left;"><span><img width="533" height="564" alt="image" src="KerasTensorFlow2019/Image_482.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 125pt;text-indent: 0pt;text-align: left;"><a name="bookmark877">Figure 8-15. Uploading images on CustomVision.ai</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s22" style="padding-top: 10pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Train <a href="#bookmark878" class="s30">(</a><span class="s39">Figure 8-16</span><span class="s17">): Click the Train button, and then in about three minutes, we have a spanking new classifier ready.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 53pt;text-indent: 0pt;text-align: left;"><span><img width="532" height="62" alt="image" src="KerasTensorFlow2019/Image_483.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 238pt;text-indent: -176pt;text-align: left;"><a name="bookmark878">Figure 8-16. The Train button in the upper-right corner of the CustomVision.ai page</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s22" style="padding-top: 9pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Analyze the model’s performance<a href="#bookmark880" class="s30">: Check the precision and recall of the model. By default, the system sets the threshold at 90% confidence and gives the precision and recall metrics at that value. For higher precision, increase the confidence threshold. This would come at the expense of reduced recall. </a><span class="s39">Figure 8-17 </span><span class="s17">shows example output.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s22" style="padding-left: 52pt;text-indent: -15pt;text-align: left;">Ready to go<span class="s17">: We now have a production-ready API endpoint that we can call from any application.</span></p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">To highlight the effect of the amount of data on model quality, let’s train a dog breed classifier. We can use the Stanford Dogs dataset, a collection of more than 100 dog categories. For simplicity, we randomly chose 10 breeds, which have more than 200 images available. With 10 classes, a random classifier would have one-tenth, or 10%, the chance of correctly identifying an image. We should easily be able to beat this number.</p><p class="s39" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Table 8-2 <span style=" color: #000;">shows the effect of training on datasets with different volumes.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s22" style="padding-left: 170pt;text-indent: -86pt;text-align: left;"><a name="bookmark879">Table 8-2. Effect of number of training images on precision and recall</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 63pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="436" height="1" alt="image" src="KerasTensorFlow2019/Image_484.png"/></span></p><p class="s33" style="padding-top: 1pt;padding-bottom: 3pt;padding-left: 119pt;text-indent: 0pt;text-align: left;">30 training images/class 200 training images/class</p><p style="padding-left: 63pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="440" height="1" alt="image" src="KerasTensorFlow2019/Image_485.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="438" height="27" alt="image" src="KerasTensorFlow2019/Image_486.png"/></span></p><p class="s26" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Recall 85.3% 89.6%</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-top: 1pt;padding-bottom: 3pt;padding-left: 66pt;text-indent: 0pt;text-align: left;">Precision 91.2% 93.5%</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="536" height="264" alt="image" src="KerasTensorFlow2019/Image_487.jpg"/></span></p><p class="s19" style="padding-top: 5pt;padding-left: 214pt;text-indent: -204pt;text-align: left;"><a name="bookmark880">Figure 8-17. Relative precision and recall for our sample training set with 200 images per class</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Because we haven’t uploaded a test set, the performance figures reported here are on the full dataset using the common <i>k</i>-fold cross-validation technique. This means the data was randomly divided into <i>k </i>parts, then (<i>k</i></p><p class="s22" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;">– <span class="s17">1) parts were used for training, and the remaining part was used for testing. This was performed a few times, each time with a randomized subset of images, and the averaged results are reported here.</span></p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;"><a href="#bookmark881" class="s30">It is incredible that even with 30 images per class, the classifier’s precision is greater than 90%, as depicted in </a>Figure 8-18<span style=" color: #000;">. And, surprisingly, this took slightly less than 30 seconds to train.</span></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Not only this, we can dig down and investigate the performance on each class. Classes with high precision might visibly be more distinct, whereas those with low precision might look similar to another class.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 33pt;text-indent: 0pt;text-align: left;"><span><img width="525" height="437" alt="image" src="KerasTensorFlow2019/Image_488.jpg"/></span></p><p class="s19" style="padding-top: 8pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark881">Figure 8-18. Some of the possible tags returned by the API</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark882">This short and convenient approach is not without its downsides, as you will see in the following section. In that section, we also discuss mitigation strategies to help take advantage of this rather useful tool.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark812">Top Reasons Why Our Classifier Does Not Work Satisfactorily</a><a name="bookmark883">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">There are a number of reasons why a classifier would not perform well. The following are some of them:</p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Not enough data</p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark884">If we find that the accuracy is not quite sufficient for our needs, we might need to train the system with more data. Of course, 30 images per class just gets us started. But for a production-quality application, more images are better. 200 images per class are usually recommended.</a></p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Nonrepresentative training data</p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;line-height: 107%;text-align: left;">Often, the images on the internet are far too clean, set up in studio lighting with clean backgrounds, and close to the center of the frame. Images that our application might see on a daily basis might not be represented quite so well. It’s really important to train our classifier with real-world images for the best performance.</p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Unrelated domain</p><p class="s39" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a href="#bookmark227" class="s30">Under the hood, Custom Vision is running transfer learning. This makes it really important to choose the correct domain when creating the project. As an example, if we are trying to classify X-ray images, transfer learning from an ImageNet-based model might not yield as accurate a result. For cases like that, training our own classifier manually in Keras would work best, as demonstrated in </a>Chapter 3 <span style=" color: #000;">(though this will probably take more than three minutes).</span></p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Using it for regression</p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;line-height: 107%;text-align: left;">In machine learning, there are two common categories of problems: classification and regression. Classification is predicting one or more classes for input. Regression, on the other hand, is predicting a numerical value given an input; for example, predicting house prices. Custom Vision is primarily a classification system. Using it to count objects by tagging the number of objects is the wrong approach, and will lead to unsatisfactory results.</p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;line-height: 107%;text-align: left;">Counting objects is a type of regression problem. We can do it by localizing each instance of the object in an image (aka object detection) and counting their occurrences. Another example of a regression problem is predicting the age of a person based on their profile photo. We tackle both problems in later chapters.</p><p class="s22" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Classes are too similar</p><p style="text-indent: 0pt;text-align: left;"><span><img width="536" height="201" alt="image" src="KerasTensorFlow2019/Image_489.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">A great feature of Custom Vision is that if the model is unsure of any image that it encounters via its API endpoint, the web UI will show those images for a manual review. We can review and manually tag new images on a periodic basis and continuously improve the quality of the model. These images tend to improve the classifier the most for two reasons: first, they represent real-world usage. Second, and more importantly, they have more impact on the model in comparison to images that the model can already easily classify. This is known as semisupervised learning.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s39" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a href="#bookmark227" class="s30">If our classes look too similar and rely heavily on smaller-level details for distinction, the model might not perform as well. For example, a five-dollar note and a 20-dollar note have very similar high-level features. It’s at the lower-level details that show they are really distinct. As another example, it might be easy to distinguish between a Chihuahua and a Siberian Husky, but it’s more difficult to distinguish between an Alaskan Malamute and a Siberian Husky. A fully retrained CNN, as demonstrated in </a>Chapter 3<span style=" color: #000;">, should perform better than this Custom Vision-based system.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In this section, we discussed a few different ways in which we can improve our model’s accuracy. In the real world, that is not the end-all-be-all of a user’s experience. How quickly we are able to respond to a request also matters a lot. In the following section, we cover a couple of different ways we can improve performance without sacrificing quality.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark813">Comparing Custom Classification APIs</a><a name="bookmark885">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark886">As you might have noticed throughout the book, we are pretty dogmatic about being data driven. If we are going to spend good money on a service, we better get the best bang for our buck. Time to put the hype to the test.</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">For a good number of classification problems, these custom cloud-based classifiers perform pretty well. To truly test their limits, we need something more challenging. We need to unleash the toughest doggone dataset, train this animal, and fetch some insightful results — using the Stanford Dogs dataset.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Using the entire dataset might make it too easy for these classifiers (after all, ImageNet already has so many dog breeds), so we took it up a notch. Instead, we trained our own Keras classifier on the entire dataset and built a mini-dataset out of the top 34 worst-performing classes (each containing at least 140 images). The reason these classes performed poorly was because they often became confused with other similar-looking dog breeds. To perform better, they require a fine-grained understanding of the features. We divide the images into 100 randomly chosen images per class in the training dataset and 40 randomly chosen images per class in the test dataset. To avoid any class imbalances, which can have an impact on predictions, we chose the same number of train and test images for each class.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Lastly, we selected a minimum confidence threshold of 0.5 as it appeared to strike a good balance between precision and recall across all services. At a high confidence threshold such as 0.99, a classifier might be very accurate, but there might be only a handful of images with predictions; in other words, really low recall. On the other hand, a really low threshold of</p><ol id="l20"><ol id="l21"><li><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">would result in predictions for nearly all images. However, we should not rely on many of these results. After all, the classifier is not confident.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Instead of reporting the precision and recall, we report the <i>F1 score </i>(also known as <i>F-measure</i>), which is a hybrid score that combines both of those values:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><span><img width="532" height="78" alt="image" src="KerasTensorFlow2019/Image_490.jpg"/></span></p><p class="s39" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark887" class="s30">Additionally, we report the time it took to train, as shown in </a>Figure 8-19<span style=" color: #000;">. Beyond just the cloud, we also trained using Apple’s Create ML tool on a</span></p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">MacBook Pro with and without data augmentations (rotate, crop, and flip).</p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Google and Microsoft provide the ability to customize the duration of training. Google Auto ML allows us to customize between 1 and 24 hours. Microsoft provides a free “Fast Training” option and a paid “Advanced Training” option (similar to Google’s offering) with which we can select the duration to be anywhere between 1 and 24 hours.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 38pt;text-indent: 0pt;text-align: left;"><span><img width="512" height="299" alt="image" src="KerasTensorFlow2019/Image_491.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 173pt;text-indent: -155pt;text-align: left;"><a name="bookmark887">Figure 8-19. A chart showing the F1 score for custom classifier services, as of August 2019 (higher is better)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Following are some interesting takeaways from this experiment:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_492.png"/></span></p><p class="s17" style="padding-top: 6pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">Clarifai and Microsoft offered near-instant training for the 3,400 training images.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_493.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">Compared to “Fast Training,” Microsoft’s “Advanced Training” performed slightly better (roughly a 1-point increase) for the extra one hour of training. Because “Fast Training” took less than 15 seconds to train, we can infer that its base featurizer was already good at extracting fine-grained features.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_494.png"/></span></p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">Surprisingly, Apple’s Create ML actually performed worse after adding in the augmentations, despite taking more than two extra hours to train, most of which was spent creating the augmentations. This was done on a top-of-the-line MacBook Pro and showed 100% GPU utilization in Activity Monitor.</p><p class="s39" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark888" class="s30">Additionally, to test the featurizer’s strength, we varied the amount of training data supplied to the service (</a>Figure 8-20<span style=" color: #000;">). Because Microsoft took less than 15 seconds to train, it was easy (and cheap!) for us to perform the experiment there. We varied between 30 and 100 images per class for training while keeping the same 40 images per class for testing.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 38pt;text-indent: 0pt;text-align: left;"><span><img width="512" height="299" alt="image" src="KerasTensorFlow2019/Image_495.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 211pt;text-indent: -194pt;text-align: left;"><a name="bookmark888">Figure 8-20. Effect of varying size of training data per class on test F1 score (higher is better)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Even though Microsoft recommends using at least 50 images per class, going under that limit did not affect performance significantly. The fact that the F1 score did not vary as much as one would expect shows the value of transfer learning (enabling less data to build classifiers) and having a good featurizer capable of fine-grained classification.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark889">It bears repeating that this experiment was intentionally made difficult to stress-test these classifiers. On average, they would have performed much better on the entire Stanford Dogs dataset.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark814">Performance Tuning for Cloud APIs</a><a name="bookmark890">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark891">A photograph taken by a modern cell phone can have a resolution as high as 4000 x 3000 pixels and be upward of 4 MB in size. Depending on the network quality, it can take a few seconds to upload such an image to the service. With each additional second, it can become more and more frustrating for our users. Could we make this faster?</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">There are two ways to reduce the size of the image:</p><p class="s22" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Resizing</p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark892">Most CNNs take an input image with a size of 224 x 224 or 448 x 448 pixels. Much of a cell phone photo’s resolution would be unnecessary for a CNN. It would make sense to downsize the image prior to sending it over the network, instead of sending a large image over the network and then downsizing it on the server.</a></p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Compression</p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark893">Most image libraries perform </a><i>lossy </i>compression while saving a file. Even a little bit of compression can go a long way in reducing the size of the image while minimally affecting the quality of the image itself.</p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;line-height: 107%;text-align: left;">Compression does introduce noise, but CNNs are usually robust enough to deal with some of it.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark815">Effect of Resizing on Image Labeling APIs</a><a name="bookmark894">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark895">We performed an experiment in which we took more than a hundred diverse unmodified images taken from an iPhone at the default resolution (4032 x 3024) and sent them to the Google Cloud Vision API to get labels for each of those images. We then downsized each of the original images in 5% increments (5%, 10%, 15%…95%) and collected the API results for those smaller images, too. We then calculated the agreement rate for each image using the following formula:</a></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><span><img width="531" height="30" alt="image" src="KerasTensorFlow2019/Image_496.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s39" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Figure 8-21 <span style=" color: #000;">shows the results of this experiment. In the figure, the solid line shows the reduction in file size, and the dotted line represents the agreement rate. Our main conclusion from the experiment was that a 60% reduction in resolution led to a 95% reduction in file size, with little change in accuracy compared to the original images.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 39pt;text-indent: 0pt;text-align: left;"><span><img width="498" height="312" alt="image" src="KerasTensorFlow2019/Image_497.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 177pt;text-indent: -168pt;text-align: left;"><a name="bookmark896">Figure 8-21. Effect of resizing an image on agreement rate and file size reduction relative to the original image</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark816">Effect of Compression on Image Labeling APIs</a><a name="bookmark897">&zwnj;</a></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark898" class="s30">We repeated the same experiment, but instead of changing the resolution, we changed the compression factor for each image incrementally. In </a>Figure 8-22<span style=" color: #000;">, the solid line shows the reduction in file size and the dotted line represents the agreement rate. The main takeaway here is that a 60% compression score (or 40% quality) leads to an 85% reduction in file size, with little change in accuracy compared to the original image.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 39pt;text-indent: 0pt;text-align: left;"><span><img width="503" height="302" alt="image" src="KerasTensorFlow2019/Image_498.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 158pt;text-indent: -141pt;text-align: left;"><a name="bookmark898">Figure 8-22. Effect of compressing an image on agreement rate and file size reduction relative to the original image</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark817">Effect of Compression on OCR APIs</a><a name="bookmark899">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark900">We took a document containing 300-plus words at the default resolution of an iPhone (4032 x 3024), and sent it to the Microsoft Cognitive Services API to test text recognition. We then compressed it at 5% increments and then sent each image and compressed it. We sent these images to the same API and compared their results against the baseline to calculate the percentage WER. We observed that even setting the compression factor to 95% (i.e., 5% quality of the original image) had no effect on the quality of results.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark818">Effect of Resizing on OCR APIs</a><a name="bookmark901">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We repeated the previous experiment, but this time by resizing each image instead of compressing. After a certain point, the WER jumped from none to almost 100%, with nearly all words being misclassified. Retesting this with another document having each word at a different font size showed that all words under a particular font size were getting misclassified. To effectively recognize text, OCR engines need the text to be bigger than a minimum height (a good rule of thumb is larger than 20 pixels). Hence the higher the resolution, the higher the accuracy.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">What have we learned?</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_499.png"/></span></p><p class="s17" style="padding-top: 6pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">For text recognition, compress images heavily, but do not resize.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_500.png"/></span></p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">For image labeling, a combination of moderate resizing (say, 50%) and moderate compression (say, 30%) should lead to heavy file size reductions (and quicker API calls) without any difference in quality of API results.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="536" height="274" alt="image" src="KerasTensorFlow2019/Image_501.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 106%;text-align: left;"><a name="bookmark902">After receiving an image, cloud APIs internally resize it to fit their own implementation. For us, this means two levels of resizing: we first resize an image to reduce the size, then send it to the cloud API, which further resizes the image. Downsizing images introduces distortion, which is more evident at lower resolutions. We can minimize the effect of distortion by resizing from a higher resolution, which is bigger by a few multiples. For example, resizing 3024x3024 (original) → 302x302 (being sent to cloud) → 224x224 (internally resized by APIs) would introduce much more distortion in the final image compared to 3024x3024 → 896x896 → 224x224. Hence, it’s best to find a happy intermediate size before sending the images. Additionally, specifying advanced interpolation options like </a><span class="s75">BICUBIC </span>and <span class="s75">LANCZOS </span>will lead to more accurate representation of the original image in the smaller version.</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_502.png"/></span></p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">Depending on your application, you might be working with already resized and compressed images. Every processing step can introduce a slight difference in the results of these APIs, so aim to minimize them.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark819">Case Studies</a><a name="bookmark903">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark904">Some people say that the best things in life don’t come easy. We believe this chapter proves otherwise. In the following section, we take a look at how some tech industry titans use cloud APIs for AI to drive some very compelling scenarios.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark820">The New York Times</a><a name="bookmark905">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark906">It might seem like the scenario painted at the beginning of the chapter was taken out of a cartoon, but it was, in fact, pretty close to the case of the </a><i>New York Times </i>(NYT). With more than 160 years of illustrious history, NYT has a treasure trove of photographs in its archives. It stored many of these artifacts in the basement of its building three stories below the ground level, aptly called the “morgue.” The value of this collection is priceless. In 2015, due to a plumbing leak, parts of the basement were damaged including some of these archived records. Thankfully the damage was minimal. However, this prompted NYT to consider digitally archiving them to protect against another catastrophe.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The photographs were scanned and stored in high quality. However, the photographs themselves did not have any identifying information. What many of them did have were handwritten or printed notes on the backside giving context for the photographs. NYT used the Google Vision API to scan this text and tag the respective images with that information.</p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Additionally, this pipeline provided opportunities to extract more metadata from the photographs, including landmark recognition, celebrity recognition, and so on. These newly added tags powered its search feature so that anyone within the company and outside could explore the gallery and search using keywords, dates, and so on without having to visit the morgue, three stories down.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark821">Uber</a><a name="bookmark907">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark908">Uber uses Microsoft Cognitive Services to identify each of its seven million-plus drivers in a couple of milliseconds. Imagine the sheer scale at</a></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">which Uber must operate its new feature called “Real-Time ID Check.” This feature verifies that the current driver is indeed the registered driver by prompting them to take a selfie either randomly or every time they are assigned to a new rider. This selfie is compared to the driver’s photo on file, and only if the face models are a match is the driver allowed to continue. This security feature is helpful for building accountability by ensuring the security of the passengers and by ensuring that the driver’s account is not compromised. This safety feature is able to detect changes in the selfie, including a hat, beard, sunglasses, and more, and then prompts the driver to take a selfie without the hat or sunglasses.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="534" height="301" alt="image" src="KerasTensorFlow2019/Image_503.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 159pt;text-indent: -149pt;text-align: left;"><a href="https://oreil.ly/lw1Ho" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 11pt;" target="_blank">Figure 8-23. The Uber Drivers app prompts the driver to take a selfie to verify the identity of the driver (</a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 11pt;">image source</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark822">Giphy</a><a name="bookmark909">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark910">Back in 1976, when Dr. Richard Dawkins coined the term “meme,” little did he know it would take on a life of its own four decades later. Instead of giving a simple textual reply, we live in a generation where most chat applications suggest an appropriate animated GIF matching the context.</a></p><p class="s39" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark911" class="s30">Several applications provide a search specific to memes and GIFs, such as Tenor, Facebook messenger, Swype, and Swiftkey. Most of them search through Giphy (</a>Figure 8-24<span style=" color: #000;">), the world’s largest search engine for animated memes commonly in the GIF format.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="534" height="322" alt="image" src="KerasTensorFlow2019/Image_504.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 43pt;text-indent: 0pt;text-align: left;"><a name="bookmark911">Figure 8-24. Giphy extracts text from animations as metadata for searching</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark911" class="s30">GIFs often have text overlaid (like the dialogue being spoken) and sometimes we want to look for a GIF with a particular dialogue straight from a movie or TV show. For example, the image in </a><span style=" color: #8E0012;">Figure 8-24 </span>from the 2010 <i>Futurama </i>episode in which the “eyePhone” (sic) was released is often used to express excitement toward a product or an idea. Having an understanding of the contents makes the GIFs more searchable. To make this happen, Giphy uses Google’s Vision API to extract the recognize text and objects — aiding the search for the perfect GIF.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">It’s obvious that tagging GIFs is a difficult task because a person must sift through millions of these animations and manually annotate them frame by frame. In 2017, Giphy figured out two solutions to automate this process.</p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">The first approach was to detect text from within the image. The second</p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">approach was to generate tags based on the objects in the image to supplement the metadata for their search engine. This metadata is stored and searched using ElasticSearch to make a scalable search engine.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">For text detection, the company used the OCR services from the Google Vision API on the first frame from the GIFs to confirm whether the GIF actually contained text. If the API replied in the affirmative, Giphy would send the next frames, receive their OCR-detected texts, and figure out the differences in the text; for instance, whether the text was static (remaining the same throughout the duration of the gif) or dynamic (different text in different frames). For generating the class labels corresponding to objects in the image, engineers had two options: label detection or web entities, both of which are available on Google Vision API. Label detection, as the name suggests, provides the actual class name of the object. Web entities provides an entity ID (which can be referenceable in the Google Knowledge Graph), which is the unique web URL for identical and similar images seen elsewhere on the net. Using these additional annotations gave the new system an increase in the click-through-rate (CTR) by 32%. Medium-to-long-tail searches (i.e., not-so-frequent searches) benefitted the most, becoming richer with relevant content as the extracted metadata surfaced previously unannotated GIFs that would have otherwise been hidden. Additionally, this metadata and click-through behavior of users provides data to make a similarity and deduplication feature.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark823">OmniEarth</a><a name="bookmark912">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark913">OmniEarth is a Virginia-based company that specializes in collecting, analyzing, and combining satellite and aerial imagery with other datasets to track water usage across the country, scalably, and at high speeds. The company is able to scan the entire United States at a total of 144 million parcels of land within hours. Internally, it uses the IBM Watson Visual Recognition API to classify images of land parcels for valuable information like how green it is. Combining this classification with other data points such as temperature and rainfall, OmniEarth can predict how much water was used to irrigate the field.</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">For house properties, it infers data points from the image such as the presence of pools, trees, or irrigable landscaping to predict the amount of water usage. The company even predicted where water is being wasted due to malpractices like overwatering or leaks. OmniEarth helped the state of California understand water consumption by analyzing more than 150,000 parcels of land, and then devised an effective strategy to curb water waste.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark824">Photobucket</a><a name="bookmark914">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark915">Photobucket is a popular online image- and video-hosting community where more than two million images are uploaded every day. Using Clarifai’s NSFW models, Photobucket automatically flags unwanted or offensive user-generated content and sends it for further review to its human moderation team. Previously, the company’s human moderation team was able to monitor only about 1% of the incoming content. About 70% of the flagged images turned out to be unacceptable content.</a></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Compared to previous manual efforts, Photobucket identified 700 times more unwanted content, thus cleaning the website and creating a better UX. This automation also helped discover two child pornography accounts, which were reported to the FBI.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark825">Staples</a><a name="bookmark916">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark917">Ecommerce stores like Staples often rely on organic search engine traffic to drive sales. One of the methods to appear high in search engine rankings is to put descriptive image tags in the ALT text field for the image. Staples Europe, which serves 12 different languages, found tagging product images and translating keywords to be an expensive proposition, which is traditionally outsourced to human agencies. Fortunately, Clarifai provides tags in 20 languages at a much cheaper rate, saving Staples costs into five figures. Using these relevant keywords led to an increase in traffic and eventually increased sales through its ecommerce store due to a surge of visitors to the product pages.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark826">InDro Robotics</a><a name="bookmark918">&zwnj;</a></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark921" class="s30" name="bookmark919">This Canadian drone company uses Microsoft Cognitive Services to power search and rescue operations, not only during natural disasters but also to proactively detect emergencies. The company utilizes Custom Vision to train models specifically for identifying objects such as boats and life vests in water (</a>Figure 8-25<span style=" color: #000;">) and use this information to notify control stations.</span></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">These drones are able to scan much larger ocean spans on their own, as compared to lifeguards. This automation alerts the lifeguard of emergencies, thus improving the speed of discovery and saving lives in the process.</p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark922" class="s30" name="bookmark920">Australia has begun using drones from other companies coupled with inflatable pods to be able to react until help reaches. Soon after deployment, these pods saved two teenagers stranded in the ocean, as demonstrated in </a>Figure 8-26<span style=" color: #000;">. Australia is also utilizing drones to detect sharks so that beaches can be vacated. It’s easy to foresee the tremendous value these automated, custom training services can bring.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="533" height="365" alt="image" src="KerasTensorFlow2019/Image_505.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark921">Figure 8-25. Detections made by InDro Robotics</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="532" height="334" alt="image" src="KerasTensorFlow2019/Image_506.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 153pt;text-indent: -141pt;text-align: left;"><a href="https://oreil.ly/dPxBv" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 11pt;" target="_blank" name="bookmark922">Figure 8-26. Drone identifies two stranded swimmers and releases an inflatable pod that they cling onto (</a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 11pt;">image source</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark827">Summary</a><a name="bookmark923">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In this chapter, we explored various cloud APIs for computer vision, first qualitatively comparing the breadth of services offered and then quantitatively comparing their accuracy and price. We also looked at potential sources of bias that might appear in the results. We saw that with just a short code snippet, we can get started using these APIs in less than 15 minutes. Because one model doesn’t fit all, we trained a custom classifier using a drag-and-drop interface, and tested multiple companies against one another. Finally, we discussed compression and resizing recommendations to speed up image transmission and how they affect different tasks. To top it all off, we examined how companies across industries use these cloud APIs for building real-world applications.</p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Congratulations on making it this far! In the next chapter, we will see how to deploy our own inference server for custom scenarios.</p><p class="s16" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark924">Chapter 9. Scalable Inference Serving on Cloud with TensorFlow Serving and KubeFlow</a><a name="bookmark955">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_507.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Imagine this: you just built a top-notch classifier. Your goal, as the Silicon Valley motto goes, is to “<i>make the world a better place</i>,” which you’re going to do... with a spectacular Dog/Cat classifier. You have a solid business plan and you cannot wait to pitch your magical classifier to that venture capital firm next week. You know that the investors will question you about your cloud strategy, and you need to show a solid demo before they even consider giving you the money. How would you do this? Creating a model is half the battle, serving it is the next challenge, often the bigger one. In fact, for a long time it was common for training a model to only take a few weeks, but trying to serve it to a larger group of people was a months-long battle, often involving backend engineers and DevOps teams.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark956">In this chapter, we answer a few questions that tend to come up in the context of hosting and serving custom-built models.</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_508.png"/></span></p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">How can I host my model on my personal server so that my coworkers can play with it?</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_509.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">I am not a backend/infrastructure engineer, but I want to make my model available so that it can serve thousands (or even millions) of users. How can I do this at a reasonable price without worrying about scalability and reliability issues?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_510.png"/></span></p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">There are reasons (such as cost, regulations, privacy, etc.) why I cannot host my model on the cloud, but only on-premises (my work network). Can I serve predictions at scale and reliably in such a case?</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_511.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">Can I do inference on GPUs?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_512.png"/></span></p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">How much can I expect to pay for each of these options?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_513.png"/></span></p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">Could I scale my training and serving across multiple cloud providers?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_514.png"/></span></p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">How much time and technical know-how will it take to get these running?</p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Let’s begin our journey by looking at the high-level overview of the tools available to us.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark925">Landscape of Serving AI Predictions</a><a name="bookmark957">&zwnj;</a></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark959" class="s30" name="bookmark958">There is a multitude of tools, libraries, and cloud services available for getting trained AI models to serve prediction requests. </a>Figure 9-1 <span style=" color: #000;">simplifies them into four categories.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 34pt;text-indent: 0pt;text-align: left;"><span><img width="517" height="409" alt="image" src="KerasTensorFlow2019/Image_515.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 8pt;text-indent: 0pt;text-align: center;"><a name="bookmark959">Figure 9-1. A high-level overview and comparison of different inference serving options</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s39" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark960" class="s30">Depending on our inference scenarios, we can make an appropriate choice. </a>Table 9-1 <span style=" color: #000;">takes a deeper look.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s22" style="padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark960">Table 9-1. Tools to serve deep learning models over the network</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_516.png"/></span></p><p class="s33" style="padding-top: 1pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Category and examples</p><p class="s33" style="padding-top: 1pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Expected time to first prediction</p><p class="s33" style="padding-top: 1pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Pros and cons</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_517.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="1" alt="image" src="KerasTensorFlow2019/Image_518.png"/></span></p><p class="s33" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Category and examples</p><p class="s33" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Expected time to first prediction</p><p class="s33" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Pros and cons</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="2" alt="image" src="KerasTensorFlow2019/Image_519.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s26" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">HTTP servers</p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_520.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_521.png"/></span></p><p class="s26" style="padding-top: 6pt;padding-left: 36pt;text-indent: 0pt;line-height: 189%;text-align: left;">Flask Django</p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_522.png"/></span></p><p class="s26" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Apache OpenWhisk</p><p class="s26" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">&lt;5 minutes + Simple to run</p><p class="s26" style="padding-top: 6pt;padding-left: 87pt;text-indent: 0pt;text-align: left;">+ Often runs current Python code</p><ul id="l22"><li><p class="s26" style="padding-top: 5pt;padding-left: 96pt;text-indent: -9pt;text-align: left;">Slow</p></li><li><p class="s26" style="padding-top: 6pt;padding-left: 96pt;text-indent: -9pt;text-align: left;">Not optimized for AI</p></li></ul><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_523.png"/></span></p><p class="s26" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Python</p><p class="s113" style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">http.server</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="207" alt="image" src="KerasTensorFlow2019/Image_524.png"/></span></p><p class="s33" style="padding-left: 9pt;text-indent: 0pt;text-align: left;">Hosted and managed cloud stacks</p><p class="s26" style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;line-height: 189%;text-align: left;">Google Cloud ML Azure ML</p><p class="s26" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Amazon Sage Maker</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s26" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Algorithmia</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s26" style="padding-left: 5pt;text-indent: 0pt;text-align: left;">&lt;15 minutes + Easier GUI/command-line interfaces</p><p class="s26" style="padding-top: 6pt;padding-left: 82pt;text-indent: 0pt;text-align: left;">+ Highly scalable</p><p class="s26" style="padding-top: 5pt;padding-left: 82pt;text-indent: 0pt;text-align: left;">+ Fully managed, reduces the need for DevOps teams</p><ul id="l23"><li><p class="s26" style="padding-top: 5pt;padding-left: 82pt;text-indent: 0pt;text-align: left;">Usually limited to CPU-based inference, can be slow for large models</p></li><li><p class="s26" style="padding-top: 5pt;padding-left: 91pt;text-indent: -9pt;text-align: left;">Warm-up query time can be slow</p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="1" alt="image" src="KerasTensorFlow2019/Image_525.png"/></span></p><p class="s33" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Category and examples</p><p class="s33" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Expected time to first prediction</p><p class="s33" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Pros and cons</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="2" alt="image" src="KerasTensorFlow2019/Image_526.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s33" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Manually managed serving libraries</p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_527.png"/></span></p><p class="s26" style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">TensorFlow Serving</p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_528.png"/></span></p><p class="s26" style="padding-top: 10pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">NVIDIA</p><p class="s26" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">TensorRT</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_529.png"/></span></p><p class="s26" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">DeepDetect</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_530.png"/></span></p><p class="s26" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">MXNet Model Serving</p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_531.png"/></span></p><p class="s26" style="padding-top: 10pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Skymind Intelligence Layer with DeepLearning4J</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_532.png"/></span></p><p class="s26" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Seldon</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_533.png"/></span></p><p class="s26" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">DeepStack AI Server</p><p class="s26" style="padding-top: 4pt;padding-left: 4pt;text-indent: 0pt;text-align: left;">&lt;15 minutes + High performance</p><p class="s26" style="padding-top: 6pt;padding-left: 82pt;text-indent: 0pt;text-align: left;">+ Allows manual controls on optimizations, batching, etc.</p><p class="s26" style="padding-top: 5pt;padding-left: 82pt;text-indent: 0pt;text-align: left;">+ Can run inference on GPU</p></li><li><p class="s26" style="padding-top: 6pt;padding-left: 91pt;text-indent: -9pt;text-align: left;">More involved setup</p></li><li><p class="s26" style="padding-top: 5pt;padding-left: 82pt;text-indent: 0pt;text-align: left;">Scaling over multiple nodes usually requires extra groundwork</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="332" alt="image" src="KerasTensorFlow2019/Image_534.png"/></span></p><p class="s33" style="padding-left: 9pt;text-indent: 0pt;text-align: left;">Cloud AI orchestration frameworks</p><p class="s26" style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">KubeFlow</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s26" style="padding-left: 87pt;text-indent: -77pt;text-align: justify;">~1 hour + Makes scaling training and inference easy to manage</p><p class="s26" style="padding-top: 5pt;padding-left: 87pt;text-indent: 0pt;text-align: justify;">+ Portability between cloud providers</p><p class="s26" style="padding-top: 5pt;padding-left: 87pt;text-indent: 0pt;text-align: justify;">+ Consistent environments across development and production</p><p class="s26" style="padding-top: 5pt;padding-left: 87pt;text-indent: 0pt;text-align: justify;">+ For data scientists, integration with familiar tools such as Jupyter Notebooks for sending models to production</p><p class="s26" style="padding-top: 5pt;padding-left: 87pt;text-indent: 0pt;text-align: justify;">+ Enables composing conditional pipelines to automate testing, cascading models</p><p class="s26" style="padding-top: 5pt;padding-left: 87pt;text-indent: 0pt;text-align: left;">+ Uses existing manually managed serving libraries</p><ul id="l24"><li><p class="s26" style="padding-top: 5pt;padding-left: 96pt;text-indent: -9pt;text-align: left;">Still evolving</p></li><li><p class="s26" style="padding-top: 6pt;padding-left: 87pt;text-indent: 0pt;text-align: left;">For beginners, hosted and managed cloud stacks offer an easier learning curve</p></li></ul></li></ul><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In this chapter, we explore a range of tools and scenarios. Some of these options are easy to use but limited in functionality. Others offer more granular controls and higher performance but are more involved to set up. We look at one example of each category and take a deeper dive to</p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">develop an intuition into when using one of those makes sense. We then present a cost analysis of the different solutions as well as case studies detailing how some of these solutions work in practice today.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;"><a name="bookmark926">Flask: Build Your Own Server</a><a name="bookmark961">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;"><a name="bookmark962">We begin with the most basic technique of </a><i>Build Your Own Server </i><a href="#bookmark960" class="s30">(BYOS). From the choices presented in the first column of </a><span style=" color: #8E0012;">Table 9-1</span>, we’ve selected Flask.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark927">Making a REST API with Flask</a><a name="bookmark963">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark964">Flask is a Python-based web application framework. Released in 2010 and with more than 46,000 stars on GitHub, it is under continuous development. It’s also quick and easy to set up and is really useful for prototyping. It is often the framework of choice for data science practitioners when they want to serve their models to a limited set of users (e.g., sharing with coworkers on a corporate network) without a lot of fuss.</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Installing Flask with <span class="s42">pip </span>is fairly straightforward:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">$ pip install flask</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Upon installation, we should be able to run the following simple “Hello World” program:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;"><span class="s77">from </span><span class="s122">flask </span><span class="s77">import </span><span style=" color: #000087;">Flask app </span>= <span style=" color: #000087;">Flask</span>(<u> </u>name<u> </u>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;"><span style=" color: #99F;">@app</span>.<span style=" color: #000087;">route</span>(<span style=" color: #C30;">&quot;/hello&quot;</span>)</p><p class="s77" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">def <span class="s125">hello</span><span class="s75">():</span></p><p class="s77" style="padding-left: 41pt;text-indent: 0pt;text-align: left;">return <span class="s76">&quot;Hello World!&quot;</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 41pt;text-indent: -21pt;text-align: left;"><span class="s77">if</span><span class="s126"> </span>name == <span style=" color: #C30;">&quot;</span><span class="s127"> </span><span style=" color: #C30;">main</span><span class="s127"> </span><span style=" color: #C30;">&quot;</span>: <span style=" color: #000087;">app</span>.<span style=" color: #000087;">run</span>()</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">The following is the command to run the “Hello World” program:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">$ python hello.py</p><p class="s75" style="padding-left: 25pt;text-indent: 0pt;text-align: left;">* Running on http://127.O.O.1:5OOO/ (Press Ctrl+C to quit)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">By default, Flask runs on port 5000. When we open the URL <i>http://localhost:5000/hello </i><a href="#bookmark965" class="s30">in the browser, we should see the words “Hello World!,” as shown in </a><span style=" color: #8E0012;">Figure 9-2</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="536" height="157" alt="image" src="KerasTensorFlow2019/Image_535.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 184pt;text-indent: -174pt;text-align: left;"><a name="bookmark965">Figure 9-2. Navigate to http://localhost:5000/hello within a web browser to view the “Hello World!” web page</a></p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;">As you can see, it takes barely more than a few lines to get a simple web application up and running. One of the most important lines in that script is <span class="s42">@app.route(&quot;/hello&quot;)</span>. It specifies that the path <span class="s42">/hello </span>after the hostname would be served by the method immediately beneath it. In our case, it merely returns the string “Hello World!” In the next step, we look at how to deploy a Keras model to a Flask server and create a route that will serve predictions by our model.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark928">Deploying a Keras Model to Flask</a><a name="bookmark966">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark967">Our first step is to load our Keras model. The following lines load the model from the .</a><i>h5 </i><a href="http://practicaldeeplearning.ai/" class="s30" target="_blank">file. You’ll find the scripts for this chapter on the book’s GitHub (see </a><span class="s116">http://PracticalDeepLearning.ai</span>) in <i>code/chapter-9</i>:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;"><span class="s77">from </span><span class="s122">tf.keras.models </span><span class="s77">import </span><span style=" color: #000087;">load_model model </span>= <span style=" color: #000087;">load_model</span>(<span style=" color: #C30;">&quot;dogcat.h5&quot;</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Now, we create the route <i>/infer </i>that would support inference on our images. Naturally, we would support <span class="s42">POST </span>requests to accept images:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;"><span style=" color: #99F;">@app</span>.<span style=" color: #000087;">route</span>(<span style=" color: #C30;">&#39;/infer&#39;</span>, <span style=" color: #000087;">methods</span>=[<span style=" color: #000087;">POST</span>])</p><p class="s77" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">def <span class="s125">infer</span><span class="s75">():</span></p><p class="s75" style="padding-left: 30pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">file </span>= <span style=" color: #000087;">request</span>.<span style=" color: #000087;">files</span>[<span style=" color: #C30;">&#39;file&#39;</span>] <span style=" color: #000087;">image </span>= <span style=" color: #000087;">Image</span>.<span style=" color: #000087;">open</span>(<span style=" color: #000087;">file</span>) <span style=" color: #000087;">image </span>= <span style=" color: #000087;">preprocess</span>(<span style=" color: #000087;">image</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s74" style="padding-left: 30pt;text-indent: 0pt;text-align: left;">predictions <span style=" color: #000;">= </span>model<span style=" color: #000;">.</span>predict<span style=" color: #000;">(</span>image<span style=" color: #000;">) </span>max_index <span style=" color: #000;">= </span>numpy<span style=" color: #000;">.</span>argmax<span style=" color: #000;">(</span>predictions<span style=" color: #000;">)</span></p><p class="s128" style="padding-left: 30pt;text-indent: 0pt;line-height: 10pt;text-align: left;"># We know the labels from the model we trained previously</p><p class="s75" style="padding-left: 18pt;text-indent: 0pt;text-align: center;"><span class="s77">if </span><span style=" color: #000087;">max_index </span>== <span style=" color: #F60;">O</span>:</p><p class="s77" style="padding-left: 18pt;text-indent: 0pt;text-align: center;">return <span class="s76">&quot;Cat&quot;</span></p><p class="s77" style="padding-left: 18pt;text-indent: 0pt;text-align: center;">else<span class="s75">:</span></p><p class="s77" style="padding-left: 18pt;text-indent: 0pt;text-align: center;">return <span class="s76">&quot;Dog&quot;</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 121%;text-align: left;">To test the inference, let’s use the <span class="s42">curl </span>command, as follows, on a sample image containing a dog:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;"><a href="mailto:image=@dog.jpg" class="s129" target="_blank">$ curl -X POST -F </a>image=@dog.jpg &#39;http://localhost:5OOO/infer&#39;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">{&quot;predictions&quot;:[{&quot;label&quot;:&quot;dog&quot;,&quot;probability&quot;:O.8525O22864341736}]}</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">As expected, we get a prediction of “dog.” This has worked quite well so far. At this point, Flask runs only locally; that is, someone else on the network would not be able to make a request to this server. To make Flask available to others, we can simply change <span class="s42">app.run() </span>to the following:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">app</span>.<span style=" color: #000087;">run</span>(<span style=" color: #000087;">host</span>=<span style=" color: #C30;">&quot;O.O.O.O&quot;</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">At this point, we can give access to our model to anyone within our network. The next question would be — can we do the same to make the model available to the general public? The answer to that question is an emphatic no! The Flask website has a prominent warning stating <i>“WARNING: Do not use the development server in a production environment.” </i>Flask indeed does not support production work out of the box and would need custom code to enable that. In the upcoming sections, we look at how to host our models on systems that are meant for</p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">production use. With all of this in mind, let’s recap some of the pros and cons of using Flask.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark929">Pros of Using Flask</a><a name="bookmark968">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_536.png"/></span></p><p class="s17" style="padding-top: 6pt;padding-left: 33pt;text-indent: -26pt;line-height: 142%;text-align: left;">Flask provides some advantages, namely: Quick to set up and to prototype</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_537.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_538.png"/></span></p><p class="s17" style="padding-top: 7pt;padding-left: 33pt;text-indent: 0pt;line-height: 191%;text-align: left;">Fast development cycle Lightweight on resources</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_539.png"/></span></p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">Broad appeal within the Python community</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark930">Cons of Using Flask</a><a name="bookmark969">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">At the same time, Flask might not be your best choice, for the following reasons:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_540.png"/></span></p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">Cannot scale; by default, it is not meant for production loads. Flask can serve only one request at one time</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_541.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_542.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;line-height: 191%;text-align: left;"><a name="bookmark970">Does not handle model versioning out of the box Does not support batching of requests out of the box</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark931">Desirable Qualities in a Production-Level Serving System</a><a name="bookmark971">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark972">For any cloud service that is serving traffic from the public, there are certain attributes that we want to look for when deciding to use a solution. In the context of machine learning, there are additional qualities that we would look for while building inference services. We look at a few of them if this section.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark932">High Availability</a><a name="bookmark973">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark974">For our users to trust our service, it must be available almost always. For many serious players, they measure their availability metric in terms of “</a><i>number of nines</i><a href="#bookmark975" class="s30">.” If a business claims that its service has four 9s availability, they mean the system is up and available 99.99% of the time. Even though 99% sounds impressive, </a><span style=" color: #8E0012;">Table 9-2 </span>puts that downtime per year in perspective.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s22" style="padding-left: 132pt;text-indent: -1pt;text-align: left;"><a name="bookmark975">Table 9-2. Downtime per year for different availability percentages</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 117pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="292" height="1" alt="image" src="KerasTensorFlow2019/Image_543.png"/></span></p><p class="s33" style="padding-top: 1pt;padding-bottom: 3pt;padding-left: 120pt;text-indent: 0pt;text-align: left;">Availability % Downtime per year</p><p style="padding-left: 117pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="297" height="1" alt="image" src="KerasTensorFlow2019/Image_544.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="296" height="27" alt="image" src="KerasTensorFlow2019/Image_545.png"/></span></p><p class="s26" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">99.9% (“three nines”) 8.77 hours</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-top: 1pt;padding-bottom: 3pt;padding-left: 120pt;text-indent: 0pt;text-align: left;">99% (“two nines”) 3.65 days</p><p style="text-indent: 0pt;text-align: left;"><span><img width="296" height="27" alt="image" src="KerasTensorFlow2019/Image_546.png"/></span></p><p class="s26" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">99.999% (“five nines”) 5.26 minutes</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-top: 2pt;padding-bottom: 3pt;padding-left: 120pt;text-indent: 0pt;text-align: left;">99.99% (“four nines”) 52.6 minutes</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Imagine how ridiculous the situation would be if a major website like Amazon were only 99.9% available, losing millions in user revenue during the eight-plus hours of downtime. Five 9s is considered the holy grail.</p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Anything less than three 9s is typically unsuitable for a high-quality production system.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark933">Scalability</a><a name="bookmark976">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark977">Traffic handled by production services is almost never uniform across a larger time period. For example, the </a><i>New York Times </i>experiences significantly more traffic during morning hours, whereas Netflix typically experiences a surge in traffic between the evening and late-night hours, when people chill. There are also seasonal factors in traffic. Amazon experiences orders of magnitude more traffic on Black Friday and during Christmas season.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">A higher demand requires a higher amount of resources being available and online to serve them. Otherwise, the availability of the system would be in jeopardy. A naive way to accomplish this would be to anticipate the highest volume of traffic the system would ever serve, determine the number of resources necessary to serve that level of traffic, and then allocate that amount all the time, in perpetuity. There are two problems with this approach: 1) if your planning was correct, the resources would be underutilized most of the time, essentially burning money; and 2) if your estimation was insufficient, you might end up affecting the availability of your service and end up with a far worse problem of losing the trust of your customers and ultimately their wallets.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">A smarter way to manage traffic loads is to monitor them as they are coming in and dynamically allocate and deallocate resources that are available for service. This ensures that the increased traffic is handled without loss of service while keeping operating costs to a minimum during low-traffic times.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">When scaling down resources, any resource that is about to be deallocated is quite likely to be processing traffic at that moment. It’s essential to ensure that all of those requests be completed before shutting down that resource. Also, crucially, the resource must not process any new requests. This process is called <i>draining</i>. Draining is also crucial when machines are taken down for routine maintenance and/or upgrades.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark934">Low Latency</a><a name="bookmark978">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark979">Consider these facts. Amazon published a study in 2008 in which it found that every 100 ms increase in latency in its retail website resulted in a 1% loss of profit. A one-second delay in loading the website caused a whopping $1.6 billion in lost revenue! Google found that a 500 ms latency on mobile websites resulted in a traffic drop of 20%. In other words, a 20% decrease in the opportunity-to-serve advertisements. And this does not affect only industry giants. If a web page takes longer than three seconds to load on a mobile phone, 53% of users abandon it (according to a 2017 study by Google). It’s clear that time is money.</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Reporting average latency can be misleading because it might paint a cheerier picture than a ground reality. It’s like saying if Bill Gates walks into a room, everyone is a billionaire on average. Instead, percentile latency is the typically reported metric. For example, a service might report 987 ms @ 99th percentile. This means that 99% of the requests were served in 987 ms or less. The very same system could have a 20 ms latency on average. Of course, as traffic to your service increases, the latency might increase if the service is not scaled up to give adequate resources. As such, latency, high availability, and scalability are intertwined.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark935">Geographic Availability</a><a name="bookmark980">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark981">The distance between New York and Sydney is nearly 10,000 miles (16,000 km). The speed of light in a vacuum is roughly 186,282 miles per second (300,000 km per second). Silica glass (used in fiber-optic cables) decreases the speed of light by a factor of roughly 30% down to 130,487 miles per second (210,000 km per second). On a piece of fiber-optic running in a straight line between these two cities, the roundtrip travel time alone for a single request is nearly 152 ms. Keep in mind that this does not account for the amount of time it takes for the request to be processed at the server, or the hops that the packets need to make across multiple routers along the way. This level of service would be unacceptable for many applications.</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="536" height="353" alt="image" src="KerasTensorFlow2019/Image_547.png"/></span></p><p class="s25" style="padding-left: 100pt;text-indent: 0pt;line-height: 15pt;text-align: center;">TIP</p><p class="s68" style="padding-top: 5pt;text-indent: 0pt;text-align: left;"><a href="#bookmark982" style=" color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11pt;">Want to simulate how long the incoming requests would take from your computer to a particular datacenter around the world? </a>Table 9-3 <span style=" color: #000;">lists a few handy browser-based tools offered by cloud providers.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-left: 101pt;text-indent: 0pt;text-align: center;"><a name="bookmark982">Table 9-3. Latency measurement tools for different cloud providers</a></p><p style="text-indent: 0pt;text-align: left;"/><p class="s130" style="text-indent: 0pt;line-height: 11pt;text-align: left;">Service</p><p style="text-indent: 0pt;text-align: left;"/><p class="s130" style="text-indent: 0pt;line-height: 11pt;text-align: left;">Cloud provider</p><p style="text-indent: 0pt;text-align: left;"/><p class="s132" style="text-indent: 0pt;line-height: 11pt;text-align: left;">AzureSpeed.com <span style=" color: #000;">Microsoft Azure</span></p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="http://gcping.com/" class="s131">GCPing.com</a></p><p style="text-indent: 0pt;text-align: left;"/><p class="s133" style="text-indent: 0pt;line-height: 11pt;text-align: left;">Google Cloud Platform</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="text-indent: 0pt;text-align: left;">Additionally, to determine realistic combinations of latency from one location to another, <i>CloudPing.co </i>measures AWS Inter-Region Latency, between more than 16 US-based AWS datacenters to one another.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s132" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">CloudPing.info <span style=" color: #000;">Amazon Web Services</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Services that expect to be used throughout the world must be strategically located to minimize latency for the users in those regions. Additionally, resources can be dynamically scaled up or down depending on local traffic, thus giving more granular control. The major cloud providers have a presence on at least five continents (sorry penguins!).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark936">Failure Handling</a><a name="bookmark983">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark984">There’s an old saying that there are only two things that are assured in life</a></p><p class="s17" style="padding-top: 1pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">— death and taxes. In the twenty-first century, this adage applies not just to humans but also computer hardware. Machines fail all the time. The question is never <i>if </i>a machine will fail, it’s <i>when</i>. One of the necessary qualities of production-quality service is its ability to gracefully handle failures. If a machine goes down, quickly bring up another machine to take its place and continue serving traffic. If an entire datacenter goes down, seamlessly route traffic to another datacenter so that users don’t even realize that anything bad happened in the first place.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark937">Monitoring</a><a name="bookmark985">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark986">If you can’t measure it, you can’t improve it. Worse, does it even exist? Monitoring the number of requests, availability, latency, resource usage, number of nodes, distribution of traffic, and location of users is vital to understanding how a service performs; finding opportunities to improve it; and, more importantly, how much to pay. Most cloud providers already have built-in dashboards providing these metrics. Additionally, recording task-specific analytics like time for model inference, preprocessing, and so on can add another level of understanding.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark938">Model Versioning</a><a name="bookmark987">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark988">We have learned in this book (and will continue to learn all the way to the last page) that machine learning is always iterative. Particularly in the case of applications in the real world, data that the model can learn on is constantly being generated. Moreover, the incoming data distribution might shift over time compared to what it was trained on, leading to lower prediction power (a phenomenon called c</a><i>oncept drift</i>). To provide users with the best possible experience, we want to keep improving our models. Every time we train our model with newer data to further improve its accuracy and make the best version yet, we want to make it available for our users as quickly and seamlessly as possible. Any good production- quality inference system should provide the ability to provide different versions of a model, including the ability to swap a live version of the model with another version at a moment’s notice.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark939">A/B Testing</a><a name="bookmark989">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark990">In addition to supporting multiple versions of a model, there are reasons we’d want to serve different versions of the model at the same time depending on a variety of attributes such as the geographic location of the user, demographics, or simply by random assignment.</a></p><p class="s22" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">A/B testing <span class="s17">is a particularly useful tool when improving a model. After all, if our spanking new model was flawed in some way, we’d rather it be deployed to only a small subset of our users rather than 100% of them at the same time before we catch the flaw. Additionally, if a model meets criteria for success on that small subset, it provides validation for the experiment and justifies eventually being promoted to all users.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark940">Support for Multiple Machine Learning Libraries</a><a name="bookmark991">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark992">Last but not least, we don’t want to be locked into a single machine learning library. Some data scientists in an organization might train models in PyTorch, others in TensorFlow, or maybe scikit-Learn suffices for non– deep learning tasks. The flexibility to support multiple libraries would be a welcome bonus.</a><a name="bookmark993">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark941">Google Cloud ML Engine: A Managed Cloud AI Serving Stack</a><a name="bookmark994">&zwnj;</a></p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1389" class="s30" name="bookmark995">Considering all the desirable qualities we discussed in a production environment in the previous section, it’s generally not a good idea to use Flask for serving users. If you do not have a dedicated infrastructure team and would like to spend more time making better models than deploying them, using a managed cloud solution is the right approach. There are several cloud-based Inference-as-a-Service solutions on the market today. We have chosen to explore the Google Cloud ML Engine partly because of the convenient TensorFlow integration and partly because it ties in nicely with the ML Kit material that we touch upon in </a>Chapter 13<span style=" color: #000;">.</span><a name="bookmark996">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark942">Pros of Using Cloud ML Engine</a><a name="bookmark997">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_548.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_549.png"/></span></p><p class="s17" style="padding-top: 5pt;padding-left: 33pt;text-indent: 0pt;line-height: 191%;text-align: left;"><a name="bookmark998">Easy-to-deploy models in production with web-based GUI Powerful and easily scalable to millions of users</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_550.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_551.png"/></span></p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;line-height: 191%;text-align: left;">Provides deep insights into model usage Ability to version models</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark943">Cons of Using Cloud ML Engine</a><a name="bookmark999">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_552.png"/></span></p><p class="s17" style="padding-top: 5pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">High latency, offers only CPUs for inference (as of August 2019)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_553.png"/></span></p><p class="s17" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">Unsuitable for scenarios involving legal and data privacy issues where the data must not leave the network</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_554.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">Imposes restrictions on architecture design of complex applications</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark944">Building a Classification API</a><a name="bookmark1000">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1001">The following step-by-step guide shows how to go about uploading and hosting our a Dog/Cat classifier model on Google Cloud ML Engine:</a></p><ol id="l25"><li><p class="s17" style="padding-top: 4pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Create a model on the Google Cloud ML Engine dashboard at<a href="https://console.cloud.google.com/mlengine/models" class="s18" target="_blank"> </a><span class="s116">https://console.cloud.google.com/mlengine/models</span><a href="#bookmark1002" class="s30">. Because this is the first time we’re using the dashboard, we need to click ENABLE API, as depicted in </a><a href="#bookmark1002" class="s18">Figure </a><span style=" color: #8E0012;">9-3</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 53pt;text-indent: 0pt;text-align: left;"><span><img width="534" height="286" alt="image" src="KerasTensorFlow2019/Image_555.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 205pt;text-indent: -146pt;text-align: left;"><a name="bookmark1002">Figure 9-3. Listing page for machine learning models on the Google Cloud ML Engine dashboard</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s39" style="padding-top: 9pt;padding-left: 52pt;text-indent: -15pt;text-align: left;"><a href="#bookmark1003" class="s30">Give the model a name and a description (</a><a href="#bookmark1003" class="s18">Figure </a>9-4<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 53pt;text-indent: 0pt;text-align: left;"><span><img width="536" height="403" alt="image" src="KerasTensorFlow2019/Image_556.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 101pt;text-indent: 0pt;text-align: left;"><a name="bookmark1003">Figure 9-4. Model creation page on Google Cloud ML Engine</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s39" style="padding-top: 10pt;padding-left: 52pt;text-indent: -15pt;text-align: left;"><a href="#bookmark1004" class="s30">After the model is created, we can access the model on the listing page (</a><a href="#bookmark1004" class="s18">Figure </a>9-5<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 53pt;text-indent: 0pt;text-align: left;"><span><img width="529" height="260" alt="image" src="KerasTensorFlow2019/Image_557.jpg"/></span></p><p class="s19" style="padding-top: 7pt;padding-left: 103pt;text-indent: 0pt;text-align: left;"><a name="bookmark1004">Figure 9-5. Model listings page on Google Cloud ML Engine</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s39" style="padding-top: 10pt;padding-left: 52pt;text-indent: -15pt;text-align: left;"><a href="#bookmark1005" class="s30">Click the model to go to the model details page (</a>Figure 9-6<span style=" color: #000;">) and add a new version.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 53pt;text-indent: 0pt;text-align: left;"><span><img width="537" height="258" alt="image" src="KerasTensorFlow2019/Image_558.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 100pt;text-indent: 0pt;text-align: left;"><a name="bookmark1005">Figure 9-6. Details page of the just-created Dog/Cat classifier</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s39" style="padding-top: 10pt;padding-left: 52pt;text-indent: -15pt;text-align: left;"><a href="#bookmark1006" class="s30">Fill out the necessary information to create the new version. The last field at the bottom requires you to upload the model to Google Cloud Storage before we can use it. Click the Browse button to create a new bucket for storing the model (</a><a href="#bookmark1006" class="s18">Figure </a>9-7<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 53pt;text-indent: 0pt;text-align: left;"><span><img width="536" height="730" alt="image" src="KerasTensorFlow2019/Image_559.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 92pt;text-indent: 0pt;text-align: left;"><a name="bookmark1006">Figure 9-7. Creating a new version for a machine learning model</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-top: 10pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Create a new bucket with a unique name, a storage class, and region. After you create this bucket, go to<a href="https://console.cloud.google.com/storage/browser" class="s18" target="_blank"> </a><span class="s116">https://console.cloud.google.com/storage/browser </span><a href="#bookmark1007" class="s30">(in a separate tab while keeping the current one open) to find this newly created bucket and upload the model there (</a><a href="#bookmark1007" class="s18">Figure </a><span style=" color: #8E0012;">9-8</span>).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 53pt;text-indent: 0pt;text-align: left;"><span><img width="530" height="568" alt="image" src="KerasTensorFlow2019/Image_560.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 197pt;text-indent: -137pt;text-align: left;"><a name="bookmark1007">Figure 9-8. Creating a new Google Cloud Storage bucket within the ML model version creation page</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-top: 9pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Our Dog/Cat classifier model is an <i>.h5 </i>file. However, Google Cloud expects a SavedModel file. You can find the script to convert the</p><p class="s22" style="padding-left: 52pt;text-indent: 0pt;text-align: left;">.h5 <a href="http://practicaldeeplearning.ai/" class="s30" target="_blank">file to SavedModel on the book’s GitHub repository (see </a><span class="s39">http://PracticalDeepLearning.ai</span><span class="s17">) at </span>code/chapter- 9/scripts/h5_to_tf.ipynb<span class="s17">. Simply load the model and execute the rest of the notebook.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s39" style="padding-left: 52pt;text-indent: -15pt;text-align: left;"><a href="#bookmark1008" class="s30">In the Google Cloud Storage browser, upload the newly converted model (</a>Figure 9-9<span style=" color: #000;">) to the bucket you created in step 6.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 53pt;text-indent: 0pt;text-align: left;"><span><img width="540" height="306" alt="image" src="KerasTensorFlow2019/Image_561.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 159pt;text-indent: -105pt;text-align: left;"><a name="bookmark1008">Figure 9-9. Google Cloud Storage Browser page showing the uploaded Dog/Cat classifier model in TensorFlow format</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s39" style="padding-top: 9pt;padding-left: 52pt;text-indent: -15pt;text-align: left;"><a href="#bookmark1009" class="s30">Specify the URI on the model version creation page for the model that you just uploaded (</a><a href="#bookmark1009" class="s18">Figure </a>9-10<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 59pt;text-indent: 0pt;text-align: left;"><span><img width="505" height="82" alt="image" src="KerasTensorFlow2019/Image_562.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 57pt;text-indent: 0pt;text-align: left;"><a name="bookmark1009">Figure 9-10. Add the URI for the model you uploaded to Google Cloud Storage</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-top: 10pt;padding-left: 52pt;text-indent: -22pt;text-align: left;">Click the Save button and wait for the model version to be created. As soon as the model version is created, you can begin making predictions against it.</p></li><li><p class="s17" style="padding-top: 13pt;padding-left: 52pt;text-indent: -21pt;text-align: left;">If it’s not already present on your machine, you can download and install the Google Cloud SDK from the installation website at<a href="https://cloud.google.com/sdk/install" class="s18" target="_blank"> </a><span class="s116">https://cloud.google.com/sdk/install</span>.</p></li><li><p class="s17" style="padding-top: 13pt;padding-left: 52pt;text-indent: -22pt;text-align: left;">You can use the Cloud ML Engine REST API to make your requests. However, for brevity, use the command-line tools in the Cloud SDK. You first need to convert your image into a <i>request.json </i>file using the <i>image-to-json.py </i>script located at <i>code/chapter-9</i>:</p><p class="s75" style="padding-top: 4pt;padding-left: 66pt;text-indent: 0pt;text-align: left;">$ python image-to-json.py --input dog.jpg --output request.json</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 52pt;text-indent: -22pt;text-align: left;">Next, use the <i>request.json </i>file created in the previous step to execute a request against our model:</p></li></ol></li></ol></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 66pt;text-indent: 0pt;text-align: left;">$ time cloud ai-platform predict --model DogCat --version v1</p><p class="s75" style="padding-left: 141pt;text-indent: 0pt;text-align: center;">--json-instances</p><p class="s75" style="padding-left: 66pt;text-indent: 0pt;text-align: left;">request.json</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 66pt;text-indent: 0pt;text-align: left;">SCORES</p><p class="s75" style="padding-left: 66pt;text-indent: 0pt;text-align: left;">[O.14749771356, O.8525O22864]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 66pt;text-indent: 0pt;text-align: left;">real Om3.37Os</p><p class="s75" style="padding-left: 66pt;text-indent: 0pt;text-align: left;">user OmO.811s sys OmO.182s</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="536" height="228" alt="image" src="KerasTensorFlow2019/Image_563.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 113%;text-align: left;">If this is your first time using <span class="s134">gcloud</span>, you need to run the following command to tie the command-line tool to your Google account:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s113" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">$ gcloud auth login</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s26" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Next, select the project using the following command:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s113" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">$ gcloud config set project {project_name}</p><p style="text-indent: 0pt;text-align: left;"/><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">As you can see from the output, we get similar results as with our Flask server; that is, a prediction of “dog” with 85% confidence.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Piece of cake, wasn’t it? In our example, we used the Google Cloud SDK to request a prediction for the sake of brevity. In a production scenario, you would want to execute the same prediction request using Google’s API endpoints, instead; either by generating HTTP requests or by using their client libraries. We can follow the documentation on Google Cloud Docs for production scenarios.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">At this point, the model is ready to be served to any user anywhere in the world using applications on the browser, mobile and edge devices, desktop, as well as cloud environments. Using a hosted stack is a pretty viable option for individuals and organizations who want the flexibility and reliability that the cloud provides while having to do minimal setup and maintenance work for the infrastructure.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In contrast, there are situations for which a hosted solution might not be the best approach. Reasons could include pricing models, data privacy issues, legal questions, technical issues, trust concerns, or contractual</p><p style="text-indent: 0pt;text-align: left;"><span><img width="536" height="95" alt="image" src="KerasTensorFlow2019/Image_564.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">For processing a large number of images at one time, you can modify <i>image- to-json.py </i>to create a <i>request.json </i>file that contains an array of multiple inputs.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1010">obligations. In such cases, a solution that is hosted and managed locally (or, “on-premises”) would be preferable.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark945">TensorFlow Serving</a><a name="bookmark1011">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1012">TensorFlow Serving is an open source library in the TensorFlow ecosystem for serving machine learning models fast. Unlike Flask, it’s built for performance, with low overhead, and designed for use in production.</a></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">TensorFlow Serving is widely used by large companies to serve their models for prediction services. It is one of the integral components of TensorFlow Extended (TFX) — an end-to-end deep learning pipeline in the TensorFlow ecosystem.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">As we saw when we looked at the desired qualities of a production system, TensorFlow serving offers low latency, failure handling, high throughput, and model versioning. Another benefit includes the ability to serve multiple models at the same time on the same service. It implements several techniques to speed up serving:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_565.png"/></span></p><p class="s17" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">During server startup, it starts a burst of threads for fast model loading.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_566.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">It uses separate thread pools for loading models and for serving inferences while giving higher priority to the threads in the inference pool. This is crucial to lowering request latency.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="536" height="131" alt="image" src="KerasTensorFlow2019/Image_567.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">TensorFlow serving gives you full control over the model rollout procedure. You can serve different models or different versions of the same kind of model in the same process. You just need to make sure that you know the name and  location of the version that you want to remove or put into production.</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_568.png"/></span></p><p class="s17" style="padding-top: 13pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">It builds minibatches of incoming asynchronous requests for short periods of time. As we have seen, with the power of batching data on GPUs during training, it aims to bring similar efficiencies on asynchronous requests. As an example, waiting 500 ms to group together several requests for inference. While at worst case, this adds a 500 ms penalty for the first request in the batch, it reduces the average latency across requests and maximizes hardware utilization.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark946">Installation</a><a name="bookmark1013">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_569.png"/></span></p><p class="s17" style="padding-top: 6pt;padding-left: 33pt;text-indent: -26pt;line-height: 142%;text-align: left;">There are a few different ways of setting up TensorFlow Serving: Building from source</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_570.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_571.png"/></span></p><p class="s17" style="padding-top: 7pt;padding-left: 33pt;text-indent: 0pt;line-height: 191%;text-align: left;">Downloading and installing using APT Deploying Docker images</p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">If you’re feeling adventurous, building from source might be the danger you seek. But if you just want to get up and running quickly, we recommend using Docker because it requires minimal steps to get the system up and running. What is Docker, you might ask? Docker provides virtualization of a Linux environment for applications that run within it. It provides isolation of resources that essentially operate as a clean slate for setting up an environment in which an application can run. Typically, an application and all of its dependencies are packaged into a single Docker container that can then be deployed repeatedly as necessary. Because the application is set up in a clean environment, it reduces the likelihood of configuration and deployment errors. This makes Docker very well suited for running applications in production.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The biggest benefit that Docker provides for us is alleviating “dependency hell” because all the necessary dependencies are packaged within the container. One additional advantage of using Docker is that the process of setting up your application remains more or less the same across different platforms, whether you use Windows, Linux, or Mac.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The Docker installation instructions, depending on the target platform, are available on the Docker home page. This should not take more than a few minutes because the setup is fairly straightforward. After you’ve installed Docker, you can run the following command to set up TensorFlow Serving for CPU:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">$ docker run -p 85O1:85O1 \</p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">--mount type=bind,source=/path/to/dogcat/,target=/models/dogcat \</p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">-e MODEL_NAME=dogcat -t tensorflow/serving</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">For GPU-enabled machines, run the following command, instead:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">$ docker run -p 85O1:85O1 --runtime=nvidia \</p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">--mount type=bind,source=/path/to/dogcat/,target=/models/dogcat \</p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">-e MODEL_NAME=dogcat -t tensorflow/serving</p><p style="text-indent: 0pt;text-align: left;"><span><img width="536" height="237" alt="image" src="KerasTensorFlow2019/Image_572.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">In any inference request, the end-to-end latency is a summation of time taken by multiple steps along the process. This includes round-trip network time, request time to serialize/deserialize the request and response objects, and, of course, time to perform the actual inference. One more component that adds overhead is the serving framework; that is, TensorFlow Serving. Google claims that the overhead contributed by TensorFlow Serving is minimal. In its experiments, it observed that TensorFlow Serving alone was able to handle approximately 100,000 QPS per core on a 16 vCPU Intel Xeon E5 2.6 GHz machine. Because it is measuring the overhead, this excludes the remote procedure call (RPC) time and the TensorFlow inference processing time.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In either case, if everything went smoothly, you should have a REST API running on your local port 8501 serving our Dog/Cat classifier.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Even though TensorFlow Serving is a great choice for serving inferences from a single machine, it does not have built-in functionality for horizontal scaling. Instead, it is built to be used in conjunction with other systems that can supercharge TensorFlow Serving with dynamic scaling. We explore one such solution in the following section.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark947">KubeFlow</a><a name="bookmark1014">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1015">Throughout this book, we have explored the various steps of an end-to- end deep learning pipeline, from data ingestion, analysis, distributed training (including hyperparameter tuning) at scale, tracking experiments, deployment, and eventually to serving prediction requests at scale. Each of these steps is complex in its own right, with its set of tools, ecosystems, and areas of expertise. People dedicate their lifetimes developing expertise in just one of these fields. It’s not exactly a walk in the park. The combinatorial explosion of the know-how required when factoring for the necessary backend engineering, hardware engineering, infrastructure engineering, dependency management, DevOps, fault tolerance, and other engineering challenges can result in a very expensive hiring process for most organizations.</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">As we saw in the previous section, Docker saves us the hassle of dependency management by making portable containers available. It helps us make TensorFlow Serving available across platforms easily without having to build it from source code or install dependencies manually.</p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Great! But it still doesn’t have an answer to many of the other challenges. How are we going to scale up containers to match rises in demand? How would we efficiently distribute traffic across containers? How do we ensure that the containers are visible to one another and can communicate?</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1016">These are questions answered by </a><i>Kubernetes</i>. Kubernetes is an orchestration framework for automatically deploying, scaling, and managing containers (like Docker). Because it takes advantage of the portability offered by Docker, we can use Kubernetes to deploy to developer laptops as well as thousand-machine clusters in an almost identical manner. This helps maintain consistency across different environments, with the added benefit of scalability in an accessible manner. It is worth noting that Kubernetes is not a dedicated solution for machine learning (neither is Docker); rather, it is a general-purpose solution to many of the problems faced in software development, which we use in the context of deep learning.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">But let’s not get ahead of ourselves just yet. After all, if Kubernetes were the be-all and end-all solution, it would have appeared in the chapter title! A machine learning practitioner using Kubernetes still needs to assemble all of the appropriate sets of containers (for training, deployment, monitoring, API management, etc.) that then need to be orchestrated together to make a fully functioning end-to-end pipeline. Unfortunately,</p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">many data scientists are trying to do exactly this in their own silos, reinventing the wheel building ad hoc machine learning-specific pipelines. Couldn’t we save everyone the trouble and make one Kubernetes-based solution for machine learning scenarios?</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Enter <i>KubeFlow</i>, which promises to automate a large chunk of these engineering challenges and hide the complexity of running a distributed, scalable, end-to-end deep learning system behind a web GUI-based tool and a powerful command-line tool. This is more than just an inference service. Think of it as a large ecosystem of tools that can interoperate seamlessly and, more importantly, scale up with demand. KubeFlow is built for the cloud. Though not just one cloud — it’s built to be compatible with all major cloud providers. This has significant implications on cost.</p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Because we are not tied to a specific cloud provider, we have the freedom to move all of our operations at a moment’s notice if a competing cloud provider drops its prices. After all, competition benefits consumers.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">KubeFlow supports a variety of hardware infrastructure, from developer laptops and on-premises datacenters, all the way to public cloud services. And because it’s built on top of Docker and Kubernetes, we can rest assured that the environments will be identical whether deployed on a developer laptop or a large cluster in a datacenter. Every single way in which the developer setup is different from the production environment could result in an outage, so it’s really valuable to have this consistency across environments.</p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1018" class="s18" name="bookmark1017">Table 9-4</a> <span style=" color: #000;">shows a brief list of readily available tools within the KubeFlow ecosystem.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s22" style="padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1018">Table 9-4. Tools available on KubeFlow</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_573.png"/></span></p><p class="s33" style="padding-top: 1pt;padding-bottom: 3pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Tool Functionality</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_574.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="27" alt="image" src="KerasTensorFlow2019/Image_575.png"/></span></p><p class="s26" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">TFJob Training TensorFlow models</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-top: 1pt;padding-bottom: 3pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Jupyter Hub Notebook environment</p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="27" alt="image" src="KerasTensorFlow2019/Image_576.png"/></span></p><p class="s26" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Seldon Serving models</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-top: 2pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">TensorFlow Serving</p><p class="s26" style="padding-top: 2pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Serving TensorFlow models</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s26" style="padding-top: 2pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">NVIDIA</p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="27" alt="image" src="KerasTensorFlow2019/Image_577.png"/></span></p><p class="s26" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Intel OpenVINO Serving models</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-left: 9pt;text-indent: 0pt;text-align: left;">TensorRT</p><p class="s26" style="padding-top: 2pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Serving models</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="27" alt="image" src="KerasTensorFlow2019/Image_578.png"/></span></p><p class="s26" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Katib Hyperparameter tuning and NAS</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-top: 2pt;padding-bottom: 3pt;padding-left: 96pt;text-indent: -86pt;text-align: left;">KFServing Abstraction for serving Tensorflow, XGBoost, scikit-learn, PyTorch, and ONNX models</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_579.png"/></span></p><p class="s33" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Tool Functionality</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_580.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="27" alt="image" src="KerasTensorFlow2019/Image_581.png"/></span></p><p class="s26" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">PyTorch Training PyTorch models</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-top: 1pt;padding-bottom: 3pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Kubebench Running benchmarking jobs</p><p style="text-indent: 0pt;text-align: left;"><span><img width="589" height="27" alt="image" src="KerasTensorFlow2019/Image_582.png"/></span></p><p class="s26" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Locust Load testing</p><p style="text-indent: 0pt;text-align: left;"/><p class="s26" style="padding-top: 2pt;padding-bottom: 3pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Istio API services, authentication, A/B testing, rollouts, metrics</p><p class="s26" style="padding-top: 2pt;padding-bottom: 3pt;padding-left: 96pt;text-indent: -86pt;text-align: left;">Pipelines Managing experiments, jobs, and runs, scheduling machine learning workflows</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_583.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="536" height="95" alt="image" src="KerasTensorFlow2019/Image_584.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Many people assume that KubeFlow is a combination of Kubernetes and TensorFlow, which, as you have seen, is not the case. It is that and much more.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">As the joke goes in the community, with so many technologies prepackaged, KubeFlow finally makes our résumés buzzword- (and recruiter-) compliant.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">There are two important parts to KubeFlow that make it unique: pipelines and fairing.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark948">Pipelines</a><a name="bookmark1019">&zwnj;</a></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1021" class="s30" name="bookmark1020">Pipelines give us the ability to compose steps across the machine learning to schedule complex workflows. </a><a href="#bookmark1021" class="s18">Figure </a>9-11 <span style=" color: #000;">shows us an example of a pipeline. Having visibility into the pipeline through a GUI tool helps stakeholders understand it (beyond just the engineers who built it).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="531" height="370" alt="image" src="KerasTensorFlow2019/Image_585.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1021">Figure 9-11. An end-to-end pipeline illustrated in KubeFlow</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark949">Fairing</a><a name="bookmark1022">&zwnj;</a></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1024" class="s30" name="bookmark1023">Fairing allows us to manage the entire build, train, and deploy lifecycle directly through Jupyter Notebooks. </a>Figure 9-12 <span style=" color: #000;">shows how to start a new notebook server, where we can host all of our Jupyter Notebooks, run training on them, and deploy our models to Google Cloud using the following few lines of code, all the while being in the comfort of a very familiar Jupyter environment:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">from fairing.deployers.gcp.gcpserving import GCPServingDeployer GCPServingDeployer().deploy(model_dir, model_name, version_name)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="533" height="480" alt="image" src="KerasTensorFlow2019/Image_586.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1024">Figure 9-12. Creating a new Jupyter Notebook server on KubeFlow</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark950">Installation</a><a name="bookmark1025">&zwnj;</a></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1027" class="s30" name="bookmark1026">Creating a new KubeFlow deployment is a fairly straightforward process that is well documented on the KubeFlow website. You can set up KubeFlow using the browser for GCP. Alternatively, you can use the KubeFlow command-line tool to set up a deployment on GCP, AWS, and Microsoft Azure. </a>Figure 9-13 <span style=" color: #000;">shows a GCP deployment using the web browser.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 54pt;text-indent: 0pt;text-align: left;"><span><img width="462" height="663" alt="image" src="KerasTensorFlow2019/Image_587.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 10pt;padding-left: 47pt;text-indent: 0pt;text-align: left;"><a name="bookmark1027">Figure 9-13. Creating a KubeFlow deployment on GCP using the browser</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1028">As of this writing, KubeFlow is in active development and shows no signs of stopping. Companies such as Red Hat, Cisco, Dell, Uber, and Alibaba are some of the active contributors on top of cloud giants like Microsoft, Google, and IBM. Ease and accessibility for solving tough challenges attract more people to any platform, and KubeFlow is doing exactly that.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark951">Price Versus Performance Considerations</a><a name="bookmark1029">&zwnj;</a></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark599" class="s30" name="bookmark1030">In </a>Chapter 6<span style=" color: #000;">, we looked at how to improve our model performance for inference (whether on smartphones or on a server). Now let’s look from another side: the hardware performance and the price involved.</span></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1031">Often while building a production system, we want the flexibility of choosing suitable hardware to strike the proper balance between performance, scale, and price for our scenario. Consider building an app that requires cloud-based inference. We can go set up our own stack manually (using Flask or TensorFlow Serving or KubeFlow), or we could use a managed Inference-as-a-Service stack (like the Google Cloud ML Engine). Assuming that our service went viral, let’s see how much it would cost.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark952">Cost Analysis of Inference-as-a-Service</a><a name="bookmark1032">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">For Google Cloud ML Engine, as of August 2019 in North America, it costs a rather inexpensive $0.0401 per hour of combined inference time on a single-core CPU machine. There’s also an option for a quad-core CPU machine, but really, a single core should suffice for most applications.</p><p class="s39" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1033" class="s30">Running several queries to the server with a small image of 12 KB took roughly 3.5 seconds on average, as illustrated in </a>Figure 9-14<span style=" color: #000;">. This does sound slow, and is partly because of doing inference on a moderate-speed machine, and, more important on a CPU server. It’s worth mentioning that this benchmark is on a warmed-up machine that has recently received an API request and hence has the model preloaded. For comparison, the first query takes between 30 and 60 seconds. This shows the importance of keeping the service running constantly or sending frequent warm-up queries. This happens because the Google Cloud ML engine takes down a model if it notices a prolonged period of nonuse.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 53pt;text-indent: 0pt;text-align: left;"><span><img width="461" height="799" alt="image" src="KerasTensorFlow2019/Image_588.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 60pt;text-indent: -47pt;text-align: left;"><a name="bookmark1033">Figure 9-14. Google Cloud ML Engine showing incoming queries and latency of serving the calls, with end-to-end latency at user’s end of about 3.5 seconds</a></p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">If a request came in at every second for an entire month, there would be a total of 60 x 60 x 24 x 30 = 2,592,000 calls per month. Assuming that each inference takes 3.5 seconds, a single node would be insufficient. The cloud service would quickly realize that and, in response to the increased traffic, bring up three additional machines to handle the traffic. In total, with four machines running for a month at $0.0401 per hour per node, it would cost a grand total of $115.48. To put this into perspective, for two million calls, that’s about the cost of a cup of Starbucks coffee a day for an entire month. And let’s not forget this is without involving much of the DevOps team members, whose time is expensive. If we took the hypothetical scenario of a Yelp-like service for which users, on average, upload photos of food at 64 QPS, running inferences on them using a classification model would cost only $7,390.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark953">Cost Analysis of Building Your Own Stack</a><a name="bookmark1034">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Less spending and high scalability, now that’s a winning combination. But the one downside is the total roundtrip latency of each request. Taking matters into our own hands, getting a VM with a modest GPU on the cloud, and setting up our scaling pipeline (using KubeFlow or the native cloud load-balancing features with TensorFlow Serving), we would be able to respond either in milliseconds or batch a few incoming queries together (say every 500 ms) to serve them. As an example, looking at the inventory of VMs on Azure, for $2.07 per hour, we can rent out an ND6 machine that features an NVIDIA P40 GPU and 112 GiB RAM. By batching incoming requests every 500 ms to 1 second, this machine can serve 64 requests per second at a total cost of $1,490 per month, and faster than the Google Cloud ML Engine.</p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1035" class="s30">In summary, the cost savings and performance benefits of orchestrating our own cloud machine environment kicks in big time when working on large QPS scenarios, as demonstrated in </a>Figure 9-15<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 40pt;text-indent: 0pt;text-align: left;"><span><img width="514" height="298" alt="image" src="KerasTensorFlow2019/Image_589.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 8pt;text-indent: 0pt;text-align: center;"><a name="bookmark1035">Figure 9-15. Cost comparison of infrastructure as a service (Google Cloud ML Engine) versus building your own stack over virtual machines (Azure VM) (costs as of August 2019)</a></p><p class="s25" style="padding-top: 9pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s68" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a href="https://jmeter.apache.org/" style=" color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 11pt;" target="_blank" name="bookmark1036">A common question that arises while benchmarking is what is my system’s limit? </a>JMeter <span style=" color: #000;">can help answer this. JMeter is a load-testing tool that lets you perform stress testing of your system with an easy-to-use graphical interface. It lets you create reusable configurations to simulate a variety of usage scenarios.</span></p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="536" height="148" alt="image" src="KerasTensorFlow2019/Image_590.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark954">Summary</a><a name="bookmark1037">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In this chapter, we answered the question most engineers and developers ask: how do we serve model prediction requests at scale for applications in the real world? We explored four different methods of serving an image recognition model: using Flask, Google Cloud ML, TensorFlow Serving, and KubeFlow. Depending on the scale, latency requirements, and our skill level, some solutions might be more attractive than others. Finally, we developed an intuition into the cost effectiveness of different stacks. Now that we can show our fabulous classifier model off to the world, all that’s left is to make our work go viral!</p><h2 style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1038">Chapter 10. AI in the Browser with TensorFlow.js and ml5.js</a><a name="bookmark1065">&zwnj;</a></h2><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="581" height="1" alt="image" src="KerasTensorFlow2019/Image_591.png"/></span></p><p class="s135" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Written in collaboration with guest author: Zaid Alyafeai</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1066">You’re a developer who dreams big. You have a kickass AI model that you would like a lot of people to try. How many is a lot? Ten thousand? A million? No, silly. You like to dream big. How about 100 million people? That’s a nice round number. Now convincing 100 million people to download and install an app and make space for it on their phones is not an easy sell. But what if we told you that they all have an app already installed, just for you. No downloads. No installs. No app stores. What kind of black magic is this!? Of course, it’s the web browser. And as a bonus, it also runs on your PC.</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1067" class="s63">This is what Google did with its home page when it decided to launch its first-ever AI doodle to their billions of users (</a>Figure 10-1<span style=" color: #000;">). And what better theme to pick for it than the music of J.S. Bach. (Bach’s parents wanted to call him J.S. Bach, 310 years before JavaScript was even created. They had quite the foresight!)</span></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">To explain briefly, the doodle allowed anyone to write one line (voice) of random notes for two measures using mouse clicks. When the user clicked a button labeled Harmonize, the input would then be processed against hundreds of musical pieces written by Bach that contain between two and four lines (voices) of music.</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The system would figure out which notes would sound best along with the user’s input to create a much richer Bach-like sounding musical piece. The entire process ran in the browser, so Google would not need to scale up its machine learning prediction infrastructure at all.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="332" alt="image" src="KerasTensorFlow2019/Image_592.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s198" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a href="https://oreil.ly/BYFfg" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12pt;" target="_blank" name="bookmark1067">Figure 10-1. The Bach music harmonizer </a>doodle <span style=" color: #000;">from Google</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In addition to the cost savings and the ability to run on any platform, with a browser we can provide users with a richer, more interactive experience because network latency is not a factor. And of course, because everything can be run locally after the model is downloaded, the end user can benefit from the privacy of their data.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Given that JavaScript is the language of the web browser, it’s useful for us to delve into JavaScript-based deep learning libraries that can run our trained model within users’ browsers. And that’s exactly what we do in this chapter.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Here, we focus on implementing deep learning models in the browser. First, we look at a brief history of different JavaScript- based deep learning frameworks before moving on to TensorFlow.js and eventually a higher-level abstraction for it called ml5.js. We also examine a few complex browser-based applications such as detecting the body pose of a person or converting a hand-drawn doodle to a photograph (using GANs).</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Finally, we talk about some practical considerations and showcase some real-world case studies.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1039">JavaScript-Based Machine Learning Libraries: A Brief History</a><a name="bookmark1068">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1070" class="s63" name="bookmark1069">Since the breakthrough of deep learning in recent years, many attempts have been made to make AI accessible to a wider range of people in the form of web-based libraries. </a><a href="#bookmark1070" class="s44">Table </a>10-1 <span style=" color: #000;">offers a brief overview of the different libraries in the order in which they were first released.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s43" style="padding-left: 58pt;text-indent: -47pt;text-align: left;"><a name="bookmark1070">Table 10-1. Historical overview of different JavaScript-based deep learning libraries (data captured as of August 2019)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:7.19243pt" cellspacing="0"><tr style="height:38pt"><td style="width:153pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:70pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 5pt;padding-left: 22pt;text-indent: 0pt;line-height: 108%;text-align: left;">Active years</p></td><td style="width:53pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s136" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 94%;text-align: left;">★ <span class="s65">on GitHub</span></p></td><td style="width:165pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Known for</p></td></tr><tr style="height:36pt"><td style="width:153pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">brain.js</p></td><td style="width:70pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">2015–</p><p class="s66" style="padding-top: 1pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">present</p></td><td style="width:53pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">9,856</p></td><td style="width:165pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 5pt;padding-right: 22pt;text-indent: 0pt;line-height: 108%;text-align: left;">Neural networks, RNNs, LSTMs, and GRUs</p></td></tr><tr style="height:36pt"><td style="width:153pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">ConvNetJS</p></td><td style="width:70pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">2014–</p><p class="s66" style="padding-top: 1pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">2016</p></td><td style="width:53pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">9,735</p></td><td style="width:165pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Neural networks, CNNs</p></td></tr><tr style="height:36pt"><td style="width:153pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Synaptic</p></td><td style="width:70pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">2014–</p><p class="s66" style="padding-top: 1pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">present</p></td><td style="width:53pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">6,571</p></td><td style="width:165pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Neural networks, LSTMs</p></td></tr><tr style="height:36pt"><td style="width:153pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">MXNetJS</p></td><td style="width:70pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">2015–</p><p class="s66" style="padding-top: 1pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">2017</p></td><td style="width:53pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">420</p></td><td style="width:165pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Running MXNet models</p></td></tr><tr style="height:36pt"><td style="width:153pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Keras.js</p></td><td style="width:70pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">2016–</p><p class="s66" style="padding-top: 1pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">2017</p></td><td style="width:53pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">4,562</p></td><td style="width:165pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Running Keras models</p></td></tr><tr style="height:36pt"><td style="width:153pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">CaffeJS</p></td><td style="width:70pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">2016–</p><p class="s66" style="padding-top: 1pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">2017</p></td><td style="width:53pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">115</p></td><td style="width:165pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Running Caffe models</p></td></tr><tr style="height:36pt"><td style="width:153pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 108%;text-align: left;">TensorFlow.js (formerly known as deeplearn.js)</p></td><td style="width:70pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">2017–</p><p class="s66" style="padding-top: 1pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">present</p></td><td style="width:53pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">11,282</p></td><td style="width:165pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 5pt;padding-right: 41pt;text-indent: 0pt;line-height: 108%;text-align: left;">Running TensorFlow models on GPU</p></td></tr><tr style="height:36pt"><td style="width:153pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">ml5.js</p></td><td style="width:70pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">2017–</p><p class="s66" style="padding-top: 1pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">present</p></td><td style="width:53pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">2,818</p></td><td style="width:165pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Easy to use on top of TF.js.</p></td></tr><tr style="height:36pt"><td style="width:153pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">ONNX.js</p></td><td style="width:70pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">2018–</p><p class="s66" style="padding-top: 1pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">present</p></td><td style="width:53pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">853</p></td><td style="width:165pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 5pt;padding-right: 32pt;text-indent: 0pt;line-height: 108%;text-align: left;">Speed, running ONNX models</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Let’s go through a few of these libraries in more detail and see how they evolved.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1040">ConvNetJS</a><a name="bookmark1071">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="146" alt="image" src="KerasTensorFlow2019/Image_593.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s79" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark1073" class="s140">In fact, when MIT scientist Lex Fridman taught his popular self-driving course in 2017, he challenged students worldwide to train a simulated autonomous car using reinforcement learning — in the browser using ConvNetJS — as shown in </a><a href="#bookmark1073" class="s64">Figure </a>10-2<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://oreil.ly/URdv9" class="s44" target="_blank" name="bookmark1072">ConvNetJS</a> <span style=" color: #000;">is a JavaScript library that was designed in 2014 by Andrej Karpathy as part of a course during his Ph.D. at Stanford University. It trained CNNs in the browser, an exciting proposition, especially in 2014, considering the AI hype was starting to take off, and a developer wouldn’t have had to go through an elaborate and painful setup process to get running. ConvNetJS helped introduce AI to so many people for the first time with interactive training demonstrations in the browser.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 17pt;text-indent: 0pt;text-align: left;"><span><img width="574" height="503" alt="image" src="KerasTensorFlow2019/Image_594.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 179pt;text-indent: -171pt;line-height: 108%;text-align: left;"><a name="bookmark1073">Figure 10-2. Screenshot of DeepTraffic training a car with reinforcement learning using ConvNetJS</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1041">Keras.js</a><a name="bookmark1074">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1075">Keras.js was introduced in 2016 by Leon Chen. It was a Keras port made to work in the browser by using JavaScript. Keras.js used WebGL to run computations on the GPU. It used shaders (special operations for pixel rendering) to run inferences, which made them run much faster than using just the CPU. Additionally, Keras.js could run on a Node.js server on a CPU to provide server-based inferences. Keras.js implemented a handful of convolutional, dense, pooling, activation, and RNN layers. It is no longer under active development.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1042">ONNX.js</a><a name="bookmark1076">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1078" class="s63" name="bookmark1077">Created by Microsoft in 2018, ONNX.js is a JavaScript library for running ONNX models in browsers and on Node.js. ONNX is an open standard for representing machine learning models that is a collaboration between Microsoft, Facebook, Amazon, and others. ONNX.js is surprisingly fast. In fact, faster than even TensorFlow.js (discussed in the next section) in early benchmarks, as shown in </a>Figure 10-3 <a href="#bookmark1079" class="s63">and </a>Figure 10-4<span style=" color: #000;">. This could be attributed to the following reasons:</span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_595.png"/></span></p><p style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">ONNX.js utilizes WebAssembly (from Mozilla) for execution on the CPU and WebGL on the GPU.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_596.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">WebAssembly allows it to run C/C++ and Rust programs in the web browser while providing near-native performance.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_597.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">WebGL provides GPU-accelerated computations like image processing within the browser.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_598.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Although browsers tend to be single-threaded, ONNX.js uses Web Workers to provide a multithreaded environment in the background for parallelizing data operations.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 30pt;text-indent: 0pt;text-align: left;"><span><img width="568" height="328" alt="image" src="KerasTensorFlow2019/Image_599.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s198" style="padding-top: 4pt;padding-left: 120pt;text-indent: -109pt;line-height: 108%;text-align: left;"><a href="https://github.com/microsoft/onnxjs" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12pt;" target="_blank" name="bookmark1078">Figure 10-3. Benchmarking data for ResNet-50 on different JavaScript machine learning libraries on CPU (</a><a href="https://github.com/microsoft/onnxjs" class="s52" target="_blank">data </a>source<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 30pt;text-indent: 0pt;text-align: left;"><span><img width="568" height="328" alt="image" src="KerasTensorFlow2019/Image_600.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s198" style="padding-top: 10pt;padding-left: 120pt;text-indent: -109pt;line-height: 108%;text-align: left;"><a href="https://github.com/microsoft/onnxjs" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12pt;" target="_blank" name="bookmark1079">Figure 10-4. Benchmarking data for ResNet-50 on different JavaScript machine learning libraries on GPU (</a><a href="https://github.com/microsoft/onnxjs" class="s52" target="_blank">data </a>source<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1043">TensorFlow.js</a><a name="bookmark1080">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="368" alt="image" src="KerasTensorFlow2019/Image_601.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s48" style="padding-left: 115pt;text-indent: 0pt;text-align: center;">FROM THE CREATOR’S DESK</p><p class="s49" style="padding-top: 7pt;padding-left: 11pt;text-indent: 0pt;line-height: 108%;text-align: left;">By Shanqing Cai, senior software engineer at Google and author of <i>Deep Learning with JavaScript </i>(Manning)</p><p class="s198" style="padding-top: 5pt;padding-left: 11pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="https://playground.tensorflow.org/" class="s140" target="_blank" name="bookmark1083">The forebearer of TensorFlow.js, deeplearn.js, originated from an effort at Google to create an intuitive and interactive visualization to teach people how neural networks are trained. This visualization, today known as “TensorFlow Playground” and available at </a>https://playground.tensorflow.org<span class="s49">, used an early version of deeplearn.js to train a multilayered neural network entirely in the browser. In building TensorFlow Playground, the engineers became impressed by the potential of using WebGL to perform accelerated training and inference of deep learning models in the browser and at the client side. A team of engineers was assembled at Google to realize this vision, which gave birth to today’s TensorFlow.js, a full-blown deep learning library that supports hundreds of operations and dozens of neural network layers and runs on environments ranging from the browser to Node.js, from native-mobile apps to cross-platform desktop apps.</span></p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1081">Some libraries offered the ability to train within the browser (e.g., ConvNetJS), whereas other libraries offered blazing-fast performance (e.g., the now-defunct TensorFire). deeplearn.js from Google was the first library that supported fast GPU accelerated operations using WebGL while also providing the ability to define, train, and infer within the browser. It offered both an immediate execution model (for inference) as well as a delayed execution model for training (like in TensorFlow 1.x). Originally released in 2017, this project became the core of TensorFlow.js (released in 2018). It is considered an integral part of the TensorFlow ecosystem, and as a result, it is currently the most actively developed JavaScript deep learning library. Considering this fact, we focus on TensorFlow.js in this chapter. To make TensorFlow.js even simpler to use, we also look at ml5.js, which is built on top of TensorFlow.js and abstracts away its complexities, exposing a simple API with ready-to-use models from GANs to PoseNet.</a><a name="bookmark1082">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s48" style="padding-left: 115pt;text-indent: 0pt;text-align: center;">FROM THE CREATOR’S DESK</p><p class="s49" style="padding-top: 7pt;padding-left: 11pt;text-indent: 0pt;line-height: 108%;text-align: left;">By Daniel Smilkov, software engineer at Google Brain and coauthor of TensorFlow.js</p><p class="s49" style="padding-top: 5pt;padding-left: 11pt;text-indent: 0pt;line-height: 108%;text-align: left;">Before TensorFlow.js, Nikhil [Thorat] and I were building neural network interpretability tools in the browser. To enable a truly interactive experience, we wanted to run inference and compute gradients directly in the browser without sending data to a server. This led to deeplearn.js (you can still see the package with its API on npm), which we released in August 2017. The project got great momentum with creative coders being one of the earliest adopters. Riding on this momentum, the team grew quickly, and six months later we launched TensorFlow.js.</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="269" alt="image" src="KerasTensorFlow2019/Image_602.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1044">TensorFlow.js Architecture</a><a name="bookmark1084">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1086" class="s63" name="bookmark1085">First, let’s take a look at the high-level architecture of TensorFlow.js (see </a>Figure 10-5<span style=" color: #000;">). TensorFlow.js runs directly in the browser on desktop and mobile. It utilizes WebGL for GPU acceleration, but also can fall back to the browser’s runtime for execution on the CPU.</span></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">It consists of two APIs: the Operations API and the Layers API. The Operations API provides access to lower-level operations such as tensor arithmetic and other mathematical operations. The Layers API builds on top of the Operations API to provide layers such as convolution, ReLU, and so on.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 17pt;text-indent: 0pt;text-align: left;"><span><img width="560" height="480" alt="image" src="KerasTensorFlow2019/Image_603.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 16pt;text-indent: 0pt;text-align: left;"><a name="bookmark1086">Figure 10-5. A high-level overview of the TensorFlow.js and ml5.js ecosystem</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Beyond the browser, TensorFlow.js can also run on a Node.js server. Additionally, ml5.js uses TensorFlow.js to provide an even higher-level API along with several prebuilt models. Having access to all of these APIs at different levels of abstraction allows us to build web apps, not only to do simple inference, but also to train models within the browser itself.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Following are some common questions that come up during the development life cycle for browser-based AI:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_604.png"/></span></p><p style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">How do I run pretrained models in the browser? Can I use my webcam feed for real-time interactivity?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_605.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">How can I create models for the browser from my TensorFlow trained models?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_606.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Can I even train a model in the browser?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_607.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">How do different hardware and browsers affect performance?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We answer each of these questions in this chapter, starting with TensorFlow.js before moving on to ml5.js. We explore some rich built-in functionality contributed by the ml5.js community, which would otherwise take a lot of effort and expertise to implement directly on TensorFlow.js. We also look at approaches to benchmarking before looking at some motivating examples built by creative developers.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Now let’s take a look at how to take advantage of pretrained models to make inferences within the browser.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1045">Running Pretrained Models Using TensorFlow.js</a><a name="bookmark1087">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s63" target="_blank" name="bookmark1088">TensorFlow.js offers lots of pretrained models that we can directly run in the browser. Some examples include MobileNet, SSD, and PoseNet. In the following example, we load a pretrained MobileNet model. The full code is located on the book’s GitHub repository (see </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">http://PracticalDeepLearning.ai</span>) at <i>code/chapter- 10/mobilenet-example/</i>.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">First, we import the latest bundle of the library:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s137" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&lt;script <a href="https://cdn.jsdelivr.net/npm/%40tensorflow/" style=" color: #309; font-family:&quot;Courier New&quot;, monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9.5pt;" target="_blank">src=</a><span class="s57">&quot;https://cdn.jsdelivr.net/npm/@tensorflow/ tfjs@latest/dist/tf.min.js&quot;</span>&gt;&lt;/script&gt;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">We then import the MobileNet model:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s137" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&lt;script <span class="s138">src=</span><span class="s57">&quot;https://cdn.jsdelivr.net/npm/ @tensorflow-models/mobilenet@1.O.O&quot;</span>&gt;&lt;/script&gt;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Now we can make predictions using the following code:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s138" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><b>&lt;img </b>id=<span style=" color: #C30;">&quot;image&quot; </span>src=<span style=" color: #C30;">&quot;cat.jpg&quot; </span><b>/&gt;</b></p><p class="s137" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&lt;p <span class="s138">id=</span><span class="s57">&quot;prediction_output&quot;</span>&gt;<span class="s53">Loading predictions...</span>&lt;/p&gt;</p><p class="s137" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&lt;script&gt;</p><p class="s53" style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span class="s54">const </span><span style=" color: #000087;">image </span>= <span style=" color: #366;">document</span>.<span style=" color: #000087;">getElementById</span>(<span style=" color: #C30;">&quot;image&quot;</span>);</p><p class="s53" style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span class="s54">const </span><span style=" color: #000087;">predictionOutput </span>= <span style=" color: #366;">document</span>.<span style=" color: #000087;">getElementById</span>(<span style=" color: #C30;">&quot;prediction_output&quot;</span>);</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">// Load the model.</p><p class="s56" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">mobilenet<span style=" color: #000;">.</span>load<span style=" color: #000;">().</span>then<span style=" color: #000;">(</span>model <span style=" color: #000;">=&gt; {</span></p><p class="s60" style="padding-left: 39pt;text-indent: 0pt;text-align: left;">// Classify the image. And output the predictions</p><p class="s53" style="padding-left: 51pt;text-indent: -11pt;text-align: left;"><span style=" color: #000087;">model</span>.<span style=" color: #000087;">classify</span>(<span style=" color: #000087;">image</span>).<span style=" color: #000087;">then</span>(<span style=" color: #000087;">predictions </span>=&gt; { <span style=" color: #000087;">predictionOutput</span>.<span style=" color: #000087;">innerText </span>= <span style=" color: #000087;">predictions</span>[<span style=" color: #F60;">O</span>].<span style=" color: #000087;">className</span>;</p><p class="s53" style="padding-left: 39pt;text-indent: 0pt;text-align: left;">});</p><p class="s53" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">});</p><p class="s137" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&lt;/script&gt;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Figure 10-6 <span style=" color: #000;">shows a sample output.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="599" height="614" alt="image" src="KerasTensorFlow2019/Image_608.jpg"/></span></p><p class="s50" style="padding-top: 5pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1089">Figure 10-6. Class prediction output in the browser</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We can alternatively load a model using a JSON file URL in the following manner:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">const </span><span style=" color: #000087;">path </span>= <span style=" color: #C30;">&#39;https://storage.googleapis.com/tfjs- models/tfjs/mobilenet_v1_1.O_224/model.json&#39;</span>;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">model <span style=" color: #000;">= </span>tf<span style=" color: #000;">.</span>loadLayersModel<span style=" color: #000;">(</span>path<span style=" color: #000;">).</span>then<span style=" color: #000;">(</span>model <span style=" color: #000;">=&gt; {</span></p><p class="s60" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">// Load model and output predictions here</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">});</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The JSON file contains the architecture, the parameter names of the model, and the paths to the smaller sharded weight files. The</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">sharding allows the files to be small enough to be cached by web browsers, which would make loading faster for any subsequent time the model would be needed.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1046">Model Conversion for the Browser</a><a name="bookmark1090">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 113%;text-align: left;"><a name="bookmark1091">In the previous section, we examined how to load a pretrained model that is already in the JSON format. In this section, we learn how to convert a pretrained Keras model (.</a><span class="s47">h5 </span>format) to JSON that is compatible with TensorFlow.js. To do this, we need to install the conversion tool using <span class="s47">pip</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ pip install tensorflowjs</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Assuming that our trained Keras model is stored in a folder named <i>keras_model</i>, we would be able to use the following command to convert it:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ tensorflowjs_converter --input_format keras keras_model/model.h5 web_model/</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;">Now the <span class="s47">web_model </span>directory will contain the <span class="s47">.json </span>and <span class="s47">.shard </span>files that we can easily load using the <span class="s47">tf.loadLayersModel </span>method:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ ls web_model</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">group1-shard1of4 group1-shard3of4 model.json group1-shard2of4 group1-shard4of4</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">That’s it! Bringing our trained model to the browser is an easy task. For cases in which we don’t already have an existing trained model, TensorFlow.js also allows us to train models directly in the browser. In the next section, we explore this by creating an end-to- end example of training a model using a webcam feed.</p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 110%;text-align: left;">Loading a model locally requires running a web server. There are tons of options that we can use, ranging from the LAMP (Linux, Apache, MySQL, PHP) stack to installing <span class="s53">http-server </span>using npm, to even running Internet Information Services (IIS) on Windows to test model loading locally. Even Python 3 can run a simple web server:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ python3 -m http.server 8O8O</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="231" alt="image" src="KerasTensorFlow2019/Image_609.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1047">Training in the Browser</a><a name="bookmark1092">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1093">The previous example used a pretrained model. Let’s take it up a notch and train our own models directly in the browser using input from the webcam. Like in some of the previous chapters, we look at a simple example in which we exploit transfer learning to make the training process faster.</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="284" alt="image" src="KerasTensorFlow2019/Image_610.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="https://oreil.ly/jkM6W" class="s140" target="_blank">Google Creative Lab built a fun interactive website called </a><a href="https://oreil.ly/jkM6W" class="s64" target="_blank">Teachable Machine </a>where the user can train three classes on any type of classification problem by simply showing those objects in front of the webcam. The three classes are given simple labels of green, purple, and orange. During prediction, rather than showing bland-looking class probabilities in text on a web page (or even worse, in the console), Teachable Machine shows GIFs of cute animals or plays different sounds based on the class that is being predicted. As you can imagine, this would be a fun and engaging experience for kids in a classroom, and it would serve as a wonderful tool to introduce them to AI.</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s63" target="_blank" name="bookmark1094">Adapted from Google’s Teachable Machine, we use transfer learning to construct a simple binary classification model, which will be trained using the webcam feed. To build this, we need a feature extractor (converts input images into features or embeddings), and then attach a network that converts these features into a prediction. Finally, we can train it with webcam inputs. The code is referenced in the book’s GitHub repository (see </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">http://PracticalDeepLearning.ai</span>) at <i>code/chapter-10/teachable- machine</i>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="281" alt="image" src="KerasTensorFlow2019/Image_611.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 51pt;text-indent: 0pt;text-align: left;">Figure 10-7. Training live in the browser with Teachable Machine</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1048">Feature Extraction</a><a name="bookmark1095">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1096">As we explored in some of the early chapters in this book, training a large model from scratch is a slow process. It’s a lot cheaper and quicker to use a pretrained model and use transfer learning to customize the model for our use case. We’ll use that model to extract high-level features (embeddings) from the input image, and use those features to train our custom model.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">For extracting the features, we load and use a pretrained MobileNet model:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">const </span><span style=" color: #000087;">path </span>= <span style=" color: #C30;">&#39;https://storage.googleapis.com/tfjs- models/tfjs/mobilenet_v1_1.O_224/model.json&#39;</span>; <span class="s54">const </span><span style=" color: #000087;">mobilenet </span>= <span style=" color: #000087;">await tf</span>.<span style=" color: #000087;">loadLayersModel</span>(<span style=" color: #000087;">path</span>);</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Let’s inspect the inputs and outputs of the model. We know that the model was trained on ImageNet and the final layer predicts a probability of each one of the 1,000 classes:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">const </span><span style=" color: #000087;">inputLayerShape </span>= <span style=" color: #000087;">mobilenet</span>.<span style=" color: #000087;">inputs</span>[<span style=" color: #F60;">O</span>].<span style=" color: #000087;">shape</span>; <span class="s60">// [null, 224, 224, 3]</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">const </span><span style=" color: #000087;">outputLayerShape </span>= <span style=" color: #000087;">mobilenet</span>.<span style=" color: #000087;">outputs</span>[<span style=" color: #F60;">O</span>].<span style=" color: #000087;">shape</span>; <span class="s60">// [null, 1000]</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">const </span>numLayers <span style=" color: #000;">= </span>mobilenet<span style=" color: #000;">.</span>layers<span style=" color: #000;">.</span>length<span style=" color: #000;">; </span><span class="s60">// 88</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 114%;text-align: left;">To extract the features, we select a layer closer to the output. Here we select <span class="s47">conv_pw_13_relu </span>and make it the output of the model; that is, remove the dense layers at the end. The model we created is called a feature extraction model:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">// Get a specific layer</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">const </span><span style=" color: #000087;">layer </span>= <span style=" color: #000087;">mobilenet</span>.<span style=" color: #000087;">getLayer</span>(<span style=" color: #C30;">&#39;conv_pw_13_relu&#39;</span>);</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">// Create a new feature extraction model</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">featureExtractionModel <span style=" color: #000;">= </span>tf<span style=" color: #000;">.</span>model<span style=" color: #000;">({</span>inputs<span style=" color: #000;">: </span>mobilenet<span style=" color: #000;">.</span>inputs<span style=" color: #000;">, </span>outputs<span style=" color: #000;">: </span>layer<span style=" color: #000;">.</span>output<span style=" color: #000;">});</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">featureExtractionModel<span style=" color: #000;">.</span>layers<span style=" color: #000;">.</span>length<span style=" color: #000;">; </span><span class="s60">// 82</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We’ll keep the feature extraction model unmodified during our training process. Instead, we add a trainable set of layers on top of it to build our classifier:</p><p class="s56" style="padding-top: 4pt;padding-left: 45pt;text-indent: -23pt;text-align: left;"><span class="s54">const </span>trainableModel <span style=" color: #000;">= </span>tf<span style=" color: #000;">.</span>sequential<span style=" color: #000;">({ </span>layers<span style=" color: #000;">: [</span></p><p class="s53" style="padding-left: 69pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">tf</span>.<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">flatten</span>({<span style=" color: #000087;">inputShape</span>: [<span style=" color: #F60;">7</span>, <span style=" color: #F60;">7</span>, <span style=" color: #F60;">1O24</span>]}), <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">dense</span>({</p><p class="s53" style="padding-left: 69pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">units</span>: <span style=" color: #F60;">64</span>, <span style=" color: #000087;">activation</span>: <span style=" color: #C30;">&#39;relu&#39;</span>,</p><p class="s53" style="padding-left: 69pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">kernelInitializer</span>: <span style=" color: #C30;">&#39;varianceScaling&#39;</span>, <span style=" color: #000087;">useBias</span>: <span class="s54">true</span></p><p class="s53" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">}),</p><p class="s53" style="padding-left: 69pt;text-indent: -23pt;text-align: left;"><span style=" color: #000087;">tf</span>.<span style=" color: #000087;">layers</span>.<span style=" color: #000087;">dense</span>({ <span style=" color: #000087;">units</span>: <span style=" color: #F60;">2</span>,</p><p class="s53" style="padding-left: 69pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">kernelInitializer</span>: <span style=" color: #C30;">&#39;varianceScaling&#39;</span>, <span style=" color: #000087;">useBias</span>: <span class="s54">false</span>,</p><p class="s56" style="padding-left: 69pt;text-indent: 0pt;text-align: left;">activation<span style=" color: #000;">: </span><span style=" color: #C30;">&#39;softmax&#39;</span></p><p class="s53" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">})]</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">});</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1049">Data Collection</a><a name="bookmark1097">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 114%;text-align: left;">Here, we collect images using the webcam feed and process them for feature extraction. The <span class="s47">capture() </span>function in the Teachable Machine is responsible for setting up the <span class="s47">webcamImage </span>for storing the captured images from the webcam in memory. Now, let’s preprocess them to make them applicable to the feature extraction model:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">function <span class="s56">capture</span><span class="s53">() {</span></p><p class="s56" style="padding-left: 51pt;text-indent: 0pt;text-align: left;"><span class="s54">return </span>tf<span style=" color: #000;">.</span>tidy<span style=" color: #000;">(() =&gt; {</span></p><p class="s60" style="padding-left: 75pt;text-indent: 0pt;text-align: left;">// convert to a tensor</p><p class="s56" style="padding-left: 75pt;text-indent: 0pt;text-align: left;"><span class="s54">const </span>webcamImage <span style=" color: #000;">= </span>tf<span style=" color: #000;">.</span>fromPixels<span style=" color: #000;">(</span>webcam<span style=" color: #000;">);</span></p><p class="s60" style="padding-left: 75pt;text-indent: 0pt;text-align: left;">// crop to 224x224</p><p class="s56" style="padding-left: 75pt;text-indent: 0pt;text-align: left;"><span class="s54">const </span>croppedImage <span style=" color: #000;">= </span>cropImage<span style=" color: #000;">(</span>webcamImage<span style=" color: #000;">);</span></p><p class="s60" style="padding-left: 75pt;text-indent: 0pt;text-align: left;">// create batch and normalize</p><p class="s53" style="padding-left: 75pt;text-indent: 0pt;text-align: left;"><span class="s54">const </span><span style=" color: #000087;">batchedImage </span>= <span style=" color: #000087;">croppedImage</span>.<span style=" color: #000087;">expandDims</span>(<span style=" color: #F60;">O</span>);</p><p class="s54" style="padding-left: 75pt;text-indent: 0pt;text-align: left;">return</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">batchedImage</span>.<span style=" color: #000087;">toFloat</span>().<span style=" color: #000087;">div</span>(<span style=" color: #000087;">tf</span>.<span style=" color: #000087;">scalar</span>(<span style=" color: #F60;">127</span>)).<span style=" color: #000087;">sub</span>(<span style=" color: #000087;">tf</span>.<span style=" color: #000087;">scalar</span>(<span style=" color: #F60;">1</span>));</p><p class="s53" style="padding-left: 51pt;text-indent: 0pt;text-align: left;">});</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">}</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">After we capture the images, we can add the image and label to the training data:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">function </span>addTrainingExample<span style=" color: #000;">(</span>img<span style=" color: #000;">, </span>label<span style=" color: #000;">) {</span></p><p class="s60" style="padding-left: 51pt;text-indent: 0pt;text-align: left;">// Extract features.</p><p class="s56" style="padding-left: 51pt;text-indent: 0pt;text-align: left;"><span class="s54">const </span>data <span style=" color: #000;">= </span>featureExtractionModel<span style=" color: #000;">.</span>predict<span style=" color: #000;">(</span>img<span style=" color: #000;">);</span></p><p class="s60" style="padding-left: 51pt;text-indent: 0pt;text-align: left;">// One-hot encode the label.</p><p class="s53" style="padding-left: 51pt;text-indent: 0pt;text-align: left;"><span class="s54">const </span><span style=" color: #000087;">oneHotLabel </span>= <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">tidy</span>(() =&gt; <span style=" color: #000087;">tf</span>.<span style=" color: #000087;">oneHot</span>(<span style=" color: #000087;">tf</span>.<span style=" color: #000087;">tensor1d</span>([<span style=" color: #000087;">label</span>], <span style=" color: #C30;">&#39;int32&#39;</span>), <span style=" color: #F60;">2</span>));</p><p class="s60" style="padding-left: 51pt;text-indent: 0pt;text-align: left;">// Add the label and data to the training set.</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">}</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1050">Training</a><a name="bookmark1098">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark227" class="s63">Next, we train the model, much as we trained in </a>Chapter 3<span style=" color: #000;">. Just like in Keras and TensorFlow, we add an optimizer and define the loss function:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">const </span>optimizer <span style=" color: #000;">= </span>tf<span style=" color: #000;">.</span>train<span style=" color: #000;">.</span>adam<span style=" color: #000;">(</span>learningRate<span style=" color: #000;">);</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">model<span style=" color: #000;">.</span>compile<span style=" color: #000;">({ </span>optimizer<span style=" color: #000;">: </span>optimizer<span style=" color: #000;">, </span>loss<span style=" color: #000;">: </span><span style=" color: #C30;">&#39;categoricalCrossentropy&#39;</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">});</p><p class="s56" style="padding-left: 45pt;text-indent: -23pt;text-align: left;">model<span style=" color: #000;">.</span>fit<span style=" color: #000;">(</span>data<span style=" color: #000;">, </span>label<span style=" color: #000;">, { </span>batchSize<span style=" color: #000;">,</span></p><p class="s53" style="padding-left: 45pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">epochs</span>: <span style=" color: #F60;">5</span>, <span style=" color: #000087;">callbacks</span>: {</p><p class="s56" style="padding-left: 92pt;text-indent: -23pt;text-align: left;">onBatchEnd<span style=" color: #000;">: </span>async <span style=" color: #000;">(</span>batch<span style=" color: #000;">, </span>logs<span style=" color: #000;">) =&gt; { </span>await tf<span style=" color: #000;">.</span>nextFrame<span style=" color: #000;">();</span></p><p class="s53" style="padding-left: 69pt;text-indent: 0pt;text-align: left;">}</p><p class="s53" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">}</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">}</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="654" alt="image" src="KerasTensorFlow2019/Image_612.png"/></span></p><p class="s51" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s49" style="padding-top: 6pt;padding-left: 35pt;text-indent: 0pt;line-height: 111%;text-align: left;">One important thing to keep in mind is that on the GPU, memory allocated by TensorFlow.js is not released when a <span class="s53">tf.tensor </span>object goes out of scope. One solution is to call the <span class="s53">dispose() </span>method on every single object created. However, that would make the code more difficult to read, particularly when chaining is involved. Consider the following example:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s74" style="padding-left: 50pt;text-indent: 0pt;text-align: left;"><span class="s77">const </span>result <span style=" color: #000;">= </span>a<span style=" color: #000;">.</span>add<span style=" color: #000;">(</span>b<span style=" color: #000;">).</span>square<span style=" color: #000;">().</span>neg<span style=" color: #000;">();</span></p><p class="s77" style="padding-left: 50pt;text-indent: 0pt;text-align: left;">return <span class="s74">result</span><span class="s75">;</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s49" style="padding-top: 7pt;padding-left: 35pt;text-indent: 0pt;line-height: 108%;text-align: left;">To cleanly dispose of all memory, we’d need to break it down into the following:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s74" style="padding-left: 50pt;text-indent: 0pt;text-align: left;"><span class="s77">const </span>sum <span style=" color: #000;">= </span>a<span style=" color: #000;">.</span>add<span style=" color: #000;">(</span>b<span style=" color: #000;">);</span></p><p class="s74" style="padding-left: 50pt;text-indent: 0pt;line-height: 108%;text-align: left;"><span class="s77">const </span>square <span style=" color: #000;">= </span>sum<span style=" color: #000;">.</span>square<span style=" color: #000;">(); </span><span class="s77">const </span>result <span style=" color: #000;">= </span>square<span style=" color: #000;">.</span>neg<span style=" color: #000;">(); </span>sum<span style=" color: #000;">.</span>dispose<span style=" color: #000;">(); </span>square<span style=" color: #000;">.</span>dispose<span style=" color: #000;">();</span></p><p class="s77" style="padding-left: 50pt;text-indent: 0pt;line-height: 10pt;text-align: left;">return <span class="s74">result</span><span class="s75">;</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s49" style="padding-top: 7pt;padding-left: 35pt;text-indent: 0pt;line-height: 112%;text-align: left;">Instead, we could simply use <span class="s53">tf.tidy() </span>to do the memory management for us, while keeping our code clean and readable. Our first line simply needs to be wrapped inside the <span class="s53">tf.tidy() </span>block, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s74" style="padding-left: 50pt;text-indent: 0pt;text-align: left;"><span class="s77">const </span>result <span style=" color: #000;">= </span>tf<span style=" color: #000;">.</span>tidy<span style=" color: #000;">(() =&gt; {</span></p><p class="s74" style="padding-left: 72pt;text-indent: 0pt;text-align: left;"><span class="s77">return </span>a<span style=" color: #000;">.</span>add<span style=" color: #000;">(</span>b<span style=" color: #000;">).</span>square<span style=" color: #000;">().</span>neg<span style=" color: #000;">();</span></p><p class="s75" style="padding-left: 50pt;text-indent: 0pt;text-align: left;">});</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s49" style="padding-top: 7pt;padding-left: 35pt;text-indent: 0pt;line-height: 108%;text-align: left;">With a CPU backend, the objects are automatically garbage collected by the browser. Calling <span class="s53">.dispose() </span>there does not have any effect.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1099" class="s63">As a simple use case, let’s train the model to detect emotions. To do so, we need to simply add training examples belonging to either one of two classes: happy or sad. Using this data, we can start training. </a>Figure 10-8 <span style=" color: #000;">shows the final result after training the model on 30 images per each class.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="590" height="235" alt="image" src="KerasTensorFlow2019/Image_613.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="168" alt="image" src="KerasTensorFlow2019/Image_614.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 110%;text-align: left;">Usually, when using a webcam for predictions, the UI tends to freeze. This is because the computation happens on the same thread as the UI rendering. Calling <span class="s53">await tf.nextFrame() </span>will release the UI thread, which will make the web page responsive and prevent the tab/browser from freezing.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s50" style="padding-top: 4pt;padding-left: 25pt;text-indent: 0pt;text-align: left;"><a name="bookmark1099">Figure 10-8. Predictions by our model on a webcam feed within a browser</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1051">GPU Utilization</a><a name="bookmark1100">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1102" class="s63" name="bookmark1101">We can see the CPU/GPU utilization during training and inference using the Chrome profiler. In the previous example, we recorded the utilization for 30 seconds and observed the GPU usage. In </a>Figure 10-9<span style=" color: #000;">, we see that the GPU is used a quarter of the time.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="601" height="571" alt="image" src="KerasTensorFlow2019/Image_615.jpg"/></span></p><p class="s50" style="padding-top: 2pt;padding-left: 35pt;text-indent: 0pt;text-align: left;"><a name="bookmark1102">Figure 10-9. GPU utilization shown in the Google Chrome profiler view</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">So far, we’ve discussed how to do everything from scratch, including loading the model, capturing video from the webcam, collecting the training data, training the model, and running an inference. Wouldn’t it be great if all these steps could be taken care</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1103">of under the hood and we could just focus on what to do with the results of the inference? In the next section, we discuss exactly that with ml5.js.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1052">ml5.js</a><a name="bookmark1104">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1106" class="s63" name="bookmark1105">ml5.js is a higher abstraction of TensorFlow.js that makes it easy to use existing pretrained deep learning models in a unified way, with a minimal number of lines of code. The package comes with a wide range of built-in models, ranging from image segmentation to sound classification to text generation, as shown in </a>Table 10-2<span style=" color: #000;">.</span></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://ml5js.org/reference" class="s63" target="_blank">Further, ml5.js reduces the steps related to preprocessing, postprocessing, and so on, letting us concentrate on building the application that we want with these models. For each of these functionalities, ml5js comes with a </a>demonstration <span style=" color: #000;">and reference code.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s43" style="padding-left: 97pt;text-indent: -90pt;text-align: left;"><a name="bookmark1106">Table 10-2. Selected built-in models in ml5.js, showing the range of functionalities in text, image, and sound</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="581" height="1" alt="image" src="KerasTensorFlow2019/Image_616.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-bottom: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Functionality Description</p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="581" height="1" alt="image" src="KerasTensorFlow2019/Image_617.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="30" alt="image" src="KerasTensorFlow2019/Image_618.png"/></span></p><p class="s49" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">U-Net Object segmentation; e.g., removing object background</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="padding-top: 2pt;padding-bottom: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">PoseNet Detect the location of human joints</p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="30" alt="image" src="KerasTensorFlow2019/Image_619.png"/></span></p><p class="s49" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Pix2Pix Image-to-image translation; e.g., black-and-white to color</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="padding-top: 2pt;padding-bottom: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Style Transfer Transfers style of one image to another</p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="30" alt="image" src="KerasTensorFlow2019/Image_620.png"/></span></p><p class="s49" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">YOLO Object detection; e.g., locates faces with bounding boxes</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="padding-top: 2pt;padding-bottom: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Sketch RNN Creates doodles based on an incomplete sketch</p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="30" alt="image" src="KerasTensorFlow2019/Image_621.png"/></span></p><p class="s49" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Pitch Detector Estimates pitch of sound</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="padding-top: 2pt;padding-bottom: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Sound Classifier Recognizes audio; e.g., whistle, clap, “one,” “stop,” etc.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="50" alt="image" src="KerasTensorFlow2019/Image_622.png"/></span></p><p class="s49" style="text-indent: 0pt;line-height: 14pt;text-align: left;">Detects sentiment of a sentence</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="text-indent: 0pt;line-height: 108%;text-align: left;">Sentiment Classifier</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="padding-top: 2pt;padding-bottom: 2pt;padding-left: 121pt;text-indent: -110pt;line-height: 108%;text-align: left;">Char RNN Generates new text based on training on a large corpus of text</p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="30" alt="image" src="KerasTensorFlow2019/Image_623.png"/></span></p><p class="s49" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Feature Extractor Generates features or embeddings from input</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="padding-top: 2pt;padding-bottom: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Word2Vec Produces word embeddings to identify word relations</p><p class="s49" style="padding-top: 2pt;padding-bottom: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">kNN Classifier Creates a fast classifier using <i>k</i>-Nearest Neighbor</p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="581" height="1" alt="image" src="KerasTensorFlow2019/Image_624.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Let’s see it in action. First, we import the latest bundle of ml5.js, which is similar to TensorFlow.js:</p><p class="s57" style="padding-top: 4pt;padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s137">&lt;script </span><a href="https://unpkg.com/ml5%40latest/dist/ml5.min.js" style=" color: #309; font-family:&quot;Courier New&quot;, monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9.5pt;" target="_blank">src=</a>&quot;https://unpkg.com/ml5@latest/dist/ml5.min.js&quot; <span style=" color: #309;">type=</span>&quot;text/javascript&quot;<span class="s137">&gt;&lt;/script&gt;</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Note that we no longer need to import anything related to TensorFlow.js, because it already comes included with ml5.js. We create a simple example where we use the same MobileNet scenario as earlier:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">// Initialize the image classifier method with MobileNet</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">const </span><span style=" color: #000087;">classifier </span>= <span style=" color: #000087;">ml5</span>.<span style=" color: #000087;">imageClassifier</span>(<span style=" color: #C30;">&#39;MobileNet&#39;</span>, <span style=" color: #000087;">modelLoaded</span>);</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s60">// Make a prediction with the selected image </span><span style=" color: #000087;">classifier</span>.<span style=" color: #000087;">predict</span>(<span style=" color: #366;">document</span>.<span style=" color: #000087;">getElementById</span>(<span style=" color: #C30;">&#39;image&#39;</span>), <span class="s54">function</span>(<span style=" color: #000087;">err</span>, <span style=" color: #000087;">results</span>) {</p><p class="s56" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">console<span style=" color: #000;">.</span>log<span style=" color: #000;">(</span>results<span style=" color: #000;">);</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">});</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1107" class="s63">Done! In effectively three lines, a pretrained model is running in our browser. Now, let’s open the browser’s console to inspect the output presented in </a>Figure 10-10<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="597" height="85" alt="image" src="KerasTensorFlow2019/Image_625.jpg"/></span></p><p class="s50" style="padding-top: 7pt;padding-left: 27pt;text-indent: 0pt;text-align: left;"><a name="bookmark1107">Figure 10-10. The top predicted classes with the probability of each class</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="146" alt="image" src="KerasTensorFlow2019/Image_626.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">If you are unfamiliar with the browser console, you can simply access it by right-clicking anywhere within the browser window and selecting “Inspect element.” A separate window opens with the console inside it.</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">We can find the full source code for the previous example at</p><p class="s43" style="padding-top: 1pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">code/chapter-10/ml5js<span class="p">.</span></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Note that ml5.js uses callbacks to manage asynchronous calls of the models. A callback is a function that is executed after the accompanying call is finished. For instance, in the last code</p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="233" alt="image" src="KerasTensorFlow2019/Image_627.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">p5.js is a library that works nicely in conjunction with ml5.js and makes it super easy to make model predictions in real time using a live video stream. You can find a code snippet demonstrating the power of p5.js at <i>code/chapter-10/p5js-webcam/</i>.</p><p class="s49" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">ml5.js natively supports p5.js elements and objects. You can use p5.js elements for drawing objects, capturing webcam feeds, and more.</p><p class="s49" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Then, you can easily use such elements as input to the ml5.js callback functions.</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;">snippet, after the model is loaded, the <span class="s47">modelLoaded </span>function is called, indicating that the model is loaded into memory.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1053">PoseNet</a><a name="bookmark1108">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1109">So far in this book, we have primarily explored image classification problems. In later chapters, we take a look at object detection and segmentation problems. These types of problems form a majority of computer-vision literature. In this section, however, we choose to take a break from the usual and deal with a different kind of problem: keypoint detection. This has significant applications in a variety of areas including health care, fitness, security, gaming, augmented reality, and robotics. For instance, to encourage a healthy lifestyle through exercise, Mexico City installed kiosks that detect the squat pose and offer free subway tickets to passengers who can do at least 10 squats. In this section, we explore how to run something so powerful in our humble web browser.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The PoseNet model offers real-time pose estimation in the browser. A “pose” consists of the position of different keypoints (including joints) in the human body such as the top of the head, eyes, nose, neck, wrists, elbows, knees, ankles, shoulders, and hips. You can use PoseNet for single or multiple poses that might exist in the same frame.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Let’s build an example using PoseNet, which is readily available in ml5.js, to detect and draw keypoints (with the help of p5.js).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 13pt;text-indent: 0pt;text-align: left;"><span><img width="568" height="311" alt="image" src="KerasTensorFlow2019/Image_628.jpg"/></span></p><p style="padding-left: 13pt;text-indent: 0pt;text-align: left;"><span><img width="568" height="604" alt="image" src="KerasTensorFlow2019/Image_629.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 156pt;text-indent: -142pt;line-height: 108%;text-align: left;">Figure 10-11. Keypoints drawn using PoseNet on a picture of former President Obama in a snowball fight</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;">You can find the code to detect keypoints for a still image at</p><p class="s43" style="padding-top: 1pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">code/chapter-10/posenet/single.html<span class="p">:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s137" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&lt;script <a href="http://p5js.org/assets/js/p5.min.js" style=" color: #309; font-family:&quot;Courier New&quot;, monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9.5pt;" target="_blank">src=</a><span class="s57">&quot;http://p5js.org/assets/js/p5.min.js&quot;</span>&gt;&lt;/script&gt;</p><p class="s137" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&lt;script <a href="http://p5js.org/assets/js/p5.dom.min.js" style=" color: #309; font-family:&quot;Courier New&quot;, monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9.5pt;" target="_blank">src=</a><span class="s57">&quot;http://p5js.org/assets/js/p5.dom.min.js&quot;</span>&gt;&lt;/script&gt;</p><p class="s137" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&lt;script <a href="https://unpkg.com/ml5%40latest/dist/ml5.min.js" style=" color: #309; font-family:&quot;Courier New&quot;, monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9.5pt;" target="_blank">src=</a><span class="s57">&quot;https://unpkg.com/ml5@latest/dist/ml5.min.js&quot;</span>&gt;&lt;/script&gt;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s137" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&lt;script&gt;</p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">function <span class="s56">setup</span><span class="s53">() {</span></p><p class="s60" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">// Set up camera here</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">// Call PoseNet model</p><p class="s56" style="padding-left: 45pt;text-indent: 0pt;text-align: left;"><span class="s54">const </span>poseNet <span style=" color: #000;">= </span>ml5<span style=" color: #000;">.</span>poseNet<span style=" color: #000;">(</span>video<span style=" color: #000;">, </span>modelReady<span style=" color: #000;">);</span></p><p class="s60" style="padding-top: 4pt;padding-left: 45pt;text-indent: 0pt;text-align: left;">// PoseNet callback function</p><p class="s53" style="padding-left: 45pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">poseNet</span>.<span style=" color: #000087;">on</span>(<span style=" color: #C30;">&#39;pose&#39;</span>, <span class="s54">function </span>(<span style=" color: #000087;">results</span>) {</p><p class="s56" style="padding-left: 69pt;text-indent: 0pt;text-align: left;"><span class="s54">const </span>poses <span style=" color: #000;">= </span>results<span style=" color: #000;">;</span></p><p class="s53" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">});</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">}</p><p class="s137" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&lt;/script&gt;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We can also run a similar script (at <i>code/chapter- 10/posenet/webcam.html</i>) on our webcam.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="416" alt="image" src="KerasTensorFlow2019/Image_630.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s48" style="padding-left: 115pt;text-indent: 0pt;text-align: center;">FROM THE CREATOR’S DESK</p><p class="s49" style="padding-top: 7pt;padding-left: 11pt;text-indent: 0pt;text-align: left;">By Cristobal Valenzuela, cofounder of Runway and contributor to ml5.js</p><p class="s49" style="padding-top: 6pt;padding-left: 11pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1110">ml5.js started as an experiment within NYU’s Interactive Telecommunications Program (ITP) to understand creative applications of machine learning in the browser. Heavily inspired by Processing and p5.js, the original idea was to create a series of code experiments with deeplearn.js (now TensorFlow.js) and p5.js. In August of 2017, a few days after deeplearn.js was released, I created a repository called “p5deeplearn: deeplearn.js meets p5” as a tentative first approach. This repository was the genesis of ml5.js, with the “5” paying homage to p5.js and the Processing philosophy itself.</a></p><p class="s49" style="padding-top: 5pt;padding-left: 11pt;text-indent: 0pt;line-height: 108%;text-align: left;">With the guidance of Dan Shiffman and the support of a Google Faculty Research Award to collaborate with the TensorFlow.js team, we organized a weekly working group to discuss developing the library itself and invited guest artists and researchers to participate in its development. The main idea behind ml5.js has always been to create an approachable and easy-to- use library space and community where we could encourage experimentation and creation with AI in the browser.</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Now let us look at another example that is supported by ml5.js.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="926" alt="image" src="KerasTensorFlow2019/Image_631.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s48" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">FROM THE CREATOR’S DESK</p><p class="s49" style="padding-top: 6pt;padding-left: 18pt;text-indent: 0pt;line-height: 108%;text-align: left;">By Daniel Shiffman, associate arts professor at the Interactive Telecommunications Program at NYU’s Tisch School of the Arts and a director of The Processing Foundation</p><p class="s49" style="padding-top: 5pt;padding-left: 18pt;text-indent: 0pt;line-height: 108%;text-align: left;">Despite the ease of running a machine learning model in the browser with TensorFlow.js, beginners who want to code their own still face the challenge of mathematical notation and low-level technical code. Machine learning frameworks are commonly geared toward people with knowledge of calculus, linear algebra, statistics, data science, and several years of programming in a language like Python or C++. Although important for research and development of new machine learning models and architectures, starting from this point can turn away newcomers with other backgrounds. Rather than thinking creatively about how to use machine learning as an artistic platform, beginners can be overwhelmed by fine distinctions between scalars, vectors, matrices, operations, inputs layers, outputs, and more.</p><p class="s49" style="padding-top: 5pt;padding-left: 18pt;text-indent: 0pt;line-height: 108%;text-align: left;">This is where ml5.js comes in. Its goal is to provide a neighborly approach to creating and exploring AI in the browser. <i>The “5” in ml5 is an homage to p5.js, a JavaScript library that serves as the primary inspiration and model for ml5. </i>p5.js is maintained by the Processing Foundation whose mission is “to empower people of all interests and backgrounds to learn how to program and make creative work with code, especially those who might not otherwise have access to these tools and resources.”</p><p class="s49" style="padding-top: 5pt;padding-left: 18pt;text-indent: 0pt;line-height: 108%;text-align: left;">With Processing, an artist can invent their own tools rather than relying on those created and maintained by others. Today, being “software literate” is arguably more important than ever. Algorithms affect our lives in ways we couldn’t have anticipated, and the explosion of machine learning research has further extended their reach. Our interactions are now negotiated not just with each other, but with autonomous vehicles, ever-listening assistants, and cameras that identify our faces and poses. Without access to and understanding of the machine learning models, underlying data, and outputs driving the software, how can we meaningfully engage, question, and propose alternatives? Machine learning faces a similar challenge of approachability as simply learning to code did more than 15 years ago.</p><p class="s49" style="padding-top: 5pt;padding-left: 18pt;text-indent: 0pt;line-height: 108%;text-align: left;">The development of ml5.js is funded by a Google Faculty Research Award at ITP. ITP is a two-year graduate program in the NYU Tisch School of the Arts, whose mission is to explore the imaginative use of communications technologies — how they might augment, improve, and bring delight and art into people’s lives. Each week, a group of 10 to 15 ITP students, along with outside contributors and guest artists, meets at ITP to discuss API decisions, share creative projects, and teach each other about contributing to open source. To date, there have been more than 50 contributors to 17 releases of ml5.js.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1054">pix2pix</a><a name="bookmark1111">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">“Hasta la vista, baby!”</p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1112">This is one of the most memorable lines in the history of film. Coincidentally, it was uttered by an AI cyborg in the 1991 classic </a><i>Terminator 2: Judgment Day</i>. By the way, its translation is “Goodbye, baby!” Language translation technology has come a long way since then. It used to be that language translation was built on phrase substitution rules. And now, it’s replaced by much better performing deep learning systems that understand the context of the sentence to convert it into a similar meaning sentence in the target language.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Here’s a thought: if we can translate from sentence one to sentence two, could we translate a picture from one setting to another? Could we do the following:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_632.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_633.png"/></span></p><p style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;line-height: 191%;text-align: left;">Convert an image from low resolution to higher resolution? Convert an image from black and white to color?</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_634.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_635.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 191%;text-align: left;">Convert an image from daytime to nighttime view? Convert a satellite image of the earth into a map view?</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_636.png"/></span></p><p style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Convert an image from a hand-drawn sketch into a photograph?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://oreil.ly/g5R60" class="s63" target="_blank">Well, image translation is not science fiction anymore. In 2017, </a>Philip Isola et al. <a href="#bookmark1113" class="s63">developed a way to convert a picture into another picture, conveniently naming it pix2pix. By learning from several pairs of before and after pictures, the pix2pix model is able to generate highly realistic renderings based on the input image. For example, as demonstrated in </a>Figure 10-12<span style=" color: #000;">, given a pencil sketch of a bag, it can recreate the photo of a bag. Additional applications include image segmentation, synthesizing artistic imagery, and more.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="587" height="216" alt="image" src="KerasTensorFlow2019/Image_637.jpg"/></span></p><p class="s50" style="padding-top: 8pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1113">Figure 10-12. Example of input and output pairs on pix2pix</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="557" alt="image" src="KerasTensorFlow2019/Image_638.png"/></span></p><p class="s51" style="padding-left: 18pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s49" style="padding-top: 6pt;padding-left: 35pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1114">Imagine a scenario with a bank teller and a currency counterfeiter. The job of the bank teller is to spot fake currency bills, whereas the counterfeiter’s goal is to make it as difficult as possible for the bank teller to identify the fakes. They are clearly in an adversarial situation. Each time the cop spots the fake bills, the counterfeiter learns his mistake, takes it as an opportunity to improve (growth mindset after all), and tries to make it even more difficult for the bank teller to thwart him next time. This forces the bank teller to get better at recognizing fakes over time. This feedback cycle forces both of them to get better at what they do. This is the underlying principle driving GANs.</a></p><p class="s79" style="padding-top: 5pt;padding-left: 35pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark1116" class="s140">As </a>Figure 10-13 <span style=" color: #000;">illustrates, GANs consist of two networks, a Generator and a Discriminator, which have the same adversarial relationship as the counterfeiter and the bank teller. The Generator’s job is to generate realistic-looking output, very similar to the training data. The Discriminator’s responsibility is to identify whether the data passed to it by the Generator was real or fake. The output of the Discriminator is fed back into the Generator to begin the next cycle. Each time the Discriminator correctly identifies a generated output as a fake, it forces the Generator to get better in the next cycle.</span></p><p class="s49" style="padding-top: 5pt;padding-left: 35pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1115">It is worthwhile to note that GANs typically do not have control over the data to be generated. However, there are variants of GANs, such as </a><i>conditional GANs</i>, that allow for labels to be part of the input, providing more control over the output generation; that is, conditioning the output. pix2pix is an example of a conditional GAN.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;text-align: left;"><span><img width="568" height="315" alt="image" src="KerasTensorFlow2019/Image_639.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1116">Figure 10-13. A flowchart for a GAN</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We used pix2pix to create a simple sketching app that works in the browser. The output images are really interesting to look at.</p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1117" class="s63">Consider the examples shown in </a>Figure 10-14 <a href="#bookmark1118" class="s63">and </a>Figure 10-15<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 12pt;text-indent: 0pt;text-align: left;"><span><img width="583" height="296" alt="image" src="KerasTensorFlow2019/Image_640.jpg"/></span></p><p class="s50" style="padding-top: 7pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1117">Figure 10-14. Sketch-to-image example</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 13pt;text-indent: 0pt;text-align: left;"><span><img width="557" height="250" alt="image" src="KerasTensorFlow2019/Image_641.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 107pt;text-indent: -88pt;line-height: 108%;text-align: left;"><a name="bookmark1118">Figure 10-15. We can create colored blueprints (left) and pix2pix will convert them to realistic-looking human faces (right)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="165" alt="image" src="KerasTensorFlow2019/Image_642.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Fun fact: Ian Goodfellow came up with the idea for GANs while at a bar. This adds yet another item to the list of inventions, organizations, and companies whose ideas originated over drinks, including the creation of the RSA Algorithm, Southwest Airlines, and the game of Quidditch.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s45" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1119" class="s63">pix2pix works by training on pairs of images. In </a>Figure 10-16<span style=" color: #000;">, the image on the left is the input image or the conditional input. The image on the right is the target image, the realistic output that we want to generate (if you are reading the print version, you will not see the color image on the right).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="292" alt="image" src="KerasTensorFlow2019/Image_643.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 210pt;text-indent: -186pt;line-height: 108%;text-align: left;"><a name="bookmark1119">Figure 10-16. Training pairs for pix2pix: a B&amp;W image and its original color image</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://oreil.ly/r-d1l" class="s63" target="_blank">One of the easier ports for training pix2pix is the TensorFlow-based implementation by </a>Christopher Hesse<span style=" color: #000;">. We can use a very simple script to train our own model:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">python pix2pix.py \</p><p class="s53" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">--mode train \</p><p class="s53" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">--output_dir facades_train \</p><p class="s53" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">--max_epochs 2OO \</p><p class="s53" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">--input_dir facades/train \</p><p class="s53" style="padding-left: 33pt;text-indent: 0pt;text-align: left;">--which_direction BtoA</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">After training has finished, we can save the model using the following command:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">python tools/export-checkpoint.py --checkpoint ../export --output_file models/MY_MODEL_BtoA.pict</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">After that, we can use this simple code to load the saved weights to ml5.js. Note the transfer function that is used to retrieve the output in a canvas:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">// Create a pix2pix model using a pre-trained network</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">const </span><span style=" color: #000087;">pix2pix </span>= <span style=" color: #000087;">ml5</span>.<span style=" color: #000087;">pix2pix</span>(<span style=" color: #C30;">&#39;models/customModel.pict&#39;</span>, <span style=" color: #000087;">modelLoaded</span>);</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">// Transfer using a canvas</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">pix2pix</span>.<span style=" color: #000087;">transfer</span>(<span style=" color: #000087;">canvas</span>, <span class="s54">function</span>(<span style=" color: #000087;">err</span>, <span style=" color: #000087;">result</span>) {</p><p class="s56" style="padding-top: 4pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">console<span style=" color: #000;">.</span>log<span style=" color: #000;">(</span>result<span style=" color: #000;">);</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">});</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1120" class="s63">We can also draw strokes and allow real-time sketching. For instance, </a>Figure 10-17 <span style=" color: #000;">shows an example that draws Pikachu.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 12pt;text-indent: 0pt;text-align: left;"><span><img width="582" height="233" alt="image" src="KerasTensorFlow2019/Image_644.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="269" alt="image" src="KerasTensorFlow2019/Image_645.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s48" style="padding-left: 115pt;text-indent: 0pt;text-align: center;">FROM THE CREATOR’S DESK</p><p class="s49" style="padding-top: 7pt;padding-left: 11pt;text-indent: 0pt;text-align: left;">By Cristobal Valenzuela, cofounder of Runway and contributor to ml5.js</p><p class="s49" style="padding-top: 6pt;padding-left: 11pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1121">There have been a lot of interesting projects, experiments, and creations built with ml5.js: artists have been using it to create art as well as live stage performances. Nikita Huggins and Ayodamola Okunseinde, two New York- based artists, have been exploring ways of increasing the diversity of the models the library currently supports, so students and developers have built applications for Hackathons and for all kinds of competitions. But what’s super exciting is to see how it has been used in curricula around the world to teach about machine learning in an approachable manner, opening the possibilities for a broad audience of artists, creative coders, and students.</a></p><p style="text-indent: 0pt;text-align: left;"/><p class="s198" style="padding-top: 4pt;padding-left: 38pt;text-indent: 0pt;text-align: left;"><a href="https://oreil.ly/HIaSy" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12pt;" target="_blank" name="bookmark1120">Figure 10-17. </a>Pix2Pix: Edges to Pikachu <span style=" color: #000;">by Yining Shi, built on ml5.js</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1055">Benchmarking and Practical Considerations</a><a name="bookmark1122">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1123">As people who care deeply about how our end users perceive our product, it’s important for us to treat them right. Two factors play a large role in how users experience our product: the model size, and the inference time based on the hardware. Let’s take a closer look at each factor.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1056">Model Size</a><a name="bookmark1124">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1125">A typical MobileNet model is 16 MB. Loading this on a standard home or office network might just take a few seconds. Loading the same model on a mobile network would take even longer. The clock is ticking, and the user is becoming impatient. And this is before the model even gets a chance to start inference. Waiting for big models to load is more detrimental to the UX than their runtime, especially where internet speeds are not as fast as a broadband paradise like Singapore. There are a few strategies that can help:</a></p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Pick the smallest model for the job</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;">Among pretrained networks, EfficientNet, MobileNet, or SqueezeNet tend to be the smallest (in order of decreasing accuracy).</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Quantize the model</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;">Reduce the model size using the TensorFlow Model Optimization Toolkit before exporting to TensorFlow.js.</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Build our own tiny model architecture</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;">If the final product does not need heavy ImageNet-level classification, we could build our own smaller model. When Google made the J.S. Bach doodle on the Google home page, its model was only 400 KB, loading almost instantly.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1057">Inference Time</a><a name="bookmark1126">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1127">Considering our model is accessible in a browser running on a PC or a mobile phone, we would want to pay careful attention to the UX, especially on the slowest hardware. During our benchmarking process, we ran </a><i>chapter10/code/benchmark.html </i><a href="#bookmark1128" class="s63">within various browsers on different devices. </a><span style=" color: #8E0012;">Figure 10-18 </span>presents the results of these experiments.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 28pt;text-indent: 0pt;text-align: left;"><span><img width="555" height="327" alt="image" src="KerasTensorFlow2019/Image_646.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a name="bookmark1128">Figure 10-18. Inference time for MobileNetV1 in Chrome on different devices</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Figure 10-18 <span style=" color: #000;">implies the faster the hardware, the faster the model inference. Apple appears to be outdoing Android in terms of GPU performance. Though, clearly, it is not an “apples-to-apples comparison.”</span></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1129" class="s63">Out of curiosity, do different browsers run inference at the same speed? Let’s find that out on an iPhone X; </a>Figure 10-19 <span style=" color: #000;">shows the results.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 17pt;text-indent: 0pt;text-align: left;"><span><img width="569" height="327" alt="image" src="KerasTensorFlow2019/Image_647.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1129">Figure 10-19. Inference time in different browsers on iPhone X</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><span style=" color: #8E0012;">Figure 10-19 </span>shows us the same speed in all browsers on an iPhone. This shouldn’t be surprising, because all of these browsers use iPhone’s WebKit-based built-in browser control called <span class="s47">WKWebView</span>. How about on a MacBook Pro? Take a look at</p><p class="s45" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Figure 10-20 <span style=" color: #000;">to see.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 17pt;text-indent: 0pt;text-align: left;"><span><img width="569" height="327" alt="image" src="KerasTensorFlow2019/Image_648.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 14pt;text-indent: 0pt;text-align: left;"><a name="bookmark1130">Figure 10-20. Inference time in different browsers on an i7 @ 2.6 GHz macOS</a></p><p class="s50" style="padding-top: 1pt;padding-left: 186pt;text-indent: 0pt;text-align: left;">10.14 machine</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The results might be surprising. Chrome is almost double the speed of Firefox in this example. Why is that? Opening a GPU monitor showed that Chrome had much higher GPU utilization compared to Firefox and slightly higher than Safari. The higher the utilization, the faster the inference. What this means is that depending on the operating system, browsers might have different optimizations to speed up the inference on the GPU, leading to different running times.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">One key point to note is that these tests were performed on top-of- the-line devices. They do not necessarily reflect the kind of device an average user might have. This also has implications for battery usage, if run for prolonged periods of time. Accordingly, we need to set appropriate expectations regarding performance, particularly for real-time user experiences.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1058">Case Studies</a><a name="bookmark1131">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1132">Now that we know all the ingredients for deep learning on the browser, let’s see what the industry is cooking.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1059">Semi-Conductor</a><a name="bookmark1133">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://oreil.ly/sNOFg" class="s63" target="_blank" name="bookmark1134">Have you ever dreamed of conducting the New York Philharmonic Orchestra? With </a>Semi-Conductor<span style=" color: #000;">, your dream is half-way fulfilled. Open the website, stand in front of the webcam, wave your arms, and watch the entire orchestra perform Mozart’s Eine Kleine Nachtmusik at your whim! As you might have guessed, it’s using PoseNet to track the arm movements and using those movements to set the tempo, volume, and the section of instruments</span></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1135" class="s63">(</a>Figure 10-21<span style=" color: #000;">) playing the music (including violins, violas, cellos, and double bass). Built by the Google Creative Lab in Sydney, Australia, it uses a prerecorded musical piece broken up into tiny fragments, and each fragment is played at the scored speed and volume depending on the arm movements. Moving hands up increases volume, moving faster increases tempo. This interactive experience is possible only because PoseNet is able to run inferences at several frames a second (on a regular laptop).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="590" height="408" alt="image" src="KerasTensorFlow2019/Image_649.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 191pt;text-indent: -181pt;line-height: 108%;text-align: left;"><a name="bookmark1135">Figure 10-21. Control an orchestra by waving your arms on the Semi-Conductor demonstrator</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1060">TensorSpace</a><a name="bookmark1136">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://tensorspace.org/" class="s63" target="_blank" name="bookmark1137">CNNs can often feel…well, convoluted. Often treated as a black box, they can be difficult to understand. What do the filters look like? What activates them? Why did they make a certain prediction? They are shrouded in mystery. As with anything complex, visualizations can help open this black box and make it easier to understand. And that’s where </a>TensorSpace<span style=" color: #000;">, the library that “presents tensors in space,” comes in.</span></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1138" class="s63">It allows us to load models in 3D space, explore their structures in the browser, zoom and rotate through them, feed inputs, and understand how the image is processed and passed layer by layer all the way to the final prediction layer. The filters can finally be opened up to manual inspection without the need for any installation. And, as </a>Figure 10-22 <span style=" color: #000;">teases, if you’re feeling savvy, you could even load this in virtual reality against any background!</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="590" height="336" alt="image" src="KerasTensorFlow2019/Image_650.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1138">Figure 10-22. LeNet model visualized inside TensorSpace</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1061">Metacar</a><a name="bookmark1139">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://metacar-project.com/" class="s63" target="_blank" name="bookmark1140">Self-driving cars are a complex beast. And using reinforcement learning to train them can take a lot of time, money, and monkeywrenching (not counting the crashes, initially). What if we could train them in the browser itself? </a>Metacar <a href="#bookmark1141" class="s63">solves this by providing a simulated 2D environment to train toy cars with reinforcement learning, all in the browser, as depicted in </a><a href="#bookmark1141" class="s44">Figure 10-</a></p><ol id="l26"><li><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1861" class="s63">Just as with video games you progress to ever-more difficult levels, Metacar allows building multiple levels to improve the performance of your car. Utilizing TensorFlow.js, this is aimed at making reinforcement learning more accessible (in which we dive into greater detail in </a>Chapter 17 <span style=" color: #000;">while building a small-scale autonomous car).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="470" alt="image" src="KerasTensorFlow2019/Image_651.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 24pt;text-indent: 0pt;text-align: left;"><a name="bookmark1141">Figure 10-23. Metacar environment for training with reinforcement learning</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1062">Airbnb’s Photo Classification</a><a name="bookmark1142">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1143">Airbnb, the online property rental company, requires homeowners and renters to upload pictures of themselves for their profiles.</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Unfortunately, a few people try to find the most readily available picture they have — their driver’s license or passport. Given the confidential nature of the information, Airbnb uses a neural network running on TensorFlow.js to detect sensitive images and prevent their upload to the server.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1063">GAN Lab</a><a name="bookmark1144">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://oreil.ly/vTpmu" class="s63" target="_blank" name="bookmark1145">Similar to </a>TensorFlow Playground <a href="https://oreil.ly/aQgga" class="s63" target="_blank">(an in-browser neural network visualization tool), </a>GAN Lab <a href="#bookmark1148" class="s63">(</a>Figure 10-24<span style=" color: #000;">) is an elegant visualization tool for understanding GANs using TensorFlow.js.</span></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1146">Visualizing GANs is a difficult process, so to simplify it, GAN Lab attempts to learn simple distributions and visualizes the generator and discriminator network output. For instance, the real distribution could be points representing a circle in 2D space. The generator starts from a random Gaussian distribution and gradually tries to generate the original distribution. This project is a collaboration between Georgia Tech and Google Brain/PAIR (People + AI Research).</a><a name="bookmark1147">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="596" height="314" alt="image" src="KerasTensorFlow2019/Image_652.jpg"/></span></p><p class="s50" style="padding-top: 6pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1148">Figure 10-24. Screenshot of GAN Lab</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1064">Summary</a><a name="bookmark1149">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We first examined the evolution of JavaScript-based deep learning libraries and chose TensorFlow.js as the candidate to focus on. We ran pretrained models in real time on the webcam feed, and then even trained models in the browser. Tools like Chrome’s profiler gave us insight into GPU usage. Then, to simplify development further, we used ml5.js, which enabled us to build demos like PoseNet and pix2pix in just a few lines of code. Finally, we benchmarked the performance of these models and libraries in the real world, ending with some interesting case studies.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1150">One huge benefit of running neural networks in the browser is the vast reach that browsers have compared to any smartphone platform. Add to that the advantage of not having to overcome the user’s reluctance to install yet another app. This also makes for a quick prototyping platform that enables inexpensive validation of hypotheses before investing significant amounts of time and money to build native experiences. TensorFlow.js, in conjunction with ml5.js, has accelerated the process of bringing the power of AI to the browser and broaden its reach to the masses.</a></p><p class="s141" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1151">Chapter 11. Real-Time Object Classification on iOS with Core ML</a><a name="bookmark1183">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="596" height="1" alt="image" src="KerasTensorFlow2019/Image_653.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1184">So far, we have seen our deep learning models running on the desktop, the cloud, and the browser. Although there are definite upsides to such a setup, it might not be ideal for all scenarios. In this chapter, we explore making predictions using deep learning models on mobile devices.</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1185">Bringing the computation closer to the user’s device, rather than a distant remote server, can be advantageous for many reasons:</a></p><p class="s142" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Latency and interactivity</p><p class="s12" style="padding-top: 4pt;padding-left: 31pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark1186">Sending an image, processing it in the cloud, and returning the result can take several seconds depending on the network quality and quantity of data being transferred. This can make for a poor UX. Decades of UX research, including Jakob Nielsen’s findings in 1993, published in his book </a><i>Usability Engineering </i>(Elsevier), showed the following:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_654.png"/></span></p><p class="s12" style="padding-top: 4pt;padding-left: 57pt;text-indent: 0pt;line-height: 107%;text-align: left;">0.1 second is about the limit for having the user feel that the system is reacting instantaneously.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_655.png"/></span></p><p class="s12" style="padding-left: 57pt;text-indent: 0pt;line-height: 107%;text-align: left;">1 second is about the limit for the user’s flow of thought to stay uninterrupted.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_656.png"/></span></p><p class="s12" style="padding-left: 57pt;text-indent: 0pt;line-height: 107%;text-align: left;">10 seconds is about the limit for keeping the user’s attention focused.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;line-height: 107%;text-align: left;">About two decades later, Google published findings that half of all mobile browser users abandon a web page if it takes longer than three seconds to load. Forget three seconds, even a 100 ms increase in latency would result in a 1% decrease in sales for Amazon. That is a lot of lost revenue. Mitigating this by processing on the device instantaneously can make for rich and interactive UXs. Running deep learning models in real time, as is done with Snapchat Lenses, can increase engagement with users.</p><p class="s142" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">24/7 availability and reduced cloud costs</p><p class="s12" style="padding-top: 4pt;padding-left: 31pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark1187">Obviously, sending less data to the cloud equates to less computing costs for the developer, leading to monetary savings. This reduces scaling costs, as well, when an app gains traction and grows to a large user base. For the users, computation on the edge is helpful, too, because they don’t need to worry about data plan costs. Additionally, processing locally means 24/7 availability, without the fear of losing connectivity.</a></p><p class="s142" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Privacy</p><p class="s12" style="padding-top: 3pt;padding-left: 31pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark1188">For the user, local computation preserves privacy by not sharing the data externally, which could potentially be mined for user information. For the developer, this ensures less headache dealing with Personally Identifiable Information (PII). With the European Union’s General Data Protection Regulation (GDPR) and other user data protection laws coming up around the world, this becomes even more important.</a></p><p class="s12" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1189">Hopefully, these arguments were convincing for why AI on mobile is important. For someone building any kind of serious application, the following are a few common questions to consider during the course of development:</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_657.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_658.png"/></span></p><p class="s12" style="padding-top: 4pt;padding-left: 31pt;text-indent: 0pt;line-height: 191%;text-align: left;">How do I convert my model to run on a smartphone? Will my model run on other platforms?</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_659.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">How do I run my model fast?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_660.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">How do I minimize the size of the app?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_661.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">How do I ensure that my app doesn’t drain the battery?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_662.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">How do I update my model without going through the roughly two-day app review process?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_663.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_664.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;line-height: 191%;text-align: left;">How do I A/B test my models? Can I train a model on a device?</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_665.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">How do I protect my intellectual property (i.e., model) from being stolen?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In the next three chapters, we look at how to run deep learning algorithms on smartphones using different frameworks. In the process, we answer these questions as they come up.</p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1192" class="s160">In this chapter, we delve into the world of mobile AI for iOS devices. We first look at the general end-to-end software life cycle (shown in </a>Figure 11-1<span style=" color: #000;">) and see how the different parts fit in with one another. We explore the Core ML ecosystem, its history, and the features offered. Next, we deploy a real-time object classification app on an iOS device, and learn performance optimizations and benchmarks. And finally, we analyze some real-world apps built on Core ML.</span></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Time to look at the big picture.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s144" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1152">The Development Life Cycle for Artificial Intelligence on Mobile</a><a name="bookmark1190">&zwnj;</a></p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1192" class="s143" name="bookmark1191">Figure 11-1</a> <span style=" color: #000;">depicts the typical life cycle for AI on mobile devices.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 53pt;text-indent: 0pt;text-align: left;"><span><img width="470" height="383" alt="image" src="KerasTensorFlow2019/Image_666.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1192">Figure 11-1. The mobile AI development life cycle</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s148" style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1192" class="s160">Let’s look at the phases in </a>Figure 11-1 <span style=" color: #000;">a bit more closely:</span></p><ol id="l27"><li><p class="s142" style="padding-top: 6pt;padding-left: 50pt;text-indent: -14pt;text-align: left;">Collect data<span class="s12">: The data we collect should reflect the context in which the app would be used. Pictures taken by real users using smartphone cameras tend to be better training examples than pictures taken by professional photographers. We might not have this data on day one, but we can progressively collect more and more data as usage grows. A good starting point in many cases is to download images from search engines.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s142" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Label data<span class="s12">: We need associated labels for the data samples that we want our model to predict. High-quality (i.e., correct) labels are vital to a good model.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s142" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Train model<span class="s12">: We build the highest-accuracy neural network possible with the data and associated labels we have so far.</span></p></li><li><p class="s142" style="padding-top: 3pt;padding-left: 50pt;text-indent: -14pt;text-align: left;">Convert model<span class="s12">: Export the model from the training framework into the mobile-compatible framework.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s142" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Optimize performance<span class="s12">: Due to the resource-constrained nature of a mobile device, it is crucial to make the model efficient for memory, energy, and processor usage.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s142" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Deploy<span class="s12">: Add the model to the app and ship it to users.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s142" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Monitor<span class="s12">: Track the app usage in the real world to find opportunities to improve further. Additionally, gather samples of real-word data from consenting users to feed to this life cycle, and then back to Step 1.</span></p></li></ol></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="539" height="194" alt="image" src="KerasTensorFlow2019/Image_667.png"/></span></p><p class="s146" style="padding-top: 9pt;padding-left: 183pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s147" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 106%;text-align: left;">Before getting the app in the hands of real users (who might hate it if the app doesn’t perform as well as they expected), it’s common practice to gather feedback through a process called dogfooding. As the saying goes: Eat Your Own Dog Food. The process involves having an inner circle of loyal users who get to test early releases, thereby identifying bugs before they go out to the general public. For AI development, this inner circle might also contribute data and assess the success of the AI models in the real world. And as the models improve, they can be deployed to a gradually increasing number of test users before finally deploying to the public.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s12" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In the first portion of the book, we primarily explored phases 1, 2, and 3, and additionally general performance improvements. In this chapter, we focus on phases 4, 5, and 6. And in the next few chapters, we explore all of these phases in the context of mobile development.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Let’s jump right in!</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s144" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1153">A Brief History of Core ML</a><a name="bookmark1193">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1194">Core ML provides one of the simplest ways to run a deep neural network for inference on an Apple device such as the iPhone and iPad as well as MacBook, Apple TV, and Apple Watch. In addition to being easy to use, it is also optimized for the underlying hardware architecture. Alternative frameworks have become a lot better in the past few years, but it’s difficult to beat the simplicity and performance offered by Core ML.</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Traditionally, to quickly run a CNN on an Apple device, developers <i>needed </i>to write on Metal, a library that was offered to game developers to better utilize the GPU. Unfortunately, developing on Metal was akin to writing in assembly language or CUDA code for an NVIDIA GPU. It was tedious, error prone, and difficult to debug. Few developers dared to tread that path. DeepLearningKit (December 2015) by Amund Tveit was one effort to build an abstraction over Metal for deploying CNNs.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">At the Apple Worldwide Developers Conference (WWDC) 2016, the company announced Metal Performance Shaders (MPS), a framework built on top of Metal, as a high-performance library for optimizing graphics and certain compute operations. It abstracted away a lot of low-level details, giving basic building blocks such as Convolution, Pooling, and ReLU. It allowed developers to write deep neural networks by combining these operations in code. For anyone who comes from the Keras world, this is a familiar and not- so-daunting task. Unfortunately, there is a lot of bookkeeping involved when writing MPS code, because you need to manually keep track of input and output dimensions at each step of the process. As an example, the code sample released by Apple for running the InceptionV3 model for recognizing 1,000 object categories was well over 2,000 lines long, with most of them defining the network. Now imagine changing the model slightly during training, and then having to dig through all 2,000 lines of code to reflect the same update in iOS code. Forge (April 2017), a library by Matthijs Hollemans, was an effort to simplify development over MPS by reducing the boilerplate code necessary to get a model running.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">All of these hardships went away when Apple announced Core ML at WWDC 2017. This included an inference engine on iOS and an open source Python package called Core ML Tools to serialize CNN models from other frameworks like Keras and Caffe. The general workflow for building an app was: train a model in other packages, convert it to a <i>.mlmodel </i>file, and deploy it in an iOS app running on the Core ML platform.</p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1195" class="s160">Core ML supports importing a broad range of machine learning models built with first- and third-party frameworks and file formats. </a>Figure 11-2 <span style=" color: #000;">showcases a few of them (clockwise, starting in the upper left) such as TensorFlow,</span></p><p class="s12" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Keras, ONNX, scikit-learn, Caffe2, Apple’s Create ML, LIBSVM, and TuriCreate (also from Apple). ONNX itself supports a large variety of frameworks, including PyTorch (Facebook), MXNet (Amazon), Cognitive Toolkit (Microsoft), PaddlePaddle (Baidu), and more, thereby ensuring compatibility with any major framework under the sky.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 35pt;text-indent: 0pt;text-align: left;"><span><img width="518" height="284" alt="image" src="KerasTensorFlow2019/Image_668.jpg"/></span></p><p class="s145" style="padding-top: 3pt;padding-left: 29pt;text-indent: 0pt;text-align: left;"><a name="bookmark1195">Figure 11-2. Frameworks compatible with Core ML for model interchange as of 2019</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s144" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1154">Alternatives to Core ML</a><a name="bookmark1196">&zwnj;</a></p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1198" class="s160" name="bookmark1197">Depending on the platform, there are a handful of options to achieve real-time predictions. These include general-purpose inference frameworks such as Core ML (from Apple), TensorFlow Lite (from Google), ML Kit (also from Google), and Fritz, as well as chip-specific accelerator frameworks including Snapdragon Neural Processing Engine (from Qualcomm) and Huawei AI Mobile Computing Platform (for Huawei’s Neural Processing Unit). </a>Table 11-1 <span style=" color: #000;">presents a high-level comparison of all these frameworks.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s142" style="padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1198">Table 11-1. A comparison of mobile device AI frameworks</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:6.47167pt" cellspacing="0"><tr style="height:31pt"><td style="width:199pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Framework Available Available for</p><p class="s149" style="padding-left: 66pt;text-indent: 0pt;text-align: left;">for iOS Android</p></td><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 6pt;padding-right: 9pt;text-indent: 0pt;line-height: 106%;text-align: left;">Dynamic updates</p></td><td style="width:48pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 9pt;padding-right: 3pt;text-indent: 0pt;line-height: 106%;text-align: left;">A/B testing</p></td><td style="width:64pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;padding-right: 8pt;text-indent: 0pt;line-height: 106%;text-align: left;">On-device training</p></td><td style="width:70pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 8pt;padding-right: 7pt;text-indent: 0pt;line-height: 106%;text-align: left;">Model encryption</p></td></tr><tr style="height:20pt"><td style="width:199pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Core ML <span class="s151">✓ </span>—</p></td><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s151" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">✓</p></td><td style="width:48pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">—</p></td><td style="width:64pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s151" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">✓</p></td><td style="width:70pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 4pt;padding-left: 8pt;text-indent: 0pt;text-align: left;">—</p></td></tr><tr style="height:33pt"><td style="width:199pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">TensorFlow <span class="s151">✓ ✓</span></p><p class="s150" style="padding-left: 3pt;text-indent: 0pt;text-align: left;">Lite</p></td><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">—</p></td><td style="width:48pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">—</p></td><td style="width:64pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 4pt;padding-left: 3pt;padding-right: 15pt;text-indent: 0pt;line-height: 106%;text-align: left;">Releases late 2019</p></td><td style="width:70pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 4pt;padding-left: 8pt;text-indent: 0pt;text-align: left;">—</p></td></tr><tr style="height:20pt"><td style="width:199pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">ML Kit <span class="s151">✓ ✓</span></p></td><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s151" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">✓</p></td><td style="width:48pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s151" style="padding-top: 2pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">✓</p></td><td style="width:64pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 4pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">—</p></td><td style="width:70pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 4pt;padding-left: 8pt;text-indent: 0pt;text-align: left;">—</p></td></tr><tr style="height:20pt"><td style="width:199pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Fritz <span class="s151">✓ ✓</span></p></td><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s151" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">✓</p></td><td style="width:48pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s151" style="padding-top: 2pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">✓</p></td><td style="width:64pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 4pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">—</p></td><td style="width:70pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s151" style="padding-top: 2pt;padding-left: 8pt;text-indent: 0pt;text-align: left;">✓</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1155">TensorFlow Lite</a><a name="bookmark1199">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1200">In November 2017, Google announced an on-device inference engine called TensorFlow Lite with the intention of extending the TensorFlow ecosystem beyond just servers and PCs. Prior to this, the options within the TensorFlow ecosystem were porting the entire TensorFlow library, itself ported to iOS (which was heavy and slow), and later on, its slightly stripped-down version called TensorFlow Mobile (which was still pretty bulky).</a></p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1389" class="s160">TensorFlow Lite was rebuilt from the ground up targeting mobile and edge devices, optimizing for speed, model and interpreter size, and power consumption. It added support for GPU backend delegates, meaning that as long as there was GPU support implemented for a hardware platform, TensorFlow Lite could take advantage of the power of the GPU. On iOS, the GPU delegate uses Metal for acceleration. We discuss TensorFlow Lite at greater length in </a>Chapter 13<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1156">ML Kit</a><a name="bookmark1201">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1202">ML Kit is a high-level library from Google that provides many computer vision, NLP, and AI functionalities out of the box, including the ability to run TensorFlow Lite models. Some of the features include face detection, barcode scanning, smart reply, on-device translation, and language identification.</a></p><p class="s148" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1389" class="s160">However, the main selling point of ML Kit is its integration with Google Firebase. Features offered by Firebase include dynamic model updates, A/B testing, and remote configuration-driven dynamic model selection (fancy words for choosing which model to use based on the customer). We explore ML Kit in greater detail in </a><a href="#bookmark1389" class="s143">Chapter </a>13<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1157">Fritz</a><a name="bookmark1203">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1204">Fritz is a startup founded with the goal of making the end-to-end process of mobile inference easier. It bridges the gap between machine learning practitioners and mobile engineers by providing easy-to-use command-line tools. On one side, it integrates training in Keras directly into the deployment pipeline, so a machine learning engineer could add a single line of Keras callback to deploy the model to users immediately after it finishes training. On the other side, a mobile engineer can benchmark the model without even needing to deploy to a physical device, simulating a model’s performance virtually, assess a Keras model’s compatibility with Core ML, and get analytics for each model. One unique selling point of Fritz is the model protection feature that prevents a model from deep inspection through obfuscation in the event that a phone is jailbroken.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s144" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1158">Apple’s Machine Learning Architecture</a><a name="bookmark1205">&zwnj;</a></p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1207" class="s160" name="bookmark1206">To gain a better understanding of the Core ML ecosystem, it’s useful to see the high-level picture of all the different APIs that Apple offers as well as how they fit with one another. </a>Figure 11-3 <span style=" color: #000;">gives us a look at the different components that make up Apple’s machine learning architecture.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 42pt;text-indent: 0pt;text-align: left;"><span><img width="488" height="219" alt="image" src="KerasTensorFlow2019/Image_669.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1207">Figure 11-3. Different levels of APIs provided by Apple for app developers</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1159">Domain-Based Frameworks</a><a name="bookmark1208">&zwnj;</a></p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1209" class="s160">To simplify common tasks in machine learning without requiring domain expertise, Apple provides many APIs out of the box, in domains including Vision, Natural Language, Speech, and Sound Analysis. </a>Table 11-2 <span style=" color: #000;">gives a detailed outline of the functionalities available on Apple operating systems.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s142" style="padding-left: 204pt;text-indent: -190pt;text-align: left;"><a name="bookmark1209">Table 11-2. Out-of-the-box machine learning functionality in Apple operating systems</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="596" height="1" alt="image" src="KerasTensorFlow2019/Image_670.png"/></span></p><p class="s153" style="padding-top: 1pt;padding-bottom: 3pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Vision Natural language Other</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="596" height="1" alt="image" src="KerasTensorFlow2019/Image_671.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_672.png"/></span></p><p class="s147" style="padding-top: 3pt;padding-left: 35pt;text-indent: 0pt;line-height: 106%;text-align: left;">Facial landmark detection</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_673.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_674.png"/></span></p><p class="s147" style="padding-left: 35pt;text-indent: 0pt;line-height: 190%;text-align: left;">Image similarity Saliency detection</p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_675.png"/></span></p><p class="s147" style="padding-left: 35pt;text-indent: 0pt;line-height: 106%;text-align: left;">Optical character recognition</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_676.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_677.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_678.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_679.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_680.png"/></span></p><p class="s147" style="padding-left: 35pt;text-indent: 0pt;line-height: 193%;text-align: left;">Rectangle detection Face detection Object classification Barcode detection Horizon detection</p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_681.png"/></span></p><p class="s147" style="padding-left: 35pt;text-indent: 0pt;line-height: 106%;text-align: left;">Human and animal detection</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_682.png"/></span></p><p class="s147" style="padding-left: 35pt;text-indent: 0pt;line-height: 106%;text-align: left;">Object tracking (for video)</p><p class="s147" style="padding-top: 3pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">Tokenization</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_683.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_684.png"/></span></p><p class="s147" style="padding-left: 31pt;text-indent: 0pt;line-height: 106%;text-align: left;">Language identification</p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_685.png"/></span></p><p class="s147" style="padding-top: 10pt;padding-left: 31pt;text-indent: 0pt;line-height: 106%;text-align: left;">Parts of speech identification</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_686.png"/></span></p><p class="s147" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">Text embedding</p><p class="s147" style="padding-top: 3pt;padding-left: 35pt;text-indent: 0pt;line-height: 106%;text-align: left;">Speech recognition (on-device and on-cloud)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_687.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_688.png"/></span></p><p class="s147" style="padding-left: 35pt;text-indent: 0pt;text-align: left;">Sound classification</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="580" height="1" alt="image" src="KerasTensorFlow2019/Image_689.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1160">ML Framework</a><a name="bookmark1210">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Core ML gives the ability to run inference on deep learning and machine learning models.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1161">ML Performance Primitives</a><a name="bookmark1211">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">The following are some of the machine learning primitives in the Apple stack:</p><p class="s142" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">MPS</p><p class="s12" style="padding-top: 4pt;padding-left: 31pt;text-indent: 0pt;line-height: 107%;text-align: left;">Provides low-level and high-performance primitives that utilize the GPU to aid running most CNN-based networks fast. And if Core ML does not support a model, MPS provides all of the building blocks to enable us to build them. Additionally, we might consider using MPS to hand roll a model for performance reasons (like guaranteeing that the model runs on the GPU).</p><p class="s142" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Accelerate and Basic Neural Network Subroutine</p><p class="s12" style="padding-top: 4pt;padding-left: 31pt;text-indent: 0pt;line-height: 107%;text-align: left;">Accelerate is Apple’s implementation of the Basic Linear Algebra Subprogram (BLAS) library. It provides functionality for high-performance large-scale mathematical computations and image calculations, like Basic Neural Network Subroutine (BNNS), which helps to implement and run neural networks.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="539" height="183" alt="image" src="KerasTensorFlow2019/Image_690.png"/></span></p><p class="s146" style="padding-top: 9pt;padding-left: 183pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s162" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 106%;text-align: left;"><a href="#bookmark1214" style=" color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10.5pt;">Apple provides several downloadable models (</a>Figure 11-4<a href="https://developer.apple.com/machine-learning/models" style=" color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10.5pt;" target="_blank">) for various computer- vision tasks, from classification to detecting objects (with bounding boxes), segmenting (identifying the pixels), depth estimation, and more. You can find them at </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 10.5pt;">https://developer.apple.com/machine-learning/models/</span><span style=" color: #000;">.</span></p><p class="s147" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 106%;text-align: left;"><a name="bookmark1212">For classification, you can find many pretrained Core ML models on Apple’s Machine Learning website, including MobileNet, SqueezeNet, ResNet-50, and VGG16.</a><a name="bookmark1213">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"/><p class="s12" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Now that we have seen how Core ML and the domain-specific APIs fit into the overall architecture, let’s see how little work is needed to run a machine learning model using Core ML and the Vision framework on an iOS app.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 35pt;text-indent: 0pt;text-align: left;"><span><img width="517" height="495" alt="image" src="KerasTensorFlow2019/Image_691.jpg"/></span></p><p class="s145" style="padding-top: 2pt;padding-left: 47pt;text-indent: 0pt;text-align: left;"><a name="bookmark1214">Figure 11-4. Ready-to-use models from the Apple Machine Learning website</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s144" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1162">Building a Real-Time Object Recognition App</a><a name="bookmark1215">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1216">Although we don’t intend to teach iOS development, we want to demonstrate running an object recognition model that classifies among 1,000 ImageNet categories in real time on an iOS device.</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We will examine the minimal amount of code necessary to get this app running. The general outline is as follows:</p><ol id="l28"><li><p class="s12" style="padding-top: 4pt;padding-left: 50pt;text-indent: -14pt;text-align: left;">Drag and drop an <i>.mlmodel </i>file to the Xcode project.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Load the model into a Vision container (<span class="s156">VNCoreMLModel</span>).</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Create a request (<span class="s156">VNCoreMLRequest</span>) based on that container and provide a function that would be called when the request is completed.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Create a request handler that can process the request based on an image provided.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Execute the request and print out the results.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Let’s take a look at the code to do this:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s77" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">import <span style=" color: #00AA87;">CoreML </span>import <span style=" color: #00AA87;">Vision</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s128" style="padding-left: 19pt;text-indent: 0pt;line-height: 10pt;text-align: left;">// load the model</p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;line-height: 10pt;text-align: left;"><span class="s77">let </span>model = <span class="s77">try</span>? <span style=" color: #000087;">VNCoreMLModel</span>(<span class="s77">for</span>: <span style=" color: #000087;">Resnet5O</span>().<span style=" color: #000087;">model</span>)!</p><p class="s128" style="padding-left: 19pt;text-indent: 0pt;line-height: 10pt;text-align: left;">// create a request with a callback</p><p class="s75" style="padding-left: 39pt;text-indent: -20pt;text-align: left;"><span class="s77">let </span>classificationRequest = <span style=" color: #000087;">VNCoreMLRequest</span>(<span style=" color: #000087;">model</span>: <span style=" color: #000087;">model</span>) { (<span style=" color: #000087;">request</span>, <span style=" color: #000087;">error</span>) <span class="s77">in</span></p><p class="s128" style="padding-left: 39pt;text-indent: 0pt;line-height: 10pt;text-align: left;">// print the results once the request is complete</p><p class="s75" style="padding-left: 39pt;text-indent: 0pt;line-height: 10pt;text-align: left;"><span class="s77">if let </span>observations = <span style=" color: #000087;">request</span>.<span style=" color: #000087;">results </span><span class="s77">as</span>? [<span style=" color: #000087;">VNClassificationObservation</span>] {</p><p class="s77" style="padding-left: 59pt;text-indent: 0pt;line-height: 10pt;text-align: left;">let <span class="s75">results = </span><span class="s74">observations</span></p><p class="s75" style="padding-left: 131pt;text-indent: 0pt;line-height: 10pt;text-align: left;">.<span style=" color: #366;">map</span>{<span style=" color: #C30;">&quot;</span><span style=" color: #A00;">\(</span>$O.<span style=" color: #000087;">identifier</span><span style=" color: #A00;">) </span><span style=" color: #C30;">- </span><span style=" color: #A00;">\(</span>$O.<span style=" color: #000087;">confidence</span><span style=" color: #A00;">)</span><span style=" color: #C30;">&quot;</span>}</p><p class="s75" style="padding-left: 131pt;text-indent: 0pt;line-height: 10pt;text-align: left;">.<span style=" color: #000087;">joined</span>(<span style=" color: #000087;">separator</span>: <span style=" color: #C30;">&quot;</span><span class="s159">\n</span><span style=" color: #C30;">&quot;</span>)</p><p class="s75" style="padding-left: 59pt;text-indent: 0pt;line-height: 10pt;text-align: left;"><span style=" color: #366;">print</span>(<span style=" color: #000087;">results</span>)</p><p class="s75" style="padding-left: 39pt;text-indent: 0pt;line-height: 10pt;text-align: left;">}</p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;line-height: 10pt;text-align: left;">}</p><p class="s128" style="padding-left: 19pt;text-indent: 0pt;line-height: 10pt;text-align: left;">// create a request handler taking an image as an argument</p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;line-height: 10pt;text-align: left;"><span class="s77">let </span>requestHandler = <span style=" color: #000087;">VNImageRequestHandler</span>(<span style=" color: #000087;">cgImage</span>: <span style=" color: #000087;">cgImage</span>)</p><p class="s128" style="padding-left: 19pt;text-indent: 0pt;line-height: 10pt;text-align: left;">// execute the request</p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;line-height: 10pt;text-align: left;"><span class="s77">try</span>? <span style=" color: #000087;">requestHandler</span>.<span style=" color: #000087;">perform</span>([<span style=" color: #000087;">classificationRequest</span>])</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 121%;text-align: left;">In this code, <span class="s156">cgImage </span>can be an image from a variety of sources. It can be a photo from the photo library, or from the web.</p><p class="s12" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We can also power real-time scenarios using the camera and pass the individual camera frames into this function. A regular iPhone camera can shoot up to 60 frames per second (FPS).</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;">By default, Core ML crops the image along the longer edge. In other words, if a model requires square dimensions, Core ML will extract the biggest square in the center of the image. This can be a source of confusion for developers</p><p class="s12" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">who find the top and bottom strips of an image are being ignored for making predictions. Depending on the scenario, we might want to use <span class="s156">.centerCrop</span>,</p><p class="s156" style="padding-top: 1pt;padding-left: 6pt;text-indent: 0pt;line-height: 121%;text-align: left;">.scaleFit<span class="s12">, or the </span>.scaleFill <a href="#bookmark1217" class="s160">option, as illustrated in </a><span class="s148">Figure 11-5</span><span class="s12">, such as the following:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">classificationRequest.imageCropAndScaleOption = .scaleFill</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 35pt;text-indent: 0pt;text-align: left;"><span><img width="513" height="645" alt="image" src="KerasTensorFlow2019/Image_692.jpg"/></span></p><p class="s145" style="padding-top: 4pt;padding-left: 28pt;text-indent: 0pt;text-align: left;"><a name="bookmark1217">Figure 11-5. How different scaling options modify the input image to Core ML models</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s161" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s160" target="_blank">Now that we have gone through the meat of it, what could be more fun? How about actually running it on a phone! We’ve made a complete app available on the book’s GitHub website (see </a>http://PracticalDeepLearning.ai<span class="s12">) at</span></p><p class="s142" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;">code/chapter-11<span class="s12">. With an iPhone or an iPad, we can deploy this pretty quickly and experiment with it, even without knowledge of iOS development. Here are the steps (note: this requires a Mac):</span></p><ol id="l29"><li><p class="s12" style="padding-top: 4pt;padding-left: 50pt;text-indent: -14pt;text-align: justify;"><a name="bookmark1218">Download Xcode from the Apple developer website or the Mac App Store.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -14pt;text-align: justify;">Plug in an iOS device. The phone needs to remain unlocked during deployment.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Change the current working directory to <span class="s156">CameraApp</span>:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 63pt;text-indent: 0pt;text-align: left;">$ cd code/chapter-11/CameraApp</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-top: 5pt;padding-left: 50pt;text-indent: -14pt;text-align: left;">Download the Core ML models from the Apple website using the available Bash script:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 63pt;text-indent: 0pt;text-align: left;">$ ./download-coreml-models.sh</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-top: 5pt;padding-left: 50pt;text-indent: -14pt;text-align: left;">Open the Xcode project:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 63pt;text-indent: 0pt;text-align: left;">$ open CameraApp.xcodeproj</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s148" style="padding-top: 5pt;padding-left: 50pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1219" class="s160">In the Project Hierarchy Navigator, in the upper-left corner, click the CameraApp project, as shown in </a><a href="#bookmark1219" class="s143">Figure </a>11-6<span style=" color: #000;">, to open the Project Information view.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 58pt;text-indent: 0pt;text-align: left;"><span><img width="514" height="157" alt="image" src="KerasTensorFlow2019/Image_693.jpg"/></span></p><p class="s145" style="padding-top: 5pt;padding-left: 131pt;text-indent: 0pt;text-align: left;"><a name="bookmark1219">Figure 11-6. Project information view within Xcode</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-top: 9pt;padding-left: 50pt;text-indent: -14pt;text-align: left;">Because Xcode reserves a unique bundle identifier, use a unique name to identify the project.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s148" style="padding-left: 50pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1220" class="s160">Log in to an Apple account to let Xcode sign the app and deploy it to the device. Select a team to do the signing, as shown in </a><a href="#bookmark1220" class="s143">Figure </a>11-7<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 61pt;text-indent: 0pt;text-align: left;"><span><img width="509" height="195" alt="image" src="KerasTensorFlow2019/Image_694.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 52pt;text-indent: 0pt;text-align: center;"><a name="bookmark1220">Figure 11-7. Select a team and let Xcode automatically manage code signing</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s148" style="padding-top: 9pt;padding-left: 50pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1221" class="s160">Click the “Build and Run” button (the right-facing triangle) to deploy the app on the device, as shown in </a><a href="#bookmark1221" class="s143">Figure </a>11-8<span style=" color: #000;">. This should typically take around 30 to 60 seconds.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 58pt;text-indent: 0pt;text-align: left;"><span><img width="511" height="147" alt="image" src="KerasTensorFlow2019/Image_695.jpg"/></span></p><p class="s145" style="padding-top: 6pt;padding-left: 52pt;text-indent: 0pt;text-align: center;"><a name="bookmark1221">Figure 11-8. Select the device and click the “Build and Run” button to deploy the app</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-top: 9pt;padding-left: 50pt;text-indent: -21pt;text-align: left;">The device will not run the app right away, because it is not trusted. Go to Settings &gt; General &gt; Profiles and Device Management and select the row with your information on it, and then tap “Trust</p><p class="s148" style="padding-left: 50pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1222" class="s160">{your_email_id},” as shown in </a>Figure 11-9<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 58pt;text-indent: 0pt;text-align: left;"><span><img width="516" height="481" alt="image" src="KerasTensorFlow2019/Image_696.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 124pt;text-indent: 0pt;text-align: left;"><a name="bookmark1222">Figure 11-9. Profiles and Device Management screen</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-top: 9pt;padding-left: 50pt;text-indent: -20pt;text-align: left;">On the home screen, find CameraApp and run the app.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 61pt;text-indent: 0pt;text-align: left;"><span><img width="500" height="791" alt="image" src="KerasTensorFlow2019/Image_697.jpg"/></span></p><p class="s145" style="padding-top: 7pt;padding-left: 165pt;text-indent: 0pt;text-align: left;">Figure 11-10. Screenshot of the app</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 7pt;padding-left: 50pt;text-indent: 0pt;text-align: left;">The output shows predictions of “notebook, notebook computer” with 84% confidence and “laptop, laptop computer” with 11% confidence.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="539" height="144" alt="image" src="KerasTensorFlow2019/Image_698.png"/></span></p><p class="s146" style="padding-top: 9pt;padding-left: 183pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s147" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 108%;text-align: left;">A great thing about Xcode is that the model input and output parameters are shown when we load the <i>.mlmodel </i><a href="#bookmark1223" style=" color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10.5pt;">file into Xcode, as demonstrated in </a><a href="#bookmark1223" class="s154">Figure </a><span style=" color: #8E0012;">11-11</span>. This   is especially helpful when we have not trained the model ourselves and don’t necessarily want to write code (like <span class="s75">model.summary() </span>in Keras) to explore the model architecture.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s12" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">That was all fun and good. Let’s now get down to more serious business: converting models from different frameworks to Core ML models.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 35pt;text-indent: 0pt;text-align: left;"><span><img width="514" height="484" alt="image" src="KerasTensorFlow2019/Image_699.jpg"/></span></p><p class="s145" style="padding-top: 4pt;padding-left: 213pt;text-indent: -193pt;line-height: 106%;text-align: left;"><a name="bookmark1223">Figure 11-11. Xcode model inspector showing the inputs and outputs of the MobileNetV2 model</a><a name="bookmark1224">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s144" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1163">Conversion to Core ML</a><a name="bookmark1225">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1226">In the code sample we built, you saw the </a><i>Inceptionv3.mlmodel </i>file. Ever wonder how that file came to be? Inception was, after all, trained by Google using TensorFlow. That file was converted from a <i>.pb </i>file into a Core ML model. We might similarly have models that need to be converted from Keras, Caffe or any other framework to Core ML. The following are a few tools that enable model conversion to Core ML.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_700.png"/></span></p><p class="s12" style="padding-top: 4pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">Core ML Tools (Apple): from Keras (<i>.h5</i>), Caffe (<i>.caffemodel</i>), as well as machine learning libraries such as LIBSVM, scikit-learn, and XGBoost.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_701.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_702.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;line-height: 191%;text-align: left;">tf-coreml (Google): from TensorFlow (<i>.pb</i>). onnx-coreml (ONNX): from ONNX (<i>.onnx</i>).</p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">We take a look at the first two converters in detail.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1164">Conversion from Keras</a><a name="bookmark1227">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 115%;text-align: left;"><a name="bookmark1228">Core ML Tools aids the translation of Keras, ONNX, and other model formats to the Core ML format (</a><i>.mlmodel</i>). Install the <span class="s156">coremltools </span>framework using <span class="s156">pip</span>:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">$ pip install --upgrade coremltools</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Now, let’s see how we can use an existing Keras model and convert it to Core ML. The conversion is just a one-line command and then we can save the converted model, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s77" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">tensorflow.keras.applications.resnet50 </span>import <span class="s74">ResNet5O model </span><span class="s75">= </span><span class="s74">ResNet5O</span><span class="s75">()</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s77" style="padding-left: 19pt;text-indent: 0pt;line-height: 10pt;text-align: left;">import <span style=" color: #0CF;">coremltools</span></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">coreml_model </span>= <span style=" color: #000087;">coremltools</span>.<span style=" color: #000087;">converters</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">convert</span>(<span style=" color: #000087;">model</span>) <span style=" color: #000087;">coreml_model</span>.<span style=" color: #000087;">save</span>(<span style=" color: #C30;">&quot;resnet5O.mlmodel&quot;</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s148" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1295" class="s160">That’s it! It can’t get any simpler. We discuss how to convert models with unsupported layers (such as MobileNet) in </a>Chapter 12<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1165">Conversion from TensorFlow</a><a name="bookmark1229">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 114%;text-align: left;"><a name="bookmark1230">Apple recommends using </a><span class="s156">tf-coreml </span>(from Google) for converting from TensorFlow-based models. In the following steps, we convert a pretrained TensorFlow model to Core ML. This process is a bit more involved than the single line of code we saw earlier.</p><p class="s12" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">First, we perform the installation of <span class="s156">tfcoreml </span>using <span class="s156">pip</span>:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">$ pip install tfcoreml --user --upgrade</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://oreil.ly/hJoly" class="s160" target="_blank">To do the conversion, we need to know the first and last layers of the model. We can ascertain this by inspecting the model architecture using a model visualization tool like </a><span style=" color: #8E0012;">Netron</span>. After loading the MobileNet model (<i>.pb </i><a href="#bookmark1231" class="s160">file) in Netron, we can visualize the entire model in the graphical interface. </a><a href="#bookmark1231" class="s143">Figure 11- 12 </a>shows a small portion of the MobileNet model; in particular, the output layer.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 35pt;text-indent: 0pt;text-align: left;"><span><img width="517" height="323" alt="image" src="KerasTensorFlow2019/Image_703.jpg"/></span></p><p class="s145" style="padding-top: 3pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1231">Figure 11-12. Output layer of MobileNet as seen in Netron</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We simply need to plug that into the following Python code as an argument and run it:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s77" style="padding-left: 19pt;text-indent: 0pt;line-height: 10pt;text-align: left;">import <span style=" color: #0CF;">tfcoreml </span>as <span style=" color: #0CF;">tf_converter</span></p><p class="s75" style="padding-left: 44pt;text-indent: -25pt;text-align: left;"><span style=" color: #000087;">tf_converter</span>.<span style=" color: #000087;">convert</span>(<span style=" color: #000087;">tf_model_path </span>= <span style=" color: #C30;">&quot;input_model.pb&quot;</span>, <span style=" color: #000087;">mlmodel_path </span>= <span style=" color: #C30;">&quot;output_model.mlmodel&quot;</span>,</p><p class="s75" style="padding-left: 44pt;text-indent: 0pt;line-height: 10pt;text-align: left;"><span style=" color: #000087;">output_feature_names </span>= [<span style=" color: #C30;">&quot;MobilenetV1/Predictions/Reshape_1:O&quot;</span>])</p><p class="s12" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">As the script runs, we see each of the operations from each layer being converted to their corresponding Core ML equivalents. When finished, we should find the <i>.mlmodel </i>exported in the directory.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Our Core ML model is now ready. Drag it into Xcode to test it.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s144" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1166">Dynamic Model Deployment</a><a name="bookmark1232">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1233">As developers, we will likely want to keep improving our models over time. After all, we’d want our users to have access to the latest and greatest model as quickly as we can hand it to them. One way to handle that is to send an update to the App Store every time we want to deploy a new model. That approach does not work very well, because we’d need to wait about two days for Apple’s approval each time, potentially causing significant delays.</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">An alternate recommended approach would be to have the app dynamically download the <i>.mlmodel </i>file and compile it within the user’s device. There are several reasons why we might want to try this approach:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_704.png"/></span></p><p class="s12" style="padding-top: 4pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">We want to regularly update the model, independent of the cadence of our App Store releases.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_705.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">We want to keep the app download size small and have the user eventually download only the models relevant for their usage scenarios. This will reduce storage needs and bandwidth costs. Apple places a limit of 200 MB on App Store downloads via cellular networks, so it’s vital to remain under that limit to not lose out on potential downloads.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_706.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">We want to A/B test different models on different sets of users to further improve the quality of the model.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_707.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">We want to use different models for different user segments, regions, and locales.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;line-height: 114%;text-align: left;">The process to achieve this is rather simple: host the <i>.mlmodel </i>on a server and design our app to dynamically download the file. After the model is on the user’s device, we can run <span class="s156">MLModel.compileModel </span>on that file to generate a compiled version of the model:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;line-height: 10pt;text-align: left;"><span class="s77">let </span>compiledModelUrl = <span class="s77">try </span><span style=" color: #000087;">MLModel</span>.<span style=" color: #000087;">compileModel</span>(<span style=" color: #000087;">at</span>: <span style=" color: #000087;">downloadedModelUrl</span>)</p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;line-height: 10pt;text-align: left;"><span class="s77">let </span>model = <span class="s77">try </span><span style=" color: #000087;">MLModel</span>(<span style=" color: #000087;">contentsOf</span>: <span style=" color: #000087;">compiledModelUrl</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 115%;text-align: left;">Keep in mind that <span class="s156">compiledModelUrl </span>is an address to a temporary location. If you want to keep the model on the device longer beyond a session, you must move it to permanent storage.</p><p class="s146" style="padding-top: 9pt;padding-left: 183pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s162" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 106%;text-align: left;"><a href="#bookmark1389" style=" color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10.5pt;">Although we can manually do model management directly with Core ML, it would still involve writing a lot of boilerplate code, on the backend and on the device. We would need to manually manage the versions of each model, the file storage, and configuration infrastructure, as well as any errors in the process. This is where ML Kit and Fritz really shine by providing these features out of the box. We discuss this in more detail in </a><a href="#bookmark1389" class="s154">Chapter </a>13<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="539" height="159" alt="image" src="KerasTensorFlow2019/Image_708.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s144" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1167">On-Device Training</a><a name="bookmark1234">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1235">So far, we have looked at scenarios that would be served well by a “one size fits all” neural network. However, some use cases would simply not work without personalizing the models. An example would be an app that organizes a user’s photo gallery based on recognizing the faces of people in each picture. Given that an average user’s phone is mostly filled with pictures of friends and family, a generic model trained on Danny DeVito’s and Tom Hanks’s faces would not be very useful for users (unless, of course, they belong to the DeVito or Hanks families).</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">A real-life example would be on the iOS system keyboard, which learns a user’s language patterns over time and begins to give more and more relevant suggestions for that user. And this becomes even more evident when that person uses slang words, nicknames, domain-specific terms, and so on, which might not be part of the common language dictionary. Personalized suggestions based on such data would be useless for any other user.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In these cases, we want to collect the data for that user and train a personalized model for that individual only. One way to accomplish this would be to collect and send the data to the cloud, train a new model there, and send back the updated model to the user. This approach reeks of scalability, cost, and privacy issues.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 114%;text-align: left;">Instead, Core ML provides functionality for on-device training, so that user’s data never needs to leave the device. A Core ML model is updatable when its <span class="s156">isUpdatable </span>property is set to <span class="s156">true</span>. Additionally, the specific set of layers that need to be retrained (usually toward the tail end of the network) also need to have the same property set to <span class="s156">true</span>. Additional training parameters such as learning rate and optimizers can also be set on the model.</p><p class="s12" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 114%;text-align: left;"><a href="#bookmark1389" class="s160">Even though training can consume GPU and Neural Processor Unit (NPU; more on these in </a><span style=" color: #8E0012;">Chapter 13</span>) cycles, the training can be scheduled in the background (using the <span class="s156">BackgroundTasks </span>framework), even when the device is idle and charging, typically at night. This will have the least impact on UX.</p><p class="s12" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 114%;text-align: left;">To do on-device training, we can call the <span class="s156">MLUpdateTask </span>function, along with the new data with which we will be retraining the model. We would also need to pass in the path for the newly updated model in the function call. After training is complete, the model at that path is ready to go:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 18pt;text-indent: 0pt;line-height: 10pt;text-align: center;"><span class="s77">let </span>modelUrl = <span style=" color: #000087;">bundle</span>.<span style=" color: #000087;">url</span>(<span style=" color: #000087;">forResource</span>: <span style=" color: #C30;">&quot;MyClassifier&quot;</span>,</p><p class="s75" style="padding-left: 14pt;text-indent: 0pt;line-height: 10pt;text-align: center;"><span style=" color: #000087;">withExtension</span>: <span style=" color: #C30;">&quot;mlmodelc&quot;</span>)!</p><p class="s75" style="padding-left: 18pt;text-indent: 0pt;line-height: 10pt;text-align: center;"><span class="s77">let </span>updatedModelUrl = <span style=" color: #000087;">bundle</span>.<span style=" color: #000087;">url</span>(<span style=" color: #000087;">forResource</span>: <span style=" color: #C30;">&quot;MyClassifierUpdated&quot;</span>,</p><p class="s75" style="padding-left: 52pt;text-indent: 0pt;line-height: 10pt;text-align: center;"><span style=" color: #000087;">withExtension</span>: <span style=" color: #C30;">&quot;mlmodelc&quot;</span>)!</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 39pt;text-indent: -20pt;text-align: left;"><span class="s77">let </span>task = <span class="s77">try </span><span style=" color: #000087;">MLUpdateTask</span>( <span style=" color: #000087;">forModelAt</span>: <span style=" color: #000087;">modelUrl</span>,</p><p class="s75" style="padding-top: 4pt;padding-left: 39pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">trainingData</span>: <span style=" color: #000087;">trainData</span>, <span style=" color: #000087;">configuration</span>: <span class="s77">nil</span>,</p><p class="s75" style="padding-left: 70pt;text-indent: -30pt;text-align: left;"><span style=" color: #000087;">completionHandler</span>: { [<span class="s77">weak self</span>] (<span style=" color: #000087;">updateContext</span>) <span class="s77">in self</span>.<span style=" color: #000087;">model </span>= <span style=" color: #000087;">updateContext</span>.<span style=" color: #000087;">model updateContext</span>.<span style=" color: #000087;">model</span>.<span style=" color: #000087;">write</span>(<span style=" color: #000087;">to</span>: <span style=" color: #000087;">updatedModelUrl</span>)</p><p class="s75" style="padding-left: 39pt;text-indent: 0pt;line-height: 9pt;text-align: left;">})</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s74" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">task<span style=" color: #000;">.</span>resume<span style=" color: #000;">()</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1168">Federated Learning</a><a name="bookmark1236">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1237">On-device training is great — except for one downside: the generic global model does not get a chance to improve. Wouldn’t it be great for a developer to somehow use that data being generated on each user’s device to improve the global model without needing to transfer their data from their device? This is where </a><i>federated learning </i>comes in.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Federated learning is a collaborative distributed training process. It essentially takes on-device training one step further by sending the incremental updates (on the personalized models from users’ devices) to the cloud and aggregating many of these over the entire user base, subsequently enriching the global model for everyone. Keep in mind that no user data is being transmitted here and it is not possible to reverse engineer the user data from the aggregated feature set. With this approach, we are able to respect our users’ privacy while also benefiting everyone through collective participation.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">On-device training is a vital stepping stone for federated learning. Even though we are not there yet, this is the direction in which the industry is moving. We can expect to see more support for federated learning over time.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;">TensorFlow Federated is one such implementation of federated learning, powering training for Google’s GBoard, a keyboard app. Training on user devices occurs in the background when they are being charged.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s144" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1169">Performance Analysis</a><a name="bookmark1238">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1239">Writing prototypes is one thing. Making production-ready apps is another ball game entirely. There are several factors that influence the user’s experience, and it is important to understand the trade-offs. Some of these include the supported device models, minimum operating system (OS) version, processing frame rate, and choice of the deep learning model. In this section, we explore the impact that some of these factors can have on the quality and performance of the product.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1170">Benchmarking Models on iPhones</a><a name="bookmark1240">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">As is the case with benchmarking, it is best to perform experiments on publicly available models that we can download easily and get our hands dirty with!</p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1241" class="s160">First, we ran our real-time object classification app on multiple iPhones produced from 2013 to 2018. </a><a href="#bookmark1241" class="s143">Table </a>11-3 <span style=" color: #000;">catalogs the results of those experiments.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s142" style="padding-left: 184pt;text-indent: -160pt;text-align: left;"><a name="bookmark1241">Table 11-3. Benchmarking inference time on different models on different iPhone versions</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:6.47167pt" cellspacing="0"><tr style="height:15pt"><td style="width:121pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Device model</p></td><td style="width:72pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 33pt;text-indent: 0pt;line-height: 12pt;text-align: left;">iPhone</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">iPhone</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">iPhone</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">iPhone</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">iPhone</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">iPhone</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">iPhone</p></td></tr><tr style="height:16pt"><td style="width:121pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:72pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-left: 30pt;padding-right: 24pt;text-indent: 0pt;text-align: center;">5s</p></td><td style="width:42pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-left: 3pt;text-indent: 0pt;text-align: left;">6</p></td><td style="width:43pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-left: 3pt;text-indent: 0pt;text-align: left;">6s</p></td><td style="width:42pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-left: 3pt;text-indent: 0pt;text-align: left;">7+</p></td><td style="width:42pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-left: 3pt;text-indent: 0pt;text-align: left;">X</p></td><td style="width:42pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-left: 3pt;text-indent: 0pt;text-align: left;">XS</p></td><td style="width:43pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-left: 3pt;text-indent: 0pt;text-align: left;">11 Pro</p></td></tr><tr style="height:18pt"><td style="width:121pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">Year released</p></td><td style="width:72pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">2013</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2014</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2015</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2016</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2017</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2018</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2019</p></td></tr><tr style="height:18pt"><td style="width:121pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">RAM</p></td><td style="width:72pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">1 GB</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">1 GB</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2 GB</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2 GB</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2 GB</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">4 GB</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">4GB</p></td></tr><tr style="height:18pt"><td style="width:121pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">Processor chip</p></td><td style="width:72pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 32pt;padding-right: 24pt;text-indent: 0pt;text-align: center;">A7</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">A8</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">A9</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">A10</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">A11</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">A12</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">A13</p></td></tr><tr style="height:31pt"><td style="width:121pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 70pt;padding-right: 3pt;text-indent: -67pt;line-height: 106%;text-align: left;">Model       Accuracy (%)</p></td><td style="width:72pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;padding-right: 2pt;text-indent: 0pt;line-height: 106%;text-align: left;">Size FPS (MB)</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">FPS</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">FPS</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">FPS</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">FPS</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">FPS</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">FPS</p></td></tr><tr style="height:18pt"><td style="width:121pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">VGG-16 <span class="s150">71</span></p></td><td style="width:72pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">553 0.1</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">0.2</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">4.2</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">5.5</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">6.9</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">27.8</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">34.5</p></td></tr><tr style="height:18pt"><td style="width:121pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s149" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">InceptionV3 <span class="s150">78</span></p></td><td style="width:72pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">95 1.4</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">1.5</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">9</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">11.1</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">12.8</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">35.7</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">41.7</p></td></tr><tr style="height:18pt"><td style="width:121pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">ResNet-50 <span class="s150">75</span></p></td><td style="width:72pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">103 1.9</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">1.7</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">11.6</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">13.5</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">14.1</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">38.5</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">50</p></td></tr><tr style="height:18pt"><td style="width:121pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s149" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">MobileNet <span class="s150">71</span></p></td><td style="width:72pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">17 7.8</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">9</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">19.6</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">28.6</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">28.6</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">55.6</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">71.4</p></td></tr><tr style="height:18pt"><td style="width:121pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">SqueezeNet <span class="s150">57</span></p></td><td style="width:72pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">5 13.3</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">12.4</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">29.4</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">33.3</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">34.5</p></td><td style="width:42pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">66.7</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">76.9</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="590" height="157" alt="image" src="KerasTensorFlow2019/Image_709.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s153" style="padding-left: 132pt;text-indent: 0pt;text-align: center;">BENCHMARKING METHODOLOGY</p><p class="s147" style="padding-top: 5pt;padding-left: 10pt;text-indent: 0pt;line-height: 106%;text-align: left;">To do reproducible benchmarking, we took the code of the example app from earlier in the chapter, and simply swapped the <i>.mlmodel </i>file within Xcode with other pretrained models available from Apple. For each kind of model, we ran the app for a fixed amount of time and collected measurements on execution time from the debug console. After running it on different iPhones, we averaged the results from the 6th prediction to the 20th prediction for each run and tabulated those results.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s12" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The difference between inference times in 2014 and 2015 is particularly striking. What happened in 2015? If you guessed GPUs, you’d be right. The iPhone 6S introduced a dedicated GPU for the first time, powering features such as “Hey Siri.”</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s148" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1242" class="s160">On the other hand, let’s look at the device market share among iPhones in the release month of the iPhone XS (Sept. 2018) in the United States, as shown in </a><a href="#bookmark1242" class="s143">Table </a>11-4<span style=" color: #000;">. Note that releases typically happen in September of each year.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s142" style="padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1242">Table 11-4. US device market share</a></p><p class="s161" style="padding-top: 3pt;padding-left: 122pt;text-indent: 0pt;text-align: center;"><a href="https://oreil.ly/L47c0" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12.5pt;" target="_blank">among iPhones as of September 2018 (the release month of the iPhone XS; data from </a>Flurry Analytics <span style=" color: #000;">adjusted to exclude iPhone XS, XS Plus, and XS Max)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:119.541pt" cellspacing="0"><tr style="height:18pt"><td style="width:75pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Year released</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">iPhone model</p></td><td style="width:64pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Percentage</p></td></tr><tr style="height:18pt"><td style="width:75pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2017</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">8 Plus</p></td><td style="width:64pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">10.8%</p></td></tr><tr style="height:18pt"><td style="width:75pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2017</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">X</p></td><td style="width:64pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">10.3%</p></td></tr><tr style="height:18pt"><td style="width:75pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2017</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">8</p></td><td style="width:64pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">8.1%</p></td></tr><tr style="height:18pt"><td style="width:75pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2016</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">7</p></td><td style="width:64pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">15.6%</p></td></tr><tr style="height:18pt"><td style="width:75pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2016</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">7 Plus</p></td><td style="width:64pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">12.9%</p></td></tr><tr style="height:18pt"><td style="width:75pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2016</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">SE</p></td><td style="width:64pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">4.2%</p></td></tr><tr style="height:18pt"><td style="width:75pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2015</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">6S</p></td><td style="width:64pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">12.5%</p></td></tr><tr style="height:18pt"><td style="width:75pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2015</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">6S Plus</p></td><td style="width:64pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">6.1%</p></td></tr><tr style="height:18pt"><td style="width:75pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2014</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">6</p></td><td style="width:64pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">10.7%</p></td></tr><tr style="height:18pt"><td style="width:75pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2014</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">6 Plus</p></td><td style="width:64pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">3.3%</p></td></tr><tr style="height:18pt"><td style="width:75pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2013</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">5S</p></td><td style="width:64pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">3.4%</p></td></tr><tr style="height:18pt"><td style="width:75pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2013</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">5C</p></td><td style="width:64pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">0.8%</p></td></tr><tr style="height:18pt"><td style="width:75pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2012</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">5</p></td><td style="width:64pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">0.8%</p></td></tr><tr style="height:18pt"><td style="width:75pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2011</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">4S</p></td><td style="width:64pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">0.4%</p></td></tr><tr style="height:18pt"><td style="width:75pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2010</p></td><td style="width:77pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">4</p></td><td style="width:64pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">0.2%</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s148" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1242" class="s160">Deriving the cumulative percentages from </a>Table 11-4<a href="#bookmark1243" class="s160">, we get </a>Table 11-5<span style=" color: #000;">. This table expresses our potential market share based on the oldest device we choose to support. For example, iPhones released after September 2016 (two years before September 2018) have a total market share of 61.9%.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s142" style="padding-left: 138pt;text-indent: 0pt;text-align: center;"><a name="bookmark1243">Table 11-5. Cumulative market share of iPhones, year-on-year, going back in time</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:131.678pt" cellspacing="0"><tr style="height:18pt"><td style="width:68pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Years under</p></td><td style="width:124pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Cumulative percentage</p></td></tr><tr style="height:18pt"><td style="width:68pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">1</p></td><td style="width:124pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">29.2%</p></td></tr><tr style="height:18pt"><td style="width:68pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2</p></td><td style="width:124pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">61.9%</p></td></tr><tr style="height:18pt"><td style="width:68pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">3</p></td><td style="width:124pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">80.5%</p></td></tr><tr style="height:18pt"><td style="width:68pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">4</p></td><td style="width:124pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">94.5%</p></td></tr><tr style="height:18pt"><td style="width:68pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">5</p></td><td style="width:124pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">98.7%</p></td></tr><tr style="height:18pt"><td style="width:68pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">6</p></td><td style="width:124pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">99.5%</p></td></tr></table><p class="s12" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Combining the benchmark and market share, there are some design choices and optimizations available to us:</p><p class="s142" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Using a faster model</p><p class="s12" style="padding-top: 4pt;padding-left: 31pt;text-indent: 0pt;line-height: 107%;text-align: left;">On an iPhone 6, VGG-16 runs about 40 times slower than MobileNet. On an iPhone XS, it’s still about two times slower. Just choosing a more efficient model can have a dramatic impact on performance, often without the need to compromise an equivalent amount of accuracy. It’s worth noting that MobileNetV2 and EfficientNet offer an even better combination of speed and accuracy.</p><p class="s142" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Determining the minimum FPS to support</p><p class="s148" style="padding-top: 4pt;padding-left: 31pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a href="#bookmark1243" class="s160">A feature to apply filters on a real-time camera feed will need to be able to process a high number of the frames delivered by the camera every second to ensure a smooth experience. In contrast, an app that processes a single image due to a user-initiated action does not need to worry about performance nearly as much. A lot of applications are going to be somewhere in between. It’s important to determine the minimum necessary FPS and perform benchmarking similar to </a>Table 11-5 <span style=" color: #000;">to arrive at the best model(s) for the scenario across iPhone generations.</span></p><p class="s142" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Batch processing</p><p class="s12" style="padding-top: 4pt;padding-left: 31pt;text-indent: 0pt;line-height: 107%;text-align: left;">GPUs are really good at parallel processing. So, it comes as no surprise that processing a batch of data is more efficient than performing inferences on each item individually. Core ML takes advantage of this fact by exposing batch processing APIs. Some user experiences, particularly those that are asynchronous and/or memory intensive, can vastly benefit from these batching APIs. For example, any bulk processing of photos in the photo gallery. Instead of processing one image at a time, we can send a list of images together to the batch API, so that Core ML can optimize the performance on the GPU.</p><p class="s142" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Dynamic model selection</p><p class="s12" style="padding-top: 4pt;padding-left: 31pt;text-indent: 0pt;line-height: 107%;text-align: left;">Depending on the use case, we might not care nearly as much about high levels of accuracy as we do about a smooth experience (at some minimum FPS threshold). In these scenarios, we might choose a lighter, less-accurate model on a slower, older device, and a larger, more- accurate model on faster, modern devices. This can be used in conjunction with model deployment via the cloud so that we don’t needlessly increase the app size.</p><p class="s142" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Using Sherlocking to our advantage</p><p class="s12" style="padding-top: 3pt;padding-left: 31pt;text-indent: 0pt;line-height: 107%;text-align: left;">“Sherlocking” is a term used for when first-party vendors (Apple in particular) make third-party software obsolete by baking in a feature themselves. A good example of that is when Apple released the Flashlight feature within the iPhone rendering all third-party flashlight apps (whether paid or free) obsolete. For illustration here, take the example of a hypothetical app that released a face tracking feature in 2017. A year later, Apple added a more accurate face tracking API within Core ML for iOS 12. Because the neural networks for the face tracking come baked into the OS, the app could update its code to use the built-in API. However, because the API would still not be available for any users in iOS 11, the app could use a hybrid approach in which it would remain backward compatible by using the old code path for iOS 11. The app developer could then stop bundling the neural network into the app, thereby reducing its size, potentially by several megabytes, and dynamically download the older model for users of iOS 11.</p><p class="s142" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Graceful degradation</p><p class="s12" style="padding-top: 4pt;padding-left: 31pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a name="bookmark1244">Sometimes an older phone just cannot handle newer deep learning models due to performance needs. That’s a perfectly reasonable situation to be in, particularly if the feature is cutting edge. In those scenarios, it’s acceptable to use one of two approaches. The first is to offload the computation to the cloud. This obviously comes at the cost of interactivity and privacy. The other alternative is to disable the feature for those users and display a message to them stating why it is not available.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s144" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1171">Measuring Energy Impact</a><a name="bookmark1245">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="539" height="108" alt="image" src="KerasTensorFlow2019/Image_710.png"/></span></p><p class="s146" style="padding-top: 9pt;padding-left: 183pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s162" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 106%;text-align: left;"><a href="#bookmark1247" style=" color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10.5pt;">People are pretty generous with bad reviews when they realize an app is eating their battery faster than anticipated, as the reviews shown in </a>Figure 11-13 <span style=" color: #000;">demonstrate.</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1246">In the previous chapters, we focused on hosting classifiers on servers. Although there are several factors that affect design decisions, energy consumption is often not among them. However, on the client side, battery power tends to be limited, and minimizing its consumption becomes a priority. How users perceive a product depends a lot on how much energy it consumes. Remember the good old days when GPS was a battery hog. Many apps that required location access used to get tons of one-star ratings for eating up too much battery power. And we definitely don’t want that.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 35pt;text-indent: 0pt;text-align: left;"><span><img width="520" height="342" alt="image" src="KerasTensorFlow2019/Image_711.jpg"/></span></p><p class="s145" style="padding-top: 2pt;padding-left: 179pt;text-indent: -156pt;line-height: 106%;text-align: left;"><a name="bookmark1247">Figure 11-13. App Store reviews for YouTube and Snapchat that complain about heavy battery consumption</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s148" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1248" class="s160">Here we utilize the Energy Impact tab (</a>Figure 11-14<a href="#bookmark1249" class="s160">) in Xcode’s Debug Navigator and generate </a>Figure 11-15<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 40pt;text-indent: 0pt;text-align: left;"><span><img width="367" height="389" alt="image" src="KerasTensorFlow2019/Image_712.jpg"/></span></p><p class="s145" style="padding-top: 6pt;padding-left: 80pt;text-indent: 0pt;text-align: left;"><a name="bookmark1248">Figure 11-14. Xcode Debug Navigator tab</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 35pt;text-indent: 0pt;text-align: left;"><span><img width="520" height="306" alt="image" src="KerasTensorFlow2019/Image_713.jpg"/></span></p><p class="s145" style="padding-top: 3pt;padding-left: 15pt;text-indent: 1pt;line-height: 106%;text-align: left;"><a href="#bookmark1248" class="s176" name="bookmark1249">Figure 11-15. Xcode Energy Impact chart on an iPad Pro 2017 (note: this screenshot was taken at a different time than </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 10.5pt;">Figure 11-14</span>, which is why the numbers are slightly different)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s148" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1249" class="s143">Figure </a>11-15 <span style=" color: #000;">demonstrates that the energy impact of running the process on the iPad Pro 2017 is high. A big reason for this is that in our sample code, we were processing every single frame that we were receiving from the camera. This meant that each frame that the camera captured was being sent to the</span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="539" height="142" alt="image" src="KerasTensorFlow2019/Image_714.png"/></span></p><p class="s146" style="padding-top: 9pt;padding-left: 183pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s162" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 106%;text-align: left;"><a href="#bookmark1250" style=" color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10.5pt;">The ratio of CPU to GPU usage is affected by a model’s architecture, specifically  the number of convolutional operations. Here we profile the average CPU and GPU utilization for different models (</a><a href="#bookmark1250" class="s154">Figure </a>11-16<span style=" color: #000;">). These numbers can be extracted   from the Energy Impact chart in Xcode. Note that we’d ideally prefer models with more GPU utilization for performance efficiency.</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s12" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">GPU for processing, resulting in higher energy consumption. In many real- world applications, it is not necessary to classify every single frame. Even processing every other frame can result in significant energy savings without generally affecting the UX. In the next section, we explore the relationship between the frame processing rate and the energy impact.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 35pt;text-indent: 0pt;text-align: left;"><span><img width="512" height="201" alt="image" src="KerasTensorFlow2019/Image_715.jpg"/></span></p><p class="s145" style="padding-top: 5pt;padding-left: 37pt;text-indent: 0pt;text-align: left;"><a name="bookmark1250">Figure 11-16. Comparing CPU and GPU utilization for different models on iOS 11</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;"><a name="bookmark1172">Benchmarking Load</a><a name="bookmark1251">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;">As you would expect, running CNN models in real time on each frame causes high GPU/CPU utilization, which in turn rapidly drains the battery. Users might also notice the phone heating up.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Instead of running an analysis on every frame, how about we skip a few frames? MobileNet takes 20 ms to analyze one frame on an iPad Pro 2017. So, it classifies about 50 FPS. Instead, if we run it at 1 FPS, the GPU utilization is reduced from 42% to a mere 7% — a reduction of more than 83%! For many applications, processing at 1 FPS might be sufficient while still keeping the device cool. For example, a security camera might perform reasonably well even with processing frames once every couple of seconds.</p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1252" class="s160">By varying the number of frames analyzed per second and measuring the percentage of GPU utilization, we observe a fascinating trend. It is evident from the graph in </a>Figure 11-17 <span style=" color: #000;">that the higher the FPS, the more the GPU is utilized. That has a significant impact on energy consumption. For apps that need to be run for longer periods of time, it might be beneficial to reduce the number of inferences per second.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 48pt;text-indent: 0pt;text-align: left;"><span><img width="479" height="283" alt="image" src="KerasTensorFlow2019/Image_716.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 51pt;text-indent: 0pt;text-align: left;"><a name="bookmark1252">Figure 11-17. Varying the FPS and analyzing the load on an iPad Pro 2017</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;">The values shown in the graph were derived from the Core Animation Instrument of Xcode Instruments. Following is the process we used to generate our results:</p><ol id="l30"><li><p class="s12" style="padding-top: 4pt;padding-left: 50pt;text-indent: -14pt;text-align: justify;">From Xcode, click Product and then select Profile.</p></li><li><p class="s148" style="padding-top: 3pt;padding-left: 50pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1253" class="s160">After the Instruments window appears, select the Core Animation Instrument, as shown in </a><a href="#bookmark1253" class="s143">Figure </a>11-18<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 58pt;text-indent: 0pt;text-align: left;"><span><img width="517" height="222" alt="image" src="KerasTensorFlow2019/Image_717.jpg"/></span></p><p class="s145" style="padding-top: 6pt;padding-left: 107pt;text-indent: 0pt;text-align: left;"><a name="bookmark1253">Figure 11-18. The Instruments window in Xcode Instruments</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-top: 9pt;padding-left: 50pt;text-indent: -14pt;text-align: left;">Press the Record button to start running the app in the Profiling mode.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Wait a few seconds to begin collecting instrumentation data.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s148" style="padding-left: 50pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1254" class="s160">Measure the values in the GPU Hardware Utilization column (</a><a href="#bookmark1254" class="s143">Figure </a>11-19<span style=" color: #000;">).</span></p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 58pt;text-indent: 0pt;text-align: left;"><span><img width="516" height="600" alt="image" src="KerasTensorFlow2019/Image_718.jpg"/></span></p><p class="s145" style="padding-top: 2pt;padding-left: 78pt;text-indent: 0pt;text-align: left;"><a name="bookmark1254">Figure 11-19. An app being profiled live in the Core Animation instrument</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;"><a name="bookmark1255">So far in this chapter, we’ve explored techniques for making production-worthy apps using Core ML. In the next section, we discuss examples of such apps in the real world.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s144" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1173">Reducing App Size</a><a name="bookmark1256">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1257">App size can be crucially important to developers in certain markets. Apple does not allow apps larger than 200 MB to be downloaded via the cellular network. This becomes a crucial point of contention for apps that are used frequently on the go, such as ride-hailing apps like Uber and Lyft. Interesting tidbit here: Uber had to do some really stringent optimizations such as heavily reducing the number of Swift Optionals, Structs, and Protocols (which otherwise help with code maintainability) in order to bring the app binary size below the App Store limit (at the time, 150 MB). Without doing that, the company would have lost a lot of new users.</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="539" height="302" alt="image" src="KerasTensorFlow2019/Image_719.png"/></span></p><p class="s146" style="padding-top: 9pt;padding-left: 183pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s147" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 106%;text-align: left;">Segment, a San Francisco-based data analytics company, wanted to determine how much of an impact app size has on the number of installs. To experiment, the company purchased a mortgage calculator app that had a steady number of app downloads (approximately 50 per day). It took the app that was originally 3 MB in size and kept bloating it repeatedly with…well, images of Taylor Swift albums (hey, it was in the name of science and research!). Engineers observed significant drops in the number of daily installs as the company increased the app size. When the app crossed 100 MB (the maximum limit for cellular network downloads from the App Store at the time), the number of daily installs dropped a whopping 44%!</p><p class="s147" style="padding-left: 5pt;text-indent: 0pt;line-height: 106%;text-align: left;">Additionally, the app attracted several negative reviews with users expressing incredulity at the app size.</p><p class="s147" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 106%;text-align: left;">The moral of the story here is that the app size is far more crucial than we think, and we ought to be mindful of the amount of space our app consumes before releasing it out to the public.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">It’s a given that any new AI functionality we introduce in the app will result in additional usage of storage. There are a few strategies that we can employ to reduce the impact of that.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1174">Avoid Bundling the Model</a><a name="bookmark1258">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">If possible, we should avoid bundling the model with the App Store binary. The same amount of data needs to be downloaded anyway, so as long as the UX is not affected, we should delay model download to when the feature is actually going to be used. Additionally, we should prefer to download the model when on WiFi in order to preserve cellular bandwidth. Microsoft Translator and Google Translate implement a form of this where they do only cloud-based translations at the outset. Knowing that travelers use these apps a lot (where they might not have good internet access), they also offer an offline mode where the required language models are downloaded at the user’s prompt in the background.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1175">Use Quantization</a><a name="bookmark1259">&zwnj;</a></p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark599" class="s160" name="bookmark1260">As we discussed in </a>Chapter 6<span style=" color: #000;">, quantization is a good strategy to reduce model size drastically while still preserving performance. Essentially, it reduces 32-bit floating-point weights down to 16-bit floating point, and 8-bit integers all the way down to 1-bit. We definitely won’t recommend going below 8 bits, though, due to the resulting loss in accuracy. We can achieve quantization with Core ML Tools for Keras models in just a couple of lines:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s77" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">coremltools</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">model_spec </span>= <span style=" color: #000087;">coremltools</span>.<span style=" color: #000087;">utils</span>.<span style=" color: #000087;">load_spec</span>(<span style=" color: #C30;">&quot;MyModel.mlmodel&quot;</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s128" style="padding-left: 19pt;text-indent: 0pt;line-height: 10pt;text-align: left;"># 16-bit conversion</p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">model_fp16_spec </span>= <span style=" color: #000087;">coremltools</span>.<span style=" color: #000087;">utils</span>.<span style=" color: #000087;">convert_neural_network_spec_weights_to_fp16</span>(<span style=" color: #000087;">model_spec</span>) <span style=" color: #000087;">coremltools</span>.<span style=" color: #000087;">utils</span>.<span style=" color: #000087;">save_spec</span>(<span style=" color: #000087;">model_fp16_spec</span>, <span style=" color: #C30;">&quot;MyModel_FP16.mlmodel&quot;</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s128" style="padding-left: 19pt;text-indent: 0pt;line-height: 10pt;text-align: left;"># 8-bit or lower quantization</p><p class="s74" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">num_bits <span style=" color: #000;">= </span><span style=" color: #F60;">8 </span>model_quant_spec <span style=" color: #000;">=</span></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">coremltools</span>.<span style=" color: #000087;">models</span>.<span style=" color: #000087;">neural_network</span>.<span style=" color: #000087;">quantization_utils</span>.<span style=" color: #000087;">quantize_weights</span>(<span style=" color: #000087;">model_spec</span>, <span style=" color: #000087;">num_bits</span>, <span style=" color: #C30;">&quot;linear&quot;</span>)</p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;line-height: 10pt;text-align: left;"><span style=" color: #000087;">coremltools</span>.<span style=" color: #000087;">utils</span>.<span style=" color: #000087;">save_spec</span>(<span style=" color: #000087;">model_quant_spec</span>, <span style=" color: #C30;">&quot;MyModel_Quant.mlmodel&quot;</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">To illustrate the impact of quantization on a challenging dataset where small modifications could lead to drastic changes, we chose to build a classifier for Oxford’s 102 Category Flower Dataset with Keras (roughly 14 MB in size), and quantized it to different bit representations while measuring its accuracy and decreasing its size. To measure the change in predictions, we compare the percent match between the full-precision model and the quantized model. We tested three quantization modes.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_720.png"/></span></p><p class="s12" style="padding-top: 4pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">Simple <span class="s156">linear </span><a href="#bookmark599" class="s160">quantization, which we described in </a><span style=" color: #8E0012;">Chapter 6</span>. The intervals are distributed equally in this strategy.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_721.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">Linear quantization using a lookup table, or <span class="s156">linear_lut</span>. In this technique, the intervals are distributed unequally, with denser areas getting smaller and more intervals, whereas sparser areas would have fewer and larger intervals. Because these intervals are unequal, they need to be stored in the lookup table, rather than being directly computed with simple arithmetic.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_722.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">Lookup table generated by <i>k</i>-means, or <span class="s156">kmeans_lut</span>, which is often used in nearest neighbor classifiers.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s148" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Table 11-6 <span style=" color: #000;">shows our observations.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s142" style="padding-left: 172pt;text-indent: -148pt;text-align: left;"><a name="bookmark1261">Table 11-6. Quantization results for different target bit sizes and different quantization modes</a></p><p style="padding-left: 21pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="557" height="1" alt="image" src="KerasTensorFlow2019/Image_723.png"/></span></p><p class="s153" style="padding-top: 3pt;padding-left: 24pt;text-indent: 0pt;text-align: left;">Quantized to Percent size reduction (approx.) Percent match with 32-bit results</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:21.1643pt" cellspacing="0"><tr style="height:14pt"><td style="width:240pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" colspan="2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:45pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" bgcolor="#F1F5FB"><p class="s163" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">linear</p></td><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" bgcolor="#F1F5FB"><p class="s163" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">linear_lut</p></td><td style="width:67pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" bgcolor="#F1F5FB"><p class="s163" style="padding-top: 2pt;padding-left: 7pt;text-indent: 0pt;text-align: left;">kmeans_lut</p></td></tr><tr style="height:18pt"><td style="width:52pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">16-bit</p></td><td style="width:188pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">50%</p></td><td style="width:45pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">100%</p></td><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">100%</p></td><td style="width:67pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 7pt;text-indent: 0pt;text-align: left;">100%</p></td></tr><tr style="height:18pt"><td style="width:52pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">8-bit</p></td><td style="width:188pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">75%</p></td><td style="width:45pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">88.37%</p></td><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">80.62%</p></td><td style="width:67pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 7pt;text-indent: 0pt;text-align: left;">98.45%</p></td></tr><tr style="height:18pt"><td style="width:52pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">4-bit</p></td><td style="width:188pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">88%</p></td><td style="width:45pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">0%</p></td><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">0%</p></td><td style="width:67pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 7pt;text-indent: 0pt;text-align: left;">81.4%</p></td></tr><tr style="height:18pt"><td style="width:52pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">2-bit</p></td><td style="width:188pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">94%</p></td><td style="width:45pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">0%</p></td><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">0%</p></td><td style="width:67pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 7pt;text-indent: 0pt;text-align: left;">10.08%</p></td></tr><tr style="height:18pt"><td style="width:52pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">1-bit</p></td><td style="width:188pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">97%</p></td><td style="width:45pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">0%</p></td><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">0%</p></td><td style="width:67pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 7pt;text-indent: 0pt;text-align: left;">7.75%</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">This gives us a few insights.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_724.png"/></span></p><p class="s12" style="padding-top: 6pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">Lowering representation to 16-bits has no effect at all on accuracy. We can essentially halve the model size with no perceivable difference in accuracy.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_725.png"/></span></p><ol id="l31"><ol id="l32"><li><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">eans when used for building the lookup table outperforms simple linear division methods. Even at 4-bit, only 20% accuracy is lost, which is remarkable.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_726.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">Going to 8-bit quantized models gives 4 times smaller modes with little loss in accuracy (especially for <span class="s156">kmeans_lut </span>mode).</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_727.png"/></span></p><p class="s12" style="padding-top: 12pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">Quantizing to lower than 8-bits results in a drastic drop in accuracy, particularly with the linear modes.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1176">Use Create ML</a><a name="bookmark1262">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1263">Create ML is a tool from Apple to train models by simply dragging and dropping data into a GUI application on the Mac. It provides several templates including object classification/detection, sound classification, and text classification, among others, putting training AI in the hands of novices without requiring any domain expertise. It uses transfer learning to tune only the handful of layers that will be necessary for our task. Because of this, the training process can be completed in just a few minutes. The OS ships with the bulk of the layers (that are usable across several tasks), whereas the task- specific layers can be shipped as part of the app. The resulting exported model ends up being really small (as little as 17 KB, as we will see shortly).</a></p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1264">We get hands-on with Create ML in the next chapter.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s144" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1177">Case Studies</a><a name="bookmark1265">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1266">Let’s take a look at some real-world examples that use Core ML for mobile inferences.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1178">Magic Sudoku</a><a name="bookmark1267">&zwnj;</a></p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://developer.apple.com/arkit" class="s160" target="_blank" name="bookmark1268">Soon after the launch of </a>ARKit on iOS <a href="https://magicsudoku.com/" class="s160" target="_blank">in 2017, the </a>Magic Sudoku <span style=" color: #000;">app from Hatchlings, a game and mobile app startup, came out as one of the break-out hits. Simply point the phone at a Sudoku puzzle, and the app will show a solved Sudoku right on the piece of paper. As we might have guessed at this point, the system is using Core ML to run a CNN-based digit recognizer. The system goes through the following steps:</span></p><ol id="l33"><li><p class="s12" style="padding-top: 4pt;padding-left: 50pt;text-indent: -14pt;text-align: left;">Use ARKit to get camera frames.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Use iOS Vision Framework to find rectangles.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Determine whether it is a Sudoku grid.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Extract 81 squares from the Sudoku image.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Recognize digits in each square using Core ML.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Use a Sudoku solver to finish the empty squares.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s148" style="padding-left: 50pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1269" class="s160">Project the finished Sudoku on the surface of original paper using ARKit, as shown in </a><a href="#bookmark1269" class="s143">Figure </a>11-20<span style=" color: #000;">.</span></p></li></ol></li></ol></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 35pt;text-indent: 0pt;text-align: left;"><span><img width="514" height="181" alt="image" src="KerasTensorFlow2019/Image_728.jpg"/></span></p><p class="s145" style="padding-top: 6pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a href="https://oreil.ly/gzmb9" class="s176" target="_blank" name="bookmark1269">Figure 11-20. Step-by-step solution to solving ARKit (</a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 10.5pt;">image source</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The Hatchlings team first started with using the MNIST digit recognition model, which mostly consists of handwritten digits. But this was not robust for printed fonts. The team then photographed thousands of pages of Sudoku books, extracting the squares using its pipeline until it had a large number of images of individual digits in a variety of fonts. To label this data, the team requested its fans classify each item as 0 through 9 and empty classes. Within 24 hours, the team got 600,000 digits scanned. The next step was to train a custom CNN, which needed to work fast, because the system needed to classify 81 square images. Deploying this model using Core ML, the app launched and become an overnight hit.</p><p class="s12" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Running out with new users in the wild brought new cases not previously anticipated. Because most users do not have a Sudoku puzzle in front of them, they often search for Sudoku on computer screens, and this was difficult for the model to always recognize precisely. Additionally, due to a fixed focal length limitation of ARKit, the input image could be slightly blurry. To remedy this, the Hatchlings team collected additional examples of photos of computer screens with puzzles, blurred them slightly, and trained a new CNN with the additional data. With an App Store update, the whole experience became much more robust. In summary, while launching an app or a service, the app builder needs to constantly learn from new scenarios not previously anticipated.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1179">Seeing AI</a><a name="bookmark1270">&zwnj;</a></p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://oreil.ly/hJxUE" class="s143" target="_blank" name="bookmark1271">Seeing AI</a> <span style=" color: #000;">is a talking camera app from Microsoft Research designed for the blind and low-vision community. It uses computer vision to describe people, text, handwriting, objects, currency, and more through spoken audio. Much of the image processing happens locally on the device, using Core ML. One of the core user needs is to recognize products — this can usually be determined by scanning close-ups of barcodes. But for a blind user, the location of a barcode is unknown, making most barcode apps difficult to use. To solve this, the team built a custom CNN trained with images containing barcodes at a variety of angles, sizes, lighting, and orientation. The user now attempts to rotate the object in front of the iPhone, and when the CNN classifies the presence of a barcode (running in real time, frame by frame), it signals with an audible beep. The rate of beeping directly correlates with the area of the barcode visible to the camera. As the blind users begin to bring the barcode closer, it beeps faster. When it is close enough for the barcode reading library to be able to clearly see the barcode, the app decodes the Universal Product Code and speaks the product name. In the past, blind users typically had to purchase and carry around bulky laser barcode scanners, which usually cost more than $1,300. In fact, a charity raised millions to donate these hardware barcode readers to those who needed them. Now, deep learning can solve this problem for free. This is a good example of mixing computer vision and UX to solve a real-world problem.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1180">HomeCourt</a><a name="bookmark1272">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1273">For anything in life, regular practice is a must if we want to get better at something, be it writing, playing a musical instrument, or cooking. However, the quality of practice is far more important than quantity. Using data to support our practice and monitor our progress does wonders to the rate at which we acquire a skill. This is exactly what NEX Team, a San Jose, California-based startup, set out to do for basketball practice with the help of its HomeCourt app. Running the app is easy: set it up on the ground or a tripod, point the camera at the basketball court, and hit record.</a></p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1274" class="s160">The app runs an object detector in real time on top of Core ML to track the ball, the people, and the basketball hoop. Among these people, the big question remains: who shot the ball? When the ball goes near the hoop, the app rewinds the video to identify the player who shot the ball. Then, it performs human pose estimation on the player to track the player’s movements. If this wasn’t impressive enough, it uses geometric transformations to convert this 3D scene of the court into a 2D map (as shown in the upper right of </a>Figure 11-21<span style=" color: #000;">) to track the locations from which the player shot the ball. The important thing to note here is that multiple models are being run simultaneously. Based on the tracked objects and the player’s body position, joints, and so on, the app provides the player with stats and visualizations for the release height of each throw, release angle, release position, release time, player speed, and more. These stats are important because they have a high correlation with a successful attempt. Players are able to record an entire game as they play and then go home and analyze each shot so that they can determine their weak areas in order to improve for the next time.</span></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In just under two years of existence, this tiny startup attracted hundreds of thousands of users as word of mouth spread, from amateurs to professionals. Even the National Basketball Association (NBA) partnered with NEX Team to help improve their players’ performance using HomeCourt. All of this happened because they saw an unmet need and came up with a creative solution using deep learning.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 35pt;text-indent: 0pt;text-align: left;"><span><img width="518" height="291" alt="image" src="KerasTensorFlow2019/Image_729.jpg"/></span></p><p class="s145" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: left;"><a name="bookmark1274">Figure 11-21. The HomeCourt app tracking a player’s shots live as they are playing</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1181">InstaSaber + YoPuppet</a><a name="bookmark1275">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1276">Do you know the largest profit maker in the </a><i>Star Wars </i>franchise? It’s not the movie ticket sales, and it’s definitely not from selling DVDs. Here’s a hint: it rhymes with merchandise. Lucas Film (and now Disney) made a lot of money selling R2D2 toys and Chewbacca costumes. Though the all-time favorite still remains the dear lightsaber. However, instead of looking cool like in the movies, the merchandise lightsabers are mostly made of plastic and frankly don’t look as sci-fi. Plus, you swing it around a few times and there’s a good chance you’ll accidentally whack someone in the face.</p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1277" class="s160">Hart Woolery, the founder of 2020CV, decided to change that by bringing Hollywood-level VFX to our phone with the InstaSaber app. Simply roll up a sheet of paper, grip it, and point your phone’s camera toward it and watch it transform into a glowing lightsaber, as illustrated in </a>Figure 11-22<span style=" color: #000;">. Wave your hand and not just watch it track it realistically in real time, but also hear the same sound effects as when Luke fought his father, (spoiler alert!) Darth Vader.</span></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Taking the tracking magic to the next level, he built YoPuppet, which tracks the joints in hands in real time to build virtual puppets that mimic the motion of the hand. The suspension of disbelief works only if it is truly real time with no lag, is accurate, and realistic looking.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In addition to being realistic, these apps were a lot of fun to play with. No wonder InstaSaber became an insta-hit with millions of viral views online and in the news. The AI potential even got billionaire investor Mark Cuban to say, “you’ve got a deal” and invest in 2020CV.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 35pt;text-indent: 0pt;text-align: left;"><span><img width="507" height="440" alt="image" src="KerasTensorFlow2019/Image_730.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1277">Figure 11-22. Screenshots of InstaSaber and YoPuppet</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="590" height="931" alt="image" src="KerasTensorFlow2019/Image_731.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s153" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">FROM THE CREATOR’S DESK</p><p class="s147" style="padding-top: 5pt;padding-left: 16pt;text-indent: 0pt;text-align: left;">By Hart Woolery, founder and CEO of 2020CV</p><p class="s147" style="padding-top: 5pt;padding-left: 16pt;text-indent: 0pt;line-height: 106%;text-align: left;">Since starting 2020CV a few years ago, I’ve developed a number of apps that attempt to push the boundaries of these special effects. I will talk about two: InstaSaber and YoPuppet. InstaSaber turns a rolled-up sheet of paper into a virtual lightsaber, and YoPuppet transforms the user’s hand into a virtual hand puppet. In both cases, I am using real-time camera frames as inputs to my models, and returning normalized x-y coordinates of feature locations inside those images. I got the idea for InstaSaber after attempting to track a handheld marker, because I was struggling at the time to track hands by themselves. The initial challenge — as is generally the case for most machine learning models — is gathering the data, labeling the data, and making sure you have enough data to create a generalized solution.</p><p class="s162" style="padding-top: 4pt;padding-left: 16pt;text-indent: 0pt;line-height: 106%;text-align: left;"><a href="#bookmark1278" style=" color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10.5pt;">Just how many labeled images do you need for a machine learning model that can decode an object reliably with multiple variables like lighting, skin tone, and occlusion? I think the answer depends largely on the problem, but at a minimum, it will generally be at least 10,000. Assuming it could take 30 seconds or more per image to label it correctly, that is a lot of time being invested. The simplest workaround is to augment your data (i.e., affine transforms, cropping, and color/lighting manipulation). While this turns a finite amount of data into a nearly infinite set of variants, your model will still be constrained by the quality of your initial set. While I manually labeled images for InstaSaber, I found it far more efficient to synthetically generate images of hands in various positions and environments for YoPuppet (</a>Figure 11-23<span style=" color: #000;">). Once you are able to train and iterate on your model, the next challenge is getting them to perform well within the constraints of a mobile device.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="590" height="880" alt="image" src="KerasTensorFlow2019/Image_732.png"/></span></p><p class="s145" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1278">Figure 11-23. Real-time hand pose estimation within YoPuppet</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s147" style="padding-left: 16pt;text-indent: 0pt;line-height: 106%;text-align: left;">It’s fairly easy to get a machine learning model running on a mobile device these days with the advent of such frameworks as Core ML. However, getting a model to run in real time and deliver a great user experience — without melting the user’s phone — is challenging. In the case of YoPuppet and InstaSaber, I also had to find the initial location of the object, and track it in real time so I could crop a square out of the full camera image, scale it down, and pass it to my model. One of the tricks I use to maintain a smooth frame rate is buffering the images so that the CPU and GPU can respectively preprocess and run inference on the images in tandem.</p><p class="s147" style="padding-top: 4pt;padding-left: 16pt;text-indent: 0pt;line-height: 106%;text-align: left;"><a name="bookmark1279">Once your app is published and out in the wild, the real-world feedback will often make you realize there are a lot of issues with your model you may have never considered (the bias is real!). For example, one user said that painted fingernails seemed to be causing issues with hand detection. Fortunately, this kind of feedback only helps you further generalize your model and make it more robust to variations in your objects. To be certain, the process of delivering a great experience for all your users is a never-ending challenge, but the reward is that you will be a pioneer in an emerging area of technology.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s144" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1182">Summary</a><a name="bookmark1280">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In this chapter, we went on a whirlwind tour of the world of Core ML, which provides an inference engine for running machine learning and deep learning algorithms on an iOS device. Analyzing the minimal code needed for running a CNN, we built a real-time object recognition app that classifies among 1,000 ImageNet categories. Along the way, we discussed some useful facts about model conversion. Moving to the next level, we learned about practical techniques like dynamic model deployment and on-device training, while also benchmarking different deep learning models on various iOS devices, providing a deeper understanding of the battery and resource constraints. We also looked at how we can optimize the app size using model quantization.</p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Finally, to take some inspiration from the industry, we explored real-life examples where Core ML is being used in production apps.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1281">In the next chapter, we build an end-to-end application by training using Create ML (among other tools), deploying our custom trained classifier, and running it using Core ML.</a></p><p class="s16" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1282">Chapter 12. Not Hotdog on iOS with Core ML and Create ML</a><a name="bookmark1295">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_733.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s39" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1297" class="s30" name="bookmark1296">“I’m a rich,” said Jian-Yang, a newly minted millionaire in an interview with Bloomberg (</a>Figure 12-1<a href="#bookmark1298" class="s30">). What did he do? He created the Not Hotdog app (</a>Figure 12-2<span style=" color: #000;">) and made the world “a better place.”</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="531" height="300" alt="image" src="KerasTensorFlow2019/Image_734.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 52pt;text-indent: -38pt;text-align: left;"><a name="bookmark1297">Figure 12-1. Jian-Yang being interviewed by Bloomberg News after Periscope acquires his “Not Hotdog” technology (image source: From HBO’s Silicon Valley)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">To the few of us who may be confused (including a third of the authors of this book), we are making a reference to HBO’s <i>Silicon Valley</i>, a show in which one of the characters is tasked with making SeeFood — the “Shazam for food.” It was meant to classify pictures of food and give recipes and nutritional information. Hilariously, the app ends up being good only for recognizing hot dogs. Anything else would be classified as “Not Hotdog.”</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">There are a few reasons we chose to reference this fictitious app. It’s very much a part of popular culture and something many people can easily relate to. It’s an exemplar: easy enough to build, yet powerful enough to see the magic of deep learning in a real-world application. It is also very trivially generalizable to recognize more than one class of items.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="535" height="468" alt="image" src="KerasTensorFlow2019/Image_735.jpg"/></span></p><p class="s19" style="padding-top: 4pt;padding-left: 8pt;text-indent: 0pt;text-align: center;"><a name="bookmark1298">Figure 12-2. The Not Hotdog app in action (image source: Apple App Store listing for the Not Hotdog app)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1299">In this chapter, we work through a few different approaches to building a Not Hotdog clone. The general outline of the end-to-end process is as follows:</a></p><ol id="l34"><li><p class="s17" style="padding-top: 4pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Collect relevant data.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 52pt;text-indent: -15pt;text-align: left;">Train the model.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 52pt;text-indent: -15pt;text-align: left;">Convert to Core ML.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 52pt;text-indent: -15pt;text-align: left;">Build the iOS app.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s39" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Table 12-1 <span style=" color: #000;">presents the different options available for steps 1 through 3. Further along in the chapter, we do a deep dive into each of them.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s22" style="padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1300">Table 12-1. Various approaches to getting a model ready for mobile deployment, right from scratch</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_736.png"/></span></p><p class="s33" style="padding-top: 1pt;padding-bottom: 3pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Data collection Training mechanism Model conversion</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_737.png"/></span></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_738.png"/></span></p><p class="s33" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Data collection Training mechanism Model conversion</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_739.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_740.png"/></span></p><p class="s26" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Find or collect a dataset</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_741.png"/></span></p><p class="s26" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Fatkun Chrome browser extension</p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_742.png"/></span></p><p class="s26" style="padding-top: 10pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Web scraper using Bing Image Search API</p><p class="s26" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Web-based GUI: CustomVision.ai, IBM Watson, Clarifai, Google AutoML</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_743.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_744.png"/></span></p><p class="s26" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Create ML</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_745.png"/></span></p><p class="s26" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Fine-tune using any framework of choice like Keras</p><p class="s26" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Create ML, CustomVision.ai, and other GUI tools generate</p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_746.png"/></span></p><p class="s26" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">.<i>mlmodel</i>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_747.png"/></span></p><p class="s26" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">For Keras, use Core ML Tools.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_748.png"/></span></p><p class="s26" style="padding-top: 10pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">For TensorFlow trained models, use <span class="s113">tf-coreml</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_749.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Let’s dive right in!</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1283">Collecting Data</a><a name="bookmark1301">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1302">To begin solving any computer-vision task using deep learning, we first need to have a dataset of images to train on. In this section, we use three different approaches to collecting the images of the relevant categories in increasing order of time required, from minutes to days.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1284">Approach 1: Find or Collect a Dataset</a><a name="bookmark1303">&zwnj;</a></p><p class="s116" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://oreil.ly/dkS6X" class="s30" target="_blank" name="bookmark1304">The fastest way to get our problem solved is to have an existing dataset in hand. There are tons of publicly available datasets for which a category or a subcategory might be relevant to our task. For example, Food-101 (</a>https://www.vision.ee.ethz.ch/datasets_extra/food-101/<span class="s17">) from ETH Zurich contains a class of hot dogs. Alternatively, ImageNet contains 1,257 images of hot dogs. We can use a random sample of images from the remaining classes as “Not Hotdog.”</span></p><p style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://oreil.ly/ftyOU" class="s30" target="_blank" name="bookmark1305">To download images from a particular category, you can use the </a><a href="https://oreil.ly/ftyOU" class="s18" target="_blank">ImageNet- Utils </a><a href="https://oreil.ly/ftyOU" class="s30" target="_blank">tool:</a></p><ol id="l35"><li><p class="s17" style="padding-top: 4pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Search for the relevant category on the ImageNet website; for example, “Hot dog.”</p></li><li><p style="padding-top: 13pt;padding-left: 52pt;text-indent: -15pt;text-align: left;"><a href="http://image-net.org/synset?wnid=n07697537" class="s30" target="_blank">Note the </a><a href="http://image-net.org/synset?wnid=n07697537" class="s164" target="_blank">wnid </a><a href="http://image-net.org/synset?wnid=n07697537" class="s30" target="_blank">(WordNet ID)in the URL: </a><a href="http://image-net.org/synset?wnid=n07697537" class="s21" target="_blank">http://image- net.org/synset?wnid=n07697537</a><a href="http://image-net.org/synset?wnid=n07697537" class="s30" target="_blank">.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 52pt;text-indent: -15pt;text-align: left;">Clone the ImageNet-Utils repository:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 66pt;text-indent: 0pt;text-align: left;">$ git clone --recursive</p><p class="s75" style="padding-left: 18pt;text-indent: 0pt;text-align: center;">https://github.com/tzutalin/ImageNet_Utils.git</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 52pt;text-indent: -15pt;text-align: left;">Download the images for the particular category by specifying the</p></li></ol><p class="s42" style="padding-left: 52pt;text-indent: 0pt;text-align: left;">wnid<span class="s17">:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 66pt;text-indent: 0pt;text-align: left;">$ ./downloadutils.py --downloadImages --wnid nO7697537</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="536" height="113" alt="image" src="KerasTensorFlow2019/Image_750.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Make sure to check the license under which the images in the dataset are released. It’s best to use images released under permissive licenses such as Creative Commons.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In case we can’t find a dataset, we can also build our own dataset by taking pictures ourselves with a smartphone. It’s essential that we take pictures representative of how our application would be used in the real world. Alternatively, crowdsourcing this problem, like asking friends, family, and coworkers, can generate a diverse dataset. Another approach used by large companies is to hire contractors who are tasked with collecting images. For example, Google Allo released a feature to convert selfies into stickers. To build it, they hired a team of artists to take an image and create the corresponding sticker so that they could train a model on it.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1285">Approach 2: Fatkun Chrome Browser Extension</a><a name="bookmark1306">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://oreil.ly/7T4JU" class="s30" target="_blank" name="bookmark1307">There are several browser extensions that allow us to batch download multiple images from a website. One such example is the </a><a href="https://oreil.ly/7T4JU" class="s18" target="_blank">Fatkun Batch Download Image</a>, a browser extension available on the Chrome browser.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We can have the entire dataset ready in the following short and quick steps.</p><ol id="l36"><li><p class="s17" style="padding-top: 4pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Add the extension to our browser.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 52pt;text-indent: -15pt;text-align: left;">Search for the keyword either on Google or Bing Image search.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 52pt;text-indent: -15pt;text-align: left;">Select the appropriate filter for image licenses in the search settings.</p></li><li><p class="s17" style="padding-top: 13pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">After the page reloads, scroll to the bottom of it a few times repeatedly to ensure more thumbnails are loaded on the page.</p></li><li><p class="s39" style="padding-top: 13pt;padding-left: 52pt;text-indent: -15pt;text-align: left;"><a href="#bookmark1308" class="s30">Open the extension and select “This Tab” option, as demonstrated in </a><a href="#bookmark1308" class="s18">Figure </a>12-3<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 53pt;text-indent: 0pt;text-align: left;"><span><img width="534" height="518" alt="image" src="KerasTensorFlow2019/Image_751.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 139pt;text-indent: 0pt;text-align: left;"><a name="bookmark1308">Figure 12-3. Bing Search results for “hot dog”</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-top: 10pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Notice that all the thumbnails are selected by default. At the top of the screen, click the Toggle button to deselect all the thumbnails and select only the ones we need. We can set the minimum width and height to be 224 (most pretrained models take 224x224 as input size).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 53pt;text-indent: 0pt;text-align: left;"><span><img width="534" height="325" alt="image" src="KerasTensorFlow2019/Image_752.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 103pt;text-indent: 0pt;text-align: left;">Figure 12-4. Selecting images through the Fatkun extension</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="536" height="184" alt="image" src="KerasTensorFlow2019/Image_753.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1309">Note that the images shown in the screenshots are iconic images (i.e., the main object is in direct focus with a clean background). Chances are that using such images exclusively in our model will cause it to not generalize well to real-world images. For example, in images with a clean white background (like on an ecommerce website), the neural network might incorrectly learn that white background equals hot dog. Hence, while performing data collection, ensure that your training images are representative of the real world.</a></p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="536" height="251" alt="image" src="KerasTensorFlow2019/Image_754.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1310">For the negative class of “Not Hotdog,” we want to collect random images that are abundantly available. Additionally, collect items that look similar to a hot dog but are not; for example, a submarine sandwich, bread, plate, hamburgers, and so on.</a></p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1311">An absence of commonly co-occurring items with hot dogs like plates with food, tissues, ketchup bottles or packets, can mistakenly lead the model to think that those are the real hot dogs. So be sure to add these to the negative class.</a></p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">When you install a browser extension like Fatkun, it will request permissions to read and modify data on all the websites we visit. It might be a good idea to disable the extension when you’re not using it for downloading images.</p><p style="text-indent: 0pt;text-align: left;"/></li><li><p class="s17" style="padding-top: 10pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">In the upper-right corner, click Save Image to download all of the selected thumbnails to our computer.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1286">Approach 3: Web Scraper Using Bing Image Search API</a><a name="bookmark1312">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1313">For building larger datasets, using Fatkun to collect images can be a tedious process. Additionally, images returned by the Fatkun browser extension are thumbnails and not the original size images. For large-scale image collections, we can use an API for searching images, like the Bing Image Search API, where we can establish certain constraints such as the keyword, image size, and license. Google used to have the Image Search API, but it was discontinued in 2011.</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Bing’s Search API is an amalgamation of its AI-based image understanding and traditional information retrieval methods (i.e., using tags from fields like “alt-text,” “metadata,” and “caption”). Many times, we can end up with some number of irrelevant images because of misleading tags from these fields. As a result, we want to manually parse the collected images to make sure that they are actually relevant to our task.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">When we have a very large image dataset, it can be a daunting task to have to go through it manually and filter out all of the poor training examples. It’s easier to approach this in an iterative manner, slowly improving the quality of the training dataset with each iteration. Here are the high-level steps:</p><ol id="l37"><li><p class="s17" style="padding-top: 4pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Create a subset of the training data by manually reviewing a small number of images. For example, if we have 50k images in our original dataset, we might want to manually select around 500 good training examples for the first iteration.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 52pt;text-indent: -15pt;text-align: left;">Train the model on those 500 images.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 52pt;text-indent: -15pt;text-align: left;">Test the model on the remaining images and get the confidence value for each image.</p></li><li><p class="s17" style="padding-top: 13pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Among the images with the least confidence values (i.e., often mispredictions), review a subset (say, 500) and discard the irrelevant images. Add the remaining images from this subset to the training set.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 52pt;text-indent: -15pt;text-align: left;">Repeat steps 1 through 4 for a few iterations until we are happy with the quality of the model.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1314">This is a form of semisupervised learning.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="536" height="95" alt="image" src="KerasTensorFlow2019/Image_755.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">You can improve the model accuracy further by reusing the discarded images as negative training examples.</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="536" height="191" alt="image" src="KerasTensorFlow2019/Image_756.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">For a large set of images that don’t have labels, you might want to use co- occurrence of other defining text as labels; for example, hashtags, emojis, alt- text, etc.</p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Facebook built a dataset of 3.5 billion images using the hashtags from the text of corresponding posts as weak labels, training them, and eventually fine tuning them on the ImageNet dataset. This model beat the state-of-the-art result by  2% (85% top 1% accuracy).</p><p style="text-indent: 0pt;text-align: left;"/><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1315">Now that we have collected our image datasets, let’s finally begin training them.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;"><a name="bookmark1287">Training Our Model</a><a name="bookmark1316">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;"><a name="bookmark1317">Broadly speaking there are three easy ways to train, all of which we have discussed previously. Here, we provide a brief overview of a few different approaches.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1288">Approach 1: Use Web UI-based Tools</a><a name="bookmark1318">&zwnj;</a></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark828" class="s30" name="bookmark1319">As discussed in </a>Chapter 8<span style=" color: #000;">, there are several tools to build custom models by supplying labeled images and performing training using the web UI. Microsoft’s CustomVision.ai, Google AutoML, IBM Watson Visual Recognition, Clarifai, and Baidu EZDL are a few examples. These methods are code free and many provide simple drag-and-drop GUIs for training.</span></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1320">Let’s look at how we can have a mobile-friendly model ready in less than five minutes using CustomVision.ai:</a></p><ol id="l38"><li><p class="s116" style="padding-top: 4pt;padding-left: 52pt;text-indent: -15pt;text-align: left;"><a href="http://customvision.ai/" class="s30" target="_blank">Go to </a>http://customvision.ai<a href="#bookmark1321" class="s30">, and make a new project. Because we want to export the trained model to a mobile phone, select a compact model type. Since our domain is food related, select “Food (Compact),” as shown in </a><a href="#bookmark1321" class="s18">Figure </a><span class="s39">12-5</span><span class="s17">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 68pt;text-indent: 0pt;text-align: left;"><span><img width="498" height="800" alt="image" src="KerasTensorFlow2019/Image_757.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a name="bookmark1321">Figure 12-5. Define a new project on CustomVision.ai</a></p></li><li><p class="s17" style="padding-top: 3pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Upload the images and assign tags (labels), as depicted in<a href="#bookmark1322" class="s18"> </a><span style=" color: #8E0012;">Figure 12-6</span>. Upload at least 30 images per tag.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 58pt;text-indent: 0pt;text-align: left;"><span><img width="520" height="651" alt="image" src="KerasTensorFlow2019/Image_758.jpg"/></span></p><p class="s19" style="padding-top: 7pt;padding-left: 119pt;text-indent: -65pt;text-align: left;"><a name="bookmark1322">Figure 12-6. Uploading images on the CustomVision.ai dashboard. Note that the tags have been populated as Hotdog and Not Hotdog</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-top: 9pt;padding-left: 52pt;text-indent: -15pt;text-align: left;"><a href="#bookmark1323" class="s30">Click the Train button. A dialog box opens, as shown in </a><a href="#bookmark1323" class="s18">Figure 12-</a></p><p class="s17" style="padding-left: 52pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1323" class="s18">7</a>. Fast Training essentially trains the last few layers, whereas Advanced Training can potentially tune the full network giving even higher accuracy (and obviously take more time and money). The Fast Training option should be sufficient for most cases.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 69pt;text-indent: 0pt;text-align: left;"><span><img width="496" height="188" alt="image" src="KerasTensorFlow2019/Image_759.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 160pt;text-indent: 0pt;text-align: left;"><a name="bookmark1323">Figure 12-7. Options for training type</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-top: 10pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">In under a minute, a screen should appear, showing the precision and recall for the newly trained model per category, as shown in<a href="#bookmark1324" class="s18"> </a><span style=" color: #8E0012;">Figure 12-8</span>. (This should ring a bell because we had discussed precision and recall earlier in the book.)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 61pt;text-indent: 0pt;text-align: left;"><span><img width="507" height="439" alt="image" src="KerasTensorFlow2019/Image_760.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 53pt;text-indent: 0pt;text-align: left;"><a name="bookmark1324">Figure 12-8. Precision, Recall, and Average Precision of the newly trained model</a></p></li><li><p class="s17" style="padding-top: 3pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Play with the probability threshold to see how it changes the model’s performance. The default 90% threshold achieves pretty good results. The higher the threshold, the more precise the model becomes, but at the expense of reduced recall.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s39" style="padding-left: 52pt;text-indent: -15pt;text-align: left;"><a href="#bookmark1325" class="s30">Press the Export button and select the iOS platform (</a>Figure 12-9<span style=" color: #000;">). Internally, CustomVision.ai converts the model to Core ML (or TensorFlow Lite if you’re exporting for Android).</span></p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 69pt;text-indent: 0pt;text-align: left;"><span><img width="498" height="606" alt="image" src="KerasTensorFlow2019/Image_761.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 104pt;text-indent: 0pt;text-align: left;"><a name="bookmark1325">Figure 12-9. The model exporter options in CustomVision.ai</a></p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1326">And we’re done, all without writing a single line of code! Now let’s look at an even more convenient way of training without coding.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1289">Approach 2: Use Create ML</a><a name="bookmark1327">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;"><a name="bookmark1328">In 2018, Apple launched Create ML as a way for developers within the Apple ecosystem to train computer-vision models natively. Developers could open a </a><i>playground </i>and write a few lines of Swift code to train an image classifier. Alternatively, they could use <span class="s42">CreateMLUI </span>import to display a limited GUI training experience within the playground. It was a good way to get Swift developers to deploy Core ML models without requiring much experience in machine learning.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">A year later, at the Apple Worldwide Developers Conference (WWDC) 2019, Apple lowered the barrier even further by announcing the standalone Create ML app on macOS Catalina (10.15). It provides an easy-to-use GUI to train neural networks without needing to write any code at all. Training a neural network simply became a matter of dragging and dropping files into this UI. In addition to supporting the image classifier, they also announced support for object detectors, NLP, sound classification, activity classification (classify activities based on motion sensor data from Apple Watch and iPhone), as well as tabular data (including recommendation systems).</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">And, it’s fast! Models can be trained in under a minute. This is because it uses transfer learning, so it doesn’t need to train all of the layers in the network. It also supports various data augmentations such as rotations, blur, noise, and so on, and all you need to do is click checkboxes.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Before Create ML came along, it was generally a given that anyone seeking to train a serious neural network in a reasonable amount of time had to own an NVIDIA GPU. Create ML took advantage of the onboard Intel and/or Radeon graphics cards, which allowed faster training on MacBooks without the need to purchase additional hardware. Create ML allows us to train multiple models, from different data sources, all at the same time. It can benefit particularly from powerful hardware such as the Mac Pro or even an external GPU (eGPU).</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">One major motivation to use Create ML is the size of the models it outputs. A full model can be broken down into a base model (which emits features) and lighter task-specific classification layers. Apple ships the base models into each of its operating systems. So, Create ML just needs to output the task-specific classifier. How small are these models? As little as a few kilobytes (compared to more than 15 MB for a MobileNet model, which is already pretty small for a CNN). This is important in a day and age when more and more app developers are beginning to incorporate deep learning</p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">into their apps. The same neural networks do not need to be unnecessarily replicated across several apps consuming valuable storage space.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In short, Create ML is easy, speedy, and tiny. Sounds too good to be true. Turns out the flip-side of having full vertical integration is that the developers are tied into the Apple ecosystem. Create ML exports only</p><p class="s22" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">.mlmodel <span class="s17">files, which can be used exclusively on Apple operating systems such as iOS, iPadOS, macOS, tvOS, and watchOS. Sadly, Android integration is not yet a reality for Create ML.</span></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">In this section, we build the Not Hotdog classifier using Create ML:</p><ol id="l39"><li><p class="s17" style="padding-top: 6pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Open the Create ML app, click New Document, and select the Image Classifier template from among the several options available (including Sound, Activity, Text, Tabular), as shown in<a href="#bookmark1329" class="s18"> </a><span style=" color: #8E0012;">Figure 12-10</span>. Note that this is only available on Xcode 11 (or greater), on macOS 10.15 (or greater).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 53pt;text-indent: 0pt;text-align: left;"><span><img width="533" height="541" alt="image" src="KerasTensorFlow2019/Image_762.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 122pt;text-indent: 0pt;text-align: left;"><a name="bookmark1329">Figure 12-10. Choosing a template for a new project</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-top: 10pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">In the next screen, enter a name for the project, and then select Done.</p></li><li><p class="s17" style="padding-top: 13pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">We need to sort the data into the correct directory structure. As<a href="#bookmark1330" class="s18"> Figure </a><span style=" color: #8E0012;">12-11 </span>illustrates, we place images in directories that have the names of their labels. It is useful to have separate train and test datasets with their corresponding directories.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 53pt;text-indent: 0pt;text-align: left;"><span><img width="528" height="147" alt="image" src="KerasTensorFlow2019/Image_763.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 114pt;text-indent: 0pt;text-align: left;"><a name="bookmark1330">Figure 12-11. Train and test data in separate directories</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-top: 10pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Point the UI to the training and test data directories, as shown in<a href="#bookmark1331" class="s18"> Figure </a><span style=" color: #8E0012;">12-12</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 53pt;text-indent: 0pt;text-align: left;"><span><img width="533" height="354" alt="image" src="KerasTensorFlow2019/Image_764.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 140pt;text-indent: 0pt;text-align: left;"><a name="bookmark1331">Figure 12-12. Training interface in Create ML</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s39" style="padding-top: 10pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">Figure 12-12 <a href="#bookmark1332" class="s30">shows the UI after you select the train and test data directories. Notice that the validation data was automatically selected by Create ML. Additionally, notice the augmentation options available. It is at this point that we can click the Play button (the right-facing triangle; see </a>Figure 12-13<span style=" color: #000;">) to start the training process.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 53pt;text-indent: 0pt;text-align: left;"><span><img width="532" height="438" alt="image" src="KerasTensorFlow2019/Image_765.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 66pt;text-indent: 0pt;text-align: left;"><a name="bookmark1332">Figure 12-13. Create ML screen that opens after loading train and test data</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="474" height="148" alt="image" src="KerasTensorFlow2019/Image_766.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 158pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">As you experiment, you will quickly notice that each augmentation that we add will make the training slower. To set a quick baseline performance metric, we should avoid using augmentations in the first run. Subsequently, we can experiment with adding more and more augmentations to assess how they affect the quality of the model.</p><p style="text-indent: 0pt;text-align: left;"/></li><li><p class="s39" style="padding-top: 4pt;padding-left: 52pt;text-indent: -15pt;text-align: left;"><a href="#bookmark1333" class="s30">When the training completes, we can see how the model performed on the training data, (auto-selected) validation data, and the test data, as depicted in </a>Figure 12-14<span style=" color: #000;">. At the bottom of the screen, we can also observe how long the training process took and the size of the final model. 97% test accuracy in under two minutes. And all that with a 17 KB output. Not too shabby.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 53pt;text-indent: 0pt;text-align: left;"><span><img width="532" height="355" alt="image" src="KerasTensorFlow2019/Image_767.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 102pt;text-indent: 0pt;text-align: left;"><a name="bookmark1333">Figure 12-14. The Create ML screen after training completes</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-top: 10pt;padding-left: 52pt;text-indent: -15pt;text-align: left;"><a href="#bookmark1333" class="s30">We’re so close now — we just need to export the final model. Drag the Output button (highlighted in </a><span style=" color: #8E0012;">Figure 12-14</span>) to the desktop to create the <i>.mlmodel </i>file.</p></li><li><p class="s17" style="padding-top: 13pt;padding-left: 52pt;text-indent: -15pt;text-align: left;">We can double-click on the newly exported <i>.mlmodel </i><a href="#bookmark1334" class="s30">file to inspect the input and output layers, as well as test drive the model by dropping images into it, as shown in </a><a href="#bookmark1334" class="s18">Figure </a><span style=" color: #8E0012;">12-15</span>.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 53pt;text-indent: 0pt;text-align: left;"><span><img width="532" height="438" alt="image" src="KerasTensorFlow2019/Image_768.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 126pt;text-indent: 0pt;text-align: left;"><a name="bookmark1334">Figure 12-15. The model inspector UI within Xcode</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="536" height="219" alt="image" src="KerasTensorFlow2019/Image_769.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s26" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1335">Create ML uses transfer learning, training only the last few layers. Depending on your use case, the underlying model that Apple provides you might be insufficient to make high-quality predictions. This is because you are unable to train the earlier layers in the model, thereby restricting the potential to which the model can be tuned. For most day-to-day problems, this should not be an  issue. However, for very domain-specific applications like X-rays, or very</a></p><p class="s26" style="padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1336">similar-looking objects for which the tiniest of details matter (like distinguishing currency notes), training a full CNN would be a better approach. We look at doing so in the following section.</a></p><p style="text-indent: 0pt;text-align: left;"/><p class="s17" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">The model is now ready to be plugged into apps on any Apple device.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1290">Approach 3: Fine Tuning Using Keras</a><a name="bookmark1337">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark227" class="s30" name="bookmark1338">By now, we have become experts in using Keras. This option can get us even higher accuracy if we are up for experimentation and are willing to spend more time training the model. Let’s reuse the code from </a><span style=" color: #8E0012;">Chapter 3 </span><a href="http://practicaldeeplearning.ai/" class="s30" target="_blank">and modify parameters such as directory and filename, batch size, and number of images. You will find the code on the book’s GitHub website (see </a><span class="s116">http://PracticalDeepLearning.ai</span>) at <i>code/chapter-12/1-keras-custom- classifier-with-transfer-learning.ipynb</i>.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1339">The model training should take a few minutes to complete, depending on the hardware, and at the end of the training, we should have a </a><i>NotHotDog.h5 </i>file ready on the disk.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1291">Model Conversion Using Core ML Tools</a><a name="bookmark1340">&zwnj;</a></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1183" class="s30" name="bookmark1341">As discussed in </a>Chapter 11<span style=" color: #000;">, there are several ways of converting our models to the Core ML format.</span></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 113%;text-align: left;"><a name="bookmark1342">Models generated from CustomVision.ai are directly available in Core ML format, hence no conversion is necessary. For models trained in Keras, Core ML Tools can help convert as follows. Note that because we are using a MobileNet model, which uses a custom layer called </a><span class="s42">relu6</span>, we need to import <span class="s42">CustomObjectScope</span>:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s77" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">tensorflow.keras.models </span>import <span class="s74">load_model</span></p><p class="s77" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">tensorflow.keras.utils.generic_utils </span>import <span class="s74">CustomObjectScope</span></p><p class="s77" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">tensorflow.keras</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;"><span class="s77">with </span><span style=" color: #000087;">CustomObjectScope</span>({<span style=" color: #C30;">&#39;relu6&#39;</span>: <span style=" color: #000087;">tensorflow</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">applications</span>.<span style=" color: #000087;">mobilenet</span>.<span style=" color: #000087;">relu6</span>,<span style=" color: #C30;">&#39;DepthwiseConv2D&#39;</span>: <span style=" color: #000087;">tensorflow</span>.<span style=" color: #000087;">keras</span>.<span style=" color: #000087;">applications</span>.<span style=" color: #000087;">mobilenet</span>.<span style=" color: #000087;">DepthwiseConv2D</span>}):</p><p class="s75" style="padding-left: 41pt;text-indent: 0pt;line-height: 10pt;text-align: left;"><span style=" color: #000087;">model </span>= <span style=" color: #000087;">load_model</span>(<span style=" color: #C30;">&#39;NotHotDog-model.h5&#39;</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s77" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">coremltools</span></p><p class="s74" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">coreml_model <span class="s134">= </span>coremltools<span class="s134">.</span>converters<span class="s134">.</span>keras<span class="s134">.</span>convert<span style=" color: #000;">(</span>model<span style=" color: #000;">) </span>coreml_model<span class="s134">.</span>save<span style=" color: #000;">(</span><span style=" color: #C30;">&#39;NotHotDog.mlmodel&#39;</span><span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Now that we have a Core ML model ready, all we need to do is build the app.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1292">Building the iOS App</a><a name="bookmark1343">&zwnj;</a></p><p class="s39" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1183" class="s30" name="bookmark1344">We can use the code from </a>Chapter 11 <span style=" color: #000;">and simply replace the </span><span class="s22">.mlmodel</span></p><p class="s39" style="padding-top: 1pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1345" class="s30">with the newly generated model file, as demonstrated in </a>Figure 12-16<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 27pt;text-indent: 0pt;text-align: left;"><span><img width="535" height="76" alt="image" src="KerasTensorFlow2019/Image_770.jpg"/></span></p><p class="s19" style="padding-top: 6pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1345">Figure 12-16. Loading the </a><span class="s32">.mlmodel </span>into Xcode</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s39" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1346" class="s30">Now, compile and run the app and you’re done! </a>Figure 12-17 <span style=" color: #000;">presents the awesome results.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 31pt;text-indent: 0pt;text-align: left;"><span><img width="524" height="821" alt="image" src="KerasTensorFlow2019/Image_771.jpg"/></span></p><p class="s19" style="padding-top: 7pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1346">Figure 12-17. Our app identifying the hot dog</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1293">Further Exploration</a><a name="bookmark1347">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Can we make this application more interesting? We can build an actual “Shazam for food” by training for all the categories in the Food-101 dataset, which we cover in the next chapter. Additionally, we can enhance the UI compared to the barebones percentages our current app shows.</p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">And, to make it viral just like “Not Hotdog,” provide a way to share the classifications to social media platforms.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s20" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1294">Summary</a><a name="bookmark1348">&zwnj;</a></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In this chapter, we worked through an end-to-end pipeline of collecting data, training and converting a model, and using it in the real world on an iOS device. For each step of the pipeline, we have explored a few different options in varying degrees of complexity. And, we have placed the concepts covered in the previous chapters in the context of a real-world application.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1349">And now, like Jian-Yang, go make your millions!</a></p><p class="s165" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1350">Chapter 13. Shazam for Food: Developing Android Apps with TensorFlow Lite and ML Kit</a><a name="bookmark1389">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="593" height="1" alt="image" src="KerasTensorFlow2019/Image_772.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s148" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1295" class="s160" name="bookmark1390">After developing the viral Not Hotdog app (that we looked at in </a>Chapter 12<a href="#bookmark1392" class="s160">), Jian-Yang was originally supposed to build a classifier to recognize all food in existence. In fact, the app was originally supposed to be called SeeFood — an app that can “see” food and know it right away (</a>Figure 13-1<span style=" color: #000;">). In other words, the “Shazam for Food.” However, the app was too successful for its own good and was acquired by Periscope. The original vision of his investor, Erlich Bachman, remains unfulfilled. In this chapter, our mission is to fulfill this dream.</span><a name="bookmark1391">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 51pt;text-indent: 0pt;text-align: left;"><span><img width="471" height="225" alt="image" src="KerasTensorFlow2019/Image_773.jpg"/></span></p><p class="s145" style="padding-top: 10pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1392">Figure 13-1. Not Hotdog app listing on the Apple App Store</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Where would such a feature be useful? For health nuts, it could look at a dish and provide the nutritional information, including the number of calories. Or, it could scan a few ingredients, and recommend a recipe based on them. Or, it could even look at a product in the market, and check whether it contains any blacklisted ingredients such as specific allergens.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1393">This is an interesting problem to solve for several reasons because it represents several challenges:</a></p><p class="s142" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Data collection challenge</p><p class="s12" style="padding-top: 3pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">There are more than a hundred cuisines around the world, each with hundreds if not thousands of dishes.</p><p class="s142" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Accuracy challenge</p><p class="s12" style="padding-top: 3pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">It should be right most of the time.</p><p class="s142" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;">Performance challenge</p><p class="s12" style="padding-top: 3pt;padding-left: 31pt;text-indent: 0pt;text-align: justify;">It should run near instantly.</p><p class="s142" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;">Platform challenge</p><p class="s12" style="padding-top: 3pt;padding-left: 31pt;text-indent: 0pt;text-align: justify;">An iPhone app alone would be insufficient. A lot of users in developing countries use less powerful smartphones, particularly Android devices. Cross-platform development is a must.</p><p class="s148" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1183" class="s160">Making a food classifier app for one cuisine is tricky enough. Imagine having to do that for every food in existence — and doing it on two platforms! An individual or a small team will quickly run into scaling issues trying to tackle this problem. In this chapter, we use this example as a motivation to explore the different parts of the mobile AI development life cycle that we explored in </a>Chapter 11<span style=" color: #000;">.</span></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: justify;">The material we explore here does not need to be limited to smartphones, either. We can apply our learnings beyond mobile to edge devices such as Google Coral and Raspberry Pi, which we discuss later in the book.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s166" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1351">The Life Cycle of a Food Classifier App</a><a name="bookmark1394">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1395">So, we want to build a global multicuisine, multiplatform food classifier. It sounds like a daunting task, but we can break it down into manageable steps. As in life, we first need to crawl, then walk, and then run. The following is one potential approach to consider:</a></p><ol id="l40"><li><p class="s12" style="padding-top: 4pt;padding-left: 50pt;text-indent: -14pt;text-align: left;">Collect a small initial set images for a single cuisine (e.g., Italian).</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Label these images with their corresponding dish identifiers (e.g.,</p><p class="s156" style="padding-left: 50pt;text-indent: 0pt;text-align: left;">margherita_pizza<span class="s12">).</span></p></li><li><p class="s12" style="padding-top: 12pt;padding-left: 50pt;text-indent: -14pt;text-align: left;">Train a classifier model.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Convert the model to a mobile framework-compatible format (e.g.,</p><p class="s142" style="padding-left: 50pt;text-indent: 0pt;text-align: left;">.tflite<span class="s12">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Build a mobile app by integrating the model with a great UX.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Recruit alpha users and share the app with them.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Collect detailed usage metrics along with feedback from active users, including camera frames (which tend to reflect real-world usage) and corresponding proxy labels (indicating whether the classification was right or wrong).</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">Improve the model using the newly collected images as additional training data. This process needs to be iterative.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">When the quality of the model meets the minimum quality bar, ship the app/feature to more/all users. Continue to monitor and improve the quality of the model for that cuisine.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -21pt;text-align: left;">Repeat these steps for each cuisine.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="540" height="173" alt="image" src="KerasTensorFlow2019/Image_774.png"/></span></p><p class="s146" style="padding-top: 9pt;padding-left: 183pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s147" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">For step 7, we could alternatively integrate the feedback within the UX itself. For example, the app could show a ranked list of predictions (by probability) that are likely candidates for a given picture. If our model is doing well, the user should be selecting the first option most of the time. Selecting a lower ranked prediction would essentially be considered an incorrect prediction. In the worst case, if none of the options were correct, allow the user to manually add a new label. That photo, along with the label (in all three scenarios), can be incorporated as training data.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s12" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">We don’t need a whole lot of data to get underway. Although each of the aforementioned steps might sound involved, we can significantly automate the</p><p style="text-indent: 0pt;text-align: left;"><span><img width="540" height="224" alt="image" src="KerasTensorFlow2019/Image_775.png"/></span></p><p class="s146" style="padding-top: 9pt;padding-left: 183pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s147" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">A die-hard fan of your app/company would make for a good alpha user. Alpha users ideally are people who have a vested interest in the success of your product. For a food recognition app, a potential group of users could be fitness buffs who watch every calorie and ingredient they eat. These users understand that the quality of the app will not be up to par early on, but they also see their role in shaping it through consistent, constructive feedback. They voluntarily agree to a liberal data-sharing agreement in order to provide data such as usage metrics and image frames from day-to-day use. We would recommend that your users know exactly what information you would be collecting about them and allow them to opt out or delete. Don’t be creepy!</p><p style="text-indent: 0pt;text-align: left;"/><p class="s12" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">process. What’s cool about this approach is that the more the app is used, the better it becomes, automatically. It’s as if it has a life of its own. We explore this self-evolving approach for a model toward the end of the chapter.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1396">In this chapter, we explore the different parts of the aforementioned life cycle and the tools that help us with each of those steps. In the end, we will take a holistic, end-to-end look at the entire mobile development life cycle, not just from this chapter, but also from the previous chapters, and combine them to see how we could effectively use them in building a production-quality, real- world application.</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1397">Our journey begins with understanding the following tools from the Google ecosystem.</a></p><p class="s142" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">TensorFlow Lite</p><p class="s12" style="padding-top: 3pt;padding-left: 31pt;text-indent: 0pt;text-align: justify;">Model conversion and mobile inference engine.</p><p class="s142" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">ML Kit</p><p class="s12" style="padding-top: 3pt;padding-left: 31pt;text-indent: 0pt;text-align: justify;">High-level software development kit (SDK) with several built-in APIs, along with the ability to run custom TensorFlow Lite models as well as integration with Firebase on Google Cloud.</p><p class="s142" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Firebase</p><p class="s12" style="padding-top: 3pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">A cloud-based framework that provides the necessary infrastructure for production-quality mobile applications, including analytics, crash reporting, A/B testing, push notifications, and more.</p><p class="s142" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">TensorFlow Model Optimization Toolkit</p><p class="s12" style="padding-top: 3pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">A set of tools for optimizing the size and performance of models.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s166" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1352">An Overview of TensorFlow Lite</a><a name="bookmark1398">&zwnj;</a></p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1183" class="s160" name="bookmark1399">As mentioned in </a>Chapter 11<span style=" color: #000;">, Google released an on-device inference engine called TensorFlow Lite that expanded the reach of the TensorFlow ecosystem beyond the cloud and desktops. Prior to this, the options within the TensorFlow ecosystem were porting the entire TensorFlow library itself to iOS (which was heavy and slow) and, later on, its slightly stripped-down version called TensorFlow Mobile (an improvement, but still fairly bulky).</span></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">TensorFlow Lite is optimized from the ground up for mobile, with the following salient features:</p><p class="s142" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Small</p><p class="s12" style="padding-top: 3pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">TensorFlow Lite comes packaged with a much lighter interpreter. Even with all the operators included, the interpreter is less than 300 KB. In typical usage with common models like MobileNet, we can expect that footprint to be less than 200 KB. For reference, the previous generation TensorFlow Mobile used to occupy 1.5 MB. Additionally, TensorFlow Lite uses s<i>elective registration — </i>it packages only the operations that it knows will be used by the model, minimizing unnecessary overheads.</p><p class="s142" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Fast</p><p class="s12" style="padding-top: 3pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">TensorFlow Lite provides a significant speedup because it is able to take advantage of on-device <i>hardware acceleration such as </i>GPUs and NPUs, where available. In the Android ecosystem, it uses the Android Neural Networks API for acceleration. Analogously on iPhones, it uses the Metal API. Google claims two to seven times speedup over a range of tasks when using GPUs (relative to CPUs).</p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">TensorFlow uses Protocol Buffers (Protobufs) for deserialization/serialization. Protobufs are a powerful tool for representing data due to their flexibility and extensibility. However, that comes at a performance cost that can be felt on low-power devices such as mobiles. <i>FlatBuffers </i>turned out to be the answer to this problem. Originally built for video game development, for which low overhead and high performance are a must, they proved to be a good solution for mobiles as well in significantly reducing the code footprint, memory usage, and CPU cycles spent for serialization and deserialization of models. This also improved start-up time by a fair amount.</p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">Within a network, there are some layers that have fixed computations at inference time; for example, the batch normalization layers, which can be precomputed because they rely on values obtained during training, such as mean and standard deviation. So, the batch normalization layer computation can be fused (i.e., combined) with the previous layer’s computation ahead of time (i.e., during model conversion), thereby reducing the inference time and making the entire model much faster. This is known as <i>prefused activation</i>, which TensorFlow Lite supports.</p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">The interpreter uses static memory and a static execution plan. This helps in decreasing the model load time.</p><p class="s142" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Fewer dependencies</p><p class="s12" style="padding-top: 3pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">The TensorFlow Lite codebase is mostly standard C/C++ with a minimal number of dependencies. It makes it easier to package and deploy and additionally reduces the size of the deployed package.</p><p class="s142" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Supports custom operators</p><p class="s12" style="padding-top: 3pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">TensorFlow Lite contains quantized and floating-point core operators, many of which have been tuned for mobile platforms, and can be used to create and run custom models. If TensorFlow Lite does not support an operation in our model, we can also write custom operators to get our model running.</p><p class="s12" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Before we build our initial Android app, it would be useful to examine TensorFlow Lite’s architecture.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s153" style="padding-left: 144pt;text-indent: 0pt;text-align: center;">FROM THE CREATOR’S DESK</p><p style="padding-top: 5pt;padding-left: 9pt;text-indent: 0pt;text-align: left;"><a href="http://shop.oreilly.com/product/0636920254508.do" style=" color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10.5pt;" target="_blank">By Pete Warden, technical lead for Mobile and Embedded TensorFlow, author of </a><a href="http://shop.oreilly.com/product/0636920254508.do" class="s155" target="_blank">TinyML</a></p><p class="s147" style="padding-left: 9pt;text-indent: 0pt;text-align: left;">(O’Reilly)</p><p class="s147" style="padding-top: 5pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">When I wrote my first neural network inference engine back in 2013, it was because I couldn’t find any other way to run image recognition models on the cheap AWS servers that were all we could afford at our startup. It was a happy accident that the same code was easy to build for iOS and Android, and I quickly realized that the possibilities for deep learning on mobile platforms were endless. That code became the Jetpac SDK, and I had tremendous fun seeing all the applications people built with it in the early days. When we were acquired by Google, I met Yangqing Jia (of Caffe fame), who was working on an internal 20% project to run inference on mobile devices, so we ended up collaborating and eventually a lot of what we learned ended up in the public release of TensorFlow. A lot of people were skeptical about the value of neural networks on phones, but Jeff Dean was always a firm supporter and he helped us ensure we had Android support right from the start, and iOS very soon after. We learned a lot from those initial TensorFlow releases, and the Mobile Vision team within Google had done some amazing work with their own specialized internal framework, so we joined forces to create TensorFlow Lite as a library offering TensorFlow compatibility, but with a much smaller footprint.</p><p class="s147" style="padding-top: 5pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Since launch, TensorFlow Lite has been shipped in production on over two billion devices, but none of that could have happened without the community that’s grown up around it. It’s been amazing to see all the contributions, examples, and peer-to-peer support that has enabled people to build applications that wouldn’t have been possible without the ecosystem working together.</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="590" height="436" alt="image" src="KerasTensorFlow2019/Image_776.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1353">TensorFlow Lite Architecture</a><a name="bookmark1400">&zwnj;</a></p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1402" class="s143" name="bookmark1401">Figure 13-2</a> <span style=" color: #000;">provides a high-level view of the TensorFlow Lite architecture.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 45pt;text-indent: 0pt;text-align: left;"><span><img width="488" height="325" alt="image" src="KerasTensorFlow2019/Image_777.jpg"/></span></p><p class="s145" style="padding-top: 9pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1402">Figure 13-2. High-level architecture of the TensorFlow Lite ecosystem</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">As app developers, we will be working in the topmost layer while interacting with the TensorFlow Lite API (or optionally with ML Kit, which in turn uses TensorFlow Lite). The TensorFlow Lite API abstracts away all of the complexities involved in using a lower-level API such as the Android’s Neural Network API. Recall that this is similar to how Core ML works within the Apple ecosystem.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Looking at the other extreme, computations can be run on various types of hardware modules. The most common among them is the CPU, simply because of its ubiquity and flexibility. Modern smartphones are increasingly equipped with specialized modules, including the GPU and the newer NPU (especially built for neural network computations like on the iPhone X).</p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Additionally, Digital Signal Processors (DSP) specialize in singular tasks such as facial authentication, fingerprint authentication, and wake word detection (like “Hey Siri”).</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1403">In the world of Internet of Things (IoT), microcontrollers (MCUs) reign supreme. With no OS, no processor, and very little memory (KBs), these are cheap to produce in mass quantities and easy to incorporate into various applications.</a></p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">With TensorFlow Lite for Microcontrollers, developers can run AI on these bare- metal devices without needing internet connectivity. The pared-down version</p><p class="s12" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">(roughly 20 KB) of the TensorFlow Lite Interpreter for MCUs is called the TensorFlow Lite Micro Interpreter.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">So how does TensorFlow Lite interact with hardware? By using delegates that are platform-aware objects that expose a consistent platform-agnostic API. In other words, delegates shield the interpreter from needing to know anything about the specific hardware it runs on. They take on all or part of the responsibility of graph execution that would have otherwise been run on the CPU and instead run on the much more efficient GPUs and NPUs. On Android, the GPU delegate accelerates performance using OpenGL, whereas on iOS, the Metal API is used.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Given that TensorFlow Lite by itself is platform agnostic, it needs to call into a platform-specific library that implements a known contract. This contract is the TensorFlow Lite Delegate API. Within Android, this contract is fulfilled by the Android Neural Network API (available on devices running Android 8.1 and above). The Neural Network API is designed to provide a base layer of functionality for higher-level machine learning frameworks. The equivalent of the Neural Network API within the Apple world is Metal Performance Shaders.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">With the information we have looked at so far, let’s get hands on.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s166" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1354">Model Conversion to TensorFlow Lite</a><a name="bookmark1404">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1405">At this point in the book, we should already have a model at hand (either pretrained on ImageNet or custom trained in Keras). Before we can plug that model into an Android app, we need to convert it to the TensorFlow Lite format (a .</a><i>tflite </i>file).</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 113%;text-align: left;">Let’s take a look at how to convert the model using the TensorFlow Lite Converter tool, the <span class="s156">tflite_convert </span>command that comes bundled with our TensorFlow installation:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s168" style="padding-left: 18pt;text-indent: 0pt;text-align: left;"># Keras to TensorFlow Lite</p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">$ tflite_convert \</p><p class="s113" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">--output_file=my_model.tflite \</p><p class="s113" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">--keras_model_file=my_model.h5</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s168" style="padding-left: 18pt;text-indent: 0pt;text-align: left;"># TensorFlow to TensorFlow Lite</p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">$ tflite_convert \</p><p class="s113" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">--output_file=my_model.tflite \</p><p class="s113" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">--graph_def_file=my_model/frozen_graph.pb</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">The output of this command is the new <i>my_model.tflite </i>file, which we can then plug into the Android app in the following section. Later, we look at how to make that model more performant by using the <span class="s156">tflite_convert </span>tool again.</p><p class="s12" style="padding-top: 1pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Additionally, the TensorFlow Lite team has created many pretrained models that are available in TensorFlow Lite format, saving us this conversation step.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s166" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1355">Building a Real-Time Object Recognition App</a><a name="bookmark1406">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1407">Running the sample app from the TensorFlow repository is an easy way to play with the TensorFlow Lite API. Note that we would need an Android phone or tablet to run the app. Following are steps to build and deploy the app:</a></p><ol id="l41"><li><p class="s12" style="padding-top: 4pt;padding-left: 50pt;text-indent: -14pt;text-align: left;">Clone the TensorFlow repository:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s113" style="padding-left: 62pt;text-indent: 0pt;text-align: left;">git clone https://github.com/tensorflow/tensorflow.git</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-top: 5pt;padding-left: 50pt;text-indent: -14pt;text-align: left;"><a name="bookmark1408">Download and install Android Studio from</a></p><p class="s161" style="padding-left: 50pt;text-indent: 0pt;text-align: left;">https://developer.android.com/studio<span class="s12">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s148" style="padding-left: 50pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1409" class="s160">Open Android Studio and then select “Open an existing Android Studio project” (</a><a href="#bookmark1409" class="s143">Figure </a>13-3<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 61pt;text-indent: 0pt;text-align: left;"><span><img width="508" height="512" alt="image" src="KerasTensorFlow2019/Image_778.jpg"/></span></p><p class="s145" style="padding-top: 2pt;padding-left: 150pt;text-indent: 0pt;text-align: left;"><a name="bookmark1409">Figure 13-3. Start screen of Android Studio</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-top: 9pt;padding-left: 50pt;text-indent: -14pt;text-align: left;">Go to the location of the cloned TensorFlow repository and then navigate further to <i>tensorflow/tensorflow/contrib/lite/java/demo/</i></p><p class="s148" style="padding-top: 3pt;padding-left: 50pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1410" class="s160">(</a>Figure 13-4<span style=" color: #000;">). Select Open.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 61pt;text-indent: 0pt;text-align: left;"><span><img width="505" height="312" alt="image" src="KerasTensorFlow2019/Image_779.jpg"/></span></p><p class="s145" style="padding-top: 5pt;padding-left: 226pt;text-indent: -156pt;text-align: left;"><a name="bookmark1410">Figure 13-4. Android Studio “Open Existing Project” screen in the TensorFlow repository</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-top: 9pt;padding-left: 50pt;text-indent: -14pt;text-align: left;">On the Android device, enable Developer Options. (Note that we used a Pixel device here, which uses the stock Android OS. For other manufacturers, the instructions might be a little different.)</p><ol id="l42"><li><p class="s12" style="padding-top: 5pt;padding-left: 75pt;text-indent: -14pt;text-align: left;">Go to Settings.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 75pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1411" class="s160">Scroll down to the About Phone or About Tablet option (</a><a href="#bookmark1411" class="s143">Figure 13-</a></p><p style="padding-left: 75pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1411" class="s143">5</a><a href="#bookmark1411" class="s160">) and select it.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 97pt;text-indent: 0pt;text-align: left;"><span><img width="441" height="768" alt="image" src="KerasTensorFlow2019/Image_780.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 219pt;text-indent: -139pt;text-align: left;"><a name="bookmark1411">Figure 13-5. System information screen on an Android phone; select the About Phone option here</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-top: 9pt;padding-left: 75pt;text-indent: -13pt;text-align: left;">Look for the Build Number row and tap it seven times. (Yeah, you read that right — seven!)</p></li><li><p class="s148" style="padding-top: 3pt;padding-left: 75pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1412" class="s160">You should see a message (</a>Figure 13-6<span style=" color: #000;">) confirming that developer mode is enabled.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 75pt;text-indent: 0pt;text-align: left;"><span><img width="508" height="238" alt="image" src="KerasTensorFlow2019/Image_781.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 123pt;text-indent: 0pt;text-align: left;"><a name="bookmark1412">Figure 13-6. The About Phone screen on an Android device</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-top: 9pt;padding-left: 75pt;text-indent: -14pt;text-align: left;">If you are using a phone, tap the back button to go back to the previous menu.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s148" style="padding-left: 75pt;text-indent: -10pt;text-align: left;"><a href="#bookmark1413" class="s160">You should see a “Developer options” button, directly above the “About phone” or “About tablet” option (</a>Figure 13-7<a href="#bookmark1414" class="s160">). Tab this button to reveal the “Developer options” menu (</a><a href="#bookmark1414" class="s143">Figure </a>13-8<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 97pt;text-indent: 0pt;text-align: left;"><span><img width="441" height="768" alt="image" src="KerasTensorFlow2019/Image_782.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 243pt;text-indent: -151pt;text-align: left;"><a name="bookmark1413">Figure 13-7. The System information screen showing “Developer options” enabled</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 97pt;text-indent: 0pt;text-align: left;"><span><img width="441" height="768" alt="image" src="KerasTensorFlow2019/Image_783.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 217pt;text-indent: -121pt;text-align: left;"><a name="bookmark1414">Figure 13-8. “Developer options” screen on an Android device with USB debugging enabled</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li></ol></li><li><p class="s12" style="padding-top: 9pt;padding-left: 50pt;text-indent: -14pt;text-align: left;">Plug the Android device into the computer via a USB cable.</p></li><li><p class="s148" style="padding-top: 3pt;padding-left: 50pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1415" class="s160">The Android device might show a message asking to allow USB debugging. Enable “Always allow this computer,” and then select OK (</a><a href="#bookmark1415" class="s143">Figure </a>13-9<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 84pt;text-indent: 0pt;text-align: left;"><span><img width="441" height="784" alt="image" src="KerasTensorFlow2019/Image_784.jpg"/></span></p><p class="s145" style="padding-top: 2pt;padding-left: 118pt;text-indent: 0pt;text-align: left;"><a name="bookmark1415">Figure 13-9. Allow USB debugging on the displayed alert</a></p></li><li><p class="s148" style="padding-top: 3pt;padding-left: 50pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1416" class="s160">In Android Studio, on the Debug toolbar bar (</a>Figure 13-10<span style=" color: #000;">), click the Run App button (the right-facing triangle).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 61pt;text-indent: 0pt;text-align: left;"><span><img width="507" height="54" alt="image" src="KerasTensorFlow2019/Image_785.jpg"/></span></p><p class="s145" style="padding-top: 5pt;padding-left: 52pt;text-indent: 0pt;text-align: center;"><a name="bookmark1416">Figure 13-10. Debug toolbar in Android Studio</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s148" style="padding-top: 9pt;padding-left: 50pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1417" class="s160">A window opens displaying all the available devices and emulators (</a><a href="#bookmark1417" class="s143">Figure </a>13-11<span style=" color: #000;">). Choose your device, and then select OK.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 61pt;text-indent: 0pt;text-align: left;"><span><img width="499" height="237" alt="image" src="KerasTensorFlow2019/Image_786.jpg"/></span></p><p class="s145" style="padding-top: 7pt;padding-left: 52pt;text-indent: 0pt;text-align: center;"><a name="bookmark1417">Figure 13-11. Select the phone from the deployment target selection screen</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-top: 9pt;padding-left: 50pt;text-indent: -21pt;text-align: left;">The app should install and begin running on our phone.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -19pt;text-align: left;">The app will request permission for your camera; go ahead and grant it permission.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s148" style="padding-left: 50pt;text-indent: -21pt;text-align: left;"><a href="#bookmark1418" class="s160">A live view of the camera should appear, along with real-time predictions of object classification, plus the number of seconds it took to make the prediction, as shown in </a><a href="#bookmark1418" class="s143">Figure </a>13-12<span style=" color: #000;">.</span></p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 84pt;text-indent: 0pt;text-align: left;"><span><img width="440" height="778" alt="image" src="KerasTensorFlow2019/Image_787.jpg"/></span></p><p class="s145" style="padding-top: 5pt;padding-left: 79pt;text-indent: 0pt;text-align: left;"><a name="bookmark1418">Figure 13-12. The app up-and-running app, showing real-time predictions</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1419">And there you have it! We have a basic app running on the phone that takes video frames and classifies them. It’s simple and it works reasonably well.</a></p><p class="s12" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1420">Beyond object classification, the TensorFlow Lite repository also has sample apps (iOS and Android) for many other AI problems, including the following:</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_788.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_789.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_790.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_791.png"/></span></p><p class="s12" style="padding-top: 4pt;padding-left: 31pt;text-indent: 0pt;line-height: 188%;text-align: left;">Object detection Pose estimation Gesture recognition Speech recognition</p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">The great thing about having these sample apps is that with basic instructions, someone without a mobile development background can get them running on a phone. Even better, if we have a custom trained model, we can plug it into the app and see it run for our custom task.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">This is great for starting out. However, things are a lot more complicated in the real world. Developers of serious real-world applications with thousands or even millions of users need to think beyond just inference — like updating and distributing models, testing different versions among subsets of users, maintaining parity between iOS and Android, and ultimately reducing the engineering cost of each. Doing all of this in-house can be expensive, time consuming, and frankly unnecessary. Naturally, platforms that provide these features would be enticing. This is where ML Kit and Firebase come in.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s166" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1356">ML Kit + Firebase</a><a name="bookmark1421">&zwnj;</a></p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark362" class="s160" name="bookmark1422">ML Kit is a mobile SDK launched during the 2018 Google I/O conference. It provides convenient APIs for novices as well as advanced ML developers to do a lot of common ML tasks. By default, ML Kit comes with a generic feature set in vision and language intelligence. </a>Table 4-1 <span style=" color: #000;">lists some of the common ML tasks that we can do in just a few lines.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s142" style="padding-left: 18pt;text-indent: 0pt;text-align: center;">Table 13-1. ML Kit built-in features</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 99pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="343" height="1" alt="image" src="KerasTensorFlow2019/Image_792.png"/></span></p><p class="s153" style="padding-top: 1pt;padding-bottom: 3pt;padding-left: 102pt;text-indent: 0pt;text-align: left;">Vision Language</p><p style="padding-left: 99pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="343" height="1" alt="image" src="KerasTensorFlow2019/Image_793.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s147" style="padding-top: 3pt;padding-left: 102pt;text-indent: 0pt;text-align: left;">Object classification</p><p class="s147" style="padding-top: 5pt;padding-left: 102pt;text-indent: 0pt;line-height: 146%;text-align: left;">Object detection and tracking Popular landmark detection Text recognition</p><p style="text-indent: 0pt;text-align: left;"><span><img width="342" height="1" alt="image" src="KerasTensorFlow2019/Image_794.png"/></span></p><p class="s147" style="padding-left: 102pt;text-indent: 0pt;line-height: 146%;text-align: left;">Face detection Barcode detection</p><p class="s147" style="padding-top: 3pt;padding-left: 4pt;text-indent: 0pt;line-height: 146%;text-align: left;">Language identification On-device translation Smart replies</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1423">ML Kit also gives us the ability to use custom trained TensorFlow Lite models for inference. Let’s take a moment to appreciate why this is so great for developers. Imagine that we were building a business card scanner. We could bring in a custom business card detection model, recognize when a business card is visible and its boundaries (to make a nice visual user interface), run the built-in text recognition, and filter out text outside of those boundaries to prevent extraneous characters. Or, consider a language learning game that can be built by pointing at objects, running an object classifier, and then using the on-device translation API to announce the labels in French. It is entirely possible to build these relatively quickly using ML Kit. Although many of these features are available in Core ML, too, ML Kit has the added advantage of being cross-platform.</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1424">ML Kit, though, is only one piece of the puzzle. It integrates into Google’s Firebase, the mobile and web application development platform that is part of Google Cloud. Firebase offers an array of features that are necessary infrastructure for production-quality apps, such as the following:</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_795.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_796.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_797.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_798.png"/></span></p><p class="s12" style="padding-top: 4pt;padding-left: 31pt;text-indent: 0pt;line-height: 188%;text-align: left;">Push notifications Authentication Crash reporting Logging</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_799.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;line-height: 14pt;text-align: left;">Performance monitoring</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_800.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_801.png"/></span></p><p class="s12" style="padding-top: 3pt;padding-left: 31pt;text-indent: 0pt;line-height: 188%;text-align: left;">Hosted device testing A/B testing</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_802.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;line-height: 14pt;text-align: left;">Model management</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="540" height="214" alt="image" src="KerasTensorFlow2019/Image_803.png"/></span></p><p class="s146" style="padding-top: 9pt;padding-left: 183pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s147" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">For a lot of the built-in functionality, ML Kit optionally provides a feature to process images in the cloud, where the models are much larger compared to on-device models. These larger models obviously require more powerful hardware to run them, with the benefit of providing some improvement in accuracy and potentially a much larger taxonomy (like thousands of object classes instead of hundreds). In fact, some functionality such as the landmark recognition feature works only on the cloud.</p><p class="s147" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">The cloud processing option is particularly useful when we need a little bit of extra accuracy and/or the user’s phone has low processing power that prevents it from running the on-device model well.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s12" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">The last point is very pertinent to us. One of the biggest benefits that Firebase gives us is the ability to host our custom models on the cloud and download them within the app as needed. Simply copy the models over to Firebase on Google Cloud, reference the model on ML Kit inside the app, and we’re good to go. The A/B testing feature gives us the ability to show different users different versions of the same model and measure the performance across the different models.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1357">Object Classification in ML Kit</a><a name="bookmark1425">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1426">For our previous task of object classification in real time, if we use ML Kit instead of vanilla TensorFlow Lite, we can simplify our code to just the following lines (in Kotlin):</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><span class="s169">val </span><span style=" color: #96F;">image </span>= <span style=" color: #000087;">FirebaseVisionImage</span>.<span style=" color: #000087;">fromBitmap</span>(<span style=" color: #000087;">bitmap</span>)</p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><span class="s169">val </span><span style=" color: #96F;">detector </span>= <span style=" color: #000087;">FirebaseVision</span>.<span style=" color: #000087;">getInstance</span>().<span style=" color: #000087;">visionLabelDetector</span></p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><span class="s169">val </span><span style=" color: #96F;">result </span>= <span style=" color: #000087;">detector</span>.<span style=" color: #000087;">detectInImage</span>(<span style=" color: #000087;">image</span>).<span style=" color: #000087;">addOnSuccessListener </span>{ <span style=" color: #000087;">labels </span>-&gt;</p><p class="s172" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">// Print labels</p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">}</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1358">Custom Models in ML Kit</a><a name="bookmark1427">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1428">In addition to the prebuilt models provided by ML Kit, we can also run our own custom models. These models must be in the TensorFlow Lite format.</a></p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Following is a simple piece of code to load a custom model that’s bundled into the app:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><span class="s169">val </span><span style=" color: #96F;">customModel </span>= <span style=" color: #000087;">FirebaseLocalModelSource</span>.<span style=" color: #000087;">Builder</span>(<span style=" color: #C30;">&quot;my_custom_model&quot;</span>)</p><p class="s113" style="padding-left: 18pt;text-indent: 40pt;text-align: left;">.<span style=" color: #000087;">setAssetFilePath</span>(<span style=" color: #C30;">&quot;my_custom_model.tflite&quot;</span>).<span style=" color: #000087;">build</span>() <span style=" color: #000087;">FirebaseModelManager</span>.<span style=" color: #000087;">getInstance</span>().<span style=" color: #000087;">registerLocalModelSource</span>(<span style=" color: #000087;">customModel</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Next, we specify the model’s input and output configuration (for a model that takes in an RGB image of size 224x224 and gives predictions for 1,000 class names):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s169" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">val <span class="s170">IMAGE_WIDTH </span><span class="s113">= </span><span class="s174">224</span></p><p class="s169" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">val <span class="s170">IMAGE_HEIGHT </span><span class="s113">= </span><span class="s174">224</span></p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><span class="s169">val </span><span style=" color: #96F;">modelConfig </span>= <span style=" color: #000087;">FirebaseModelInputOutputOptions</span>.<span style=" color: #000087;">Builder</span>()</p><p class="s113" style="padding-left: 18pt;text-indent: 40pt;text-align: left;">.<span style=" color: #000087;">setInputFormat</span>(<span style=" color: #F60;">O</span>, <span style=" color: #000087;">FirebaseModelDataType</span>.<span style=" color: #000087;">FLOAT32</span>, <span style=" color: #000087;">intArrayOf</span>(<span style=" color: #F60;">1</span>, <span style=" color: #000087;">IMAGE_WIDTH</span>, <span style=" color: #000087;">IMAGE_HEIGHT</span>, <span style=" color: #F60;">3</span>))</p><p class="s113" style="padding-left: 58pt;text-indent: 0pt;text-align: left;">.<span style=" color: #000087;">setOutputFormat</span>(<span style=" color: #F60;">O</span>, <span style=" color: #000087;">FirebaseModelDataType</span>.<span style=" color: #000087;">FLOAT32</span>, <span style=" color: #000087;">intArrayOf</span>(<span style=" color: #F60;">1</span>, <span style=" color: #F60;">1OOO</span>))</p><p class="s113" style="padding-left: 58pt;text-indent: 0pt;text-align: left;">.<span style=" color: #000087;">build</span>()</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Next, we create an array of a single image and normalize each pixel to the range [–1,1]:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><span class="s169">val </span><span style=" color: #96F;">bitmap </span>= <span style=" color: #000087;">Bitmap</span>.<span style=" color: #000087;">createScaledBitmap</span>(<span style=" color: #000087;">image</span>, <span style=" color: #000087;">IMAGE_WIDTH</span>, <span style=" color: #000087;">IMAGE_HEIGHT</span>, <span class="s169">true</span>) <span class="s169">val </span><span style=" color: #96F;">input </span>= <span style=" color: #000087;">Array</span>(<span style=" color: #F60;">1</span>) {</p><p class="s113" style="padding-left: 58pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">Array</span>(<span style=" color: #000087;">IMAGE_WIDTH</span>) { <span style=" color: #000087;">Array</span>(<span style=" color: #000087;">IMAGE_HEIGHT</span>) { <span style=" color: #000087;">FloatArray</span>(<span style=" color: #F60;">3</span>) } }</p><p class="s113" style="padding-left: 58pt;text-indent: 0pt;text-align: left;">}</p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><span class="s169">for </span>(<span style=" color: #000087;">x </span><span class="s169">in </span><span style=" color: #F60;">O.</span>.<span style=" color: #000087;">IMAGE_WIDTH</span>) {</p><p class="s113" style="padding-left: 38pt;text-indent: 0pt;text-align: left;"><span class="s169">for </span>(<span style=" color: #000087;">y </span><span class="s169">in </span><span style=" color: #F60;">O.</span>.<span style=" color: #000087;">IMAGE_HEIGHT</span>) {</p><p class="s113" style="padding-left: 58pt;text-indent: 0pt;text-align: left;"><span class="s169">val </span><span style=" color: #96F;">pixel </span>= <span style=" color: #000087;">bitmap</span>.<span style=" color: #000087;">getPixel</span>(<span style=" color: #000087;">x</span>, <span style=" color: #000087;">y</span>)</p><p class="s113" style="padding-left: 58pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">input</span>[<span style=" color: #F60;">O</span>][<span style=" color: #000087;">x</span>][<span style=" color: #000087;">y</span>][<span style=" color: #F60;">O</span>] = (<span style=" color: #000087;">Color</span>.<span style=" color: #000087;">red</span>(<span style=" color: #000087;">pixel</span>) - <span style=" color: #F60;">127</span>) / <span style=" color: #F60;">128.Of</span></p><p class="s113" style="padding-left: 58pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">input</span>[<span style=" color: #F60;">O</span>][<span style=" color: #000087;">x</span>][<span style=" color: #000087;">y</span>][<span style=" color: #F60;">1</span>] = (<span style=" color: #000087;">Color</span>.<span style=" color: #000087;">green</span>(<span style=" color: #000087;">pixel</span>) - <span style=" color: #F60;">127</span>) / <span style=" color: #F60;">128.Of</span></p><p class="s113" style="padding-left: 58pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">input</span>[<span style=" color: #F60;">O</span>][<span style=" color: #000087;">x</span>][<span style=" color: #000087;">y</span>][<span style=" color: #F60;">2</span>] = (<span style=" color: #000087;">Color</span>.<span style=" color: #000087;">blue</span>(<span style=" color: #000087;">pixel</span>) - <span style=" color: #F60;">127</span>) / <span style=" color: #F60;">128.Of</span></p><p class="s113" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">}</p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">}</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Now, we set up an interpreter based on our custom model:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><span class="s169">val </span><span style=" color: #96F;">options </span>= <span style=" color: #000087;">FirebaseModelOptions</span>.<span style=" color: #000087;">Builder</span>()</p><p class="s113" style="padding-left: 43pt;text-indent: 0pt;text-align: left;">.<span style=" color: #000087;">setLocalModelName</span>(<span style=" color: #C30;">&quot;my_custom_model&quot;</span>).<span style=" color: #000087;">build</span>()</p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><span class="s169">val </span><span style=" color: #96F;">interpreter </span>= <span style=" color: #000087;">FirebaseModelInterpreter</span>.<span style=" color: #000087;">getInstance</span>(<span style=" color: #000087;">options</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Next, we run our input batch on the interpreter:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><span class="s169">val </span><span style=" color: #96F;">modelInputs </span>= <span style=" color: #000087;">FirebaseModelInputs</span>.<span style=" color: #000087;">Builder</span>().<span style=" color: #000087;">add</span>(<span style=" color: #000087;">input</span>).<span style=" color: #000087;">build</span>() <span style=" color: #000087;">interpreter</span>.<span style=" color: #000087;">run</span>(<span style=" color: #000087;">modelInputs</span>, <span style=" color: #000087;">modelConfig</span>).<span style=" color: #000087;">addOnSuccessListener </span>{ <span style=" color: #000087;">result </span>-&gt;</p><p class="s172" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">// Print results</p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">}</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Yup, it’s really that simple! Here, we’ve seen how we can bundle custom models along with the app. Sometimes, we might want the app to dynamically download the model from the cloud for reasons such as the following:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_804.png"/></span></p><p class="s12" style="padding-top: 3pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">We want to keep the default app size small on the Play Store so as to not prevent users with data usage constraints from downloading our app.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_805.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">We want to experiment with a different variety of models and pick the best one based on the available metrics.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_806.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">We want the user to have the latest and greatest model, without having to go through the whole app release process.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_807.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">The feature that needs the model might be optional, and we want to conserve space on the user’s device.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">This brings us to hosted models.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1359">Hosted Models</a><a name="bookmark1429">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1430">ML Kit, along with Firebase, gives us the ability to upload and store our model on Google Cloud and download it from the app when needed. After the model is downloaded, it functions exactly like it would have if we had bundled the model into the app. Additionally, it provides us with the ability to push updates to the model without having to do an entire release of the app. Also, it lets us do experiments with our models to see which ones perform best in the real world. For hosted models, there are two aspects that we need to look at.</a></p><p class="s175" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1360">Accessing a hosted model</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1431">The following lines inform Firebase that we’d like to use the model named</a></p><p class="s156" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">my_remote_custom_model:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><span class="s169">val </span><span style=" color: #96F;">remoteModel </span>= <span style=" color: #000087;">FirebaseCloudModelSource</span>.<span style=" color: #000087;">Builder</span>(<span style=" color: #C30;">&quot;my_remote_custom_model&quot;</span>)</p><p class="s113" style="padding-left: 18pt;text-indent: 40pt;text-align: left;">.<span style=" color: #000087;">enableModelUpdates</span>(<span class="s169">true</span>).<span style=" color: #000087;">build</span>() <span style=" color: #000087;">FirebaseModelManager</span>.<span style=" color: #000087;">getInstance</span>().<span style=" color: #000087;">registerCloudModelSource</span>(<span style=" color: #000087;">remoteModel</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;">Notice that we set <span class="s156">enableModelUpdates </span>to enable us to push updates to the model from the cloud to the device. We can also optionally configure the conditions under which the model would be downloaded for the first time versus every subsequent time — whether the device is idle, whether it’s currently charging, and whether the download is restricted to WiFi networks only.</p><p class="s12" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Next, we set up an interpreter much like we did with our local model:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><span class="s169">val </span><span style=" color: #96F;">options </span>= <span style=" color: #000087;">FirebaseModelOptions</span>.<span style=" color: #000087;">Builder</span>()</p><p class="s113" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">.<span style=" color: #000087;">setCloudModelName</span>(<span style=" color: #C30;">&quot;my_remote_custom_model&quot;</span>).<span style=" color: #000087;">build</span>()</p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><span class="s169">val </span><span style=" color: #96F;">interpreter </span>= <span style=" color: #000087;">FirebaseModelInterpreter</span>.<span style=" color: #000087;">getInstance</span>(<span style=" color: #000087;">options</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">After this point, the code to perform the prediction would look exactly the same as that for local models.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Next, we discuss the other aspect to hosted models — uploading the model.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s175" style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1361">Uploading a hosted model</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1432">As of this writing, Firebase supports only models hosted on GCP. In this section, we walk through the simple process of creating, uploading, and storing a hosted model. This subsection presumes that we already have an existing GCP account.</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">The following lists the steps that we need to take to get a model hosted on the cloud:</p><ol id="l43"><li><p class="s161" style="padding-top: 4pt;padding-left: 50pt;text-indent: -14pt;text-align: left;"><a href="https://console.firebase.google.com/" class="s160" target="_blank">Go to </a>https://console.firebase.google.com<a href="#bookmark1433" class="s160">. Select an existing project or add a new one (</a><a href="#bookmark1433" class="s143">Figure </a><span class="s148">13-13</span><span class="s12">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 61pt;text-indent: 0pt;text-align: left;"><span><img width="498" height="483" alt="image" src="KerasTensorFlow2019/Image_808.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 128pt;text-indent: 0pt;text-align: left;"><a name="bookmark1433">Figure 13-13. Home page of Google Cloud Firebase</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s148" style="padding-top: 9pt;padding-left: 50pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1434" class="s160">On the Project Overview screen, create an Android app (</a>Figure 13-14<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 61pt;text-indent: 0pt;text-align: left;"><span><img width="501" height="407" alt="image" src="KerasTensorFlow2019/Image_809.jpg"/></span></p><p class="s145" style="padding-top: 7pt;padding-left: 87pt;text-indent: 0pt;text-align: left;"><a name="bookmark1434">Figure 13-14. The Project Overview screen on Google Cloud Firebase</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s148" style="padding-top: 9pt;padding-left: 50pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1435" class="s160">Use the app ID from the project in Android Studio (</a>Figure 13-15<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 61pt;text-indent: 0pt;text-align: left;"><span><img width="506" height="520" alt="image" src="KerasTensorFlow2019/Image_810.jpg"/></span></p><p class="s145" style="padding-top: 5pt;padding-left: 141pt;text-indent: 0pt;text-align: left;"><a name="bookmark1435">Figure 13-15. App creation screen on Firebase</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-top: 9pt;padding-left: 50pt;text-indent: -14pt;text-align: left;">After clicking “Register app,” download the configuration file. This configuration file gives the necessary credentials to the app for it to access our cloud account. Add the configuration file and the Firebase SDK to the Android app as shown on the app creation page.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s148" style="padding-left: 50pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1436" class="s160">In the ML Kit section, select Get Started, and then select “Add custom model” (</a><a href="#bookmark1436" class="s143">Figure </a>13-16<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 61pt;text-indent: 0pt;text-align: left;"><span><img width="501" height="347" alt="image" src="KerasTensorFlow2019/Image_811.jpg"/></span></p><p class="s145" style="padding-top: 7pt;padding-left: 146pt;text-indent: 0pt;text-align: left;"><a name="bookmark1436">Figure 13-16. The ML Kit custom models tab</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -14pt;text-align: left;">In the name field, enter <span class="s156">my_remote_custom_model </span>to match the name in the code.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s148" style="padding-left: 50pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1437" class="s160">Upload the model file from your computer (</a>Figure 13-17<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 61pt;text-indent: 0pt;text-align: left;"><span><img width="497" height="380" alt="image" src="KerasTensorFlow2019/Image_812.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 99pt;text-indent: 0pt;text-align: left;"><a name="bookmark1437">Figure 13-17. Uploading a TensorFlow Lite model file to Firebase</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-top: 9pt;padding-left: 50pt;text-indent: -14pt;text-align: left;">Tap the “Publish” button after the file upload completes.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">That’s it! Our model is now ready to be accessed and used from the app dynamically. Next, we examine how we can do A/B testing between models using Firebase.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1362">A/B Testing Hosted Models</a><a name="bookmark1438">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 113%;text-align: left;"><a name="bookmark1439">Let’s take the scenario in which we had a version 1 model named </a><span class="s156">my_model_v1 </span>to start off with and deployed it to our users. After some usage by them, we obtained more data that we were able to train on. The result of this training was <span class="s156">my_model_v2 </span><a href="#bookmark1440" class="s160">(</a><span style=" color: #8E0012;">Figure 13-18</span>). We want to assess whether this new version would give us better results. This is where A/B testing comes in.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 39pt;text-indent: 0pt;text-align: left;"><span><img width="506" height="238" alt="image" src="KerasTensorFlow2019/Image_813.jpg"/></span></p><p class="s145" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1440">Figure 13-18. Currently uploaded custom models to Firebase</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Widely used by industry, A/B testing is a statistical hypothesis testing technique, which answers the question “Is B better than A?” Here A and B could be anything of the same kind: content on a website, design elements on a phone app, or even deep learning models. A/B testing is a really useful feature for us when actively developing a model and discovering how our users respond to different iterations of the model.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;">Users have been using <span class="s156">my_model_v1 </span>for some time now, and we’d like to see whether the v2 iteration has our users going gaga. We’d like to start slow; maybe just 10% of our users should get v2. For that, we can set up an A/B testing experiment as follows:</p><ol id="l44"><li><p class="s148" style="padding-top: 3pt;padding-left: 50pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1441" class="s160">In Firebase, click the A/B Testing section, and then select “Create experiment” (</a><a href="#bookmark1441" class="s143">Figure </a>13-19<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 61pt;text-indent: 0pt;text-align: left;"><span><img width="503" height="265" alt="image" src="KerasTensorFlow2019/Image_814.jpg"/></span></p><p class="s145" style="padding-top: 5pt;padding-left: 52pt;text-indent: 0pt;text-align: center;"><a name="bookmark1441">Figure 13-19. A/B testing screen in Firebase where we can create an experiment</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-top: 9pt;padding-left: 50pt;text-indent: -14pt;text-align: left;">Select the Remote Config option.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s148" style="padding-left: 50pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1442" class="s160">In the Basics section, in the “Experiment name” box, enter the experiment name and an optional description (</a>Figure 13-20<span style=" color: #000;">), and then click Next.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 61pt;text-indent: 0pt;text-align: left;"><span><img width="499" height="261" alt="image" src="KerasTensorFlow2019/Image_815.jpg"/></span></p><p class="s145" style="padding-top: 7pt;padding-left: 71pt;text-indent: 0pt;text-align: center;"><a name="bookmark1442">Figure 13-20. The Basics section of the screen to create a remote configuration experiment</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-top: 9pt;padding-left: 50pt;text-indent: -14pt;text-align: left;">In the Targeting section that opens, from the “Target users” drop-down menu, select our app and enter the percentage of target users</p><p class="s148" style="padding-left: 50pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1443" class="s160">(</a>Figure 13-21<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 61pt;text-indent: 0pt;text-align: left;"><span><img width="504" height="296" alt="image" src="KerasTensorFlow2019/Image_816.jpg"/></span></p><p class="s145" style="padding-top: 5pt;padding-left: 98pt;text-indent: 0pt;text-align: left;"><a name="bookmark1443">Figure 13-21. The Targeting section of the Remote Config screen</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-top: 9pt;padding-left: 50pt;text-indent: -14pt;text-align: left;">Select a goal metric that makes sense. We discuss this in a little more detail in the next section.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 50pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1444" class="s160">In the variants section (</a><span style=" color: #8E0012;">Figure 13-22</span>), create a new parameter called <span class="s156">model_name </span>that reflects the name of the model a particular user would use. The control group gets the default model, which is <span class="s156">my_model_v1</span>. We also create an additional variant with the name <span class="s156">my_model_v2, </span>which goes to 10% of the users.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 69pt;text-indent: 0pt;text-align: left;"><span><img width="478" height="415" alt="image" src="KerasTensorFlow2019/Image_817.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 101pt;text-indent: 0pt;text-align: left;"><a name="bookmark1444">Figure 13-22. The Variants section of the Remote Config screen</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-top: 9pt;padding-left: 50pt;text-indent: -14pt;text-align: left;">Select Review and then select “Start experiment.” Over time, we can increase the distribution of users using the variant.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;text-align: justify;">Ta-da! Now we have our experiment up and running.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s175" style="padding-left: 6pt;text-indent: 0pt;text-align: justify;"><a name="bookmark1363">Measuring an experiment</a></p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: justify;"><a href="#bookmark1445" class="s160">Where do we go from here? We want to give our experiment some time to see how it performs. Depending on the type of experiment, we might want to give it a few days to a few weeks. The success of the experiments can be determined by any number of criteria. Google provides a few metrics out of the box that we can use, as shown in </a>Figure 13-23<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 96pt;text-indent: 0pt;text-align: left;"><span><img width="346" height="773" alt="image" src="KerasTensorFlow2019/Image_818.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 52pt;text-indent: 0pt;text-align: left;"><a name="bookmark1445">Figure 13-23. Analytics available when setting up an A/B testing experiment</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Suppose that we want to maximize our estimated total revenue — after all, we all want to become rich like Jian-Yang. We would measure our revenue from the users who have the experiment turned on against the baseline; that is, the users who do not have the experiment turned on. If our revenue per user</p><p class="s12" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">increased against the baseline, we would consider the experiment a success. Conversely, we would conclude the opposite if there were no increase/decrease in revenue per user. For successful experiments, we want to slowly roll them out to all users. At that point, it ceases to be an experiment and it “graduates” to become a core offering.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1364">Using the Experiment in Code</a><a name="bookmark1446">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Now that we have set up an experiment, let’s see how to include it in our application using code. To use the appropriate model within our code, we simply need to access the remote configuration object (<span class="s156">remoteConfig</span>) and get the model name from it. The model name that we get from the remote configuration object will depend on whether the user is included in the experiment. The following lines of code accomplish that:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><span class="s169">val </span><span style=" color: #96F;">remoteConfig </span>= <span style=" color: #000087;">FirebaseRemoteConfig</span>.<span style=" color: #000087;">getInstance</span>() <span style=" color: #000087;">remoteConfig</span>.<span style=" color: #000087;">fetch</span>()</p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><span class="s169">val </span><span style=" color: #96F;">modelName </span>= <span style=" color: #000087;">remoteConfig</span>.<span style=" color: #000087;">getString</span>(<span style=" color: #C30;">&quot;current_best_model&quot;</span>)</p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><span class="s169">val </span><span style=" color: #96F;">remoteModel </span>= <span style=" color: #000087;">FirebaseCloudModelSource</span>.<span style=" color: #000087;">Builder</span>(<span style=" color: #000087;">modelName</span>)</p><p class="s113" style="padding-left: 18pt;text-indent: 40pt;text-align: left;">.<span style=" color: #000087;">enableModelUpdates</span>(<span class="s169">true</span>).<span style=" color: #000087;">build</span>() <span style=" color: #000087;">FirebaseModelManager</span>.<span style=" color: #000087;">getInstance</span>().<span style=" color: #000087;">registerCloudModelSource</span>(<span style=" color: #000087;">remoteModel</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1447">The rest of the code to perform the prediction remains exactly the same as in the previous sections. Our app is now ready to use the correct model as dictated by our experiment.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s166" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1365">TensorFlow Lite on iOS</a><a name="bookmark1448">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1449">The previous chapters demonstrate how easy it is to use Apple’s Core ML on iOS. We can simply drag and drop a model into Xcode and start making inferences with just a couple of lines of code. In contrast, even looking at basic iOS examples such as those on TensorFlow Lite’s repository, it becomes evident that it needs a significant amount of boilerplate code to get even the most basic of apps running. In contrast, TensorFlow Lite used in conjunction with ML Kit is a rather pleasant experience. In addition to being able to use a clean and concise API, we get all the features we detailed earlier in this chapter</a></p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">— remotely downloading and updating models, model A/B testing, and cloud fallback for processing. All of this without having to do much extra work. A developer writing a deep learning app for both iOS and Android might consider using ML Kit as a way to “build once, use everywhere.”</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s166" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1366">Performance Optimizations</a><a name="bookmark1450">&zwnj;</a></p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark599" class="s160" name="bookmark1451">In </a>Chapter 6<span style=" color: #000;">, we explored quantization and pruning, mostly from a theoretical standpoint. Let’s see them up close from TensorFlow Lite’s perspective and the tools to achieve them.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1367">Quantizing with TensorFlow Lite Converter</a><a name="bookmark1452">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 113%;text-align: left;"><a name="bookmark1453">For iOS, Apple provides </a><span class="s156">quantization_utils </span>in its Core ML Tools package. And for TensorFlow Lite, the equivalent is the already built-in <span class="s156">tflite_convert </span>tool, which we used earlier in this chapter. On the command line, we can specify the input file, the model graph, the data type to convert to, and the names of the input and output (which can be inspected using Netron, as shown in</p><p class="s148" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Chapter 11<span style=" color: #000;">). Going from 32-bit to 8-bit integer representation means a four times smaller model, with relatively little loss in accuracy.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s113" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">$ tflite_convert \</p><p class="s113" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">--output_file=quantized-model.tflite \</p><p class="s113" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">--graph_def_file=/tmp/some-graph.pb \</p><p class="s113" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">--inference_type=QUANTIZED_UINT8 \</p><p class="s113" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">--input_arrays=input \</p><p class="s113" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">--output_arrays=MobilenetV1/Predictions/Reshape_1 \</p><p class="s113" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">--mean_values=128 \</p><p class="s113" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">--std_dev_values=127</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">When it’s finished, this command should give us the <span class="s156">quantized-model.tflite</span></p><p class="s12" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">model.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1368">TensorFlow Model Optimization Toolkit</a><a name="bookmark1454">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1455">The TensorFlow Lite converter is the simplest way to get our models quantized. It’s worth noting that the converter quantizes the models post-training. Due to the decrease in representation power, there can be a tiny but noticeable loss in accuracy. Could we do better? </a><i>Quantization-aware training</i>, as the name suggests, accounts for the effects of quantization during training time and attempts to compensate and minimize the losses that would have happened in post-training quantization.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Although both forms of quantization offer 75% reduction in the size of the model, experiments have shown the following:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_819.png"/></span></p><p class="s12" style="padding-top: 4pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">In the case of MobileNetV2, compared to an eight-point loss in accuracy with post-training quantization, quantization-aware training yielded only a one-point loss.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_820.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">For InceptionV3, quantization-aware training yielded a whopping 52% reduction in latency, compared to 25% reduction with post-training quantization.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="540" height="107" alt="image" src="KerasTensorFlow2019/Image_821.png"/></span></p><p class="s146" style="padding-top: 9pt;padding-left: 183pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s147" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">It is worth noting that these accuracy metrics are on the 1,000 class ImageNet test set. Most problems have less complexity with a smaller number of classes. Post- training quantization should result in a smaller loss on such simpler problems.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s12" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Quantization-aware training can be implemented with the TensorFlow Model Optimization Toolkit. This toolkit additional offers an increasing array of tools for model compression, including pruning. Additionally, the TensorFlow Lite model repository already offers these prequantized models using this technique.</p><p class="s148" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Table 13-2 <span style=" color: #000;">lists the effects of various quantization strategies.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s142" style="padding-left: 59pt;text-indent: -29pt;text-align: left;"><a name="bookmark1456">Table 13-2. Effects of different quantization strategies (8-bit) on models (source: TensorFlow Lite Model optimization documentation)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:18.3315pt" cellspacing="0"><tr style="height:18pt"><td style="width:82pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Model</p></td><td style="width:201pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-right: 3pt;text-indent: 0pt;text-align: right;">MobileNet</p></td><td style="width:69pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">MobileNetV2</p></td><td style="width:66pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">InceptionV3</p></td></tr><tr style="height:18pt"><td style="width:82pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Top-1 accuracy</p></td><td style="width:201pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Original <span class="s150">0.709</span></p></td><td style="width:69pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">0.719</p></td><td style="width:66pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">0.78</p></td></tr><tr style="height:18pt"><td style="width:82pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:201pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Post-training quantized <span class="s150">0.657</span></p></td><td style="width:69pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">0.637</p></td><td style="width:66pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">0.772</p></td></tr><tr style="height:15pt"><td style="width:82pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:201pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Quantization-aware training <span class="s150">0.7</span></p></td><td style="width:69pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 11pt;text-align: left;">0.709</p></td><td style="width:66pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 11pt;text-align: left;">0.775</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:18.0174pt" cellspacing="0"><tr style="height:18pt"><td style="width:82pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" rowspan="3" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Latency (ms)</p></td><td style="width:145pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Original</p></td><td style="width:40pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">124</p></td><td style="width:60pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">89</p></td><td style="width:91pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 28pt;text-indent: 0pt;text-align: left;">1130</p></td></tr><tr style="height:18pt"><td style="width:145pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Post-training quantized</p></td><td style="width:40pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">112</p></td><td style="width:60pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">98</p></td><td style="width:91pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 28pt;text-indent: 0pt;text-align: left;">845</p></td></tr><tr style="height:18pt"><td style="width:145pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Quantization-aware training</p></td><td style="width:40pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">64</p></td><td style="width:60pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">54</p></td><td style="width:91pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 28pt;text-indent: 0pt;text-align: left;">543</p></td></tr></table><p class="s153" style="padding-top: 2pt;padding-bottom: 3pt;padding-left: 21pt;text-indent: 0pt;text-align: left;">Size (MB) Original <span class="s147">16.9 14 95.7</span></p><p style="padding-left: 100pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="439" height="1" alt="image" src="KerasTensorFlow2019/Image_822.png"/></span></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="560" height="1" alt="image" src="KerasTensorFlow2019/Image_823.png"/></span></p><p class="s153" style="padding-top: 2pt;padding-left: 21pt;text-indent: 0pt;text-align: left;">Model MobileNet MobileNetV2 InceptionV3</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:18.0174pt" cellspacing="0"><tr style="height:18pt"><td style="width:82pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:101pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Optimized</p></td><td style="width:82pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 47pt;text-indent: 0pt;text-align: left;">4.3</p></td><td style="width:63pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 20pt;padding-right: 25pt;text-indent: 0pt;text-align: center;">3.6</p></td><td style="width:90pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 27pt;text-indent: 0pt;text-align: left;">23.9</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s166" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1369">Fritz</a><a name="bookmark1457">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1458">As we have seen so far, the primary purpose of Core ML and TensorFlow Lite is to serve fast mobile inferences. Have a model, plug it into the app, and run inferences. Then came ML Kit, which apart from its built-in AI capabilities, made it easier to deploy models and monitor our custom models (with Firebase). Taking a step back to look at the end-to-end pipeline, we had training, conversion to mobile format, optimizing its speed, deploying to users, monitoring the performance, keeping track of model versions. These are several steps spread across many tools. And there is a good chance that there is no single owner of the entire pipeline. This is because oftentimes these tools require some level of familiarity (e.g., having to deploy a model to users might be outside a data scientist’s comfort zone). Fritz, a Boston-based startup, is attempting to bring down these barriers and make the full cycle from model development to deployment even more straightforward for both data scientists and mobile developers.</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Fritz offers an end-to-end solution for mobile AI development that includes the following noteworthy features:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_824.png"/></span></p><p class="s12" style="padding-top: 4pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">Ability to deploy models directly to user devices from Keras after training completes using callbacks.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_825.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">Ability to benchmark a model directly from the computer without having to deploy it on a phone. The following code demonstrates this:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s113" style="padding-left: 43pt;text-indent: 0pt;text-align: left;">$ fritz model benchmark &lt;path to keras model.h5&gt;</p><p class="s113" style="padding-bottom: 4pt;padding-left: 48pt;text-indent: 0pt;text-align: left;">...</p><p style="padding-left: 48pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="161" height="1" alt="image" src="KerasTensorFlow2019/Image_826.png"/></span></p><p class="s113" style="padding-top: 4pt;padding-bottom: 4pt;padding-left: 48pt;text-indent: 0pt;text-align: left;">Fritz Model Grade Report</p><p style="padding-left: 48pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="161" height="1" alt="image" src="KerasTensorFlow2019/Image_827.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s113" style="padding-left: 48pt;text-indent: 0pt;text-align: left;">Core ML Compatible: True</p><p class="s113" style="padding-left: 48pt;text-indent: 0pt;text-align: left;">Predicted Runtime (iPhone X): 31.4 ms (31.9 fps) Total MFLOPS: 686.9O</p><p class="s113" style="padding-left: 48pt;text-indent: 0pt;text-align: left;">Total Parameters: 1,258,58O</p><p class="s113" style="padding-left: 48pt;text-indent: 0pt;text-align: left;">Fritz Version ID: &lt;Version UID&gt;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_828.png"/></span></p><p class="s12" style="padding-top: 4pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">Ability to encrypt models so that our intellectual property can be protected from theft from a device by nefarious actors.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_829.png"/></span></p><p class="s148" style="padding-left: 31pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1459" class="s160">Ability to implement many advanced computer-vision algorithms with just a few lines of code. The SDK comes with ready-to-use, mobile-friendly implementations of these algorithms, which run at high frame rates. For example, image segmentation, style transfer, object detection, and pose estimation. </a>Figure 13-24 <span style=" color: #000;">shows benchmarks of object detection run on various iOS devices.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s113" style="padding-left: 43pt;text-indent: 0pt;text-align: left;"><span class="s169">let </span>poseModel = <span style=" color: #000087;">FritzVisionPoseModel</span>()</p><p class="s113" style="padding-left: 43pt;text-indent: 0pt;text-align: left;"><span class="s169">guard let </span>poseResult = <span class="s169">try</span>? <span style=" color: #000087;">poseModel</span>.<span style=" color: #000087;">predict</span>(<span style=" color: #000087;">image</span>) <span class="s169">else </span>{ <span class="s169">return </span>}</p><p class="s113" style="padding-left: 43pt;text-indent: 0pt;text-align: left;"><span class="s169">let </span>imageWithPose = <span style=" color: #000087;">poseResult</span>.<span style=" color: #000087;">drawPose</span>() <span class="s172">// Overlays pose on input.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 57pt;text-indent: 0pt;text-align: left;"><span><img width="482" height="249" alt="image" src="KerasTensorFlow2019/Image_830.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-left: 165pt;text-indent: -132pt;text-align: left;"><a name="bookmark1459">Figure 13-24. Performance of Fritz SDK’s object detection functionality on different mobile devices, relative to the iPhone X</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_831.png"/></span></p><p class="s12" style="padding-top: 10pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">Ability to customize the prebuilt models to custom datasets by retraining using their Jupyter notebooks. It’s worth noting that this can be a difficult problem (even for professional data scientists) that is simplified significantly because the developer has only to ensure that the data is in the right format.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_832.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">Ability to manage all model versions from the command line.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_833.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">Ability to test out mobile readiness of our models using Fritz’ open source app called Heartbeat (also available on iOS/Android app stores). Assuming that we have a model ready without much mobile know how, we can clone the app, swap the existing model with our own, and get to see it run on the phone.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_834.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">A vibrant community of contributors blogging about the latest in mobile AI on <i>heartbeat.fritz.ai</i>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="590" height="476" alt="image" src="KerasTensorFlow2019/Image_835.png"/></span></p><p class="s153" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">FROM THE CREATOR’S DESK</p><p class="s147" style="padding-top: 5pt;padding-left: 16pt;text-indent: 0pt;text-align: left;">By Dan Abdinoor, CEO and cofounder of Fritz</p><p class="s147" style="padding-top: 5pt;padding-left: 16pt;text-indent: 0pt;text-align: left;">Our motivation to build Fritz came from two somewhat contradictory feelings — inspiration and frustration. The inspiration came from seeing how many previously impossible problems were being solved with machine learning. The combination of data, compute, and model architectures were all starting to click. At the same time, we found ourselves frustrated by the lack of resources for deploying and maintaining machine learning anywhere other than the cloud. For reasons of performance, privacy, and cost, it makes more sense to shift inference to devices where data is being collected, as opposed to moving all that data to a cloud environment, processing it, and then sending predictions back down to the devices. This led us to build Fritz as a platform for developers to collect, train, deploy, and manage machine learning models for edge devices — like mobile phones.</p><p class="s147" style="padding-top: 5pt;padding-left: 16pt;text-indent: 0pt;text-align: left;">In many ways, the process of building a solution with machine learning is like a race with hurdles. We want to lower or remove those hurdles so that engineers, even those without deep learning or mobile expertise, can use what we built to make great mobile applications. One can get started quickly with efficient pretrained models, or custom train a new one.</p><p class="s147" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">Our tools should make it easier to deploy models, understand how they are performing, and keep them updated and protected. The results of all this, in part, are models that perform well on edge devices.</p><p class="s147" style="padding-top: 5pt;padding-left: 16pt;text-indent: 0pt;text-align: left;"><a name="bookmark1460">Making it easier to implement machine learning features in mobile apps will lead to more powerful, personalized experiences that retain current users, attract new ones, and shift our thinking about what’s possible. Ultimately, we believe machine learning is the most fundamental change to computer science in decades, and we want to help build, educate, and evolve the community.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s166" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1370">A Holistic Look at the Mobile AI App Development Cycle</a><a name="bookmark1461">&zwnj;</a></p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1463" class="s160" name="bookmark1462">Until this point in the book, we’ve looked at a bunch of techniques and technologies that enable us to perform individual tasks in the mobile AI development cycle. Here, we tie everything together by exploring the kind of questions that come up throughout this life cycle. </a>Figure 13-25 <span style=" color: #000;">provides a broad overview of the development cycle.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 56pt;text-indent: 0pt;text-align: left;"><span><img width="470" height="383" alt="image" src="KerasTensorFlow2019/Image_836.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1463">Figure 13-25. Mobile AI app development life cycle</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1371">How Do I Collect Initial Data?</a><a name="bookmark1464">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">We can apply a few different strategies to accomplish this:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_837.png"/></span></p><p class="s12" style="padding-top: 5pt;padding-left: 31pt;text-indent: 0pt;text-align: left;"><a name="bookmark1465">Find the object of interest and manually take photos with different angles, lighting, environments, framing, and so on.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_838.png"/></span></p><p class="s148" style="padding-left: 31pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1295" class="s160">Scrape from the internet using browser extensions like Fatkun (</a>Chapter 12<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_839.png"/></span></p><p class="s148" style="padding-left: 31pt;text-indent: 0pt;text-align: left;"><a href="https://oreil.ly/NawZ6" class="s160" target="_blank">Find existing datasets (</a>Google Dataset Search<span style=" color: #000;">). For example, Food-101 for dishes.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_840.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">Synthesize your own dataset.</p><ol id="l45"><li><p class="s12" style="padding-top: 5pt;padding-left: 75pt;text-indent: -14pt;text-align: left;">Place the object (foreground) in front of a green screen (background) and take a photograph of it. Replace the background with random images to synthesize a large dataset, while zooming, cropping, and rotating to create potentially hundreds of images.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s12" style="padding-left: 75pt;text-indent: -14pt;text-align: left;">If a green screen is not possible, segment (i.e., cut) the object out of the background from existing real-world images and repeat the previous step in order to build a robust, diverse dataset. It’s important to note that, in points (a) and (b), there needs to be sufficient diversity in the foreground; otherwise, the network might overlearn that one example instead of understanding the object.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s148" style="padding-left: 75pt;text-indent: -14pt;text-align: left;"><a href="#bookmark730" class="s160">Find a realistic 3D model of the object of interest and place it in realistic environments using a 3D framework such as Unity. Adjust the lighting and camera position, zoom, and rotation to take snapshots of this object from many angles. We explored companies such as AI.Reverie and CVEDIA in </a>Chapter 7 <a href="#bookmark1751" class="s160">that work in this space. We use photo-realistic simulators to train models for the self-driving chapters (</a>Chapter 16 <a href="#bookmark1861" class="s160">and </a><a href="#bookmark1861" class="s143">Chapter </a>17<span style=" color: #000;">).</span></p></li></ol></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1372">How Do I Label My Data?</a><a name="bookmark1466">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1467">Most of the steps in the previous answer should have already given you labels for the data. For unlabeled collections, use labeling tools such as Supervisely, Labelbox, and Diffgram. For really large datasets in which annotating data by yourself is not feasible, socially responsible labeling services such as Digital Data Divide, iMerit, and Samasource, which provide income opportunities to disadvantaged populations, might be a good option.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1373">How Do I Train My Model?</a><a name="bookmark1468">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_841.png"/></span></p><p class="s148" style="padding-top: 5pt;padding-left: 31pt;text-indent: -25pt;line-height: 140%;text-align: justify;"><a href="#bookmark227" class="s160" name="bookmark1469">The following are the two broad approaches to train a model: With code: Use Keras and TensorFlow (</a>Chapter 3<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_842.png"/></span></p><p class="s148" style="padding-top: 6pt;padding-left: 31pt;text-indent: 0pt;text-align: justify;"><a href="#bookmark828" class="s160">Without code: Use custom classifier services such as Google’s Auto ML, Microsoft’s CustomVision.ai, and Clarifai (benchmarked in </a>Chapter 8<a href="#bookmark1295" class="s160">), or Apple’s ecosystem-only Create ML (</a>Chapter 12<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1374">How Do I Convert the Model to a Mobile-Friendly Format?</a><a name="bookmark1470">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">The following are a few different ways to convert a model to a mobile- compatible format:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_843.png"/></span></p><p class="s12" style="padding-top: 4pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">Use Core ML Tools (Apple only).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_844.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_845.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;line-height: 188%;text-align: left;">Use TensorFlow Lite Converter for iOS and Android. Alternatively, use Fritz for the end-to-end pipeline.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1375">How Do I Make my Model Performant?</a><a name="bookmark1471">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Here are some techniques to make a model performant:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_846.png"/></span></p><p class="s12" style="padding-top: 5pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">Start with an efficient model such as the MobileNet family, or even better, EfficientNet.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_847.png"/></span></p><p class="s148" style="padding-left: 31pt;text-indent: 0pt;text-align: left;"><a href="#bookmark599" class="s160">Make the model smaller in size by quantizing and pruning it to improve loading and inference times, while keeping the model accuracy relatively intact (</a>Chapter 6<a href="#bookmark1183" class="s160">, </a>Chapter 11<a href="#bookmark1389" class="s160">, and </a>Chapter 13<span style=" color: #000;">). Expect up to a 75% reduction in size with little loss in accuracy.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_848.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">Use Core ML Tools for the Apple ecosystem or TensorFlow Model Optimization Kit for both iOS and Android.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1376">How Do I Build a Great UX for My Users?</a><a name="bookmark1472">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Obviously, that’s going to depend on the kind of problem you are trying to solve. But a general guideline is to strike the proper balance between interactivity, performance, and resource usage (memory, CPU, battery, etc.). And, of course, an intelligent feedback mechanism that enables effortless data collection and feedback helps. Gamifying this experience would take it to an entirely new level.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">In the case of the food classifier app, after the user takes a picture, our UI would show a list of top five candidate predictions (in decreasing order of confidence) for a given photo. For example, if the user takes a picture of a pizza, the candidate predictions shown on screen could be “pie - 75%,” “pizza - 15%,” “naan - 6%,” “bread - 3%,” “casserole - 1%.” In this case, the user would have selected the second prediction. For a perfect model, the user would always select the first prediction. Because our model is not perfect, the rank of the prediction the user selects becomes a signal that will help improve the model in the future. In the absolute worst case, in which none of the predictions were correct, the user should have a way to manually label the data. Providing an autosuggest feature during manual entry will help keep clean labels in the dataset.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">An even better experience could be one in which the user never needs to click a picture. Rather, the predictions are available in real time.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1377">How Do I Make the Model Available to My Users?</a><a name="bookmark1473">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">The following are some ways to deploy models to users:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_849.png"/></span></p><p class="s12" style="padding-top: 5pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">Bundle the model into the app binary and release it on the app stores.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_850.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">Alternatively, host the model in the cloud and have the app download the model, as necessary.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_851.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">Use a model management service like Fritz or Firebase (integrated with ML Kit).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1378">How Do I Measure the Success of My Model?</a><a name="bookmark1474">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1475">The very first step is to determine the success criteria. Consider the following examples:</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_852.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_853.png"/></span></p><p class="s12" style="padding-top: 4pt;padding-left: 31pt;text-indent: 0pt;line-height: 188%;text-align: left;">“My model should run inferences in under 200 ms at the 90th percentile.” “Users who use this model open the app every day.”</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_854.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">In the food classifier app, a success metric could be something along the lines of “80% of users selected the first prediction in the list of predictions.”</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">These success criteria are not set in stone and should continue to evolve over time. It’s very essential to be data driven. When you have a new model version, run A/B tests on a subset of users and evaluate the success criteria against that version to determine whether it’s an improvement over the previous version.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;"><a name="bookmark1379">How Do I Improve My Model?</a><a name="bookmark1476">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;">Here are some ways to improve the quality of our models:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_855.png"/></span></p><p class="s12" style="padding-top: 5pt;padding-left: 31pt;text-indent: 0pt;text-align: justify;">Collect feedback on individual predictions from users: what was correct, and, more important, what was incorrect. Feed these images along with the corresponding labels as input for the next model training cycle.</p><p class="s148" style="padding-left: 31pt;text-indent: 0pt;text-align: justify;">Figure 13-26 <span style=" color: #000;">illustrates this.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_856.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">For users who have explicitly opted in, collect frames automatically whenever the prediction confidence is low. Manually label those frames and feed them into the next training cycle.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 51pt;text-indent: 0pt;text-align: left;"><span><img width="486" height="353" alt="image" src="KerasTensorFlow2019/Image_857.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 158pt;text-indent: -140pt;text-align: left;"><a name="bookmark1477">Figure 13-26. The feedback cycle of an incorrect prediction, generating more training data, leading to an improved model</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1380">How Do I Update the Model on My Users’ Phones?</a><a name="bookmark1478">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Here are some ways to update the model on your users’ phones:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_858.png"/></span></p><p class="s12" style="padding-top: 5pt;padding-left: 31pt;text-indent: 0pt;text-align: left;"><a name="bookmark1479">Bundle the new model into the next app release. This is slow and inflexible.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_859.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">Host the new model on the cloud and force the apps out in the world to download the new model. Prefer to do this when the user is on WiFi.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_860.png"/></span></p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">Use a model management system such as Firebase (in conjunction with ML Kit) or Fritz to automate a lot of the grunt work involved.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1480">With all of these questions answered, let’s appreciate the beauty of how this app improves on its own.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s166" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1381">The Self-Evolving Model</a><a name="bookmark1481">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1482">For applications that need only mature pretrained models, our job is already done. Just plug the model into an app and we’re ready to go. For custom- trained models that rely especially on scarce training data, we can get the user involved in building a self-improving, ever-evolving model.</a></p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1483" class="s160">At the most fundamental level, each time a user uses the app, they’re providing the necessary feedback (image + label) to improve the model further, as illustrated in </a>Figure 13-27<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 49pt;text-indent: 0pt;text-align: left;"><span><img width="480" height="303" alt="image" src="KerasTensorFlow2019/Image_861.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1483">Figure 13-27. The self-evolving model cycle</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Just like a university student must graduate multiple years before getting ready to step into the real world, a model needs to go through phases of development before it reaches its final users. The following is a popular model of phasing releases in software, which is also a useful guideline for releasing AI models.</p><ol id="l46"><li><p class="s142" style="padding-top: 8pt;padding-left: 20pt;text-indent: -14pt;text-align: left;">Dev</p><p class="s12" style="padding-top: 3pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">This is the initial phase of development in which the developers of the app are the only users of it. Data accumulation is slow, the experience is very buggy, and model predictions can be quite unreliable.</p></li><li><p class="s142" style="padding-top: 8pt;padding-left: 20pt;text-indent: -14pt;text-align: left;">Alpha</p><p class="s12" style="padding-top: 3pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">After the app is ready to be tested by a few users beyond the developers, it is now considered to be in alpha. User feedback is extremely crucial here because it would serve to improve the app experience as well provide data at a greater scale to the pipeline. The experience is not nearly as buggy, and the model predictions are a little more reliable here. In some organizations, this phase is also known as <i>dogfooding </i>(i.e., internal application testing by employees).</p></li><li><p class="s142" style="padding-top: 8pt;padding-left: 20pt;text-indent: -14pt;text-align: left;">Beta</p><p class="s12" style="padding-top: 3pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">An app in beta has significantly more users than in alpha. User feedback is also quite important here. The data collection rate is at an even larger scale. Many different devices are out in the real world collecting data to help improve the model rapidly. The experience is a lot more stable, and the model predictions are a lot more reliable, thanks to the alpha users.</p><p class="s12" style="padding-left: 31pt;text-indent: 0pt;text-align: left;">Beta apps tend to be hosted on Apple’s TestFlight for iOS and Google Play Console for Android. Third-party services such as HockeyApp and TestFairy are also popular for hosting beta programs.</p></li><li><p class="s142" style="padding-top: 8pt;padding-left: 20pt;text-indent: -14pt;text-align: left;">Prod</p></li></ol><p class="s12" style="padding-top: 3pt;padding-left: 31pt;text-indent: 0pt;text-align: left;">An app in production is stable and is widely available. Although the data is coming in at large rates, the model is fairly stable at this point, and it does not learn as much. However, as real-world usage keeps growing, it’s able to get better at edge cases it might not have been seen before in the first three phases. When the model is mature enough, small version improvements can be alpha/beta tested or A/B tested on subsets of the production audience.</p><p class="s12" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Although many data scientists assume the data to be available before starting development, people in the mobile AI world might need to bootstrap on a small dataset and improve their system incrementally.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: justify;">With this self-evolving system for the Shazam for Food app, the most difficult choice that the developers must make should be the restaurants they visit to collect their seed data.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s166" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1382">Case Studies</a><a name="bookmark1484">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1485">Let’s look at a few interesting examples that show how what we have learned so far is applied in the industry.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1383">Lose It!</a><a name="bookmark1486">&zwnj;</a></p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1488" class="s160" name="bookmark1487">We need to confess here. The app we were building all along in this chapter already exists. Erlich Bachman’s dream was already built a year before by a Boston-based company named Fit Now. Lose It! (</a>Figure 13-28<span style=" color: #000;">) claims to have helped 30 million users lose 85 million pounds by tracking what they eat. Users can point their phone’s camera at barcodes, nutritional labels, and the food that they’re just about to eat to track calories and macros they’re consuming for every single meal.</span></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">The company first implemented its food scanning system with a cloud-based algorithm. Due to the resource demands and network delay, the experience could not be real time. To improve the experience, the Fit Now team migrated its models to TensorFlow Lite to optimize them for mobile and used ML Kit to seamlessly deploy to its millions of users. With a constant feedback loop, model updates, and A/B testing, the app keeps improving essentially on its own.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><span><img width="483" height="775" alt="image" src="KerasTensorFlow2019/Image_862.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 121pt;text-indent: -112pt;text-align: left;"><a name="bookmark1488">Figure 13-28. Snap It feature from Lose It! showing multiple suggestions for a scanned food item</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1384">Portrait Mode on Pixel 3 Phones</a><a name="bookmark1489">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1490">One of the key visual concepts that separates professional photographers from the amateur wannabes is bokeh, or blurring of the background behind the subject of the image. (Not to be confused with the Python visualization tool of the same name.) The closer the camera is located to the subject, the more the background appears blurred. With the help of professional lenses with a low </a><i>f</i>- stop number (which often run into the thousands of dollars), one can produce spectacular blurs.</p><p style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1491" class="s160">But if you don’t have that kind of money, AI can help. Google’s Pixel 3 offers a “Portrait” mode that creates the bokeh effect. Essentially, it uses a CNN to estimate the depth of each pixel in a scene, and determine which pixels belong to the foreground and the background. The background pixels are then blurred to varying intensities to create the bokeh effect, as demonstrated in </a><a href="#bookmark1491" class="s143">Figure 13- 29</a><a href="#bookmark1491" class="s160">.</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Depth estimation is a compute-intensive task so running it fast is essential. Tensorflow Lite with a GPU backend comes to the rescue, with a roughly 3.5 times speedup over a CPU backend.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Google accomplished this by training a neural network that specializes in depth estimation. It used a rig with multiple phone cameras (which it termed “Frankenphone”) to take pictures of the same scene from slightly different viewpoints belonging to each camera. It then used the <i>parallax effect </i>experienced by each pixel to precisely determine the depth of each pixel. This depth map was then fed into the CNN along with the images.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 39pt;text-indent: 0pt;text-align: left;"><span><img width="504" height="361" alt="image" src="KerasTensorFlow2019/Image_863.jpg"/></span></p><p class="s145" style="padding-top: 5pt;padding-left: 167pt;text-indent: -150pt;text-align: left;"><a name="bookmark1491">Figure 13-29. Portrait effect on Pixel 3, which achieves separation between foreground and background using blurring</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1385">Speaker Recognition by Alibaba</a><a name="bookmark1492">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1493">Imagine speaking “Hey Siri” or “Hey Google” into a friend’s phone, followed by the magical words “read the last text.” From a privacy standpoint, it would be terrifying if this worked. Obviously, most mobile operating systems today ask us to unlock the phone first before proceeding. This creates a not-so-smooth experience for the owner of the phone.</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Alibaba Machine Intelligence Labs solved this problem using the following approach. First, by converting speech into images of spectrograms (extracting audio features with mel-frequency cepstrum algorithm), training a CNN (using transfer learning), and finally deploying it to devices using Tensorflow Lite.</p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">That’s right: CNNs can do more than just computer vision!</p><p class="s12" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">By recognizing speakers, they are able to personalize the content on devices with many users in a family (e.g., in its “Talk to your TV” feature on its Netflix- like TV app). Additionally, by recognizing whether the sound is a human voice, it is able to isolate the spoken commands to transcribe from background noise. To make processing faster with Tensorflow Lite, engineers kept the <span class="s156">USE_NEON </span>flag to accelerate instruction sets for ARM-based CPUs. The team reported a speed increase of four times with this optimization.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1386">Face Contours in ML Kit</a><a name="bookmark1494">&zwnj;</a></p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1496" class="s160" name="bookmark1495">Want to quickly build a Snapchat face filter–like functionality without getting a Ph.D.? ML Kit also provides the goods to do that — an API to identify facial contours, a set of points (in x and y coordinates) that follow the shape of facial features in the input image. In total, 133 points map to the various facial contours, including 16 points representing each eye, while 36 points map to the oval shape around the face, as demonstrated in </a>Figure 13-30<span style=" color: #000;">.</span></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Internally, ML Kit is running a deep learning model using TensorFlow Lite. In experiments with the new TensorFlow Lite GPU backend, Google found an increase in speed of four times on Pixel 3 and Samsung Galaxy S9, and a six- times speedup on iPhone 7, compared to the previous CPU backend. The effect of this is that we can precisely place a hat or sunglasses on a face in real time.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 39pt;text-indent: 0pt;text-align: left;"><span><img width="502" height="630" alt="image" src="KerasTensorFlow2019/Image_864.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a href="https://oreil.ly/8PMGa" class="s176" target="_blank" name="bookmark1496">Figure 13-30. 133 Face contour points identified by ML Kit (</a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 10.5pt;">image source</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s167" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1387">Real-Time Video Segmentation in YouTube Stories</a><a name="bookmark1497">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1498">Green screens are staple equipment for anyone in the video production industry. By choosing a color not matching the subject, the background can be changed during postproduction using the </a><i>chroma keying </i>technique. Obviously, this requires expensive software and powerful machines for postproduction.</p><p class="s12" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Many YouTubers have the same needs but might not have the budget. And now they have a solution within the YouTube Stories app — a real-time video segmentation option implemented over TensorFlow Lite.</p><p class="s148" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1500" class="s160" name="bookmark1499">The key requirements here are first, to run semantic segmentation fast (more than 30 frames per second), and second, be temporally consistent; for instance, achieving smooth frame-to-frame temporal continuity on the edges. If we attempt to run semantic segmentation over multiple frames, we’ll quickly notice the edges of many of the segmented masks bouncing around. The key trick employed here is to pass the segmented masks of the person’s face to the next frame as a prior. Because we traditionally work on three channels (RGB), the trick is to add a fourth channel, which essentially is the output of the previous frame, as illustrated in </a>Figure 13-31<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 43pt;text-indent: 0pt;text-align: left;"><span><img width="491" height="183" alt="image" src="KerasTensorFlow2019/Image_865.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 8pt;text-indent: 0pt;text-align: center;"><a name="bookmark1500">Figure 13-31. An input image (left) is broken down into its three components layers (R, G, B).</a></p><p style="padding-left: 28pt;text-indent: 0pt;text-align: center;"><a href="https://oreil.ly/rHNH5" class="s176" target="_blank">The output mask of the previous frame is then appended with these components (</a><a href="https://oreil.ly/rHNH5" class="s155" target="_blank">image source</a><a href="https://oreil.ly/rHNH5" class="s176" target="_blank">)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s12" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">With other optimizations to the structure of the base CNN, the YouTube team was able to run the system at more than 100 frames per second on an iPhone 7, and faster than 40 frames per second on a Pixel 2. Additionally, comparing the CPU versus GPU backend of TensorFlow Lite, an increase in speed of 18 times is observed when choosing the GPU backend over the CPU backend (much more acceleration compared to the usual two to seven times for other semantic segmentation tasks for images only).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s166" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1388">Summary</a><a name="bookmark1501">&zwnj;</a></p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">In this chapter, we discussed the architecture of TensorFlow Lite, as it relates to Android’s Neural Network API. We then worked on getting a simple object recognition app running on an Android device. We covered Google’s ML Kit and talked about the reasons why you might want to use it. We additionally went through how to convert our TensorFlow models to TensorFlow Lite format so that they could be used within an Android device. We finally discussed a couple of examples of how TensorFlow Lite is being used to solve real-world problems.</p><p class="s12" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1502">In the next chapter, we look at how we can use real-time deep learning to develop an interactive, real-world application.</a></p><p class="s177" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1503">Chapter 14. Building the Purrfect Cat Locator App with TensorFlow Object Detection API</a><a name="bookmark1540">&zwnj;</a></p><p style="padding-left: 5pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="586" height="1" alt="image" src="KerasTensorFlow2019/Image_866.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">Bob gets frequent visits from a neighborhood feral cat. Those visits result in less than pleasant outcomes. You see, Bob has a nice fairly large garden that he tends to with great care. However, this furry little fella visits his garden every night and starts chewing on a bunch of plants. Months of hard work gets destroyed overnight. Clearly unhappy with this situation, Bob is keen on doing something about it.</p><p class="s133" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">Channeling his inner Ace Ventura (Pet Detective), he tries to stay awake at night to drive the cat away, but clearly, that’s not sustainable in the long term. After all, Red Bull has its limits. Reaching a breaking point, he decides to use the nuclear option: use AI in conjunction with his sprinkler system to literally “turn the hose” on the cat.</p><p class="s133" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">In his sprawling garden, he sets up a camera that can track the motion of the cat and turn on the nearest set of sprinklers to scare the cat away. He has an old phone lying around, and all he needs is a way to determine the cat’s location in real time, so he can control accordingly which sprinkler to trigger.</p><p class="s132" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1541" class="s192">Hopefully, after a few unwelcome baths, as demonstrated in </a>Figure 14-1<span style=" color: #000;">, the cat would be disincentivized from raiding Bob’s garden.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><span><img width="371" height="264" alt="image" src="KerasTensorFlow2019/Image_867.jpg"/></span></p><p class="s178" style="padding-top: 4pt;padding-left: 51pt;text-indent: 0pt;text-align: left;"><a name="bookmark1541">Figure 14-1. Building an AI cat sprinkler system, like this Havahart Spray Away Motion Detector</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="552" height="138" alt="image" src="KerasTensorFlow2019/Image_868.png"/></span></p><p class="s179" style="padding-top: 7pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s180" style="padding-top: 4pt;padding-left: 4pt;text-indent: 0pt;line-height: 109%;text-align: left;">Keen observers might have noticed that we’re attempting to find the position of the cat in 2D space, whereas the cat itself exists in 3D space. We can make assumptions to simplify the problem of locating the cat in real- world coordinates by assuming that the camera will always be in a fixed position. To determine the distance of the cat, we can use the size of an average cat to take measurements of its apparent size on a picture at regular intervals of distance from the camera. For example, an average cat might appear to have a bounding box height of 300 pixels at a distance of two feet from the camera, whereas it might occupy 250 pixels when it’s three feet away from the camera lens.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">In this chapter, we help Bob make his cat detector. (Note to animal-rights advocates: no cats were harmed in the making of this chapter.) We answer the following questions along the way:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_869.png"/></span></p><p class="s133" style="padding-top: 3pt;padding-left: 25pt;text-indent: 0pt;text-align: left;">What are the different kinds of computer-vision tasks?</p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_870.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_871.png"/></span></p><p class="s133" style="padding-top: 3pt;padding-left: 25pt;text-indent: 0pt;line-height: 187%;text-align: left;">How do I reuse a model pretrained for an existing class of objects? Can I train an object detector model without writing any code?</p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_872.png"/></span></p><p class="s133" style="padding-left: 25pt;text-indent: 0pt;text-align: left;">I want more granular control for greater accuracy and speed. How do I train a custom object detector?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s181" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1504">Types of Computer-Vision Tasks</a><a name="bookmark1542">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1543">In most of the previous chapters, we’ve essentially looked at one kind of problem: object classification. In that, we found out whether an image contained objects of a certain class. In Bob’s scenario, in addition to knowing whether the camera is seeing a cat, it is necessary to know exactly where the cat is in order to trigger the nearest sprinkler. Determining the location of an object within an image is a different type of problem: </a><i>object detection</i>. Before we jump into object detection, let’s look at the variety of frequent computer-vision tasks and the questions they purport to answer.</p><p class="s40" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1505">Classification</a><a name="bookmark1544">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1545">We have looked at several examples of classification throughout this book. Simply put, the task of classification assigns an image with the class(es) of the object(s) present in the image. It answers the question: “Is there an object of class X in the image?” Classification is one of the most fundamental computer-vision tasks. In an image, there might be objects of more than one class — called multiclass classification. The label in this case for one image would be a list of all object classes that the image contains.</a></p><p class="s40" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1506">Localization</a><a name="bookmark1546">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1547">The downside of classification is that it does not tell us where in the image a particular object is, how big or small it is, or how many objects there are. It only tells us that an object of a particular class exists somewhere within it. </a><i>Localization</i>, otherwise known as <i>classification with localization</i>, can inform us which classes are in an image and where they are located within the image. The keyword here is <i>classes</i>, as opposed to individual objects, because localization gives us only one bounding box per class. Just like classification, it cannot answer the question “How many objects of class X are in this image?”</p><p class="s133" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">As you will see momentarily, localization will work correctly only when it is guaranteed that there is a single instance of each class. If there is more than one instance of a class, one bounding box might encompass some or all objects of that class (depending upon the probabilities). But just one bounding box per class seems rather restrictive, doesn’t it?</p><p class="s40" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1507">Detection</a><a name="bookmark1548">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1549">When we have multiple objects belonging to multiple classes in the same image, localization will not suffice. Object detection would give us a bounding rectangle for every instance of a class, for all classes. It also informs us as to the class of the object within each of the detected bounding boxes. For example, in the case of a self-driving car, object detection would return one bounding box per car, person, lamp post, and so on that the car sees. Because of this ability, we also can use it in applications that need to count. For example, counting the number of people in a crowd.</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="552" height="72" alt="image" src="KerasTensorFlow2019/Image_873.png"/></span></p><p class="s183" style="padding-top: 7pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">WARNING</p><p class="s180" style="padding-top: 4pt;padding-left: 4pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1550">Often people use the term “object localization” when, really, they mean “object detection.” It’s important to note the distinction between the two.</a></p><p style="text-indent: 0pt;text-align: left;"/><p class="s133" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">Unlike localization, detection does not have a restriction on the number of instances of a class in an image. This is why it is used in real-world applications.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s40" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1508">Segmentation</a><a name="bookmark1551">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1552">Object segmentation is the task of assigning a class label to individual pixels throughout an image. A children’s coloring book where we use crayons to color various objects is a real-world analogy. Considering each pixel in the image is being assigned a class, it is a highly compute-intensive task. Although object localization and detection give bounding boxes, segmentation produces groups of pixels — also known as </a><i>masks</i>. Segmentation is obviously much more precise about the boundaries of an object compared to detection. For example, a cosmetic app that changes a user’s hair color in real-time would use segmentation. Based on the types of masks, segmentation comes in different flavors.<a name="bookmark1553">&zwnj;</a></p><p class="s130" style="padding-top: 9pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1509">Semantic segmentation</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1554">Given an image, </a><i>semantic segmentation </i>assigns one mask per class. If there are multiple objects of the same class, all of them are assigned to the same mask. There is no differentiation between the instances of the same class. Just like localization, semantic segmentation cannot count.</p><p class="s130" style="padding-top: 9pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1510">Instance-level segmentation</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1555">Given an image, </a><i>instance-level segmentation </i>identifies the area occupied by each instance of each class. Different instances of the same class will be segmented uniquely.</p><p class="s132" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Table 14-1 <span style=" color: #000;">lists the different computer-vision tasks.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="597" height="1" alt="image" src="KerasTensorFlow2019/Image_874.png"/></span></p><p class="s182" style="padding-left: 215pt;text-indent: -199pt;text-align: left;"><a href="https://oreil.ly/ieJ2d" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 10pt;" target="_blank" name="bookmark1556">Table 14-1. Types of computer-vision tasks illustrated using image ID </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 10pt;">120524 </span>from the MS COCO dataset</p><p class="s185" style="padding-top: 7pt;text-indent: 0pt;text-align: right;">Task Image In lay</p><p class="s185" style="text-indent: 0pt;text-align: right;">terms</p><p class="s185" style="padding-top: 7pt;padding-left: 7pt;text-indent: 0pt;text-align: left;">Outputs</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 5pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="591" height="1" alt="image" src="KerasTensorFlow2019/Image_875.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="402" height="301" alt="image" src="KerasTensorFlow2019/Image_876.jpg"/></span></p><p class="s180" style="padding-top: 5pt;padding-left: 7pt;text-indent: 0pt;line-height: 109%;text-align: left;">Object classification</p><p class="s180" style="padding-top: 5pt;padding-left: 311pt;text-indent: 0pt;line-height: 109%;text-align: left;">Is there a sheep in this image?</p><p class="s180" style="padding-top: 5pt;padding-left: 4pt;text-indent: 0pt;line-height: 109%;text-align: left;">Class probabilities</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 5pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="591" height="1" alt="image" src="KerasTensorFlow2019/Image_877.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="597" height="1" alt="image" src="KerasTensorFlow2019/Image_878.png"/></span></p><p class="s185" style="padding-top: 3pt;text-indent: 0pt;text-align: right;">Task Image In lay</p><p style="text-indent: 0pt;text-align: left;"><span><img width="597" height="242" alt="image" src="KerasTensorFlow2019/Image_879.png"/></span></p><p class="s180" style="text-indent: 0pt;line-height: 109%;text-align: left;">“a” sheep box and in the class</p><p class="s180" style="text-indent: 0pt;line-height: 109%;text-align: left;">image probability and</p><p class="s180" style="text-indent: 0pt;line-height: 109%;text-align: left;">where is it?</p><p style="text-indent: 0pt;text-align: left;"/><p class="s180" style="text-indent: 0pt;text-align: left;">Is there Bounding</p><p style="text-indent: 0pt;text-align: left;"/><p class="s180" style="text-indent: 0pt;line-height: 109%;text-align: left;">Object localization</p><p style="text-indent: 0pt;text-align: left;"/><p class="s185" style="text-indent: 0pt;text-align: right;">terms</p><p class="s185" style="padding-top: 3pt;padding-left: 7pt;text-indent: 0pt;text-align: left;">Outputs</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 5pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="591" height="1" alt="image" src="KerasTensorFlow2019/Image_880.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s180" style="padding-top: 5pt;padding-left: 7pt;text-indent: 0pt;line-height: 152%;text-align: left;">Object detection</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="597" height="225" alt="image" src="KerasTensorFlow2019/Image_881.png"/></span></p><p class="s180" style="padding-left: 7pt;text-indent: 0pt;line-height: 109%;text-align: left;">Semantic segmentation</p><p class="s180" style="padding-top: 5pt;padding-left: 308pt;text-indent: 0pt;line-height: 109%;text-align: left;">What and where are “all” the objects in this image?</p><p style="text-indent: 0pt;text-align: left;"><span><img width="402" height="301" alt="image" src="KerasTensorFlow2019/Image_882.jpg"/></span></p><p class="s180" style="padding-top: 3pt;padding-left: 308pt;text-indent: 0pt;line-height: 109%;text-align: left;">Which pixels in this image belong to different classes; e.g., the class “sheep,”</p><p class="s180" style="padding-left: 308pt;text-indent: 0pt;line-height: 9pt;text-align: left;">“dog,”</p><p class="s180" style="padding-left: 308pt;text-indent: 0pt;text-align: left;">“person”?</p><p class="s180" style="padding-top: 5pt;padding-left: 3pt;text-indent: 0pt;line-height: 109%;text-align: left;">Bounding boxes, clas probabilities class ID prediction</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s180" style="padding-left: 3pt;text-indent: 0pt;line-height: 109%;text-align: left;">One mask per class</p><table style="border-collapse:collapse;margin-left:5.2536pt" cellspacing="0"><tr style="height:24pt"><td style="width:55pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" bgcolor="#F1F5FB"><p class="s186" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">Task</p></td><td style="width:306pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s186" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">I</p></td><td style="width:87pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D" bgcolor="#F1F5FB"><p class="s186" style="padding-top: 1pt;padding-left: 2pt;padding-right: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">In lay Outputs terms</p></td></tr><tr style="height:66pt"><td style="width:55pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:306pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" rowspan="2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:87pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:45pt"><td style="width:55pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:87pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:105pt"><td style="width:55pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:306pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:87pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s185" style="text-indent: 0pt;text-align: left;">mage</p><p style="text-indent: 0pt;text-align: left;"/><p class="s180" style="padding-top: 5pt;padding-left: 7pt;text-indent: 0pt;line-height: 109%;text-align: left;">Instance- level segmentation</p><p class="s180" style="padding-top: 5pt;padding-left: 308pt;text-indent: 0pt;line-height: 109%;text-align: left;">Which pixels in this image belong to each instance of each class; e.g.,</p><p style="text-indent: 0pt;text-align: left;"><span><img width="402" height="505" alt="image" src="KerasTensorFlow2019/Image_883.png"/></span></p><p class="s180" style="padding-left: 308pt;text-indent: 0pt;line-height: 9pt;text-align: left;">“sheep,”</p><p class="s180" style="padding-left: 308pt;text-indent: 0pt;text-align: left;">“dog,”</p><p class="s180" style="padding-left: 308pt;text-indent: 0pt;text-align: left;">“person”?</p><p class="s180" style="padding-top: 5pt;padding-left: 3pt;text-indent: 0pt;line-height: 109%;text-align: left;">One mask per instance of each class</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 5pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="591" height="1" alt="image" src="KerasTensorFlow2019/Image_884.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s181" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1511">Approaches to Object Detection</a><a name="bookmark1557">&zwnj;</a></p><p class="s132" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1559" class="s192" name="bookmark1558">Depending on the scenario, your needs, and technical know-how, there are a few ways to go about getting the object detection functionality in your applications. </a>Table 14-2 <span style=" color: #000;">takes a look at some approaches.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s182" style="padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1559">Table 14-2. Different approaches to object detection and their trade-offs</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:5.50388pt" cellspacing="0"><tr style="height:24pt"><td style="width:84pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:49pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s186" style="padding-top: 1pt;padding-left: 9pt;padding-right: 7pt;text-indent: 0pt;line-height: 109%;text-align: left;">Custom classes</p></td><td style="width:52pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s186" style="padding-top: 1pt;padding-left: 7pt;text-indent: 0pt;text-align: left;">Effort</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s186" style="padding-top: 1pt;padding-left: 3pt;text-indent: 0pt;line-height: 109%;text-align: left;">Cloud or local</p></td><td style="width:216pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s186" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">Pros and cons</p></td></tr><tr style="height:18pt"><td style="width:84pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s187" style="padding-top: 5pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">Cloud-based object</p></td><td style="width:49pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s187" style="padding-top: 5pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">No</p></td><td style="width:52pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s187" style="padding-top: 5pt;padding-left: 7pt;text-indent: 0pt;text-align: left;">&lt;5 minutes</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s187" style="padding-top: 5pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Cloud</p></td><td style="width:216pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s187" style="padding-top: 5pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">+ Thousands of classes</p></td></tr><tr style="height:14pt"><td style="width:84pt"><p class="s187" style="padding-left: 2pt;text-indent: 0pt;line-height: 8pt;text-align: left;">detection APIs</p></td><td style="width:49pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:52pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:43pt"><p class="s187" style="padding-left: 3pt;text-indent: 0pt;line-height: 8pt;text-align: left;">only</p></td><td style="width:216pt"><p class="s187" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">+ State of the art</p></td></tr><tr style="height:14pt"><td style="width:84pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:49pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:52pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:43pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:216pt"><p class="s187" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">+ Fast setup</p></td></tr><tr style="height:14pt"><td style="width:84pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:49pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:52pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:43pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:216pt"><p class="s187" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">+ Scalable API</p></td></tr><tr style="height:14pt"><td style="width:84pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:49pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:52pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:43pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:216pt"><p class="s187" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">– No customization</p></td></tr><tr style="height:15pt"><td style="width:84pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:49pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:52pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:43pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:216pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s187" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">– Latency due to network</p></td></tr><tr style="height:18pt"><td style="width:84pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s187" style="padding-top: 5pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">Pretrained model</p></td><td style="width:49pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s187" style="padding-top: 5pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">No</p></td><td style="width:52pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s187" style="padding-top: 5pt;padding-left: 7pt;text-indent: 0pt;text-align: left;">&lt;15</p></td><td style="width:43pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s187" style="padding-top: 5pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Local</p></td><td style="width:216pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s187" style="padding-top: 5pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">+ ~100 classes</p></td></tr><tr style="height:14pt"><td style="width:84pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:49pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:52pt" bgcolor="#F1F5FB"><p class="s187" style="padding-left: 7pt;text-indent: 0pt;line-height: 8pt;text-align: left;">minutes</p></td><td style="width:43pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:216pt" bgcolor="#F1F5FB"><p class="s187" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">+ Choice of model to fit speed and accuracy needs</p></td></tr><tr style="height:14pt"><td style="width:84pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:49pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:52pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:43pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:216pt" bgcolor="#F1F5FB"><p class="s187" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">+ Can run on the edge</p></td></tr><tr style="height:15pt"><td style="width:84pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:49pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:52pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:43pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:216pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s187" style="padding-top: 2pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">– No customization</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s180" style="padding-top: 2pt;padding-left: 7pt;text-indent: 0pt;line-height: 109%;text-align: left;">Cloud-based model training</p><p class="s180" style="padding-top: 2pt;padding-left: 7pt;text-indent: 0pt;text-align: left;">Yes &lt;20</p><p class="s180" style="padding-left: 55pt;text-indent: 0pt;text-align: left;">minutes</p><p class="s180" style="padding-top: 2pt;padding-left: 7pt;text-indent: 0pt;line-height: 109%;text-align: left;">Cloud and local</p><p class="s180" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">+ GUI-based, no coding for training</p><p class="s180" style="padding-top: 4pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">+ Customizability</p><p class="s180" style="padding-top: 4pt;padding-left: 3pt;text-indent: 0pt;line-height: 109%;text-align: left;">+ Choice between powerful model (for cloud) and efficient model (for edge)</p><p class="s180" style="padding-top: 3pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">+ Scalable API</p><p class="s180" style="padding-top: 4pt;padding-left: 3pt;text-indent: 0pt;line-height: 109%;text-align: left;">– Uses transfer learning, might not allow full-model retraining</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="592" height="76" alt="image" src="KerasTensorFlow2019/Image_885.png"/></span></p><p class="s180" style="padding-left: 7pt;text-indent: 0pt;line-height: 109%;text-align: left;">Custom training a model</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s180" style="padding-left: 55pt;text-indent: -47pt;line-height: 109%;text-align: left;">Yes 4 hours to 2 days</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s180" style="padding-left: 7pt;text-indent: 0pt;text-align: left;">Local + Highly customizable</p><p class="s180" style="padding-top: 4pt;padding-left: 51pt;text-indent: 0pt;line-height: 109%;text-align: left;">+ Largest variety of models available for different speed and accuracy requirements</p><p class="s180" style="padding-top: 4pt;padding-left: 51pt;text-indent: 0pt;text-align: left;">– Time consuming and highly involved</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s132" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark955" class="s192">It’s worth noting that the options marked “Cloud” are already engineered for scalability. At the same time, the options marked as being available for “Local” inferences can also be deployed on the cloud. To achieve high scale, we can host them on the cloud similar to how we did so for the classification models in </a>Chapter 9<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s181" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1512">Invoking Prebuilt Cloud-Based Object Detection APIs</a><a name="bookmark1560">&zwnj;</a></p><p class="s132" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark828" class="s192" name="bookmark1561">As we already saw in </a>Chapter 8<a href="#bookmark1563" class="s192">, calling cloud-based APIs is relatively straightforward. The process involves setting up an account, getting an API key, reading through the documentation, and writing a REST API client. To make this process easier, many of these services provide Python-based (and other language) SDKs. The main cloud-based object detection API providers are Google’s Vision AI (</a>Figure 14-2<span style=" color: #000;">) and Microsoft’s Cognitive Services.</span></p><p class="s133" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">The main advantages of using cloud-based APIs are that they are scalable out of the box and they support recognition of thousands of classes of objects. These cloud giants built their models using large proprietary datasets that are constantly growing, resulting in a very rich taxonomy. Considering that the number of classes in the largest public datasets with object detection labels is usually only a few hundred, there exists no nonproprietary solution out there that is capable of detecting thousands of classes.</p><p class="s133" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: justify;"><a name="bookmark1562">The main limitation of cloud-based APIs, of course, is the latency due to network requests. It’s not possible to power real-time experiences with this kind of lag. In the next section, we look at how to power real-time experiences without any data or training.</a></p><p style="padding-left: 77pt;text-indent: 0pt;text-align: left;"><span><img width="399" height="587" alt="image" src="KerasTensorFlow2019/Image_886.jpg"/></span></p><p class="s178" style="padding-top: 7pt;padding-left: 48pt;text-indent: 0pt;text-align: left;"><a name="bookmark1563">Figure 14-2. Running a familiar photo on Google’s Vision AI API to obtain object detection results</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s181" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1513">Reusing a Pretrained Model</a><a name="bookmark1564">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s192" target="_blank" name="bookmark1565">In this section, we explore how easy it is to get an object detector running on a mobile phone with a pretrained model. Hopefully, you are already comfortable with running a neural network on mobile from some of the previous chapters. The code to run object detection models on iOS and Android is referenced on the book’s GitHub website (see </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 10pt;">http://PracticalDeepLearning.ai</span>) at <i>code/chapter-14</i>. Changing functionality is simply a matter of replacing the existing <i>.tflite </i>model file with a new one.</p><p class="s133" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1566">In the previous chapters, we often used MobileNet to do classification tasks. Although the MobileNet family, including MobileNetV2 (2018) and MobileNetV3 (2019) by itself are classification networks only, they can act as a backbone for object detection architectures like SSD MobileNetV2, which we use in this chapter.</a></p><p class="s40" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1514">Obtaining the Model</a><a name="bookmark1567">&zwnj;</a></p><p class="s132" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="https://oreil.ly/9CsHM" class="s192" target="_blank" name="bookmark1568">The best way to uncover the magic behind the scenes is to take a deeper look at a model. We’d need to get our hands on the </a>TensorFlow Models repository<span style=" color: #000;">, which features models for more than 50 deep learning tasks, including audio classification, text summarization, and object detection. This repository contains models as well as utility scripts that we use throughout this chapter. Without further ado, let’s clone the repository on our machines:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">$ git clone https://github.com/tensorflow/models.git &amp;&amp; cd models/research</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Then, we update the <span class="s113">PYTHONPATH </span>to make all scripts visible to Python:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">$ export PYTHONPATH=&quot;${PYTHONPATH}:`pwd`:`pwd`/slim&quot;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 113%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s192" target="_blank">Next, we copy over the Protocol Buffer (protobuf) compiler command script from our GitHub repository (see </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 10pt;">http://PracticalDeepLearning.ai</span>) into our current directory to make the .<span class="s113">proto </span>files available to Python:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">$ cp {path_to_book_github_repo}/code/chapter-14/add_protoc.sh . &amp;&amp; \ chmod +x add_protoc.sh &amp;&amp; \</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">./add_protoc.sh</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Finally, we run the <i>setup.py </i>script as follows:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">$ python setup.py build</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">$ python setup.py install</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 110%;text-align: left;"><a href="https://oreil.ly/FwSlM" class="s192" target="_blank">Now is the time to download our prebuilt model. In our case, we’re using the SSD MobileNetV2 model. You can find a large list of models at TensorFlow’s </a><span style=" color: #8E0012;">object detection model zoo</span>, featuring models by the datasets on which they were trained, speed of inference, and Mean Average Precision (mAP). Within that list, download the model titled <span class="s113">ssd_mobilenet_v2_coco</span>, which, as the name suggests, was trained on the MS COCO dataset. Benchmarked at 22 mAP, this model runs at 31 ms on an NVIDIA GeForce GTX TITAN X with a 600x600 resolution input. After downloading that model, we unzip it into the <i>models/research/object_detection </i>directory inside the TensorFlow repository. We can inspect the contents of the directory as follows:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">$ cd object_detection/</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">$ ls <b>ssd_mobilenet_v2_coco_2018_03_29</b></p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">checkpoint model.ckpt.data-OOOOO-of-OOOO1 model.ckpt.meta saved_model</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">frozen_inference_graph.pb model.ckpt.index pipeline.config</p><p class="s40" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1515">Test Driving Our Model</a><a name="bookmark1569">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">Before we plug our model into a mobile app, it’s a good idea to verify whether the model is able to make predictions. The TensorFlow Models repository contains a Jupyter Notebook where we can simply plug in a photograph to make predictions on it. You can find the notebook at <i>models/research/object_detection/object_detection_tutorial.ipynb</i><a href="#bookmark1570" class="s192">. </a><span style=" color: #8E0012;">Figure 14-3 </span>shows a prediction from that notebook on a familiar photograph.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 110pt;text-indent: 0pt;text-align: left;"><span><img width="318" height="311" alt="image" src="KerasTensorFlow2019/Image_887.jpg"/></span></p><p class="s178" style="padding-top: 7pt;padding-left: 11pt;text-indent: 0pt;text-align: left;"><a name="bookmark1570">Figure 14-3. Object detection prediction in the ready-to-use Jupyter Notebook from the TensorFlow Models repository</a></p><p class="s40" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1516">Deploying to a Device</a><a name="bookmark1571">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 111%;text-align: left;">Now that we’ve verified that the model works, it’s time to convert it into a mobile-friendly format. For conversion to the TensorFlow Lite format, we use our familiar <span class="s113">tflite_convert </span><a href="#bookmark1389" class="s192">tool from </a><span style=" color: #8E0012;">Chapter 13</span>. It should be noted that this tool operates on <i>.pb </i>files, whereas the TensorFlow Object Detection model zoo provides only model checkpoints. So, we first need to generate a <i>.pb </i>model from the checkpoints and graphs. Let’s do that using the handy script that comes with the TensorFlow Models repository. You can find the <i>export_tflite_ssd_graph.py </i>file in <i>models/research/object_detection</i>:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">$ python export_tflite_ssd_graph.py \</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">--pipeline_config_path=<b>ssd_mobilenet_v2_coco_2018_03_29</b>/pipeline.config \</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">--trained_checkpoint_prefix=<b>ssd_mobilenet_v2_coco_2018_03_29</b>/ model.ckpt.data-OOOOO-of-OOOO1 \</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">--output_directory=tflite_model \</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">--add_postprocessing_op=true</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">If the preceding script execution was successful, we’ll see the following files in the <i>tflite_model</i></p><p class="s133" style="padding-top: 1pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">directory:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">$ ls tflite_model tflite_graph.pb tflite_graph.pbtxt</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">We will convert this to the TensorFlow Lite format using the <span class="s113">tflite_convert </span>tool.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">$ tflite_convert --graph_def_file=tflite_model/tflite_graph.pb \</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">--output_file=tflite_model/model.tflite</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s132" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s192" target="_blank">Now the only thing that remains is to plug the model into an app. The app that we’ll be using is referenced in the book’s GitHub website (see </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 10pt;">http://PracticalDeepLearning.ai</span><span style=" color: #000;">) at </span><span class="s182">code/chapter-14</span><a href="#bookmark1183" class="s192">. We have already looked at how to swap a model in an app in Chapters </a>11<a href="#bookmark1295" class="s192">, </a>12<a href="#bookmark1389" class="s192">, and </a>13<a href="#bookmark1572" class="s192">, so we won’t discuss that here again. </a>Figure 14-4 <span style=" color: #000;">shows the result of the object detector model when plugged into the Android app.</span></p><p style="padding-left: 77pt;text-indent: 0pt;text-align: left;"><span><img width="404" height="470" alt="image" src="KerasTensorFlow2019/Image_888.jpg"/></span></p><p class="s178" style="padding-top: 2pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1572">Figure 14-4. Running a real-time object detector model on an Android device</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s132" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark828" class="s192" name="bookmark1573">The reason why we’re able to see the “Cat” prediction right away is because ‘Cat’ is one of the 80 categories already present in the MS COCO dataset that was used to train the model. This model might be sufficient for Bob to deploy on his devices (keeping in mind that although Bob might not use mobile phones to track his garden, the process for deploying a TensorFlow Lite model to edge hardware is quite similar). However, Bob would do well for himself to improve the precision of his model by fine tuning it on data that has been generated within his garden. In the next section, we explore how to use transfer learning to build an object detector by using only a web-based tool. If you’ve read </a>Chapter 8<span style=" color: #000;">, what comes next should feel familiar.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s181" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1517">Building a Custom Detector Without Any Code</a><a name="bookmark1574">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">My cat’s breath smells like cat food! Ralph Wiggum</p><p class="s133" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1575">Let’s face it. Your authors could go around and snap a lot of cat pictures within their gardens to perform this experiment. It would be tedious, and we might be rewarded with only a few extra percentage points of precision and recall. Or we could look at a really fun example that also tests the limits of CNNs. We are, of course, referring to </a><i>The Simpsons</i>. Given that most models are not trained with features from cartoon images, it would be interesting to see how our model performs here.</p><p class="s132" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="https://oreil.ly/-3wvj" class="s192" target="_blank" name="bookmark1576">First, we need to get our hands on a dataset. Thankfully, we have one readily available on </a>Kaggle<a href="#bookmark828" class="s192">. Let’s download the dataset and use CustomVision.ai (similar to </a>Chapter 8<span style=" color: #000;">) to train our Simpsons Classifier using the following steps. </span><span class="s182">Excellent!</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="552" height="139" alt="image" src="KerasTensorFlow2019/Image_889.png"/></span></p><p class="s179" style="padding-top: 7pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s180" style="padding-top: 4pt;padding-left: 4pt;text-indent: 0pt;line-height: 109%;text-align: left;">Contrary to what some may believe, we, the authors, do not have millions of dollars lying around. This means that we cannot afford to buy the rights to <i>The Simpsons </i>from Fox. Copyright laws, as a consequence, prevent us from publishing any images from that show. Instead, in this section, we are using the next best thing — public domain images from the United States Congress. In place of the images from the cartoon, we use the photographs of congresswomen and congressmen with the same first names as the Simpsons family: <i>Homer </i>Hoch, <i>Marge </i>Roukema, <i>Bart </i>Gordon, and <i>Lisa </i>Blunt Rochester. Keep in mind that this is only for publishing purposes; we have still trained on the original dataset from the cartoon.</p><p style="text-indent: 0pt;text-align: left;"/><ol id="l47"><li><p class="s132" style="padding-top: 4pt;padding-left: 40pt;text-indent: -11pt;text-align: left;"><a href="#bookmark1577" class="s192">Go to CustomVision.ai and start a new Object Detection Project (</a>Figure 14-5<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 48pt;text-indent: 0pt;text-align: left;"><span><img width="379" height="452" alt="image" src="KerasTensorFlow2019/Image_890.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s178" style="padding-top: 5pt;padding-left: 42pt;text-indent: 0pt;text-align: left;"><a name="bookmark1577">Figure 14-5. Creating a new Object Detection project in CustomVision.ai</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s132" style="padding-top: 7pt;padding-left: 40pt;text-indent: -11pt;text-align: left;"><a href="#bookmark1578" class="s192">Create tags for Homer, Marge, Bart, and Lisa. Upload 15 images for each character and draw a bounding box for each of those images. The dashboard should resemble </a><a href="#bookmark1578" class="s131">Figure </a>14-6<span style=" color: #000;"> right about now.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 43pt;text-indent: 0pt;text-align: left;"><span><img width="399" height="390" alt="image" src="KerasTensorFlow2019/Image_891.jpg"/></span></p><p class="s178" style="padding-top: 5pt;padding-left: 66pt;text-indent: 0pt;text-align: left;"><a name="bookmark1578">Figure 14-6. Dashboard with bounding box and class name</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s133" style="padding-top: 7pt;padding-left: 40pt;text-indent: -11pt;text-align: left;">Click the Train button and let the training commence. There are sliders to control the probability and overlap thresholds on the dashboard. We can play around with them and adjust them to something we like and with which get good precision and recall.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s133" style="padding-left: 40pt;text-indent: -11pt;text-align: left;">Click the Quick Test button and use any random image of the Simpsons (not previously used for training) to test the performance of the model. The results might not be great yet, but that’s okay: we can fix it by training with more data.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s133" style="padding-left: 40pt;text-indent: -11pt;text-align: left;">Let’s experiment with how many images we need to increase precision, recall, and mAP. Let’s start by adding five more images for each class and retrain the model.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s132" style="padding-left: 40pt;text-indent: -11pt;text-align: left;"><a href="#bookmark1579" class="s192">Repeat this process until we have acceptable results. </a>Figure 14-7 <span style=" color: #000;">shows the results from our experiment.</span></p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 103pt;text-indent: 0pt;text-align: left;"><span><img width="384" height="224" alt="image" src="KerasTensorFlow2019/Image_892.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s178" style="padding-top: 5pt;padding-left: 235pt;text-indent: -194pt;line-height: 109%;text-align: left;"><a name="bookmark1579">Figure 14-7. Measuring improvement in percent mean average precision with increasing number of images per class</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s132" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1580" class="s192">With our final model, we are able to get reasonably good detections for a random image off the internet, as can be seen in </a>Figure 14-8<span style=" color: #000;">. Although not expected, it is surprising that a model pretrained on natural images is able to fine tune on cartoons with relatively little data.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 5pt;text-indent: 0pt;text-align: left;"><span><img width="400" height="400" alt="image" src="KerasTensorFlow2019/Image_893.jpg"/></span></p><p class="s178" style="padding-top: 6pt;padding-left: 8pt;text-indent: 0pt;line-height: 109%;text-align: center;"><a name="bookmark1580">Figure 14-8. Detected Simpsons characters with the final model, represented by US congress members of the same first name (see note at the beginning of this section)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">As we already know by now, CustomVision.ai allows this model to be exported in a variety of formats including Core ML, TensorFlow Lite, ONNX, and more. We can simply download into our desired format (<i>.tflite </i>in our case) and plug this file into the app similar to see how we did with the pretrained model in the previous section. With real-time Simpsons detection in our hands, we could</p><p style="text-indent: 0pt;text-align: left;"><span><img width="552" height="112" alt="image" src="KerasTensorFlow2019/Image_894.png"/></span></p><p class="s179" style="padding-top: 7pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s180" style="padding-top: 4pt;padding-left: 4pt;text-indent: 0pt;line-height: 109%;text-align: left;">CustomVision.ai is not the only platform that allows you to label, train, and deploy online without writing any code. Google’s Cloud AutoML (in beta as of October 2019) and Apple’s Create ML (only for the Apple ecosystem) offer a very similar feature set. Additionally, Matroid allows you to build custom object detectors from video feeds, which can be extremely useful to train a network without spending too much effort on building a dataset.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s133" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">show it off to our friends and family the next time Principal Skinner talks about steamed hams on our TV.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1581">So far, we have looked at three quick ways to get object detection running with a very minimal amount of code. We estimate that about 90% of use cases can be handled with one of these options. If you can solve for your scenario using these, you can stop reading this chapter and jump straight to the “Case Studies” section.</a><a name="bookmark1582">&zwnj;</a></p><p class="s133" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1583">In a very small set of scenarios, we might want further fine-grained control on factors such as accuracy, speech, model size, and resource usage. In the upcoming sections, we look at the world of object detection in a little more detail, from labeling the data all the way to deploying the model.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s181" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1518">The Evolution of Object Detection</a><a name="bookmark1584">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1585">Over the years, as the deep learning revolution happened, there was a renaissance not only for classification, but also for other computer-vision tasks, including object detection. During this time, several architectures were proposed for object detection, often building on top of each other.</a></p><p class="s132" style="padding-left: 5pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Figure 14-9 <span style=" color: #000;">shows a timeline of some of them.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 77pt;text-indent: 0pt;text-align: left;"><span><img width="402" height="132" alt="image" src="KerasTensorFlow2019/Image_895.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s178" style="padding-top: 5pt;padding-left: 154pt;text-indent: -146pt;line-height: 109%;text-align: left;"><a name="bookmark1586">Figure 14-9. A timeline of different object detection architectures (image source: Recent Advances in Deep Learning for Object Detection by Xiongwei Wu et al.)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="552" height="178" alt="image" src="KerasTensorFlow2019/Image_896.png"/></span></p><p class="s179" style="padding-top: 7pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s180" style="padding-top: 4pt;padding-left: 4pt;text-indent: 0pt;line-height: 109%;text-align: left;">In the world of object detection, Ross Girshik is a name you will encounter often while reading papers. Working before the deep learning era as well as during it, his work includes Deformable Part Models (DPM), R-CNN, Fast R-CNN, Faster R-CNN, You Only Look Once (YOLO), Mask R-CNN, Feature Pyramid Network (FPN), RetinaNet, and ResNeXt to name just a few, often breaking his own records year after year on public benchmarks.</p><p class="s180" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;line-height: 109%;text-align: left;">I participated in several first-place entries into the PASCAL VOC object detection challenge, and was awarded a “lifetime achievement” prize for my work on deformable part models. I think this refers to the lifetime of the PASCAL challenge — and not mine!</p><p class="s180" style="padding-left: 9pt;text-indent: 0pt;line-height: 9pt;text-align: left;">— Ross Girschik</p><p style="text-indent: 0pt;text-align: left;"/><p class="s133" style="padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">In object classification, our CNN architecture extracts the features from an image and computes the probabilities for a specific number of classes. These CNN architectures (ResNet, MobileNet) work as the <i>backbone </i><a href="http://practicaldeeplearning.ai/" class="s192" target="_blank">for object detection networks. In object detection networks, our end result is bounding boxes (defined by the center of rectangle, height, width). Although covering the inner details of many of these will probably need significantly more in-depth exploration (which you can find on this book’s GitHub website, linked at </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 10pt;">http://PracticalDeepLearning.ai</span><a href="#bookmark1587" class="s192">), we can broadly divide them into two categories, as shown in </a><span style=" color: #8E0012;">Table 14-3</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:5.50388pt" cellspacing="0"><tr style="height:17pt"><td style="width:49pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:282pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s190" style="padding-left: 79pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a name="bookmark1587">Table 14-3. Categories of object detectors</a></p></td><td style="width:113pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:14pt"><td style="width:49pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:282pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s186" style="padding-top: 1pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Description</p></td><td style="width:113pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s186" style="padding-top: 1pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Pros and cons</p></td></tr><tr style="height:18pt"><td style="width:49pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s186" style="padding-top: 5pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">Two-stage</p></td><td style="width:282pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s187" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Generate category-agnostic bounding box candidates (regions of interest)</p></td><td style="width:113pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s187" style="padding-top: 5pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">+ High Accuracy</p></td></tr><tr style="height:24pt"><td style="width:49pt"><p class="s186" style="padding-left: 2pt;text-indent: 0pt;line-height: 8pt;text-align: left;">detectors</p></td><td style="width:282pt"><p class="s187" style="padding-left: 6pt;text-indent: 0pt;line-height: 8pt;text-align: left;">using a Region Proposal Network (RPN).</p><p class="s187" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Run a CNN on these region proposals to assign each a category.</p></td><td style="width:113pt"><p class="s187" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">– Slower</p></td></tr><tr style="height:15pt"><td style="width:49pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:282pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s187" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Examples: Faster R-CNN, Mask R-CNN.</p></td><td style="width:113pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:16pt"><td style="width:49pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s186" style="padding-top: 5pt;padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">One-stage</p></td><td style="width:282pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s187" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Directly make categorical predictions on objects on each location of the</p></td><td style="width:113pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s187" style="padding-top: 5pt;padding-left: 3pt;text-indent: 0pt;line-height: 9pt;text-align: left;">+ Speed, better suited for</p></td></tr><tr style="height:12pt"><td style="width:49pt" bgcolor="#F1F5FB"><p class="s186" style="padding-left: 2pt;text-indent: 0pt;text-align: left;">detectors</p></td><td style="width:282pt" bgcolor="#F1F5FB"><p class="s187" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">feature maps; can be trained end-to-end training.</p></td><td style="width:113pt" bgcolor="#F1F5FB"><p class="s187" style="padding-left: 3pt;text-indent: 0pt;text-align: left;">real-time applications</p></td></tr><tr style="height:15pt"><td style="width:49pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:282pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s187" style="padding-top: 2pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Examples: YOLO, Single-Shot Detector (SSD).</p></td><td style="width:113pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s187" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">– Lower accuracy</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s40" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1519">Performance Considerations</a><a name="bookmark1588">&zwnj;</a></p><p class="s132" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1590" class="s192" name="bookmark1589">From a practitioner’s point of view, the primary concerns tend to be accuracy and speed. These two factors usually have an inverse relationship with each other. We want to find the detector that strikes the ideal balance for our scenario. </a>Table 14-4 <span style=" color: #000;">summarizes some of those readily available pretrained models on the TensorFlow object detection model zoo. The speed reported was on a 600x600 pixel resolution image input, processed on an NVIDIA GeForce GTX TITAN X card.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s182" style="padding-left: 95pt;text-indent: 0pt;text-align: center;"><a name="bookmark1590">Table 14-4. Speed versus percent mean average precision for some readily available architectures on the TensorFlow object detection model zoo website</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:82.0888pt" cellspacing="0"><tr style="height:14pt"><td style="width:114pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:88pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s186" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">Inference speed (ms)</p></td><td style="width:89pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s186" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">% mAP on MS COCO</p></td></tr><tr style="height:14pt"><td style="width:114pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s186" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">ssd_mobilenet_v1_coco</p></td><td style="width:88pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s187" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">30</p></td><td style="width:89pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s187" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">21</p></td></tr><tr style="height:14pt"><td style="width:114pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s186" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">ssd_mobilenet_v2_coco</p></td><td style="width:88pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s187" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">31</p></td><td style="width:89pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s187" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">22</p></td></tr><tr style="height:14pt"><td style="width:114pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s186" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">ssdlite_mobilenet_v2_coco</p></td><td style="width:88pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s187" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">27</p></td><td style="width:89pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s187" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">22</p></td></tr><tr style="height:14pt"><td style="width:114pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s186" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">ssd_resnet_50_fpn_coco</p></td><td style="width:88pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s187" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">76</p></td><td style="width:89pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s187" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">35</p></td></tr><tr style="height:14pt"><td style="width:114pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s186" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">faster_rcnn_nas</p></td><td style="width:88pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s187" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">1,833</p></td><td style="width:89pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s187" style="padding-top: 1pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">43</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_897.png"/></span></p><p class="s132" style="padding-left: 25pt;text-indent: -20pt;line-height: 139%;text-align: left;"><a href="#bookmark1591" class="s192">A 2017 study done by Google (see </a>Figure 14-10<span style=" color: #000;">) revealed the following key findings: One-stage detectors are faster than two-stage, though less accurate.</span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_898.png"/></span></p><p class="s133" style="padding-top: 5pt;padding-left: 25pt;text-indent: 0pt;text-align: left;">The higher the accuracy of the backbone CNN architecture on classification tasks (such as ImageNet), the higher the precision of the object detector.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_899.png"/></span></p><p class="s133" style="padding-left: 25pt;text-indent: 0pt;text-align: left;">Small-sized objects are challenging for object detectors, which give poor performance (usually under 10% mAP). The effect is more severe on one-stage detectors.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_900.png"/></span></p><p class="s133" style="padding-left: 25pt;text-indent: 0pt;text-align: left;">On large-sized objects, most detectors give similar performance.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_901.png"/></span></p><p class="s133" style="padding-left: 25pt;text-indent: 0pt;text-align: left;">Higher-resolution images give better results because small objects appear larger to the network.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_902.png"/></span></p><p class="s133" style="padding-left: 25pt;text-indent: 0pt;text-align: left;">Two-stage object detectors internally generate a large number of proposals to be considered as the potential locations of objects. The number of proposals can be tuned. Decreasing the number of proposals can lead to speedups with little loss in accuracy (the threshold will depend on the use case).</p><p style="padding-left: 77pt;text-indent: 0pt;text-align: left;"><span><img width="404" height="242" alt="image" src="KerasTensorFlow2019/Image_903.jpg"/></span></p><p class="s178" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: center;"><a href="http://practicaldeeplearning.ai/" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 8pt;" target="_blank" name="bookmark1591">Figure 14-10. The effect of object detection architecture as well as the backbone architecture (feature extractor) on the percent mean average precision and prediction time (note that the colors might not be clear in grayscale printing; refer to the book’s GitHub website [see </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 8pt;">http://PracticalDeepLearning.ai</span>] for the color image) (image source: Speed/accuracy trade-offs for modern convolutional object detectors by Jonathan Huang et al.)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s181" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1520">Key Terms in Object Detection</a><a name="bookmark1592">&zwnj;</a><a name="bookmark1594">&zwnj;</a><a name="bookmark1521">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1593">The terms used heavily in object detection include Intersection over Union, Mean Average Precision, Non-Maximum Suppression, and Anchor. Let’s examine what each of these means.</a></p><p class="s40" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Intersection over Union</p><p class="s132" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1596" class="s192" name="bookmark1595">In an object detection training pipeline, metrics such as Intersection over Union (IoU) are typically used as a threshold value to filter detections of a certain quality. To calculate the IoU, we use both the predicted bounding box and the ground truth bounding box to calculate two different numbers. The first is the area where both the prediction and the ground truth overlap — the intersection. The second is the span covered by both the prediction and the ground truth — the union. As the name suggests, we simply divide the total area of the intersection by the area of the union to get the IoU. </a>Figure 14-11 <span style=" color: #000;">visually demonstrates the IoU concept for two 2x2 squares that intersect in a single 1x1 square in the middle.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 80pt;text-indent: 0pt;text-align: left;"><span><img width="381" height="307" alt="image" src="KerasTensorFlow2019/Image_904.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s178" style="padding-top: 5pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1596">Figure 14-11. A visual representation of the IoU ratio</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s132" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1597" class="s192">In the perfect scenario in which the predicted bounding box matches the ground truth exactly, the IoU value would be 1. In the worst-case scenario, the prediction would have no overlap with the ground truth and the IoU value would be 0. As we can see, the IoU value would range between 0 and 1, with higher numbers indicating higher-quality predictions, as illustrated in </a>Figure 14-12<span style=" color: #000;">.</span></p><p class="s133" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">To help us filter and report results, we would set a minimum IoU threshold value. Setting the threshold to a really aggressive value (such as 0.9) would result in a loss of a lot of predictions that might turn out to be important further down the pipeline. Conversely, setting the threshold value too low would result in too many spurious bounding boxes. A minimum IoU of 0.5 is typically used for reporting the precision of an object detection model.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 5pt;text-indent: 0pt;text-align: left;"><span><img width="397" height="150" alt="image" src="KerasTensorFlow2019/Image_905.jpg"/></span></p><p class="s178" style="padding-top: 6pt;padding-left: 26pt;text-indent: -19pt;line-height: 109%;text-align: left;"><a name="bookmark1597">Figure 14-12. IoU illustrated; predictions from better models tend to have heavier overlap with the ground truth, resulting in a higher IoU</a></p><p class="s133" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">It’s worth reiterating here that the IoU value is calculated per instance of a category, not per image. However, to calculate the quality of the detector over a larger set of images, we would use IoU in conjunction with other metrics such as Average Precision.</p><p class="s40" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1522">Mean Average Precision</a><a name="bookmark1598">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="mailto:AP@0.5" class="s192" target="_blank" name="bookmark1599">While reading research papers on object detection, we often come across numbers such as </a>AP@0.5. That term conveys the average precision at IoU=0.5. Another more elaborate representation would be AP@[0.6:0.05:0.75], which is the average precision from IoU=0.6 to IoU=0.75 at increments of 0.05. The Mean Average Precision (or mAP) is simply the average precision across all categories. For the COCO challenge, the MAP metric used is AP@[0.5:0.05:0.95].</p><p class="s40" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1523">Non-Maximum Suppression</a><a name="bookmark1600">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1601">Internally, object detection algorithms make a number of proposals for the potential locations of objects that might be in the image. For each object in the image, it is expected to have multiple of these bounding box proposals at varying confidence values. Our task is to find the one proposal that best represents the real location of the object. A naïve way would be to consider only the proposal with the maximum confidence value. This approach might work if there were only one object in the entire image. But this won’t work if there are multiple categories, each with multiple instances in a single image.</a></p><p class="s132" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1603" class="s192">Non-Maximum Suppression (NMS) comes to the rescue (</a>Figure 14-13<span style=" color: #000;">). The key idea behind NMS is that two instances of the same object will not have heavily overlapping bounding boxes; for instance, the IoU of their bounding boxes will be less than a certain IoU threshold (say 0.5). A greedy way to achieve this is by repeating the following steps for each category:</span></p><ol id="l48"><li><p class="s133" style="padding-top: 3pt;padding-left: 40pt;text-indent: -11pt;text-align: left;">Filter out all proposals under a minimum confidence threshold.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s133" style="padding-left: 40pt;text-indent: -11pt;text-align: left;">Accept the proposal with the maximum confidence value.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s133" style="padding-left: 40pt;text-indent: -11pt;text-align: left;">For all remaining proposals sorted in descending order of their confidence values, check whether the IoU of the current box with respect to one of the previously accepted proposals</p></li></ol><p class="s133" style="padding-left: 40pt;text-indent: 0pt;text-align: left;"><a name="bookmark1602">≥ 0.5. If so, filter it; otherwise, accept it as a proposal.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 94pt;text-indent: 0pt;text-align: left;"><span><img width="403" height="149" alt="image" src="KerasTensorFlow2019/Image_906.jpg"/></span></p><p class="s178" style="padding-top: 4pt;padding-left: 45pt;text-indent: 0pt;text-align: left;"><a name="bookmark1603">Figure 14-13. Using NMS to find the bounding box that best represents the location of the object in an image</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s181" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1524">Using the TensorFlow Object Detection API to Build Custom Models</a><a name="bookmark1604">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1605">In this section, we run through a full end-to-end example of building an object detector. We look at several steps in the process, including collecting, labeling, and preprocessing data, training the model, and exporting it to the TensorFlow Lite format.</a></p><p class="s133" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">First, let’s look at some strategies for collecting data.</p><p class="s40" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1525">Data Collection</a><a name="bookmark1606">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1607">We know by now that, in the world of deep learning, data reigns supreme. There are a few ways in which we can acquire data for the object that we want to detect:</a></p><p class="s182" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Using ready-to-use datasets</p><p class="s133" style="padding-top: 3pt;padding-left: 25pt;text-indent: 0pt;text-align: left;">There are a few public datasets available to train object detection models such as MS COCO (80 categories), ImageNet (200 categories), Pascal VOC (20 categories), and the newer Open Images (600 categories). MS COCO and Pascal VOC are used in most object detection benchmarks, with COCO-based benchmarks being more realistic for real-world scenarios due to more complex imagery.</p><p class="s182" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Downloading from the web</p><p class="s132" style="padding-top: 3pt;padding-left: 25pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1295" class="s192">We should already be familiar with this process from </a>Chapter 12 <span style=" color: #000;">in which we collected images for the “Hot Dog” and “Not Hot Dog” classes. Browser extensions such as Fatkun come in handy for quickly downloading a large number of images from search engine results.</span></p><p class="s182" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Taking pictures manually</p><p class="s132" style="padding-top: 3pt;padding-left: 25pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1608" class="s192">This is the more time consuming (but potentially fun) option. For a robust model, it’s important to train it with pictures taken in a variety of different settings. With the object to detect in hand, we should take at least 100 to 150 images of it against different backgrounds, with a variety of compositions (framing) and angles, and in many different lighting conditions. </a>Figure 14-14 <span style=" color: #000;">shows some examples of pictures taken to train a Coke and Pepsi object detection model.</span></p><p class="s133" style="padding-left: 25pt;text-indent: 0pt;text-align: left;">Considering that a model can potentially learn the spurious correlation that red means Coke and blue means Pepsi, it’s a good idea to mix objects with backgrounds that could potentially confuse it so that eventually we realize a more robust model.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 77pt;text-indent: 0pt;text-align: left;"><span><img width="399" height="400" alt="image" src="KerasTensorFlow2019/Image_907.jpg"/></span></p><p class="s178" style="padding-top: 6pt;padding-left: 29pt;text-indent: 0pt;text-align: left;"><a name="bookmark1608">Figure 14-14. Photographs of objects taken in a variety of different settings to train an object detector model</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">It’s worth taking pictures of the object in environments that it’s unlikely to be used in order to diversify the dataset and improve the robustness of the model. It also has the added bonus of</p><p class="s132" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1609" class="s192">keeping an otherwise boring and tedious process a little entertaining. We can make it interesting by challenging ourselves to come up with unique and innovative photos. </a>Figure 14-15 <span style=" color: #000;">shows some creative examples of photos taken during the process of building a currency detector.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 77pt;text-indent: 0pt;text-align: left;"><span><img width="403" height="269" alt="image" src="KerasTensorFlow2019/Image_908.jpg"/></span></p><p class="s178" style="padding-top: 3pt;padding-left: 5pt;text-indent: 28pt;text-align: left;"><a name="bookmark1609">Figure 14-15. Some creative photographs taken during the process of building a diverse currency dataset</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s132" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark227" class="s192">Because we want to make a cat detector, we will be reusing the cat images from the “Cats and Dogs” Kaggle dataset that we used in </a>Chapter 3<span style=" color: #000;">. We randomly chose images from that set and split them into a train and test set.</span></p><p class="s133" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">To maintain uniformity of input size to our network, we resize all images to a fixed size. We will use the same size as part of our network definition and while converting to a <i>.tflite </i>model. We can use the ImageMagick tool to resize all images at once:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">$ apt-get install imagemagick</p><p style="text-indent: 0pt;text-align: left;"><span><img width="552" height="140" alt="image" src="KerasTensorFlow2019/Image_909.png"/></span></p><p class="s179" style="padding-top: 7pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s180" style="padding-top: 4pt;padding-left: 4pt;text-indent: 0pt;line-height: 112%;text-align: left;">If you have a large number of images (i.e., several tens of thousands of images) in the current directory, the preceding command might fail to enlist all of the images. A solution would be to use the <span class="s188">find </span>command to list all of the images and pipe the output to the <span class="s188">mogrify </span>command:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s193" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">$ find . -type f | awk -F. &#39;!a[$NF]++{print $NF}&#39; | xargs -I{} mogrify -resize 8OOx6OO *.jpg</p><p style="text-indent: 0pt;text-align: left;"/><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">$ mogrify -resize 8OOx6OO *.jpg</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s40" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1526">Labeling the Data</a><a name="bookmark1610">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1611">After we have our data, the next step would be to label it. Unlike classification where simply placing an image in the correct directory would be sufficient, we need to manually draw the bounding rectangles for the objects of interest. Our tool of choice for this task is LabelImg (available for Windows, Linux, and Mac) for the following reasons:</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_910.png"/></span></p><p class="s133" style="padding-top: 3pt;padding-left: 25pt;text-indent: 0pt;text-align: left;">You can save annotations either as XML files in PASCAL VOC format (also adopted by ImageNet) or the YOLO format.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_911.png"/></span></p><p class="s133" style="padding-left: 25pt;text-indent: 0pt;text-align: left;">It supports single and multiclass labels.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="552" height="222" alt="image" src="KerasTensorFlow2019/Image_912.png"/></span></p><p class="s179" style="padding-top: 7pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s180" style="padding-top: 4pt;padding-left: 4pt;text-indent: 0pt;line-height: 109%;text-align: left;">If you are the curious cat like us, you’d want to know what the difference is between the YOLO format and the PASCAL VOC format. YOLO happens to use simple <i>.txt </i>files, one per image with the same name, to store information about the classes and the bounding boxes within the image. The following is what a <i>.txt </i>file in YOLO format typically looks like:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s193" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">class_for_box1 box1_x box1_y box1_w box1_h class_for_box2 box2_x box2_y box2_w box2_h</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s180" style="padding-top: 4pt;padding-left: 4pt;text-indent: 0pt;line-height: 109%;text-align: left;">Note that the x, y, width, and height in this example are normalized using the full width and height of the image.</p><p class="s180" style="padding-top: 3pt;padding-left: 4pt;text-indent: 0pt;line-height: 109%;text-align: left;">PASCAL VOC format, on the other hand, is XML based. Similar to the YOLO format, we use one XML file per image (ideally with the same name). You can view the sample format on the Git repository at <i>code/chapter- 14/pascal-voc-sample.xml</i>.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s132" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: justify;"><a href="https://oreil.ly/jH31E" class="s192" target="_blank">First, download the application from </a>GitHub <span style=" color: #000;">to a directory on your computer. This directory will have an executable and a data directory containing some sample data. Because we will be using our own custom data, we don’t need the data within the provided data directory. You can start the application by double-clicking the executable file.</span></p><p class="s132" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1612" class="s192">At this point, we should have a collection of images that is ready to be used during the training process. We first divide our data randomly into training and test sets and place them in separate directories. We can do this split by simply dragging and dropping the images randomly into either directory. After the train and test directories are created, we load the training directory by clicking Open Dir, as shown in </a>Figure 14-16<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 77pt;text-indent: 0pt;text-align: left;"><span><img width="396" height="250" alt="image" src="KerasTensorFlow2019/Image_913.jpg"/></span></p><p class="s178" style="padding-top: 7pt;padding-left: 45pt;text-indent: 0pt;text-align: left;"><a name="bookmark1612">Figure 14-16. Click the Open Dir button and then select the directory that contains the training data</a></p><p class="s132" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1613" class="s192">After LabelImg loads the training directory, we can start our labeling process. We must go through each image and manually draw bounding boxes for each object (only cats in our case), as shown in </a>Figure 14-17<span style=" color: #000;">. After we make the bounding box, we are prompted to provide a label to accompany the bounding box. For this exercise, enter the name of the object, “cat”. After a label is entered, we need only to select the checkbox to specify that label again for subsequent images. For images with multiple objects, we would make multiple bounding boxes and add their corresponding labels. If there are different kinds of objects, we simply add a new label for that object class.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 77pt;text-indent: 0pt;text-align: left;"><span><img width="406" height="259" alt="image" src="KerasTensorFlow2019/Image_914.jpg"/></span></p><p class="s178" style="padding-top: 2pt;padding-left: 24pt;text-indent: 0pt;text-align: left;"><a name="bookmark1613">Figure 14-17. Select the Create RectBox from the panel on the left to make a bounding box that covers the cat</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 111%;text-align: left;">Now, repeat this step for all of the training and test images. We want to obtain tight bounding boxes for each object, such that all parts of the object are bounded by the box. Finally, in the train and test directories, we see <i>.xml </i><a href="#bookmark1614" class="s192">files accompanying each image file, as depicted in </a><span style=" color: #8E0012;">Figure 14-18</span>. We can open the .<span class="s113">xml </span>file in a text editor and inspect metadata such as image file name, bounding box coordinates, and label name.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 77pt;text-indent: 0pt;text-align: left;"><span><img width="398" height="282" alt="image" src="KerasTensorFlow2019/Image_915.jpg"/></span></p><p class="s178" style="padding-top: 7pt;padding-left: 206pt;text-indent: -189pt;line-height: 109%;text-align: left;"><a name="bookmark1614">Figure 14-18. Each image is accompanied by an XML file that contains the label information and the bounding box information</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="592" height="495" alt="image" src="KerasTensorFlow2019/Image_916.png"/></span></p><p class="s180" style="padding-top: 5pt;padding-left: 13pt;text-indent: 0pt;line-height: 109%;text-align: justify;"><a href="#bookmark58" style=" color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8pt;">In </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8pt;">Chapter 1</span>, we mentioned that during the development of the MS COCO dataset, it took roughly three seconds to label the name of each object in an image, approximately 30 seconds to place a bounding box around each object, and 79 seconds to draw the outlines for each object.</p><p class="s180" style="padding-top: 3pt;padding-left: 13pt;text-indent: 0pt;line-height: 109%;text-align: left;">Labeling for detection can take about 10x the time as labeling for classification. Doing this on a large scale while maintaining high quality can get really expensive, really quickly. What’s the expensive part here? Drawing the bounding boxes manually. What is something cheaper than drawing them? Verifying the correctness of already drawn boxes. And that’s what we want to maximize.</p><p class="s180" style="padding-top: 3pt;padding-left: 13pt;text-indent: 0pt;line-height: 109%;text-align: left;">Rather than labeling large quantities of data manually, we’d go through an iterative semiautomated process of labeling. In this approach you’d do the following:</p><ol id="l49"><li><p class="s180" style="padding-top: 3pt;padding-left: 35pt;text-indent: -9pt;text-align: left;">Pick a small fraction of images from the pool of data.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s180" style="padding-left: 35pt;text-indent: -9pt;text-align: left;">Manually label it with the object class and bounding box information.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s180" style="padding-left: 35pt;text-indent: -9pt;text-align: left;">Train a model with the labeled data.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s180" style="padding-left: 35pt;text-indent: -9pt;text-align: left;">Make predictions on the remaining unlabeled data using this model.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s180" style="padding-left: 35pt;text-indent: -9pt;text-align: left;">If a prediction confidence is higher than a set threshold, assign that as the label.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s180" style="padding-left: 35pt;text-indent: -9pt;text-align: left;">Pick a sample of the remaining predictions under this threshold.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s180" style="padding-left: 35pt;text-indent: -9pt;line-height: 109%;text-align: left;">In this sample, verify the predictions for correctness. If a prediction is incorrect, manually fix it. In practice, this usually means moving the bounding box slightly, which is much quicker than drawing the full bounding boxes.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s180" style="padding-left: 35pt;text-indent: -9pt;text-align: left;">Add the images from the manually reviewed sample to the training dataset.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s180" style="padding-left: 35pt;text-indent: -9pt;text-align: left;">Repeat the process until the model achieves acceptable performance on a separate validation set.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s180" style="padding-left: 13pt;text-indent: 0pt;line-height: 109%;text-align: left;">In the first few iterations of this process, you might have a barely functioning model. But that’s okay. By using this human-in-the-loop approach, we are constantly teaching it what it’s bad at. Pretty soon, our model will become confident enough to automatically label a majority of the data, cutting down on the large costs of manually labeling large amounts of data.</p><p class="s180" style="padding-top: 3pt;padding-left: 13pt;text-indent: 0pt;line-height: 109%;text-align: left;">This approach is one way of using the technique known as <i>active learning</i>. Famous labeling companies like Figure Eight use this heavily to reduce labeling costs and increase efficiency so that a large majority of time is eventually spent on verification.</p><p class="s40" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1527">Preprocessing the Data</a><a name="bookmark1615">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1616">At this point, we have handy XML data that gives the bounding boxes for all of our objects. However, for us to use TensorFlow for training on the data, we must preprocess it into a format that TensorFlow understands, namely TFRecords. Before we can convert our data into TFRecords, we must go through the intermediate step of consolidating the data from all the XML files into a single comma-separated values (CSV) file. TensorFlow provides helper scripts that assist us with these operations.</a></p><p class="s133" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Now that we have our environment set up, it’s time to begin doing some real work:</p><ol id="l50"><li><p class="s133" style="padding-top: 4pt;padding-left: 40pt;text-indent: -11pt;text-align: left;">Convert our cats dataset directory to a single CSV file using the <span class="s113">xml_to_csv </span>tool from the<a href="https://oreil.ly/k8QGl" class="s131" target="_blank"> </a><span style=" color: #8E0012;">racoon_dataset </span>repository by Dat Tran. We have provided a slightly edited copy of this file in our repository at <i>code/chapter-14/xml_to_csv.py</i>:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 50pt;text-indent: 0pt;text-align: left;">$ python xml_to_csv.py -i {path to cats training dataset} -o {path to output train_labels.csv}</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s133" style="padding-top: 4pt;padding-left: 40pt;text-indent: -11pt;text-align: left;">Do the same for the test data:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 50pt;text-indent: 0pt;text-align: left;">$ python xml_to_csv.py -i {path to cats test dataset} -o {path to test_labels.csv}</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s133" style="padding-top: 4pt;padding-left: 40pt;text-indent: -11pt;text-align: left;">Make the <i>label_map.pbtxt </i>file. This file contains the label and identifier mappings for all of our classes. We use this file to convert our text label into an integer identifier, which is what TFRecord expects. Because we have only one class, the file is rather small and looks as follows:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 50pt;text-indent: 0pt;text-align: left;">item {</p><p class="s188" style="padding-left: 66pt;text-indent: 0pt;text-align: left;">id: 1</p><p class="s188" style="padding-left: 66pt;text-indent: 0pt;text-align: left;">name: &#39;cat&#39;</p><p class="s188" style="padding-left: 50pt;text-indent: 0pt;text-align: left;">}</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s133" style="padding-top: 4pt;padding-left: 40pt;text-indent: -11pt;text-align: left;"><a href="https://oreil.ly/VNwwE" class="s192" target="_blank">Generate the TFRecord format files that will contain the data to be used for training and testing our model later on. This file is also from the </a><span style=" color: #8E0012;">racoon_dataset </span>repository by Dat Tran. We have provided a slightly edited copy of this file in our repository at <i>code/chapter- 14/generate_tfrecord.py</i>. (It’s worth noting that the <span class="s113">image_dir </span>path in the argument should be the same as the path in the XML files; LabelImg uses absolute paths.)</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 50pt;text-indent: 0pt;text-align: left;">$ python generate_tfrecord.py \</p><p class="s188" style="padding-left: 50pt;text-indent: 0pt;text-align: left;">--csv_input={path to train_labels.csv} \</p><p class="s188" style="padding-left: 50pt;text-indent: 0pt;text-align: left;">--output_path={path to train.tfrecord} \</p><p class="s188" style="padding-left: 50pt;text-indent: 0pt;text-align: left;">--image_dir={path to cat training dataset}</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 50pt;text-indent: 0pt;text-align: left;">$ python generate_tfrecord.py \</p><p class="s188" style="padding-left: 50pt;text-indent: 0pt;text-align: left;">--csv_input={path to test_labels.csv} \</p><p class="s188" style="padding-left: 50pt;text-indent: 0pt;text-align: left;">--output_path={path to test.tfrecord} \</p><p class="s188" style="padding-left: 50pt;text-indent: 0pt;text-align: left;">--image_dir={path to cat test dataset}</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1617">With our </a><i>train.tfrecord </i>and <i>test.tfrecord </i>files ready, we can now begin our training process.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s181" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1528">Inspecting the Model</a><a name="bookmark1618">&zwnj;</a></p><p class="s132" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1620" class="s192">(This section is informational only and is not necessary for the training process. You can skip ahead to </a>“Training” <span style=" color: #000;">if you want to.)</span></p><p class="s133" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1619">We can inspect our model using the </a><span class="s113">saved_model_cli </span>tool:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">$ saved_model_cli show --dir ssd_mobilenet_v2_coco_2O18_O3_29/saved_model \</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">--tag_set serve \</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">--signature_def serving_default</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">The output of that script looks like the following:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 23pt;text-indent: -8pt;text-align: left;">The given SavedModel SignatureDef contains the following input(s): inputs[&#39;inputs&#39;] tensor_info:</p><p class="s188" style="padding-left: 39pt;text-indent: 0pt;text-align: left;">dtype: DT_UINT8</p><p class="s188" style="padding-left: 39pt;text-indent: 0pt;text-align: left;">shape: (-1, -1, -1, 3)</p><p class="s188" style="padding-left: 39pt;text-indent: 0pt;text-align: left;">name: image_tensor:O</p><p class="s188" style="padding-left: 23pt;text-indent: -8pt;text-align: left;">The given SavedModel SignatureDef contains the following output(s): outputs[&#39;detection_boxes&#39;] tensor_info:</p><p class="s188" style="padding-left: 39pt;text-indent: 0pt;text-align: left;">dtype: DT_FLOAT shape: (-1, 1OO, 4)</p><p class="s188" style="padding-left: 23pt;text-indent: 16pt;text-align: left;">name: detection_boxes:O outputs[&#39;detection_classes&#39;] tensor_info:</p><p class="s188" style="padding-left: 39pt;text-indent: 0pt;text-align: left;">dtype: DT_FLOAT shape: (-1, 1OO)</p><p class="s188" style="padding-left: 23pt;text-indent: 16pt;text-align: left;">name: detection_classes:O outputs[&#39;detection_scores&#39;] tensor_info:</p><p class="s188" style="padding-left: 39pt;text-indent: 0pt;text-align: left;">dtype: DT_FLOAT shape: (-1, 1OO)</p><p class="s188" style="padding-left: 23pt;text-indent: 16pt;text-align: left;">name: detection_scores:O outputs[&#39;num_detections&#39;] tensor_info:</p><p class="s188" style="padding-left: 39pt;text-indent: 0pt;text-align: left;">dtype: DT_FLOAT shape: (-1)</p><p class="s188" style="padding-left: 23pt;text-indent: 16pt;text-align: left;">name: num_detections:O outputs[&#39;raw_detection_boxes&#39;] tensor_info:</p><p class="s188" style="padding-left: 39pt;text-indent: 0pt;text-align: left;">dtype: DT_FLOAT shape: (-1, -1, 4)</p><p class="s188" style="padding-left: 23pt;text-indent: 16pt;text-align: left;">name: raw_detection_boxes:O outputs[&#39;raw_detection_scores&#39;] tensor_info:</p><p class="s188" style="padding-left: 39pt;text-indent: 0pt;text-align: left;">dtype: DT_FLOAT shape: (-1, -1, 2)</p><p class="s188" style="padding-left: 39pt;text-indent: 0pt;text-align: left;">name: raw_detection_scores:O</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">Method name is: tensorflow/serving/predict</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">The following is how we can interpret the output from the previous command:</p><ol id="l51"><li><p class="s133" style="padding-top: 4pt;padding-left: 40pt;text-indent: -11pt;text-align: left;">The shape of <span class="s113">inputs </span>being <span class="s113">(-1, -1, -1, 3) </span>indicates that the trained model can accept any arbitrarily sized image input that contains three channels. Due to this inherent flexibility in input size, the converted model would be larger than if the model had a fixed-size input. When we train our own object detector later in this chapter, we will be fixing the input size to 800 x 600 pixels to make the resulting model more compact.</p></li><li><p class="s133" style="padding-top: 9pt;padding-left: 40pt;text-indent: -11pt;text-align: left;">Moving on to the outputs, the very first output is <span class="s113">detection_boxes (-1, 1OO, 4)</span>. This tells us how many detection boxes are possible, and what will they look like. In particular, the very first number (i.e., -1) indicates that we can have any number of boxes based on the detections for all 100 classes (second number) with four coordinates (third number) — x, y, width, and height — defining each box. In other words, we are not limiting the number of detections for each of the 100 classes.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s133" style="padding-left: 40pt;text-indent: -11pt;text-align: left;">For <span class="s113">detection_classes</span>, we have a list of two elements: the first defining how many objects we detected, and the second, a one-hot encoded vector with the detected class enabled.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s113" style="padding-left: 40pt;text-indent: -11pt;text-align: left;">num_detections <span class="s133">is the number of objects detected in the image. It is a single floating point.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s113" style="padding-left: 40pt;text-indent: -11pt;text-align: left;">raw_detection_boxes <span class="s133">defines the coordinates of each box that was detected for each object. All of these detections are before the application of NMS on all the detections.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s113" style="padding-left: 40pt;text-indent: -11pt;text-align: left;">raw_detection_scores <span class="s133">is a list of two floating-point numbers, the first describing the total number of detections, and the second giving the total number of categories including the background if it is considered a separate category.</span></p><p class="s40" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1529">Training</a><a name="bookmark1620">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 112%;text-align: left;">Because we are using SSD MobileNetV2, we will need to create a copy of the <i>pipeline.config </i>file (from the TensorFlow repository) and modify it based on our configuration parameters. First, make a copy of the configuration file and search for the string <span class="s113">PATH_TO_BE_CONFIGURED </span>within the file. This parameter indicates all of the places that need to be updated with the correct paths (absolute paths preferably) within our filesystem. We will also want to edit some parameters in the configuration file, such as number of classes (<span class="s113">num_classes</span>), number of steps (<span class="s113">num_steps</span>), number of validation samples (<span class="s113">num_examples</span>), and path of label mappings for both the train and test/eval sections. (You’ll find our version of the <i>pipeline.config </i><a href="http://practicaldeeplearning.ai/" class="s192" target="_blank">file on the book’s GitHub website (see </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 10pt;">http://PracticalDeepLearning.ai</span>).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">$ cp object_detection/samples/configs/ssd_mobilenet_v2_coco.config</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">./pipeline.config</p><p style="text-indent: 0pt;text-align: left;"><span><img width="552" height="144" alt="image" src="KerasTensorFlow2019/Image_917.png"/></span></p><p class="s179" style="padding-top: 7pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s180" style="padding-top: 4pt;padding-left: 4pt;text-indent: 0pt;line-height: 109%;text-align: left;">In our example, we’re using the SSD MobileNetV2 model to train our object detector. Under different conditions, you might want to choose a different model on which to base your training. Because each model comes with its own pipeline configuration file, you’d be modifying that configuration file, instead. The configuration file comes bundled with each model. You’d use a similar process in which you’d identify the paths that need to be changed and update them using a text editor accordingly.</p><p class="s180" style="padding-top: 3pt;padding-left: 4pt;text-indent: 0pt;line-height: 109%;text-align: left;">In addition to modifying paths, you might want to modify other parameters within the configuration file such as image size, number of classes, optimizer, learning rate, and number of epochs.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">$ vim pipeline.config</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">So far, we’ve been at the <i>models/research </i>directory within the TensorFlow repository. Let’s now move into the <i>object_detection </i>directory and run the <i>model_main.py </i>script from TensorFlow, which trains our model based on the configuration provided by the <i>pipeline.config </i>file that we just edited:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">$ cd object_detection/</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">$ python model_main.py \</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">--pipeline_config_path=../pipeline.config \</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">--logtostderr \</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">--model_dir=training/</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">We’ll know the training is happening correctly when we see lines of output that look like the following:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">Average Precision (AP) @[ IoU=O.5O:O.95 | area=all | maxDets=1OO ] = O.76O</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">Depending on the number of iterations that we are training for, the training will take from a few minutes to a couple of hours, so plan to have a snack, do the laundry, clean the litter box, or better yet, read the chapter ahead. After the training is complete, we should see the latest checkpoint file in the training/ directory. The following files are also created as a result of the training process:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">$ ls training/</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">checkpoint model.ckpt-1396O.meta</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">eval_O model.ckpt-16747.data-OOOOO-of-OOOO1 events.out.tfevents.155468433O.computername model.ckpt-16747.index events.out.tfevents.1554684359.computername model.ckpt-16747.meta</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">export model.ckpt-19526.data-OOOOO-of-OOOO1</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">graph.pbtxt model.ckpt-19526.index</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">label_map.pbtxt model.ckpt-19526.meta</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">model.ckpt-1118O.data-OOOOO-of-OOOO1 model.ckpt-2OOOO.data-OOOOO-of-OOOO1 model.ckpt-1118O.index model.ckpt-2OOOO.index</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">model.ckpt-1118O.meta model.ckpt-2OOOO.meta model.ckpt-1396O.data-OOOOO-of-OOOO1 pipeline.config model.ckpt-1396O.index</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">We convert the latest checkpoint file to the <i>.TFLite </i>format in the next section.</p><p class="s179" style="padding-top: 7pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s180" style="padding-top: 4pt;padding-left: 4pt;text-indent: 0pt;line-height: 109%;text-align: left;">Sometimes, you might want to do a deeper inspection of your model for debugging, optimization, and/or informational purposes. Think of it like a DVD extra of a behind-the-scenes shot of your favorite TV show. You would run the following command along with arguments pointing to the checkpoint file, the configuration file, and the input type to view all the different parameters, the model analysis report, and other golden nuggets of information:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s193" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">$ python export_inference_graph.py \</p><p class="s193" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">--input_type=image_tensor \</p><p class="s193" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">--pipeline_config_path=training/pipeline.config \</p><p class="s193" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">--output_directory=inference_graph \</p><p class="s193" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">--trained_checkpoint_prefix=training/model.ckpt-2OOOO</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s180" style="padding-top: 4pt;padding-left: 4pt;text-indent: 0pt;text-align: left;">The output from the this command looks like the following:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s193" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">=========================Options=========================</p><p class="s193" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">-max_depth 1OOOO</p><p class="s193" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">-step -1</p><p class="s193" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s193" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">==================Model Analysis Report==================</p><p class="s193" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">...</p><p class="s193" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">Doc:</p><p class="s193" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">scope: The nodes in the model graph are organized by their names, which is hierarchical like filesystem. param: Number of parameters (in the Variable).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s193" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">Profile:</p><p class="s193" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">node name | # parameters</p><p class="s193" style="padding-left: 17pt;text-indent: -3pt;text-align: left;">_TFProfRoot (--/3.72m params) BoxPredictor_O (--/93.33k params)</p><p class="s193" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">BoxPredictor_O/BoxEncodingPredictor (--/62.22k params)</p><p class="s193" style="padding-left: 35pt;text-indent: 0pt;text-align: left;">BoxPredictor_O/BoxEncodingPredictor/biases (12, 12/12 params)</p><p class="s193" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">...</p><p class="s193" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">FeatureExtractor (--/2.84m params)</p><p class="s193" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s180" style="padding-top: 4pt;padding-left: 4pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1621">This report helps you to learn how many parameters you have, which could in turn help you in finding opportunities for model optimization.</a></p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="552" height="480" alt="image" src="KerasTensorFlow2019/Image_918.png"/></span></p><p class="s40" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1530">Model Conversion</a><a name="bookmark1622">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 113%;text-align: left;"><a name="bookmark1623">Now that we have the latest checkpoint file (the suffix should match the number of epochs in the </a><i>pipeline.config </i>file), we will feed it into the <span class="s113">export_tflite_ssd_graph </span>script like we did earlier in the chapter with our pretrained model:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">$ python export_tflite_ssd_graph.py \</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">--pipeline_config_path=training/pipeline.config \</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">--trained_checkpoint_prefix=training/model.ckpt-2OOOO \</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">--output_directory=tflite_model \</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">--add_postprocessing_op=true</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">If the preceding script execution was successful, we’ll see the following files in the <i>tflite_model</i></p><p class="s133" style="padding-top: 1pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">directory:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">$ ls tflite_model tflite_graph.pb tflite_graph.pbtxt</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">We have one last step remaining: convert the frozen graph files to the <i>.TFLite </i>format. We can do that using the <span class="s113">tflite_convert </span>tool:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">$ tflite_convert --graph_def_file=tflite_model/tflite_graph.pb \</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">--output_file=tflite_model/cats.tflite \</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">--input_arrays=normalized_input_image_tensor \</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">--output_arrays=&#39;TFLite_Detection_PostProcess&#39;,&#39;TFLite_Detection_PostProcess:1&#39;,&#39;TFLi te_Detection_PostProcess:2&#39;,&#39;TFLite_Detection_PostProcess:3&#39; \</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">--input_shape=1,8OO,6OO,3 \</p><p class="s188" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">--allow_custom_ops</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">In this command, notice that we’ve used a few different arguments that might not be intuitive at first sight:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_919.png"/></span></p><p class="s133" style="padding-top: 3pt;padding-left: 25pt;text-indent: 0pt;text-align: left;">For <span class="s113">--input_arrays</span>, the argument simply indicates that the images that will be provided during predictions will be normalized <span class="s113">float32 </span>tensors.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_920.png"/></span></p><p class="s133" style="padding-top: 9pt;padding-left: 25pt;text-indent: 0pt;text-align: left;">The arguments supplied to <span class="s113">--output_arrays </span>indicate that there will be four different types of information in each prediction: the number of bounding boxes, detection scores, detection classes, and the coordinates of bounding boxes themselves. This is possible because we used the argument <span class="s113">--add_postprocessing_op=true </span>in the export graph script in the previous step.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="4" alt="image" src="KerasTensorFlow2019/Image_921.png"/></span></p><p class="s133" style="padding-top: 9pt;padding-left: 25pt;text-indent: 0pt;text-align: left;">For <span class="s113">--input_shape</span>, we provide the same dimension values as we did in the <i>pipeline.config </i>file.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="552" height="141" alt="image" src="KerasTensorFlow2019/Image_922.png"/></span></p><p class="s179" style="padding-top: 7pt;padding-left: 181pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s180" style="padding-top: 4pt;padding-left: 4pt;text-indent: 0pt;line-height: 112%;text-align: justify;">In the floating-point MobileNet model, &#39;<span class="s188">normalized_image_tensor</span>&#39; has values between <span class="s188">[-1,1)</span>. This typically means mapping each pixel (linearly) to a value between [–1,1]. Input image values between 0 and 255 are scaled by (1/128) and then a value of –1 is added to them to ensure the range is <span class="s188">[-1,1)</span>.</p><p class="s180" style="padding-top: 4pt;padding-left: 4pt;text-indent: 0pt;text-align: justify;">In the quantized MobileNet model, &#39;<span class="s188">normalized_image_tensor</span>&#39; has values between <span class="s188">[O, 255]</span>.</p><p class="s180" style="padding-top: 5pt;padding-left: 4pt;text-indent: 0pt;line-height: 115%;text-align: left;">In general, see the <span class="s188">preprocess </span>function defined in the feature extractor class in the TensorFlow Models repository at <i>models/research/object_detection/models </i>directory.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s133" style="padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">The rest are fairly trivial. We should now have a spanking new <i>cats.tflite </i>model file within our <i>tflite_model/ </i>directory. It is now ready to be plugged into an Android, iOS, or edge device to do live detection of cats. This model is well on its way to saving Bob’s garden!</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s181" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1531">Image Segmentation</a><a name="bookmark1624">&zwnj;</a></p><p class="s132" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1626" class="s192" name="bookmark1625">Taking a step further beyond object detection, to get more precise locations of objects, we can perform object segmentation. As we saw earlier in this chapter, this involves making category predictions for each pixel in an image frame. Architectures such as U-Net, Mask R-CNN, and DeepLabV3+ are commonly used to perform segmentation tasks. Similar to object detection, there has been a growing trend of running segmentation networks in real time, including on resource- constrained devices such as smartphones. Being real time opens up many consumer app scenarios like face filters (</a>Figure 14-19<a href="#bookmark1627" class="s192">), and industrial scenarios such as detecting drivable roads for autonomous cars (</a>Figure 14-20<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 77pt;text-indent: 0pt;text-align: left;"><span><img width="403" height="134" alt="image" src="KerasTensorFlow2019/Image_923.jpg"/></span></p><p class="s178" style="padding-top: 4pt;padding-left: 38pt;text-indent: 0pt;text-align: left;"><a name="bookmark1626">Figure 14-19. Colorizing hair with ModiFace app by accurately mapping the pixels belonging to the hair</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 87pt;text-indent: 0pt;text-align: left;"><span><img width="383" height="121" alt="image" src="KerasTensorFlow2019/Image_924.jpg"/></span></p><p class="s178" style="padding-top: 6pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1627">Figure 14-20. Image segmentation performed on frames from a dashcam (CamVid dataset)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s133" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s192" target="_blank">As you might have grown accustomed to hearing in this book by now, you can accomplish much of this without needing much code. Labeling tools like Supervisely, LabelBox, and Diffgram can help not just label the data, but also load previously annotated data and train further on a pretrained object segmentation model. Moreover, these tools provide AI-assisted labeling, which can dramatically speed up (~10 times) the otherwise laborious and expensive labeling process. If this sounds exciting, you are in luck! We have included a bonus resource guide on how to learn and build segmentation projects on the book’s GitHub website (see </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 10pt;">http://PracticalDeepLearning.ai</span>).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s181" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1532">Case Studies</a><a name="bookmark1628">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1629">Let’s now look at how object detection is being used to power real-world applications in the industry.</a></p><p class="s40" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1533">Smart Refrigerator</a><a name="bookmark1630">&zwnj;</a></p><p class="s132" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1632" class="s192" name="bookmark1631">Smart fridges have been gaining popularity for the past few years because they have started to become more affordable. People seem to like the convenience of knowing what’s in their fridge even when they are not home to look inside. Microsoft teamed up with Swiss manufacturing giant Liebherr to use deep learning in its new generation SmartDeviceBox refrigerator (</a>Figure 14-21<span style=" color: #000;">). The company used Fast R-CNN to perform object detection within its refrigerators to detect different food items, maintain an inventory, and keep the user abreast of the latest state.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 110pt;text-indent: 0pt;text-align: left;"><span><img width="314" height="419" alt="image" src="KerasTensorFlow2019/Image_925.jpg"/></span></p><p class="s178" style="padding-top: 3pt;padding-left: 27pt;text-indent: 0pt;text-align: left;"><a href="https://oreil.ly/xg0wT" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 8pt;" target="_blank" name="bookmark1632">Figure 14-21. Detected objects along with their classes from the SmartDeviceBox refrigerator (</a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 8pt;">image source</span>)</p><p class="s40" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1534">Crowd Counting</a><a name="bookmark1633">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1634">Counting people is not just something that only cats do while staring out of windows. It’s useful in a lot of situations including managing security and logistics at large sporting events, political gatherings, and other high-traffic areas. Crowd counting, as its name suggests, can be used to count any kind of object including people and animals. Wildlife conservation is an exceptionally challenging problem because of the lack of labeled data and intense data collection strategies.</a></p><p class="s130" style="padding-top: 9pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1535">Wildlife conservation</a></p><p class="s132" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1636" class="s192" name="bookmark1635">Several organizations, including the University of Glasgow, University of Cape Town, Field Museum of Natural History, and Tanzania Wildlife Research Institute, came together to count the largest terrestrial animal migration on earth: 1.3 million blue wildebeest and 250,000 zebra between the Serengeti and the Masaai Mara National Reserve, Kenya (</a>Figure 14-22<span style=" color: #000;">). They employed data labeling through 2,200 volunteer citizen scientists using a platform called Zooniverse and used automated object detection algorithms like YOLO for counting the wildebeest and zebra population. They observed that the count from the volunteers and from the object detection algorithms were within 1% of each other.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 77pt;text-indent: 0pt;text-align: left;"><span><img width="402" height="263" alt="image" src="KerasTensorFlow2019/Image_926.jpg"/></span></p><p class="s178" style="padding-top: 4pt;padding-left: 43pt;text-indent: 0pt;text-align: left;"><a href="https://oreil.ly/hTodA" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 8pt;" target="_blank" name="bookmark1636">Figure 14-22. An aerial photograph of wildebeest taken from a small survey airplane (</a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 8pt;">image source</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s130" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1536">Kumbh Mela</a></p><p class="s132" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1637" class="s192">Another example of dense crowd counting is from Prayagraj, India where approximately 250 million people visit the city once every 12 years for the Kumbh Mela festival (</a>Figure 14-23<span style=" color: #000;">). Crowd control for such large crowds has historically been difficult. In fact, in the year 2013, due to poor crowd management, a stampede broke out tragically resulting in the loss of 42 lives.</span></p><p class="s133" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">In 2019, the local state government contracted with Larsen &amp; Toubro to use AI for a variety of logistical tasks including traffic monitoring, garbage collection, security assessments, and also crowd monitoring. Using more than a thousand CCTV cameras, authorities analyzed crowd density and designed an alerting system based on the density of people in a fixed area. In places of higher density, the monitoring was more intense. It made the Guinness Book of World Records for being the largest crowd management system ever built in the history of humankind!</p><p style="padding-left: 77pt;text-indent: 0pt;text-align: left;"><span><img width="403" height="95" alt="image" src="KerasTensorFlow2019/Image_927.jpg"/></span></p><p class="s178" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a href="https://oreil.ly/OIy7N" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 8pt;" target="_blank" name="bookmark1637">Figure 14-23. The 2013 Kumbh Mela, as captured by an attendee (</a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 8pt;">image source</span>)</p><p class="s40" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1537">Face Detection in Seeing AI</a><a name="bookmark1638">&zwnj;</a></p><p class="s132" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1640" class="s192" name="bookmark1639">Microsoft’s Seeing AI app (for the blind and low-vision community) provides a real-time facial detection feature with which it informs the user of the people in front of the phone’s camera, their relative locations, and their distance from the camera. A typical guidance might sound like “One face in the top-left corner, four feet away.” Additionally, the app uses the facial-detection guidance to perform facial recognition against a known list of faces. If the face is a match, it will announce the name of the person, as well. An example of vocal guidance would be “Elizabeth near top edge, three feet away,” as demonstrated in </a>Figure 14-24<span style=" color: #000;">.</span></p><p class="s132" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark323" class="s192">To identify a person’s location in the camera feed, the system is running on a fast mobile-optimized object detector. A crop of this face is then passed for further processing to age, emotion, hair style, and other recognition algorithms on the cloud from Microsoft’s Cognitive Services. For identifying people in a privacy-friendly way, the app asks the user’s friends and family to take three selfies of their faces and generates a feature representation (embedding) of the face that is stored on the device (rather than storing any images). When a face is detected in the camera live feed in the future, an embedding is calculated and compared with the database of embeddings and associated names. This is based on the concept of one-shot learning, similar to Siamese networks that we saw in </a>Chapter 4<span style=" color: #000;">. Another benefit of not storing images is that the size of the app doesn’t increase drastically even with a large number of faces stored.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 77pt;text-indent: 0pt;text-align: left;"><span><img width="383" height="408" alt="image" src="KerasTensorFlow2019/Image_928.jpg"/></span></p><p class="s178" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1640">Figure 14-24. Face detection feature on Seeing AI</a></p><p class="s40" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1538">Autonomous Cars</a><a name="bookmark1641">&zwnj;</a></p><p class="s133" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1642">Several self-driving car companies including Waymo, Uber, Tesla, Cruise, NVIDIA, and others use object detection, segmentation, and other deep learning techniques for building their self-driving cars. Advanced Driver Assistance Systems (ADAS) such as pedestrian detection, vehicle type identification, and speed limit sign recognition are important components of a self-driving car.</a></p><p class="s133" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1643">For the decision-making involved in self-driving cars, NVIDIA uses specialized networks for different tasks. For example, WaitNet is a neural network used for doing fast, high-level detection of traffic lights, intersections, and traffic signs. In addition to being fast, it is also meant to withstand noise and work reliably in tougher conditions such as rain and snow. The bounding boxes detected by WaitNet are then fed to specialized networks for more detailed classification. For instance, if a traffic light is detected in a frame, it is then fed into LightNet — a network used for detecting traffic light shape (circle versus arrow) and state (red, yellow, green). Additionally, if a traffic sign is detected in a frame, it’s fed into SignNet, a network to classify among a few hundred types of traffic signs from the US and Europe, including stop signs, yield signs, directional information, speed limit information, and more. Cascading output from faster networks to specialized networks helps improve performance and modularize development of different networks.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 77pt;text-indent: 0pt;text-align: left;"><span><img width="403" height="281" alt="image" src="KerasTensorFlow2019/Image_929.jpg"/></span></p><p class="s178" style="padding-top: 4pt;padding-left: 15pt;text-indent: 0pt;text-align: left;"><a href="https://oreil.ly/vcJY6" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 8pt;" target="_blank">Figure 14-25. Detecting traffic lights and signs on a self-driving car using the NVIDIA Drive Platform (</a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 8pt;">image source</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s181" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;"><a name="bookmark1539">Summary</a><a name="bookmark1644">&zwnj;</a></p><p class="s132" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="https://www.twitter.com/PracticalDLBook" class="s192" target="_blank">In this chapter, we explored the types of computer-vision tasks, including how they relate to one another and how they are different from one another. We took a deeper look at object detection, how the pipeline works, and how it evolved over time. We then collected data, labeled it, trained a model (with and without code), and deployed the model to mobile. We next looked at how object detection is being used in the real world by industry, government, and non-governmental organizations (NGOs). And then we took a sneak peek into the world of object segmentation. Object detection is a very powerful tool whose vast potential is still being discovered every day in numerous areas of our lives. What innovative use of object detection can you think of? Share it with us on Twitter </a>@PracticalDLBook<span style=" color: #000;">.</span></p><h2 style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1645">Chapter 15. Becoming a Maker: Exploring Embedded AI at the Edge</a><a name="bookmark1666">&zwnj;</a></h2><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="588" height="1" alt="image" src="KerasTensorFlow2019/Image_930.png"/></span></p><p class="s135" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Contributed by guest author: Sam Sterckval</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1667">You know how to build a great AI application, but you want more. You don’t want to be limited to just running AI software on some computer, you want to bring it out in the real physical world. You want to build devices to make things more interactive, to make life easier, to serve humanity, or perhaps just for the fun of it. Maybe you want to build an interactive painting that smiles at you when you look at it. A camera on your door that makes a loud alarm when an unauthorized person attempts to steal delivered packages. Maybe a robotic arm that sorts recyclables and trash. A device in the woods to prevent wildlife poaching, perhaps? Or a drone that can autonomously survey large areas and identify people in distress during floods. Maybe even a wheelchair that could drive on its own. What you need is a smart electronic device, but how would you build it, what would it cost, how powerful would it be? In this chapter, we begin to address those questions.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We look at how to implement AI on an embedded device — a device that you might use in a “maker” project. Makers are people with a DIY spirit who use their creativity to build something new.</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Often starting as amateur hobbyists, makers are fun-loving problem solvers, roboticists, innovators, and sometimes entrepreneurs.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The aim of this chapter is to spark your ability to select the appropriate device for the task (which means not trying to run a heavy GAN on a tiny CPU or get a quadrillion-core GPU to run a “Not Hotdog” classifier), and set it up for the tests as quickly and easily as possible. We do this by exploring a few of the better- known devices out there, and seeing how we can use them to</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">perform inferencing of our model. And finally, we look at how makers around the world are using AI to build robotic projects.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Let’s take our first step and look at the current landscape of embedded AI devices.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1646">Exploring the Landscape of Embedded AI Devices</a><a name="bookmark1668">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1670" class="s63" name="bookmark1669">In this section, we explore a few well-known embedded AI devices, listed in </a>Table 15-1<span style=" color: #000;">. We talk about their inner workings and the differences between them before we go into testing.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s48" style="padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1670">Raspberry Pi 4</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="50" alt="image" src="KerasTensorFlow2019/Image_931.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Google <span class="s49">A USB accelerator using a custom Google Application-Specific</span></p><p class="s48" style="padding-top: 1pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Coral USB <span class="s49">Integrated Circuit (ASIC)</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s48" style="padding-top: 6pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">Intel Movidius NCS2</p><p class="s43" style="padding-top: 4pt;padding-left: 79pt;text-indent: 0pt;text-align: left;">Table 15-1. Device list</p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="1" alt="image" src="KerasTensorFlow2019/Image_932.png"/></span></p><p class="s48" style="padding-top: 11pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">The most famous single-board computer, as of this writing</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="1" alt="image" src="KerasTensorFlow2019/Image_933.png"/></span></p><p class="s49" style="padding-left: 10pt;text-indent: 0pt;text-align: left;">A USB accelerator using a 16-core Visual Processing Unit (VPU)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s48" style="padding-top: 2pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">NVIDIA</p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="50" alt="image" src="KerasTensorFlow2019/Image_934.png"/></span></p><p class="s49" style="text-indent: 0pt;line-height: 108%;text-align: left;">A single-board computer using the combination of CPU and 50k CLB Field-Programmable Gate Array (FPGA)</p><p style="text-indent: 0pt;text-align: left;"/><p class="s48" style="text-indent: 0pt;line-height: 14pt;text-align: left;">PYNQ-Z2</p><p style="text-indent: 0pt;text-align: left;"/><p class="s48" style="padding-top: 1pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">Jetson Nano</p><p class="s49" style="padding-top: 2pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">A single-board computer using a combination of CPU and 128- core CUDA GPU</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Instead of saying one is better than the other, we want to learn how to choose a setup for a particular project. We don’t typically see a Ferrari during the morning commute. Smaller, more compact cars are more common, and they get the job done just as well, if not better. Similarly, using a powerful $1,000-plus NVIDIA 2080 Ti GPU might be overkill for a battery-powered drone. Following are some questions we should be asking ourselves to understand which of these edge devices would best suit our needs:</p><ol id="l52"><li><p style="padding-top: 5pt;padding-left: 58pt;text-indent: -16pt;text-align: left;">How big is the device (for instance, compared to a coin)?</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 58pt;text-indent: -16pt;text-align: left;">How much does the device cost? Consider whether you’re on a tight budget.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 58pt;text-indent: -16pt;text-align: left;">How fast is the device? Will it process a single FPS or 100 FPS?</p></li><li><p style="padding-top: 3pt;padding-left: 58pt;text-indent: -16pt;text-align: left;">How much power (in watts) does the device typically need? For battery-powered projects, this can be essential.</p></li></ol></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1671" class="s63">With these questions in mind, let’s explore some of the devices in </a>Figure 15-1 <span style=" color: #000;">one by one.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="443" alt="image" src="KerasTensorFlow2019/Image_935.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 15pt;text-indent: 0pt;line-height: 108%;text-align: center;"><a name="bookmark1671">Figure 15-1. Family photo of Embedded AI devices; starting at the top, going clockwise: PYNQ-Z2, Arduino UNO R3, Intel Movidius NCS2, Raspberry Pi 4, Google Coral USB Accelerator, NVIDIA Jetson Nano, and a €1 coin for reference in the middle</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1647">Raspberry Pi</a><a name="bookmark1672">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1674" class="s63" name="bookmark1673">Because we will be talking about embedded devices for makers, let’s begin with the one universally synonymous with electronic projects: the Raspberry Pi (</a>Figure 15-2<span style=" color: #000;">). It’s cheap, it’s easy to build on, and it has a huge community.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="443" alt="image" src="KerasTensorFlow2019/Image_936.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1674">Figure 15-2. Raspberry Pi 4</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="308" height="30" alt="image" src="KerasTensorFlow2019/Image_937.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Price <span class="s49">Starting at $35</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s48" style="padding-top: 10pt;padding-bottom: 4pt;padding-left: 14pt;text-indent: 0pt;text-align: center;">Size                      <span class="s49">85.6 mm x 56.5 mm</span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="308" height="30" alt="image" src="KerasTensorFlow2019/Image_938.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Power rating <span class="s49">15W</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s48" style="padding-top: 2pt;padding-bottom: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">Processing unit  <span class="s49">ARM Cortex-A72 CPU</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">First of all, what is a Raspberry Pi? It’s a “single board computer,” which simply means that all calculations can be performed on a single printed circuit board (PCB). The fourth version of the single-</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">board computer houses a Broadcom SoC (system-on-a-chip) containing (most important) an ARMv8-A72 quad-core CPU, a VideoCore VI 3D unit, and some video decoders and encoders. It comes with a choice of RAM size, up to 4 GB.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">This version is a big step up from the Raspberry Pi 3 in terms of performance, but it does lose a bit of efficiency. This is due to the Raspberry Pi 3 having an ARMv8-A53 core, which is the high- efficiency version, whereas the ARMv8-A72 core (used in version</p></li></ol></li><li><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">is the high-performance version. We can see this reflected in the power supply recommendation, which was 2.5 amps for the Raspberry Pi 3. For the Raspberry Pi 4, this became 3 amps. It is also important to note that the Raspberry Pi 4 has USB 3 ports, where the Raspberry Pi 3 only has USB 2 ports. This will prove to be important information in the future.</p></li></ol><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://oreil.ly/AuEzr" class="s63" target="_blank">On to some machine learning stuff now. However powerful the Raspberry Pi 4 has become, it still mainly consists of four sequential CPU cores (which now support Out of Order [OoO] execution). It has the VideoCore VI, but there is no TensorFlow version available for this architecture as of this writing. Koichi Nakamura from Idein Inc. has built </a>py-videocore<span style=" color: #000;">, a Python library for accessing the Quad Processing Units (QPUs; the GPU-like cores of the Raspberry Pi’s SoC). He has accelerated neural networks with it before, but simple acceleration of TensorFlow isn’t possible yet. C++ libraries for accessing these cores are also available. But as you might suspect, these cores are not that powerful, so even when used to accelerate neural networks, they might not yield the desired results. For the sake of simplicity, we will not go into these libraries, because digging into the algorithms is beyond the scope of this book. And, and as we will see further on, this might not be necessary at all.</span></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In the end, the Raspberry Pi has proven to be an immensely useful piece of hardware for numerous tasks. It is often used for educational purposes, and by makers. You would be surprised how many industries use the Raspberry Pi in industrial environments (there is a thing called the netPi, which is just a Raspberry Pi with a robust enclosure).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1648">Intel Movidius Neural Compute Stick</a><a name="bookmark1675">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1677" class="s63" name="bookmark1676">Let’s now dive straight into one of the reasons the Raspberry Pi is the go-to base for a lot of projects: The Intel Movidius Neural Compute Stick 2 (</a>Figure 15-3<span style=" color: #000;">), the second generation of a USB accelerator created by Intel.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="443" alt="image" src="KerasTensorFlow2019/Image_939.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1677">Figure 15-3. Intel Neural Compute Stick 2</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="276" height="30" alt="image" src="KerasTensorFlow2019/Image_940.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Price <span class="s49">$87.99</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s48" style="padding-top: 10pt;padding-bottom: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">Size                      <span class="s49">72.5 mm x 27 mm</span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="276" height="30" alt="image" src="KerasTensorFlow2019/Image_941.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Power rating <span class="s49">1W</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s48" style="padding-top: 2pt;padding-bottom: 4pt;padding-left: 127pt;text-indent: 0pt;text-align: left;">Processing unit <span class="s49">Myriad X VPU</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">What it does is pretty simple: you give it a neural network and some data, and it does all the calculations necessary for inference. And it’s connected only through USB, so you can just hook it up to</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">your Raspberry Pi, run your inferencing on the USB accelerator, and free up the CPU of your Raspberry Pi to do all the other cool stuff you want it to do.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1678">It is based on the Myriad VPU. The first generation had a Myriad 2 VPU, this one has a Myriad X VPU. The VPU contains 16 SHAVE (Streaming Hybrid Architecture Vector Engine) cores, which are kind of like GPU cores but less tailored to graphics-related operations. It features on-chip RAM, which is especially useful when doing neural network inferencing because these networks tend to create a lot of data while they compute, which then can be stored right next to the core, which reduces access time drastically.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1649">Google Coral USB Accelerator</a><a name="bookmark1679">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1681" class="s63" name="bookmark1680">The Google Coral (</a>Figure 15-4<span style=" color: #000;">), containing the Google Edge TPU, is the second USB accelerator we will discuss. First, a little explanation on why we are looking at two different USB accelerators. The Intel stick, as mentioned, has a number of SHAVE cores, which have multiple available instructions, like GPU cores, and thus act as a processing unit. The Google Edge TPU, on the other hand, is an ASIC (Application Specific Integrated Circuit), which also does some processing, but it serves a single purpose (hence the “Specific” keyword). An ASIC comes with a few properties inherent to the hardware, some of which are really nice, others less so:</span></p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Speed</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;">Because all electronic circuits inside the TPU serve a single purpose, there is no overhead in terms of decoding operations. You pump in input data and weights, and it gives you a result, almost instantly.</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Efficiency</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;">All ASICs serve a single purpose, so no extra energy is required. The performance/watt figure for ASICs is usually the highest in the business.</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Flexibility</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;">An ASIC can do only what it was designed for; in this case, that would be accelerating TensorFlow Lite neural networks. You will need to stick to the Google Edge TPU compiler and 8- bit <i>.tflite </i>models.</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Complexity</p><p style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 107%;text-align: left;">Google is, in essence, a software company and it knows how to make things easy to use. That is exactly what it has done here, as well. The Google Coral is incredibly easy to get started with.</p><p style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">So how does the Google Edge TPU work? Information on the Edge TPU itself has not been shared, but information about the</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://oreil.ly/R5VpP" class="s63" target="_blank">Cloud TPU has, so the assumption is that the Edge TPU works in broadly the same way as the Cloud TPU. It has dedicated hardware to do the multiply-add, activation, and pooling operations. All the transistors on the chip have been connected in such a way that it can take weights and input data, and it will calculate the output in a highly parallel fashion. The single biggest part of the chip (apart from the on-chip memory, that is) is a part that does exactly what it sounds like: the “Matrix Multiply Unit.” It uses a rather clever, though not so new, principle called </a><a href="https://oreil.ly/R5VpP" class="s46" target="_blank">systolic execution</a>. This execution principle helps lower memory bandwidth by storing intermediate results in the processing elements rather than in memory.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="443" alt="image" src="KerasTensorFlow2019/Image_942.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1681">Figure 15-4. Google Coral USB Accelerator</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="278" height="30" alt="image" src="KerasTensorFlow2019/Image_943.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Price <span class="s49">$74.99</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s48" style="padding-top: 10pt;padding-bottom: 4pt;padding-left: 15pt;text-indent: 0pt;text-align: center;">Size                      <span class="s49">65 mm x 30 mm</span></p><p class="s48" style="padding-top: 2pt;padding-bottom: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">Processing unit  <span class="s49">Google Edge TPU</span></p><p style="padding-left: 123pt;text-indent: 0pt;line-height: 10pt;text-align: left;"><span><img width="275" height="13" alt="image" src="KerasTensorFlow2019/Image_944.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">What’s the main difference between the two USB accelerators we’ve discussed? The Google Coral is more powerful, but a (little) less flexible than the Intel Movidius NCS2. That being said, the Coral is far easier to set up and work with, certainly after you have the trained and converted model.</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="165" alt="image" src="KerasTensorFlow2019/Image_945.png"/></span></p><p class="s48" style="padding-left: 3pt;text-indent: 0pt;line-height: 14pt;text-align: left;">Power rating <span class="s49">2.5W</span></p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="278" height="25" alt="image" src="KerasTensorFlow2019/Image_946.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1650">NVIDIA Jetson Nano</a><a name="bookmark1682">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1684" class="s63" name="bookmark1683">On to a different kind of hardware: the NVIDIA Jetson Nano (</a>Figure 15-5<span style=" color: #000;">), a single board AI computer. Kind of like the Raspberry Pi, but with a 128-core CUDA-enabled Maxwell GPU. The addition of the GPU makes it kind of similar to a Raspberry Pi with an Intel NCS2, but where the NCS2 has 16 cores, this Jetson has 128. What more does it contain? A quad-core A57 ARMv8 CPU, which is the predecessor of the ARMv8 A72 in the Raspberry</span></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Pi 4 (it is also a few months older than the Raspberry Pi 4), 4 GB of Low-Power Double Data Rate 4 (LPDDR4) RAM memory, which is, quite conveniently, shared between the CPU and GPU, which allows you to process data on the GPU, without copying it.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="443" alt="image" src="KerasTensorFlow2019/Image_947.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1684">Figure 15-5. NVIDIA Jetson Nano</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="436" height="28" alt="image" src="KerasTensorFlow2019/Image_948.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Price <span class="s49">$99.00</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s48" style="padding-top: 10pt;padding-bottom: 4pt;padding-left: 68pt;text-indent: 0pt;text-align: left;">Size <span class="s49">100 mm x 79 mm</span></p><p style="padding-left: 64pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="431" height="2" alt="image" src="KerasTensorFlow2019/Image_949.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="436" height="30" alt="image" src="KerasTensorFlow2019/Image_950.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Power rating <span class="s49">10W (Can spike higher under high load)</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s48" style="padding-top: 2pt;padding-bottom: 4pt;padding-left: 68pt;text-indent: 0pt;text-align: left;">Processing unit <span class="s49">ARM A57 + 128 core Maxwell GPU</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The thing about this single board computer is that, as said before, these GPU cores are CUDA enabled, so yes, they can run TensorFlow-GPU or any-other-framework, which will make a big difference compared to a Raspberry Pi, especially when you also plan to train networks. Also, it’s dirt cheap for a GPU. At this point in time, the Jetson Nano is yours for $99, and this includes a rather high-performance ARM CPU and a 128-core GPU. In comparison, the Raspberry Pi 4 with 4 GB of memory is around $55, the Coral USB accelerator is around $75, and the Movidius NCS2 is about</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">$90, as well. The latter two are not standalone, and will at least need an additional Raspberry Pi to actually do something, and the Pi has no GPU that can easily accelerate deep learning applications.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">One more note about the Jetson Nano: it can accelerate default TensorFlow 32-bit floating-point operations, but it will get much more efficient when 16-bit floating-point operations are used, and even more efficient if you use its own TensorRT framework. Luckily, the company has a nice little open source library called</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">TensorFlow-TensorRT (TF-TRT) that will accelerate the available operations with TensorRT automatically while allowing TensorFlow to do the rest. This library offers grand speedups of around four times compared to TensorFlow-GPU. With all this in mind, this makes the Jetson Nano easily the most flexible device.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s48" style="padding-left: 115pt;text-indent: 0pt;text-align: center;">FROM THE CREATORS’ DESK</p><p class="s49" style="padding-top: 7pt;padding-left: 11pt;text-indent: 0pt;text-align: left;">By John Welsh and Chitoku Yato, NVIDIA Jetson Nano Team</p><p class="s49" style="padding-top: 6pt;padding-left: 11pt;text-indent: 0pt;line-height: 108%;text-align: left;">It’s exciting to be working on the NVIDIA Jetson platform, which provides the software and hardware capabilities to drive AI-powered robots, drones, Intelligent Video Analytics (IVA) applications, and other autonomous machines that think for themselves. Jetson Nano brings the power of modern AI to a small, easy-to-use platform.</p><p class="s49" style="padding-top: 5pt;padding-left: 11pt;text-indent: 0pt;line-height: 108%;text-align: left;">A few years ago, we had a group of high school interns who were developing summer projects using deep learning at the edge. The projects they came up with were creative, technically impressive, and fun. We were very excited to come out with Jetson Nano, because we felt that these kinds of projects were exactly what Jetson Nano would enable for a larger audience.</p><p class="s49" style="padding-top: 5pt;padding-left: 11pt;text-indent: 0pt;line-height: 108%;text-align: left;">It’s really rewarding to be part of the talented team here at NVIDIA that’s bringing the tools to inspire these communities to get up and running fast with AI. We’re continually amazed by some of the cool projects that makers, developers, and learners are building on Jetson Nano — from DIY robocars to home automation — and it’s just the beginning. Our goal is to make AI more accessible to all.</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="443" alt="image" src="KerasTensorFlow2019/Image_951.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1651">FPGA + PYNQ</a><a name="bookmark1685">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1687" class="s63" name="bookmark1686">Now is the time to fasten your seatbelts, because we are about to take a deep dive into the dark world of electronics. The PYNQ platform (</a>Figure 15-6<span style=" color: #000;">), based on the Xilinx Zynq family of chips is, for the most part, a totally different side of the electronics world compared to the other devices discussed in this topic. If you do a bit of research, you’ll find out it has a dual-core ARM-A9 CPU, at a whopping 667 MHz. The first thing you’ll think is “Are you serious? That is ridiculous compared to the 1.5 GHz quad-core A72 from the Raspberry Pi?!” And you’d be right, the CPU in this thing is, for the most part, absolutely worthless. But it has something else on board — an FPGA.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="443" alt="image" src="KerasTensorFlow2019/Image_952.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1687">Figure 15-6. Xilinx PYNQ-Z2</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="271" height="28" alt="image" src="KerasTensorFlow2019/Image_953.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Price <span class="s49">$119.00</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s48" style="padding-top: 10pt;padding-bottom: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">Size                      <span class="s49">140 mm x 87 mm</span></p><p style="padding-left: 125pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="268" height="2" alt="image" src="KerasTensorFlow2019/Image_954.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="271" height="30" alt="image" src="KerasTensorFlow2019/Image_955.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Power rating <span class="s49">13.8W</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s48" style="padding-top: 2pt;padding-bottom: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">Processing unit  <span class="s49">Xilinx Zynq-7020</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s70" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1652">FPGAs</a></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1688">To understand what an FPGA is, we need to first look at some familiar concepts. Let’s begin with a CPU: a device that knows a list of operations known as the Instruction Set Architecture (ISA). This is a set that defines everything the CPU can do, and usually contains operations such as “Load Word” (a word is typically a number of bits equal to the datapath size of the CPU, usually 32-bit or 64-bit), which will load some value into an internal register of the CPU, and “Add,” which can add up two of the internal registers, and store the result in a third register, for example.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The reason the CPU can do this is because it contains a whole bunch of transistors (look at these as electrical switches if you like) that are hardwired in such a way that the CPU automatically translates the operations and does whatever that operation was intended to do. A software program is just a really long list of these operations, in a precisely thought-out order. A single-core CPU will take in operation per operation and carry them out, at pretty impressive speeds.</p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1689" class="s63">Let’s look at parallelism. Neural networks, as you know, consist of mostly convolutions or linear nodes, which can all be translated to matrix multiplications. If we look at the mathematics behind these operations, we can spot that each output point of a layer can be calculated independently from the other output points, as demonstrated in </a><a href="#bookmark1689" class="s44">Figure </a>15-7<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="590" height="320" alt="image" src="KerasTensorFlow2019/Image_956.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1689">Figure 15-7. Matrix multiplication</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We can now see that all of these operations could actually be done in a parallel fashion. Our single-core CPU won’t be able to do so, because it can do only one operation at a time, but that’s where multicore CPUs come in. A quad-core CPU can do four operations at a time, which means a theoretical speedup of four times. The SHAVE cores in the Intel Movidius NCS2 and the CUDA cores in the Jetson Nano might not be as complex as a CPU core, but they are good enough for these multiplications and additions, and instead of having four of these, the NCS2 has 16, and the Jetson Nano has 128. A bigger GPU like a RTX 2080 Ti even has 4,352 CUDA cores. It’s easy to see now why GPUs are better at performing deep learning tasks compared to CPUs.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Let’s get back to FPGAs. Whereas CPUs and GPUs are huge collections of transistors hardwired to carry out a set of instructions, you can think of an FPGA as that same huge collection of transistors, but not wired. You can choose how they are wired, and rewire them whenever you want, making them reconfigurable. You can wire them to be a CPU. You can also find schematics and projects for which people have wired them to be a GPU. But most interesting here is that they can even be wired to the exact same architecture as your deep learning neural network,</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">which would actually make them a physical implementation of your network. The word “wired” is used intentionally here. Often, you’ll find people talking about this configuration with the word “program,” but this can be confusing. What you’re doing is reconfiguring the actual hardware, unlike a CPU or GPU for which you download a program that the hardware can run.</p><p class="s70" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1653">PYNQ platform</a></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We usually call the “wiring” file for an FPGA a <i>bitstream </i>or a <i>bitmap</i>, because what you flash onto the chip is basically just a map of the connections that should be made. As you can imagine, making these bitstreams is quite a lot more complicated than running a Python script. That’s where PYNQ comes in. Its tagline is “Python productivity for Zynq.” The company installs the PYNQ image that automatically runs a Jupyter Notebook on the ARM inside the chip, and it comes with a few basic bitstreams; however, more bitstreams will likely become available in the future. Within the PYNQ world, these bitstreams are called <i>overlays</i>.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">If you go looking for examples, you’ll quickly find an example called “BNN-PYNQ,” which has a simple VGG-style, six-layer CNN that can run at 3,000-ish FPS on the PYNQ-Z1 and Z2, and close to 10,000 FPS on the ZCU104, which has the Ultrascale+ version of the Zynq chip onboard. These numbers look pretty insane, but take into account that they run on 32x32 pixel images, rather than the usual 224x224 pixel images and that this network is “binarized,” which means it has weights and activations of one bit, instead of the 32-bits of TensorFlow. To have a better comparison of performance, I tried to recreate a similar network in Keras.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;">I built the FP32 model and trained it on the CIFAR-10 dataset. The CIFAR-10 dataset is easily available with Keras using <span class="s47">keras.datasets.cifar1O</span>. The FP32 model reached a roughly 17% error rate, which is, surprisingly, only 2% better than the binary model. Inference speeds are around 132 FPS on an Intel i9 eight- core CPU. There is, to my knowledge, no easy way of using a binary network efficiently and easily on a CPU — you’ll need to dig into some specific Python packages or some C code to get the</p><p class="s45" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://oreil.ly/CijXF" class="s63" target="_blank">most out of the hardware. You could potentially achieve a speedup of three to five times. This would, however, still be far less than a low-end FPGA, and a CPU will usually draw more power in doing so. Of course, everything has a flip side, and for FPGAs that has to be the complexity of the design. Open source frameworks exist, namely the </a>FINN <span style=" color: #000;">framework, backed by Xilinx. Other manufacturers offer additional frameworks, but none of them come close to how easy to use software packages and frameworks like TensorFlow are. Designing a neural network for an FPGA would also involve a lot of electronics knowledge, and thus is beyond the scope of this book.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1654">Arduino</a><a name="bookmark1690">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1693" class="s63" name="bookmark1691">Arduino (</a>Figure 15-8<span style=" color: #000;">) can make your life a lot easier when trying to interact with the real world through sensors and actuators.</span></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1692">AnMicroController Units (MCUs) Arduino is a microcontroller development board built around the 8-bit Advanced Virtual RISC (AVR) ATMega328p microcontroller running at 16 MHz (so yeah, let’s not try to run a decent neural network on that). A microcontroller is something everyone has come into contact with</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">— you can find microcontrollers in almost everything that is slightly electronic, ranging from every screen/TV, to your desktop keyboard, heck bicycle lights may even contain a microcontroller to enable the flashing mode.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">These boards come in a variety of shapes, sizes, and performances, and although the MCU in the Arduino UNO is pretty low performance, more potent MCUs are available. The ARM Cortex-M series is probably the most well known. Recently TensorFlow and uTensor (an extremely lightweight machine learning inference framework aimed at MCUs) joined forces to enable the possibility to run TensorFlow models on these MCUs.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="443" alt="image" src="KerasTensorFlow2019/Image_957.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="388" alt="image" src="KerasTensorFlow2019/Image_958.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s48" style="padding-left: 115pt;text-indent: 0pt;text-align: center;">FROM THE CREATOR’S DESK</p><p style="padding-top: 7pt;padding-left: 11pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="http://shop.oreilly.com/product/0636920254508.do" class="s140" target="_blank">By Pete Warden, technical lead for Mobile and Embedded TensorFlow, author of </a><a href="http://shop.oreilly.com/product/0636920254508.do" class="s52" target="_blank">TinyML</a></p><p class="s49" style="padding-top: 5pt;padding-left: 11pt;text-indent: 0pt;line-height: 108%;text-align: left;">When I joined Google in 2014, I was amazed to find that the “Ok Google” team was using models that were only 13 KB in size, and ran on tiny DSPs (Digital Signal Processors), to spot wake words. They were very experienced and pragmatic engineers, so I knew they weren’t doing this to be fashionable; they’d experimented and this was the best solution they could find. At that time, I was used to models being megabytes in size, so finding out that tiny models could be useful was a revelation, and I couldn’t help wondering what other problems they could be useful for. Since then, I’ve been keen to open up the technology they pioneered to a wider audience so we can discover what some of these applications might be.</p><p class="s49" style="padding-left: 11pt;text-indent: 0pt;line-height: 108%;text-align: left;">This is why we released our first version of TensorFlow Lite for Microcontrollers in early 2019, and it has been amazing to hear from all of the creative engineers building innovative new features, and even entirely new products, using these new capabilities.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1693">Figure 15-8. Arduino UNO R3</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="290" height="30" alt="image" src="KerasTensorFlow2019/Image_959.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Price <span class="s49">Less than $10.00</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s48" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">Size                      <span class="s49">68.6 mm x 53.3 mm</span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="290" height="30" alt="image" src="KerasTensorFlow2019/Image_960.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Power rating <span class="s49">0.3W</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s48" style="padding-top: 2pt;padding-bottom: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">Processing unit  <span class="s49">AVR ATMega328p</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="126" alt="image" src="KerasTensorFlow2019/Image_961.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Using Python’s serial library, you can easily interface with an Arduino using a Universal Asynchronous Receiver/Transmitter (UART) through a USB cable to send commands or data back and forth.</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1694">Although the Arduino UNO is not really useful for performing lots of calculations, it has many other benefits that make it a mandatory part of the workbench of a maker. It’s cheap, it’s simple, it’s reliable, and it has a huge community surrounding it. Most sensors and actuators have some kind of library and shield for Arduino, which makes it a really easy platform to interact with. The AVR architecture is a kind of dated 8-bit modified Harvard architecture, but it’s really easy to learn, especially with the Arduino framework on top of it. The huge community around Arduino obviously brings a lot of tutorials with it, so just look up any Arduino tutorial for your sensor of choice, and you’ll surely find what you need for your project.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1655">A Qualitative Comparison of Embedded AI Devices</a><a name="bookmark1695">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1697" class="s44" name="bookmark1696">Table 15-2</a> <a href="#bookmark1698" class="s63">summarizes the platforms we’ve talked about, and </a>Figure 15-9 <span style=" color: #000;">plots performance versus complexity for each device.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_962.png"/></span></p><p class="s48" style="padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1697">Embedded device</a></p><p class="s43" style="padding-top: 4pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">Table 15-2. Pros and cons of tested platforms</p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="1" alt="image" src="KerasTensorFlow2019/Image_963.png"/></span></p><p class="s48" style="padding-top: 11pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">Pros Cons</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="581" height="1" alt="image" src="KerasTensorFlow2019/Image_964.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s48" style="padding-top: 4pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">Raspberry Pi 4</p><p class="s49" style="padding-top: 4pt;padding-left: 23pt;text-indent: 0pt;text-align: left;">Easy</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="110" alt="image" src="KerasTensorFlow2019/Image_965.png"/></span></p><p class="s49" style="text-indent: 0pt;line-height: 14pt;text-align: left;">Not so powerful</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="text-indent: 0pt;line-height: 14pt;text-align: left;">Supports most platforms</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="text-indent: 0pt;line-height: 108%;text-align: left;">Rather expensive for the speedup</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="text-indent: 0pt;line-height: 14pt;text-align: left;">Easy optimizations</p><p style="text-indent: 0pt;text-align: left;"/><p class="s48" style="text-indent: 0pt;line-height: 108%;text-align: left;">Intel Movidius NCS2</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_966.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_967.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_968.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_969.png"/></span></p><p class="s49" style="padding-left: 23pt;text-indent: 0pt;line-height: 196%;text-align: justify;">Large community Readily available Cheap</p><p class="s49" style="padding-top: 4pt;padding-left: 23pt;text-indent: 0pt;text-align: left;">Lacks computing power</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s48" style="padding-top: 4pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">Google Coral USB</p><p class="s49" style="padding-top: 4pt;padding-left: 23pt;text-indent: 0pt;line-height: 199%;text-align: left;">Easy getting started Huge speedup</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_970.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_971.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_972.png"/></span></p><p class="s49" style="padding-left: 23pt;text-indent: 0pt;line-height: 13pt;text-align: left;">Price versus speedup</p><p class="s49" style="padding-top: 4pt;padding-left: 23pt;text-indent: 0pt;text-align: left;">Supports only <i>.tflite</i></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_973.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_974.png"/></span></p><p class="s49" style="padding-left: 23pt;text-indent: 0pt;line-height: 108%;text-align: left;">Needs eight-bit quantization</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="219" alt="image" src="KerasTensorFlow2019/Image_975.png"/></span></p><p class="s48" style="padding-top: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">NVIDIA</p><p class="s48" style="padding-top: 1pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Jetson Nano</p><p class="s49" style="padding-top: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">All-in-one</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s49" style="padding-left: 10pt;text-indent: 0pt;line-height: 194%;text-align: left;">Training is possible Cheap</p><p class="s49" style="padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">Really easy to achieve decent performance</p><p class="s49" style="padding-top: 12pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">CUDA GPU</p><p class="s49" style="padding-top: 4pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">Performance might still be lacking</p><p class="s49" style="padding-top: 12pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">Advanced optimizations can be complex</p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="1" alt="image" src="KerasTensorFlow2019/Image_976.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_977.png"/></span></p><p class="s48" style="padding-top: 3pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">Embedded device</p><p class="s48" style="padding-top: 3pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Pros Cons</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="581" height="1" alt="image" src="KerasTensorFlow2019/Image_978.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_979.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_980.png"/></span></p><p class="s48" style="padding-top: 4pt;padding-left: 125pt;text-indent: -114pt;line-height: 108%;text-align: left;">PYNQ-Z2 <span class="s49">Potentially huge power efficiency</span></p><p class="s49" style="padding-top: 4pt;padding-left: 23pt;text-indent: 0pt;line-height: 199%;text-align: left;">Massively complex Long design flow</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_981.png"/></span></p><p class="s49" style="padding-top: 12pt;padding-left: 125pt;text-indent: 0pt;text-align: left;">Actual hardware design</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_982.png"/></span></p><p class="s49" style="padding-left: 125pt;text-indent: 0pt;line-height: 108%;text-align: left;">Potentially huge performance</p><p style="text-indent: 0pt;text-align: left;"><span><img width="5" height="5" alt="image" src="KerasTensorFlow2019/Image_983.png"/></span></p><p class="s49" style="padding-top: 12pt;padding-left: 125pt;text-indent: 0pt;line-height: 108%;text-align: left;">Even more versatile than the Jetson Nano</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="581" height="1" alt="image" src="KerasTensorFlow2019/Image_984.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 12pt;text-indent: 0pt;text-align: left;"><span><img width="597" height="411" alt="image" src="KerasTensorFlow2019/Image_985.jpg"/></span></p><p class="s50" style="padding-top: 6pt;padding-left: 181pt;text-indent: -152pt;line-height: 108%;text-align: left;"><a name="bookmark1698">Figure 15-9. Performance versus complexity-to-use (the size of the circle represents price)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In this section, we attempt to test some platforms by performing 250 classifications of the same image using MobileNetV2, with the top platform trained on the ImageNet dataset. We use the same</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;">image every time because this will allow us to eliminate part of the data bottlenecks that can occur in systems that don’t have enough RAM to store all weights and lots of different images.</p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1699" class="s63">Ok, let’s find an image first. Who doesn’t like cats? So, let’s have an image of a beautiful cat (</a>Figure 15-10<span style=" color: #000;">) that is exactly 224 x 224 pixels, that way we don’t need to scale the image.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 144pt;text-indent: 0pt;text-align: left;"><span><img width="224" height="224" alt="image" src="KerasTensorFlow2019/Image_986.jpg"/></span></p><p class="s50" style="padding-top: 7pt;padding-left: 32pt;text-indent: 0pt;text-align: left;"><a name="bookmark1699">Figure 15-10. The image of the cat we will be using for our experiments</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark166" class="s63">It’s always nice to have a benchmark, so let’s run the model on our PC first. </a><span style=" color: #8E0012;">Chapter 2 </span><a href="http://practicaldeeplearning.ai/" class="s63" target="_blank">explains how to do this, so let’s go ahead and write a script that will invoke the prediction 250 times, and measure how long this takes. You can find the full script on the book’s GitHub website (see </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">http://PracticalDeepLearning.ai</span>) at <i>code/chapter-15</i>:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ python3 benchmark.py Using TensorFlow backend. tf version : 1.14.O</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">keras version : 2.2.4</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">input tensor shape : (1, 224, 224, 3) warmup prediction</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">[(&#39;nO2124O75&#39;, &#39;Egyptian_cat&#39;, O.6629321)] starting now...</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">Time[s] : 16.7O4 FPS : 14.968</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">Model saved.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1700">Now that we’ve established our benchmark, it’s time to begin looking at how to run this model on the embedded devices and see whether and how we can take the performance to a useful level.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1656">Hands-On with the Raspberry Pi</a><a name="bookmark1701">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1702">We begin with the most well-known and most basic of the previously discussed devices: the Raspberry Pi (RPi for short).</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We start by installing Raspbian, a Linux variant made especially for the Raspberry Pi. For the sake of brevity, let’s assume that we have a Raspberry Pi with everything installed, updated, connected, and ready. We can go straight to installing TensorFlow on the Pi, which should work using the <span class="s47">pip </span>installer:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="199" alt="image" src="KerasTensorFlow2019/Image_987.png"/></span></p><p class="s51" style="padding-left: 170pt;text-indent: 0pt;line-height: 17pt;text-align: center;">NOTE</p><p class="s49" style="padding-top: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Due to the recent switch to Raspbian Buster, we encountered some problems, which were resolved by using the following <span class="s53">piwheel</span>:</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;line-height: 108%;text-align: left;"><a href="http://www.piwheels.org/simple/tensorflow/tensorflow" class="s129" target="_blank">$ pip3 install https://www.piwheels.org/simple/tensorflow/tensorflow</a></p><p class="s75" style="text-indent: 0pt;line-height: 10pt;text-align: left;">-1.13.1-cp37-none-linux_armv7l.whl</p><p style="text-indent: 0pt;text-align: left;"/><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ pip3 install tensorflow</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;">Installing Keras is straightforward with <span class="s47">pip</span>, but don’t forget to install <span class="s47">libhdf5-dev</span>, which you will need if you want to load weights into a neural network:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ pip3 install keras</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ apt install libhdf5-dev</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Because installing OpenCV, called in code as cv2, on the RPi can be a burden (especially when a recent switch of OS has happened), we can load the image using the PIL instead of OpenCV. This means replacing the import of cv2 with an import for PIL, and changing the code to load the image to use this library:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">#input_image = cv2.imread(input_image_path)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">#input_image = cv2.cvtColor(input_image, cv2.COLOR_BGR2RGB) input_image = PIL.Image.open(input_image_path)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">input_image = np.asarray(input_image)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="106" alt="image" src="KerasTensorFlow2019/Image_988.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Unlike OpenCV, PIL loads images in the RGB format, so a conversion from BGR to RGB is no longer needed.</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">And that’s it! The exact same script should run on your Raspberry Pi now:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ python3 benchmark.py Using TensorFlow backend. tf version : 1.14.O</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">keras version : 2.2.4</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">input tensor shape : (1, 224, 224, 3) warmup prediction</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">[(&#39;nO2124O75&#39;, &#39;Egyptian_cat&#39;, O.6629321)] starting now...</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">Time[s] : 91.O41 FPS : 2.747</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">As you can see, it runs a lot slower, dropping to less than three FPS. Time to think about how we can speed this up.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1389" class="s63">The first thing we could do is have a look at TensorFlow Lite. TensorFlow has, as discussed in </a><span style=" color: #8E0012;">Chapter 13</span>, a converter built in, which lets us easily convert any model to a TensorFlow Lite (<i>.tflite</i>) model.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s63" target="_blank">We proceed by writing a small script, very similar to the original benchmark script, which will just set up everything to use the TensorFlow Lite model and run the 250 predictions. This script is, of course, also available on the book’s GitHub webiste (see </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">http://PracticalDeepLearning.ai</span>).</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Let’s go ahead and run this so that we can evaluate our effort to speed things up.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ python3 benchmark_tflite.py Using TensorFlow backend.</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">input tensor shape : (1, 224, 224, 3) conversion to tflite is done</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">INFO: Initialized TensorFlow Lite runtime. [[(&#39;nO2124O75&#39;, &#39;Egyptian_cat&#39;, O.687698O7)]]</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">starting now (tflite)... Time[ms] : 32.152</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">FPS : 7.775</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="106" alt="image" src="KerasTensorFlow2019/Image_989.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s79" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="https://coral.withgoogle.com/" class="s140" target="_blank">The </a><a href="https://coral.withgoogle.com/" class="s64" target="_blank">Google Coral website</a> <span style=" color: #000;">has 8-bit quantized CPU models available, which you can run using TensorFlow Lite.</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s45" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1703" class="s63">For the Raspberry Pi 4, we observed an increase in speed of three times (see </a>Table 15-3<span style=" color: #000;">). Not bad for a quick try, but we still only achieved 7.8 FPS, which is kind of nice and perfectly fine for a lot of applications. But what if our original plan was to do something on live video, for example? Then this is not enough. Quantizing the model can achieve even more performance, but this will be only a marginal increase given that the CPU in the Raspberry Pi has not been optimized for 8-bit integer operations.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s43" style="padding-left: 187pt;text-indent: -41pt;text-align: left;"><a name="bookmark1703">Table 15-3. Raspberry Pi benchmarks</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:126.618pt" cellspacing="0"><tr style="height:21pt"><td style="width:170pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Setup</p></td><td style="width:32pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">FPS</p></td></tr><tr style="height:21pt"><td style="width:170pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Raspberry Pi 4 (tflite, 8-bit)</p></td><td style="width:32pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">8.6</p></td></tr><tr style="height:21pt"><td style="width:170pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Raspberry Pi 4 (tflite)</p></td><td style="width:32pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">7.8</p></td></tr><tr style="height:21pt"><td style="width:170pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Raspberry Pi 3B+ (tflite, 8-bit)</p></td><td style="width:32pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">4.2</p></td></tr><tr style="height:21pt"><td style="width:170pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Raspberry Pi 4</p></td><td style="width:32pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2.7</p></td></tr><tr style="height:21pt"><td style="width:170pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Raspberry Pi 3B+</p></td><td style="width:32pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2.1</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">So how can we speed things up even more so that they become useful for applications like autonomous racecars or automatic drones? We touched on it before: the USB accelerators.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1657">Speeding Up with the Google Coral USB Accelerator</a><a name="bookmark1704">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1705">That’s right, these accelerators come in quite handy right now. All of our hardware setup can stay exactly the same, we just need to add a little bit here and there. So let’s find out: how do we get the Google Coral USB Accelerator to run on the Raspberry Pi, and will it speed things up?</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://coral.withgoogle.com/" class="s63" target="_blank">First things first. Assuming that we have a USB accelerator on our hands, the first thing we should always do is look for a “Getting Started” guide from the vendor. Check out </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">https://coral.withgoogle.com/</span>, head to <i>Docs&gt;USB Accelerator&gt;Get Started</i>, and you’re rolling in mere minutes.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">As of this writing, the Coral USB Accelerator is not yet fully compatible with the Raspberry Pi 4, but after fiddling around with the <i>install.sh </i><a href="#bookmark1706" class="s63">script, it is pretty easy to get it running. You need to simply add a part to the install script so that it recognizes the Pi 4, as demonstrated in </a><a href="#bookmark1706" class="s44">Figure </a><span style=" color: #8E0012;">15-11</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="596" height="259" alt="image" src="KerasTensorFlow2019/Image_990.jpg"/></span></p><p class="s50" style="padding-top: 6pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1706">Figure 15-11. Google Coral install script changes</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Now the <i>install.sh </i>script will run correctly. Then, we need to rename a <i>.so </i>file, so that it will also work with Python 3.7. To do this, use the Unix copy command:</p><p class="s53" style="padding-top: 4pt;padding-left: 21pt;text-indent: 0pt;text-align: left;">$ sudo cp /usr/local/lib/python3.7/dist- packages/edgetpu/swig/_edgetpu_cpp_wrapper.cpython- 35m-arm-linux-gnueabihf.so</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">/usr/local/lib/python3.7/dist- packages/edgetpu/swig/_edgetpu_cpp_wrapper.cpython- 37m-arm-linux-gnueabihf.so</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">After you do this, everything should work correctly, and the demonstrations from Google should run.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="146" alt="image" src="KerasTensorFlow2019/Image_991.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">NOTE</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="https://oreil.ly/ydoSy" class="s140" target="_blank">If you want to create, train, quantize, and convert your own model for the Edge TPU, this is a bit more work and cannot be done using Keras. You can find information on how to do this on the </a><a href="https://oreil.ly/ydoSy" class="s64" target="_blank">Google Coral website</a><a href="https://oreil.ly/ydoSy" class="s140" target="_blank">.</a></p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Now that we have the Coral running, let’s try to benchmark the same MobileNetV2 model again. But this time, it must be the quantized version of it, because Google’s Edge TPU supports only 8-bit integer operations. Google supplied us with the quantized and converted MobileNetV2 model, ready to use with the Edge TPU. We can download it from the Coral website under <i>Resources &gt; See pre-compiled models &gt; MobileNetV2(ImageNet) &gt; Edge TPU Model</i>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s63" target="_blank">We have a working USB accelerator and a model to run on it. Now, let’s make a new script to test its performance. The file we are about to make is again very similar to the previous one and takes a lot straight from the examples Google supplied with the Coral. And, as always, this file is available for download at GitHub website (see </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">http://PracticalDeepLearning.ai</span>):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ python3 benchmark_edgetpu.py</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">INFO: Initialized TensorFlow Lite runtime. warmup prediction</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">Egyptian cat O.59375</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">starting now (Edge TPU)... Time[s] : 1.O42</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">FPS : 24O.38O</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Yes, that is correct. It did all 250 classifications already! For the Raspberry Pi 4 with USB3, it took only 1.04 seconds, which translates to 240.38 FPS! Now that’s a speedup. As you can expect with these speeds, live video would be no problem at all.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Lots of precompiled models are available, for all kinds of different purposes, so check them out. You might be able to find a model that suits your needs so that you don’t need to go through the flow (or struggle) to create, train, quantize, and convert your own.</p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1707" class="s63">The Raspberry Pi 3 has no USB3 ports, only USB2. We can clearly see in </a>Table 15-4 <span style=" color: #000;">that this creates a data bottleneck for the Coral.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s43" style="padding-left: 138pt;text-indent: 0pt;text-align: center;"><a name="bookmark1707">Table 15-4. Google Coral benchmarks</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 109pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="312" height="1" alt="image" src="KerasTensorFlow2019/Image_992.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">Setup                                              FPS</p><p style="text-indent: 0pt;text-align: left;"><span><img width="316" height="30" alt="image" src="KerasTensorFlow2019/Image_993.png"/></span></p><p class="s49" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Raspberry Pi 4 + Coral (tflite, 8-bit) 240.4</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="316" height="1" alt="image" src="KerasTensorFlow2019/Image_994.png"/></span></p><p class="s49" style="padding-top: 7pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">i7-7700K + Coral (tflite, 8-bit)           352.1</p><p style="text-indent: 0pt;text-align: left;"><span><img width="316" height="30" alt="image" src="KerasTensorFlow2019/Image_995.png"/></span></p><p class="s49" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">RPi3 + Coral (tflite, 8-bit) 75.5</p><p style="text-indent: 0pt;text-align: left;"/><p class="s49" style="padding-top: 29pt;padding-bottom: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">Jetson Nano + Coral (tflite, 8-bit)     223.2</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1658">Port to NVIDIA Jetson Nano</a><a name="bookmark1708">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1709">That USB accelerator is nice, but what if your project needs a real niche model, trained on some crazy, self-made, dataset? As we said earlier, creating a new model for the Coral Edge TPU is quite a bit more work than just creating a Keras model. So, is there an easy way to have a custom model running on the edge with some decent performance? NVIDIA to the rescue! With its Jetson Nano, the company has created a replacement for the Raspberry Pi that has a CUDA enabled, and rather efficient, GPU on board, which lets you accelerate not only TensorFlow, but anything you like.</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="248" alt="image" src="KerasTensorFlow2019/Image_996.png"/></span></p><p class="s51" style="padding-left: 170pt;text-indent: 0pt;line-height: 17pt;text-align: center;">NOTE</p><p class="s49" style="padding-top: 6pt;text-indent: 0pt;line-height: 158%;text-align: left;">Note there is a known issue with <span class="s53">pip3</span>: “<span class="s53">cannot import name ‘main’</span>”. Here’s the solution:</p><p class="s75" style="padding-top: 12pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">$ sudo apt install nano</p><p class="s75" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">$ sudo nano /usr/bin/pip3</p><p style="text-indent: 0pt;text-align: left;"/><p class="s75" style="text-indent: 0pt;text-align: left;">Replace : main =&gt;<u> </u>main<span class="s195">      </span></p><p class="s75" style="text-indent: 0pt;text-align: left;">Replace : main() =&gt;<u> </u>main<u> </u>._main()</p><p style="text-indent: 0pt;text-align: left;"/><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://oreil.ly/d11bQ" class="s63" target="_blank">Again, we must begin by installing all needed packages. First, you want to download a copy of NVIDIA’s JetPack, which is its version of a Debian-like OS for the Jetson platform. Then, to install TensorFlow and the needed packages, NVIDIA walks us through how to do that </a>here<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="227" alt="image" src="KerasTensorFlow2019/Image_997.png"/></span></p><p class="s51" style="padding-left: 178pt;text-indent: 0pt;line-height: 17pt;text-align: center;">TIP</p><p class="s49" style="padding-top: 4pt;text-indent: 0pt;line-height: 16pt;text-align: left;">Updating all <span class="s53">pip </span>packages can take a long time; if you want to ensure that your Jetson did not freeze, you might want to first install <span class="s53">htop</span>:</p><p style="text-indent: 0pt;text-align: left;"/><p class="s75" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">$ sudo apt install htop</p><p class="s75" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">$ htop</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s49" style="padding-top: 7pt;text-indent: 0pt;line-height: 108%;text-align: left;">This lets you monitor CPU utilization. As long as this is working, your Jetson is, too.</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="213" alt="image" src="KerasTensorFlow2019/Image_998.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">The Jetson Nano tends to run rather hot when compiling, so we recommend using some kind of fan. The development board has a connector, but keep in mind this will feed 5V to the fan, whereas most fans are rated for 12V.</p><p class="s49" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Some 12V fans might do the trick out of the box, some might need a little push to get started. You will need a 40 mm x 40 mm fan. 5V versions are also available.</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Unfortunately, the NVIDIA walkthrough is not as easy as the Google one. Chances are you will go through a bit of a struggle with the occasional table-flip moment.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="219" alt="image" src="KerasTensorFlow2019/Image_999.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;">Installing Keras on the Jetson requires scipy, which requires <span class="s53">libatlas-base-dev </span>and <span class="s53">gfortran</span>, so start by installing the latter, and move to the front:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ sudo apt install libatlas-base-dev gfortran</p><p class="s75" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ sudo pip3 install scipy</p><p class="s75" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ sudo pip3 install keras</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">But hang in there; you’ll get there eventually.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: justify;">After everything is done, we can choose to run the <i>benchmark.py </i>file directly, which will be, because of the GPU, a lot faster than it was on the Raspberry Pi:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ python3 benchmark.py Using TensorFlow backend. tf version : 1.14.O</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">keras version : 2.2.4</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">input tensor shape : (1, 224, 224, 3) warmup prediction</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">[(&#39;nO2124O75&#39;, &#39;Egyptian_cat&#39;, O.6629321)] starting now...</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">Time[s] : 2O.52O FPS : 12.177</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="528" height="126" alt="image" src="KerasTensorFlow2019/Image_1000.png"/></span></p><p class="s51" style="padding-top: 10pt;padding-left: 176pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s49" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">You also can attach the Google Coral to your Jetson Nano, which opens up the possibility to run one model on the Coral, and another one on the GPU simultaneously.</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">This immediately shows the power of the Jetson Nano: it runs almost exactly like any other PC with a GPU. However, 12 FPS is still not huge, so let’s look at how to optimize this.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://practicaldeeplearning.ai/" class="s63" target="_blank">The GPU of the Jetson is actually built specifically for 16-bit- floating point operations, so inherently, this will be the best trade- off between precision and performance. As mentioned earlier, NVIDIA has a package called TF-TRT, which facilitates optimization and conversion. However, it is still a bit more complex than the Coral example (keep in mind that Google supplied us with the precompiled model file for the Coral). You’ll need to freeze the Keras model and then create a TF-TRT inference graph. Doing this can take quite a while if you need to find everything laying around on GitHub, so it’s bundled on this book’s GitHub website (see </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">http://PracticalDeepLearning.ai</span>).</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">You can use the <i>tftrt_helper.py </i>file to optimize your own models for inferencing on the Jetson Nano. All it really does is freeze the Keras model, removes the training nodes, and then use NVIDIA’s</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">TF-TRT Python package (included in TensorFlow Contrib) to optimize the model.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ python3 benchmark_jetson.py FrozenGraph build.</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">TF-TRT model ready to rumble!</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">input tensor shape : (1, 224, 224, 3) [[(&#39;nO2124O75&#39;, &#39;Egyptian_cat&#39;, O.662932O4)]]</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">starting now (Jetson Nano)... Time[s] : 5.124</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">FPS : 48.834</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1710" class="s63">48 FPS, that’s a speedup of four times with just a few lines of code. Exciting, isn’t it? You can achieve similar speedups on your own custom models, tailored to the specific needs of your project; these performance benchmarks can be found in </a><a href="#bookmark1710" class="s44">Table </a>15-5<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s43" style="padding-left: 187pt;text-indent: -66pt;text-align: left;"><a name="bookmark1710">Table 15-5. NVIDIA Jetson Nano benchmarks</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:115.492pt" cellspacing="0"><tr style="height:21pt"><td style="width:186pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Setup</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">FPS</p></td></tr><tr style="height:21pt"><td style="width:186pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Jetson Nano + Coral (tflite, 8-bit)</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">223.2</p></td></tr><tr style="height:21pt"><td style="width:186pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Jetson Nano (TF-TRT, 16-bit)</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">48.8</p></td></tr><tr style="height:21pt"><td style="width:186pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Jetson Nano 128CUDA</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">12.2</p></td></tr><tr style="height:21pt"><td style="width:186pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Jetson Nano (tflite, 8-bit)</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">11.3</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1659">Comparing the Performance of Edge Devices</a><a name="bookmark1711">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1713" class="s44" name="bookmark1712">Table 15-6</a> <span style=" color: #000;">shows a quantitative comparison of several edge devices running the MobileNetV2 model.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s43" style="padding-left: 205pt;text-indent: -77pt;text-align: left;"><a name="bookmark1713">Table 15-6. Full benchmarking results</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:113.266pt" cellspacing="0"><tr style="height:21pt"><td style="width:190pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Setup</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s65" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">FPS</p></td></tr><tr style="height:21pt"><td style="width:190pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">i7-7700K + Coral (tflite, 8-bit)</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">352.1</p></td></tr><tr style="height:21pt"><td style="width:190pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">i7-7700K + GTX1080 2560CUDA</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">304.9</p></td></tr><tr style="height:21pt"><td style="width:190pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Raspberry Pi 4 + Coral</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">240.4</p></td></tr><tr style="height:21pt"><td style="width:190pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Jetson Nano + Coral (tflite, 8-bit)</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">223.2</p></td></tr><tr style="height:21pt"><td style="width:190pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">RPi3 + Coral (tflite, 8-bit)</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">75.5</p></td></tr><tr style="height:21pt"><td style="width:190pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Jetson Nano (TF-TRT, 16-bit)</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">48.8</p></td></tr><tr style="height:21pt"><td style="width:190pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">i7-7700K (tflite, 8-bit)</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">32.4</p></td></tr><tr style="height:21pt"><td style="width:190pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">i9-9880HQ (2019 MacBook Pro)</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">15.0</p></td></tr><tr style="height:21pt"><td style="width:190pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Jetson Nano 128CUDA</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">12.2</p></td></tr><tr style="height:21pt"><td style="width:190pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Jetson Nano (tflite, 8-bit)</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">11.3</p></td></tr><tr style="height:21pt"><td style="width:190pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">i7-4870HQ (2014 MacBook Pro)</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">11.1</p></td></tr><tr style="height:21pt"><td style="width:190pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Jetson Nano (tflite, 8-bit)</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">10.9</p></td></tr><tr style="height:21pt"><td style="width:190pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Raspberry Pi 4 (tflite, 8-bit)</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">8.6</p></td></tr><tr style="height:21pt"><td style="width:190pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Raspberry Pi 4 (tflite)</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">7.8</p></td></tr><tr style="height:21pt"><td style="width:190pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">RPi3B+ (tflite, 8-bit)</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">4.2</p></td></tr><tr style="height:21pt"><td style="width:190pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Raspberry Pi 4</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2.7</p></td></tr><tr style="height:21pt"><td style="width:190pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">RPi3B+</p></td><td style="width:39pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">2.1</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">We can summarize the takeaways from these experiments as follows:</p><ol id="l53"><li><p style="padding-top: 5pt;padding-left: 58pt;text-indent: -16pt;text-align: left;">Good optimizations make a big difference. The world of computing optimization is still growing rapidly, and we will see big things coming up in the next few years.</p></li><li><p style="padding-top: 3pt;padding-left: 58pt;text-indent: -16pt;text-align: justify;">More is always better when talking about computing units for AI.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 58pt;text-indent: -16pt;text-align: left;">ASIC &gt; FPGA &gt; GPU &gt; CPU in terms of performance/watt.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 58pt;text-indent: -16pt;text-align: justify;">TensorFlow Lite is awesome, especially for small CPUs. Keep in mind that it is specifically aimed at small CPUs, and using it for x64 machines will not be that interesting.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1660">Case Studies</a><a name="bookmark1714">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1715">This chapter is about makers. And it would be incomplete without showcasing what they make. Let’s look at a few things that have been created by running AI on the edge.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1661">JetBot</a><a name="bookmark1716">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1718" class="s63" name="bookmark1717">NVIDIA has been at the forefront of the deep learning revolution, enabling researchers and developers with powerful hardware and software. And in 2019, they took the next step to enable makers, too, by releasing the Jetson Nano. We already know the power of this hardware, so now it’s time to build something with it — like a DIY miniature car. Luckily, NVIDIA has us covered with JetBot (</a>Figure 15-12<span style=" color: #000;">), the open source robot that can be controlled by an onboard Jetson Nano.</span></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="https://oreil.ly/3nExK" class="s63" target="_blank">The </a>JetBot wiki <span style=" color: #000;">features beginner-friendly step-by-step instructions on building it. Here’s a high-level look:</span></p><ol id="l54"><li><p style="padding-top: 5pt;padding-left: 58pt;text-indent: -16pt;text-align: left;">Buy the parts specified in the Bill of Materials, like the motor, caster, camera, and WiFi antenna. There are about 30 parts, costing around $150, on top of the $99 Jetson Nano.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s45" style="padding-left: 58pt;text-indent: -16pt;text-align: left;"><a href="#bookmark1718" class="s63">It’s time to channel our inner MacGyver, get a set of pliers and a cross-tip screwdriver, and assemble the parts. The end result should be something resembling </a><a href="#bookmark1718" class="s44">Figure </a>15-12<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 58pt;text-indent: -16pt;text-align: justify;">Next, we’d set up the software. This involves flashing the JetBot image onto an SD card, booting the Jetson Nano, connecting it to WiFi, and finally connecting to our JetBot from a web browser.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p style="padding-left: 58pt;text-indent: -16pt;text-align: left;">Finally, we run through the example notebooks provided. The provided notebooks enable us, through little code, to not only control the bot from a web browser, but also use its camera to collect training data from streaming video, train a deep learning model right on the device (the Jetson Nano is a mini-GPU after all), and use it for tasks such as avoiding obstacles and following objects such as a person or a ball.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="481" alt="image" src="KerasTensorFlow2019/Image_1001.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1718">Figure 15-12. NVIDIA JetBot</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">Makers are already using this base framework to extend the JetBot’s capabilities, such as attaching lidar sensors to it for understanding the environment better, bringing JetBot to different physical forms like tanks, Roomba vacuum cleaners (JetRoomba), object-following spiders (JetSpider), and more. Because all roads eventually lead to racing cars, the Jetson Nano team eventually released a similar open source recipe book for a racing car called JetRacer. It’s based on a faster chassis, higher camera frame rate, and optimizations for inference (with TensorRT) to handle the speed. The end result: JetRacer is already being raced at events like the DIY Robocars meetups.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">The slowest step here is…waiting for the hardware to arrive.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="463" alt="image" src="KerasTensorFlow2019/Image_1002.png"/></span></p><p class="s48" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">FROM THE CREATORS’ DESK</p><p class="s49" style="padding-top: 6pt;padding-left: 18pt;text-indent: 0pt;text-align: left;">By John Welsh and Chitoku Yato, NVIDIA Jetson Nano Team</p><p class="s49" style="padding-top: 7pt;padding-left: 18pt;text-indent: 0pt;line-height: 108%;text-align: left;">We wanted to develop a reference platform to show developers what’s possible with this tiny piece of hardware — the Jetson Nano. While dreaming up the project that would eventually turn into JetBot, we realized its platform requirements matched what we envisioned many makers would need for their next-level AI projects.</p><p class="s49" style="padding-top: 5pt;padding-left: 18pt;text-indent: 0pt;line-height: 108%;text-align: left;">Specifically, JetBot required a platform capable of real-time image processing that worked with an affordable camera and would be easy to interface with maker hardware. As the engineering development of Jetson Nano matured, these boxes were checked. With Jetson Nano as the brain powering JetBot, we felt it would be an excellent platform for makers interested in getting started with AI for a wide range of projects.</p><p class="s49" style="padding-top: 5pt;padding-left: 18pt;text-indent: 0pt;line-height: 108%;text-align: left;">We focused on making JetBot easy to use and educational to inspire developers to start creating with Jetson Nano. Although JetBot is shown in NVIDIA demonstrations across the globe, its vision is much more far- reaching. It’s meant to be an example of what’s possible when makers combine our technology with their creativity and ingenuity. Since JetBot’s release, there have been many different spin-offs, and we hope it’s a great guide to learn, explore, and, most important, have fun with AI.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1662">Squatting for Metro Tickets</a><a name="bookmark1719">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1723" class="s63" name="bookmark1720">When good health can’t motivate people to exercise, what else would? The answer turns out to be…free train tickets! To raise public awareness for its growing obesity crisis, Mexico City installed ticket machines with cameras at subway stations that give free tickets, but only if you exercise. Ten squats get a free ticket (</a>Figure 15-13<span style=" color: #000;">). Moscow, too, implemented a similar system at its metro stations, but apparently, officials there had a much higher fitness standard at 30 squats per person.</span></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1721">Inspired by these, we could foresee how to build our own “squat- tracker.” We could achieve this in multiple ways, the simplest being to train our own classifier with the classes “squatting” and “not squatting.” This would clearly involve building a dataset with thousands of pictures of people either squatting or not squatting.</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1065" class="s63" name="bookmark1722">A much better way to accomplish this would involve running PoseNet (which tracks body joints, as we saw in </a>Chapter 10<span style=" color: #000;">) on, say, Google Coral USB Accelerator. With its 10-plus FPS, we could track how many times the hip points drop low enough and count much more accurately. All we would need is a Raspberry Pi, a Pi Camera, a Coral USB Accelerator, and a public transport operator to provide a ticket printer and endless free tickets, and we could start making our cities fitter than ever.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="589" height="373" alt="image" src="KerasTensorFlow2019/Image_1003.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1723">Figure 15-13. Squatting for tickets</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s15" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1663">Cucumber Sorter</a><a name="bookmark1724">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1725">Makoto Koike, the son of cucumber farmers in Japan, observed that his parents spent a lot of time postharvest sorting through cucumbers. The sorting required separating cucumbers into nine categories based on fine-grained analysis of very small features such as minute texture differences, tiny scratches, and prickles, along with larger attributes such as size, thickness, and curvature. The system was complicated and hiring part-time workers was pretty much a no-go because of how long it would take to train them. He couldn’t sit by idly watching his parents go through the labor-intensive task for more than eight hours every single day.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">One detail we didn’t mention yet is that Mr. Koike was formerly an embedded systems designer at Toyota. He realized that a lot of the visual inspection could be automated using the power of deep learning. He took more than 7,000 pictures of different cucumbers that his mother had manually sorted over a three-month period. He then trained a classifier that could look at a picture of a cucumber and predict with a high degree of accuracy to which category it belonged. But a classifier is not going to do much on its own now, will it?</p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark1726" class="s63">Using his experience in embedded systems, he deployed a classifier to a Raspberry Pi that was connected to a camera, a conveyor-belt system, and a sorting arm that pushed each cucumber into one of the multiple bins based on the predictions from the Raspberry Pi (</a>Figure 15-14<span style=" color: #000;">). The Raspberry Pi ran a small cucumber/not-cucumber classifier as a first pass. For images classified as cucumber, the Raspberry Pi would send the image to a server that ran the more sophisticated multiple category cucumber classifier. Keep in mind that this was in 2015, shortly after TensorFlow was released (long before the days of TensorFlow Lite, MobileNet, and the extra power of the current Raspberry Pi 4 or even 3). With a machine like this, his parents could spend more time in actual farming rather than sorting through already harvested cucumbers for days on end.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;text-align: left;"><span><img width="591" height="443" alt="image" src="KerasTensorFlow2019/Image_1004.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s198" style="padding-top: 4pt;padding-left: 30pt;text-indent: 0pt;text-align: left;"><a href="https://oreil.ly/0cSOp" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12pt;" target="_blank" name="bookmark1726">Figure 15-14. Makoto Koike’s cucumber sorting machine (</a>image source<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1727">Even though the debate on AI taking over jobs appears daily in the news, Mr. Koike’s story truly highlights the real value that AI provides: making humans more productive and augmenting our abilities, along with making his parents proud.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1664">Further Exploration</a><a name="bookmark1728">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1729">There are two equally important aspects to focus on when becoming a maker: the hardware and the software. One is incomplete without the other. There are more DIY projects to explore than one can build in a lifetime. But the key is to find some that you’re passionate about, build them end to end, and feel the excitement when they start to actually function. Gradually, you’ll develop the know-how so that the next time you read a project, you can guess how to build it yourself.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">The best way to get started is to get hands-on and build more and more projects. Some excellent sources for inspiration include <i>Hackster.io</i>, <i>Hackaday.io</i><a href="http://instructables.com/" class="s63" target="_blank">, and </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">Instructables.com</span>, which feature a large range of project themes, platforms, and skill levels (from beginner to advanced), often along with the step-by-step instructions.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">To reduce the overhead of assembling hardware for beginners, there are several kits available in the market. For example, AI Kits for Raspberry Pi including AIY Vision Kit (Google), AIY Speech Kit (Google), GoPiGo (Dexter Industries), and DuckieTown platform (MIT), to name a few. They lower the barriers for getting started with electronic hardware projects, making the new area more approachable and hence usable for everyone, from high schoolers to rapid prototypers.</p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="#bookmark599" class="s63">On the software side of things, running AI faster on low-power devices means making the models more performant. Model compression techniques like quantization and pruning (as mentioned in </a>Chapter 6<span style=" color: #000;">) can help get us there. To go even faster (at some loss in accuracy), BNNs, which represent models in one bit instead of the normal 32 bits, are a potential solution.</span></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a href="http://shop.oreilly.com/product/0636920254508.do" class="s63" target="_blank">Companies like XNOR.ai and Microsoft’s Embedded Learning Library allow us to make such models. For running AI on even lower-power devices like microcontrollers with less than 100 KB of memory, Pete Warden’s book </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">TinyML </span>is an excellent learning resource.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s8" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1665">Summary</a><a name="bookmark1730">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;">In this chapter, we introduced some well-known embedded AI devices and looked at how to run a Keras model on some of them. We presented a high-level view of their inner workings, and how they achieve the computing capacity needed for running neural networks. Eventually benchmarking them to develop an intuition on which might be suitable for our projects depending on size, costs, latency, and power requirements. Going from platforms to robotic projects, we looked at some ways in which makers around the world are using them to build electronic projects. The devices discussed in this chapter are obviously just a handful of those available. New devices will keep popping up as the edge becomes a more desirable place to be for AI.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 111%;text-align: left;"><a name="bookmark1731">With the power of edge AI, makers can imagine and bring their dream projects to reality, which might have been considered science fiction just a few years ago. On your journey in this DIY AI world, remember, you are among a tight-knit community of tinkerers with a lot of openness and willingness to share. The forums are active, so if you ever get stuck on a problem, there are helpful souls to call upon. And hopefully, with your project, you can inspire others to become makers themselves.</a></p><h3 style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;"><a name="bookmark1732">Chapter 16. Simulating a Self- Driving Car Using End-to-End Deep Learning with Keras</a><a name="bookmark1751">&zwnj;</a></h3><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="585" height="1" alt="image" src="KerasTensorFlow2019/Image_1005.png"/></span></p><p class="s135" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Contributed by guest authors: Aditya Sharma and Mitchell Spryn</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1752">From the Batmobile to Knightrider, from robotaxis to autonomous pizza delivery, self-driving cars have captured the imagination of both modern pop culture and the mainstream media. And why wouldn’t they? How often does it happen that a science-fiction concept is brought to life? More important, autonomous cars promise to address some key challenges urban societies are facing today: road accidents, pollution levels, cities becoming increasingly more congested, hours of productivity lost in traffic, and the list goes on.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">It should come as no surprise that a full self-driving system is quite complex to build, and cannot be tackled in one book chapter. Much like an onion, any complex problem contains layers that can be peeled. In our case, we intend to tackle one fundamental problem here: how to steer. Even better, we don’t need a real car to do this. We will be training a neural network to drive our car autonomously within a simulated environment, using realistic physics and visuals.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">But first, a brief bit of history.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 20pt;text-indent: 0pt;text-align: left;"><span><img width="551" height="247" alt="image" src="KerasTensorFlow2019/Image_1006.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="332" alt="image" src="KerasTensorFlow2019/Image_1007.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s48" style="padding-left: 94pt;text-indent: 0pt;text-align: center;">SAE LEVELS OF DRIVING AUTOMATION</p><p class="s49" style="padding-top: 6pt;padding-left: 11pt;text-indent: 0pt;text-align: left;">“Autonomous driving” is a broad term that is often used to describe everything from Adaptive Cruise Control (ACC) technology on your Chrysler 200 to the steering wheel-free cars of the future. To bring some structure around the definition of autonomous driving (or the term more popular in Europe: automated driving), the Society of Automotive Engineers (SAE) International proposed to divide automation capabilities of driving vehicles into six levels, ranging from “No Automation” at Level 0 to “Full Automation” at Level 5.</p><p class="s79" style="padding-left: 11pt;text-indent: 0pt;text-align: left;">Figure 16-1 <span style=" color: #000;">gives an overview of these. These levels are somewhat subject to interpretation, but they give the industry a reference point when talking about autonomous driving. ACC is an example of Level 1 automation, whereas Tesla’s cars fall somewhere between Levels 2 and 3. Although there are many startups, technology companies, and automakers working on Level 4 cars, we haven’t seen any in production yet. It will take us a while before we realize our dream of a truly fully autonomous Level 5 vehicle.</span></p><p style="text-indent: 0pt;text-align: left;"/><p class="s198" style="padding-top: 4pt;padding-left: 49pt;text-indent: 0pt;text-align: left;"><a href="https://oreil.ly/RHKUt" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12pt;" target="_blank" name="bookmark1753">Figure 16-1. The SAE Levels of Driving Automation (</a>image source<span style=" color: #000;">)</span><a name="bookmark1754">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s196" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1733">A Brief History of Autonomous Driving</a><a name="bookmark1755">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark1757" class="s63" name="bookmark1756">Even though it might seem like autonomous driving is a very recent technological development, research in this field originated more than 30 years ago. Scientists at Carnegie Mellon University first tried their hands at this seemingly impossible feat back in 1984 when they started working on what would be known as the Navlab 1. “Navlab” was a shorthand for Carnegie Mellon’s Navigation Laboratory, a not- so-fancy name for what would turn out to be the first step into a very impressive future for humanity. The Navlab 1 was a Chevrolet panel van (</a>Figure 16-2<span style=" color: #000;">) with racks of hardware onboard that included, among other things, workstations for the research team and a Sun Microsystems supercomputer. It was considered cutting edge at the time, a self-contained computing system on wheels. Long-distance wireless communication was pretty much nonexistent back then, and cloud computing was not even a concept. Putting the entire research team in the back of a highly experimental self-driving van might seem like a dangerous idea, but the Navlab had a maximum speed of 20 MPH and navigated on only empty roads. This ensured the safety of the scientists working onboard. What is very impressive to note though, is that the technology used in this car laid the foundation for technology used in the self-driving cars of today. For example, Navlab 1 used video cameras and a rangefinder (an early version of lidar) to observe its surroundings. For navigation, they used a single-layer neural network to predict steering angles given sensor data. Pretty neat isn’t it?</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 107pt;text-indent: 0pt;text-align: left;"><span><img width="320" height="383" alt="image" src="KerasTensorFlow2019/Image_1008.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="197" alt="image" src="KerasTensorFlow2019/Image_1009.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s48" style="padding-left: 94pt;text-indent: 0pt;text-align: center;">TALK ABOUT YOUR ROBO-ACHIEVERS</p><p class="s49" style="padding-top: 6pt;padding-left: 11pt;text-indent: 0pt;text-align: left;">There were many more versions of the Navlab 1. Navlab 5 was actually able to steer itself all the way from Pittsburgh to San Diego in 1995, driving all but 50 of the 2,850 mile journey by itself. For this achievement, Navlab 5 was inducted into the Robot Hall of Fame. In the world of robots, being in the Hall of Fame pretty much makes you elite royalty. If you are ever in Pittsburgh and want to meet some other members of this prestigious class, be sure to check out the Roboworld exhibit at the Carnegie Science Center.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s198" style="padding-top: 7pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a href="https://oreil.ly/b2Bnn" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12pt;" target="_blank" name="bookmark1757">Figure 16-2. The NavLab 1 in all its glory (</a>image source<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s196" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1734">Deep Learning, Autonomous Driving, and the Data Problem</a><a name="bookmark1758">&zwnj;</a></p><p style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1759">Even 35 years ago scientists knew that neural networks were going to play a key role in making self-driving cars a reality. Back then, of course, we did not have the technology needed (GPUs, cloud computing, FPGAs, etc.) to train and deploy deep neural networks at scale for autonomous driving to become a reality. Today’s autonomous cars use deep learning to perform all kinds of tasks.</a></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Table 16-1 <span style=" color: #000;">lists some examples.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s43" style="padding-left: 213pt;text-indent: -194pt;text-align: left;"><a name="bookmark1760">Table 16-1. Examples of deep learning applications in self-driving cars</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="585" height="1" alt="image" src="KerasTensorFlow2019/Image_1010.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-bottom: 3pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Task Examples</p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="585" height="1" alt="image" src="KerasTensorFlow2019/Image_1011.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="495" height="48" alt="image" src="KerasTensorFlow2019/Image_1012.png"/></span></p><p class="s49" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Detect other vehicles, pedestrians, animals, objects on the road, etc.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s48" style="padding-top: 7pt;padding-bottom: 3pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Perception <span class="s49">Detect drivable area, lane markings, intersections, crosswalks, etc.</span></p><p class="s49" style="padding-top: 2pt;padding-left: 80pt;text-indent: 0pt;text-align: left;">Detect traffic signs and signals</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:7.05929pt" cellspacing="0"><tr style="height:41pt"><td style="width:441pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2" colspan="2" bgcolor="#F1F5FB"><p class="s65" style="padding-top: 8pt;padding-left: 73pt;padding-right: 6pt;text-indent: -70pt;text-align: left;">Navigation <span class="s66">Predict and output steering angle, throttle, etc., based on sensor input</span></p></td></tr><tr style="height:21pt"><td style="width:70pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:371pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Perform overtaking, lane changes, U-turns, etc.</p></td></tr><tr style="height:21pt"><td style="width:441pt" colspan="2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 73pt;text-indent: 0pt;text-align: left;">Perform merges, exits, navigate roundabouts, etc.</p></td></tr><tr style="height:21pt"><td style="width:70pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:371pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Drive in tunnels, over bridges, etc.</p></td></tr><tr style="height:35pt"><td style="width:441pt" colspan="2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 73pt;padding-right: 6pt;text-indent: 0pt;text-align: left;">Respond to traffic rule breakers, wrong-way drivers, unexpected environment changes, etc.</p></td></tr><tr style="height:21pt"><td style="width:70pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:371pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Navigate stop-and-go traffic</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1761">We know that deep learning requires data. In fact, a general rule of thumb is that more data ensures better model performance. In previous chapters, we saw that training image classifiers can require millions of images. Imagine how much data it would take to train a car to drive itself. Things are also very different with self-driving cars when it comes to the data needed for validation and testing. Not only must a car be able to drive, it must do it safely. Testing and validating model performance is therefore fundamentally critical and requires a</a></p><p class="s45" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="https://oreil.ly/mOUeJ" class="s63" target="_blank">lot more data than what is needed for training, unlike traditional deep learning problems. However, it is difficult to accurately predict the exact amount of data needed, and estimates vary. </a>A 2016 study <span style=" color: #000;">shows that it would take 11 billion miles of driving for a car to become as good as a human driver. For a fleet of 100 self-driving cars collecting data 24 hours per day, 365 days per year at an average speed of 25 miles per hour, this would take more than 500 years!</span></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="https://waymo.com/tech" class="s63" target="_blank" name="bookmark1762">Now, of course, it is highly impractical and costly to collect 11 billion miles of data by having fleets of cars drive around in the real world. This is why almost everyone working in this space — be it a large automaker or a startup — uses simulators to collect data and validate trained models. </a>Waymo <a href="https://oreil.ly/rag7v" class="s63" target="_blank">(Google’s self-driving car team), for example, had driven nearly 10 million miles on the road as of late 2018. Even though this is more than any other company on the planet it represents less than one percent of our 11-billion-mile figure. On the other hand, Waymo has driven seven billion miles in simulation. Although everyone uses simulation for validation, some companies build their own simulation tools, whereas others license them from companies like Cognata, Applied Intuition, and AVSimulation. There are some great open source simulation tools available as well: </a><a href="https://oreil.ly/rag7v" class="s44" target="_blank">AirSim </a><a href="https://oreil.ly/rag7v" class="s63" target="_blank">from Microsoft, </a><a href="https://oreil.ly/rag7v" class="s44" target="_blank">Carla </a><a href="https://oreil.ly/rag7v" class="s63" target="_blank">from Intel, and </a><a href="https://oreil.ly/rag7v" class="s44" target="_blank">Apollo simulation </a><span style=" color: #000;">from Baidu. Thanks to these tools, we don’t need to connect the CAN bus of our car to learn the science behind making it drive itself.</span><a name="bookmark1763">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="https://oreil.ly/uzOGl" class="s63" target="_blank" name="bookmark1764">In this chapter, we use a custom-built version of AirSim, built specifically for Microsoft’s </a>Autonomous Driving Cookbook<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="595" height="931" alt="image" src="KerasTensorFlow2019/Image_1013.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s48" style="padding-top: 4pt;padding-left: 40pt;text-indent: 0pt;text-align: left;">SIMULATION AND THE AUTONOMOUS DRIVING INDUSTRY</p><p class="s49" style="padding-top: 6pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a name="bookmark1765">Simulation plays a very important role in autonomous driving. Before the autonomy stack can be safely deployed on real-world vehicles, it must go through hours and hours of testing and validation inside simulated worlds that accurately represent the environment these vehicles will be driving in.</a></p><p class="s49" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">Simulators enable closed-loop validation of algorithms. The ego vehicle in simulation receives sensor data and performs actions based on it, which has a direct affect on the vehicle’s environment and influences the next set of sensor readings; hence, closing the loop.</p><p class="s79" style="padding-top: 5pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1766" class="s140">Different types of simulators are utilized based on which part of the autonomy stack is being tested (</a>Figure 16-3<span style=" color: #000;">). For tasks that require a visually realistic representation of the environment, like testing the perception stack, we use photorealistic simulators. These simulators also try to accurately mimic sensor physics, material dynamics, and so on. AirSim and Carla are examples of open source photo-realistic simulators. On the other hand, for tasks that can do without realistic visuals, we can save a lot of GPU resources by employing post-perception simulators. Most of these tasks utilize the results of a perception system to do path planning and navigation. Baidu’s Apollo is an example of an open source simulator in this category.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s198" style="padding-top: 4pt;padding-left: 158pt;text-indent: -133pt;text-align: left;"><a href="https://oreil.ly/rag7v" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12pt;" target="_blank" name="bookmark1766">Figure 16-3. AirSim’s photo realistic simulation versus Apollo postperception simulation (</a>image source<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s79" style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><a name="bookmark1767">Cognata</a><span style=" color: #000;">, an autonomous driving simulation startup based in Israel, is a leader in the space with its cloud-scale, photo-realistic simulation platform. Cognata is addressing some of the key challenges in this industry using a very innovative approach that uses DNNs. “I came to this field after working on computer vision–based ADAS [Advanced Driver Assistance Systems] applications for close to a decade,” said Cognata CEO and founder Danny Atsmon. “I found out that using OpenGL-based rendering techniques does not yield the feature quality which is needed to train or validate a deep neural network and came to a decision that a new rendering technique is needed for that. Our rendering engine uses DNNs to learn distributions from real recorded data and renders the simulated data in a way that mimics the actual sensor.”</span></p><p class="s49" style="padding-top: 5pt;padding-left: 18pt;text-indent: 0pt;text-align: left;">We are indeed living in a fantastic time in which hardware and software innovations are coming together like never before to solve one of the most</p><p class="s49" style="padding-left: 11pt;text-indent: 0pt;line-height: 14pt;text-align: left;">complex technological challenges we have ever seen: the self-driving car.</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="588" height="35" alt="image" src="KerasTensorFlow2019/Image_1014.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s196" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1735">The “Hello, World!” of Autonomous Driving: Steering Through a Simulated Environment</a><a name="bookmark1768">&zwnj;</a></p><p style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1769">In this section, we implement the “Hello, World!” problem of autonomous driving. Self-driving cars are complex, with dozens of sensors streaming gigabytes of data and multiple decisions being made while driving down a road. Much like programming, for the “Hello, World!” of self-driving cars, we strip the requirements down to basic fundamentals:</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1015.png"/></span></p><p style="padding-top: 5pt;padding-left: 35pt;text-indent: 0pt;text-align: left;">The car always stays on the road.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1016.png"/></span></p><p style="padding-left: 35pt;text-indent: 0pt;text-align: left;">For external sensor input, the car uses a single image frame from a single camera mounted on the front of the hood. No other sensors (lidar, radar, etc.) are used.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1017.png"/></span></p><p style="padding-top: 14pt;padding-left: 35pt;text-indent: 0pt;text-align: left;">Based on this single-image input, going at a constant speed, the car predicts its output steering angle. No other possible outputs (brake, throttle, gear changes, etc.) are predicted.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1018.png"/></span></p><p style="padding-top: 14pt;padding-left: 35pt;text-indent: 0pt;text-align: left;">There are no other vehicles, pedestrians, animals, or anything else on the road or relevant surroundings.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1019.png"/></span></p><p style="padding-top: 14pt;padding-left: 35pt;text-indent: 0pt;text-align: left;">The road being driven on is single lane, with no markings or traffic signs and signals and no rules for staying on the left or right side of the road.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1020.png"/></span></p><p style="padding-top: 14pt;padding-left: 35pt;text-indent: 0pt;text-align: left;">The road mostly changes in terms of turns (which will require changing steering angle to navigate) and not in terms of elevation (which would require a change in throttle, applying brakes, etc.).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s197" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1736">Setup and Requirements</a><a name="bookmark1770">&zwnj;</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark1772" class="s63" name="bookmark1771">We will be implementing the “Hello, World!” problem in AirSim’s Landscape map (</a>Figure 16-4<span style=" color: #000;">). AirSim is an open source photo- realistic simulation platform and is a popular research tool for training data collection and validation of deep learning–based autonomous system model development.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 10pt;text-indent: 0pt;text-align: left;"><span><img width="583" height="349" alt="image" src="KerasTensorFlow2019/Image_1021.jpg"/></span></p><p class="s50" style="padding-top: 5pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1772">Figure 16-4. The Landscape map in AirSim</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="https://oreil.ly/_IJl9" class="s63" target="_blank">You can find the code for this chapter in the </a><a href="https://oreil.ly/_IJl9" class="s44" target="_blank">end-to-end deep learning tutorial </a><a href="https://oreil.ly/uF5Bz" class="s63" target="_blank">from the </a><a href="https://oreil.ly/_IJl9" class="s46" target="_blank">Autonomous Driving Cookbook </a><a href="https://oreil.ly/YVKPp" class="s63" target="_blank">on GitHub in the form of Jupyter Notebooks. In the cookbook repository, go to </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">AirSimE2EDeepLearning/</span>. We can do so by running the following:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ git clone https://github.com/Microsoft/AutonomousDrivingCookbook.git</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">$ cd AutonomousDrivingCookbook/AirSimE2EDeepLearning/</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">We will use Keras, a library with which we are already familiar, to implement our neural network. It’s not necessary for us to learn any new deep learning concepts to work on this problem other than what has already been introduced in prior chapters of this book.</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="https://aka.ms/AirSimTutorialDataset" class="s63" target="_blank">For this chapter, we have created a dataset by driving around in AirSim. The uncompressed size of the dataset is 3.25 GB. This is a little larger than datasets we’ve been using, but remember, we are implementing the “Hello, World!” of a highly complex problem. For comparison, it is fairly normal practice for automakers to collect multiple petabytes of data on the road every day. You can download the dataset by going to </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">aka.ms/AirSimTutorialDataset</span>.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="http://aka.ms/ADCookbookAirSimPackage" class="s63" target="_blank">We can run the provided code and train our model on a Windows or Linux machine. We created a standalone build of AirSim for this chapter, which you can download from </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">aka.ms/ADCookbookAirSimPackage</span>. After you’ve downloaded it, extract the simulator package to the location of your choice. Take note of the path because you will need it later. Please note that this build runs only on Windows but is needed only to see our final trained model in action. If you’re using Linux, you can take the model files and run them on a Windows machine with the provided simulator package.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">AirSim is a highly photo-realistic environment, which means it is capable of generating lifelike pictures of the environment for the model to train on. You may have encountered similar graphics while playing high-definition video games. Given the size of the data and the graphic quality of the provided simulator package, a GPU is certainly preferable for running the code as well as the simulator.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="https://oreil.ly/RzZe7" class="s63" target="_blank">Finally, there are some additional tools and Python dependencies needed to run the code provided. You can find the details for these at </a><span style=" color: #8E0012;">Environment Setup in the README file </span>in the code repository. At a high level, we need Anaconda with Python 3.5 (or higher), TensorFlow (to run as a backend to Keras), and h5py (for storing and reading data and model files). After we have our Anaconda environment set up, we can install the needed Python dependencies by running the <i>InstallPackages.py </i>file as root or administrator.</p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Table 16-2 <span style=" color: #000;">provides a summary of all the requirements that we just defined.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s43" style="padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1773">Table 16-2. Setup and requirements summary</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="585" height="1" alt="image" src="KerasTensorFlow2019/Image_1022.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-bottom: 3pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Item Requirements/Link Notes/Comments</p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="585" height="1" alt="image" src="KerasTensorFlow2019/Image_1023.png"/></span></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="585" height="1" alt="image" src="KerasTensorFlow2019/Image_1024.png"/></span></p><p class="s48" style="padding-top: 2pt;padding-bottom: 3pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Item Requirements/Link Notes/Comments</p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="585" height="1" alt="image" src="KerasTensorFlow2019/Image_1025.png"/></span></p><p class="s198" style="padding-top: 2pt;padding-left: 312pt;text-indent: -301pt;text-align: left;"><a href="https://oreil.ly/_IJl9" class="s140" target="_blank">Code repository </a>https://oreil.ly/_IJl9 <span class="s49">Can be run on a Windows or Linux machine</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:7.05929pt" cellspacing="0"><tr style="height:50pt"><td style="width:441pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2" colspan="3" bgcolor="#F1F5FB"><p style="padding-top: 8pt;padding-left: 3pt;text-indent: 0pt;text-align: left;"><a href="https://oreil.ly/6yvCq" style=" color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12pt;" target="_blank">Jupyter </a><a href="https://oreil.ly/6yvCq" class="s199" target="_blank">DataExplorationAndPreparation.ipynb</a></p><p style="padding-left: 3pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="https://oreil.ly/rcR47" style=" color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12pt; vertical-align: 6pt;" target="_blank">Notebooks </a><a href="https://oreil.ly/rcR47" class="s199" target="_blank">TrainModel.ipynb</a></p><p class="s66" style="padding-left: 3pt;text-indent: 0pt;line-height: 8pt;text-align: left;">used</p></td></tr><tr style="height:18pt"><td style="width:87pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:211pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="padding-left: 8pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="https://oreil.ly/FE-EP" class="s199">TestModel.ipynb</a></p></td><td style="width:143pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:35pt"><td style="width:87pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;padding-right: 31pt;text-indent: 0pt;text-align: left;">Dataset download</p></td><td style="width:211pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="padding-top: 2pt;padding-left: 8pt;text-indent: 0pt;text-align: left;"><a href="http://aka.ms/AirSimTutorialDataset" class="s199">aka.ms/AirSimTutorialDataset</a></p></td><td style="width:143pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 6pt;padding-right: 6pt;text-indent: 0pt;text-align: left;">3.25 GB in size; needed to train model</p></td></tr><tr style="height:70pt"><td style="width:87pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 8pt;padding-left: 3pt;padding-right: 31pt;text-indent: 0pt;text-align: left;">Simulator download</p></td><td style="width:211pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="padding-top: 8pt;padding-left: 8pt;text-indent: 0pt;text-align: left;"><a href="http://aka.ms/ADCookbookAirSimPackage" class="s199">aka.ms/ADCookbookAirSimPackage</a></p></td><td style="width:143pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 8pt;padding-left: 6pt;padding-right: 12pt;text-indent: 0pt;text-align: left;">Not needed to train model, only to deploy and run it; runs only on Windows</p></td></tr><tr style="height:35pt"><td style="width:87pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">GPU</p></td><td style="width:211pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s66" style="padding-top: 2pt;padding-left: 8pt;padding-right: 9pt;text-indent: 0pt;text-align: left;">Recommended for training, required for running simulator</p></td><td style="width:143pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:50pt"><td style="width:87pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s66" style="padding-top: 2pt;padding-left: 3pt;padding-right: 8pt;text-indent: 0pt;text-align: left;">Other tools + Python dependencies</p></td><td style="width:211pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="padding-top: 2pt;padding-left: 8pt;padding-right: 42pt;text-indent: 0pt;text-align: left;"><a href="https://oreil.ly/RzZe7" class="s201">Environment Setup section in README file in the repository</a></p></td><td style="width:143pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1774">With all that taken care of, let’s get started!</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s196" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1737">Data Exploration and Preparation</a><a name="bookmark1775">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1776">As we journey deeper into the world of neural networks and deep learning, you will notice that much of the magic of machine learning doesn’t come from how a neural network is built and trained, but from the data scientist’s understanding of the problem, the data, and the domain. Autonomous driving is no different. As you will see shortly, having a deep understanding of the data and the problem we are trying to solve is key when teaching our car how to drive itself.</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="https://oreil.ly/6aE7z" class="s63" target="_blank">All the steps here are also detailed in the Jupyter Notebook </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">DataExplorationAndPreparation.ipynb</span>. We start by importing all the necessary modules for this part of the exercise:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">os </span>import <span style=" color: #0CF;">random</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">numpy </span>as <span style=" color: #0CF;">np </span>import <span style=" color: #0CF;">pandas </span>as <span style=" color: #0CF;">pd </span>import <span style=" color: #0CF;">h5py</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">matplotlib.pyplot </span>as <span style=" color: #0CF;">plt </span>from <span style=" color: #0CF;">PIL </span>import <span class="s56">Image</span><span class="s53">, </span><span class="s56">ImageDraw</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">Cooking </span><span class="s60">#This module contains helper code. Please do not edit this file.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Next, we make sure our program can find the location of our unzipped dataset. We also provide it a location to store our processed (or “cooked”) data:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># &lt;&lt; Point this to the directory containing the raw data &gt;&gt;</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">RAW_DATA_DIR <span style=" color: #000;">= </span><span style=" color: #C30;">&#39;data_raw/&#39;</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># &lt;&lt; Point this to the desired output directory for the cooked (.h5) data</p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&gt;&gt;</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">COOKED_DATA_DIR <span style=" color: #000;">= </span><span style=" color: #C30;">&#39;data_cooked/&#39;</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># The folders to search for data under RAW_DATA_DIR</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s60"># For example, the first folder searched will be RAW_DATA_DIR/normal_1 </span><span style=" color: #000087;">DATA_FOLDERS </span>= [<span style=" color: #C30;">&#39;normal_1&#39;</span>, <span style=" color: #C30;">&#39;normal_2&#39;</span>, <span style=" color: #C30;">&#39;normal_3&#39;</span>, <span style=" color: #C30;">&#39;normal_4&#39;</span>, <span style=" color: #C30;">&#39;normal_5&#39;</span>,</p><p class="s57" style="padding-left: 67pt;text-indent: 0pt;text-align: left;">&#39;normal_6&#39;<span style=" color: #000;">, </span>&#39;swerve_1&#39;<span style=" color: #000;">, </span>&#39;swerve_2&#39;<span style=" color: #000;">, </span>&#39;swerve_3&#39;<span style=" color: #000;">]</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># The size of the figures and illustrations used</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">FIGURE_SIZE </span>= (<span style=" color: #F60;">1O</span>,<span style=" color: #F60;">1O</span>)</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Looking at the provided dataset we will see that it contains nine folders: <i>normal_1 </i>through <i>normal_6 </i>and <i>swerve_1 </i>through <i>swerve_3</i>. We come back to the naming of these folders later. Within each of these folders are images as well as <i>.tsv </i>(or <i>.txt</i>) files. Let’s check out one of these images:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">sample_image_path = os.path.join(RAW_DATA_DIR, &#39;normal_1/images/img_O.png&#39;)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">sample_image = Image.open(sample_image_path) plt.title(&#39;Sample Image&#39;) plt.imshow(sample_image)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">plt.show()</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark1777" class="s63">We should see the following output. We can see that this image was captured by a camera placed centrally on the hood of the car (which is slightly visible at the bottom in </a>Figure 16-5<span style=" color: #000;">). We can also see the Landscape environment used for this problem from the simulator.</span></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Notice that no other vehicles or objects are on the road, keeping in line with our requirements. Although the road appears to be snowy, for our experiment, the snow is only visual and not physical; that is, it will have no effect on the physics and movement of our car. Of course, in the real world, it is critical to accurately replicate the physics of snow, rain, etc., so that our simulators can produce highly accurate versions of reality. This is a very complicated task to undertake and many companies dedicate a lot of resources to it.</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Thankfully for our purpose, we can safely ignore all that and treat the snow as just white pixels in our image.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="354" height="215" alt="image" src="KerasTensorFlow2019/Image_1026.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 21pt;text-indent: 0pt;text-align: left;"><a name="bookmark1777">Figure 16-5. Plot showing the contents of the file normal_1/images/img_0.png</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Let’s also get a preview of what the rest of the data looks like by displaying the contents of one of the <i>.tsv/.txt </i>files:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">sample_tsv_path </span>= <span style=" color: #000087;">os</span>.<span style=" color: #000087;">path</span>.<span style=" color: #000087;">join</span>(<span style=" color: #000087;">RAW_DATA_DIR</span>, <span style=" color: #C30;">&#39;normal_1/airsim_rec.txt&#39;</span>) <span style=" color: #000087;">sample_tsv </span>= <span style=" color: #000087;">pd</span>.<span style=" color: #000087;">read_csv</span>(<span style=" color: #000087;">sample_tsv_path</span>, <span style=" color: #000087;">sep</span>=<span style=" color: #C30;">&#39;</span><span class="s80">\t</span><span style=" color: #C30;">&#39;</span>)</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">sample_tsv<span style=" color: #000;">.</span>head<span style=" color: #000;">()</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;">We should see the following output:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 10pt;text-indent: 0pt;text-align: left;"><span><img width="577" height="199" alt="image" src="KerasTensorFlow2019/Image_1027.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">There is a lot going on here, so let’s break it down. First, we can see that each row in the table corresponds to an image frame (we are displaying only the first five frames here). Because this is at the beginning of our data collection drive, we can see that the car hasn’t started moving yet: the speed and throttle are 0 and the gear is neutral. Because we are trying to predict only steering angles for our problem, we won’t be predicting the speed, throttle, brake, or gear values. These values will be used, however, as part of the input data (more on this later).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s197" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1738">Identifying the Region of Interest</a><a name="bookmark1778">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1779">Let’s get back to our sample image now. All the observations we made so far were from the eyes of a human being. For a moment, let’s take a look at the image again, only this time we step into the shoes (or tires) of a car that is just beginning to learn how to drive itself and is trying to understand what it is seeing.</a></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark1780" class="s63">If I’m the car, looking at this image that my camera presented me, I can divide it into three distinct parts (</a>Figure 16-6<span style=" color: #000;">). First, there is the lower third, which more or less looks consistent. It is made up of mostly straight lines (the road, lane divider, road fences, etc.) and has a uniform coloring of white, black, gray, and brown. There is also a weird black arc at the very bottom (this is the hood of the car). The upper third of the image, like the lower third, is also consistent. It is mostly gray and white (the sky and the clouds). Lastly, there is the middle third and it has a lot going on. There are big brown and grey shapes (mountains), which are not uniform at all. There are also four tall green figures (trees), their shape and color are different from anything else I see, so they must be super important. As I am presented more images, the upper third and the lower third don’t change all that much but the middle third undergoes a lot of change. Hence, I conclude that this is the part that I should be focusing on the most.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 10pt;text-indent: 0pt;text-align: left;"><span><img width="576" height="335" alt="image" src="KerasTensorFlow2019/Image_1028.jpg"/></span></p><p class="s50" style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark1780">Figure 16-6. The three parts of the image as seen by the self-driving car</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Do you see the challenge in front of our car? It has no way of knowing what part of the image being presented to it is important. It might try to associate the changing steering angles with the changing scenery instead of focusing on turns in the road, which are very subtle compared to everything else that is going on. Not only are the changes in the scenery confusing, but they are also not relevant to the problem we are trying to solve here at all. The sky above, although mostly unchanging, also does not provide us with any information relevant to the steering of our car. Finally, the part of the hood being captured in every picture is also nonrelevant.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Let us fix this by focusing only on the relevant portion of the image. We do this by creating a region of interest (ROI) in our image. As we can imagine, there is no hard-and-fast rule to dictate what our ROI should look like. It really depends on our use case. For us, because the camera is in a fixed position and there are no elevation changes on the road, the ROI is a simple rectangle focusing on the road and road boundaries. We can see the ROI by running the following code snippet:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;line-height: 200%;text-align: left;"><span style=" color: #000087;">sample_image_roi </span>= <span style=" color: #000087;">sample_image</span>.<span style=" color: #000087;">copy</span>() <span style=" color: #000087;">fillcolor</span>=(<span style=" color: #F60;">255</span>,<span style=" color: #F60;">O</span>,<span style=" color: #F60;">O</span>)</p><p class="s56" style="padding-top: 4pt;padding-left: 21pt;text-indent: 0pt;text-align: left;">draw <span style=" color: #000;">= </span>ImageDraw<span style=" color: #000;">.</span>Draw<span style=" color: #000;">(</span>sample_image_roi<span style=" color: #000;">)</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">points </span>= [(<span style=" color: #F60;">1</span>,<span style=" color: #F60;">76</span>), (<span style=" color: #F60;">1</span>,<span style=" color: #F60;">135</span>), (<span style=" color: #F60;">255</span>,<span style=" color: #F60;">135</span>), (<span style=" color: #F60;">255</span>,<span style=" color: #F60;">76</span>)]</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">for </span><span style=" color: #000087;">i </span><b>in </b><span style=" color: #366;">range</span>(<span style=" color: #F60;">O</span>, <span style=" color: #366;">len</span>(<span style=" color: #000087;">points</span>), <span style=" color: #F60;">1</span>):</p><p class="s53" style="padding-left: 21pt;text-indent: 23pt;text-align: left;"><span style=" color: #000087;">draw</span>.<span style=" color: #000087;">line</span>([<span style=" color: #000087;">points</span>[<span style=" color: #000087;">i</span>], <span style=" color: #000087;">points</span>[(<span style=" color: #000087;">i</span>+<span style=" color: #F60;">1</span>)%<span style=" color: #366;">len</span>(<span style=" color: #000087;">points</span>)]], <span style=" color: #000087;">fill</span>=<span style=" color: #000087;">fillcolor</span>, <span style=" color: #000087;">width</span>=<span style=" color: #F60;">3</span>)</p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">del <span class="s56">draw</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">plt</span>.<span style=" color: #000087;">title</span>(<span style=" color: #C30;">&#39;Image with sample ROI&#39;</span>) <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">imshow</span>(<span style=" color: #000087;">sample_image_roi</span>) <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">show</span>()</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1781" class="s63">We should see the output shown in </a>Figure 16-7<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 10pt;text-indent: 0pt;text-align: left;"><span><img width="566" height="349" alt="image" src="KerasTensorFlow2019/Image_1029.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1781">Figure 16-7. The ROI for our car to focus on during training</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Our model will focus only on the road now and not be confused by anything else going on in the environment. This also reduces the size of the image by half, which will make training our neural network easier.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s197" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1739">Data Augmentation</a><a name="bookmark1782">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1783">As mentioned earlier, it is always better to have as much data as we can get our hands on while training deep learning models. We have seen in previous chapters the importance of data augmentation and how it helps to not only get more training data but to also avoid overfitting. Most data augmentation techniques discussed previously for image classification, however, will not be useful for our current autonomous driving problem. Let’s take the example of rotation.</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Rotating images randomly by 20 degrees is very helpful when training a classifier for a smartphone camera, but the camera on the hood of our car is fixed in place and will never see a rotated image (unless our car is doing flips, at which point we have larger concerns). The same goes for random shifts; we will never encounter those while driving. There is, however, something else we can do to augment the data for our current problem.</p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark1784" class="s63">Looking closely at our image, we can observe that flipping it on the y-axis produces an image that could have easily come from a different test run (</a>Figure 16-8<span style=" color: #000;">). We can effectively double the size of</span></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">our dataset if we used the flipped versions of images along with their regular ones. Flipping an image this way will require us to modify the steering angle associated with it as well. Because our new image is a reflection of our original, we can just change the sign of the corresponding steering angle (e.g., from 0.212 to –0.212).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 10pt;text-indent: 0pt;text-align: left;"><span><img width="576" height="162" alt="image" src="KerasTensorFlow2019/Image_1030.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1784">Figure 16-8. Flipping image on the y-axis</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">There is another thing we can do to augment our data. Autonomous cars need to be ready for not only changes on the roads, but also for changes in external conditions like weather, time of day, and</p><p class="s45" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark1785" class="s63">available light. Most simulators available today allow us to create these conditions synthetically. All of our data was collected in bright lighting conditions. Instead of going back to the simulator to collect more data under a variety of lighting conditions, we could just introduce random lighting changes by adjusting image brightness while training on the data we have. </a>Figure 16-9 <span style=" color: #000;">shows an example.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 10pt;text-indent: 0pt;text-align: left;"><span><img width="576" height="165" alt="image" src="KerasTensorFlow2019/Image_1031.jpg"/></span></p><p class="s50" style="padding-top: 7pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1785">Figure 16-9. Reducing image brightness by 40%</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s197" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1740">Dataset Imbalance and Driving Strategies</a><a name="bookmark1786">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1787">Deep learning models are only as good as the data on which they are trained. Unlike humans, the AI of today cannot think and reason for itself. Hence, when presented with a completely new situation it will fall back on what it has seen before and make predictions based on the dataset it was trained on. Additionally, the statistical nature of deep learning makes it ignore instances that happen infrequently as aberrations and outliers, even if they are of significance. This is called </a><i>dataset imbalance</i>, and it is a common nuisance for data scientists.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Imagine that we are trying to train a classifier that looks at dermatoscopic images to detect whether a lesion is benign or malignant. Suppose that our dataset has one million images, 10,000 of which contain lesions that are malignant. It is very likely that the classifier we train on this data always predicts images to be benign and never malignant. This happens because deep learning algorithms are designed to minimize error (or maximize accuracy) while training. By classifying all images as benign, our model attains 99% accuracy and calls it a day, while severely failing at the job it was trained to perform: detecting cancerous lesions. This problem is usually solved by training predictors on a more balanced dataset.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Autonomous driving is not immune to the problem of dataset imbalance. Let’s take our steering-angle prediction model. What do we know about steering angles from our day-to-day driving experience? While driving down a road we mostly drive straight. If our model was trained on only normal driving data, it would never learn how to navigate turns due to their relative scarcity in the training dataset. To solve this, it is important that our dataset contains data not only for a normal driving strategy but also for a “swerved” driving strategy in a statistically significant amount. To illustrate what we mean by this, let’s go back to our <i>.tsv</i>/<i>.txt </i>files.</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Earlier in the chapter, we pointed out the naming of our data folders. It should now be clear that our dataset has data from six collection runs using a normal driving strategy and from three collection runs using a swerve driving strategy.</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Let us aggregate the data from all <i>.tsv</i>/<i>.txt </i>files into a single DataFrame to make the analysis easier:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">full_path_raw_folders <span style=" color: #000;">= [</span>os<span style=" color: #000;">.</span>path<span style=" color: #000;">.</span>join<span style=" color: #000;">(</span>RAW_DATA_DIR<span style=" color: #000;">, </span>f<span style=" color: #000;">) </span><span class="s54">for </span>f <span class="s71">in</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">DATA_FOLDERS<span style=" color: #000;">]</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">dataframes <span style=" color: #000;">= []</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">for </span>folder <span class="s71">in </span>full_path_raw_folders<span style=" color: #000;">:</span></p><p class="s53" style="padding-left: 21pt;text-indent: 23pt;text-align: left;"><span style=" color: #000087;">current_dataframe </span>= <span style=" color: #000087;">pd</span>.<span style=" color: #000087;">read_csv</span>(<span style=" color: #000087;">os</span>.<span style=" color: #000087;">path</span>.<span style=" color: #000087;">join</span>(<span style=" color: #000087;">folder</span>, <span style=" color: #C30;">&#39;airsim_rec.txt&#39;</span>),</p><p class="s53" style="padding-left: 44pt;text-indent: 185pt;text-align: left;"><span style=" color: #000087;">sep</span>=<span style=" color: #C30;">&#39;</span><span class="s80">\t</span><span style=" color: #C30;">&#39;</span>) <span style=" color: #000087;">current_dataframe</span>[<span style=" color: #C30;">&#39;Folder&#39;</span>] = <span style=" color: #000087;">folder dataframes</span>.<span style=" color: #000087;">append</span>(<span style=" color: #000087;">current_dataframe</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">dataset </span>= <span style=" color: #000087;">pd</span>.<span style=" color: #000087;">concat</span>(<span style=" color: #000087;">dataframes</span>, <span style=" color: #000087;">axis</span>=<span style=" color: #F60;">O</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Let’s plot some steering angles from both driving strategies on a scatter plot:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">min_index <span style=" color: #000;">= </span><span style=" color: #F60;">1OO </span>max_index <span style=" color: #000;">= </span><span style=" color: #F60;">15OO</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">steering_angles_normal_1 </span>= <span style=" color: #000087;">dataset</span>[<span style=" color: #000087;">dataset</span>[<span style=" color: #C30;">&#39;Folder&#39;</span>].<span style=" color: #000087;">apply</span>(<span class="s54">lambda </span><span style=" color: #000087;">v</span>: <span style=" color: #C30;">&#39;normal_1&#39;</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><b>in </b><span style=" color: #000087;">v</span>)][<span style=" color: #C30;">&#39;Steering&#39;</span>][<span style=" color: #000087;">min_index</span>:<span style=" color: #000087;">max_index</span>]</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">steering_angles_swerve_1 </span>= <span style=" color: #000087;">dataset</span>[<span style=" color: #000087;">dataset</span>[<span style=" color: #C30;">&#39;Folder&#39;</span>].<span style=" color: #000087;">apply</span>(<span class="s54">lambda </span><span style=" color: #000087;">v</span>: <span style=" color: #C30;">&#39;swerve_1&#39;</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><b>in </b><span style=" color: #000087;">v</span>)][<span style=" color: #C30;">&#39;Steering&#39;</span>][<span style=" color: #000087;">min_index</span>:<span style=" color: #000087;">max_index</span>]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">plot_index <span style=" color: #000;">= [</span>i <span class="s54">for </span>i <span class="s71">in </span><span style=" color: #366;">range</span><span style=" color: #000;">(</span>min_index<span style=" color: #000;">, </span>max_index<span style=" color: #000;">, </span><span style=" color: #F60;">1</span><span style=" color: #000;">)] </span>fig <span style=" color: #000;">= </span>plt<span style=" color: #000;">.</span>figure<span style=" color: #000;">(</span>figsize<span style=" color: #000;">=</span>FIGURE_SIZE<span style=" color: #000;">)</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">ax1 </span>= <span style=" color: #000087;">fig</span>.<span style=" color: #000087;">add_subplot</span>(<span style=" color: #F60;">111</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">ax1</span>.<span style=" color: #000087;">scatter</span>(<span style=" color: #000087;">plot_index</span>, <span style=" color: #000087;">steering_angles_normal_1</span>, <span style=" color: #000087;">c</span>=<span style=" color: #C30;">&#39;b&#39;</span>, <span style=" color: #000087;">marker</span>=<span style=" color: #C30;">&#39;o&#39;</span>, <span style=" color: #000087;">label</span>=<span style=" color: #C30;">&#39;normal_1&#39;</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">ax1</span>.<span style=" color: #000087;">scatter</span>(<span style=" color: #000087;">plot_index</span>, <span style=" color: #000087;">steering_angles_swerve_1</span>, <span style=" color: #000087;">c</span>=<span style=" color: #C30;">&#39;r&#39;</span>, <span style=" color: #000087;">marker</span>=<span style=" color: #C30;">&#39;_&#39;</span>, <span style=" color: #000087;">label</span>=<span style=" color: #C30;">&#39;swerve_1&#39;</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">plt</span>.<span style=" color: #000087;">legend</span>(<span style=" color: #000087;">loc</span>=<span style=" color: #C30;">&#39;upper left&#39;</span>);</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">plt</span>.<span style=" color: #000087;">title</span>(<span style=" color: #C30;">&#39;Steering Angles for normal_1 and swerve_1 runs&#39;</span>) <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">xlabel</span>(<span style=" color: #C30;">&#39;Time&#39;</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">plt</span>.<span style=" color: #000087;">ylabel</span>(<span style=" color: #C30;">&#39;Steering Angle&#39;</span>) <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">show</span>()</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Figure 16-10 <span style=" color: #000;">shows the results.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 25pt;text-indent: 0pt;text-align: left;"><span><img width="551" height="367" alt="image" src="KerasTensorFlow2019/Image_1032.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 11pt;padding-left: 31pt;text-indent: 0pt;text-align: left;"><a name="bookmark1788">Figure 16-10. Plot showing steering angles from the two driving strategies</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Let’s also plot the number of data points collected with each strategy:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">dataset</span>[<span style=" color: #C30;">&#39;Is Swerve&#39;</span>] = <span style=" color: #000087;">dataset</span>.<span style=" color: #000087;">apply</span>(<span class="s54">lambda </span><span style=" color: #000087;">r</span>: <span style=" color: #C30;">&#39;swerve&#39; </span><b>in </b><span style=" color: #000087;">r</span>[<span style=" color: #C30;">&#39;Folder&#39;</span>], <span style=" color: #000087;">axis</span>=<span style=" color: #F60;">1</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">grouped </span>= <span style=" color: #000087;">dataset</span>.<span style=" color: #000087;">groupby</span>(<span style=" color: #000087;">by</span>=[<span style=" color: #C30;">&#39;Is Swerve&#39;</span>]).<span style=" color: #000087;">size</span>().<span style=" color: #000087;">reset_index</span>() <span style=" color: #000087;">grouped</span>.<span style=" color: #000087;">columns </span>= [<span style=" color: #C30;">&#39;Is Swerve&#39;</span>, <span style=" color: #C30;">&#39;Count&#39;</span>]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">def </span><span style=" color: #C0F;">make_autopct</span>(<span style=" color: #000087;">values</span>):</p><p class="s53" style="padding-left: 67pt;text-indent: -23pt;text-align: left;"><span class="s54">def </span><span style=" color: #C0F;">my_autopct</span>(<span style=" color: #000087;">percent</span>): <span style=" color: #000087;">total </span>= <span style=" color: #366;">sum</span>(<span style=" color: #000087;">values</span>)</p><p class="s53" style="padding-left: 67pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">val </span>= <span style=" color: #366;">int</span>(<span style=" color: #366;">round</span>(<span style=" color: #000087;">percent</span>*<span style=" color: #000087;">total</span>/<span style=" color: #F60;">1OO.O</span>))</p><p class="s53" style="padding-left: 67pt;text-indent: 0pt;text-align: left;"><span class="s54">return </span><span style=" color: #C30;">&#39;</span><span style=" color: #A00;">{O:.2f}</span><span style=" color: #C30;">% (</span><span style=" color: #A00;">{1:d}</span><span style=" color: #C30;">)&#39;</span>.<span style=" color: #000087;">format</span>(<span style=" color: #000087;">percent</span>,<span style=" color: #000087;">val</span>)</p><p class="s54" style="padding-left: 44pt;text-indent: 0pt;text-align: left;">return <span class="s56">my_autopct</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">pie_labels </span>= [<span style=" color: #C30;">&#39;Normal&#39;</span>, <span style=" color: #C30;">&#39;Swerve&#39;</span>]</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">fig</span>, <span style=" color: #000087;">ax </span>= <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">subplots</span>(<span style=" color: #000087;">figsize</span>=<span style=" color: #000087;">FIGURE_SIZE</span>) <span style=" color: #000087;">ax</span>.<span style=" color: #000087;">pie</span>(<span style=" color: #000087;">grouped</span>[<span style=" color: #C30;">&#39;Count&#39;</span>], <span style=" color: #000087;">labels</span>=<span style=" color: #000087;">pie_labels</span>, <span style=" color: #000087;">autopct </span>=</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">make_autopct</span>(<span style=" color: #000087;">grouped</span>[<span style=" color: #C30;">&#39;Count&#39;</span>]), <span style=" color: #000087;">explode</span>=[<span style=" color: #F60;">O.1</span>, <span style=" color: #F60;">1</span>], <span style=" color: #000087;">textprops</span>={<span style=" color: #C30;">&#39;weight&#39;</span>: <span style=" color: #C30;">&#39;bold&#39;</span>},</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">colors</span>=[<span style=" color: #C30;">&#39;lightblue&#39;</span>, <span style=" color: #C30;">&#39;salmon&#39;</span>])</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">plt</span>.<span style=" color: #000087;">title</span>(<span style=" color: #C30;">&#39;Number of data points per driving strategy&#39;</span>) <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">show</span>()</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Figure 16-11 <span style=" color: #000;">shows those results.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><span><img width="545" height="327" alt="image" src="KerasTensorFlow2019/Image_1033.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1789">Figure 16-11. Dataset split for the two driving strategies</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark1788" class="s63">Looking at </a>Figure 16-10<a href="#bookmark1789" class="s63">, as we had expected, we see that the normal driving strategy produces steering angles that we would observe during everyday driving, mostly straight on the road with the occasional turn. By contrast, the swerve driving strategy mostly focuses on sharp turns and hence has higher values for steering angles. As shown in </a>Figure 16-11<span style=" color: #000;">, a combination of these two strategies gives us a nice, albeit unrealistic in real life, distribution to train on with a 75/25 split. This also further solidifies the importance of simulation for autonomous driving because it is unlikely we’d be collecting data using the swerve strategy in real life with an actual car.</span></p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark1790" class="s63">Before closing our discussion on data preprocessing and dataset imbalance, let’s take a final look at the distribution of our steering angles for the two driving strategies by plotting them on a histogram (</a>Figure 16-12<span style=" color: #000;">):</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">bins </span>= <span style=" color: #000087;">np</span>.<span style=" color: #000087;">arange</span>(-<span style=" color: #F60;">1</span>, <span style=" color: #F60;">1.O5</span>, <span style=" color: #F60;">O.O5</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">normal_labels </span>= <span style=" color: #000087;">dataset</span>[<span style=" color: #000087;">dataset</span>[<span style=" color: #C30;">&#39;Is Swerve&#39;</span>] == <span class="s54">False</span>][<span style=" color: #C30;">&#39;Steering&#39;</span>] <span style=" color: #000087;">swerve_labels </span>= <span style=" color: #000087;">dataset</span>[<span style=" color: #000087;">dataset</span>[<span style=" color: #C30;">&#39;Is Swerve&#39;</span>] == <span class="s54">True</span>][<span style=" color: #C30;">&#39;Steering&#39;</span>]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 44pt;text-indent: -23pt;text-align: left;"><span class="s54">def </span><span style=" color: #C0F;">steering_histogram</span>(<span style=" color: #000087;">hist_labels</span>, <span style=" color: #000087;">title</span>, <span style=" color: #000087;">color</span>): <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">figure</span>(<span style=" color: #000087;">figsize</span>=<span style=" color: #000087;">FIGURE_SIZE</span>)</p><p class="s53" style="padding-left: 44pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">n</span>, <span style=" color: #000087;">b</span>, <span style=" color: #000087;">p </span>= <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">hist</span>(<span style=" color: #000087;">hist_labels</span>.<span style=" color: #000087;">as_matrix</span>(), <span style=" color: #000087;">bins</span>, <span style=" color: #000087;">normed</span>=<span style=" color: #F60;">1</span>,</p><p class="s53" style="padding-top: 4pt;padding-left: 44pt;text-indent: -23pt;text-align: left;"><span style=" color: #000087;">facecolor</span>=<span style=" color: #000087;">color</span>) <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">xlabel</span>(<span style=" color: #C30;">&#39;Steering Angle&#39;</span>)</p><p class="s53" style="padding-left: 44pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">plt</span>.<span style=" color: #000087;">ylabel</span>(<span style=" color: #C30;">&#39;Normalized Frequency&#39;</span>) <span style=" color: #000087;">plt</span>.<span style=" color: #000087;">title</span>(<span style=" color: #000087;">title</span>)</p><p class="s56" style="padding-left: 44pt;text-indent: 0pt;text-align: left;">plt<span style=" color: #000;">.</span>show<span style=" color: #000;">()</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">steering_histogram</span>(<span style=" color: #000087;">normal_labels</span>, <span style=" color: #C30;">&#39;Normal driving strategy label distribution&#39;</span>,</p><p class="s57" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&#39;g&#39;<span style=" color: #000;">)</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">steering_histogram</span>(<span style=" color: #000087;">swerve_labels</span>, <span style=" color: #C30;">&#39;Swerve driving strategy label distribution&#39;</span>,</p><p class="s57" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">&#39;r&#39;<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 10pt;text-indent: 0pt;text-align: left;"><span><img width="575" height="300" alt="image" src="KerasTensorFlow2019/Image_1034.jpg"/></span></p><p class="s50" style="padding-top: 5pt;padding-left: 43pt;text-indent: 0pt;text-align: left;"><a name="bookmark1790">Figure 16-12. Steering angle distribution for the two driving strategies</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark1790" class="s63">As noted earlier, the swerve driving strategy gives us a much broader range of angles compared to the normal driving strategy, as shown in </a>Figure 16-12<span style=" color: #000;">. These angles will help our neural network react appropriately in case it ever finds the car going off the road.</span></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">The problem of imbalance in our dataset is somewhat solved, but not entirely. We still have a lot of zeros, across both driving strategies. To balance our dataset further, we could just ignore a portion of these during training. Although this gives us a very balanced dataset, it greatly reduces the overall number of data points available to us. We need to keep this in mind when we build and train our neural network.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Before moving on, let’s make sure our data is suitable for training. Let’s take the raw data from all folders, split it into train, test, and validation datasets, and compress them into HDF5 files. The HDF5</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">format allows us to access data in chunks without reading the entire dataset into memory at once. This makes it ideal for deep learning problems. It also works seamlessly with Keras. The following code will take some time to run. When it has finished running, we will have three dataset files: <i>train.h5</i>, <i>eval.h5</i>, and <i>test.h5</i>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">train_eval_test_split </span>= [<span style=" color: #F60;">O.7</span>, <span style=" color: #F60;">O.2</span>, <span style=" color: #F60;">O.1</span>]</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">full_path_raw_folders <span style=" color: #000;">= [</span>os<span style=" color: #000;">.</span>path<span style=" color: #000;">.</span>join<span style=" color: #000;">(</span>RAW_DATA_DIR<span style=" color: #000;">, </span>f<span style=" color: #000;">) </span><span class="s54">for </span>f <span class="s71">in</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">DATA_FOLDERS<span style=" color: #000;">]</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">Cooking<span style=" color: #000;">.</span>cook<span style=" color: #000;">(</span>full_path_raw_folders<span style=" color: #000;">, </span>COOKED_DATA_DIR<span style=" color: #000;">, </span>train_eval_test_split<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Each dataset file has four parts:</p><p class="s43" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Image</p><p style="padding-top: 4pt;padding-left: 35pt;text-indent: 0pt;text-align: left;">A NumPy array containing the image data.</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Previous_state</p><p style="padding-top: 4pt;padding-left: 35pt;text-indent: 0pt;text-align: left;">A NumPy array containing the last known state of the car. This is a (steering, throttle, brake, speed) tuple.</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Label</p><p style="padding-top: 4pt;padding-left: 35pt;text-indent: 0pt;text-align: left;">A NumPy array containing the steering angles that we wish to predict (normalized on the range -1..1).</p><p class="s43" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Metadata</p><p style="padding-top: 4pt;padding-left: 35pt;text-indent: 0pt;text-align: left;">A NumPy array containing metadata about the files (which folder they came from, etc.).</p><p style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1791">We are now ready to take the observations and learnings from our dataset and start training our model.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s196" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1741">Training Our Autonomous Driving Model</a><a name="bookmark1792">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="https://oreil.ly/ESHVS" class="s63" target="_blank" name="bookmark1793">All the steps in this section are also detailed in the Jupyter Notebook </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">TrainModel.ipynb</span>. As before, we begin by importing some libraries and defining paths:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">keras.preprocessing.image </span>import <span class="s56">ImageDataGenerator</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">keras.models </span>import <span class="s56">Sequential</span><span class="s53">, </span><span class="s56">Model</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">from </span><span class="s55">keras.layers </span><span class="s54">import </span>Conv2D<span style=" color: #000;">, </span>MaxPooling2D<span style=" color: #000;">, </span>Dropout<span style=" color: #000;">, </span>Flatten<span style=" color: #000;">, </span>Dense<span style=" color: #000;">, </span>Lambda<span style=" color: #000;">,</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">Input<span style=" color: #000;">, </span>concatenate</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">from </span><span class="s55">tensorflow.keras.optimizers </span><span class="s54">import </span>Adam<span style=" color: #000;">, </span>SGD<span style=" color: #000;">, </span>Adamax<span style=" color: #000;">, </span>Nadam <span class="s54">from </span><span class="s55">tensorflow.keras.callbacks </span><span class="s54">import </span>ReduceLROnPlateau<span style=" color: #000;">, </span>ModelCheckpoint<span style=" color: #000;">,</span></p><p class="s56" style="padding-left: 67pt;text-indent: 0pt;text-align: left;">CSVLogger</p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">tensorflow.keras.callbacks </span>import <span class="s56">EarlyStopping</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">tensorflow.keras.backend </span>as <span style=" color: #0CF;">K</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">tensorflow.keras.preprocessing </span>import <span class="s56">image</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">from </span><span class="s55">tensorflow.keras.models </span><span class="s54">import </span>Sequential<span style=" color: #000;">, </span>Model<span style=" color: #000;">, </span>load_model <span class="s54">from </span><span class="s55">tensorflow.keras.preprocessing.image </span><span class="s54">import </span>ImageDataGenerator <span class="s54">from </span><span class="s55">tensorflow.keras.layers </span><span class="s54">import </span>Conv2D<span style=" color: #000;">, </span>MaxPooling2D<span style=" color: #000;">, </span>Dropout<span style=" color: #000;">, </span>Flatten<span style=" color: #000;">, </span>Dense<span style=" color: #000;">,</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">from </span><span class="s55">tensorflow.keras.layers </span><span class="s54">import </span>Lambda<span style=" color: #000;">, </span>Input<span style=" color: #000;">, </span>concatenate<span style=" color: #000;">,</span></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">BatchNormalization</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">keras_tqdm </span>import <span class="s56">TQDMNotebookCallback</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">json </span>import <span style=" color: #0CF;">os</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">numpy </span>as <span style=" color: #0CF;">np </span>import <span style=" color: #0CF;">pandas </span>as <span style=" color: #0CF;">pd</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">Generator </span>import <span class="s56">DriveDataGenerator </span>from <span style=" color: #0CF;">Cooking </span>import <span class="s56">checkAndCreateDir </span>import <span style=" color: #0CF;">h5py</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">PIL </span>import <span class="s56">Image</span><span class="s53">, </span><span class="s56">ImageDraw</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">math</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">matplotlib.pyplot </span>as <span style=" color: #0CF;">plt</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># &lt;&lt; The directory containing the cooked data from the previous step &gt;&gt;</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">COOKED_DATA_DIR <span style=" color: #000;">= </span><span style=" color: #C30;">&#39;data_cooked/&#39;</span></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># &lt;&lt; The directory in which the model output will be placed &gt;&gt;</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">MODEL_OUTPUT_DIR <span style=" color: #000;">= </span><span style=" color: #C30;">&#39;model&#39;</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Let’s also set up our datasets:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">train_dataset </span>= <span style=" color: #000087;">h5py</span>.<span style=" color: #000087;">File</span>(<span style=" color: #000087;">os</span>.<span style=" color: #000087;">path</span>.<span style=" color: #000087;">join</span>(<span style=" color: #000087;">COOKED_DATA_DIR</span>, <span style=" color: #C30;">&#39;train.h5&#39;</span>), <span style=" color: #C30;">&#39;r&#39;</span>) <span style=" color: #000087;">eval_dataset </span>= <span style=" color: #000087;">h5py</span>.<span style=" color: #000087;">File</span>(<span style=" color: #000087;">os</span>.<span style=" color: #000087;">path</span>.<span style=" color: #000087;">join</span>(<span style=" color: #000087;">COOKED_DATA_DIR</span>, <span style=" color: #C30;">&#39;eval.h5&#39;</span>), <span style=" color: #C30;">&#39;r&#39;</span>) <span style=" color: #000087;">test_dataset </span>= <span style=" color: #000087;">h5py</span>.<span style=" color: #000087;">File</span>(<span style=" color: #000087;">os</span>.<span style=" color: #000087;">path</span>.<span style=" color: #000087;">join</span>(<span style=" color: #000087;">COOKED_DATA_DIR</span>, <span style=" color: #C30;">&#39;test.h5&#39;</span>), <span style=" color: #C30;">&#39;r&#39;</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">num_train_examples </span>= <span style=" color: #000087;">train_dataset</span>[<span style=" color: #C30;">&#39;image&#39;</span>].<span style=" color: #000087;">shape</span>[<span style=" color: #F60;">O</span>] <span style=" color: #000087;">num_eval_examples </span>= <span style=" color: #000087;">eval_dataset</span>[<span style=" color: #C30;">&#39;image&#39;</span>].<span style=" color: #000087;">shape</span>[<span style=" color: #F60;">O</span>] <span style=" color: #000087;">num_test_examples </span>= <span style=" color: #000087;">test_dataset</span>[<span style=" color: #C30;">&#39;image&#39;</span>].<span style=" color: #000087;">shape</span>[<span style=" color: #F60;">O</span>]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">batch_size<span style=" color: #000;">=</span><span style=" color: #F60;">32</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s197" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1742">Drive Data Generator</a><a name="bookmark1794">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1795">We were introduced to the concept of Keras data generators in previous chapters. A data generator iterates through the dataset and reads data in chunks from the disk. This allows us to keep both our CPU and GPU busy, increasing throughput. To implement ideas discussed in the previous section we created our own Keras generator called </a><span class="s47">DriveDataGenerator</span>.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1035.png"/></span></p><p style="padding-top: 7pt;padding-left: 35pt;text-indent: -28pt;line-height: 139%;text-align: left;">Let’s recap some of our observations from the previous section: Our model should focus only on the ROI within each image.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1036.png"/></span></p><p style="padding-top: 7pt;padding-left: 35pt;text-indent: 0pt;text-align: left;">We can augment our dataset by flipping images horizontally and reversing the sign of the steering angle.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1037.png"/></span></p><p style="padding-top: 14pt;padding-left: 35pt;text-indent: 0pt;text-align: left;">We can further augment the data by introducing random brightness changes in the images. This will simulate different lighting conditions and make our model more robust.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1038.png"/></span></p><p style="padding-top: 14pt;padding-left: 35pt;text-indent: 0pt;text-align: left;">We can randomly drop a percentage of data points where the steering angle is zero so that the model sees a balanced dataset when training.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1039.png"/></span></p><p style="padding-top: 14pt;padding-left: 35pt;text-indent: 0pt;text-align: left;">Our overall number of data points available will be reduced significantly post-balancing.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 113%;text-align: left;">Let’s see how the <span class="s47">DriveDataGenerator </span>takes care of the first four of these items. We will return to last item when we begin designing our neural network.</p><p style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">The ROI is a simple image crop. [76,135,0,255] (shown in the code block that follows) is the [x1,x2,y1,y2] value of the rectangle representing the ROI. The generator extracts this rectangle from each image. We can use the parameter <span class="s47">roi </span>to modify the ROI.</p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">The horizontal flip is fairly straightforward. When generating batches, random images are flipped along the y-axis and their steering angle values are reversed if the parameter <span class="s47">horizontal_flip </span>is set to <span class="s47">True</span>.</p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">For random brightness changes, we introduce the parameter</p><p class="s47" style="padding-top: 1pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">brighten_range<span class="p">. Setting this parameter to </span>O.4 <span class="p">modifies the brightness</span></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 112%;text-align: left;">of images in any given batch randomly up to 40%. We do not recommend increasing this beyond <span class="s47">O.4</span>. To compute brightness, we transform the image from RGB to HSV space, scale the “V” coordinate up or down, and transform back to RGB.</p><p style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 113%;text-align: left;">For dataset balancing through dropping zeros, we introduce the parameter <span class="s47">zero_drop_percentage</span>. Setting this to <span class="s47">O.9 </span>will randomly drop 90% of the 0-label data points in any given batch.</p><p style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Let’s initialize our generator with these parameters:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">data_generator </span>= <span style=" color: #000087;">DriveDataGenerator</span>(<span style=" color: #000087;">rescale</span>=<span style=" color: #F60;">1.</span>/<span style=" color: #F60;">255.</span>, <span style=" color: #000087;">horizontal_flip</span>=<span class="s54">True</span>,</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">brighten_range</span>=<span style=" color: #F60;">O.4</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-top: 9pt;padding-left: 44pt;text-indent: -23pt;text-align: left;"><span style=" color: #000087;">train_generator </span>= <span style=" color: #000087;">data_generator</span>.<span style=" color: #000087;">flow</span>\ (<span style=" color: #000087;">train_dataset</span>[<span style=" color: #C30;">&#39;image&#39;</span>], <span style=" color: #000087;">train_dataset</span>[<span style=" color: #C30;">&#39;previous_state&#39;</span>], <span style=" color: #000087;">train_dataset</span>[<span style=" color: #C30;">&#39;label&#39;</span>], <span style=" color: #000087;">batch_size</span>=<span style=" color: #000087;">batch_size</span>,</p><p class="s53" style="padding-left: 44pt;text-indent: -23pt;text-align: left;"><span style=" color: #000087;">zero_drop_percentage</span>=<span style=" color: #F60;">O.95</span>, <span style=" color: #000087;">roi</span>=[<span style=" color: #F60;">76</span>,<span style=" color: #F60;">135</span>,<span style=" color: #F60;">O</span>,<span style=" color: #F60;">255</span>])</p><p class="s53" style="padding-left: 44pt;text-indent: -23pt;text-align: left;"><span style=" color: #000087;">eval_generator </span>= <span style=" color: #000087;">data_generator</span>.<span style=" color: #000087;">flow</span>\ (<span style=" color: #000087;">eval_dataset</span>[<span style=" color: #C30;">&#39;image&#39;</span>], <span style=" color: #000087;">eval_dataset</span>[<span style=" color: #C30;">&#39;previous_state&#39;</span>], <span style=" color: #000087;">eval_dataset</span>[<span style=" color: #C30;">&#39;label&#39;</span>],</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">batch_size</span>=<span style=" color: #000087;">batch_size</span>, <span style=" color: #000087;">zero_drop_percentage</span>=<span style=" color: #F60;">O.95</span>, <span style=" color: #000087;">roi</span>=[<span style=" color: #F60;">76</span>,<span style=" color: #F60;">135</span>,<span style=" color: #F60;">O</span>,<span style=" color: #F60;">255</span>]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Let’s visualize some sample data points by drawing labels (steering angle) over their corresponding images:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">def </span><span style=" color: #C0F;">draw_image_with_label</span>(<span style=" color: #000087;">img</span>, <span style=" color: #000087;">label</span>, <span style=" color: #000087;">prediction</span>=<span class="s54">None</span>):</p><p class="s56" style="padding-left: 21pt;text-indent: 23pt;text-align: left;">theta <span style=" color: #000;">= </span>label <span style=" color: #000;">* </span><span style=" color: #F60;">O.69 </span><span class="s60">#Steering range for the car is +- 40 degrees -&gt; 0.69</span></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># radians</p><p class="s53" style="padding-left: 44pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">line_length </span>= <span style=" color: #F60;">5O </span><span style=" color: #000087;">line_thickness </span>= <span style=" color: #F60;">3 </span><span style=" color: #000087;">label_line_color </span>= (<span style=" color: #F60;">255</span>, <span style=" color: #F60;">O</span>, <span style=" color: #F60;">O</span>)</p><p class="s53" style="padding-left: 44pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">prediction_line_color </span>= (<span style=" color: #F60;">O</span>, <span style=" color: #F60;">255</span>, <span style=" color: #F60;">255</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 23pt;text-align: left;"><span style=" color: #000087;">pil_image </span>= <span style=" color: #000087;">image</span>.<span style=" color: #000087;">array_to_img</span>(<span style=" color: #000087;">img</span>, <span style=" color: #000087;">K</span>.<span style=" color: #000087;">image_data_format</span>(), <span style=" color: #000087;">scale</span>=<span class="s54">True</span>)</p><p class="s53" style="padding-left: 44pt;text-indent: 0pt;text-align: left;"><span style=" color: #366;">print</span>(<span style=" color: #C30;">&#39;Actual Steering Angle = </span><span style=" color: #A00;">{O}</span><span style=" color: #C30;">&#39;</span>.<span style=" color: #000087;">format</span>(<span style=" color: #000087;">label</span>)) <span style=" color: #000087;">draw_image </span>= <span style=" color: #000087;">pil_image</span>.<span style=" color: #000087;">copy</span>()</p><p class="s53" style="padding-left: 44pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">image_draw </span>= <span style=" color: #000087;">ImageDraw</span>.<span style=" color: #000087;">Draw</span>(<span style=" color: #000087;">draw_image</span>) <span style=" color: #000087;">first_point </span>= (<span style=" color: #366;">int</span>(<span style=" color: #000087;">img</span>.<span style=" color: #000087;">shape</span>[<span style=" color: #F60;">1</span>]/<span style=" color: #F60;">2</span>), <span style=" color: #000087;">img</span>.<span style=" color: #000087;">shape</span>[<span style=" color: #F60;">O</span>])</p><p class="s53" style="padding-left: 21pt;text-indent: 23pt;text-align: left;"><span style=" color: #000087;">second_point </span>= (<span style=" color: #366;">int</span>((<span style=" color: #000087;">img</span>.<span style=" color: #000087;">shape</span>[<span style=" color: #F60;">1</span>]/<span style=" color: #F60;">2</span>) + (<span style=" color: #000087;">line_length </span>* <span style=" color: #000087;">math</span>.<span style=" color: #000087;">sin</span>(<span style=" color: #000087;">theta</span>))),</p><p class="s53" style="padding-left: 44pt;text-indent: -23pt;text-align: left;"><span style=" color: #366;">int</span>(<span style=" color: #000087;">img</span>.<span style=" color: #000087;">shape</span>[<span style=" color: #F60;">O</span>] - (<span style=" color: #000087;">line_length </span>* <span style=" color: #000087;">math</span>.<span style=" color: #000087;">cos</span>(<span style=" color: #000087;">theta</span>)))) <span style=" color: #000087;">image_draw</span>.<span style=" color: #000087;">line</span>([<span style=" color: #000087;">first_point</span>, <span style=" color: #000087;">second_point</span>], <span style=" color: #000087;">fill</span>=<span style=" color: #000087;">label_line_color</span>,</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">width<span style=" color: #000;">=</span>line_thickness<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 44pt;text-indent: 0pt;text-align: left;">if <span class="s53">(</span><span class="s56">prediction </span><span style=" color: #000;">is not </span>None<span class="s53">):</span></p><p class="s53" style="padding-left: 67pt;text-indent: 0pt;text-align: left;"><span style=" color: #366;">print</span>(<span style=" color: #C30;">&#39;Predicted Steering Angle = </span><span style=" color: #A00;">{O}</span><span style=" color: #C30;">&#39;</span>.<span style=" color: #000087;">format</span>(<span style=" color: #000087;">prediction</span>)) <span style=" color: #366;">print</span>(<span style=" color: #C30;">&#39;L1 Error: </span><span style=" color: #A00;">{O}</span><span style=" color: #C30;">&#39;</span>.<span style=" color: #000087;">format</span>(<span style=" color: #366;">abs</span>(<span style=" color: #000087;">prediction</span>-<span style=" color: #000087;">label</span>)))</p><p class="s56" style="padding-left: 67pt;text-indent: 0pt;text-align: left;">theta <span style=" color: #000;">= </span>prediction <span style=" color: #000;">* </span><span style=" color: #F60;">O.69</span></p><p class="s53" style="padding-left: 21pt;text-indent: 46pt;text-align: left;"><span style=" color: #000087;">second_point </span>= (<span style=" color: #366;">int</span>((<span style=" color: #000087;">img</span>.<span style=" color: #000087;">shape</span>[<span style=" color: #F60;">1</span>]/<span style=" color: #F60;">2</span>) + ((<span style=" color: #000087;">line_length</span>/<span style=" color: #F60;">2</span>) * <span style=" color: #000087;">math</span>.<span style=" color: #000087;">sin</span>(<span style=" color: #000087;">theta</span>))), <span style=" color: #366;">int</span>(<span style=" color: #000087;">img</span>.<span style=" color: #000087;">shape</span>[<span style=" color: #F60;">O</span>] - ((<span style=" color: #000087;">line_length</span>/<span style=" color: #F60;">2</span>) * <span style=" color: #000087;">math</span>.<span style=" color: #000087;">cos</span>(<span style=" color: #000087;">theta</span>))))</p><p class="s56" style="padding-top: 4pt;padding-left: 21pt;text-indent: 46pt;text-align: left;">image_draw<span style=" color: #000;">.</span>line<span style=" color: #000;">([</span>first_point<span style=" color: #000;">, </span>second_point<span style=" color: #000;">], </span>fill<span style=" color: #000;">=</span>prediction_line_color<span style=" color: #000;">,</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">width</span>=<span style=" color: #000087;">line_thickness </span>* <span style=" color: #F60;">3</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 44pt;text-indent: 0pt;text-align: left;"><span class="s54">del </span>image_draw plt<span style=" color: #000;">.</span>imshow<span style=" color: #000;">(</span>draw_image<span style=" color: #000;">) </span>plt<span style=" color: #000;">.</span>show<span style=" color: #000;">()</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">[<span style=" color: #000087;">sample_batch_train_data</span>, <span style=" color: #000087;">sample_batch_test_data</span>] = <span style=" color: #366;">next</span>(<span style=" color: #000087;">train_generator</span>)</p><p class="s53" style="padding-left: 44pt;text-indent: -23pt;text-align: left;"><span class="s54">for </span><span style=" color: #000087;">i </span><b>in </b><span style=" color: #366;">range</span>(<span style=" color: #F60;">O</span>, <span style=" color: #F60;">3</span>, <span style=" color: #F60;">1</span>): <span style=" color: #000087;">draw_image_with_label</span>(<span style=" color: #000087;">sample_batch_train_data</span>[<span style=" color: #F60;">O</span>][<span style=" color: #000087;">i</span>],</p><p class="s56" style="padding-left: 67pt;text-indent: 0pt;text-align: left;">sample_batch_test_data<span style=" color: #000;">[</span>i<span style=" color: #000;">])</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark1796" class="s63">We should see an output similar to </a>Figure 16-13<span style=" color: #000;">. Observe that we are now looking at only the ROI when training the model, thereby ignoring all the nonrelevant information present in the original images. The line indicates the ground truth steering angle. This is the angle the car was driving at when that image was taken by the camera during data collection.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><span><img width="354" height="399" alt="image" src="KerasTensorFlow2019/Image_1040.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1796">Figure 16-13. Drawing steering angles on images</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s197" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1743">Model Definition</a><a name="bookmark1797">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">We are now ready to define the architecture of our neural network. It is here that we must take into account the problem of our dataset being very limited in size after removing zeros. Because of this limitation, we cannot build a network that is too deep. Because we are dealing with images, we will need a few convolutional/max- pooling pairs to extract features.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Images alone, however, might not be enough to lead our model to convergence. Using only images to train also does not align with how driving decisions are made in the real world. When driving down the road, we are not only perceiving our surrounding environment, we are also aware of how fast we are going, how much we are turning and, the state of our gas and brake pedals. Input from sensors like cameras, lidars, radars, and so on being fed into a neural network corresponds to only one portion of all information a driver has at hand while making a driving decision in the real world.</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">An image presented to our neural network could have been taken from a stationary car or a car driving at 60 mph; the network would have no way of knowing which. Turning the steering wheel by two degrees to the right while driving at 5 mph will yield very different results compared to doing the same at 50 mph. In short, a model trying to predict steering angles should not rely on sensory input alone. It also needs information about the current state of the car. Thankfully for us, we do have this information available.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">At the end of the previous section, we noted that our datasets have four parts. For each image, in addition to the steering angle label and metadata, we also recorded the last known state of the car corresponding to the image. This was stored in the form of a (steering, throttle, brake, speed) tuple, and we will use this information, along with our images, as input to the neural network.</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Note that this does not violate our “Hello, World!” requirements, because we are still using the single camera as our only external sensor.</p><p class="s45" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark1798" class="s63">Putting all we discussed together, you can see the neural network that we will be using for this problem in </a>Figure 16-14<span style=" color: #000;">. We are using</span></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">three convolutional layers with 16, 32, 32 filters, respectively, and a (3,3) convolutional window. We are merging the image features (output from convolutional layers) with an input layer supplying the previous state of the car. The combined feature set is then passed through two fully connected layers with 64 and 10 hidden neurons, respectively. The activation function used in our network is ReLU. Notice that unlike the classification problems we have been working on in previous chapters, the last layer of our network is a single neuron with no activation. This is because the problem we are trying to solve is a regression problem. The output of our network is the steering angle, a floating-point number, unlike the discrete classes that we were predicting earlier.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 59pt;text-indent: 0pt;text-align: left;"><a name="bookmark1798"><span><img width="446" height="888" alt="image" src="KerasTensorFlow2019/Image_1041.jpg"/></span></a></p><p class="s50" style="padding-top: 3pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">Figure 16-14. Network architecture</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Let’s now implement our network. We can use <span class="s47">model.summary()</span>:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: justify;"><span style=" color: #000087;">image_input_shape </span>= <span style=" color: #000087;">sample_batch_train_data</span>[<span style=" color: #F60;">O</span>].<span style=" color: #000087;">shape</span>[<span style=" color: #F60;">1</span>:] <span style=" color: #000087;">state_input_shape </span>= <span style=" color: #000087;">sample_batch_train_data</span>[<span style=" color: #F60;">1</span>].<span style=" color: #000087;">shape</span>[<span style=" color: #F60;">1</span>:] <span style=" color: #000087;">activation </span>= <span style=" color: #C30;">&#39;relu&#39;</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: justify;"># Create the convolutional stacks</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: justify;">pic_input <span style=" color: #000;">= </span>Input<span style=" color: #000;">(</span>shape<span style=" color: #000;">=</span>image_input_shape<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">img_stack </span>= <span style=" color: #000087;">Conv2D</span>(<span style=" color: #F60;">16</span>, (<span style=" color: #F60;">3</span>, <span style=" color: #F60;">3</span>), <span style=" color: #000087;">name</span>=<span style=" color: #C30;">&quot;convolutionO&quot;</span>, <span style=" color: #000087;">padding</span>=<span style=" color: #C30;">&#39;same&#39;</span>, <span style=" color: #000087;">activation</span>=<span style=" color: #000087;">activation</span>)(<span style=" color: #000087;">pic_input</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">img_stack </span>= <span style=" color: #000087;">MaxPooling2D</span>(<span style=" color: #000087;">pool_size</span>=(<span style=" color: #F60;">2</span>,<span style=" color: #F60;">2</span>))(<span style=" color: #000087;">img_stack</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">img_stack </span>= <span style=" color: #000087;">Conv2D</span>(<span style=" color: #F60;">32</span>, (<span style=" color: #F60;">3</span>, <span style=" color: #F60;">3</span>), <span style=" color: #000087;">activation</span>=<span style=" color: #000087;">activation</span>, <span style=" color: #000087;">padding</span>=<span style=" color: #C30;">&#39;same&#39;</span>, <span style=" color: #000087;">name</span>=<span style=" color: #C30;">&#39;convolution1&#39;</span>)(<span style=" color: #000087;">img_stack</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">img_stack </span>= <span style=" color: #000087;">MaxPooling2D</span>(<span style=" color: #000087;">pool_size</span>=(<span style=" color: #F60;">2</span>, <span style=" color: #F60;">2</span>))(<span style=" color: #000087;">img_stack</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">img_stack </span>= <span style=" color: #000087;">Conv2D</span>(<span style=" color: #F60;">32</span>, (<span style=" color: #F60;">3</span>, <span style=" color: #F60;">3</span>), <span style=" color: #000087;">activation</span>=<span style=" color: #000087;">activation</span>, <span style=" color: #000087;">padding</span>=<span style=" color: #C30;">&#39;same&#39;</span>, <span style=" color: #000087;">name</span>=<span style=" color: #C30;">&#39;convolution2&#39;</span>)(<span style=" color: #000087;">img_stack</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">img_stack </span>= <span style=" color: #000087;">MaxPooling2D</span>(<span style=" color: #000087;">pool_size</span>=(<span style=" color: #F60;">2</span>, <span style=" color: #F60;">2</span>))(<span style=" color: #000087;">img_stack</span>) <span style=" color: #000087;">img_stack </span>= <span style=" color: #000087;">Flatten</span>()(<span style=" color: #000087;">img_stack</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">img_stack </span>= <span style=" color: #000087;">Dropout</span>(<span style=" color: #F60;">O.2</span>)(<span style=" color: #000087;">img_stack</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Inject the state input</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">state_input <span style=" color: #000;">= </span>Input<span style=" color: #000;">(</span>shape<span style=" color: #000;">=</span>state_input_shape<span style=" color: #000;">) </span>merged <span style=" color: #000;">= </span>concatenate<span style=" color: #000;">([</span>img_stack<span style=" color: #000;">, </span>state_input<span style=" color: #000;">])</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># Add a few dense layers to finish the model</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">merged </span>= <span style=" color: #000087;">Dense</span>(<span style=" color: #F60;">64</span>, <span style=" color: #000087;">activation</span>=<span style=" color: #000087;">activation</span>, <span style=" color: #000087;">name</span>=<span style=" color: #C30;">&#39;denseO&#39;</span>)(<span style=" color: #000087;">merged</span>) <span style=" color: #000087;">merged </span>= <span style=" color: #000087;">Dropout</span>(<span style=" color: #F60;">O.2</span>)(<span style=" color: #000087;">merged</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">merged </span>= <span style=" color: #000087;">Dense</span>(<span style=" color: #F60;">1O</span>, <span style=" color: #000087;">activation</span>=<span style=" color: #000087;">activation</span>, <span style=" color: #000087;">name</span>=<span style=" color: #C30;">&#39;dense2&#39;</span>)(<span style=" color: #000087;">merged</span>) <span style=" color: #000087;">merged </span>= <span style=" color: #000087;">Dropout</span>(<span style=" color: #F60;">O.2</span>)(<span style=" color: #000087;">merged</span>)</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">merged </span>= <span style=" color: #000087;">Dense</span>(<span style=" color: #F60;">1</span>, <span style=" color: #000087;">name</span>=<span style=" color: #C30;">&#39;output&#39;</span>)(<span style=" color: #000087;">merged</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">adam </span>= <span style=" color: #000087;">Nadam</span>(<span style=" color: #000087;">lr</span>=<span style=" color: #F60;">O.OOO1</span>, <span style=" color: #000087;">beta_1</span>=<span style=" color: #F60;">O.9</span>, <span style=" color: #000087;">beta_2</span>=<span style=" color: #F60;">O.999</span>, <span style=" color: #000087;">epsilon</span>=<span style=" color: #F60;">1e-O8</span>) <span style=" color: #000087;">model </span>= <span style=" color: #000087;">Model</span>(<span style=" color: #000087;">inputs</span>=[<span style=" color: #000087;">pic_input</span>, <span style=" color: #000087;">state_input</span>], <span style=" color: #000087;">outputs</span>=<span style=" color: #000087;">merged</span>) <span style=" color: #000087;">model</span>.<span style=" color: #000087;">compile</span>(<span style=" color: #000087;">optimizer</span>=<span style=" color: #000087;">adam</span>, <span style=" color: #000087;">loss</span>=<span style=" color: #C30;">&#39;mse&#39;</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s70" style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1744">Callbacks</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1799">One of the nice features of Keras is the ability to declare </a><i>callbacks</i>. Callbacks are functions that are executed after each epoch of training and help us to gain an insight into the training process as well as control hyperparameters to an extent. They also let us define conditions to perform certain actions while training is underway; for example, stopping the training early if the loss stops decreasing. We will use a few callbacks for our experiment:</p><p class="s202" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">ReduceLROnPlateau</p><p style="padding-top: 3pt;padding-left: 35pt;text-indent: 0pt;text-align: left;">If the model is near a minimum and the learning rate is too high, the model will circle around that minimum without ever reaching it. This callback will allow the model to reduce its learning rate when the validation loss hits a plateau and stops improving, allowing us to reach the optimal point.</p><p class="s202" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">CSVLogger</p><p style="padding-top: 3pt;padding-left: 35pt;text-indent: 0pt;text-align: left;">This lets us log the output of the model after each epoch into a CSV file, which will allow us to track the progress without needing to use the console.</p><p class="s202" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">ModelCheckpoint</p><p style="padding-top: 3pt;padding-left: 35pt;text-indent: 0pt;text-align: left;">Generally, we will want to use the model that has the lowest loss on the validation set. This callback will save the model each time the validation loss improves.</p><p class="s202" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">EarlyStopping</p><p style="padding-top: 3pt;padding-left: 35pt;text-indent: 0pt;text-align: left;"><a name="bookmark1800">We will want to stop training when the validation loss stops improving. Otherwise, we risk overfitting. This option will detect when the validation loss stops improving and will stop the training process when that occurs.</a></p><p style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Let’s now go ahead and implement these callbacks:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">plateau_callback </span>= <span style=" color: #000087;">ReduceLROnPlateau</span>(<span style=" color: #000087;">monitor</span>=<span style=" color: #C30;">&#39;val_loss&#39;</span>, <span style=" color: #000087;">factor</span>=<span style=" color: #F60;">O.5</span>, <span style=" color: #000087;">patience</span>=<span style=" color: #F60;">3</span>,</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">min_lr</span>=<span style=" color: #F60;">O.OOO1</span>, <span style=" color: #000087;">verbose</span>=<span style=" color: #F60;">1</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">checkpoint_filepath </span>= <span style=" color: #000087;">os</span>.<span style=" color: #000087;">path</span>.<span style=" color: #000087;">join</span>(<span style=" color: #000087;">MODEL_OUTPUT_DIR</span>, <span style=" color: #C30;">&#39;models&#39;</span>, <span style=" color: #C30;">&#39;</span><span style=" color: #A00;">{O}</span><span style=" color: #C30;">_model.</span><span style=" color: #A00;">{1}</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">-{<span style=" color: #F60;">2</span>}.<span style=" color: #000087;">h5</span><span style=" color: #C30;">&#39;.format(&#39;</span><span style=" color: #000087;">model</span><span style=" color: #C30;">&#39;, &#39;</span>{<span style=" color: #000087;">epoch</span>:<span style=" color: #F60;">O2</span><span style=" color: #000087;">d</span>}<span style=" color: #C30;">&#39;, &#39;</span>{<span style=" color: #000087;">val_loss</span>:.<span style=" color: #F60;">7</span><span style=" color: #000087;">f</span>}<span style=" color: #C30;">&#39;)) </span><span style=" color: #000087;">checkAndCreateDir</span>(<span style=" color: #000087;">checkpoint_filepath</span>) <span style=" color: #000087;">checkpoint_callback </span>= <span style=" color: #000087;">ModelCheckpoint</span>(<span style=" color: #000087;">checkpoint_filepath</span>, <span style=" color: #000087;">save_best_only</span>=<span class="s54">True</span>,</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">verbose</span>=<span style=" color: #F60;">1</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">csv_callback </span>= <span style=" color: #000087;">CSVLogger</span>(<span style=" color: #000087;">os</span>.<span style=" color: #000087;">path</span>.<span style=" color: #000087;">join</span>(<span style=" color: #000087;">MODEL_OUTPUT_DIR</span>, <span style=" color: #C30;">&#39;training_log.csv&#39;</span>))</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">early_stopping_callback </span>= <span style=" color: #000087;">EarlyStopping</span>(<span style=" color: #000087;">monitor</span>=<span style=" color: #C30;">&#39;val_loss&#39;</span>, <span style=" color: #000087;">patience</span>=<span style=" color: #F60;">1O</span>,</p><p class="s53" style="padding-left: 368pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">verbose</span>=<span style=" color: #F60;">1</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-top: 5pt;padding-left: 21pt;text-indent: 0pt;text-align: left;">nbcallback <span style=" color: #000;">= </span>TQDMNotebookCallback<span style=" color: #000;">()</span></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #366;">setattr</span>(<span style=" color: #000087;">nbcallback</span>, <span style=" color: #C30;">&#39;on_train_batch_begin&#39;</span>, <span class="s54">lambda </span><span style=" color: #000087;">x</span>,<span style=" color: #000087;">y</span>: <span class="s54">None</span>) <span style=" color: #366;">setattr</span>(<span style=" color: #000087;">nbcallback</span>, <span style=" color: #C30;">&#39;on_train_batch_end&#39;</span>, <span class="s54">lambda </span><span style=" color: #000087;">x</span>,<span style=" color: #000087;">y</span>: <span class="s54">None</span>) <span style=" color: #366;">setattr</span>(<span style=" color: #000087;">nbcallback</span>, <span style=" color: #C30;">&#39;on_test_begin&#39;</span>, <span class="s54">lambda </span><span style=" color: #000087;">x</span>: <span class="s54">None</span>) <span style=" color: #366;">setattr</span>(<span style=" color: #000087;">nbcallback</span>, <span style=" color: #C30;">&#39;on_test_end&#39;</span>, <span class="s54">lambda </span><span style=" color: #000087;">x</span>: <span class="s54">None</span>) <span style=" color: #366;">setattr</span>(<span style=" color: #000087;">nbcallback</span>, <span style=" color: #C30;">&#39;on_test_batch_begin&#39;</span>, <span class="s54">lambda </span><span style=" color: #000087;">x</span>,<span style=" color: #000087;">y</span>: <span class="s54">None</span>) <span style=" color: #366;">setattr</span>(<span style=" color: #000087;">nbcallback</span>, <span style=" color: #C30;">&#39;on_test_batch_end&#39;</span>, <span class="s54">lambda </span><span style=" color: #000087;">x</span>,<span style=" color: #000087;">y</span>: <span class="s54">None</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">callbacks<span style=" color: #000;">=[</span>plateau_callback<span style=" color: #000;">, </span>csv_callback<span style=" color: #000;">, </span>checkpoint_callback<span style=" color: #000;">, </span>early_stopping_callback<span style=" color: #000;">, </span>nbcallback<span style=" color: #000;">]</span></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">We’re now all set to kick off training. The model will take a while to train, so this will make for a nice Netflix break. The training process should terminate with a validation loss of approximately .0003:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">history </span>= <span style=" color: #000087;">model</span>.<span style=" color: #000087;">fit_generator</span>(<span style=" color: #000087;">train_generator</span>, <span style=" color: #000087;">steps_per_epoch</span>=<span style=" color: #000087;">num_train_examples </span>// <span style=" color: #000087;">batch_size</span>, <span style=" color: #000087;">epochs</span>=<span style=" color: #F60;">5OO</span>,</p><p class="s53" style="padding-left: 67pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">callbacks</span>=<span style=" color: #000087;">callbacks</span>, <span style=" color: #000087;">validation_data</span>=<span style=" color: #000087;">eval_generator</span>, <span style=" color: #000087;">validation_steps</span>=<span style=" color: #000087;">num_eval_examples </span>// <span style=" color: #000087;">batch_size</span>, <span style=" color: #000087;">verbose</span>=<span style=" color: #F60;">2</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">Epoch 1/5OO</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">Epoch OOOO1: val_loss improved from inf to O.O2338, saving model to model\models\model_model.O1-O.O233783.h5</p><ul id="l55"><li><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">442s - loss: O.O225 - val_loss: O.O234 Epoch 2/5OO</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">Epoch OOOO2: val_loss improved from O.O2338 to O.OO859, saving model to model\models\model_model.O2-O.OO85879.h5</p></li><li><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">37s - loss: O.O184 - val_loss: O.OO86 Epoch 3/5OO</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">Epoch OOOO3: val_loss improved from O.OO859 to O.OO188, saving model to model\models\model_model.O3-O.OO18831.h5</p></li><li><p class="s53" style="padding-left: 32pt;text-indent: -11pt;text-align: left;">38s - loss: O.OO64 - val_loss: O.OO19</p></li></ul><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">…………………………….</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Our model is now trained and ready to go. Before we see it in action, let’s do a quick sanity check and plot some predictions against images:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">[<span style=" color: #000087;">sample_batch_train_data</span>, <span style=" color: #000087;">sample_batch_test_data</span>] = <span style=" color: #366;">next</span>(<span style=" color: #000087;">train_generator</span>) <span style=" color: #000087;">predictions </span>= <span style=" color: #000087;">model</span>.<span style=" color: #000087;">predict</span>([<span style=" color: #000087;">sample_batch_train_data</span>[<span style=" color: #F60;">O</span>], <span style=" color: #000087;">sample_batch_train_data</span>[<span style=" color: #F60;">1</span>]])</p><p class="s53" style="padding-left: 44pt;text-indent: -23pt;text-align: left;"><span class="s54">for </span><span style=" color: #000087;">i </span><b>in </b><span style=" color: #366;">range</span>(<span style=" color: #F60;">O</span>, <span style=" color: #F60;">3</span>, <span style=" color: #F60;">1</span>): <span style=" color: #000087;">draw_image_with_label</span>(<span style=" color: #000087;">sample_batch_train_data</span>[<span style=" color: #F60;">O</span>][<span style=" color: #000087;">i</span>],</p><p class="s56" style="padding-left: 171pt;text-indent: 0pt;text-align: left;">sample_batch_test_data<span style=" color: #000;">[</span>i<span style=" color: #000;">], </span>predictions<span style=" color: #000;">[</span>i<span style=" color: #000;">])</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark1802" class="s63" name="bookmark1801">We should see an output similar to </a>Figure 16-15<span style=" color: #000;">. In this figure, the thick line is the predicted output, and the thin line is the label output. Looks like our predictions are fairly accurate (we can also see the actual and predicted values above the images). Time to deploy our model and see it in action.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 88pt;text-indent: 0pt;text-align: left;"><span><img width="354" height="522" alt="image" src="KerasTensorFlow2019/Image_1042.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s50" style="padding-top: 4pt;padding-left: 40pt;text-indent: 0pt;text-align: left;"><a name="bookmark1802">Figure 16-15. Drawing actual and predicted steering angles on images</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s196" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1745">Deploying Our Autonomous Driving Model</a><a name="bookmark1803">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="https://oreil.ly/5saDl" class="s63" target="_blank" name="bookmark1804">All of the steps in this section are also detailed in the Jupyter Notebook </a><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14.5pt;">TestModel.ipynb</span>. Now that we have our model trained, it is time to spin up our simulator and use our model to drive our car around.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">As before, begin by importing some libraries and defining paths:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">tensorflow.keras.models </span>import <span class="s56">load_model</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">sys</span></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">import <span style=" color: #0CF;">numpy </span>as <span style=" color: #0CF;">np </span>import <span style=" color: #0CF;">glob </span>import <span style=" color: #0CF;">os</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 44pt;text-indent: -23pt;text-align: left;"><span class="s54">if </span>(<span style=" color: #C30;">&#39;../../PythonClient/&#39; </span><b>not in </b><span style=" color: #000087;">sys</span>.<span style=" color: #000087;">path</span>): <span style=" color: #000087;">sys</span>.<span style=" color: #000087;">path</span>.<span style=" color: #000087;">insert</span>(<span style=" color: #F60;">O</span>, <span style=" color: #C30;">&#39;../../PythonClient/&#39;</span>)</p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">from <span style=" color: #0CF;">AirSimClient </span>import <span class="s53">*</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># &lt;&lt; Set this to the path of the model &gt;&gt;</p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># If None, then the model with the lowest validation loss from training will be</p><p class="s60" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"># used</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">MODEL_PATH <span style=" color: #000;">= </span><span class="s54">None</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">if </span>(<span style=" color: #000087;">MODEL_PATH </span>== <span class="s54">None</span>):</p><p class="s53" style="padding-left: 44pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">models </span>= <span style=" color: #000087;">glob</span>.<span style=" color: #000087;">glob</span>(<span style=" color: #C30;">&#39;model/models/*.h5&#39;</span>) <span style=" color: #000087;">best_model </span>= <span style=" color: #366;">max</span>(<span style=" color: #000087;">models</span>, <span style=" color: #000087;">key</span>=<span style=" color: #000087;">os</span>.<span style=" color: #000087;">path</span>.<span style=" color: #000087;">getctime</span>)</p><p class="s56" style="padding-left: 44pt;text-indent: 0pt;text-align: left;">MODEL_PATH <span style=" color: #000;">= </span>best_model</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #366;">print</span>(<span style=" color: #C30;">&#39;Using model </span><span style=" color: #A00;">{O} </span><span style=" color: #C30;">for testing.&#39;</span>.<span style=" color: #000087;">format</span>(<span style=" color: #000087;">MODEL_PATH</span>))</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Next, load the model and connect to AirSim in the Landscape environment. To start the simulator, on a Windows machine, open a PowerShell command window at the location where we unzipped the simulator package and run the following:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">.\AD_Cookbook_Start_AirSim.ps1 landscape</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Back in the Jupyter Notebook, run the following to connect the model to the AirSim client. Ensure that the simulator is running <i>before </i>kicking this off:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">model <span style=" color: #000;">= </span>load_model<span style=" color: #000;">(</span>MODEL_PATH<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">client </span>= <span style=" color: #000087;">CarClient</span>() <span style=" color: #000087;">client</span>.<span style=" color: #000087;">confirmConnection</span>() <span style=" color: #000087;">client</span>.<span style=" color: #000087;">enableApiControl</span>(<span class="s54">True</span>) <span style=" color: #000087;">car_controls </span>= <span style=" color: #000087;">CarControls</span>() <span style=" color: #366;">print</span>(<span style=" color: #C30;">&#39;Connection established!&#39;</span>)</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">With the connection established, let’s now set the initial state of the car as well as some buffers used to store the output from the model:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: justify;">car_controls<span style=" color: #000;">.</span>steering <span style=" color: #000;">= </span><span style=" color: #F60;">O </span>car_controls<span style=" color: #000;">.</span>throttle <span style=" color: #000;">= </span><span style=" color: #F60;">O </span>car_controls<span style=" color: #000;">.</span>brake <span style=" color: #000;">= </span><span style=" color: #F60;">O</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">image_buf </span>= <span style=" color: #000087;">np</span>.<span style=" color: #000087;">zeros</span>((<span style=" color: #F60;">1</span>, <span style=" color: #F60;">59</span>, <span style=" color: #F60;">255</span>, <span style=" color: #F60;">3</span>)) <span style=" color: #000087;">state_buf </span>= <span style=" color: #000087;">np</span>.<span style=" color: #000087;">zeros</span>((<span style=" color: #F60;">1</span>,<span style=" color: #F60;">4</span>))</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">The next step is to set up the model to expect an RGB image from the simulator as the input. We need to define a helper function for this:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">def <span class="s61">get_image</span><span class="s53">():</span></p><p class="s53" style="padding-left: 21pt;text-indent: 23pt;text-align: left;"><span style=" color: #000087;">image_response </span>= <span style=" color: #000087;">client</span>.<span style=" color: #000087;">simGetImages</span>([<span style=" color: #000087;">ImageRequest</span>(<span style=" color: #F60;">O</span>, <span style=" color: #000087;">AirSimImageType</span>.<span style=" color: #000087;">Scene</span>,</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span class="s54">False</span>, <span class="s54">False</span>)])[<span style=" color: #F60;">O</span>]</p><p class="s56" style="padding-left: 21pt;text-indent: 23pt;text-align: left;">image1d <span style=" color: #000;">= </span>np<span style=" color: #000;">.</span>fromstring<span style=" color: #000;">(</span>image_response<span style=" color: #000;">.</span>image_data_uint8<span style=" color: #000;">, </span>dtype<span style=" color: #000;">=</span>np<span style=" color: #000;">.</span>uint8<span style=" color: #000;">)</span></p><p class="s53" style="padding-left: 21pt;text-indent: 23pt;text-align: left;"><span style=" color: #000087;">image_rgba </span>= <span style=" color: #000087;">image1d</span>.<span style=" color: #000087;">reshape</span>(<span style=" color: #000087;">image_response</span>.<span style=" color: #000087;">height</span>, <span style=" color: #000087;">image_response</span>.<span style=" color: #000087;">width</span>, <span style=" color: #F60;">4</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 44pt;text-indent: 0pt;text-align: left;"><span class="s54">return </span><span style=" color: #000087;">image_rgba</span>[<span style=" color: #F60;">76</span>:<span style=" color: #F60;">135</span>,<span style=" color: #F60;">O</span>:<span style=" color: #F60;">255</span>,<span style=" color: #F60;">O</span>:<span style=" color: #F60;">3</span>].<span style=" color: #000087;">astype</span>(<span style=" color: #366;">float</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Finally, let’s set up an infinite loop for our model to read an image from the simulator along with the current state of the car, predict the steering angle, and send it back to the simulator. Because our model predicts only steering angles, we will need to supply a control signal to maintain speed ourselves. Let’s set it up so that the car will attempt to run at a constant 5 m/s:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">while <span class="s53">(</span>True<span class="s53">):</span></p><p class="s56" style="padding-left: 44pt;text-indent: 0pt;text-align: left;">car_state <span style=" color: #000;">= </span>client<span style=" color: #000;">.</span>getCarState<span style=" color: #000;">()</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 67pt;text-indent: -23pt;text-align: left;"><span class="s54">if </span>(<span style=" color: #000087;">car_state</span>.<span style=" color: #000087;">speed </span>&lt; <span style=" color: #F60;">5</span>): <span style=" color: #000087;">car_controls</span>.<span style=" color: #000087;">throttle </span>= <span style=" color: #F60;">1.O</span></p><p class="s54" style="padding-left: 44pt;text-indent: 0pt;text-align: left;">else<span class="s53">:</span></p><p class="s56" style="padding-left: 67pt;text-indent: 0pt;text-align: left;">car_controls<span style=" color: #000;">.</span>throttle <span style=" color: #000;">= </span><span style=" color: #F60;">O.O</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 44pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">image_buf</span>[<span style=" color: #F60;">O</span>] = <span style=" color: #000087;">get_image</span>()</p><p class="s53" style="padding-left: 21pt;text-indent: 23pt;text-align: left;"><span style=" color: #000087;">state_buf</span>[<span style=" color: #F60;">O</span>] = <span style=" color: #000087;">np</span>.<span style=" color: #000087;">array</span>([<span style=" color: #000087;">car_controls</span>.<span style=" color: #000087;">steering</span>, <span style=" color: #000087;">car_controls</span>.<span style=" color: #000087;">throttle</span>,</p><p class="s56" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">car_controls<span style=" color: #000;">.</span>brake<span style=" color: #000;">, </span>car_state<span style=" color: #000;">.</span>speed<span style=" color: #000;">])</span></p><p class="s53" style="padding-left: 44pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">model_output </span>= <span style=" color: #000087;">model</span>.<span style=" color: #000087;">predict</span>([<span style=" color: #000087;">image_buf</span>, <span style=" color: #000087;">state_buf</span>]) <span style=" color: #000087;">car_controls</span>.<span style=" color: #000087;">steering </span>= <span style=" color: #366;">round</span>(<span style=" color: #F60;">O.5 </span>* <span style=" color: #366;">float</span>(<span style=" color: #000087;">model_output</span>[<span style=" color: #F60;">O</span>][<span style=" color: #F60;">O</span>]), <span style=" color: #F60;">2</span>)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s57" style="padding-left: 44pt;text-indent: 0pt;text-align: left;"><span style=" color: #366;">print</span><span style=" color: #000;">(</span>&#39;Sending steering = <span style=" color: #A00;">{O}</span>, throttle =</p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;"><span style=" color: #A00;">{1}</span><span style=" color: #C30;">&#39;</span>.<span style=" color: #000087;">format</span>(<span style=" color: #000087;">car_controls</span>.<span style=" color: #000087;">steering</span>, <span style=" color: #000087;">car_controls</span>.<span style=" color: #000087;">throttle</span>))</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s56" style="padding-left: 44pt;text-indent: 0pt;text-align: left;">client<span style=" color: #000;">.</span>setCarControls<span style=" color: #000;">(</span>car_controls<span style=" color: #000;">)</span></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">We should see output similar to the following:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s53" style="padding-left: 21pt;text-indent: 0pt;text-align: left;">Sending steering = O.O3, throttle = 1.O Sending steering = O.O3, throttle = 1.O Sending steering = O.O3, throttle = 1.O Sending steering = O.O3, throttle = 1.O Sending steering = O.O3, throttle = 1.O Sending steering = -O.1, throttle = 1.O Sending steering = -O.12, throttle = 1.O Sending steering = -O.13, throttle = 1.O Sending steering = -O.13, throttle = 1.O Sending steering = -O.13, throttle = 1.O Sending steering = -O.14, throttle = 1.O Sending steering = -O.15, throttle = 1.O</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">We did it! The car is driving around nicely on the road, keeping to the right side, for the most part, carefully navigating all the sharp turns and instances where it could potentially go off the road. Kudos on training our first-ever autonomous driving model!</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 82pt;text-indent: 0pt;text-align: left;"><span><img width="384" height="208" alt="image" src="KerasTensorFlow2019/Image_1043.jpg"/></span></p><p class="s50" style="padding-top: 7pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">Figure 16-16. Trained model driving the car</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 7pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Before we wrap up, there are a couple of things worth noting. First, notice that the motion of the car is not perfectly smooth. This is because we are working with a regression problem and making a steering angle prediction for every image frame seen by the car. One way to fix this would be to average out predictions over a buffer of consecutive images. Another idea could be to turn this into a classification problem. More specifically, we could define buckets for the steering angles (..., –0.1, –0.05, 0, 0.05, 0.1, ...), bucketize the labels, and predict the correct bucket for each image.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">If we let the model run for a while (a little more than five minutes), we observe that the car eventually veers off the road randomly and</p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1805">crashes. This happens on a portion of the track with a steep incline. Remember our last requirement during the problem setup? Elevation changes require manipulating throttle and brakes. Because our model can control only the steering angle, it doesn’t do too well on steep roads.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s196" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1746">Further Exploration</a><a name="bookmark1806">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1807">Having been trained on the “Hello, World!” scenario, our model is obviously not a perfect driver but don’t be disheartened. Keep in mind that we have barely scratched the surface of the possibilities at the intersection of deep learning and self-driving cars. The fact that we were able to have our car learn to drive around almost perfectly using a very small dataset is something to be proud of!</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="595" height="730" alt="image" src="KerasTensorFlow2019/Image_1044.png"/></span></p><p class="s48" style="padding-top: 4pt;padding-left: 180pt;text-indent: -162pt;text-align: left;">END-TO-END DEEP LEARNING FOR SELF-DRIVING CARS OF THE REAL WORLD!</p><p class="s49" style="padding-top: 5pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a name="bookmark1808">At the beginning of 2016, end-to-end deep learning gained popularity among roboticists. The hypothesis was that given enough visual data, a DNN should be able to learn a task in an “end-to-end” manner, mapping inputs directly to actions. Hence, it should be possible to train robots to perform complicated tasks using only image-based input from cameras into DNNs, resulting in actions.</a></p><p class="s79" style="padding-top: 5pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1810" class="s140" name="bookmark1809">One of the most popular works on this in the context of autonomous driving came from NVIDIA when it introduced its DAVE-2 system to the world. Unlike traditional systems, DAVE-2 used a single DNN to output driving control signals from image pixels (</a>Figure 16-17<a href="https://devblogs.nvidia.com/deep-learning-self-driving-cars" class="s140" target="_blank">). NVIDIA demonstrated that a small amount of training data from less than a hundred hours of driving was sufficient to train the car to operate in diverse conditions, on highways and local, residential roads in sunny, cloudy, and rainy conditions. You can find more details on this work at </a><a href="https://devblogs.nvidia.com/deep-learning-self-driving-cars" class="s52" target="_blank">https://devblogs.nvidia.com/deep-learning-self- driving-cars</a><a href="https://devblogs.nvidia.com/deep-learning-self-driving-cars" class="s140" target="_blank">.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s198" style="padding-top: 4pt;padding-left: 39pt;text-indent: 0pt;text-align: left;"><a href="https://oreil.ly/jVwEv" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12pt;" target="_blank" name="bookmark1810">Figure 16-17. Architecture of NVIDIA’s DAVE-2 system (</a>image source<span style=" color: #000;">)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Here are some new ideas for us to build on top of what we learned in this chapter. You can implement all of these ideas using the setup we already have in place for this chapter.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s197" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1747">Expanding Our Dataset</a><a name="bookmark1811">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">As a general rule, using more data helps improve model performance. Now that we have the simulator up and running, it will be a useful exercise to expand our dataset by doing more data collection runs. We can even try combining data from various different environments available in AirSim and see how our model trained on this data performs in different environments.</p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">We used only RGB data from a single camera in this chapter. AirSim allows us to do a lot more. For example, we can collect images in depth view, segmentation view, surface normal view, and more for each of the cameras available. So, we can potentially have 20 different images (for five cameras operating in all four modes) for each instance. Can using all this extra data help us improve the model we just trained?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s197" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1748">Training on Sequential Data</a><a name="bookmark1812">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1813">Our model currently uses a single image and a single vehicle state for each prediction. This is not really how we drive in real life, though. Our actions always take into account the recent series of events leading up to that given moment. In our dataset, we have timestamp information available for all our images, which we can use to create sequences. We can modify our model to make predictions using the previous </a><i>N </i>images and states. For example, given the past 10 images and past 10 states, predict the next steering angle. (Hint: This might require the use of RNNs.)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s197" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1749">Reinforcement Learning</a><a name="bookmark1814">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="https://oreil.ly/u1hoC" class="s63" target="_blank" name="bookmark1815">After we learn about reinforcement learning in the next chapter, we can come back and try the </a><a href="https://oreil.ly/bTphH" class="s44" target="_blank">Distributed Deep Reinforcement Learning for Autonomous Driving </a><a href="https://oreil.ly/bTphH" class="s63" target="_blank">tutorial from the </a><a href="https://oreil.ly/bTphH" class="s46" target="_blank">Autonomous Driving Cookbook</a>. Using the Neighborhood environment in AirSim, which is included in the package we downloaded for this chapter, we will learn how to scale a deep reinforcement learning training job and reduce training time from under a week to less than an hour using transfer learning and the cloud.<a name="bookmark1816">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s196" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1750">Summary</a><a name="bookmark1817">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">This chapter gave us a sneak peek into how deep learning enables the autonomous driving industry. Taking advantage of the skills acquired in the previous chapters, we implemented the “Hello, World!” problem of autonomous driving using Keras. Exploring the raw data at hand, we learned how to preprocess it to make it suitable for training a high-performing model. And we were able to accomplish this with a very small dataset. We were also able to take our trained model and deploy it to drive a car in the simulated world. Wouldn’t you agree that there’s just something magical about that?</p><p class="s203" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1818">Chapter 17. Building an Autonomous Car in Under an Hour: Reinforcement Learning with AWS DeepRacer</a><a name="bookmark1861">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_1045.png"/></span></p><p class="s204" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Contributed by guest author: Sunil Mallya</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">If you follow technology news, you probably have seen a resurgence in debates about when computers are going to take over the world. Although that’s a fun thought exercise, what’s triggered the resurgence in these debates? A large part of the credit can be attributed to the news of computers beating humans at decision-making tasks — winning in chess, achieving high scores in video games like Atari (2013), beating humans in a complex game of Go (2016), and, finally, beating human teams at Defence of the Ancients (Dota) 2 in 2017. The most astonishing thing about these successes is that the “bots” learned the games by playing against one another and reinforcing the strategies that they found to bring them success.</p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1862">If we think more broadly on this concept, it’s no different than how humans teach their pets. To train a dog, every good behavior is reinforced by rewarding the dog with a treat and lots of hugs, and every undesired behavior is discouraged by asserting “bad doggie.” This concept of reinforcing good behaviors and discouraging bad ones essentially forms the crux of </a><i>reinforcement learning</i>.</p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Computer games, or games in general, require a sequence of decisions to be made, so traditional supervised methods aren’t well suited, because they often focus on making a single decision (e.g., is this an image of a cat or a dog?). The inside joke in the reinforcement learning community is that we just play video games all day (spoiler alert: It’s true!). At present, reinforcement learning is being applied across industries to optimize stock trading, manage heating and cooling in large buildings and datacenters, perform real-time bidding of advertisements, optimize video-streaming quality, and even optimize chemical reactions in a lab. Given these examples of production systems, we would strongly advocate using reinforcement learning for sequential decision making and optimization problems. In this chapter, we focus on learning this paradigm of machine learning and applying it to a real-world problem: building a one-eighteenth-scale, self- driving autonomous car in less than an hour.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s144" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1819">A Brief Introduction to Reinforcement Learning</a><a name="bookmark1863">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1864">Similar to deep learning, reinforcement learning has seen a renaissance in the past few years ever since previously held human video game records were broken. Reinforcement learning theory had its heyday in the 1990s, but didn’t break in to large-scale production systems due to computational requirements and difficulty in training these systems. Traditionally reinforcement learning has been considered compute heavy; in contrast, neural networks are data heavy. But advancements in deep neural networks have also benefited reinforcement learning. Neural networks are now being used to represent the reinforcement learning model, thus giving birth to deep reinforcement learning. In this chapter, we use the term reinforcement learning and deep reinforcement learning interchangeably, but in almost all cases if not stated otherwise, when we refer to reinforcement learning, we are talking about deep reinforcement learning.</a></p><p class="s39" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1867" class="s30" name="bookmark1865">Despite recent advancements, the landscape for reinforcement learning has not been developer friendly. Interfaces for training deep learning models have progressively become simpler, but this hasn’t quite caught up in the reinforcement learning community. Another challenging aspect for reinforcement learning has been the significant computational requirements and time to model convergence (it has completed learning) — it literally takes days, if not weeks, to create a converged model. Now, assuming that we had the patience, knowledge of neural networks, and the monetary bandwidth, educational resources regarding reinforcement learning are few and far between. Most of the resources are targeted to advanced data scientists, and sometimes out of reach for developers. That one-eighteenth- scale autonomous car we referenced earlier? That’s AWS’ DeepRacer (</a>Figure 17-1<span style=" color: #000;">). One of the biggest motivations behind AWS DeepRacer was to make reinforcement learning accessible to developers. It is powered by Amazon SageMaker reinforcement learning, which is a general-purpose reinforcement learning platform. And, let’s get real: who doesn’t like self- driving cars?</span><a name="bookmark1866">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 133pt;text-indent: 0pt;text-align: left;"><span><img width="265" height="265" alt="image" src="KerasTensorFlow2019/Image_1046.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 52pt;text-indent: 0pt;text-align: left;"><a name="bookmark1867">Figure 17-1. The AWS DeepRacer one-eighteenth-scale autonomous car</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s144" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1820">Why Learn Reinforcement Learning with an Autonomous Car?</a><a name="bookmark1868">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1869">In recent years, self-driving technology has seen significant investments and success. DIY self-driving and radio-controlled (RC) car-racing communities have since become popular. This unparalleled enthusiasm in developers building scaled autonomous cars with real hardware, testing in real-world scenarios has compelled us to use a “vehicle,” literally, to educate developers on reinforcement learning. Although there existed other algorithms to build self-driving cars, like traditional computer vision or supervised learning (behavioral cloning), we believe reinforcement learning has an edge over these.</a></p><p class="s39" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1872" class="s18" name="bookmark1870">Table 17-1</a> <span style=" color: #000;">summarizes some of the popular self-driving kits available for developers, and the technologies that enable them. One of the key benefits of reinforcement learning is that models can be trained exclusively in a simulator. But reinforcement learning systems come with their own set of challenges, the biggest of them being the simulation-to-real (sim2real) problem. There’s always a challenge of deploying models trained completely in simulation in to real-world environments. DeepRacer tackles this with some simple, yet effective solutions that we discuss later in the chapter.</span><a name="bookmark1871">&zwnj;</a></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Within the first six months following the launch of DeepRacer in November 2018, close to 9,000 developers trained their models in the simulator and successfully tested them on a real-world track.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s22" style="padding-left: 52pt;text-indent: 0pt;text-align: left;"><a name="bookmark1872">Table 17-1. Landscape of autonomous self-driving technology</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="589" height="1" alt="image" src="KerasTensorFlow2019/Image_1047.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="120" height="118" alt="image" src="KerasTensorFlow2019/Image_1048.jpg"/></span></p><p class="s153" style="padding-top: 2pt;padding-bottom: 3pt;padding-left: 72pt;text-indent: 0pt;text-align: left;">Hardware Assembly Technology Cost</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="589" height="1" alt="image" src="KerasTensorFlow2019/Image_1049.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s147" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">AWS</p><p class="s147" style="padding-left: 9pt;text-indent: 0pt;text-align: left;">DeepRacer</p><p class="s147" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;">Intel Atom with 100 GFLOPS GPU</p><p class="s147" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Preassembled Reinforcement</p><p class="s147" style="padding-left: 81pt;text-indent: 0pt;text-align: left;">learning</p><p class="s147" style="padding-top: 4pt;padding-left: 4pt;text-indent: 0pt;text-align: left;">$399</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="589" height="1" alt="image" src="KerasTensorFlow2019/Image_1050.png"/></span></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="589" height="1" alt="image" src="KerasTensorFlow2019/Image_1051.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="596" height="196" alt="image" src="KerasTensorFlow2019/Image_1052.png"/></span></p><p class="s147" style="text-indent: 0pt;line-height: 12pt;text-align: left;">$90</p><p style="text-indent: 0pt;text-align: left;"/><p class="s147" style="text-indent: 0pt;line-height: 108%;text-align: left;">Traditional computer vision</p><p style="text-indent: 0pt;text-align: left;"/><p class="s147" style="text-indent: 0pt;line-height: 108%;text-align: left;">OpenMV DIY (two H7 hours)</p><p style="text-indent: 0pt;text-align: left;"/><p class="s147" style="text-indent: 0pt;line-height: 12pt;text-align: left;">OpenMV</p><p style="text-indent: 0pt;text-align: left;"/><p class="s153" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 72pt;text-indent: 0pt;text-align: left;">Hardware Assembly Technology Cost</p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="589" height="1" alt="image" src="KerasTensorFlow2019/Image_1053.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s147" style="padding-top: 5pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Duckietown Raspberry</p><p class="s147" style="padding-left: 72pt;text-indent: 0pt;text-align: left;">Pi</p><p class="s147" style="padding-top: 5pt;padding-left: 4pt;text-indent: 0pt;text-align: left;">Preassembled Reinforcement</p><p style="text-indent: 0pt;text-align: left;"><span><img width="596" height="193" alt="image" src="KerasTensorFlow2019/Image_1054.png"/></span></p><p class="s147" style="text-indent: 0pt;line-height: 12pt;text-align: left;">Pi</p><p style="text-indent: 0pt;text-align: left;"/><p class="s147" style="text-indent: 0pt;line-height: 12pt;text-align: left;">$250</p><p style="text-indent: 0pt;text-align: left;"/><p class="s147" style="text-indent: 0pt;line-height: 108%;text-align: left;">Behavioral closing</p><p style="text-indent: 0pt;text-align: left;"/><p class="s147" style="text-indent: 0pt;line-height: 12pt;text-align: right;">DonkeyCar Raspberry DIY (two to</p><p class="s147" style="text-indent: 0pt;text-align: right;">three hours)</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="165" height="135" alt="image" src="KerasTensorFlow2019/Image_1055.jpg"/></span></p><p class="s147" style="padding-left: 80pt;text-indent: 0pt;line-height: 108%;text-align: left;">learning, behavioral cloning</p><p class="s147" style="padding-top: 5pt;padding-left: 4pt;text-indent: 0pt;text-align: left;">$279–</p><p style="text-indent: 0pt;text-align: left;"><span><img width="173" height="135" alt="image" src="KerasTensorFlow2019/Image_1056.jpg"/></span></p><p class="s147" style="padding-left: 4pt;text-indent: 0pt;text-align: left;">$350</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s147" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">NVIDIA</p><p class="s147" style="padding-left: 9pt;text-indent: 0pt;text-align: left;">JetRacer</p><p class="s147" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;line-height: 108%;text-align: left;">Jetson Nano</p><p class="s147" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;line-height: 108%;text-align: left;">DIY (three to five hours)</p><p class="s147" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;line-height: 108%;text-align: left;">Supervised learning</p><p class="s147" style="padding-top: 4pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">~$400</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="589" height="1" alt="image" src="KerasTensorFlow2019/Image_1057.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s153" style="padding-left: 65pt;text-indent: 0pt;text-align: center;">FROM THE CREATOR’S DESK</p><p class="s147" style="padding-top: 6pt;padding-left: 10pt;text-indent: 0pt;line-height: 151%;text-align: left;">By Chris Anderson, CEO 3DR and founder of DIY Robocars The future of robocars in DIY communities will be:</p><p class="s145" style="padding-top: 4pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Faster</p><p class="s147" style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: justify;">Consistently beating humans under all conditions, starting with straight speed and getting to track/racing offensive and defensive tactics. We want our cars to be the nonplayer characters of real-world Mario Kart races set to ludicrous difficulty. ;-)</p><p class="s145" style="padding-top: 9pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Easier</p><p class="s147" style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">In the same way that a great game is “easy to pick up, but hard to master,” we want our cars to drive well out of the box but require clever software approaches to win.</p><p class="s145" style="padding-top: 9pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Cheaper</p><p class="s147" style="padding-top: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark1873">The cost and machine learning barrier to entry in to DIY racing leagues will significantly decrease.</a></p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="590" height="333" alt="image" src="KerasTensorFlow2019/Image_1058.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s144" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1821">Practical Deep Reinforcement Learning with DeepRacer</a><a name="bookmark1874">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1875">Now for the most exciting part of this chapter: building our first reinforcement learning-based autonomous racing model. Before we embark on the journey, let’s build a quick cheat sheet of terms that will help you to become familiar with important reinforcement learning terminology:</a></p><p class="s22" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Goal</p><p class="s17" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: left;">Finishing a lap around the track without going off track.</p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Input</p><p class="s17" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: left;">In a human driven car, the human visualizes the environment and uses driving knowledge to make decisions and navigate the road. DeepRacer is also a vision-driven system and so we use a single camera image as our input into the system. Specifically, we use a grayscale 120x160 image as the input.</p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Output (Actions)</p><p style="text-indent: 0pt;text-align: left;"><span><img width="538" height="128" alt="image" src="KerasTensorFlow2019/Image_1059.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 182pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s147" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 108%;text-align: left;">A servo in an RC hobby car is generally controlled by a PWM signal, which is a series of pulses of varying width. The position in which the servo needs to end up is achieved by sending a particular width of the pulse signal. The parameters for the pulses are min pulse width, max pulse width, and repetition rate.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s17" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: left;">In the real world, we drive the car by using the throttle (gas), brake, and steering wheel. DeepRacer, which is built on top of a RC car, has two control signals: the throttle and the steering, both of which are controlled by traditional pulse-width modulation (PWM) signals. Mapping driving to PWM signals can be nonintuitive, so we discretize the driving actions that the car can take. Remember those old-school car-racing games we played on the computer? The simplest of those used the arrow keys — left, right, and up — to drive the car. Similarly, we can define a fixed set of actions that the car can take, but with more fine-grained control over throttle and steering. Our reinforcement learning model, after it’s trained, will make decisions on which action to take such that it can navigate the track successfully. We’ll have the flexibility to define these actions as we create the model.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s22" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Agent</p><p class="s17" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: left;">The system that learns and makes decisions. In our case, it’s the car that’s learning to navigate the environment (the track).</p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Environment</p><p class="s17" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: left;">Where the agent learns by interacting with actions. In DeepRacer, the environment contains a track that defines where the agent can go and be in. The agent explores the environment to collect data to train the underlying deep reinforcement learning neural network.</p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;">State (s)</p><p class="s17" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: justify;">The representation of where the agent is in an environment. It’s a point- in-time snapshot of the agent. For DeepRacer, we use an image as the state.</p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;">Actions (a)</p><p class="s17" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: left;">Set of decisions that the agent can make.</p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Step</p><p class="s17" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: left;">Discrete transition from one state to the next.</p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Episode</p><p class="s17" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: left;"><a name="bookmark1876">This refers to an attempt by the car to achieve its goal; that is, complete a lap on the track. Thus, an episode is a sequence of steps, or experience. Different episodes can have different lengths.</a></p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;">Reward (r)</p><p class="s17" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: left;">The value for the action that the agent took given an input state.</p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;">Policy (π)</p><p class="s17" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: left;">Decision-making strategy or function; a mapping from state to actions.</p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Value function (V)</p><p class="s17" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: justify;"><a name="bookmark1877">The mapping of state to values, in which value represents the expected reward for an action given the state.</a></p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Replay or experience buffer</p><p class="s17" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;line-height: 106%;text-align: left;"><a name="bookmark1878">Temporary storage buffer that stores the experience, which is a tuple of (s,a,r,s</a><span class="s156">&#39;</span>), where “s” stands for an observation (or state) captured by the camera, “a” for an action taken by the vehicle, “r” for the expected reward incurred by the said action, and “s<span class="s156">&#39;</span>” for the new observation (or new state) after the action is taken.</p><p class="s22" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Reward function</p><p class="s17" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: left;"><a name="bookmark1879">Any reinforcement learning system needs a guide, something that tells the model as it learns what’s a good or a bad action given the situation. The reward function acts as this guide, which evaluates the actions taken by the car and gives it a reward (scalar value) that indicates the desirability of that action for the situation. For example, on a left turn, taking a “left turn” action would be considered optimal (e.g., reward = 1; on a 0–1 scale), but taking a “right turn” action would be bad (reward = 0). The reinforcement learning system eventually collects this guidance based on the reward function and trains the model. This is the most critical piece in training the car and the part that we’ll focus on.</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Finally, when we put together the system, the schematic flow looks as follows:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Input (12Ox16O grayscale Image) → (reinforcement learning Model) → Output (left, right, straight)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1880">In AWS DeepRacer, the reward function is an important part of the model building process. We must provide it when training our AWS DeepRacer model.</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">In an episode, the agent interacts with the track to learn the optimal set of actions it needs to take to maximize the expected cumulative reward. But a single episode doesn’t produce enough data for us to train the agent. So, we end up collecting many episodes’ worth of data. Periodically, at the end of every <i>n</i>th episode, we kick off a training process to produce an iteration of the reinforcement learning model. We run many iterations to produce the best model we can. This process is explained in detail in the next section.</p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">After the training, the agent executes autonomous driving by running inference on the model to take an optimal action given an image input. The evaluation of the model can be done in either the simulated environment with a virtual agent or a real-world environment with a physical AWS DeepRacer car.</p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">It’s finally time to create our first model. Because the input into the car is fixed, which is a single image from the camera, we need to focus only on the output (actions) and the reward function. We can follow the steps below to begin training the model.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s153" style="padding-left: 65pt;text-indent: 0pt;text-align: center;">SIMULATION TO REAL TRANSFER PROBLEM (SIM2REAL)</p><p class="s147" style="padding-top: 6pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1881">Data collection for robotic applications can be extremely difficult and time consuming. So, there are great advantages to training these applications in a simulated environment. However, creating certain scenarios in the real world can be impractical, like simulating a collision with another car or a human. Therefore, there can be reality gaps in the simulator — perceptual differences and simulation fidelity (image quality, sampling rate, etc.), physical differences (friction, mass, density, etc.), and incorrect physical modeling (interactions and collisions between physical objects in the simulator). All of these can lead to the simulation environment being vastly different from the real world.</a></p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="590" height="212" alt="image" src="KerasTensorFlow2019/Image_1060.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1822">Building Our First Reinforcement Learning</a><a name="bookmark1882">&zwnj;</a></p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1884" class="s30" name="bookmark1883">To do this exercise, you will need an AWS account. Log into the AWS Console using your account credentials, as shown in </a>Figure 17-2<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="363" height="286" alt="image" src="KerasTensorFlow2019/Image_1061.jpg"/></span></p><p class="s145" style="padding-top: 7pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1884">Figure 17-2. The AWS login console</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="https://console.aws.amazon.com/deepracer/home?region=us-east-1&amp;getStarted" class="s30" target="_blank">First, let’s make sure we are in the North Virginia region, given that the service is available only in that region, and then navigate to the DeepRacer console page: </a><a href="https://console.aws.amazon.com/deepracer/home?region=us-east-1&amp;getStarted" class="s21" target="_blank">https://console.aws.amazon.com/deepracer/home?region=us- east-1#getStarted</a><a href="https://console.aws.amazon.com/deepracer/home?region=us-east-1&amp;getStarted" class="s30" target="_blank">.</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: justify;">After you select “Reinforcement learning,” the model page opens. This page shows a list of all the models that have been created and the status of each model. To create a model, start the process here.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 40pt;text-indent: 0pt;text-align: left;"><span><img width="501" height="183" alt="image" src="KerasTensorFlow2019/Image_1062.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">Figure 17-3. Workflow for training the AWS DeepRacer model</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1823">Step 1: Create Model</a><a name="bookmark1885">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1886">We are going to create a model that can be used by the AWS DeepRacer car to autonomously drive (take actions) around a race track. We need to select the specific race track, provide the actions that our model can choose from, provide a reward function that will be used to incentivize our desired driving behavior, and configure the hyperparameters used during training.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 32pt;text-indent: 0pt;text-align: left;"><span><img width="520" height="218" alt="image" src="KerasTensorFlow2019/Image_1063.jpg"/></span></p><p class="s145" style="padding-top: 6pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">Figure 17-4. Creating a model on the AWS DeepRacer console</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1824">Step 2: Configure Training</a><a name="bookmark1887">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1888">In this step, we select our training environment, configure action space, write our reward function, and adjust other training related settings before kicking off our training job.</a></p><p class="s40" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1825">Configure the simulation environment</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Training our reinforcement learning model takes place on a simulated race track, and we can choose the track to train our model. We’ll use AWS RoboMaker, a cloud service that makes building robotic applications easy, to spin up the simulation environment.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">When training a model, we pick the track most similar to the final track we intend to race on. As of July 2019, AWS DeepRacer provides seven tracks that we can train on. While configuring such a complementary environment isn’t required and doesn’t guarantee a good model, it will maximize the odds that our model will perform best on the race track. Furthermore, if we train on a straight track, it’s unlikely that our model would have learned how to turn.</p><p class="s39" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1890" class="s30">Just like in the case of supervised learning in which it’s unlikely that the model will learn something that’s not part of the training data, in reinforcement learning, the agent is unlikely to learn anything out of scope from the training environment. For our first exercise, select the re:Invent 2018 track, as shown in </a>Figure 17-5<span style=" color: #000;">.</span></p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1889">To train a reinforcement learning model, we must choose a learning algorithm. Currently, the AWS DeepRacer console supports only the proximal policy optimization (PPO) algorithm. The team eventually will support more algorithms, but PPO was chosen for faster training times and superior convergence properties. Training a reinforcement learning model is an iterative process. First, it’s a challenge to define a reward function to cover all important behaviors of an agent in an environment at once.</a></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Second, hyperparameters are often tuned to ensure satisfactory training performance. Both require experimentation. A prudent approach is to start with a simple reward function, which will be our approach in this chapter, and then progressively enhance it. AWS DeepRacer facilitates this iterative process by enabling us to clone a trained model, in which we could enhance the reward function to handle previous ignored variables or we can systematically adjust hyperparameters until the result converges. The easiest way to detect this convergence is look at the logs and see whether the car is going past the finish line; in other words, whether progress is 100%. Alternatively, we could visually observe the car’s behavior and confirm that it goes past the finish line.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 32pt;text-indent: 0pt;text-align: left;"><span><img width="517" height="450" alt="image" src="KerasTensorFlow2019/Image_1064.jpg"/></span></p><p class="s145" style="padding-top: 8pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1890">Figure 17-5. Track selection on the AWS DeepRacer console</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s40" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1826">Configure the action space</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1891">Next, we configure the action space that our model will select both during and after training. An action (output) is a combination of speed and steering angle. Currently in AWS DeepRacer, we use a discrete action space (a fixed set of actions) as opposed to a continuous action space (turn </a><i>x </i>degrees with <i>y </i>speed, where <i>x </i>and <i>y </i><a href="#bookmark1938" class="s30">take real values). This is because it’s easier to map to values on the physical car, which we dive into later in the </a><a href="#bookmark1938" class="s18">“Racing the AWS DeepRacer Car” </a><a href="#bookmark1892" class="s30">To build this discrete action space, we specify the maximum speed, the speed levels, the maximum steering angle, and the steering levels, as depicted in </a><span style=" color: #8E0012;">Figure 17-6</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 32pt;text-indent: 0pt;text-align: left;"><span><img width="518" height="783" alt="image" src="KerasTensorFlow2019/Image_1065.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1892">Figure 17-6. Defining the action space on the AWS DeepRacer console</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Following are the configuration parameters for the action space:</p><p class="s22" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Maximum steering angle</p><p class="s17" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: left;">This is the maximum angle in degrees that the front wheels of the car can turn to the left and to the right. There is a limit as to how far the wheels can turn, and so the maximum turning angle is 30 degrees.</p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Steering angle granularity</p><p class="s39" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1892" class="s30">Refers to the number of steering intervals between the maximum steering angle on either side. Thus, if our maximum steering angle is 30 degrees, +30 degrees is to the left and –30 degrees is to the right. With a steering granularity of 5, the following steering angles, as shown in </a>Figure 17-6<span style=" color: #000;">, from left to right, will be in the action space: 30 degrees, 15 degrees, 0 degrees, –15 degrees, and –30 degrees. Steering angles are always symmetrical around 0 degrees.</span></p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Maximum speed</p><p class="s17" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: left;">Refers to the maximum speed the car will drive in the simulator as measured in meters per second (m/s).</p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Speed levels</p><p class="s17" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: left;">Refers to the number of speed levels from the maximum speed (including) to zero (excluding). So, if our maximum speed is 3 m/s and our speed granularity is 3, our action space will contain speed settings of 1 m/s, 2 m/s, and 3 m/s. Simply put, 3 m/s divided by 3 = 1 m/s, so go from 0 m/s to 3 m/s in increments of 1 m/s. 0 m/s is not included in the action space.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Based on the previous example the final action space will include 15 discrete actions (three speeds x five steering angles), which should be listed in the AWS DeepRacer service. Feel free to tinker with other options, just remember that larger action spaces might take a bit longer to train.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="538" height="452" alt="image" src="KerasTensorFlow2019/Image_1066.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 182pt;text-indent: 0pt;text-align: center;">TIP</p><p class="s147" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 108%;text-align: left;">Based on our experience, here are some tips on how to configure the action space:</p><p class="s147" style="padding-top: 5pt;padding-left: 31pt;text-indent: 0pt;line-height: 108%;text-align: left;">Our experiments have shown that models with a faster maximum speed take longer to converge than those with a slower maximum speed. In some cases (reward function and track dependent), it can take longer than 12 hours for a 5 m/s model to converge.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s147" style="padding-left: 31pt;text-indent: 0pt;line-height: 108%;text-align: left;">Our model will not perform an action that is not in the action space. Similarly, if the model is trained on a track that never required the use of this action — for example, turning won’t be incentivized on a straight track — the model won’t know how to use this action, because it won’t be incentivized to turn. As you begin thinking about building a robust model, make sure that you keep the action space and training track in mind.</p><p class="s147" style="padding-top: 10pt;padding-left: 31pt;text-indent: 0pt;line-height: 108%;text-align: left;">Specifying a fast speed or a wide steering angle is great, but we still need to think about our reward function and whether it makes sense to drive full speed into a turn, or exhibit zigzag behavior on a straight section of the track.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s147" style="padding-left: 31pt;text-indent: 0pt;line-height: 108%;text-align: left;">We also need to keep physics in mind. If we try to train a model at faster than 5 m/s, we might see our car spin out on corners, which will probably increase the time to convergence of our model.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s40" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1827">Configure reward function</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1893">As we explained earlier, the reward function evaluates the quality of an action’s outcome given the situation, and rewards the action accordingly. In practice the reward is calculated during training after each action is taken, and forms a key part of the experience used to train the model. We then store the tuple (state, action, next state, reward) in a memory buffer. We can build the reward function logic using a number of variables that are exposed by the simulator. These variables represent measurements of the car, such as steering angle and speed; the car in relation to the racetrack, such as (x,</a><a name="bookmark1894">&zwnj;</a></p><ol id="l56"><li><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">coordinates; and the racetrack, such as waypoints (milestone markers on the track). We can use these measurements to build our reward function logic in Python 3 syntax.</p><p class="s39" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1895" class="s30">All of the parameters are available as a dictionary to the reward function. Their keys, data types, and descriptions are documented in </a>Figure 17-7<a href="#bookmark1896" class="s30">, and some of the more nuanced ones are further illustrated in </a>Figure 17-8<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 32pt;text-indent: 0pt;text-align: left;"><span><img width="519" height="128" alt="image" src="KerasTensorFlow2019/Image_1067.jpg"/></span></p><p class="s145" style="padding-top: 6pt;padding-left: 152pt;text-indent: -137pt;line-height: 108%;text-align: left;"><a name="bookmark1895">Figure 17-7. Reward function parameters (a more in-depth review of these parameters is available in the documentation)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 32pt;text-indent: 0pt;text-align: left;"><span><img width="520" height="292" alt="image" src="KerasTensorFlow2019/Image_1068.jpg"/></span></p><p class="s145" style="padding-top: 7pt;padding-left: 49pt;text-indent: 0pt;text-align: left;"><a name="bookmark1896">Figure 17-8. Visual explanation of some of the reward function parameters</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s39" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1897" class="s30">To build our first model, let’s pick an example reward function and train our model. Let’s use the default template, shown in </a>Figure 17-9<span style=" color: #000;">, in which the car tries to follow the center dashed lines. The intuition behind this reward function is to take the safest navigation path around the track because being in the center keeps the car farthest from being off track. The reward function does the following: creates three tiers around the track, using the three markers, and then proceeds to reward the car more for driving in the second tier as opposed to the center or the last tier. Also note the differences in the size of the reward. We provide a reward of 1 for staying in the narrow center tier, 0.5 for staying in the second (off-center) tier, and 0.1 for staying in the last tier. If we decrease the reward for the center tier, or increase the reward for the second tier, we are essentially incentivizing the car to use a larger portion of the track surface. Remember that time you did your driving test?</span></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">The examiner probably did the same and cut off points as you got closer to the curb or the lane makers. This could come in handy, especially when there are sharp corners.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 71pt;text-indent: 0pt;text-align: left;"><span><img width="406" height="385" alt="image" src="KerasTensorFlow2019/Image_1069.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1897">Figure 17-9. An example reward function</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Here’s the code that sets this up:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;"><span class="s77">def </span><span style=" color: #C0F;">reward_function</span>(<span style=" color: #000087;">params</span>):</p><p class="s205" style="padding-left: 40pt;text-indent: 0pt;text-align: left;">&#39;&#39;&#39;</p><p class="s205" style="padding-left: 40pt;text-indent: 0pt;text-align: left;">Example of rewarding the agent to follow center line &#39;&#39;&#39;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s128" style="padding-left: 40pt;text-indent: 0pt;text-align: left;"># Read input parameters</p><p class="s75" style="padding-left: 40pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">track_width </span>= <span style=" color: #000087;">params</span>[<span style=" color: #C30;">&#39;track_width&#39;</span>] <span style=" color: #000087;">distance_from_center </span>= <span style=" color: #000087;">params</span>[<span style=" color: #C30;">&#39;distance_from_center&#39;</span>]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s128" style="padding-left: 40pt;text-indent: 0pt;text-align: left;"># Calculate 3 markers that are at varying distances away from the center line</p><p class="s75" style="padding-left: 40pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">marker_1 </span>= <span style=" color: #F60;">O.1 </span>* <span style=" color: #000087;">track_width marker_2 </span>= <span style=" color: #F60;">O.25 </span>* <span style=" color: #000087;">track_width marker_3 </span>= <span style=" color: #F60;">O.5 </span>* <span style=" color: #000087;">track_width</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s128" style="padding-left: 40pt;text-indent: 0pt;text-align: left;"># Give higher reward if the car is closer to center line and vice versa</p><p class="s74" style="padding-left: 60pt;text-indent: -20pt;text-align: left;"><span class="s77">if </span>distance_from_center <span style=" color: #000;">&lt;= </span>marker_1<span style=" color: #000;">: </span>reward <span style=" color: #000;">= </span><span style=" color: #F60;">1.O</span></p><p class="s74" style="padding-left: 60pt;text-indent: -20pt;text-align: left;"><span class="s77">elif </span>distance_from_center <span style=" color: #000;">&lt;= </span>marker_2<span style=" color: #000;">: </span>reward <span style=" color: #000;">= </span><span style=" color: #F60;">O.5</span></p><p class="s74" style="padding-left: 60pt;text-indent: -20pt;text-align: left;"><span class="s77">elif </span>distance_from_center <span style=" color: #000;">&lt;= </span>marker_3<span style=" color: #000;">: </span>reward <span style=" color: #000;">= </span><span style=" color: #F60;">O.1</span></p><p class="s77" style="padding-left: 40pt;text-indent: 0pt;text-align: left;">else<span class="s75">:</span></p><p class="s74" style="padding-left: 60pt;text-indent: 0pt;text-align: left;">reward <span style=" color: #000;">= </span><span style=" color: #F60;">1e-3 </span><span class="s128"># likely crashed/ close to off track</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 40pt;text-indent: 0pt;text-align: left;"><span class="s77">return </span><span style=" color: #366;">float</span>(<span style=" color: #000087;">reward</span>)</p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Because this is the first training run, let’s focus on understanding the process of creating and evaluating a basic model, and then focus on optimizing it. In this case, we skip the algorithm settings and hyperparameter sections and use the defaults.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="538" height="221" alt="image" src="KerasTensorFlow2019/Image_1070.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 182pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s145" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 108%;text-align: left;">FAQ: Should the rewards be in a certain range, and also can I give negative rewards?</p><p class="s147" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 108%;text-align: left;">There are no real constraints on what we can reward and not reward, but as a good practice it’s easier to understand rewards when they are in a 0–1 or 0–100 scale. What’s more important is that our reward scale gives relative rewards for the actions appropriately. For example, on a right turn, we should reward the right action with high reward, a left action with close to 0 reward, perhaps a straight action with an in-between reward or higher than the left action because it might not be a completely bad action to take.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s40" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1828">Configure stop conditions</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1898">This is the last section before we begin training. Here we specify the maximum time our model will train for. This is provided as a convenient mechanism for us to terminate our training given that we are billed for the amount of training time.</a><a name="bookmark1899">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Specify 60 minutes and then select “Start training.” If there is an error, we will be taken to the error location. After we start training, it can take up to six minutes to spin up the services (such as Amazon SageMaker, AWS Robomaker, AWS Lambda, AWS Step Function) needed to start training.</p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1900">Remember, we can always stop training early if we determine that the model has converged (as explained in the next section) by clicking the “stop” button.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1829">Step 3: Model Training</a><a name="bookmark1901">&zwnj;</a></p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1903" class="s30" name="bookmark1902">After our model has begun training, we can select it from the listed models on the DeepRacer console. We can then see quantitatively how the training is progressing by looking at the total reward over time graph and also qualitatively from a first-person view from the car in the simulator (see </a>Figure 17-10<span style=" color: #000;">).</span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="538" height="169" alt="image" src="KerasTensorFlow2019/Image_1071.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 182pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s145" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">FAQ: Why is the reward graph spiky?</p><p class="s147" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;line-height: 108%;text-align: left;">The agent starts with high exploration, and gradually begins to exploit the trained model. Because the agent always takes random actions for a fraction of its decisions, there might be occasions for which it totally makes the wrong decision and ends up going off track. This is typically high at the beginning of training, but eventually the spikiness should reduce as the model begins to learn.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">At first, our car will not be able to drive on a straight road, but as it learns better driving behavior, we should see its performance improving and the reward graph increasing. Furthermore, when our car drives off of the track it will be reset on the track. We might observe that the reward graph is spiky.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Logs are always a good source of more granular information regarding our model’s training. Later in the chapter, we examine how we can use the logs programmatically to gain a deeper understanding of our model training. In the meantime, we can look at the log files for both Amazon SageMaker and AWS RoboMaker. The logs are output to Amazon CloudWatch. To see the logs, hover your mouse over the reward graph and select the three dots that appear below the refresh button. Then, select “View logs.” Because the model training will take an hour, this might be a good time to skip to the next section and learn a bit more about reinforcement learning.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 32pt;text-indent: 0pt;text-align: left;"><span><img width="520" height="258" alt="image" src="KerasTensorFlow2019/Image_1072.jpg"/></span></p><p class="s145" style="padding-top: 7pt;padding-left: 11pt;text-indent: 0pt;text-align: left;"><a name="bookmark1903">Figure 17-10. Training graph and simulation video stream on the AWS DeepRacer console</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1830">Step 4: Evaluating the Performance of the Model</a><a name="bookmark1904">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1905">In reinforcement learning, the best way to gauge the ability of the model is to run it such that it only exploits — that is, it doesn’t take random actions. In our case, first test it on a track similar to the one it’s trained on to see whether it can replicate the trained behavior. Next, try it on a different track to test generalizability. After our model training is complete, we can commence model evaluation. From our model details page, where we observed training, select “Start evaluation.” We can now select the track on which we want to evaluate the performance of our model and also the number of laps. Select the “re:Invent 2018” track and 5 laps and then select Start. When it’s done, we should see a similar page as that shown in</a></p><p class="s39" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Figure 17-11<span style=" color: #000;">, which summarizes the results of our model’s attempts to go around the track and complete the lap.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 32pt;text-indent: 0pt;text-align: left;"><span><img width="518" height="549" alt="image" src="KerasTensorFlow2019/Image_1073.jpg"/></span></p><p class="s145" style="padding-top: 7pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1906">Figure 17-11. Model evaluation page on the AWS DeepRacer console</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="538" height="204" alt="image" src="KerasTensorFlow2019/Image_1074.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 182pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s145" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;text-align: justify;">FAQ: When I run evaluation, I see only 100% completion rates sometimes?</p><p class="s147" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;line-height: 108%;text-align: justify;">As the model runs inference and navigates around the track in the simulator, due to the fidelity of the simulator, the car can end up in slightly different positions for the same action — in other words, a 15 degree left turn action might result in only</p><p class="s147" style="padding-left: 5pt;text-indent: 0pt;line-height: 108%;text-align: left;">14.9 degrees. Practically, we observe only very small deviations in the simulator, but these small deviations can add up over time. A well-trained model is able to recover from close-to-off-track positions, but an undertrained model is likely to not recover from close calls.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Great job! We have successfully built our first reinforcement learning– enabled autonomous car.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="538" height="110" alt="image" src="KerasTensorFlow2019/Image_1075.png"/></span></p><p class="s25" style="padding-top: 9pt;padding-left: 182pt;text-indent: 0pt;text-align: center;">NOTE</p><p class="s147" style="padding-top: 5pt;padding-left: 5pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1907">We can get started with the AWS DeepRacer console service to create our first model, train it (for up to six hours), evaluate it, and submit it to the AWS DeepRacer League for free.</a></p><p style="text-indent: 0pt;text-align: left;"/><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Now that our model has been successfully evaluated, we move on to improving it and learn to achieve better lap times. But before that, it’s necessary for you to understand more about the theory behind reinforcement learning and dig deeper into the learning process.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s144" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1831">Reinforcement Learning in Action</a><a name="bookmark1908">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1909">Let’s take a closer look at reinforcement learning in action. Here, we discuss some theory, the inner workings, and lots of practical insights related to our autonomous car project.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1832">How Does a Reinforcement Learning System Learn?</a><a name="bookmark1910">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1911">First, we must understand </a><i>explore </i>versus <i>exploit</i>. Similar to how a child learns, a reinforcement learning system learns from <i>exploring </i>and finding out what’s good and bad. In the case of the child, the parent guides or informs the child of its mistakes, qualifies the decisions made as good or bad, or to what degree they were good or bad. The child memorizes the decisions it took for given situations and tries to replay, or <i>exploit</i>, those decisions at opportune moments. In essence, the child is trying to maximize the parent’s approval or cheer. Early in a child’s life, it’s more attentive to the suggestions from its parents, thus creating opportunities to learn. And later in life, as adults who seldom listen to their parents, exploit the concepts they have learned to make decisions.</p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1912" class="s30">As shown in </a><span style=" color: #8E0012;">Figure 17-12</span>, at every timestep “t,” the DeepRacer car (agent) receives its current observation, the state (S<span class="s206">t</span>), and on that basis the car selects an action (A<span class="s206">t</span>). As a result of the action the agent took, it gets a reward R<span class="s206">t+1 </span>and moves to state S<span class="s206">t+1, </span>and this process continues throughout the episode.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 42pt;text-indent: 0pt;text-align: left;"><span><img width="496" height="276" alt="image" src="KerasTensorFlow2019/Image_1076.jpg"/></span></p><p class="s145" style="padding-top: 5pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1912">Figure 17-12. Reinforcement learning theory basics in a nutshell</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">In the context of DeepRacer, the agent explores by taking random actions, and the reward function, which essentially acts just like the parent, tells the car whether the actions it took for the given state were good or not. Usually, “goodness” of the action for a given state is expressed as a number, with higher numbers meaning it’s close to optimal and lower meaning it’s not. The system records all of this information for every step, specifically: <i>current state, action taken, reward for the action, and next state </i>(s,a,r,s<span class="s156">&#39;</span>), in what we</p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">call the experience replay buffer, which is essentially a temporary memory buffer. The entire idea here being that the car can learn from what decisions were good and other decisions that were bad. The key point is that we <i>start with a high degree of exploration, and slowly increase exploitation.</i></p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1913" class="s30">In the DeepRacer simulator, we sample the input image state at 15 frames per second. At each step or image frame captured, the car transitions from one state to another. Each image represents the state the car is in, and eventually after the reinforcement learning model is trained, it will look to exploit by inferring which action to take. To make decisions, we could either take random actions or use our model for a recommendation. As the model trains, the training process balances the exploration and exploitation. To begin, we explore more, given that our model is unlikely to be good, but as it learns through experience, we shift more toward exploitation by giving the model more control. </a>Figure 17-13 <span style=" color: #000;">depicts this flow. This transition could be a linear decay, an exponential decay, or any similar strategy that’s usually tuned based on the degree of learning we hypothesize. Typically, an exponential decay is used in practical reinforcement learning training.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 45pt;text-indent: 0pt;text-align: left;"><span><img width="498" height="125" alt="image" src="KerasTensorFlow2019/Image_1077.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s145" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1913">Figure 17-13. The DeepRacer training flow</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">After an action is taken by a random choice or the model prediction, the car transitions to a new state. Using the reward function, the reward is computed and assigned to the outcome. This process will continue, for each state, until we get to a terminal state; that is, the car goes off track or completes a lap, at which point the car will be reset and then repeated. A step is a transition from one state to another, and at each step a (state, action, new state, reward) tuple is recorded. The collection of steps from the reset point until the terminal state is called an <i>episode</i>.</p><p class="s39" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1914" class="s30">To illustrate an episode, let’s look at the example of a miniature race track in </a>Figure 17-14<span style=" color: #000;">, where the reward function incentivizes following the centerline because it’s the shortest and quickest path from start to finish. This episode consists of four steps: at step 1 and 2 the car follows the center line, and then it turns left 45 degrees at step 3, and continues in that direction only to finally crash at step 4.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 32pt;text-indent: 0pt;text-align: left;"><span><img width="520" height="270" alt="image" src="KerasTensorFlow2019/Image_1078.jpg"/></span></p><p class="s145" style="padding-top: 6pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1914">Figure 17-14. Illustration of an agent exploring during an episode</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">We can think of these episodes as experience, or training data for our model. Periodically, the reinforcement learning system takes a random subset of these recordings from the memory buffer and trains a DNN (our deep reinforcement learning model) to produce a model that can best navigate the environment based on our reward function “guide”; in other words, get maximum cumulative rewards. As time progresses or with more episodes, we see a model that becomes better over time. Of course, the supercritical caveat being that the reward function is well defined and directing the agent toward the goal. If our reward function is bad, our model will not learn the correct behavior.</p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1915">Let’s take a slight diversion to understand a bad reward function. As we were initially designing the system, the car had freedom to go in any direction (left, right, forward, back). Our simplest reward function didn’t distinguish between directions, and in the end the model learned the best way to accumulate awards by just rocking backward and forward. This was then overcome by incentivizing the car to go forward. Luckily for developers now, the DeepRacer team made it simpler by allowing the car to move only in the forward direction, so we don’t even need to think of such behavior.</a></p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Now back to reinforcement learning. <i>How do we know if the model is getting better? </i>Let’s return to the concepts of explore and exploit. Remember that we begin with high exploration, low exploitation, and gradually increase the rate of exploitation. This means that at any point in the training process, for a certain percentage of time the reinforcement learning system will explore; that is, take random actions. As the experience buffer grows, for any given state, it stores all kinds of decisions (actions) including the ones that resulted in the highest reward to the lowest reward. The model essentially uses this</p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">information to learn and predict the best action to take for the given state. Suppose that the model initially took an action “go straight” for state S and received a reward of 0.5, but the next time it arrived in state S, it took action “go right” and received a reward of 1. If the memory buffer had several samples of the reward as “1” for the same state S for action “go right,” the model eventually learns “go right” is the optimal action for that state. Over time, the model will explore less and exploit more, and this percentage allocation is changed either linearly or exponentially to allow for the best learning.</p><p class="s39" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1913" class="s30">The key here is that if the model is taking optimal actions, the system learns to keep selecting those actions; if it isn’t selecting the best action, the system continues to try to learn the best action for a given state. Practically speaking, there can exist many paths to get to the goal, but for the mini racetrack example in </a>Figure 17-13<a href="#bookmark1916" class="s30">, the fastest path is going to be right down the middle of the track, as practically speaking any turns would slow down the car. During training, in early episodes as the model begins to learn, we observe that it might end up at the finish line (goal) but might not be taking the optimal path, as illustrated in </a>Figure 17-15 <a href="#bookmark1916" class="s30">(left) where the car zigzags, thus taking more time to get to the finish line and earning cumulative rewards of only 9. But because the system still continues to explore for a fraction of the time, the agent gives itself opportunities to find better paths. As more experience is built, the agent learns to find an optimal path and converge to an optimal policy to reach the goal with total cumulative rewards of 18, as illustrated in </a>Figure 17-15 <span style=" color: #000;">(right).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 32pt;text-indent: 0pt;text-align: left;"><span><img width="517" height="136" alt="image" src="KerasTensorFlow2019/Image_1079.jpg"/></span></p><p class="s145" style="padding-top: 6pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1916">Figure 17-15. Illustration of different paths to the goal</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Quantitatively speaking, for each episode, you should see a trend of increasing rewards. If the model is making those optimal decisions, the car must be on track and navigating the course, resulting in accumulating rewards. However, you might see even after high reward episodes the graph dipping, which can happen in early episodes because the car might still have a high degree of exploration, as mentioned earlier.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1833">Reinforcement Learning Theory</a><a name="bookmark1917">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1918">Now that we understand how a reinforcement learning system learns and works, especially in the context of AWS DeepRacer, let’s look at some formal definitions and general reinforcement learning theory. This background will be handy when we solve other problems using reinforcement learning.</a></p><p class="s40" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1834">The Markov decision process</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1919">Markov decision process (MDP) is a discrete stochastic state-transition process framework that is used for modeling decision making in a control process. The markov property defines that each state is solely dependent on the previous state. This is a convenient property because it means that to make a state transition, all of the necessary information must be available in the current state. Theoretical results in reinforcement learning rely on the problem being formulated as an MDP, hence it’s important to understand how to model a problem as an MDP to be solved using reinforcement learning.</a></p><p class="s40" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1835">Model free versus model based</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1920">Model, in this context, refers to the learned representation of the environment. This is useful because we can potentially learn the dynamics in the environment and train our agent using the model rather than having to use the real environment every time. However, in reality, learning the environment isn’t easy, and it’s often easier to have a representation of the real world in simulation and then jointly learn both perception and dynamics as part of the agent navigation rather than one after the other in a sequence. In this chapter, we focus only on model-free reinforcement learning.</a></p><p class="s40" style="padding-top: 11pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1836">Value based</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1921">For every action taken by the agent, there’s a corresponding reward assigned by the reward function. For any given state-action pair, it’s helpful to know its value (reward). If such a function were to exist, we could compute the maximum reward that can be achieved in any state and simply select the corresponding action to navigate the environment. For example, in a game  of 3x3 tic-tac-toe, there are a finite number of game situations, so we could build a lookup table to give us the best move given the situation. But in a game of chess, given the size of the board and complexity of the game, such a lookup table would be computationally expensive to build and memory storage would be large. Thus, in a complex environment it’s difficult to tabulate state-action value pairs or define a function that can map state- action pairs to values. So, instead we try to use a neural network by parameterizing the value function and using a neural network to approximate</a></p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">the value for every action given a state observation. An example of a value- based algorithm is Deep Q-Learning.</p><p class="s40" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1837">Policy based</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1922">A policy is a set of rules that the agent learns to navigate the environment. Simply put the policy function tells the agent which action is the best action to take from its current state. Policy-based reinforcement learning algorithms like REINFORCE and Policy Gradients find the optimal policy without the need to map values to states. In reinforcement learning, we parameterize the policy. In other words, we allow a neural network to learn what the optimal policy function is.</a></p><p class="s40" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1838">Policy based or value based — why not both?</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1923">There’s always been a debate about whether to use policy-based or value- based reinforcement learning. Newer architectures try to learn both the value function and policy function together rather than keeping one fixed. This approach in reinforcement learning is called </a><i>actor critic</i>.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">You can associate the actor with the policy and the critic with the value function. The actor is responsible for taking actions, and the critic is responsible for estimating the “goodness,” or the value of those actions. The actor maps states to actions, and the critic maps state-action pairs to values. In the actor-critic paradigm, the two networks (actor and critic) are trained separately using gradient ascent to update the weights of our deep neural network. (Remember that our goal is to maximize cumulative rewards; thus, we need to find global maxima.) As the episodes roll by, the actor becomes better at taking actions that lead to higher reward states, and the critic also becomes better at estimating the values of those actions. The signal for both the actor and critic to learn comes purely from the reward function.</p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1924">The value for a given state-action pair is called </a><i>Q value</i>, denoted by Q(s,a). We can decompose the Q value into two parts: the estimated value and a quantitative measure of the factor by which the action is better than others. This measure is called the <i>Advantage </i>function. We can view Advantage as the difference between the actual reward for a given state-action pair and the expected reward at that state. The higher the difference, the farther we are from selecting an optimal action.</p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Given that estimating the value of the state could end up being a difficult problem, we can focus on learning the advantage function. This allows us to evaluate the action not only based on how good it is, but also based on how much better it could be. This allows us to converge to an optimal policy much easier than other simpler policy gradient-based methods because, generally, policy networks have high variance.</p><p class="s40" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1839">Delayed rewards and discount factor (γ)</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1925">Rewards are given for every state transition based on the action taken. But the impact of these rewards might be nonlinear. For certain problems the immediate rewards might be more important, and in some cases the future rewards more important. As an example, if we were to build a stock-trading algorithm, the future rewards might have higher uncertainty; thus, we would need to discount appropriately. The discount factor (γ) is a multiplication factor between [0,1], where closer to zero indicates rewards in the immediate future are more important. With a high value that’s closer to 1, the agent will focus on taking actions that maximize future rewards.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1840">Reinforcement Learning Algorithm in AWS DeepRacer</a><a name="bookmark1926">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1927">First, let’s look at one of the simplest examples of a policy optimization reinforcement learning algorithm: vanilla policy gradient.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 32pt;text-indent: 0pt;text-align: left;"><span><img width="525" height="239" alt="image" src="KerasTensorFlow2019/Image_1080.jpg"/></span></p><p class="s145" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;">Figure 17-16. Training process for the vanilla policy gradient algorithm</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">We can think of a deep reinforcement learning model as consisting of two parts: the input embedder and policy network. The input embedder will extract features from the image input and pass it to the policy network, which makes decisions; for instance, predict which action is the best for the given input state. Given that our input is an image, we use convolution layers (CNNs) to extract features. Because the policy is something we want to learn, we parameterize our policy function, the simplest of which can be learned with a fully connected layer. The input CNN layers take in an image and then the policy network uses the image features as input and outputs an action. Thus, mapping state to action. As the model trains, we become better at mapping the input space and extracting relevant features and also optimizing the policy to get the best action for each state. Our goal here is to collect maximum cumulative rewards. To achieve that, our model weights are updated such to maximize the cumulative future reward, and in doing so, we give a higher probability to the action that leads to the higher cumulative future reward. In training neural networks previously, we used stochastic gradient descent or its variation; when training an reinforcement learning system, we seek to maximize the cumulative reward; so, instead of minimization, we look to maximize. So, we use gradient ascent to move the weights in the direction of the steepest reward signal.</p><p class="s39" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1929" class="s30" name="bookmark1928">DeepRacer uses an advanced variation of policy optimization, called Proximal Policy Optimization (PPO), summarized in </a>Figure 17-17<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 32pt;text-indent: 0pt;text-align: left;"><span><img width="516" height="220" alt="image" src="KerasTensorFlow2019/Image_1081.jpg"/></span></p><p class="s145" style="padding-top: 7pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1929">Figure 17-17. Training using the PPO algorithm</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s39" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1929" class="s30">On the left side of </a>Figure 17-17<span style=" color: #000;">, we have our simulator using the latest policy (model) to get new experience (s,a,r,s&#39;). The experience is fed into an experience replay buffer that feeds our PPO algorithm after we have a set number of episodes.</span></p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1929" class="s30">On the right side of </a>Figure 17-17<span style=" color: #000;">, we update our model using PPO. Although PPO is a policy optimization method, it uses the advantage actor-critic method, which we described earlier. We compute the PPO gradient and shift policy in the direction where we get the highest rewards. Blindly taking large steps in this direction can cause too much variability in training; if we take small steps training can take forever. PPO improves the stability of the policy (actor) by limiting how much the policy can update at each training step. This is done by using a clipped surrogate objective function, which prevents the policy from being updated too much, thus solving large variance, a common issue with policy optimization methods. Typically, for PPO, we keep the ratio of new and old policy at [0.8, 1.2]. The critic tells the actor how good the action taken was, and how the actor should adjust its network. After the policy is updated the new model is sent to the simulator to get more experience.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1841">Deep Reinforcement Learning Summary with DeepRacer as an Example</a><a name="bookmark1930">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1931">To solve any problem with reinforcement learning, we need to work through the following steps:</a></p><ol id="l57"><li><p class="s17" style="padding-top: 4pt;padding-left: 51pt;text-indent: -14pt;text-align: left;">Define the goal.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 51pt;text-indent: -14pt;text-align: left;">Select the input state.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 51pt;text-indent: -14pt;text-align: left;">Define the action space.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 51pt;text-indent: -14pt;text-align: left;">Construct the reward function.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 51pt;text-indent: -14pt;text-align: left;">Define the DNN architecture.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 51pt;text-indent: -14pt;text-align: left;">Pick the reinforcement learning optimization algorithm (DQN, PPO, etc.).</p></li></ol></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">The fundamental manner in which a reinforcement learning model trains doesn’t change if we are building a self-driving car or building a robotic arm to grasp objects. This is a huge benefit of the paradigm because it allows us to focus on a much higher level of abstraction. To solve a problem using reinforcement learning, the main task at hand is to define our problem as an MDP, followed by defining the input state and set of actions that the agent can take in a given environment, and the reward function. Practically speaking, the reward function can be one of the most difficult parts to define, and often is the most important as this is what influences the policy that our agent learns. After all the environment-dependent factors are defined, we can then focus on what the deep neural network architecture should be to map the input to actions, followed by picking the reinforcement learning algorithm (value-based, policy-based, actor-critic-based) to learn. After we pick the algorithm, we can focus on the high level knobs to control what the algorithm does. When we drive a car, we tend to focus on controls, and the understanding of the internal combustion engine doesn’t influence too much the way we drive. Similarly, as long as we understand the knobs that each algorithm exposes, we can train a reinforcement learning model.</p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">It’s time to bring this home. Let’s formulate the DeepRacer racing problem:</p><ol id="l58"><li><p class="s17" style="padding-top: 5pt;padding-left: 51pt;text-indent: -14pt;text-align: left;">Goal: To finish a lap by going around the track in the least amount of time</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 51pt;text-indent: -14pt;text-align: left;">Input: Grayscale 120x160 image</p></li><li><p class="s17" style="padding-top: 3pt;padding-left: 51pt;text-indent: -14pt;text-align: left;">Actions: Discrete actions with combined speed and steering angle values</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 51pt;text-indent: -14pt;text-align: left;">Rewards: Reward the car for being on the track, incentivize going faster, and prevent from doing a lot of corrections or zigzag behavior</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 51pt;text-indent: -14pt;text-align: left;">DNN architecture: Three-layer CNN + fully connected layer (Input → CNN → CNN → CNN → FC → Output)</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 51pt;text-indent: -14pt;text-align: left;">Optimization algorithm: PPO</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1842">Step 5: Improving Reinforcement Learning Models</a><a name="bookmark1932">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1933">We can now look to improve our models and also get insights into our model training. First, we focus on training improvements in the console. We have at our disposal the ability to change the reinforcement learning algorithm settings and neural network hyperparameters.</a></p><p class="s40" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1843">Algorithm settings</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">This section specifies the hyperparameters that will be used by the reinforcement learning algorithm during training. Hyperparameters are used to improve training performance.</p><p class="s40" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1844">Hyperparameters for the neural network</a></p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Table 17-2 <span style=" color: #000;">presents the hyperparameters that are available to tune the neural network. Even though the default values have experimentally proven to be good, practically speaking the developer should focus on the batch size, number of epochs, and the learning rate as they were found to be the most influential in producing high-quality models; that is, getting the best out of our reward function.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s22" style="padding-left: 168pt;text-indent: -155pt;text-align: left;"><a name="bookmark1934">Table 17-2. Description and guidance for tuneable hyperparameters for the deep neural network</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="583" height="1" alt="image" src="KerasTensorFlow2019/Image_1082.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="590" height="1" alt="image" src="KerasTensorFlow2019/Image_1083.png"/></span></p><p class="s153" style="padding-top: 2pt;padding-left: 9pt;text-indent: 0pt;text-align: left;">Parameter Description Tips</p><p style="text-indent: 0pt;text-align: left;"><span><img width="590" height="148" alt="image" src="KerasTensorFlow2019/Image_1084.png"/></span></p><p class="s147" style="text-indent: 0pt;line-height: 108%;text-align: left;">Use a larger number of epochs to promote more stable updates, but expect slower training. When the batch size is small, we can use a smaller number of epochs.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s147" style="padding-left: 61pt;text-indent: -61pt;line-height: 108%;text-align: left;">epochs    where the neural network weights are updated after each batch is processed, before proceeding to the next batch. Ten epochs implies we update the neural network weights, using all batches one at a time, but repeat this process 10 times.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s147" style="text-indent: 0pt;line-height: 12pt;text-align: left;">Number of An epoch represents one pass through all batches,</p><p style="text-indent: 0pt;text-align: left;"/><p class="s147" style="padding-top: 6pt;padding-left: 70pt;text-indent: -61pt;line-height: 108%;text-align: left;">Batch size The number recent of vehicle experiences sampled at random from an experience buffer and used for updating the underlying deep learning neural network weights. If we have 5,120 experiences in the buffer, and specify a batch size of 512, then ignoring random sampling, we will get 10 batches of experience. Each batch will be used, in turn, to update our neural network weights during training.</p><p class="s147" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;line-height: 108%;text-align: left;">Use a larger batch size to promote more stable and smooth updates to the neural network weights, but be aware of the possibility that the training may be slower.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:6.54899pt" cellspacing="0"><tr style="height:19pt"><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Parameter</p></td><td style="width:253pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Description</p></td><td style="width:128pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#9D9D9D"><p class="s149" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;text-align: left;">Tips</p></td></tr><tr style="height:15pt"><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Learning</p></td><td style="width:253pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">The learning rate controls how big the updates to</p></td><td style="width:128pt;border-top-style:solid;border-top-width:1pt;border-top-color:#9D9D9D"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">A larger learning rate will</p></td></tr><tr style="height:13pt"><td style="width:61pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">rate</p></td><td style="width:253pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">the neural network weights are. Simply put, when</p></td><td style="width:128pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">lead to faster training,</p></td></tr><tr style="height:13pt"><td style="width:61pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">we need to change the weights of our policy to get</p></td><td style="width:128pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">but it may struggle to</p></td></tr><tr style="height:13pt"><td style="width:61pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">to the maximum cumulative reward, how much</p></td><td style="width:128pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">converge. Smaller</p></td></tr><tr style="height:13pt"><td style="width:61pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">should we shift our policy.</p></td><td style="width:128pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">learning rates lead to</p></td></tr><tr style="height:13pt"><td style="width:61pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:128pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">stable convergence, but</p></td></tr><tr style="height:13pt"><td style="width:61pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:128pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">can take a long time to</p></td></tr><tr style="height:16pt"><td style="width:61pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:128pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;text-align: left;">train.</p></td></tr><tr style="height:15pt"><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Exploration</p></td><td style="width:253pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">This refers to the method used to determine the</p></td><td style="width:128pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Since we will be using a</p></td></tr><tr style="height:13pt"><td style="width:61pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">trade-off between exploration and exploitation. In</p></td><td style="width:128pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">discrete action space, we</p></td></tr><tr style="height:13pt"><td style="width:61pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">other words, what method should we use to</p></td><td style="width:128pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">should always select</p></td></tr><tr style="height:13pt"><td style="width:61pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">determine when we should stop exploring</p></td><td style="width:128pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">“CategoricalParameters.”</p></td></tr><tr style="height:13pt"><td style="width:61pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">(randomly choosing actions) and when should we</p></td><td style="width:128pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:16pt"><td style="width:61pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;text-align: left;">exploit the experience we have built up.</p></td><td style="width:128pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:15pt"><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Entropy</p></td><td style="width:253pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">A degree of uncertainty, or randomness, added to</p></td><td style="width:128pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:13pt"><td style="width:61pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">the probability distribution of the action space. This</p></td><td style="width:128pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:13pt"><td style="width:61pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">helps promote the selection of random actions to</p></td><td style="width:128pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:16pt"><td style="width:61pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;text-align: left;">explore the state/action space more broadly.</p></td><td style="width:128pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:15pt"><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Discount</p></td><td style="width:253pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">A factor that specifies how much the future rewards</p></td><td style="width:128pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">The recommended</p></td></tr><tr style="height:13pt"><td style="width:61pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">factor</p></td><td style="width:253pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">contribute to the expected cumulative reward. The</p></td><td style="width:128pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">discount factor values</p></td></tr><tr style="height:13pt"><td style="width:61pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">larger the discount factor, the farther out the model</p></td><td style="width:128pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">are 0.99, 0.999, and</p></td></tr><tr style="height:13pt"><td style="width:61pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">looks to determine the expected cumulative reward</p></td><td style="width:128pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">0.9999.</p></td></tr><tr style="height:13pt"><td style="width:61pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">and the slower the training. With a discount factor</p></td><td style="width:128pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:13pt"><td style="width:61pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">of 0.9, the vehicle includes rewards from an order</p></td><td style="width:128pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:13pt"><td style="width:61pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">of 10 future steps to make a move. With a discount</p></td><td style="width:128pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:13pt"><td style="width:61pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">factor of 0.999, the vehicle considers rewards from</p></td><td style="width:128pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:16pt"><td style="width:61pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;text-align: left;">an order of 1,000 future steps to make a move.</p></td><td style="width:128pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:15pt"><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Loss type</p></td><td style="width:253pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">The loss type specifies the type of the objective</p></td><td style="width:128pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">When we have</p></td></tr><tr style="height:13pt"><td style="width:61pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">function (cost function) used to update the network</p></td><td style="width:128pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">convergence problems,</p></td></tr><tr style="height:13pt"><td style="width:61pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">weights. The Huber and mean squared error loss</p></td><td style="width:128pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">use the Huber loss type.</p></td></tr><tr style="height:13pt"><td style="width:61pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">types behave similarly for small updates. But as</p></td><td style="width:128pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">When convergence is</p></td></tr><tr style="height:13pt"><td style="width:61pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">the updates become larger, the Huber loss takes</p></td><td style="width:128pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">good and we want to</p></td></tr><tr style="height:13pt"><td style="width:61pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">smaller increments compared to the mean squared</p></td><td style="width:128pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">train faster, use the</p></td></tr><tr style="height:13pt"><td style="width:61pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">error loss.</p></td><td style="width:128pt"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">mean squared error loss</p></td></tr><tr style="height:16pt"><td style="width:61pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:128pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;text-align: left;">type.</p></td></tr><tr style="height:15pt"><td style="width:61pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Number of</p></td><td style="width:253pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">This parameter controls how much experience the</p></td><td style="width:128pt;border-top-style:solid;border-top-width:1pt;border-top-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-top: 2pt;padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">The recommended</p></td></tr><tr style="height:13pt"><td style="width:61pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">episodes</p></td><td style="width:253pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">car should obtain between each model training</p></td><td style="width:128pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">values are 10, 20, and</p></td></tr><tr style="height:13pt"><td style="width:61pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">between</p></td><td style="width:253pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">iteration. For more complex problems that have</p></td><td style="width:128pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">40.</p></td></tr><tr style="height:13pt"><td style="width:61pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">each</p></td><td style="width:253pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">more local maxima, a larger experience buffer is</p></td><td style="width:128pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:13pt"><td style="width:61pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">training</p></td><td style="width:253pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">necessary to provide more uncorrelated data</p></td><td style="width:128pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:13pt"><td style="width:61pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;line-height: 12pt;text-align: left;">points. In this case, training will be slower but more</p></td><td style="width:128pt" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:16pt"><td style="width:61pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:253pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p class="s150" style="padding-left: 3pt;text-indent: 0pt;text-align: left;">stable.</p></td><td style="width:128pt;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#C2C2C2" bgcolor="#F1F5FB"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s40" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;"><a name="bookmark1845">Insights into model training</a></p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: justify;"><a href="#bookmark1903" class="s30">After the model is trained, at a macro level the rewards over time graph, like the one in </a>Figure 17-10<span style=" color: #000;">, gives us an idea of how the training progressed and the point at which the model begins to converge. But it doesn’t give us an</span></p><p class="s39" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="https://oreil.ly/OWw_E" class="s30" target="_blank">indication of the converged policy, insights into how our reward function behaved, or areas where the speed of the car could be improved. To help gain more insights, we developed a </a>Jupyter Notebook <span style=" color: #000;">that analyzes the training logs, and provides suggestions. In this section, we look at some of the more useful visualization tools that can be used to gain insight into our model’s training.</span></p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">The log file records every step that the car takes. At each step it records the x,y location of the car, yaw (rotation), the steering angle, throttle, the progress from the start line, action taken, reward, the closest waypoint, and so on.</p><p class="s40" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1846">Heatmap visualization</a></p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1936" class="s30" name="bookmark1935">For complex reward functions, we might want to understand reward distribution on the track; that is, where did the reward function give rewards to the car on the track, and its magnitude. To visualize this, we can generate a heatmap, as shown in </a>Figure 17-18<a href="https://oreil.ly/n-w7G" class="s30" target="_blank">. Given that the reward function we used gave the maximum rewards closest to the center of the track, we see that region to be bright and a tiny band on either side of the centerline beyond it to be red, indicating fewer rewards. Finally, the rest of the track is dark, indicating no rewards or rewards close to 0 were given when the car was in those locations. We can follow the </a>code <span style=" color: #000;">to generate our own heatmap and investigate our reward distribution.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 32pt;text-indent: 0pt;text-align: left;"><span><img width="516" height="334" alt="image" src="KerasTensorFlow2019/Image_1085.jpg"/></span></p><p class="s145" style="padding-top: 7pt;padding-left: 38pt;text-indent: 0pt;text-align: left;"><a name="bookmark1936">Figure 17-18. Heatmap visualization for the example centerline reward function</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s40" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1847">Improving the speed of our model</a></p><p class="s39" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="https://oreil.ly/tLOtk" class="s30" target="_blank">After we run an evaluation, we get the result with lap times. At this point, we might be curious as to the path taken by the car or where it failed, or perhaps the points where it slowed down. To understand all of these, we can use the code in this </a>notebook <a href="#bookmark1937" class="s30">to plot a race heatmap. In the example that follows, we can observe the path that the car took to navigate around the track and also visualize the speeds at which it passes through at various points on the track. This gives us insight into parts that we can optimize. One quick look at </a>Figure 17-19 <span style=" color: #000;">(left) indicates that the car didn’t really go fast at the straight part of the track; this provides us with an opportunity. We could incentivize the model by giving more rewards to go faster at this part of the track.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 34pt;text-indent: 0pt;text-align: left;"><span><img width="518" height="306" alt="image" src="KerasTensorFlow2019/Image_1086.jpg"/></span></p><p class="s145" style="padding-top: 7pt;padding-left: 55pt;text-indent: -32pt;line-height: 108%;text-align: left;"><a name="bookmark1937">Figure 17-19. Speed heatmap of an evaluation run; (left) evaluation lap with the basic example reward function, (right) faster lap with modified reward function</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s39" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1937" class="s30">In </a>Figure 17-19 <a href="#bookmark1937" class="s30">(left), it seems like the car has a small zigzag pattern at times, so one improvement here could be that we penalize the car when it turns too much. In the code example that follows, we multiply the reward by a factor of 0.8, if the car is steering beyond a threshold. We also incentivize the car to go faster by giving 20% more reward if the car goes at 2 m/s or more. When trained with this new reward function, we can see that the car does go faster than the previous reward function. </a>Figure 17-19 <span style=" color: #000;">(right) shows more stability; the car follows the centerline almost to perfection and finishes the lap roughly two seconds faster than our first attempt. This is just a glimpse in to improving the model. We can continue to iterate on our models and clock better lap times using these tools. All of the suggestions are incorporated in to the reward function example shown here:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s75" style="padding-left: 19pt;text-indent: 0pt;text-align: left;"><span class="s77">def </span><span style=" color: #C0F;">reward_function</span>(<span style=" color: #000087;">params</span>):</p><p class="s205" style="padding-left: 40pt;text-indent: 0pt;text-align: left;">&#39;&#39;&#39;</p><p class="s205" style="padding-top: 4pt;padding-left: 40pt;text-indent: 0pt;text-align: left;">Example of penalize steering, which helps mitigate zigzag behaviors and speed incentive</p><p class="s205" style="padding-left: 40pt;text-indent: 0pt;text-align: left;">&#39;&#39;&#39;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s128" style="padding-left: 40pt;text-indent: 0pt;text-align: left;"># Read input parameters</p><p class="s75" style="padding-left: 40pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">distance_from_center </span>= <span style=" color: #000087;">params</span>[<span style=" color: #C30;">&#39;distance_from_center&#39;</span>] <span style=" color: #000087;">track_width </span>= <span style=" color: #000087;">params</span>[<span style=" color: #C30;">&#39;track_width&#39;</span>]</p><p class="s75" style="padding-left: 40pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">steering </span>= <span style=" color: #366;">abs</span>(<span style=" color: #000087;">params</span>[<span style=" color: #C30;">&#39;steering_angle&#39;</span>]) <span class="s128"># Only need absolute steering angle</span></p><p class="s75" style="padding-left: 40pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">speed </span>= <span style=" color: #000087;">params</span>[<span style=" color: #C30;">&#39;speed&#39;</span>] <span class="s128"># in meter/sec</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s128" style="padding-left: 40pt;text-indent: 0pt;text-align: left;"># Calculate 3 markers that are at varying distances away from the center line</p><p class="s75" style="padding-left: 40pt;text-indent: 0pt;text-align: left;"><span style=" color: #000087;">marker_1 </span>= <span style=" color: #F60;">O.1 </span>* <span style=" color: #000087;">track_width marker_2 </span>= <span style=" color: #F60;">O.25 </span>* <span style=" color: #000087;">track_width marker_3 </span>= <span style=" color: #F60;">O.5 </span>* <span style=" color: #000087;">track_width</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s128" style="padding-left: 40pt;text-indent: 0pt;text-align: left;"># Give higher reward if the agent is closer to the center line and vice versa</p><p class="s74" style="padding-left: 60pt;text-indent: -20pt;text-align: left;"><span class="s77">if </span>distance_from_center <span style=" color: #000;">&lt;= </span>marker_1<span style=" color: #000;">: </span>reward <span style=" color: #000;">= </span><span style=" color: #F60;">1</span></p><p class="s74" style="padding-left: 60pt;text-indent: -20pt;text-align: left;"><span class="s77">elif </span>distance_from_center <span style=" color: #000;">&lt;= </span>marker_2<span style=" color: #000;">: </span>reward <span style=" color: #000;">= </span><span style=" color: #F60;">O.5</span></p><p class="s74" style="padding-left: 60pt;text-indent: -20pt;text-align: left;"><span class="s77">elif </span>distance_from_center <span style=" color: #000;">&lt;= </span>marker_3<span style=" color: #000;">: </span>reward <span style=" color: #000;">= </span><span style=" color: #F60;">O.1</span></p><p class="s77" style="padding-left: 40pt;text-indent: 0pt;text-align: left;">else<span class="s75">:</span></p><p class="s74" style="padding-left: 60pt;text-indent: 0pt;text-align: left;">reward <span style=" color: #000;">= </span><span style=" color: #F60;">1e-3 </span><span class="s128"># likely crashed/ close to off track</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s128" style="padding-left: 40pt;text-indent: 0pt;text-align: left;"># Steering penalty threshold, change the number based on your action space</p><p class="s74" style="padding-left: 40pt;text-indent: 10pt;text-align: left;">setting ABS_STEERING_THRESHOLD <span style=" color: #000;">= </span><span style=" color: #F60;">15</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s128" style="padding-left: 40pt;text-indent: 0pt;text-align: left;"># Penalize reward if the agent is steering too much</p><p class="s74" style="padding-left: 60pt;text-indent: -20pt;text-align: left;"><span class="s77">if </span>steering <span style=" color: #000;">&gt; </span>ABS_STEERING_THRESHOLD<span style=" color: #000;">: </span>reward <span style=" color: #000;">*= </span><span style=" color: #F60;">O.8</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s128" style="padding-left: 40pt;text-indent: 0pt;text-align: left;"># Incentivize going faster</p><p class="s75" style="padding-left: 60pt;text-indent: -20pt;text-align: left;"><span class="s77">if </span><span style=" color: #000087;">speed </span>&gt;= <span style=" color: #F60;">2</span>: <span style=" color: #000087;">reward </span>*= <span style=" color: #F60;">1.2</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s144" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: justify;"><a name="bookmark1848">Racing the AWS DeepRacer Car</a><a name="bookmark1938">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: justify;"><a name="bookmark1939">It’s time to bring what we’ve learned so far from the virtual to the physical world and race a real autonomous car. Toy sized, of course!</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: justify;">If you own an AWS DeepRacer car, follow the instructions provided to test your model on a physical car. For those interested in buying the car, AWS DeepRacer is available for purchase on Amazon.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1849">Building the Track</a><a name="bookmark1940">&zwnj;</a></p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="https://oreil.ly/2xZQA" class="s30" target="_blank">Now that we have a trained model, we can evaluate this model on a real track and with a physical AWS DeepRacer car. First, let’s build a makeshift track at home to race our model. For simplicity, we’ll build only part of a racetrack, but instructions on how to build an entire track are provided </a>here<span style=" color: #000;">.</span></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">To build a track, you need the following materials:</p><p class="s22" style="padding-top: 10pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">For track borders:</p><p style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: left;"><a href="https://oreil.ly/2x6dl" class="s30" target="_blank">We can create a track with tape that is about two-inches wide and white or off-white color against the dark-colored track surface. In the virtual environment, the thickness of the track markers is set to be two inches. For a dark surface, use a white or off-white tape. For example, </a><a href="https://oreil.ly/2x6dl" class="s18" target="_blank">1.88-inch width, pearl white duct tape </a><a href="https://oreil.ly/Hn0AD" class="s30" target="_blank">or </a><a href="https://oreil.ly/2x6dl" class="s18" target="_blank">1.88-inch (less sticky) masking tape</a><a href="https://oreil.ly/2x6dl" class="s30" target="_blank">.</a></p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">For track surface:</p><p class="s39" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: left;"><a href="https://oreil.ly/7Q1ae" class="s30" target="_blank">We can create a track on a dark-colored hard floor such as hardwood, carpet, concrete, or </a>asphalt felt<span style=" color: #000;">. The latter mimics the real-world road surface with minimal reflection.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1850">AWS DeepRacer Single-Turn Track Template</a><a name="bookmark1941">&zwnj;</a></p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1942" class="s30">This basic track template consists of two straight track segments connected by a curved track segment, as illustrated in </a>Figure 17-20<span style=" color: #000;">. Models trained with this track should make our AWS DeepRacer vehicle drive in a straight line or make turns in one direction. </span><span class="s22">The angular dimensions for the turns specified are suggestive; we can use approximate measurements when laying down the track.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 32pt;text-indent: 0pt;text-align: left;"><span><img width="513" height="248" alt="image" src="KerasTensorFlow2019/Image_1087.jpg"/></span></p><p class="s145" style="padding-top: 6pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1942">Figure 17-20. The test track layout</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1851">Running the Model on AWS DeepRacer</a><a name="bookmark1943">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">To start the AWS DeepRacer vehicle on autonomous driving, we must upload at least one AWS DeepRacer model to our AWS DeepRacer vehicle.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">To upload a model, pick our trained model from the AWS DeepRacer console and then download the model artifacts from its Amazon S3 storage to a (local or network) drive that can be accessed from the computer. There’s an easy download model button provided on the model page.</p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">To upload a trained model to the vehicle, do the following:</p><ol id="l59"><li><p class="s39" style="padding-top: 5pt;padding-left: 51pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1944" class="s30">From the device console’s main navigation pane, choose Models, as shown in </a><a href="#bookmark1944" class="s18">Figure </a>17-21<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 55pt;text-indent: 0pt;text-align: left;"><span><img width="522" height="205" alt="image" src="KerasTensorFlow2019/Image_1088.jpg"/></span></p><p class="s145" style="padding-top: 6pt;padding-left: 58pt;text-indent: 0pt;text-align: left;"><a name="bookmark1944">Figure 17-21. The Model upload menu on the AWS DeepRacer car web console</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-top: 9pt;padding-left: 51pt;text-indent: -14pt;text-align: left;">On the Models page, above the Models list, choose Upload.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 51pt;text-indent: -14pt;text-align: left;">From the file picker, navigate to the drive or share where you downloaded the model artifacts and choose the model for upload.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 51pt;text-indent: -14pt;text-align: left;">When the model is uploaded successfully, it will be added to the Models list and can be loaded into the vehicle’s inference engine.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1852">Driving the AWS DeepRacer Vehicle Autonomously</a><a name="bookmark1945">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">To start autonomous driving, place the vehicle on a physical track and do the following:</p><ol id="l60"><li><p class="s39" style="padding-top: 4pt;padding-left: 51pt;text-indent: -14pt;text-align: left;"><a href="https://oreil.ly/OwzSz" class="s30" target="_blank">Follow </a>the instructions <span style=" color: #000;">to sign in to the vehicle’s device console, and then do the following for autonomous driving:</span></p><p class="s39" style="padding-top: 5pt;padding-left: 77pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1946" class="s30">a. On the “Control vehicle” page, in the Controls section, choose “Autonomous driving,” as shown in </a>Figure 17-22<span style=" color: #000;">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 117pt;text-indent: 0pt;text-align: left;"><span><img width="392" height="342" alt="image" src="KerasTensorFlow2019/Image_1089.jpg"/></span></p><p class="s145" style="padding-top: 5pt;padding-left: 244pt;text-indent: -164pt;line-height: 108%;text-align: left;"><a name="bookmark1946">Figure 17-22. Driving mode selection menu on the AWS DeepRacer car web console</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s39" style="padding-top: 8pt;padding-left: 51pt;text-indent: -14pt;text-align: left;"><a href="#bookmark1947" class="s30">On the “Select a model” drop-down list (</a>Figure 17-23<span style=" color: #000;">), choose an uploaded model, and then choose “Load model.” This will start loading the model into the inference engine. The process takes about 10 seconds to complete.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 51pt;text-indent: -14pt;text-align: left;">Adjust the “Maximum speed” setting of the vehicle to be a percentage of the maximum speed used in training the model. (Certain factors such as surface friction of the real track can reduce the maximum speed of the vehicle from the maximum speed used in the training. You’ll need to experiment to find the optimal setting.)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 55pt;text-indent: 0pt;text-align: left;"><span><img width="519" height="263" alt="image" src="KerasTensorFlow2019/Image_1090.jpg"/></span></p><p class="s145" style="padding-top: 6pt;padding-left: 73pt;text-indent: 0pt;text-align: left;"><a name="bookmark1947">Figure 17-23. Model selection menu on AWS DeepRacer car web console</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-top: 9pt;padding-left: 51pt;text-indent: -14pt;text-align: left;">Choose “Start vehicle” to set the vehicle to drive autonomously.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 51pt;text-indent: -14pt;text-align: left;">Watch the vehicle drive on the physical track or the streaming video player on the device console.</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s17" style="padding-left: 51pt;text-indent: -14pt;text-align: left;">To stop the vehicle, choose “Stop vehicle.”</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s40" style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1853">Sim2Real transfer</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1948">Simulators can be more convenient than the real world to train on. Certain scenarios can be easily created in a simulator; for example, a car colliding with a person or another car — we wouldn’t want to do this in the real world</a></p><p class="s17" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">:). However, the simulator in most cases will not have the visual fidelity we do in the real world. Also, it might not be able to capture the physics of the real world. These factors can affect modeling the environment in the simulator, and as a result, even with great success in simulation, when the agent runs in the real world, we can experience failures. Here are some of the common approaches to handle the limitations of the simulator:</p><p class="s22" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">System identification</p><p class="s17" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: left;">Build a mathematical model of the real environment and calibrate the physical system to be as realistic as possible.</p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Domain adaptation</p><p class="s17" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: left;">Map the simulation domain to the real environment, or vice versa, using techniques such as regularization, GANs, or transfer learning.</p><p class="s22" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Domain randomization</p><p class="s17" style="padding-top: 3pt;padding-left: 32pt;text-indent: 0pt;text-align: left;">Create a variety of simulation environments with randomized properties and train a model on data from all these environments.</p><p class="s17" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">In the context of DeepRacer, the simulation fidelity is an approximate representation of the real world, and the physics engine could use some improvements to adequately model all the possible physics of the car. But the beauty of deep reinforcement learning is that we don’t need everything to be perfect. To mitigate large perceptual changes affecting the car, we do two major things: a) instead of using an RGB image, we grayscale the image to make the perceptual differences between the simulator and the real world narrower, and b) we intentionally use a shallow feature embedder; for instance, we use only a few CNN layers; this helps the network not learn the simulation environment entirely. Instead it forces the network to learn only the important features. For example, on the race track the car learns to focus on navigating using the white track extremity markers. Take a look at</p><p class="s39" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1949">Figure 17-24</a><span style=" color: #000;">, which uses a technique called GradCAM to generate a heatmap of the most influential parts of the image to understand where the car is looking for navigation.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 34pt;text-indent: 0pt;text-align: left;"><span><img width="516" height="129" alt="image" src="KerasTensorFlow2019/Image_1091.jpg"/></span></p><p class="s145" style="padding-top: 7pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1950">Figure 17-24. GradCAM heatmaps for AWS DeepRacer navigation</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s144" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1854">Further Exploration</a><a name="bookmark1951">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1952">To continue with the adventure, you can become involved in various virtual and physical racing leagues. Following are a few options to explore.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1855">DeepRacer League</a><a name="bookmark1953">&zwnj;</a></p><p style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="https://console.aws.amazon.com/deepracer/home?region=us-east-1&amp;leaderboards" class="s30" target="_blank" name="bookmark1954">AWS DeepRacer has a physical league at AWS summits and monthly virtual leagues. To race in the current virtual track and win prizes, visit the league page: </a><a href="https://console.aws.amazon.com/deepracer/home?region=us-east-1&amp;leaderboards" class="s21" target="_blank">https://console.aws.amazon.com/deepracer/home?region=us-east- 1#leaderboards</a><a href="https://console.aws.amazon.com/deepracer/home?region=us-east-1&amp;leaderboards" class="s30" target="_blank">.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1856">Advanced AWS DeepRacer</a><a name="bookmark1955">&zwnj;</a></p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="https://oreil.ly/Xto3S" class="s30" target="_blank" name="bookmark1956">We understand that some advanced developers might want more control over the simulation environment and also have the ability to define different neural network architectures. To enable this experience, we provide a </a>Jupyter Notebook<span style=" color: #000;">–based setup with which you can provision the components needed to train your custom AWS DeepRacer models.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1857">AI Driving Olympics</a><a name="bookmark1957">&zwnj;</a></p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1959" class="s30" name="bookmark1958">At NeurIPS 2018, the AI Driving Olympics (AI-DO) was launched with a focus on AI for self-driving cars. During the first edition, this global competition featured lane-following and fleet-management challenges on the Duckietown platform (</a>Figure 17-25<span style=" color: #000;">). This platform has two components, Duckiebots (miniature autonomous taxis), and Duckietowns (miniature city environments featuring roads, signs). Duckiebots have one job — to transport the citizens of Duckietown (the duckies). Onboard with a tiny camera and running the computations on Raspberry Pi, Duckiebots come with easy-to-use software, helping everyone from high schoolers to university researchers to get their code running relatively quickly. Since the first edition of the AI-DO, this competition has expanded to other top AI academic conferences and now includes challenges featuring both Duckietown and DeepRacer platforms.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 77pt;text-indent: 0pt;text-align: left;"><span><img width="397" height="369" alt="image" src="KerasTensorFlow2019/Image_1092.jpg"/></span></p><p class="s145" style="padding-top: 8pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1959">Figure 17-25. Duckietown at the AI Driving Olympics</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1858">DIY Robocars</a><a name="bookmark1960">&zwnj;</a></p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="https://oreil.ly/SJOfT" class="s30" target="_blank" name="bookmark1961">The </a>DIY Robocars Meetup<span style=" color: #000;">, initially started in Oakland (California), now has expanded to more than 50 meetup groups around the world. These are fun and engaging communities to try and work with other enthusiasts in the self- driving and autonomous robocar space. Many of them run monthly races and are great venues to physically race your robocar.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s152" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1859">Roborace</a><a name="bookmark1962">&zwnj;</a></p><p class="s39" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="#bookmark1965" class="s30" name="bookmark1963">It’s time to channel our inner Michael Schumacher. Motorsports is typically considered a competition of horsepower, and now Roborace is turning it into a competition of intelligence. Roborace organizes competitions between all- electric, self-driving race cars, like the sleek-looking Robocar designed by Daniel Simon (known for futuristic designs like the Tron Legacy Light Cycle), shown in </a>Figure 17-26<span style=" color: #000;">. We are not talking about miniature-scaled cars anymore. These are full-sized, 1,350 kg, 4.8 meters, capable of reaching 200 mph (320 kph). The best part? We don’t need intricate hardware knowledge to race them.</span></p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">The real stars here are AI developers. Each team gets an identical car, so that the winning edge is focused on the autonomous AI software written by the competitors. Output of onboard sensors such as cameras, radar, lidar, sonar, and ultrasonic sensors is available. For high-throughput computations, the cars are also loaded with the powerful NVIDIA DRIVE platform capable of processing several teraflops per second. All we need to build is the algorithm to let the car stay on track, avoid getting into an accident, and of course, get ahead as fast as possible.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="590" height="243" alt="image" src="KerasTensorFlow2019/Image_1093.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s153" style="padding-left: 65pt;text-indent: 0pt;text-align: center;">FROM THE CREATOR’S DESK</p><p class="s147" style="padding-top: 6pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;">By Anima Anandkumar, director of research, NVIDIA, Bren Professor, California Institute of Technology</p><p class="s147" style="padding-top: 5pt;padding-left: 10pt;text-indent: 0pt;text-align: left;">Future and Evolution of Reinforcement Learning</p><p class="s147" style="padding-top: 6pt;padding-left: 10pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark1964">We would not see reinforcement learning in the usual sense where learning is assumed to be from scratch with no prior knowledge or structure. Instead, I like to use the term “interactive learning,” which is broader. This includes active learning where data collection is done actively based on limitations of the current model that is being trained. I envision the use of physics-infused learning in rob6tics in which we incorporate physics and classical control but add learning to improve efficiency while maintaining stability and safety.</a></p><p style="text-indent: 0pt;text-align: left;"/><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">To get started, Roborace provides a race simulation environment where precise virtual models of real cars are available. Along comes virtual qualification rounds, where the winners get to participate in real races including at Formula E circuits. By 2019, the top racing teams have already closed the gap to within 5–10% of the best human performances in races. Soon developers will be standing on top of the podium, after beating professional drivers. Ultimately, competitions like these lead to innovations and hopefully the learnings can be translated back to the autonomous car industry, making them safer, more reliable, and performant at the same time.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 32pt;text-indent: 0pt;text-align: left;"><span><img width="520" height="293" alt="image" src="KerasTensorFlow2019/Image_1094.jpg"/></span></p><p class="s145" style="padding-top: 6pt;padding-left: 202pt;text-indent: -176pt;line-height: 108%;text-align: left;"><a name="bookmark1965">Figure 17-26. Robocar from Roborace designed by Daniel Simon (image courtesy of Roborace)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s144" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1860">Summary</a><a name="bookmark1966">&zwnj;</a></p><p class="s17" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">In the previous chapter, we looked at how to train a model for an autonomous vehicle by manually driving inside the simulator. In this chapter, we explored concepts related to reinforcement learning and learned how to formulate the ultimate problem on everyone’s mind: how to get an autonomous car to learn how to drive. We used the magic of reinforcement learning to remove the human from the loop, teaching the car to drive in a simulator on its own. But why limit it to the virtual world? We brought the learnings into the physical world and raced a real car. And all it took was an hour!</p><p class="s17" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a name="bookmark1967">Deep reinforcement learning is a relatively new field but an exciting one to explore further. Some of the recent extensions to reinforcement learning are opening up new problem domains where its application can bring about large-scale automation. For example, hierarchical reinforcement learning allows us to model fine-grained decision making. Meta-RL allows us to model generalized decision making across environments. These frameworks are getting us closer to mimicking human-like behavior. It’s no surprise that a lot of machine learning researchers believe reinforcement learning has the potential to get us closer to </a><i>artificial general intelligence </i>and open up avenues that were previously considered science fiction.</p><h4 style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 106%;text-align: left;"><a name="bookmark1968">Appendix A. A Crash Course in Convolutional Neural Networks</a><a name="bookmark1980">&zwnj;</a></h4><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="589" height="1" alt="image" src="KerasTensorFlow2019/Image_1095.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s100" style="padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a href="#bookmark2006" class="s110">In keeping with the word “practical” in the book’s title, we’ve focused heavily on the real-world aspects of deep learning. The goal of this appendix is meant to serve as reference material, rather than a full- fledged exploration into the theoretical aspects of deep learning. To develop a deeper understanding of some of these topics, we recommend perusing the </a>“Further Exploration” <span style=" color: #000;">for references to other source material.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s84" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1969">Machine Learning</a><a name="bookmark1981">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1096.png"/></span></p><p class="s83" style="padding-top: 5pt;padding-left: 34pt;text-indent: 0pt;text-align: left;"><a name="bookmark1982">Machine learning helps learn patterns from data to make predictions on unseen data.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1097.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">There are three kinds of machine learning: supervised learning (learning from labeled data), unsupervised learning (learning from unlabeled data), and reinforcement learning (learning by action and feedback from an environment).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1098.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">Supervised learning tasks include classification (output is one of many categories/classes) and regression (output is a numeric value).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1099.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">There are various supervised machine learning techniques including naive Bayes, SVM, decision trees, k-nearest neighbors, neural networks, and others.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s84" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1970">Perceptron</a><a name="bookmark1983">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1100.png"/></span></p><p class="s100" style="padding-top: 5pt;padding-left: 34pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1985" class="s110" name="bookmark1984">A perceptron, as shown in </a>Figure A-1<span style=" color: #000;">, is the simplest form of a neural network, a single-layered neural network with one neuron.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1101.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">A perceptron calculates a weighted sum of its inputs; that is, it accepts input values, multiplies each with a corresponding weight, adds a bias term, and generates a numeric output.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 42pt;text-indent: 0pt;text-align: left;"><span><img width="540" height="312" alt="image" src="KerasTensorFlow2019/Image_1102.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s86" style="padding-top: 4pt;padding-left: 52pt;text-indent: 0pt;text-align: center;"><a name="bookmark1985">Figure A-1. An example of a perceptron</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1103.png"/></span></p><p class="s83" style="padding-top: 13pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">Because a perceptron is governed by a linear equation, it only has the capacity to model linear or close-to-linear tasks well. For a regression task, the prediction can be represented as a straight line. For a classification task, the prediction can be represented as a straight line separating a plane into two parts.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1104.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">Most practical tasks are nonlinear in nature, and hence a perceptron would fail to model the underlying data well, leading to poor prediction performance.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s84" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1971">Activation Functions</a><a name="bookmark1986">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1105.png"/></span></p><p class="s100" style="padding-top: 5pt;padding-left: 34pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1988" class="s110" name="bookmark1987">Activation functions convert linear input into nonlinear output. A sigmoid (</a>Figure A-2<a href="#bookmark1989" class="s110">) is a type of activation function. The hyperbolic tangent function and ReLU, shown in </a><a href="#bookmark1989" class="s85">Figure </a>A-3 <span style=" color: #000;">are other common activation functions.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 45pt;text-indent: 0pt;text-align: left;"><span><img width="538" height="313" alt="image" src="KerasTensorFlow2019/Image_1106.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s86" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1988">Figure A-2. A plot of the sigmoid function</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 56pt;text-indent: 0pt;text-align: left;"><span><img width="523" height="313" alt="image" src="KerasTensorFlow2019/Image_1107.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s86" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: center;"><a name="bookmark1989">Figure A-3. A plot of the ReLU function</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1108.png"/></span></p><p class="s83" style="padding-top: 13pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">For classification, the probability of predicting a category is usually desired. This can be accomplished by a sigmoid function (for binary classification tasks) at the end of the perceptron, which converts values in the range of 0 to 1, and hence is better suited to represent probabilities.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1109.png"/></span></p><p class="s83" style="padding-top: 13pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">Activation functions help replicate the biological concept of the firing of neurons, which, in the simplest case, can be on or off; that is, the inputs activate the neurons. A step function is one form of an activation function where the value is one when the neuron is activated and zero when not. One downside of using a step function is that it loses the magnitude. ReLU, on the other hand, outputs the magnitude of the activation if it activates, and zero otherwise. Due to its simplicity and low computational requirements, it is preferred for nonprobability-based outputs.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s84" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1972">Neural Networks</a><a name="bookmark1990">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1110.png"/></span></p><p class="s83" style="padding-top: 5pt;padding-left: 34pt;text-indent: 0pt;text-align: left;"><a name="bookmark1991">Combining a perceptron with a nonlinear activation function improves its predictive ability. Combining several perceptions with nonlinear activation functions improves it even further.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1111.png"/></span></p><p class="s100" style="padding-left: 34pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1992" class="s110">A neural network, as seen in </a>Figure A-4<span style=" color: #000;">, consists of multiple layers, each containing multiple perceptrons. Layers are connected in a sequence, passing the output of the previous layer as the input to the subsequent layer. This data transfer is represented as connections, with each neuron connected to every neuron in the previous and subsequent layers (hence the layers are aptly named fully connected layers). Each of these connections has a multiplying factor associated with it, also known as a weight.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 49pt;text-indent: 0pt;text-align: left;"><span><img width="533" height="192" alt="image" src="KerasTensorFlow2019/Image_1112.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s86" style="padding-top: 4pt;padding-left: 52pt;text-indent: 0pt;text-align: center;"><a name="bookmark1992">Figure A-4. An example of a multilayer neural network</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1113.png"/></span></p><p class="s83" style="padding-top: 13pt;padding-left: 34pt;text-indent: 0pt;text-align: justify;">Each neuron stores the associated weights and bias, and has an optional nonlinear activation function at the end of it.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1114.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: justify;">Since information flows in one direction, without any cycles, this network structure is also called a feedforward neural network or multilayer feedforward network.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1115.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">The layers between the input(s) and output(s), hidden from the end-user, are appropriately known as hidden layers.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1116.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">Neural networks have a powerful ability to model patterns in data (i.e., represent the underlying relationship between data and associated labels). The <i>Universal Approximation Theorem </i>states that a neural network with a single hidden layer can represent any</p><p class="s83" style="padding-top: 3pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">continuous function within a specific range, acting as a universal approximator. So technically, a single-layer network could model any problem in existence. The major caveat is that it might be infeasible in practice due to the sheer number of neurons required to model many problems. The alternative approach is to have multiple layers with a fewer number of neurons per layer, which works well in practice.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1117.png"/></span></p><p class="s83" style="padding-top: 13pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">The output of a single hidden layer is the result of a nonlinear function applied over a linear combination of its inputs. The output of a second hidden layer is the result of a nonlinear function applied over a linear combination of inputs, which itself are nonlinear functions applied over a linear combination of their inputs. Each layer further builds upon the predictive power of the previous layer. Thus, the higher the number of layers, the better the representative ability of the neural network to model real-world nonlinear problems. This makes the network deep, and hence such networks with many hidden layers are also called <i>deep neural networks</i>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s84" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1973">Backpropagation</a><a name="bookmark1993">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1118.png"/></span></p><p class="s83" style="padding-top: 5pt;padding-left: 34pt;text-indent: 0pt;text-align: left;"><a name="bookmark1994">Training a network involves modifying the weights and biases of the network iteratively until the network starts to make predictions with minimal error.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1119.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">Backpropagation helps train neural networks. It involves making a prediction, measuring how far-off the prediction is from the ground truth, and propagating the error back into the network so that the weights can be updated in order to reduce the magnitude of the error in subsequent iterations. This process is repeated until the error of the network no longer reduces.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1120.png"/></span></p><p class="s83" style="padding-top: 13pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">Neural networks are usually initialized with random weights.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1121.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">The performance of a model is measured with loss functions. For regression tasks (with numeric predictions), mean squared error (MSE) is a commonly used loss function. Due to the squaring of the magnitude of the error, using MSE helps favor more small errors than a few large errors. For classification tasks (with category predictions), the cross-entropy loss is commonly used. While accuracy is used more as a human-understandable metric of performance, cross-entropy loss is used for training a network, since it’s more nuanced.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s84" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1974">Shortcoming of Neural Networks</a><a name="bookmark1995">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1122.png"/></span></p><p class="s83" style="padding-top: 5pt;padding-left: 34pt;text-indent: 0pt;text-align: left;"><a name="bookmark1996">A layer of a neural network with </a><span class="s90">n </span>neurons and <span class="s90">i </span>inputs requires <span class="s90">n x i </span>weights and computations since each neuron is connected to its inputs. An image usually has a lot of pixels as inputs. For an image with width <span class="s90">w</span>, height <span class="s90">h</span>, and <span class="s90">c </span>channels, <span class="s90">w x h x c x n </span>computations would be required. For a standard smartphone camera’s image (usually 4032 x 3024 pixels in 3 channels of red, green, and blue), if the first hidden layer has 128 neurons, over 4 billion weights and computations would result, making neural networks impractical to use for most computer-vision tasks. We want to ideally convert an image into a much smaller workable representation that can then be classified by a neural network.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1123.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">Pixels in an image usually are related to other pixels in their vicinity. Capturing this relationship can give a better understanding of the image’s content. But while feeding a neural network, the relationship between these pixels is lost because the image is flattened out into a 1D array.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s84" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1975">Desired Properties of an Image Classifier</a><a name="bookmark1997">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1124.png"/></span></p><p class="s83" style="padding-top: 5pt;padding-left: 34pt;text-indent: 0pt;text-align: left;"><a name="bookmark1998">It is computationally efficient.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1125.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">It captures relationships between different parts of an image.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1126.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">It is resilient to differences in position, size, angle of an object present in an image, and other factors such as noise. That is, an image classifier should be invariant to geometric transformations (often referred to using terms such as translation invariance, rotational invariance, positional invariance, shift-invariance, scale invariance, etc.).</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1127.png"/></span></p><p class="s83" style="padding-top: 13pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">A CNN satisfies many of these desired properties in practice (some by its design, others with data augmentation).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s84" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1976">Convolution</a><a name="bookmark1999">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1128.png"/></span></p><p class="s83" style="padding-top: 5pt;padding-left: 34pt;text-indent: 0pt;text-align: left;"><a name="bookmark2000">A convolutional filter is a matrix that slides across an image (row by row, left to right), and multiplies with that section of adjoining pixels to produce an output. Such filters are famously used in Photoshop to blur, sharpen, brighten, darken an image, etc.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1129.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">Convolutional filters can, among other things, be used to detect vertical, horizontal, and diagonal edges. That is, when edges are present, they generate higher numbers as output, and lower output values otherwise. Alternatively stated, they “filter” out the input unless it contains an edge.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1130.png"/></span></p><p class="s83" style="padding-top: 13pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">Historically, convolutional filters were hand-engineered to perform a task. In the context of neural networks, these convolutional filters can be used as building blocks whose parameters (matrix weights) can be deduced automatically via a training pipeline.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1131.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">A convolutional filter activates every time it spots the input pattern it has been trained for. Since it traverses over an entire image, the filter is capable of locating the pattern at any position in the image. As a result, the convolutional filters contribute to making the classifier position invariant.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s84" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1977">Pooling</a><a name="bookmark2001">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1132.png"/></span></p><p class="s83" style="padding-top: 5pt;padding-left: 34pt;text-indent: 0pt;text-align: left;"><a name="bookmark2002">A pooling operation reduces the spatial size of the input. It looks at smaller portions of an input and performs an aggregation operation reducing the output to a single number. Typically aggregation operations include finding the maximum or average of all values, also commonly known as </a><i>max pooling </i>and <i>average pooling</i>, respectively. For example, a <span class="s90">2 x 2 </span>max pooling operation will replace each <span class="s90">2 x 2 </span>submatrix of the input (without overlap) with a single value in the output. Similar to convolution, pooling traverses the entire input matrix, aggregating multiple blocks of values into single values. If the input matrix were of size <span class="s90">2N x 2N</span>, the resulting output would be of size <span class="s90">N x N</span>.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1133.png"/></span></p><p class="s83" style="padding-top: 13pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">In the aforementioned example, the output would be the same regardless of where in the <span class="s90">2 x 2 </span>matrix the maximum occurred.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1134.png"/></span></p><p class="s83" style="padding-top: 13pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">Max pooling is more commonly used than average pooling because it acts as a noise suppressor. Because it only takes the maximum value in each operation, it ignores the lower values, which are typically characteristics of noise.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s84" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1978">Structure of a CNN</a><a name="bookmark2003">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1135.png"/></span></p><p class="s100" style="padding-top: 5pt;padding-left: 34pt;text-indent: 0pt;line-height: 16pt;text-align: left;"><a href="#bookmark2005" class="s110" name="bookmark2004">At a high level, a CNN (shown in </a>Figure A-5<span style=" color: #000;">) consists of two parts</span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">— a featurizer followed by a classifier. The featurizer reduces the input image to a workable size of features (i.e., a smaller representation of the image) upon which the classifier then acts.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1136.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">A CNN’s featurizer is a repeating structure of convolutional, activation, and pooling layers. The input passes through this repeating structure in a sequence one layer at a time.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 41pt;text-indent: 0pt;text-align: left;"><span><img width="541" height="348" alt="image" src="KerasTensorFlow2019/Image_1137.jpg"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s86" style="padding-top: 4pt;padding-left: 52pt;text-indent: 0pt;text-align: center;"><a name="bookmark2005">Figure A-5. A high-level overview of a convolutional network</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1138.png"/></span></p><p class="s83" style="padding-top: 13pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">The transformed input is finally passed into classification layers, which are really just neural networks. In this context, the classification neural network is typically known as a fully connected layer.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1139.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">Much like in neural networks, the nonlinearity provided by activation functions help the CNN learn complex features. ReLU is the most commonly used activation function.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1140.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">Empirically, earlier layers (i.e., those closer to the input layers) detect simple features such as curves and edges. If a matching</p><p class="s83" style="padding-top: 3pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">feature is detected, the layer gets activated and passes on the signal to subsequent layers. Eventual layers combine these signals to detect more complex features such as a human eye, human nose, or human ears. Ultimately, these signals might add up to detect the entire object such as a human face.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1141.png"/></span></p><p class="s83" style="padding-top: 13pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">CNNs are trained using backpropagation just like multilayer perceptron networks.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="6" height="6" alt="image" src="KerasTensorFlow2019/Image_1142.png"/></span></p><p class="s83" style="padding-left: 34pt;text-indent: 0pt;text-align: left;">Unlike traditional machine learning, this makes feature selection automated. Additionally, the reduction of the input into smaller features makes the process more computationally efficient. Both of these are big selling points of deep learning.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s84" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark1979">Further Exploration</a><a name="bookmark2006">&zwnj;</a></p><p class="s83" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 108%;text-align: left;"><a name="bookmark2007">The topics we cover in this book should be self-sufficient, but if you do choose to develop a deeper appreciation for the underlying fundamentals, we highly recommend checking out some of the following material:</a></p><p style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="https://www.deeplearning.ai/" class="s207">https://www.deeplearning.ai</a></p><p class="s83" style="padding-top: 4pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">This set of deep learning courses from Andrew Ng covers the foundations for a wide range of topics, encompassing theoretical knowledge and deep insights behind each concept.</p><p style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="https://course.fast.ai/" class="s207">https://course.fast.ai</a></p><p class="s83" style="padding-top: 4pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">This course by Jeremy Howard and Rachel Thomas has a more hands-on approach to deep learning using PyTorch as the primary deep learning framework. The fast.ai library used in this course has helped many students run models with state-of-the-art performance using just a few lines of code.</p><p class="s88" style="padding-top: 9pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><span style=" color: #8E0012; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14pt;">Hands-On Machine Learning with Scikit-Learn, Keras, and TensorFlow</span>, 2nd Edition</p><p class="s83" style="padding-top: 4pt;padding-left: 34pt;text-indent: 0pt;text-align: left;">This book by Aurélien Géron covers machine learning and delves into topics such as support vector machines, decision trees, random forests, etc., then bridges into deep learning topics such as convolutional and recurrent neural networks. It explains both theory as well as some hands-on examples of these techniques.</p><h1 style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a name="bookmark2008">Index</a><a name="bookmark2009">&zwnj;</a></h1><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 7pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="588" height="1" alt="image" src="KerasTensorFlow2019/Image_1143.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Symbols</p><p style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1187" class="s208">24/7 availability, </a><a href="#bookmark1187">Real-Time Object Classification on iOS with Core ML</a></p><p class="s2" style="padding-top: 1pt;padding-left: 6pt;text-indent: 0pt;line-height: 34pt;text-align: left;"><a href="#bookmark760" class="s208">80legs.com, </a>Data <span style=" color: #000;">A</span></p><p style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark990" class="s208">A/B testing, </a><a href="#bookmark1447" class="a">A/B Testing</a><a href="#bookmark1439" class="s208">, </a><a href="#bookmark1447" class="a">A/B Testing Hosted Models</a><a href="#bookmark1447" class="s208">-</a><a href="#bookmark1447">Using the Experiment in Code</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark143" class="s208">accountability, </a><a href="#bookmark143">Accountability and Explainability</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1891" class="s208">action space, </a><a href="#bookmark1893" class="a">Configure the action space</a><a href="#bookmark1893" class="s208">-</a><a href="#bookmark1893">Configure the action space</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1987" class="s208">activation functions, </a><a href="#bookmark1987">Activation Functions</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1923" class="s208">actor-critic approach, </a><a href="#bookmark1923">Policy based or value based — why not both?</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark272" class="s208">Adam optimizer, </a><a href="#bookmark272">Set Training Parameters</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1642" class="s208">Advanced Driver Assistance Systems (ADAS), </a><a href="#bookmark1642">Autonomous Cars</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1692" class="s208">Advanced Virtual RISC (AVR), </a><a href="#bookmark1692">Arduino</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1924" class="s208">Advantage function, </a><a href="#bookmark1924">Policy based or value based — why not both?</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1958" class="s208">AI Driving Olympics (AI-DO), </a><a href="#bookmark1958">AI Driving Olympics</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1143" class="s208">Airbnb, </a><a href="#bookmark1143">Airbnb’s Photo Classification</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1762" class="s208">AirSim, </a><a href="#bookmark1762" class="a">Deep Learning, Autonomous Driving, and the Data Problem</a><a href="#bookmark1771" class="s208">, </a><a href="#bookmark1762" class="a">Setup </a><a href="#bookmark1762">and Requirements</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark846" class="s208">AlchemyVision, </a>IBM Watson Visual Recognition <a href="#bookmark849" class="s208">Algorithmia, </a><a href="#bookmark849">Algorithmia</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark1493" class="s208">Alibaba, </a><a href="#bookmark1493">Speaker Recognition by Alibaba</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1396" class="s208">alpha users, </a>The Life Cycle of a Food Classifier App <a href="#bookmark843" class="s208">Amazon Rekognition, </a><a href="#bookmark843">Amazon Rekognition</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1865" class="s208">Amazon SageMaker, </a><a href="#bookmark1865">A Brief Introduction to Reinforcement Learning</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark736" class="s208">AMD GPUs, </a>Installation <a href="#bookmark735" class="s208">Anaconda Python, </a><a href="#bookmark735">Installation</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1408" class="s208">Android Studio, </a>Building a Real-Time Object Recognition App <a href="#bookmark773" class="s208">annotations, </a><a href="#bookmark773">Data</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark387" class="s208">Annoy (Approximate Nearest Neighbors Oh Yeah), </a><a href="#bookmark387">Annoy</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1762" class="s208">Apollo simulation, </a><a href="#bookmark1762">Deep Learning, Autonomous Driving, and the Data Problem</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1257" class="s208">app size, reducing, </a>Reducing App Size<a href="#bookmark1264" class="s208">-</a><a href="#bookmark1264">Use Create ML</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1206" class="s208">Apple’s machine learning architecture, </a><a href="#bookmark1328" class="a">Apple’s Machine </a><a href="#bookmark1206" class="a">Learning Architecture</a><a href="#bookmark1212" class="s208">-</a><a href="#bookmark1206" class="a">ML Performance Primitives</a><a href="#bookmark1328" class="s208">, </a><a href="#bookmark1328">Approach 2: Use Create ML</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark376" class="s208">approximate nearest neighbor (ANN), </a><a href="#bookmark376">Approximate Nearest-</a></p><p class="s2" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;">Neighbor Benchmark <a href="#bookmark113" class="s208">architecture, </a>Model Architecture <a href="#bookmark1691" class="s208">Arduino, </a><a href="#bookmark1691">Arduino</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark1967" class="s208">artificial general intelligence, </a><a href="#bookmark1967">Summary</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">artificial intelligence (AI)</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1066" class="s208">browser-based, </a><a href="#bookmark1066" class="a">AI in the Browser with TensorFlow.js and ml5.js</a><a href="#bookmark1150" class="s208">-</a><a href="#bookmark1150">Summary</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark65" class="s208">definition of, </a><a href="#bookmark65">What Is AI?</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1667" class="s208">on embedded devices, </a><a href="#bookmark1667" class="a">Becoming a Maker: Exploring Embedded AI at the Edge</a><a href="#bookmark1731" class="s208">-</a><a href="#bookmark1731">Summary</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark61" class="s208">examples of, </a><a href="#bookmark73" class="a">An Apology</a><a href="#bookmark72" class="s208">, </a><a href="#bookmark73" class="a">Motivating Examples</a><a href="#bookmark73" class="s208">-</a><a href="#bookmark73" class="a">Motivating Examples </a><a href="#bookmark73" class="s208">(see also case studies)</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark153" class="s208">frequently asked questions, </a>Frequently Asked Questions<span style=" color: #000;">-</span></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark155">Frequently Asked Questions</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark75" class="s208">history of, </a><a href="#bookmark100" class="a">A Brief History of AI</a><a href="#bookmark100" class="s208">-</a><a href="#bookmark100">How Deep Learning Became a Thing</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark190" class="s208">versus human accuracy, </a>ImageNet Dataset <a href="#bookmark63" class="s208">introduction to, </a>The Real Introduction<a href="#bookmark69" class="s208">-</a><a href="#bookmark69">What Is AI?</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: justify;"><a href="#bookmark1184" class="s208">mobile-based, </a><a href="#bookmark1390" class="a">Real-Time Object Classification on iOS with </a><a href="#bookmark1184" class="a">Core ML</a><a href="#bookmark1281" class="s208">-</a><a href="#bookmark1184" class="a">Summary</a><a href="#bookmark1184" class="s208">, </a><a href="#bookmark1390" class="a">Shazam for Food: Developing Android Apps with TensorFlow Lite and ML Kit</a><a href="#bookmark1502" class="s208">-</a><a href="#bookmark1502">Summary</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark102" class="s208">perfect deep learning solution, </a><a href="#bookmark167" class="a">Recipe for the Perfect Deep </a><a href="#bookmark102" class="a">Learning Solution</a><a href="#bookmark128" class="s208">-</a><a href="#bookmark102" class="a">Hardware</a><a href="#bookmark102" class="s208">, </a><a href="#bookmark167" class="a">What’s in the Picture: Image </a><a href="#bookmark167">Classification with Keras</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark780" class="s208">resources for learning about, </a>Education and Exploration<span style=" color: #000;">,</span></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark2007">Further Exploration</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark130" class="s208">responsible AI, </a>Responsible AI<a href="#bookmark150" class="s208">-</a><a href="#bookmark150">Privacy</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark958" class="s208">serving prediction requests, </a><a href="#bookmark958">Landscape of Serving AI Predictions</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark731" class="s208">tools, tips, and tricks, </a><a href="#bookmark790" class="a">Practical Tools, Tips, and Tricks</a><a href="#bookmark790" class="s208">-</a><a href="#bookmark790">One Last Question</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark530" class="s208">aspect ratio, </a><a href="#bookmark530">Effect of Change in Aspect Ratio on Transfer Learning</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark636" class="s208">asynchronous communication, </a>Prefetch Data <a href="#bookmark539" class="s208">augmentations, </a><a href="#bookmark539">AutoAugment</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark467" class="s208">AutoAugment, </a>Tools of the Trade<a href="#bookmark539" class="s208">, </a>AutoAugment <a href="#bookmark466" class="s208">AutoKeras, </a>Tools of the Trade<a href="#bookmark542" class="s208">, </a><a href="#bookmark542">AutoKeras</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark666" class="s208">Automatic Mixed Precision, </a>Use Automatic Mixed Precision <a href="#bookmark539" class="s208">automatic tuning, </a><a href="#bookmark539">AutoAugment</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;">autonomous driving</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1761" class="s208">data collection necessary for, </a><a href="#bookmark1761">Deep Learning, Autonomous Driving, and the Data Problem</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1776" class="s208">data exploration and preparation, </a><a href="#bookmark1776" class="a">Data Exploration and Preparation</a><a href="#bookmark1791" class="s208">-</a><a href="#bookmark1776" class="a">Dataset </a><a href="#bookmark1776">Imbalance and Driving Strategies</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1759" class="s208">deep learning applications in, </a><a href="#bookmark1759">Deep Learning, Autonomous Driving, and the Data Problem</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1807" class="s208">further exploration, </a><a href="#bookmark1815" class="a">Further Exploration</a><a href="#bookmark1815" class="s208">-</a><a href="#bookmark1815">Reinforcement Learning</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark87" class="s208">history of, </a><a href="#bookmark1756" class="a">A Glimmer of Hope</a><a href="#bookmark1756" class="s208">, </a><a href="#bookmark1756">A Brief History of Autonomous Driving</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1752" class="s208">introduction to, </a><a href="#bookmark1752">Simulating a Self-Driving Car Using End-to-</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1752">End Deep Learning with Keras</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1870" class="s208">landscape of, </a><a href="#bookmark1870">Why Learn Reinforcement Learning with an Autonomous Car?</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1804" class="s208">model deployment, </a><a href="#bookmark1804" class="a">Deploying Our Autonomous Driving Model</a><a href="#bookmark1805" class="s208">-</a><a href="#bookmark1804" class="a">Deploying </a><a href="#bookmark1804">Our Autonomous Driving Model</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1793" class="s208">model training, </a>Training Our Autonomous Driving Model<span style=" color: #000;">-</span></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1801">Callbacks</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1642" class="s208">object detection in, </a><a href="#bookmark1642">Autonomous Cars</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1808" class="s208">real-world applications of, </a><a href="#bookmark1808">Further Exploration</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1754" class="s208">SAE levels of driving automation, </a><a href="#bookmark1754">Simulating a Self-Driving Car Using End-to-End Deep Learning with Keras</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: justify;"><a href="#bookmark1765" class="s208">simulation and, </a><a href="#bookmark1881" class="a">Deep Learning, Autonomous Driving, and </a><a href="#bookmark1765" class="a">the Data Problem</a><a href="#bookmark1765" class="s208">, </a><a href="#bookmark1881" class="a">Practical Deep Reinforcement Learning with DeepRacer</a><a href="#bookmark1948" class="s208">, </a><a href="#bookmark1881" class="a">Sim2Real </a><a href="#bookmark1881">transfer</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1769" class="s208">steering through simulated environments, </a><a href="#bookmark1769" class="a">The “Hello, World!” of Autonomous Driving: Steering Through a Simulated Environment</a><a href="#bookmark1774" class="s208">-</a><a href="#bookmark1769" class="a">Setup </a><a href="#bookmark1769">and Requirements</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1764" class="s208">Autonomous Driving Cookbook, </a><a href="#bookmark1764" class="a">Deep Learning, Autonomous Driving, and the Data Problem</a><a href="#bookmark1816" class="s208">, </a><a href="#bookmark1764" class="a">Reinforcement </a><a href="#bookmark1764">Learning</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark974" class="s208">availability, </a><a href="#bookmark1187" class="a">High Availability</a><a href="#bookmark1187" class="s208">, </a><a href="#bookmark1187">Real-Time Object Classification on iOS with Core ML</a></p><p class="s3" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">AWS DeepRacer</p><p class="s2" style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1956" class="s208">for advanced developers, </a>Advanced AWS DeepRacer <a href="#bookmark1958" class="s208">AI Driving Olympics, </a><a href="#bookmark1958">AI Driving Olympics</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1883" class="s208">creating AWS accounts, </a><a href="#bookmark1883" class="a">Building Our First Reinforcement </a><a href="#bookmark1883">Learning</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1954" class="s208">DeepRacer league, </a><a href="#bookmark1954" class="a">DeepRacer </a>League <a href="#bookmark1961" class="s208">DIY Robocars, </a><a href="#bookmark1961" class="a">DIY </a><a href="#bookmark1961">Robocars</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1933" class="s208">improving learning models, </a><a href="#bookmark1939" class="a">Step 5: Improving </a><a href="#bookmark1933" class="a">Reinforcement Learning Models</a><a href="#bookmark1933" class="s208">-</a><a href="#bookmark1939" class="a">Racing the A</a><a href="#bookmark1939">WS DeepRacer Car</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1886" class="s208">model creation, </a><a href="#bookmark1886">Step 1: Create Model</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1905" class="s208">model evaluation, </a><a href="#bookmark1905">Step 4: Evaluating the Performance of the Model</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1902" class="s208">model training, </a><a href="#bookmark1902">Step 3: Model Training</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1866" class="s208">motivation behind, </a><a href="#bookmark1866" class="a">A Brief Introduction to Reinforcement </a><a href="#bookmark1866">Learning</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1939" class="s208">racing the car, </a><a href="#bookmark1939" class="a">Racing the AWS </a><a href="#bookmark1949" class="a">DeepRacer Car</a><a href="#bookmark1949" class="s208">-</a><a href="#bookmark1949" class="a">Sim2Real </a><a href="#bookmark1949">transfer</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1927" class="s208">reinforcement learning algorithm, </a><a href="#bookmark1927">Reinforcement Learning Algorithm in AWS DeepRacer</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1911" class="s208">reinforcement learning in action, </a><a href="#bookmark1911">How Does a Reinforcement Learning System Learn?</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1931" class="s208">reinforcement learning summary, </a><a href="#bookmark1931">Deep Reinforcement Learning Summary with DeepRacer as an Example</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1875" class="s208">reinforcement learning terminology, </a><a href="#bookmark1875">Practical Deep Reinforcement Learning with DeepRacer</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1918" class="s208">reinforcement learning theory, </a><a href="#bookmark1918">Reinforcement Learning Theory</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1880" class="s208">reward function in, </a><a href="#bookmark1880">Practical Deep Reinforcement Learning with DeepRacer</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1963" class="s208">Roborace, </a><a href="#bookmark1963">Roborace</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1888" class="s208">training configuration, </a>Step 2: Configure Training<a href="#bookmark1900" class="s208">- </a><a href="#bookmark1900">Configure stop conditions</a></p><p class="s3" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">B</p><p class="s2" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark83" class="s208">backpropagation, </a>A Glimmer of Hope<a href="#bookmark257" class="s208">, </a>Batch Size<span style=" color: #000;">,</span></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1994">Backpropagation</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">batch size</p><p class="s2" style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark524" class="s208">effect on accuracy, </a>Effect of Batch Size <a href="#bookmark257" class="s208">role of, </a><a href="#bookmark257">Batch Size</a></p><p class="s2" style="padding-left: 6pt;text-indent: 15pt;line-height: 209%;text-align: left;"><a href="#bookmark668" class="s208">using larger, </a>Use Larger Batch Size <a href="#bookmark745" class="s208">Bayesian Optimization, </a><a href="#bookmark745">Training</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark769" class="s208">BDD100K, </a><a href="#bookmark769">Data</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark697" class="s208">benchmarks, </a><a href="#bookmark697">Examine Industry Benchmarks</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark133" class="s208">bias, </a>Bias<a href="#bookmark201" class="s208">, </a>Class Activation Maps<a href="#bookmark425" class="s208">, </a>Image Captioning<a href="#bookmark864" class="s208">, </a>Bias<span style=" color: #000;">-</span></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark870">Bias</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark254" class="s208">binary classification, </a>Binary classification <a href="#bookmark733" class="s208">Binder, </a><a href="#bookmark733">Installation</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1313" class="s208">Bing Image Search API, </a><a href="#bookmark1313">Approach 3: Web Scraper Using Bing Image Search API</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 36pt;text-align: left;"><a href="#bookmark1639" class="s208">blind and low-vision community, </a>Face Detection in Seeing AI <a href="#bookmark330" class="s208">bottleneck features, </a><a href="#bookmark330">Image Similarity</a></p><p class="s3" style="padding-top: 5pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">(see also embeddings)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">browser-based AI</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1123" class="s208">benchmarking and practical considerations, </a><a href="#bookmark1123">Benchmarking and Practical Considerations</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1132" class="s208">case studies, </a>Case Studies<a href="#bookmark1146" class="s208">-</a><a href="#bookmark1146">GAN Lab</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1066" class="s208">introduction to, </a><a href="#bookmark1066">AI in the Browser with TensorFlow.js and ml5.js</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1069" class="s208">JavaScript-based ML libraries, </a><a href="#bookmark1069" class="a">JavaScript-Based Machine Learning Libraries: A Brief History</a><a href="#bookmark1081" class="s208">-</a><a href="#bookmark1069" class="a">T</a><a href="#bookmark1069">ensorFlow.js</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1105" class="s208">ml5.js, </a><a href="#bookmark1105">ml5.js</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1091" class="s208">model conversion, </a>Model Conversion for the Browser <a href="#bookmark1112" class="s208">pix2pix, </a>pix2pix<a href="#bookmark1121" class="s208">-</a><a href="#bookmark1121">pix2pix</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1109" class="s208">PoseNet, </a><a href="#bookmark1109">PoseNet</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1088" class="s208">pretrained models using TensorFlow.js, </a><a href="#bookmark1088">Running Pretrained Models Using TensorFlow.js</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1085" class="s208">TensorFlow.js architecture, </a>TensorFlow.js Architecture <a href="#bookmark1093" class="s208">training, </a>Training in the Browser<a href="#bookmark1103" class="s208">-</a><a href="#bookmark1103">GPU Utilization</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark384" class="s208">brute-force algorithm, </a><a href="#bookmark384">Brute Force</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">C</p><p class="s2" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark645" class="s208">caching, </a>Cache Data <a href="#bookmark1799" class="s208">callbacks, </a><a href="#bookmark1799">Callbacks</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1762" class="s208">Carla, </a><a href="#bookmark1762">Deep Learning, Autonomous Driving, and the Data Problem</a></p><p class="s3" style="padding-top: 14pt;padding-left: 22pt;text-indent: -15pt;line-height: 157%;text-align: left;">case studies browser-based AI</p><p style="padding-left: 37pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1143" class="s208">Airbnb’s photo classification, </a><a href="#bookmark1143">Airbnb’s Photo Classification</a></p><p class="s2" style="padding-top: 14pt;padding-left: 37pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1145" class="s208">GAN Lab, </a>GAN Lab <a href="#bookmark1140" class="s208">Metacar, </a><a href="#bookmark1140">Metacar</a></p><p class="s2" style="padding-left: 37pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1134" class="s208">Semi-Conductor, </a>Semi-Conductor <a href="#bookmark1137" class="s208">TensorSpace, </a><a href="#bookmark1137">TensorSpace</a></p><p style="padding-left: 37pt;text-indent: -15pt;line-height: 157%;text-align: left;"><a href="#bookmark910" class="s208">computer vision Giphy, </a><a href="#bookmark910">Giphy</a></p><p style="padding-top: 8pt;padding-left: 37pt;text-indent: 0pt;text-align: left;"><a href="#bookmark919" class="s208">InDro Robotics, </a><a href="#bookmark919">InDro Robotics</a></p><p class="s2" style="padding-top: 3pt;padding-left: 37pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark906" class="s208">New York Times, </a>The New York Times <a href="#bookmark913" class="s208">OmniEarth, </a><a href="#bookmark913">OmniEarth</a></p><p class="s2" style="padding-left: 37pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark915" class="s208">Photobucket, </a>Photobucket <a href="#bookmark917" class="s208">Staples, </a><a href="#bookmark917">Staples</a></p><p style="padding-left: 37pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark908" class="s208">Uber, </a><a href="#bookmark908">Uber</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 22pt;text-indent: 0pt;text-align: left;">embedded AI devices</p><p class="s2" style="padding-top: 9pt;padding-left: 37pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1725" class="s208">cucumber sorter, </a>Cucumber Sorter <a href="#bookmark1717" class="s208">JetBot, </a><a href="#bookmark1717">JetBot</a></p><p style="padding-left: 37pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark1720" class="s208">squatting for metro tickets, </a><a href="#bookmark1720">Squatting for Metro Tickets</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 22pt;text-indent: 0pt;text-align: left;">mobile-based AI</p><p class="s2" style="padding-top: 9pt;padding-left: 37pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1495" class="s208">face filter–like functionality, </a>Face Contours in ML Kit <a href="#bookmark1273" class="s208">HomeCourt, </a><a href="#bookmark1273">HomeCourt</a></p><p class="s2" style="padding-left: 37pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1276" class="s208">InstaSaber, </a>InstaSaber + YoPuppet <a href="#bookmark1487" class="s208">Lose It!, </a><a href="#bookmark1487">Lose It!</a></p><p style="padding-left: 37pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark1268" class="s208">Magic Sudoku, </a><a href="#bookmark1268">Magic Sudoku</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 37pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1490" class="s208">portrait mode on Pixel 3 phones, </a><a href="#bookmark1490">Portrait Mode on Pixel 3 Phones</a></p><p style="padding-top: 14pt;padding-left: 37pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1271" class="s208">Seeing AI, </a><a href="#bookmark1271">Seeing AI</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 37pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1493" class="s208">speaker recognition by Alibaba, </a><a href="#bookmark1493">Speaker Recognition by Alibaba</a></p><p style="padding-top: 3pt;padding-left: 37pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1498" class="s208">video segmentation, </a><a href="#bookmark1498">Real-Time Video Segmentation in YouTube Stories</a></p><p class="s2" style="padding-left: 22pt;text-indent: 15pt;line-height: 36pt;text-align: left;"><a href="#bookmark1276" class="s208">YoPuppet, </a>InstaSaber + YoPuppet <span style=" color: #000;">object detection</span></p><p class="s2" style="padding-top: 5pt;padding-left: 37pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1642" class="s208">autonomous cars, </a>Autonomous Cars <a href="#bookmark1634" class="s208">crowd counting, </a><a href="#bookmark1634">Crowd Counting</a></p><p style="padding-left: 37pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1639" class="s208">face detection in Seeing AI app, </a><a href="#bookmark1639" class="a">Face Detection in Seeing </a><a href="#bookmark1639">AI</a></p><p class="s2" style="padding-left: 22pt;text-indent: 15pt;line-height: 36pt;text-align: left;"><a href="#bookmark1631" class="s208">smart refrigerators, </a><a href="#bookmark1631" class="a">Smart </a>Refrigerator <span style=" color: #000;">reverse image search</span></p><p class="s2" style="padding-top: 5pt;padding-left: 37pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark417" class="s208">Celebslike.me, </a>Celebrity Doppelgangers <a href="#bookmark411" class="s208">Flickr, </a><a href="#bookmark411">Flickr</a></p><p class="s2" style="padding-left: 37pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark423" class="s208">image captioning, </a>Image Captioning <a href="#bookmark414" class="s208">Pinterest, </a><a href="#bookmark414">Pinterest</a></p><p style="padding-left: 37pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark420" class="s208">Spotify, </a><a href="#bookmark420">Spotify</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark277" class="s208">categorical_crossentropy loss function, </a>Start Training <a href="#bookmark192" class="s208">category unawareness, </a><a href="#bookmark192">ImageNet Dataset</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark417" class="s208">celebrity doppelgangers, </a>Celebrity Doppelgangers <a href="#bookmark174" class="s208">channels, </a><a href="#bookmark174">Predicting an Image’s Category</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1498" class="s208">chroma keying technique, </a><a href="#bookmark1498">Real-Time Video Segmentation in YouTube Stories</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark834" class="s208">Clarifai, </a><a href="#bookmark834">Clarifai</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark198" class="s208">class activation maps (heat maps), </a>Class Activation Maps<a href="#bookmark202" class="s208">- </a>Class Activation Maps<a href="#bookmark1935" class="s208">, </a><a href="#bookmark1935">Heatmap visualization</a></p><p class="s3" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;">classification problems (see also custom classifiers; image classification)</p><p class="s2" style="padding-top: 5pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark254" class="s208">binary, </a>Binary classification <a href="#bookmark1545" class="s208">computer-vision tasks, </a>Classification <a href="#bookmark255" class="s208">multiclass, </a><a href="#bookmark255">Multiclass classification</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark1547" class="s208">classification with localization, </a><a href="#bookmark1547">Localization</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1581" class="s208">Cloud AutoML, </a><a href="#bookmark1581">Building a Custom Detector Without Any Code</a></p><p class="s3" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">cloud computing (see also inference serving)</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark886" class="s208">comparing custom classification APIs, </a><a href="#bookmark886">Comparing Custom Classification APIs</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark829" class="s208">example scenario using, </a><a href="#bookmark829">Cloud APIs for Computer Vision:</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark829">Up and Running in 15 Minutes</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark872" class="s208">getting up and running with, </a><a href="#bookmark872">Getting Up and Running with Cloud APIs</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1430" class="s208">hosted models, </a><a href="#bookmark1447" class="a">Hosted Models</a><a href="#bookmark1447" class="s208">-</a><a href="#bookmark1447">Using the Experiment in Code</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark891" class="s208">performance tuning for cloud APIs, </a><a href="#bookmark891" class="a">Performance Tuning for Cloud APIs</a><a href="#bookmark902" class="s208">-</a><a href="#bookmark891" class="a">Effect </a><a href="#bookmark891">of Resizing on OCR APIs</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1561" class="s208">prebuilt object detection APIs, </a><a href="#bookmark1562" class="a">Invoking Prebuilt Cloud- </a><a href="#bookmark1561" class="a">Based Object Detection APIs</a><a href="#bookmark1561" class="s208">-</a><a href="#bookmark1561">Invoking Prebuilt Cloud-</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1562">Based Object Detection APIs</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1187" class="s208">reduced costs of mobile-based AI, </a><a href="#bookmark1187">Real-Time Object Classification on iOS with Core ML</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark875" class="s208">training custom classifiers, </a><a href="#bookmark875" class="a">Training Our Own Custom Classifier</a><a href="#bookmark882" class="s208">-</a><a href="#bookmark875" class="a">T</a><a href="#bookmark875">raining Our Own Custom Classifier</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark884" class="s208">troubleshooting classifiers, </a><a href="#bookmark884">Top Reasons Why Our Classifier Does Not Work Satisfactorily</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark832" class="s208">visual recognition APIs available, </a><a href="#bookmark832" class="a">The Landscape of Visual Recognition APIs</a><a href="#bookmark851" class="s208">-</a><a href="#bookmark832" class="a">What’</a><a href="#bookmark832">s unique about this API?</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark853" class="s208">visual recognition APIs comparison, </a><a href="#bookmark853" class="a">Comparing Visual Recognition APIs</a><a href="#bookmark870" class="s208">-</a><a href="#bookmark870">Bias</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark201" class="s208">co-occurrences, </a><a href="#bookmark1311" class="a">Class Activation Maps</a><a href="#bookmark1311" class="s208">, </a><a href="#bookmark1311">Approach 2: Fatkun Chrome Browser Extension</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark106" class="s208">COCO (Microsoft Common Objects in COntext), </a>Datasets<span style=" color: #000;">,</span></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark423">Image Captioning</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">code examples</p><p class="s2" style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark24" class="s208">downloading, </a>Using Code Examples <a href="#bookmark24" class="s208">permission to use, </a><a href="#bookmark24">Using Code Examples</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark123" class="s208">code-free training, </a>A continuously evolving landscape<a href="#bookmark1575" class="s208">, </a><a href="#bookmark1575">Building a Custom Detector Without Any Code</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1767" class="s208">Cognata, </a><a href="#bookmark1767">Deep Learning, Autonomous Driving, and the Data Problem</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark837" class="s208">Cognitive Services, </a><a href="#bookmark1561" class="a">Microsoft Cognitive Services</a><a href="#bookmark1561" class="s208">, </a><a href="#bookmark1561">Invoking Prebuilt Cloud-Based Object Detection APIs</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark742" class="s208">CometML, </a><a href="#bookmark742">Training</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 36pt;text-align: left;"><a href="#bookmark174" class="s208">components, </a>Predicting an Image’s Category <a href="#bookmark893" class="s208">compression, </a>Performance Tuning for Cloud APIs <span style=" color: #000;">computer vision</span></p><p class="s2" style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark904" class="s208">case studies, </a>Case Studies<a href="#bookmark920" class="s208">-</a><a href="#bookmark920">InDro Robotics</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark853" class="s208">comparing visual recognition APIs, </a><a href="#bookmark853" class="a">Comparing Visual Recognition APIs</a><a href="#bookmark870" class="s208">-</a><a href="#bookmark870">Bias</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark875" class="s208">custom classifer training, </a><a href="#bookmark875" class="a">Training Our Own Custom Classifier</a><a href="#bookmark882" class="s208">-</a><a href="#bookmark875" class="a">T</a><a href="#bookmark875">raining Our Own Custom Classifier</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark886" class="s208">custom classification APIs comparison, </a><a href="#bookmark889" class="a">Comparing </a><a href="#bookmark886" class="a">Custom Classification APIs</a><a href="#bookmark886" class="s208">-</a><a href="#bookmark889" class="a">Comparing Custom </a><a href="#bookmark889">Classification APIs</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark829" class="s208">example scenario using, </a><a href="#bookmark830" class="a">Cloud APIs for Computer Vision: </a><a href="#bookmark829" class="a">Up and Running in 15 Minutes</a><a href="#bookmark829" class="s208">-</a><a href="#bookmark830" class="a">Cloud APIs for Computer </a><a href="#bookmark830">Vision: Up and Running in 15 Minutes</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark891" class="s208">performance tuning for cloud APIs, </a><a href="#bookmark891" class="a">Performance Tuning for Cloud APIs</a><a href="#bookmark902" class="s208">-</a><a href="#bookmark891" class="a">Effect </a><a href="#bookmark891">of Resizing on OCR APIs</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark99" class="s208">time estimation for achieving, </a><a href="#bookmark99">How Deep Learning Became a Thing</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark884" class="s208">troubleshooting classifiers, </a><a href="#bookmark884">Top Reasons Why Our Classifier Does Not Work Satisfactorily</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1543" class="s208">types of computer-vision tasks, </a><a href="#bookmark1543" class="a">Types of Computer-Vision Tasks</a><a href="#bookmark1558" class="s208">-</a><a href="#bookmark1543" class="a">Approaches </a><a href="#bookmark1543">to Object Detection</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark872" class="s208">using cloud APIs, </a><a href="#bookmark872" class="a">Getting Up and Running with Cloud APIs</a><a href="#bookmark873" class="s208">-</a><a href="#bookmark872" class="a">Getting </a><a href="#bookmark872">Up and Running with Cloud APIs</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark832" class="s208">visual recognition APIs available, </a><a href="#bookmark832" class="a">The Landscape of Visual Recognition APIs</a><a href="#bookmark851" class="s208">-</a><a href="#bookmark832" class="a">What’</a><a href="#bookmark832">s unique about this API?</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark988" class="s208">concept drift, </a>Model Versioning <a href="#bookmark1115" class="s208">conditional GANs , </a><a href="#bookmark1115">pix2pix</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark27" class="s208">contact information for this book, </a>How to Contact Us <a href="#bookmark1891" class="s208">continuous action space, </a><a href="#bookmark1891">Configure the action space</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark406" class="s208">contrastive loss function, </a><a href="#bookmark406">Siamese Networks for One-Shot Face Verification</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark22" class="s208">conventions used in this book, </a><a href="#bookmark22">Conventions Used in This Book</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1072" class="s208">ConvNetJS, </a>ConvNetJS <a href="#bookmark2000" class="s208">convolution filters, </a><a href="#bookmark2000">Convolution</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;">Convolutional Neural Networks (CNNs)</p><p class="s2" style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark360" class="s208">accuracy and feature lengths, </a>Length of Feature Vectors <a href="#bookmark750" class="s208">creating diagrams of, </a><a href="#bookmark750">Model</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark501" class="s208">end-to-end learning example pipeline, </a><a href="#bookmark501" class="a">End-to-End Deep Learning Example Pipeline</a><a href="#bookmark505" class="s208">-</a><a href="#bookmark501" class="a">Basic </a><a href="#bookmark505" class="a">Custom Network </a><a href="#bookmark505">Pipeline</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark507" class="s208">hyperparameter effect on accuracy, </a><a href="#bookmark532" class="a">How Hyperparameters </a><a href="#bookmark507" class="a">Affect Accuracy</a><a href="#bookmark507" class="s208">-</a><a href="#bookmark532" class="a">Effect of Change in Aspect Ratio on </a><a href="#bookmark532">Transfer Learning</a></p><p class="s2" style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark176" class="s208">image classification using, </a>Predicting an Image’s Category<a href="#bookmark234" class="s208">, </a><a href="#bookmark234">A Shallow Dive into Convolutional Neural Networks</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark459" class="s208">improving model accuracy, </a><a href="#bookmark460" class="a">From Novice to Master Predictor: Maximizing Convolutional Neural Network </a><a href="#bookmark459" class="a">Accuracy</a><a href="#bookmark459" class="s208">-</a><a href="#bookmark460" class="a">From Novice to Master Predictor: Maximizing </a><a href="#bookmark460">Convolutional Neural Network Accuracy</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark95" class="s208">progress over past decade, </a><a href="#bookmark95">How Deep Learning Became a Thing</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark292" class="s208">resources for learning about, </a><a href="#bookmark295" class="a">Further Reading</a><a href="#bookmark295" class="s208">-</a><a href="#bookmark295">Further Reading</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark232" class="s208">structure of, </a><a href="#bookmark232" class="a">A Shallow Dive into Convolutional Neural Networks</a><a href="#bookmark2004" class="s208">, </a><a href="#bookmark232" class="a">Structure </a><a href="#bookmark232">of a CNN</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark489" class="s208">techniques for ML experimentation, </a><a href="#bookmark499" class="a">Common Techniques </a><a href="#bookmark489" class="a">for Machine Learning Experimentation</a><a href="#bookmark489" class="s208">-</a><a href="#bookmark499" class="a">Reproducible </a><a href="#bookmark499">Experiments</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark534" class="s208">tools for automated tuning, </a><a href="#bookmark534" class="a">Tools to Automate Tuning for Maximum Accuracy</a><a href="#bookmark544" class="s208">-</a><a href="#bookmark544">AutoKeras</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark462" class="s208">tools to reduce code and effort, </a><a href="#bookmark487" class="a">Tools of the Trade</a><a href="#bookmark487" class="s208">-</a><a href="#bookmark487">tf- explain</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark237" class="s208">transfer learning using, </a><a href="#bookmark237">Transfer Learning</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 15pt;text-align: left;"><a href="#bookmark1335" class="s208">versus transfer learning, </a><a href="#bookmark1335">Approach 2: Use Create ML</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1680" class="s208">Coral USB accelerator, </a>Google Coral USB Accelerator<a href="#bookmark1705" class="s208">, </a><a href="#bookmark1705">Speeding Up with the Google Coral USB Accelerator</a></p><p class="s3" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Core ML</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1197" class="s208">alternatives to, </a><a href="#bookmark1197">Alternatives to Core ML</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1216" class="s208">building real-time object recognition apps, </a><a href="#bookmark1224" class="a">Building a Real- </a><a href="#bookmark1216" class="a">Time Object Recognition App</a><a href="#bookmark1216" class="s208">-</a><a href="#bookmark1224" class="a">Building a Real-Time Object </a><a href="#bookmark1224">Recognition App</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1226" class="s208">conversion to, </a><a href="#bookmark1341" class="a">Conversion to Core ML</a><a href="#bookmark1341" class="s208">, </a><a href="#bookmark1341">Model Conversion Using Core ML Tools</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1233" class="s208">dynamic model deployment, </a><a href="#bookmark1233">Dynamic Model Deployment</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1206" class="s208">ecosystem, </a><a href="#bookmark1212" class="a">Apple’s Machine Learning Architecture</a><a href="#bookmark1212" class="s208">-</a><a href="#bookmark1212">ML Performance Primitives</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1194" class="s208">history of, </a><a href="#bookmark1194">A Brief History of Core ML</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1246" class="s208">measuring energy consumption, </a>Measuring Energy Impact<a href="#bookmark1255" class="s208">- </a><a href="#bookmark1255">Benchmarking Load</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1296" class="s208">Not Hotdog app, </a><a href="#bookmark1296" class="a">Not Hotdog on iOS with Core ML and Create ML</a><a href="#bookmark1349" class="s208">-</a><a href="#bookmark1349">Summary</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1235" class="s208">on-device training, </a><a href="#bookmark1235">On-Device Training</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1239" class="s208">performance analysis, </a>Performance Analysis<span style=" color: #000;">-</span></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1244">Benchmarking Models on iPhones</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 15pt;line-height: 209%;text-align: left;"><a href="#bookmark1257" class="s208">reducing app size, </a>Reducing App Size<a href="#bookmark1264" class="s208">-</a>Use Create ML <a href="#bookmark1634" class="s208">counting people, </a><a href="#bookmark1634">Crowd Counting</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1263" class="s208">Create ML, </a>Use Create ML<a href="#bookmark1328" class="s208">, </a>Approach 2: Use Create ML<a href="#bookmark1582" class="s208">- </a><a href="#bookmark1336" class="a">Approach </a><a href="#bookmark1582" class="a">2: Use Create ML</a><a href="#bookmark1582" class="s208">, </a><a href="#bookmark1582">Building a Custom Detector Without Any Code</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1634" class="s208">crowd counting, </a>Crowd Counting <a href="#bookmark1725" class="s208">cucumber sorting device, </a><a href="#bookmark1725">Cucumber Sorter</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark370" class="s208">curse of dimensionality, </a><a href="#bookmark370">Reducing Feature-Length with PCA</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">custom classifiers</p><p class="s2" style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark252" class="s208">building data pipelines, </a>Build the Data Pipeline <a href="#bookmark259" class="s208">data augmentation, </a>Data Augmentation <span style=" color: #000;">hosting and serving (see inference serving)</span></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark283" class="s208">model analysis, </a><a href="#bookmark290" class="a">Analyzing the Results</a><a href="#bookmark290" class="s208">-</a><a href="#bookmark290">Analyzing the Results</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark267" class="s208">model definition, </a>Model Definition <a href="#bookmark281" class="s208">model testing, </a><a href="#bookmark281">Test the Model</a></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark270" class="s208">model training, </a>Set Training Parameters <a href="#bookmark248" class="s208">organizing data, </a><a href="#bookmark248">Organize the Data</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark246" class="s208">overview of, </a><a href="#bookmark246">Building a Custom Classifier in Keras with Transfer Learning</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark875" class="s208">using cloud APIs, </a>Training Our Own Custom Classifier<span style=" color: #000;">-</span></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark902">Effect of Resizing on OCR APIs</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1575" class="s208">custom detectors, building without code, </a><a href="#bookmark1583" class="a">Building a Custom </a><a href="#bookmark1575" class="a">Detector Without Any Code</a><a href="#bookmark1575" class="s208">-</a><a href="#bookmark1583" class="a">Building a Custom Detector </a><a href="#bookmark1583">Without Any Code</a></p><p class="s3" style="padding-top: 5pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">(see also object detection)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1320" class="s208">CustomVision.ai, </a>Approach 1: Use Web UI-based Tools<a href="#bookmark1342" class="s208">- </a><a href="#bookmark1326" class="a">Approach </a><a href="#bookmark1342" class="a">1: Use Web UI-based Tools</a><a href="#bookmark1342" class="s208">, </a><a href="#bookmark1576" class="a">Model Conversion </a><a href="#bookmark1342" class="a">Using Core ML Tools</a><a href="#bookmark1342" class="s208">, </a><a href="#bookmark1576" class="a">Building a Custom Detector W</a><a href="#bookmark1576">ithout Any Code</a></p><p class="s3" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">D</p><p class="s2" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark259" class="s208">data augmentation, </a>Data Augmentation<a href="#bookmark265" class="s208">-</a>Data Augmentation<span style=" color: #000;">,</span></p><p class="s2" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;">Data Augmentation<a href="#bookmark1783" class="s208">, </a>Data Augmentation <a href="#bookmark645" class="s208">data caching, </a><a href="#bookmark645">Cache Data</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1795" class="s208">data generators, </a>Drive Data Generator <a href="#bookmark491" class="s208">data inspection, </a><a href="#bookmark491">Data Inspection</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;">data preparation (TensorFlow)</p><p class="s2" style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark625" class="s208">reducing size of input data, </a>Reduce Size of Input Data <a href="#bookmark623" class="s208">storing data as TFRecords, </a><a href="#bookmark623">Store as TFRecords</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark627" class="s208">using TensorFlow Datasets, </a><a href="#bookmark627">Use TensorFlow Datasets</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">data reading (TensorFlow)</p><p class="s2" style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark654" class="s208">autotuning parameter values, </a>Autotune Parameter Values <a href="#bookmark645" class="s208">caching data, </a><a href="#bookmark645">Cache Data</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark643" class="s208">enabling nondeterministic ordering, </a><a href="#bookmark643">Enable Nondeterministic Ordering</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark638" class="s208">parallelizing CPU processing, </a><a href="#bookmark638">Parallelize CPU Processing</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark640" class="s208">parallelizing I/O and processing, </a><a href="#bookmark640">Parallelize I/O and Processing</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark635" class="s208">prefetching data, </a><a href="#bookmark635">Prefetch Data</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark647" class="s208">turning on experimental optimizations, </a><a href="#bookmark647">Turn on Experimental Optimizations</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark632" class="s208">using tf.data, </a><a href="#bookmark632">Use tf.data</a></p><p class="s3" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">data size</p><p class="s2" style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark515" class="s208">effect on accuracy, </a>Effect of Data Size on Transfer Learning <a href="#bookmark891" class="s208">reducing image size, </a>Performance Tuning for Cloud APIs <a href="#bookmark625" class="s208">reducing in TensorFlow, </a><a href="#bookmark625">Reduce Size of Input Data</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark606" class="s208">datamash tool, </a><a href="#bookmark606">nvidia-smi</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1787" class="s208">dataset imbalance, </a>Dataset Imbalance and Driving Strategies <a href="#bookmark645" class="s208">Dataset.cache() function, </a><a href="#bookmark645">Cache Data</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark764" class="s208">DatasetList.com, </a><a href="#bookmark764">Data</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">datasets</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark773" class="s208">annotating data, </a><a href="#bookmark773">Data</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1302" class="s208">approaches to collecting data, </a><a href="#bookmark1315" class="a">Collecting Data</a><a href="#bookmark1315" class="s208">-</a><a href="#bookmark1315">Approach 3:</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1315">Web Scraper Using Bing Image Search API</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark755" class="s208">collecting hundreds of images, </a><a href="#bookmark1307" class="a">Data</a><a href="#bookmark1307" class="s208">, </a><a href="#bookmark1307">Approach 2: Fatkun Chrome Browser Extension</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark757" class="s208">downloading data in custom ways, </a>Data <a href="#bookmark767" class="s208">finding larger, </a><a href="#bookmark767">Data</a></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark764" class="s208">finding prebuilt, </a>Data <a href="#bookmark766" class="s208">finding smaller, </a><a href="#bookmark766">Data</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1465" class="s208">for mobile AI app development, </a><a href="#bookmark1465" class="a">How Do I Collect Initial Data?</a><a href="#bookmark1607" class="s208">, </a><a href="#bookmark1465" class="a">Data </a><a href="#bookmark1465">Collection</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark764" class="s208">Google Dataset Search, </a><a href="#bookmark764">Data</a></p><p class="s2" style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark178" class="s208">ImageNet dataset, </a>Predicting an Image’s Category<span style=" color: #000;">,</span></p><p class="s2" style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;">ImageNet Dataset<a href="#bookmark193" class="s208">-</a>ImageNet Dataset <a href="#bookmark772" class="s208">largest labeled, </a><a href="#bookmark772">Data</a></p><p class="s3" style="padding-left: 22pt;text-indent: 0pt;line-height: 17pt;text-align: left;">MS COCO (Microsoft Common Objects in COntext),</p><p class="s2" style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;">Datasets<a href="#bookmark423" class="s208">, </a>Image Captioning <a href="#bookmark105" class="s208">need for labeled, </a>Datasets <a href="#bookmark763" class="s208">of negative classes, </a><a href="#bookmark763">Data</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark91" class="s208">NIST and MNIST datasets, </a><a href="#bookmark91">A Glimmer of Hope</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark108" class="s208">publicly available, </a><a href="#bookmark1304" class="a">Datasets</a><a href="#bookmark1304" class="s208">, </a><a href="#bookmark1304">Approach 1: Find or Collect a Dataset</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark765" class="s208">reading popular, </a><a href="#bookmark765">Data</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark469" class="s208">ready-to-use, </a><a href="#bookmark469">TensorFlow Datasets</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1313" class="s208">scraping images using Bing Image Search API, </a><a href="#bookmark1313">Approach 3: Web Scraper Using Bing Image Search API</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark756" class="s208">scraping images using command line, </a>Data <a href="#bookmark1813" class="s208">sequential data, </a><a href="#bookmark1813">Training on Sequential Data</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark494" class="s208">splitting into train, validation, and test, </a><a href="#bookmark494">Breaking the Data:</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark494">Train, Validation, Test</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark380" class="s208">synthetic datasets, </a>Which Library Should I Use?<a href="#bookmark775" class="s208">, </a><a href="#bookmark775">Data</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark469" class="s208">TensorFlow Datasets, </a><a href="#bookmark627" class="a">TensorFlow Datasets</a><a href="#bookmark627" class="s208">, </a><a href="#bookmark627" class="a">Use TensorFlow Datasets</a><a href="#bookmark765" class="s208">, </a><a href="#bookmark765">Data</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark775" class="s208">for unique problems, </a><a href="#bookmark775">Data</a></p><p class="s2" style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark774" class="s208">versioning tools for, </a>Data <a href="#bookmark771" class="s208">video datasets, </a><a href="#bookmark771">Data</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark1809" class="s208">DAVE-2 system, </a><a href="#bookmark1809">Further Exploration</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark698" class="s208">DAWNBench benchmarks, </a>Examine Industry Benchmarks <a href="#bookmark747" class="s208">debugging, </a><a href="#bookmark747">Training</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;">deep learning</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1759" class="s208">applications in autonomous driving, </a><a href="#bookmark1759">Deep Learning, Autonomous Driving, and the Data Problem</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark67" class="s208">definition of, </a><a href="#bookmark67">What Is AI?</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark97" class="s208">highlights of modern era, </a><a href="#bookmark97" class="a">How Deep Learning Became a </a><a href="#bookmark97">Thing</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark93" class="s208">increase in popularity of, </a><a href="#bookmark93" class="a">How Deep Learning Became a </a><a href="#bookmark93">Thing</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark117" class="s208">libraries for, </a><a href="#bookmark117">Frameworks</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark102" class="s208">perfect deep learning solution, </a><a href="#bookmark102" class="a">Recipe for the Perfect Deep Learning Solution</a><a href="#bookmark128" class="s208">-</a><a href="#bookmark128">Hardware</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark782" class="s208">Deeplearning.ai, </a><a href="#bookmark782">Education and Exploration</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1549" class="s208">detection, </a>Detection <span style=" color: #000;">(see also facial recognition; object detection)</span></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark773" class="s208">Digital Data Divide, </a><a href="#bookmark773">Data</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1925" class="s208">discount factor (γ), </a>Delayed rewards and discount factor (γ) <a href="#bookmark1891" class="s208">discrete action space, </a><a href="#bookmark1891">Configure the action space</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1816" class="s208">Distributed Deep Reinforcement Learning for Autonomous Driving, </a><a href="#bookmark1816">Reinforcement Learning</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark694" class="s208">distributed training, </a>Distribute Training <a href="#bookmark1961" class="s208">DIY Robocars, </a><a href="#bookmark1961">DIY Robocars</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark737" class="s208">Docker, </a><a href="#bookmark737">Installation</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1754" class="s208">driving automation, </a><a href="#bookmark1754">Simulating a Self-Driving Car Using End- to-End Deep Learning with Keras</a></p><p class="s3" style="padding-top: 5pt;padding-left: 22pt;text-indent: 0pt;text-align: left;">(see also autonomous driving)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">E</p><p style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark677" class="s208">eager execution, </a><a href="#bookmark677">Use tf.function</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 36pt;text-align: justify;"><a href="#bookmark496" class="s208">early stopping, </a>Early Stopping<a href="#bookmark1800" class="s208">, </a>Callbacks <span style=" color: #000;">edge devices (see embedded AI devices) embedded AI devices</span></p><p class="s2" style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1715" class="s208">case studies, </a>Case Studies<a href="#bookmark1727" class="s208">-</a><a href="#bookmark1727">Cucumber Sorter</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1696" class="s208">comparison of, </a><a href="#bookmark1696" class="a">A Qualitative Comparison of Embedded AI Devices</a><a href="#bookmark1700" class="s208">-</a><a href="#bookmark1696" class="a">A </a><a href="#bookmark1696">Qualitative Comparison of Embedded AI Devices</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1669" class="s208">landscape of, </a><a href="#bookmark1669" class="a">Exploring the Landscape of Embedded AI Devices</a><a href="#bookmark1694" class="s208">-</a><a href="#bookmark1694">Arduino</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1712" class="s208">performance of, </a><a href="#bookmark1712" class="a">Comparing the Performance of Edge </a><a href="#bookmark1712">Devices</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 15pt;line-height: 209%;text-align: left;"><a href="#bookmark1729" class="s208">resources for learning about, </a>Further Exploration <span style=" color: #000;">embeddings</span></p><p class="s2" style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark353" class="s208">benefits of, </a>Visualizing Image Clusters with t-SNE <a href="#bookmark330" class="s208">defined, </a><a href="#bookmark330">Image Similarity</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark400" class="s208">extracting for similarity search, </a><a href="#bookmark400">Fine Tuning Without Fully Connected Layers</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark398" class="s208">fine tuning, </a><a href="#bookmark398">Improving Accuracy with Fine Tuning</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark404" class="s208">Siamese networks and, </a><a href="#bookmark404">Siamese Networks for One-Shot Face Verification</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark354" class="s208">TensorFlow Embedding projector, </a><a href="#bookmark354">Visualizing Image Clusters with t-SNE</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 15pt;line-height: 209%;text-align: left;"><a href="#bookmark395" class="s208">visualizing, </a>Improving Accuracy with Fine Tuning <a href="#bookmark778" class="s208">encryption, </a><a href="#bookmark778">Privacy</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1246" class="s208">energy consumption, of mobile apps, </a><a href="#bookmark1246" class="a">Measuring Energy Impact</a><a href="#bookmark1255" class="s208">-</a><a href="#bookmark1246" class="a">Benchmarking </a><a href="#bookmark1246">Load</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1876" class="s208">episodes, </a><a href="#bookmark1876">Practical Deep Reinforcement Learning with DeepRacer</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark339" class="s208">Euclidean distance, </a><a href="#bookmark371" class="a">Similarity Search</a><a href="#bookmark371" class="s208">, </a><a href="#bookmark371">Reducing Feature-</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark371">Length with PCA</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1878" class="s208">experience buffer, </a><a href="#bookmark1878">Practical Deep Reinforcement Learning with DeepRacer</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark647" class="s208">experimental optimizations, </a><a href="#bookmark647">Turn on Experimental Optimizations</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: -15pt;line-height: 157%;text-align: left;"><a href="#bookmark143" class="s208">explainability, </a>Accountability and Explainability <a href="#bookmark485" class="s208">tf-explain, </a>tf-explain<a href="#bookmark487" class="s208">-</a><a href="#bookmark487">tf-explain</a></p><p class="s2" style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark476" class="s208">What-If Tool, </a>What-If Tool<a href="#bookmark482" class="s208">-</a><a href="#bookmark482">What-If Tool</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">F</p><p style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark403" class="s208">facial recognition, </a><a href="#bookmark1639" class="a">Siamese Networks for One-Shot Face </a><a href="#bookmark403" class="a">Verification</a><a href="#bookmark1495" class="s208">, </a><a href="#bookmark403" class="a">Face Contours in ML Kit</a><a href="#bookmark403" class="s208">, </a><a href="#bookmark1639" class="a">Face Detection in </a><a href="#bookmark1639">Seeing AI</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark984" class="s208">failure handling, </a>Failure Handling <a href="#bookmark1023" class="s208">fairing, </a><a href="#bookmark1023">Fairing</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark391" class="s208">Faiss, </a><a href="#bookmark391">Faiss</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark781" class="s208">Fast.ai, </a>Education and Exploration <a href="#bookmark741" class="s208">FastProgress, </a><a href="#bookmark741">Training</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark755" class="s208">Fatkun Batch Download Image, </a><a href="#bookmark1307" class="a">Data</a><a href="#bookmark1307" class="s208">, </a><a href="#bookmark1307">Approach 2: Fatkun Chrome Browser Extension</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark333" class="s208">feature extraction, </a>Feature Extraction<a href="#bookmark336" class="s208">-</a>Feature Extraction<span style=" color: #000;">,</span></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1096">Feature Extraction</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 36pt;text-align: left;"><a href="#bookmark175" class="s208">feature scaling, </a>Predicting an Image’s Category <span style=" color: #000;">feature vectors</span></p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark330" class="s208">defined, </a><a href="#bookmark330">Image Similarity</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark361" class="s208">length of, </a><a href="#bookmark361">Length of Feature Vectors</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark366" class="s208">reducing feature length, </a><a href="#bookmark366">Reducing Feature-Length with PCA</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1237" class="s208">federated learning, </a><a href="#bookmark1237">Federated Learning</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1686" class="s208">Field Programmable Gate Arrays (FPGAs), </a><a href="#bookmark1686">FPGA + PYNQ</a></p><p class="s2" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark648" class="s208">filter operations, </a>Turn on Experimental Optimizations <a href="#bookmark650" class="s208">filter_fusion option, </a><a href="#bookmark650">Filter fusion</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark240" class="s208">fine tuning, </a><a href="#bookmark394" class="a">Fine Tuning</a><a href="#bookmark244" class="s208">-</a><a href="#bookmark394" class="a">How Much to Fine Tune</a><a href="#bookmark394" class="s208">, </a><a href="#bookmark401" class="a">Improving </a><a href="#bookmark394" class="a">Accuracy with Fine Tuning</a><a href="#bookmark394" class="s208">-</a><a href="#bookmark401" class="a">Fine Tuning Without Fully </a><a href="#bookmark401">Connected Layers</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark191" class="s208">fine-grained recognition, </a>ImageNet Dataset <a href="#bookmark1202" class="s208">Firebase, </a>ML Kit<a href="#bookmark1424" class="s208">, </a><a href="#bookmark1424">ML Kit + Firebase</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark643" class="s208">fixed round-robin order, </a>Enable Nondeterministic Ordering <a href="#bookmark962" class="s208">Flask, </a>Flask: Build Your Own Server<a href="#bookmark970" class="s208">-</a>Cons of Using Flask <a href="#bookmark411" class="s208">Flickr, </a><a href="#bookmark411">Flickr</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;">food classifier apps</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1407" class="s208">building real-time object recognition apps, </a><a href="#bookmark1419" class="a">Building a Real- </a><a href="#bookmark1407" class="a">Time Object Recognition App</a><a href="#bookmark1407" class="s208">-</a><a href="#bookmark1419" class="a">Building a Real-Time Object </a><a href="#bookmark1419">Recognition App</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1393" class="s208">challenges of, </a><a href="#bookmark1393">Shazam for Food: Developing Android Apps with TensorFlow Lite and ML Kit</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1395" class="s208">life cycle of, </a><a href="#bookmark1395">The Life Cycle of a Food Classifier App</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1462" class="s208">life cycle of mobile AI development, </a><a href="#bookmark1480" class="a">A Holistic Look at the </a><a href="#bookmark1462" class="a">Mobile AI App Development Cycle</a><a href="#bookmark1462" class="s208">-</a><a href="#bookmark1480" class="a">How Do I Update the </a><a href="#bookmark1480">Model on My Users’ Phones?</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1422" class="s208">using ML Kit + Firebase, </a><a href="#bookmark1447" class="a">ML Kit + Firebase</a><a href="#bookmark1447" class="s208">-</a><a href="#bookmark1447">Using the Experiment in Code</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1405" class="s208">model conversion to TensorFlow Lite, </a><a href="#bookmark1405">Model Conversion to TensorFlow Lite</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1390" class="s208">Shazam for Food app, </a><a href="#bookmark1390">Shazam for Food: Developing Android Apps with TensorFlow Lite and ML Kit</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1401" class="s208">TensorFlow Lite architecture, </a>TensorFlow Lite Architecture <a href="#bookmark1449" class="s208">TensorFlow Lite on iOS, </a>TensorFlow Lite on iOS <a href="#bookmark1399" class="s208">TensorFlow Lite overview, </a>An Overview of TensorFlow Lite <a href="#bookmark1397" class="s208">tools for, </a><a href="#bookmark1397">The Life Cycle of a Food Classifier App</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark257" class="s208">forward pass, </a><a href="#bookmark257">Batch Size</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1686" class="s208">FPGAs (Field Programmable Gate Arrays), </a>FPGA + PYNQ <a href="#bookmark1204" class="s208">Fritz, </a>Fritz<a href="#bookmark1458" class="s208">, </a>Fritz<a href="#bookmark1460" class="s208">-</a><a href="#bookmark1460">Fritz</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark717" class="s208">fused operations, </a><a href="#bookmark717">Use Fused Operations</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">G</p><p style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1145" class="s208">GAN Lab, </a><a href="#bookmark1145">GAN Lab</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1188" class="s208">General Data Protection Regulation (GDPR), </a><a href="#bookmark1188">Real-Time Object Classification on iOS with Core ML</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark679" class="s208">generalization, </a><a href="#bookmark1309" class="a">Overtrain, and Then Generalize</a><a href="#bookmark1309" class="s208">, </a><a href="#bookmark1309">Approach 2: Fatkun Chrome Browser Extension</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1114" class="s208">Generative Adversarial Networks (GANs), </a>pix2pix <a href="#bookmark981" class="s208">geographic availability, </a>Geographic Availability <a href="#bookmark910" class="s208">Giphy, </a><a href="#bookmark910">Giphy</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark425" class="s208">Giraffe-Tree problem, </a><a href="#bookmark425">Image Captioning</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">Google Cloud ML Engine</p><p class="s2" style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1001" class="s208">building classification APIs, </a>Building a Classification API<span style=" color: #000;">-</span></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1010">Building a Classification API</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 15pt;line-height: 209%;text-align: left;"><a href="#bookmark998" class="s208">pros and cons of, </a>Pros of Using Cloud ML Engine <a href="#bookmark1432" class="s208">Google Cloud Platform (GCP), </a><a href="#bookmark1432">Uploading a hosted model</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark840" class="s208">Google Cloud Vision, </a><a href="#bookmark1561" class="a">Google Cloud Vision</a><a href="#bookmark1561" class="s208">, </a><a href="#bookmark1561">Invoking Prebuilt Cloud-Based Object Detection APIs</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1680" class="s208">Google Coral USB accelerator, </a><a href="#bookmark1705" class="a">Google Coral USB </a><a href="#bookmark1680" class="a">Accelerator</a><a href="#bookmark1680" class="s208">, </a><a href="#bookmark1705" class="a">Speeding Up with the Google Coral </a><a href="#bookmark1705">USB Accelerator</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark764" class="s208">Google Dataset Search, </a><a href="#bookmark764">Data</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1680" class="s208">Google Edge Tensor Processing Unit (TPU), </a><a href="#bookmark1680">Google Coral USB Accelerator</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark784" class="s208">Google Seedbank, </a><a href="#bookmark784">Education and Exploration</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1066" class="s208">Google&#39;s AI doodle, </a><a href="#bookmark1066">AI in the Browser with TensorFlow.js and ml5.js</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark719" class="s208">GPU persistence, </a>Enable GPU Persistence <a href="#bookmark1101" class="s208">GPU utilization, </a><a href="#bookmark1101">GPU Utilization</a></p><p style="padding-left: 22pt;text-indent: -15pt;line-height: 157%;text-align: left;"><a href="#bookmark604" class="s208">Graphics Processing Unit (GPU) starvation displaying GPU statistics, </a><a href="#bookmark604">nvidia-smi</a></p><p style="padding-top: 8pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark601" class="s208">overview of, </a><a href="#bookmark601">GPU Starvation</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark608" class="s208">visualizing program execution, </a><a href="#bookmark608">TensorFlow Profiler + TensorBoard</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark123" class="s208">GUI-based model training tools, </a><a href="#bookmark123">A continuously evolving landscape</a></p><p class="s3" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">H</p><p class="s3" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">hardware</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark687" class="s208">installing optimized stacks for, </a><a href="#bookmark687">Install an Optimized Stack for the Hardware</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark126" class="s208">need for deep learning, </a>Hardware <a href="#bookmark692" class="s208">using better, </a><a href="#bookmark692">Use Better Hardware</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark198" class="s208">heatmaps, </a><a href="#bookmark485" class="a">Class Activation Maps</a><a href="#bookmark202" class="s208">-</a><a href="#bookmark485" class="a">Class Activation Maps</a><a href="#bookmark485" class="s208">, </a><a href="#bookmark485" class="a">tf- explain</a><a href="#bookmark1935" class="s208">, </a><a href="#bookmark485" class="a">Heatmap </a><a href="#bookmark485">visualization</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark974" class="s208">high availability, </a>High Availability <a href="#bookmark1273" class="s208">HomeCourt, </a><a href="#bookmark1273">HomeCourt</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark694" class="s208">horizontal scaling, </a><a href="#bookmark694">Distribute Training</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">hosted models</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1439" class="s208">A/B testing, </a><a href="#bookmark1447" class="a">A/B Testing Hosted Models</a><a href="#bookmark1447" class="s208">-</a><a href="#bookmark1447">Using the Experiment in Code</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1431" class="s208">accessing, </a>Accessing a hosted model <a href="#bookmark1430" class="s208">with Firebase, </a>Hosted Models <a href="#bookmark1432" class="s208">uploading, </a><a href="#bookmark1432">Uploading a hosted model</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;">hosting and serving (see inference serving)</p><p class="s2" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark745" class="s208">Hyperas, </a>Training <a href="#bookmark745" class="s208">Hyperopt, </a><a href="#bookmark745">Training</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;">hyperparameters</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark465" class="s208">automatic tuning, </a><a href="#bookmark534" class="a">Tools of the Trade</a><a href="#bookmark534" class="s208">, </a><a href="#bookmark654" class="a">Tools to Automate </a><a href="#bookmark534" class="a">Tuning for Maximum Accuracy</a><a href="#bookmark544" class="s208">-</a><a href="#bookmark534" class="a">AutoKeras</a><a href="#bookmark534" class="s208">, </a><a href="#bookmark654" class="a">Autotune Parameter Values</a><a href="#bookmark745" class="s208">, </a><a href="#bookmark654" class="a">T</a><a href="#bookmark654">raining</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark507" class="s208">effect on accuracy, </a>How Hyperparameters Affect Accuracy<a href="#bookmark532" class="s208">- </a><a href="#bookmark532">Effect of Change in Aspect Ratio on Transfer Learning</a></p><p class="s3" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">I</p><p style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark846" class="s208">IBM Watson Visual Recognition, </a><a href="#bookmark846">IBM Watson Visual Recognition</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 36pt;text-align: left;"><a href="#bookmark423" class="s208">image captioning, </a>Image Captioning <span style=" color: #000;">image classification</span></p><p style="padding-top: 5pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: justify;"><a href="#bookmark246" class="s208">building custom classifiers in Keras, </a><a href="#bookmark290" class="a">Building a Custom </a><a href="#bookmark246" class="a">Classifier in Keras with Transfer Learning</a><a href="#bookmark246" class="s208">-</a><a href="#bookmark290" class="a">Analyzing the </a><a href="#bookmark290">Results</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark192" class="s208">category unawareness, </a><a href="#bookmark192">ImageNet Dataset</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark198" class="s208">class activation maps (heat maps), </a>Class Activation Maps<span style=" color: #000;">-</span></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark202">Class Activation Maps</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark234" class="s208">using CNNs, </a><a href="#bookmark234">A Shallow Dive into Convolutional Neural Networks</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1998" class="s208">desired properties of image classifiers, </a><a href="#bookmark1998">Desired Properties of an Image Classifier</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark191" class="s208">fine-grained recognition, </a><a href="#bookmark191">ImageNet Dataset</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark174" class="s208">how images store information, </a><a href="#bookmark174">Predicting an Image’s Category</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark186" class="s208">ImageNet dataset, </a>ImageNet Dataset<a href="#bookmark193" class="s208">-</a><a href="#bookmark193">ImageNet Dataset</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark172" class="s208">using Keras, </a><a href="#bookmark182" class="a">Predicting an Image’s Category</a><a href="#bookmark182" class="s208">-</a><a href="#bookmark182">Predicting an Image’s Category</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark195" class="s208">model zoos, </a><a href="#bookmark195">Model Zoos</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark175" class="s208">preprocessing images, </a>Predicting an Image’s Category <a href="#bookmark171" class="s208">simple pipeline for, </a><a href="#bookmark171">Predicting an Image’s Category</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark895" class="s208">image labeling APIs, </a><a href="#bookmark895" class="a">Effect of Resizing on Image Labeling APIs</a><a href="#bookmark1467" class="s208">, </a><a href="#bookmark895" class="a">How </a><a href="#bookmark895">Do I Label My Data?</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark198" class="s208">image saliency, </a>Class Activation Maps <a href="#bookmark1625" class="s208">image segmentation, </a><a href="#bookmark1625">Image Segmentation</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark327" class="s208">image similarity, </a>Image Similarity<a href="#bookmark331" class="s208">-</a>Image Similarity <a href="#bookmark891" class="s208">image size, </a>Performance Tuning for Cloud APIs <a href="#bookmark763" class="s208">ImageN, </a><a href="#bookmark763">Data</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark178" class="s208">ImageNet dataset, </a><a href="#bookmark186" class="a">Predicting an Image’s Category</a><a href="#bookmark186" class="s208">, </a><a href="#bookmark186" class="a">ImageNet Dataset</a><a href="#bookmark193" class="s208">-</a><a href="#bookmark186" class="a">ImageNet </a><a href="#bookmark186">Dataset</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark189" class="s208">ImageNet Large Scale Visual Recognition Challenge </a><a href="#bookmark94" class="s208">(ILSVRC), </a><a href="#bookmark189" class="a">How Deep Learning Became a Thing</a><a href="#bookmark189" class="s208">, </a><a href="#bookmark189">ImageNet Dataset</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1305" class="s208">ImageNet-Utils, </a>Approach 1: Find or Collect a Dataset <a href="#bookmark766" class="s208">Imagenette, </a><a href="#bookmark766">Data</a></p><p class="s2" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark773" class="s208">iMerit, </a>Data <a href="#bookmark138" class="s208">implicit bias, </a><a href="#bookmark138">Bias</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark141" class="s208">in-group/out-group bias, </a><a href="#bookmark141">Bias</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark840" class="s208">Inception architectures, </a>Google Cloud Vision <a href="#bookmark919" class="s208">InDro Robotics, </a><a href="#bookmark919">InDro Robotics</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;">inference serving</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark972" class="s208">desirable qualities for, </a><a href="#bookmark992" class="a">Desirable Qualities in a Production- </a><a href="#bookmark972" class="a">Level Serving System</a><a href="#bookmark972" class="s208">-</a><a href="#bookmark992" class="a">Support for Multiple Machine </a><a href="#bookmark992">Learning Libraries</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark117" class="s208">frameworks for, </a><a href="#bookmark117">Frameworks</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark956" class="s208">frequently asked questions, </a><a href="#bookmark956">Scalable Inference Serving on Cloud with TensorFlow Serving and KubeFlow</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark995" class="s208">Google Cloud ML Engine, </a><a href="#bookmark1010" class="a">Google Cloud ML Engine: A </a><a href="#bookmark995" class="a">Managed Cloud AI Serving Stack</a><a href="#bookmark995" class="s208">-</a><a href="#bookmark1010" class="a">Building a </a><a href="#bookmark1010">Classification API</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1015" class="s208">KubeFlow, </a>KubeFlow<a href="#bookmark1028" class="s208">-</a><a href="#bookmark1028">Installation</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1030" class="s208">price versus performance, </a><a href="#bookmark1030" class="a">Price Versus Performance Considerations</a><a href="#bookmark1036" class="s208">-</a><a href="#bookmark1030" class="a">Cost </a><a href="#bookmark1036" class="a">Analysis of Building Your Own </a><a href="#bookmark1036">Stack</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark962" class="s208">server building with Flask, </a>Flask: Build Your Own Server<a href="#bookmark970" class="s208">- </a><a href="#bookmark970">Cons of Using Flask</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1012" class="s208">TensorFlow Serving, </a><a href="#bookmark1012">TensorFlow Serving</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark958" class="s208">tools, libraries, and cloud services, </a><a href="#bookmark958">Landscape of Serving AI Predictions</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1127" class="s208">inference time, </a><a href="#bookmark1127">Inference Time</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark996" class="s208">Inference-as-a-Service, </a><a href="#bookmark1031" class="a">Google Cloud ML Engine: A Managed </a><a href="#bookmark996" class="a">Cloud AI Serving Stack</a><a href="#bookmark996" class="s208">, </a><a href="#bookmark1031" class="a">Price Versus Performance </a><a href="#bookmark1031">Considerations</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark733" class="s208">installation, </a>Installation<a href="#bookmark738" class="s208">-</a>Installation <a href="#bookmark762" class="s208">InstaLooter, </a><a href="#bookmark762">Data</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark325" class="s208">instance retrieval, </a><a href="#bookmark325">Building a Reverse Image Search Engine:</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark325">Understanding Embeddings</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1555" class="s208">instance-level segmentation, </a>Instance-level segmentation <a href="#bookmark1276" class="s208">InstaSaber, </a><a href="#bookmark1276">InstaSaber + YoPuppet</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark1688" class="s208">Instruction Set Architecture (ISA), </a><a href="#bookmark1688">FPGAs</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1676" class="s208">Intel Movidius Neural Compute Stick 2, </a><a href="#bookmark1676">Intel Movidius Neural Compute Stick</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1110" class="s208">Interactive Telecommunications Program (ITP), </a><a href="#bookmark1110">PoseNet</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1186" class="s208">interactivity, </a><a href="#bookmark1186">Real-Time Object Classification on iOS with Core ML</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1595" class="s208">Intersection over Union (IoU), </a>Intersection over Union <span style=" color: #000;">iOS models (see Core ML)</span></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 15pt;text-align: left;">J</p><p style="padding-top: 8pt;padding-left: 22pt;text-indent: -15pt;line-height: 157%;text-align: left;"><a href="#bookmark1072" class="s208">JavaScript-based ML libraries ConvNetJS, </a><a href="#bookmark1072">ConvNetJS</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1069" class="s208">history of, </a><a href="#bookmark1069">JavaScript-Based Machine Learning Libraries: A Brief History</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1075" class="s208">Keras.js, </a>Keras.js <a href="#bookmark1077" class="s208">ONNX.js, </a><a href="#bookmark1077">ONNX.js</a></p><p class="s2" style="padding-left: 6pt;text-indent: 15pt;line-height: 209%;text-align: left;"><a href="#bookmark1082" class="s208">TensorFlow.js, </a>TensorFlow.js <a href="#bookmark1717" class="s208">JetBot, </a><a href="#bookmark1717">JetBot</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1683" class="s208">Jetson Nano, </a><a href="#bookmark1709" class="a">NVIDIA Jetson Nano</a><a href="#bookmark1709" class="s208">, </a><a href="#bookmark1709">Port to NVIDIA Jetson Nano</a></p><p class="s3" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Jupyter Notebooks</p><p class="s2" style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark784" class="s208">machine learning examples, </a>Education and Exploration <a href="#bookmark733" class="s208">running interactively in browsers, </a><a href="#bookmark733">Installation</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark1023" class="s208">using with KubeFlow, </a><a href="#bookmark1023">Fairing</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">K</p><p class="s3" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Keras</p><p class="s2" style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark124" class="s208">benefits of, </a>A continuously evolving landscape<span style=" color: #000;">,</span></p><p class="s2" style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;">Introducing Keras <a href="#bookmark1799" class="s208">callbacks in, </a><a href="#bookmark1799">Callbacks</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1228" class="s208">conversion to Core ML, </a><a href="#bookmark1342" class="a">Conversion from Keras</a><a href="#bookmark1342" class="s208">, </a><a href="#bookmark1342">Model Conversion Using Core ML Tools</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark246" class="s208">custom classifiers using transfer learning, </a><a href="#bookmark246" class="a">Building a Custom Classifier in Keras with Transfer Learning</a><a href="#bookmark290" class="s208">- </a><a href="#bookmark290">Analyzing the Results</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark967" class="s208">deploying models to Flask, </a><a href="#bookmark967">Deploying a Keras Model to Flask</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1338" class="s208">fine tuning object classifiers with, </a><a href="#bookmark1338">Approach 3: Fine Tuning Using Keras</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark120" class="s208">history of, </a><a href="#bookmark120">Keras</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark171" class="s208">image classification pipeline, </a><a href="#bookmark171" class="a">Predicting an Image’s Category</a><a href="#bookmark182" class="s208">-</a><a href="#bookmark171" class="a">Predicting </a><a href="#bookmark171">an Image’s Category</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark334" class="s208">key function for feature extraction, </a>Feature Extraction <a href="#bookmark184" class="s208">model accuracy, </a>Investigating the Model<a href="#bookmark193" class="s208">-</a>ImageNet Dataset <a href="#bookmark195" class="s208">pretrained models in, </a><a href="#bookmark195">Model Zoos</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;">Keras functions</p><p class="s2" style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark177" class="s208">decode_predictions, </a>Predicting an Image’s Category <a href="#bookmark263" class="s208">ImageDataGenerator, </a>Data Augmentation <a href="#bookmark175" class="s208">preprocess_input, </a><a href="#bookmark175">Predicting an Image’s Category</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark465" class="s208">Keras Tuner, </a>Tools of the Trade<a href="#bookmark536" class="s208">, </a>Keras Tuner<a href="#bookmark537" class="s208">-</a>Keras Tuner<a href="#bookmark745" class="s208">, </a><a href="#bookmark745">Training</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1075" class="s208">Keras.js, </a><a href="#bookmark1075">Keras.js</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 36pt;text-align: left;"><a href="#bookmark1109" class="s208">keypoint detection, </a>PoseNet <a href="#bookmark740" class="s208">Knock Knock, </a>Training <span style=" color: #000;">KubeFlow</span></p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1023" class="s208">fairing, </a><a href="#bookmark1023">Fairing</a></p><p class="s2" style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1026" class="s208">installation, </a>Installation <a href="#bookmark1015" class="s208">introduction to, </a>KubeFlow <a href="#bookmark1020" class="s208">pipelines, </a><a href="#bookmark1020">Pipelines</a></p><p class="s2" style="padding-left: 6pt;text-indent: 15pt;line-height: 209%;text-align: left;"><a href="#bookmark1017" class="s208">tools available, </a>KubeFlow <a href="#bookmark1016" class="s208">Kubernetes, </a><a href="#bookmark1016">KubeFlow</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 15pt;text-align: left;">L</p><p style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark105" class="s208">labeling, </a><a href="#bookmark1611" class="a">Datasets</a><a href="#bookmark773" class="s208">, </a><a href="#bookmark1611" class="a">Data</a><a href="#bookmark1467" class="s208">, </a><a href="#bookmark1611" class="a">How Do I Label My Data?</a><a href="#bookmark1611" class="s208">, </a><a href="#bookmark1611">Labeling the Data</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark979" class="s208">latency, </a><a href="#bookmark1186" class="a">Low Latency</a><a href="#bookmark1186" class="s208">, </a><a href="#bookmark1186">Real-Time Object Classification on iOS with Core ML</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark512" class="s208">layers, effect on accuracy, </a><a href="#bookmark512">Effect of Number of Layers Fine-</a></p><p class="s2" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;">Tuned in Transfer Learning <a href="#bookmark340" class="s208">lazy learning, </a><a href="#bookmark340">Similarity Search</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;">learning rate</p><p class="s2" style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark518" class="s208">effect on accuracy, </a>Effect of Learning Rate <a href="#bookmark673" class="s208">finding optimal, </a>Find the Optimal Learning Rate <a href="#bookmark273" class="s208">role of, </a><a href="#bookmark273">Set Training Parameters</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1547" class="s208">localization, </a>Localization <a href="#bookmark1487" class="s208">Lose It!, </a><a href="#bookmark1487">Lose It!</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark271" class="s208">loss function, </a><a href="#bookmark406" class="a">Set Training Parameters</a><a href="#bookmark406" class="s208">, </a><a href="#bookmark406">Siamese Networks for One-Shot Face Verification</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark979" class="s208">low latency, </a><a href="#bookmark979">Low Latency</a></p><p class="s3" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">M</p><p class="s3" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">machine learning (ML)</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1206" class="s208">Apple’s machine learning architecture, </a><a href="#bookmark1206" class="a">Apple’s Machine Learning Architecture</a><a href="#bookmark1212" class="s208">-</a><a href="#bookmark1206" class="a">ML Performance Primitives</a><a href="#bookmark1206" class="s208">,</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark1328">Approach 2: Use Create ML</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark489" class="s208">common techniques for, </a><a href="#bookmark489" class="a">Common Techniques for Machine Learning Experimentation</a><a href="#bookmark499" class="s208">-</a><a href="#bookmark489" class="a">Reproducible </a><a href="#bookmark489">Experiments</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark66" class="s208">definition of, </a><a href="#bookmark66">What Is AI?</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1069" class="s208">JavaScript-based ML libraries, </a><a href="#bookmark1069" class="a">JavaScript-Based Machine Learning Libraries: A Brief History</a><a href="#bookmark1081" class="s208">-</a><a href="#bookmark1069" class="a">T</a><a href="#bookmark1069">ensorFlow.js</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1982" class="s208">overview of, </a><a href="#bookmark1982">Machine Learning</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark780" class="s208">resources for learning about, </a>Education and Exploration<span style=" color: #000;">,</span></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark2007">Further Exploration</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark993" class="s208">support for multiple ML libraries, </a><a href="#bookmark993">Support for Multiple Machine Learning Libraries</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 15pt;line-height: 209%;text-align: left;"><a href="#bookmark134" class="s208">terminology used in, </a>Bias <a href="#bookmark1268" class="s208">Magic Sudoku, </a><a href="#bookmark1268">Magic Sudoku</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark714" class="s208">magnitude-based weight pruning, </a>Prune the Model <a href="#bookmark649" class="s208">map operations, </a>Turn on Experimental Optimizations <a href="#bookmark651" class="s208">map_and_filter_fusion option, </a>Map and filter fusion <a href="#bookmark641" class="s208">map_func function, </a>Parallelize I/O and Processing <a href="#bookmark652" class="s208">map_fusion option, </a><a href="#bookmark652">Map fusion</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1919" class="s208">Markov decision process (MDP), </a><a href="#bookmark1919">The Markov decision process</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1552" class="s208">masks, </a><a href="#bookmark1552">Segmentation</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1599" class="s208">Mean Average Precision (mAP), </a>Mean Average Precision <a href="#bookmark1140" class="s208">Metacar, </a><a href="#bookmark1140">Metacar</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark404" class="s208">metric learning, </a><a href="#bookmark404">Siamese Networks for One-Shot Face Verification</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark274" class="s208">metrics, </a><a href="#bookmark274">Set Training Parameters</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1403" class="s208">MicroController Units (MCUs), </a>TensorFlow Lite Architecture<a href="#bookmark1692" class="s208">, </a><a href="#bookmark1692">Arduino</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark837" class="s208">Microsoft Cognitive Services, </a>Microsoft Cognitive Services<a href="#bookmark1561" class="s208">, </a><a href="#bookmark1561">Invoking Prebuilt Cloud-Based Object Detection APIs</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 36pt;text-align: left;"><a href="#bookmark668" class="s208">minibatches, </a>Use Larger Batch Size <a href="#bookmark694" class="s208">MirroredStrategy, </a>Distribute Training <span style=" color: #000;">ML Kit</span></p><p style="padding-top: 5pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1202" class="s208">benefits of, </a><a href="#bookmark1202">ML Kit</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1422" class="s208">common ML tasks supported by, </a>ML Kit + Firebase <a href="#bookmark1449" class="s208">cross-platform adaptability, </a><a href="#bookmark1449">TensorFlow Lite on iOS</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark1423" class="s208">using custom trained TensorFlow Lite models, </a><a href="#bookmark1423">ML Kit +</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1423" class="a">Firebase</a><a href="#bookmark1428" class="s208">, </a><a href="#bookmark1423" class="a">Custom </a><a href="#bookmark1423">Models in ML Kit</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1495" class="s208">facial contours in, </a><a href="#bookmark1495">Face Contours in ML Kit</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1430" class="s208">using hosted models, </a><a href="#bookmark1447" class="a">Hosted Models</a><a href="#bookmark1447" class="s208">-</a><a href="#bookmark1447">Using the Experiment in Code</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 15pt;line-height: 209%;text-align: left;"><a href="#bookmark1426" class="s208">object classification, </a>Object Classification in ML Kit <a href="#bookmark1105" class="s208">ml5.js, </a><a href="#bookmark1105">ml5.js</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark700" class="s208">MLPerf, </a>Examine Industry Benchmarks <a href="#bookmark753" class="s208">MMdnn, </a><a href="#bookmark753">Model</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark91" class="s208">MNIST dataset, </a><a href="#bookmark91">A Glimmer of Hope</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">mobile-based AI</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1206" class="s208">Apple’s machine learning architecture, </a><a href="#bookmark1206" class="a">Apple’s Machine Learning Architecture</a><a href="#bookmark1212" class="s208">-</a><a href="#bookmark1206" class="a">ML Performance Primitives</a><a href="#bookmark1206" class="s208">,</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark1328">Approach 2: Use Create ML</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1216" class="s208">building real-time object recognition apps, </a><a href="#bookmark1224" class="a">Building a Real- </a><a href="#bookmark1216" class="a">Time Object Recognition App</a><a href="#bookmark1216" class="s208">-</a><a href="#bookmark1407" class="a">Building a Real-Time Object </a><a href="#bookmark1224" class="a">Recognition App</a><a href="#bookmark1224" class="s208">, </a><a href="#bookmark1407" class="a">Building a Real-Time Object Recognition App</a><a href="#bookmark1419" class="s208">-</a><a href="#bookmark1407" class="a">Building </a><a href="#bookmark1407">a Real-Time Object Recognition App</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1266" class="s208">case studies, </a><a href="#bookmark1485" class="a">Case Studies</a><a href="#bookmark1279" class="s208">-</a><a href="#bookmark1485" class="a">InstaSaber + YoPuppet</a><a href="#bookmark1485" class="s208">, </a><a href="#bookmark1485" class="a">Case Studies</a><a href="#bookmark1499" class="s208">-</a><a href="#bookmark1485" class="a">Real-T</a><a href="#bookmark1499" class="a">ime Video Segmentation in YouTube </a><a href="#bookmark1499">Stories</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1185" class="s208">challenges of, </a><a href="#bookmark1185">Real-Time Object Classification on iOS with Core ML</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1226" class="s208">conversion to Core ML, </a>Conversion to Core ML <a href="#bookmark1197" class="s208">Core ML alternatives, </a>Alternatives to Core ML <a href="#bookmark1194" class="s208">Core ML history, </a><a href="#bookmark1194">A Brief History of Core ML</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1191" class="s208">development life cycle for, </a><a href="#bookmark1191">The Development Life Cycle for Artificial Intelligence on Mobile</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1233" class="s208">dynamic model deployment, </a><a href="#bookmark1233">Dynamic Model Deployment</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1189" class="s208">frequently asked questions, </a><a href="#bookmark1462" class="a">Real-Time Object </a><a href="#bookmark1189" class="a">Classification on iOS with Core ML</a><a href="#bookmark1189" class="s208">, </a><a href="#bookmark1462" class="a">A Holistic </a><a href="#bookmark1480" class="a">Look at the </a><a href="#bookmark1462" class="a">Mobile AI App Development Cycle</a><a href="#bookmark1462" class="s208">-</a><a href="#bookmark1480" class="a">How Do I Update the </a><a href="#bookmark1480">Model on My Users’ Phones?</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1458" class="s208">Fritz end-to-end solution for, </a>Fritz<a href="#bookmark1460" class="s208">-</a><a href="#bookmark1460">Fritz</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1246" class="s208">measuring energy consumption, </a>Measuring Energy Impact<span style=" color: #000;">-</span></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1255">Benchmarking Load</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1235" class="s208">on-device training, </a><a href="#bookmark1235">On-Device Training</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1239" class="s208">performance analysis, </a>Performance Analysis<span style=" color: #000;">-</span></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1244">Benchmarking Models on iPhones</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1257" class="s208">reducing app size, </a>Reducing App Size<a href="#bookmark1264" class="s208">-</a>Use Create ML <a href="#bookmark1482" class="s208">self-evolving model, </a><a href="#bookmark1482">The Self-Evolving Model</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark746" class="s208">MobileNet, </a><a href="#bookmark746">Training</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">model accuracy</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark704" class="s208">improving TensorFlow performance, </a><a href="#bookmark720" class="a">Inference</a><a href="#bookmark720" class="s208">-</a><a href="#bookmark720">Enable GPU Persistence</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark283" class="s208">transfer learning with Keras, </a>Analyzing the Results<span style=" color: #000;">-</span></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark290">Analyzing the Results</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark111" class="s208">model architecture, </a>Model Architecture <a href="#bookmark752" class="s208">model cards, </a><a href="#bookmark752">Model</a></p><p class="s2" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark714" class="s208">model compression, </a>Prune the Model <a href="#bookmark267" class="s208">model definition, </a><a href="#bookmark267">Model Definition</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;">model inference (TensorFlow)</p><p class="s2" style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark717" class="s208">fused operations, </a>Use Fused Operations <a href="#bookmark719" class="s208">GPU persistence, </a>Enable GPU Persistence <a href="#bookmark714" class="s208">pruning, </a><a href="#bookmark714">Prune the Model</a></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark710" class="s208">quantization techniques, </a>Quantize the Model <a href="#bookmark706" class="s208">selecting efficient models, </a><a href="#bookmark706">Use an Efficient Model</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1125" class="s208">model size, </a>Model Size <a href="#bookmark281" class="s208">model testing, </a>Test the Model <a href="#bookmark749" class="s208">model tips and tricks, </a><a href="#bookmark749">Model</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;">model training</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark608" class="s208">analyzing with TensorFlow profiler, </a><a href="#bookmark608">TensorFlow Profiler +</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark608">TensorBoard</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1317" class="s208">approaches to, </a><a href="#bookmark1339" class="a">Training Our Model</a><a href="#bookmark1339" class="s208">-</a><a href="#bookmark1339">Approach 3: Fine Tuning Using Keras</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1093" class="s208">browser-based AI, </a>Training in the Browser<a href="#bookmark1103" class="s208">-</a>GPU Utilization <a href="#bookmark1469" class="s208">mobile-based AI, </a><a href="#bookmark1469">How Do I Train My Model?</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark664" class="s208">optimizing in TensorFlow, </a><a href="#bookmark702" class="a">Training</a><a href="#bookmark702" class="s208">-</a><a href="#bookmark702">Examine Industry Benchmarks</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark270" class="s208">transfer learning with Keras, </a><a href="#bookmark279" class="a">Set Training Parameters</a><a href="#bookmark279" class="s208">-</a><a href="#bookmark279">Start Training</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1319" class="s208">web UI-based tools, </a>Approach 1: Use Web UI-based Tools<span style=" color: #000;">-</span></p><p class="s2" style="padding-top: 3pt;padding-left: 6pt;text-indent: 15pt;line-height: 209%;text-align: left;">Approach 1: Use Web UI-based Tools <a href="#bookmark988" class="s208">model versioning, </a>Model Versioning <a href="#bookmark195" class="s208">model zoos, </a><a href="#bookmark195">Model Zoos</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1920" class="s208">model-free reinforcement learning, </a><a href="#bookmark1920" class="a">Model free versus model </a><a href="#bookmark1920">based</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark751" class="s208">ModelDepot.io, </a>Model <a href="#bookmark751" class="s208">ModelZoo.co, </a>Model <a href="#bookmark986" class="s208">monitoring, </a><a href="#bookmark986">Monitoring</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1676" class="s208">Movidius Neural Compute Stick 2, </a><a href="#bookmark1676">Intel Movidius Neural Compute Stick</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark106" class="s208">MS COCO (Microsoft Common Objects in COntext), </a>Datasets<a href="#bookmark423" class="s208">, </a><a href="#bookmark423">Image Captioning</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark750" class="s208">MS Paint, </a><a href="#bookmark750">Model</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark255" class="s208">multiclass classification, </a>Multiclass classification <a href="#bookmark84" class="s208">multilayer neural networks, </a><a href="#bookmark84">A Glimmer of Hope</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark993" class="s208">multiple libraries support, </a><a href="#bookmark993">Support for Multiple Machine Learning Libraries</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark673" class="s208">multiples of eight, </a>Find the Optimal Learning Rate <a href="#bookmark694" class="s208">MultiWorkerMirroredStrategy, </a><a href="#bookmark694">Distribute Training</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1678" class="s208">Myriad VPU, </a><a href="#bookmark1678">Intel Movidius Neural Compute Stick</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">N</p><p style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark89" class="s208">National Institute of Standards and Technology (NIST), </a><a href="#bookmark89">A Glimmer of Hope</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark87" class="s208">NavLab, </a><a href="#bookmark1756" class="a">A Glimmer of Hope</a><a href="#bookmark1756" class="s208">, </a><a href="#bookmark1756">A Brief History of Autonomous Driving</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: -15pt;line-height: 157%;text-align: left;"><a href="#bookmark427" class="s208">nearest-neighbor approach efficacy of, </a><a href="#bookmark427">Image Captioning</a></p><p style="padding-top: 8pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark374" class="s208">scaling reverse image search using, </a><a href="#bookmark374" class="a">Scaling Similarity Search with Approximate Nearest Neighbors</a><a href="#bookmark392" class="s208">-</a><a href="#bookmark392">Faiss</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 15pt;text-align: left;"><a href="#bookmark338" class="s208">similarity search using, </a>Similarity Search<a href="#bookmark345" class="s208">-</a><a href="#bookmark345">Similarity Search</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark763" class="s208">negative classes, </a><a href="#bookmark1310" class="a">Data</a><a href="#bookmark1310" class="s208">, </a><a href="#bookmark1310">Approach 2: Fatkun Chrome Browser Extension</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark389" class="s208">Neighborhood Graph and Tree (NGT), </a>NGT <a href="#bookmark749" class="s208">Netron, </a><a href="#bookmark749">Model</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark466" class="s208">Neural Architecture Search (NAS), </a>Tools of the Trade<span style=" color: #000;">,</span></p><p class="s2" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">AutoKeras<a href="#bookmark746" class="s208">, </a><a href="#bookmark746">Training</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: -15pt;line-height: 157%;text-align: left;"><a href="#bookmark260" class="s208">neural networks (see also Convolutional Neural Networks) data augmentation, </a><a href="#bookmark260">Data Augmentation</a></p><p style="padding-top: 8pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark78" class="s208">definition of, </a><a href="#bookmark78">Exciting Beginnings</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark710" class="s208">matrix-matrix multiplication in, </a>Quantize the Model <a href="#bookmark84" class="s208">multilayer, </a><a href="#bookmark84">A Glimmer of Hope</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1991" class="s208">overview of, </a><a href="#bookmark1991">Neural Networks</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark249" class="s208">purpose of validation sets, </a>Organize the Data <a href="#bookmark292" class="s208">resources for learning about, </a>Further Reading <a href="#bookmark1996" class="s208">shortcomings of, </a><a href="#bookmark1996">Shortcoming of Neural Networks</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark906" class="s208">New York Times, </a>The New York Times<a href="#bookmark977" class="s208">, </a>Scalability <a href="#bookmark89" class="s208">NIST dataset, </a><a href="#bookmark89">A Glimmer of Hope</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark750" class="s208">NN-SVG, </a><a href="#bookmark750">Model</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1601" class="s208">Non-Maximum Suppression (NMS), </a><a href="#bookmark1601">Non-Maximum Suppression</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark643" class="s208">nondeterministic ordering, </a>Enable Nondeterministic Ordering <a href="#bookmark175" class="s208">normalization, </a><a href="#bookmark175">Predicting an Image’s Category</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;">Not Hotdog app</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1344" class="s208">building iOS app, </a><a href="#bookmark1344">Building the iOS App</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1302" class="s208">collecting data, </a><a href="#bookmark1315" class="a">Collecting Data</a><a href="#bookmark1315" class="s208">-</a><a href="#bookmark1315">Approach 3: Web Scraper Using Bing Image Search API</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1341" class="s208">model conversion using Core ML, </a><a href="#bookmark1341">Model Conversion Using Core ML Tools</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1317" class="s208">model training, </a><a href="#bookmark1339" class="a">Training Our Model</a><a href="#bookmark1339" class="s208">-</a><a href="#bookmark1339">Approach 3: Fine Tuning Using Keras</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1299" class="s208">overview of steps, </a><a href="#bookmark1299">Not Hotdog on iOS with Core ML and Create ML</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark974" class="s208">number of nines, </a><a href="#bookmark974">High Availability</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark660" class="s208">NVIDIA Data Loading Library (DALI) , </a><a href="#bookmark660">tf.image built-in augmentations</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark719" class="s208">NVIDIA GPU Persistence Daemon, </a>Enable GPU Persistence <a href="#bookmark734" class="s208">NVIDIA Graphics Processing Units (GPUs), </a><a href="#bookmark734">Installation</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1683" class="s208">NVIDIA Jetson Nano, </a><a href="#bookmark1709" class="a">NVIDIA Jetson Nano</a><a href="#bookmark1709" class="s208">, </a><a href="#bookmark1709">Port to NVIDIA Jetson Nano</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark604" class="s208">nvidia-smi (NVIDIA System Management Interface), </a><a href="#bookmark604" class="a">nvidia- smi</a><a href="#bookmark744" class="s208">, </a><a href="#bookmark604" class="a">T</a><a href="#bookmark604">raining</a></p><p class="s3" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">O</p><p style="padding-top: 8pt;padding-left: 22pt;text-indent: -15pt;line-height: 157%;text-align: left;"><a href="#bookmark1344" class="s208">object classification (see also food classifier apps) building iOS app, </a><a href="#bookmark1344">Building the iOS App</a></p><p style="padding-top: 8pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1407" class="s208">building real-time apps for, </a><a href="#bookmark1419" class="a">Building a Real-Time Object </a><a href="#bookmark1407" class="a">Recognition App</a><a href="#bookmark1407" class="s208">-</a><a href="#bookmark1419" class="a">Building a Real-Time Object Recognition </a><a href="#bookmark1419">App</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1185" class="s208">challenges of on mobile devices, </a><a href="#bookmark1393" class="a">Real-Time Object </a><a href="#bookmark1185" class="a">Classification on iOS with Core ML</a><a href="#bookmark1185" class="s208">, </a><a href="#bookmark1393" class="a">Shazam for </a><a href="#bookmark1393">Food: Developing Android Apps with TensorFlow Lite and ML Kit</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1302" class="s208">collecting data, </a><a href="#bookmark1315" class="a">Collecting Data</a><a href="#bookmark1315" class="s208">-</a><a href="#bookmark1315">Approach 3: Web Scraper Using Bing Image Search API</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1426" class="s208">in ML Kit, </a><a href="#bookmark1426">Object Classification in ML Kit</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1341" class="s208">model conversion using Core ML, </a><a href="#bookmark1341">Model Conversion Using Core ML Tools</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1317" class="s208">model training, </a><a href="#bookmark1339" class="a">Training Our Model</a><a href="#bookmark1339" class="s208">-</a><a href="#bookmark1339">Approach 3: Fine Tuning Using Keras</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1299" class="s208">overview of steps, </a><a href="#bookmark1299">Not Hotdog on iOS with Core ML and Create ML</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1216" class="s208">real-time apps for, </a><a href="#bookmark1216" class="a">Building a Real-Time Object Recognition App</a><a href="#bookmark1224" class="s208">-</a><a href="#bookmark1216" class="a">Building </a><a href="#bookmark1216">a Real-Time Object Recognition App</a></p><p class="s3" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">object detection</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1558" class="s208">approaches to, </a><a href="#bookmark1558">Approaches to Object Detection</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1575" class="s208">building custom detectors without code, </a><a href="#bookmark1583" class="a">Building a Custom </a><a href="#bookmark1575" class="a">Detector Without Any Code</a><a href="#bookmark1575" class="s208">-</a><a href="#bookmark1583" class="a">Building a Custom Detector </a><a href="#bookmark1583">Without Any Code</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1629" class="s208">case studies, </a>Case Studies<a href="#bookmark1643" class="s208">-</a>Autonomous Cars <a href="#bookmark1585" class="s208">evolution of, </a>The Evolution of Object Detection <a href="#bookmark1625" class="s208">image segmentation, </a><a href="#bookmark1625">Image Segmentation</a></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark1619" class="s208">inspecting and training models, </a>Inspecting the Model<span style=" color: #000;">-</span></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1621">Training</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1593" class="s208">key terms in, </a><a href="#bookmark1602" class="a">Key Terms in Object Detection</a><a href="#bookmark1602" class="s208">-</a><a href="#bookmark1602">Non-Maximum Suppression</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1623" class="s208">model conversion, </a><a href="#bookmark1623">Model Conversion</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1589" class="s208">performance considerations, </a><a href="#bookmark1589">Performance Considerations</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1561" class="s208">prebuilt cloud-based APIs, </a><a href="#bookmark1562" class="a">Invoking Prebuilt Cloud-Based </a><a href="#bookmark1561" class="a">Object Detection APIs</a><a href="#bookmark1561" class="s208">-</a><a href="#bookmark1562" class="a">Invoking Prebuilt Cloud-Based </a><a href="#bookmark1562">Object Detection APIs</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1565" class="s208">reusing pretrained models, </a>Reusing a Pretrained Model<a href="#bookmark1573" class="s208">- </a><a href="#bookmark1573">Deploying to a Device</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1605" class="s208">TensorFlow Object Detection API, </a><a href="#bookmark1605" class="a">Using the TensorFlow Object Detection API to Build Custom Models</a><a href="#bookmark1605" class="s208">-</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark1617">Preprocessing the Data</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1543" class="s208">types of computer-vision tasks, </a><a href="#bookmark1543" class="a">Types of Computer-Vision Tasks</a><a href="#bookmark1558" class="s208">-</a><a href="#bookmark1543" class="a">Approaches </a><a href="#bookmark1543">to Object Detection</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1550" class="s208">object localization, </a>Detection <a href="#bookmark1553" class="s208">object segmentation, </a><a href="#bookmark1553">Segmentation</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark900" class="s208">OCR APIs, </a>Effect of Compression on OCR APIs <a href="#bookmark913" class="s208">OmniEarth, </a><a href="#bookmark913">OmniEarth</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark407" class="s208">one shot learning, </a><a href="#bookmark407">Siamese Networks for One-Shot Face Verification</a></p><p class="s3" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">online resources</p><p class="s2" style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark24" class="s208">code examples, </a>Using Code Examples <a href="#bookmark27" class="s208">for this book, </a><a href="#bookmark27">How to Contact Us</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark1077" class="s208">ONNX.js, </a><a href="#bookmark1077">ONNX.js</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark768" class="s208">Open Images V4 , </a><a href="#bookmark768">Data</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark122" class="s208">Open Neural Network Exchange (ONNX), </a><a href="#bookmark122" class="a">A continuously evolving landscape</a><a href="#bookmark753" class="s208">, </a><a href="#bookmark122" class="a">Model</a><a href="#bookmark1077" class="s208">, </a><a href="#bookmark1077">ONNX.js</a></p><p class="s3" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">optimizations (TensorFlow Lite)</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1455" class="s208">model optimization toolkit, </a><a href="#bookmark1455">TensorFlow Model Optimization Toolkit</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1453" class="s208">quantizing, </a><a href="#bookmark1453">Quantizing with TensorFlow Lite Converter</a></p><p class="s3" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;">optimizations (TensorFlow) (see also TensorFlow performance checklist)</p><p class="s2" style="padding-top: 5pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark666" class="s208">Automatic Mixed Precision, </a>Use Automatic Mixed Precision <a href="#bookmark692" class="s208">better hardware, </a><a href="#bookmark692">Use Better Hardware</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark694" class="s208">distributed training, </a><a href="#bookmark694">Distribute Training</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark677" class="s208">eager execution and tf.function, </a><a href="#bookmark677">Use tf.function</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark647" class="s208">experimental optimizations, </a><a href="#bookmark647">Turn on Experimental Optimizations</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark697" class="s208">industry benchmarks, </a>Examine Industry Benchmarks <a href="#bookmark668" class="s208">larger batch size, </a><a href="#bookmark668">Use Larger Batch Size</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark671" class="s208">multiples of eight, </a><a href="#bookmark671">Use Multiples of Eight</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark687" class="s208">optimized hardware stacks, </a><a href="#bookmark687">Install an Optimized Stack for the Hardware</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark689" class="s208">optimizing parallel CPU threads, </a><a href="#bookmark689">Optimize the Number of Parallel CPU Threads</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark679" class="s208">overtraining and generalization, </a><a href="#bookmark679">Overtrain, and Then Generalize</a></p><p class="s3" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">optimizers</p><p class="s2" style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark521" class="s208">effect on accuracy, </a>Effect of Optimizers <a href="#bookmark272" class="s208">role of, </a><a href="#bookmark272">Set Training Parameters</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark643" class="s208">ordering, nondeterministic, </a><a href="#bookmark643">Enable Nondeterministic Ordering</a></p><p class="s2" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark261" class="s208">overfitting, </a>Data Augmentation<a href="#bookmark1800" class="s208">, </a><a href="#bookmark1800">Callbacks</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark496" class="s208">overtraining, </a>Early Stopping<a href="#bookmark679" class="s208">, </a><a href="#bookmark679">Overtrain, and Then Generalize</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark783" class="s208">O’Reilly’s Online Learning platform, </a><a href="#bookmark783">Education and Exploration</a></p><p class="s3" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">P</p><p style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark145" class="s208">p-hacking, </a><a href="#bookmark145">Reproducibility</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark751" class="s208">PapersWithCode.com, </a>Model<a href="#bookmark785" class="s208">, </a><a href="#bookmark785">Education and Exploration</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark638" class="s208">parallel processing, </a><a href="#bookmark689" class="a">Parallelize CPU Processing</a><a href="#bookmark689" class="s208">, </a><a href="#bookmark689">Optimize the Number of Parallel CPU Threads</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark366" class="s208">PCA (Principle Component Analysis), </a><a href="#bookmark366">Reducing Feature-</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark366">Length with PCA</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark77" class="s208">perceptrons, </a>Exciting Beginnings<a href="#bookmark81" class="s208">, </a>The Cold and Dark Days<span style=" color: #000;">,</span></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1984">Perceptron</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark891" class="s208">performance tuning, </a>Performance Tuning for Cloud APIs<a href="#bookmark902" class="s208">- </a>Effect of Resizing on OCR APIs <span style=" color: #000;">(see also TensorFlow performance checklist)</span></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1188" class="s208">Personally Identifiable Information (PII), </a><a href="#bookmark1188">Real-Time Object Classification on iOS with Core ML</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark915" class="s208">Photobucket , </a><a href="#bookmark915">Photobucket</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark864" class="s208">Pilot Parliaments Benchmark (PPB), </a>Bias <a href="#bookmark414" class="s208">Pinterest, </a><a href="#bookmark414">Pinterest</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;">pipelines</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark252" class="s208">building in custom classifiers, </a><a href="#bookmark252">Build the Data Pipeline</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark501" class="s208">end-to-end learning example pipeline, </a><a href="#bookmark501" class="a">End-to-End Deep Learning Example Pipeline</a><a href="#bookmark505" class="s208">-</a><a href="#bookmark501" class="a">Basic </a><a href="#bookmark505" class="a">Custom Network </a><a href="#bookmark505">Pipeline</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1296" class="s208">end-to-end object recognition example, </a><a href="#bookmark1296" class="a">Not Hotdog on iOS with Core ML and Create ML</a><a href="#bookmark1349" class="s208">-</a><a href="#bookmark1349">Summary</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1020" class="s208">in KubeFlow, </a><a href="#bookmark1020">Pipelines</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark633" class="s208">reading data in TensorFlow, </a><a href="#bookmark633">Use tf.data</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark469" class="s208">ready-to-use datasets for, </a><a href="#bookmark469">TensorFlow Datasets</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark171" class="s208">simple pipeline for image classification, </a><a href="#bookmark171">Predicting an Image’s Category</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark612" class="s208">tuning TensorFlow performance, </a><a href="#bookmark612" class="a">How to Use This Checklist</a><a href="#bookmark720" class="s208">-</a><a href="#bookmark612" class="a">Enable </a><a href="#bookmark612">GPU Persistence</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1112" class="s208">pix2pix, </a>pix2pix<a href="#bookmark1121" class="s208">-</a><a href="#bookmark1121">pix2pix</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1490" class="s208">Pixel 3 phones, </a>Portrait Mode on Pixel 3 Phones <a href="#bookmark174" class="s208">pixels, </a>Predicting an Image’s Category <a href="#bookmark750" class="s208">PlotNeuralNet, </a><a href="#bookmark750">Model</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1922" class="s208">policy-based reinforcement learning, </a>Policy based <a href="#bookmark364" class="s208">pooling operations, </a>Length of Feature Vectors<a href="#bookmark2002" class="s208">, </a>Pooling <a href="#bookmark1490" class="s208">portrait mode, </a>Portrait Mode on Pixel 3 Phones <a href="#bookmark1109" class="s208">PoseNet, </a>PoseNet<a href="#bookmark1722" class="s208">, </a><a href="#bookmark1722">Squatting for Metro Tickets</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;">pretrained models</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark753" class="s208">adapting to new frameworks, </a><a href="#bookmark753">Model</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark230" class="s208">adapting to new tasks, </a><a href="#bookmark230" class="a">Adapting Pretrained Models to New Tasks</a><a href="#bookmark244" class="s208">-</a><a href="#bookmark230" class="a">How </a><a href="#bookmark230">Much to Fine Tune</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1213" class="s208">from Apple Machine Learning website, </a><a href="#bookmark1213">ML Performance Primitives</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark195" class="s208">in Keras, </a>Model Zoos <a href="#bookmark751" class="s208">locating, </a><a href="#bookmark751">Model</a></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark1565" class="s208">reusing for object detection, </a>Reusing a Pretrained Model<span style=" color: #000;">-</span></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1573">Deploying to a Device</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1088" class="s208">in TensorFlow.js, </a><a href="#bookmark1088">Running Pretrained Models Using TensorFlow.js</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark366" class="s208">principal components, </a><a href="#bookmark366">Reducing Feature-Length with PCA</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark149" class="s208">privacy, </a><a href="#bookmark1188" class="a">Privacy</a><a href="#bookmark778" class="s208">, </a><a href="#bookmark1188" class="a">Privacy</a><a href="#bookmark1188" class="s208">, </a><a href="#bookmark1188">Real-Time Object Classification on iOS with Core ML</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark608" class="s208">profiling, </a>TensorFlow Profiler + TensorBoard <a href="#bookmark741" class="s208">progress bars, </a><a href="#bookmark741">Training</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark683" class="s208">progressive augmentation, </a>Use progressive augmentation <a href="#bookmark685" class="s208">progressive resizing, </a>Use progressive resizing <a href="#bookmark681" class="s208">progressive sampling, </a><a href="#bookmark681">Use progressive sampling</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark837" class="s208">Project Oxford, </a><a href="#bookmark837">Microsoft Cognitive Services</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: justify;"><a href="#bookmark1889" class="s208">proximal policy optimization (PPO) algorithm, </a><a href="#bookmark1928" class="a">Configure the </a><a href="#bookmark1889" class="a">simulation environment</a><a href="#bookmark1889" class="s208">, </a><a href="#bookmark1928" class="a">Reinforcement Learning Algorithm </a><a href="#bookmark1928">in AWS DeepRacer</a></p><p class="s2" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark714" class="s208">pruning, </a>Prune the Model <a href="#bookmark1686" class="s208">PYNQ platform, </a>FPGA + PYNQ <a href="#bookmark121" class="s208">PyTorch, </a><a href="#bookmark121">PyTorch</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 15pt;text-align: left;">Q</p><p style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark774" class="s208">Qri, </a><a href="#bookmark774">Data</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark710" class="s208">quantization techniques, </a><a href="#bookmark1260" class="a">Quantize the Model</a><a href="#bookmark1260" class="s208">, </a><a href="#bookmark1260" class="a">Use Quantization</a><a href="#bookmark1453" class="s208">, </a><a href="#bookmark1260" class="a">Quantizing </a><a href="#bookmark1453" class="a">with TensorFlow Lite </a><a href="#bookmark1453">Converter</a></p><p class="s2" style="padding-top: 1pt;padding-left: 6pt;text-indent: 0pt;line-height: 34pt;text-align: left;"><a href="#bookmark774" class="s208">Quilt, </a>Data <span style=" color: #000;">R</span></p><p style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark498" class="s208">randomization, </a><a href="#bookmark498">Reproducible Experiments</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 36pt;text-align: left;"><a href="#bookmark1673" class="s208">Raspberry Pi, </a>Raspberry Pi<a href="#bookmark1702" class="s208">, </a>Hands-On with the Raspberry Pi <a href="#bookmark1779" class="s208">region of interest (ROI), </a>Identifying the Region of Interest <span style=" color: #000;">reinforcement learning</span></p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1927" class="s208">AWS DeepRacer algorithm, </a><a href="#bookmark1927">Reinforcement Learning Algorithm in AWS DeepRacer</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1939" class="s208">AWS DeepRacer car, </a>Racing the AWS DeepRacer Car<a href="#bookmark1949" class="s208">- </a><a href="#bookmark1949">Sim2Real transfer</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1875" class="s208">AWS DeepRacer example, </a><a href="#bookmark1907" class="a">Practical Deep Reinforcement </a><a href="#bookmark1875" class="a">Learning with DeepRacer</a><a href="#bookmark1875" class="s208">-</a><a href="#bookmark1907" class="a">Step 4: Evaluating the </a><a href="#bookmark1907">Performance of the Model</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1862" class="s208">crux of, </a><a href="#bookmark1862">Building an Autonomous Car in Under an Hour: Reinforcement Learning with AWS DeepRacer</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1816" class="s208">Distributed Deep Reinforcement Learning for Autonomous Driving tutorial , </a><a href="#bookmark1816">Reinforcement Learning</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1952" class="s208">further exploration, </a>Further Exploration<a href="#bookmark1964" class="s208">-</a><a href="#bookmark1964">Roborace</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1933" class="s208">improving learning models, </a><a href="#bookmark1939" class="a">Step 5: Improving </a><a href="#bookmark1933" class="a">Reinforcement Learning Models</a><a href="#bookmark1933" class="s208">-</a><a href="#bookmark1939" class="a">Racing the A</a><a href="#bookmark1939">WS DeepRacer Car</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1909" class="s208">inner workings of, </a><a href="#bookmark1909">Reinforcement Learning in Action</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1864" class="s208">introduction to, </a><a href="#bookmark1864">A Brief Introduction to Reinforcement Learning</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1869" class="s208">learning with autonomous cars, </a><a href="#bookmark1873" class="a">Why Learn Reinforcement </a><a href="#bookmark1869" class="a">Learning with an Autonomous Car?</a><a href="#bookmark1869" class="s208">-</a><a href="#bookmark1873" class="a">Why Learn </a><a href="#bookmark1873">Reinforcement Learning with an Autonomous Car?</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1931" class="s208">summary of, </a><a href="#bookmark1931">Deep Reinforcement Learning Summary with DeepRacer as an Example</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1875" class="s208">terminology used in, </a><a href="#bookmark1875">Practical Deep Reinforcement Learning with DeepRacer</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1918" class="s208">theory of, </a><a href="#bookmark1918">Reinforcement Learning Theory</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1878" class="s208">replay buffer, </a><a href="#bookmark1878">Practical Deep Reinforcement Learning with DeepRacer</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark140" class="s208">reporting bias, </a><a href="#bookmark140">Bias</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark145" class="s208">reproducibility, </a>Reproducibility<a href="#bookmark498" class="s208">, </a>Reproducible Experiments <a href="#bookmark786" class="s208">ResearchCode, </a><a href="#bookmark786">Education and Exploration</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;">resizing</p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark527" class="s208">effect on accuracy, </a><a href="#bookmark527">Effect of Resizing</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark892" class="s208">images for performance tuning, </a><a href="#bookmark892">Performance Tuning for Cloud APIs</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark746" class="s208">ResNet, </a><a href="#bookmark746">Training</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark176" class="s208">ResNet-50, </a><a href="#bookmark179" class="a">Predicting an Image’s Category</a><a href="#bookmark179" class="s208">, </a><a href="#bookmark179">Predicting an Image’s Category</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 36pt;text-align: left;"><a href="#bookmark964" class="s208">REST APIs, </a>Making a REST API with Flask <span style=" color: #000;">reverse image search</span></p><p class="s2" style="padding-top: 5pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark409" class="s208">case studies, </a>Case Studies<a href="#bookmark428" class="s208">-</a><a href="#bookmark428">Image Captioning</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark333" class="s208">feature extraction, </a>Feature Extraction<a href="#bookmark336" class="s208">-</a><a href="#bookmark336">Feature Extraction</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark394" class="s208">fine tuning for improved accuracy, </a><a href="#bookmark401" class="a">Improving Accuracy </a><a href="#bookmark394" class="a">with Fine Tuning</a><a href="#bookmark394" class="s208">-</a><a href="#bookmark401" class="a">Fine Tuning Without Fully Connected </a><a href="#bookmark401">Layers</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark327" class="s208">image similarity, </a>Image Similarity<a href="#bookmark331" class="s208">-</a><a href="#bookmark331">Image Similarity</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark358" class="s208">improving search speed, </a><a href="#bookmark358" class="a">Improving the Speed of Similarity Search</a><a href="#bookmark372" class="s208">-</a><a href="#bookmark358" class="a">Reducing </a><a href="#bookmark358">Feature-Length with PCA</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark324" class="s208">introduction to, </a><a href="#bookmark324">Building a Reverse Image Search Engine:</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark324">Understanding Embeddings</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark374" class="s208">scaling with nearest-neighbor approach, </a><a href="#bookmark374" class="a">Scaling Similarity Search with Approximate Nearest Neighbors</a><a href="#bookmark392" class="s208">-</a><a href="#bookmark392">Faiss</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark403" class="s208">Siamese networks for, </a><a href="#bookmark403">Siamese Networks for One-Shot Face Verification</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark338" class="s208">similarity search, </a>Similarity Search<a href="#bookmark345" class="s208">-</a><a href="#bookmark345">Similarity Search</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark347" class="s208">visualizing image clusters, </a><a href="#bookmark347" class="a">Visualizing Image Clusters with t-SNE</a><a href="#bookmark355" class="s208">-</a><a href="#bookmark347" class="a">V</a><a href="#bookmark347">isualizing Image Clusters with t-SNE</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1879" class="s208">reward function, </a><a href="#bookmark1898" class="a">Practical Deep Reinforcement Learning with </a><a href="#bookmark1879" class="a">DeepRacer</a><a href="#bookmark1894" class="s208">, </a><a href="#bookmark1879" class="a">Configure reward function</a><a href="#bookmark1879" class="s208">-</a><a href="#bookmark1915" class="a">Configure reward </a><a href="#bookmark1898" class="a">function</a><a href="#bookmark1898" class="s208">, </a><a href="#bookmark1915" class="a">How Does a Reinforcement Learning System </a><a href="#bookmark1915">Learn?</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1963" class="s208">Roborace, </a>Roborace <a href="#bookmark147" class="s208">robustness, </a>Robustness <a href="#bookmark736" class="s208">ROCm stack, </a><a href="#bookmark736">Installation</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark271" class="s208">root-mean-square error (RMSE), </a>Set Training Parameters <a href="#bookmark643" class="s208">round-robin order, </a>Enable Nondeterministic Ordering <a href="#bookmark787" class="s208">Runway ML, </a><a href="#bookmark787">Education and Exploration</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 15pt;text-align: left;">S</p><p style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1865" class="s208">SageMaker reinforcement learning, </a><a href="#bookmark1865">A Brief Introduction to Reinforcement Learning</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark773" class="s208">SamaSource, </a>Data <a href="#bookmark977" class="s208">scalability, </a><a href="#bookmark977">Scalability</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark694" class="s208">scaling horizontally, </a>Distribute Training <a href="#bookmark758" class="s208">ScrapeStorm.com, </a><a href="#bookmark758">Data</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark761" class="s208">Scrapy.org, </a><a href="#bookmark761">Data</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1271" class="s208">Seeing AI, </a>Seeing AI<a href="#bookmark1639" class="s208">, </a>Face Detection in Seeing AI <a href="#bookmark1553" class="s208">segmentation, </a><a href="#bookmark1553">Segmentation</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark135" class="s208">selection bias, </a><a href="#bookmark135">Bias</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark87" class="s208">self-driving cars, </a>A Glimmer of Hope<a href="#bookmark1642" class="s208">, </a>Autonomous Cars <span style=" color: #000;">(see also autonomous driving; reinforcement learning)</span></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1482" class="s208">self-evolving model, </a>The Self-Evolving Model <a href="#bookmark1554" class="s208">semantic segmentation, </a>Semantic segmentation <a href="#bookmark1134" class="s208">Semi-Conductor, </a><a href="#bookmark1134">Semi-Conductor</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1314" class="s208">semi-supervised learning, </a><a href="#bookmark1314">Approach 3: Web Scraper Using Bing Image Search API</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1813" class="s208">sequential data, </a><a href="#bookmark1813">Training on Sequential Data</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1391" class="s208">Shazam for Food app, </a><a href="#bookmark1391">Shazam for Food: Developing Android Apps with TensorFlow Lite and ML Kit</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark403" class="s208">Siamese networks, </a><a href="#bookmark403">Siamese Networks for One-Shot Face Verification</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 36pt;text-align: left;"><a href="#bookmark1948" class="s208">Sim2Real transfer, </a>Sim2Real transfer <span style=" color: #000;">similarity search</span></p><p style="padding-top: 5pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark338" class="s208">finding nearest neighbors, </a><a href="#bookmark345" class="a">Similarity Search</a><a href="#bookmark345" class="s208">-</a><a href="#bookmark345">Similarity Search</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark358" class="s208">improving speed of, </a><a href="#bookmark358" class="a">Improving the Speed of Similarity Search</a><a href="#bookmark372" class="s208">-</a><a href="#bookmark358" class="a">Reducing </a><a href="#bookmark358">Feature-Length with PCA</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark374" class="s208">scaling, </a><a href="#bookmark374" class="a">Scaling Similarity Search with Approximate Nearest Neighbors</a><a href="#bookmark392" class="s208">-</a><a href="#bookmark392">Faiss</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1765" class="s208">simulation, </a><a href="#bookmark1881" class="a">Deep Learning, Autonomous Driving, and the </a><a href="#bookmark1765" class="a">Data Problem</a><a href="#bookmark1765" class="s208">, </a><a href="#bookmark1881" class="a">Practical Deep Reinforcement Learning </a><a href="#bookmark1881">with</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1881" class="a">DeepRacer</a><a href="#bookmark1948" class="s208">, </a><a href="#bookmark1881" class="a">Sim2Real </a><a href="#bookmark1881">transfer</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1871" class="s208">simulation-to-real (sim2real) problem, </a><a href="#bookmark1881" class="a">Why Learn </a><a href="#bookmark1871" class="a">Reinforcement </a><a href="#bookmark1881" class="a">Learning with an Autonomous Car?</a><a href="#bookmark1881" class="s208">, </a><a href="#bookmark1948" class="a">Practical </a><a href="#bookmark1881" class="a">Deep Reinforcement Learning with DeepRacer</a><a href="#bookmark1881" class="s208">, </a><a href="#bookmark1948" class="a">Sim2Real </a><a href="#bookmark1948">transfer</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1631" class="s208">smart refrigerators, </a>Smart Refrigerator <a href="#bookmark277" class="s208">softmax activation function, </a>Start Training <a href="#bookmark785" class="s208">SOTAWHAT tool, </a><a href="#bookmark785">Education and Exploration</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1493" class="s208">speaker recognition, </a>Speaker Recognition by Alibaba <a href="#bookmark420" class="s208">Spotify, </a><a href="#bookmark420">Spotify</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: justify;"><a href="#bookmark1721" class="s208">squat-tracker app, </a>Squatting for Metro Tickets <a href="#bookmark1566" class="s208">SSD MobileNetV2, </a>Reusing a Pretrained Model <a href="#bookmark917" class="s208">Staples, </a><a href="#bookmark917">Staples</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: justify;"><a href="#bookmark1899" class="s208">stop conditions, </a><a href="#bookmark1899">Configure stop conditions</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1475" class="s208">success, measuring, </a><a href="#bookmark1475">How Do I Measure the Success of My Model?</a></p><p class="s2" style="padding-top: 1pt;padding-left: 6pt;text-indent: 0pt;line-height: 34pt;text-align: left;"><a href="#bookmark381" class="s208">synthetic datasets, </a>Which Library Should I Use?<a href="#bookmark775" class="s208">, </a>Data <span style=" color: #000;">T</span></p><ol id="l61"><li><p class="s2" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark347" class="s208">SNE algorithm, </a>Visualizing Image Clusters with t-SNE<a href="#bookmark355" class="s208">-</a><a href="#bookmark355" class="a"> Visualizing Image Clusters with </a><a href="#bookmark355">t-SNE</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1094" class="s208">Teachable Machine, </a>Training in the Browser <a href="#bookmark767" class="s208">Tencent ML Images, </a><a href="#bookmark767">Data</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark471" class="s208">TensorBoard, </a><a href="#bookmark608" class="a">TensorBoard</a><a href="#bookmark476" class="s208">-</a><a href="#bookmark608" class="a">What-If Tool</a><a href="#bookmark608" class="s208">, </a><a href="#bookmark608">TensorFlow Profiler</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark608">+ TensorBoard</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">TensorFlow</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark736" class="s208">AMD GPUs and, </a><a href="#bookmark736">Installation</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark124" class="s208">benefits of, </a>A continuously evolving landscape <a href="#bookmark1230" class="s208">conversion to Core ML, </a>Conversion from TensorFlow <a href="#bookmark747" class="s208">debugging scripts, </a><a href="#bookmark747">Training</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark119" class="s208">history of, </a><a href="#bookmark119">TensorFlow</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark735" class="s208">installation on Windows PCs, </a>Installation <a href="#bookmark743" class="s208">testing for available GPUs, </a><a href="#bookmark743">Training</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark469" class="s208">TensorFlow Datasets, </a><a href="#bookmark627" class="a">TensorFlow Datasets</a><a href="#bookmark627" class="s208">, </a><a href="#bookmark627" class="a">Use TensorFlow Datasets</a><a href="#bookmark765" class="s208">, </a><a href="#bookmark765">Data</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark747" class="s208">TensorFlow Debugger (tfdbg), </a><a href="#bookmark747">Training</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark356" class="s208">TensorFlow Embedding projector, </a><a href="#bookmark356">Visualizing Image Clusters with t-SNE</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark778" class="s208">TensorFlow Encrypted, </a><a href="#bookmark778">Privacy</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1012" class="s208">TensorFlow Extended (TFX), </a>TensorFlow Serving <a href="#bookmark752" class="s208">TensorFlow Hub (tfhub.dev), </a><a href="#bookmark752">Model</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;">TensorFlow Lite</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1401" class="s208">architecture, </a><a href="#bookmark1401">TensorFlow Lite Architecture</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1407" class="s208">building real-time object recognition apps, </a><a href="#bookmark1419" class="a">Building a Real- </a><a href="#bookmark1407" class="a">Time Object Recognition App</a><a href="#bookmark1407" class="s208">-</a><a href="#bookmark1419" class="a">Building a Real-Time Object </a><a href="#bookmark1419">Recognition App</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1200" class="s208">history of, </a><a href="#bookmark1200">TensorFlow Lite</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1405" class="s208">model conversion to, </a><a href="#bookmark1405">Model Conversion to TensorFlow Lite</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1455" class="s208">model optimization toolkit, </a><a href="#bookmark1455">TensorFlow Model Optimization Toolkit</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1449" class="s208">on iOS, </a><a href="#bookmark1449">TensorFlow Lite on iOS</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1399" class="s208">overview of, </a>An Overview of TensorFlow Lite <a href="#bookmark1451" class="s208">performance optimizations, </a><a href="#bookmark1451">Performance Optimizations</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1420" class="s208">sample apps in repository, </a><a href="#bookmark1420">Building a Real-Time Object Recognition App</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1423" class="s208">using models with ML Kit, </a><a href="#bookmark1428" class="a">ML Kit + Firebase</a><a href="#bookmark1428" class="s208">, </a><a href="#bookmark1428">Custom Models in ML Kit</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1407" class="s208">TensorFlow models repository, </a><a href="#bookmark1407" class="a">Building a Real-Time Object Recognition App</a><a href="#bookmark1568" class="s208">, </a><a href="#bookmark1407" class="a">Obtaining </a><a href="#bookmark1407">the Model</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: -15pt;line-height: 157%;text-align: right;"><a href="#bookmark1607" class="s208">TensorFlow Object Detection API data collection, </a><a href="#bookmark1607" class="a">Data </a><a href="#bookmark1607">Collection</a></p><p style="padding-top: 8pt;text-indent: 0pt;text-align: right;"><a href="#bookmark1611" class="s208">data labeling, </a><a href="#bookmark1611" class="a">Labeling the </a><a href="#bookmark1611">Data</a></p><p class="s2" style="padding-left: 6pt;text-indent: 15pt;line-height: 36pt;text-align: left;"><a href="#bookmark1616" class="s208">data preprocessing, </a>Preprocessing the Data <span style=" color: #000;">TensorFlow performance checklist</span></p><p class="s2" style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark657" class="s208">data augmentation, </a>Data Augmentation<a href="#bookmark662" class="s208">-</a><a href="#bookmark662">NVIDIA DALI</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark621" class="s208">data preparation, </a><a href="#bookmark628" class="a">Data Preparation</a><a href="#bookmark628" class="s208">-</a><a href="#bookmark628">Use TensorFlow Datasets</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark630" class="s208">data reading, </a>Data Reading<a href="#bookmark655" class="s208">-</a>Autotune Parameter Values <a href="#bookmark612" class="s208">effective use of, </a><a href="#bookmark612">How to Use This Checklist</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark601" class="s208">GPU starvation, </a><a href="#bookmark610" class="a">GPU Starvation</a><a href="#bookmark610" class="s208">-</a><a href="#bookmark610">TensorFlow Profiler +</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark610">TensorBoard</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark704" class="s208">inference, </a>Inference<a href="#bookmark720" class="s208">-</a>Enable GPU Persistence <a href="#bookmark615" class="s208">overview of, </a><a href="#bookmark615">Data Preparation</a></p><p class="s2" style="padding-left: 6pt;text-indent: 15pt;line-height: 209%;text-align: left;"><a href="#bookmark664" class="s208">training, </a>Training<a href="#bookmark702" class="s208">-</a>Examine Industry Benchmarks <a href="#bookmark1083" class="s208">TensorFlow Playground, </a>TensorFlow.js <a href="#bookmark1012" class="s208">TensorFlow Serving, </a><a href="#bookmark1012">TensorFlow Serving</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;">TensorFlow.js</p><p class="s2" style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1085" class="s208">architecture, </a>TensorFlow.js Architecture <a href="#bookmark1082" class="s208">introduction to, </a><a href="#bookmark1082">TensorFlow.js</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1088" class="s208">running pretrained models, </a><a href="#bookmark1088">Running Pretrained Models Using TensorFlow.js</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1137" class="s208">TensorSpace, </a><a href="#bookmark1137">TensorSpace</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1230" class="s208">tf-coreml, </a>Conversion from TensorFlow <a href="#bookmark464" class="s208">tf-explain, </a>Tools of the Trade<a href="#bookmark485" class="s208">, </a><a href="#bookmark485">tf-explain</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark632" class="s208">tf.data, </a>Use tf.data<a href="#bookmark643" class="s208">, </a>Enable Nondeterministic Ordering <a href="#bookmark654" class="s208">tf.data.experimental.AUTOTUNE, </a><a href="#bookmark654">Autotune Parameter Values</a></p><p style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark647" class="s208">tf.data.experimental.OptimizationOptions, </a><a href="#bookmark647">Turn on Experimental Optimizations</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark677" class="s208">tf.function, </a><a href="#bookmark677">Use tf.function</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark659" class="s208">tf.image, </a>tf.image built-in augmentations <a href="#bookmark465" class="s208">tf.keras, </a>Tools of the Trade <a href="#bookmark743" class="s208">tf.test.is_gpu_available(), </a><a href="#bookmark743">Training</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark608" class="s208">tfprof (TensorFlow profiler), </a><a href="#bookmark608">TensorFlow Profiler + TensorBoard</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark623" class="s208">TFRecords, </a>Store as TFRecords<a href="#bookmark1616" class="s208">, </a>Preprocessing the Data <a href="#bookmark385" class="s208">timeit command, </a><a href="#bookmark385">Brute Force</a></p><p class="s2" style="padding-left: 22pt;text-indent: -15pt;line-height: 157%;text-align: left;"><a href="#bookmark755" class="s208">tools, tips, and tricks data, </a>Data<a href="#bookmark776" class="s208">-</a><a href="#bookmark776">Data</a></p><p class="s2" style="padding-top: 8pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark780" class="s208">education and exploration, </a>Education and Exploration<span style=" color: #000;">-</span></p><p class="s2" style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;">Education and Exploration <a href="#bookmark733" class="s208">installation, </a>Installation<a href="#bookmark738" class="s208">-</a>Installation <a href="#bookmark749" class="s208">models, </a><a href="#bookmark749">Model</a></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark778" class="s208">privacy, </a>Privacy <a href="#bookmark740" class="s208">training, </a><a href="#bookmark740">Training</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark270" class="s208">training parameters, </a><a href="#bookmark270">Set Training Parameters</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark697" class="s208">Transaction Processing Council (TPC) benchmark, </a><a href="#bookmark697">Examine Industry Benchmarks</a></p><p class="s3" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">transfer learning</p><p style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark753" class="s208">adapting pretrained models to new networks, </a><a href="#bookmark753">Model</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark230" class="s208">adapting pretrained models to new tasks, </a><a href="#bookmark230" class="a">Adapting Pretrained Models to New Tasks</a><a href="#bookmark244" class="s208">-</a><a href="#bookmark230" class="a">How </a><a href="#bookmark244" class="a">Much to Fine </a><a href="#bookmark244">Tune</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark503" class="s208">basic pipeline for, </a><a href="#bookmark503">Basic Transfer Learning Pipeline</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark246" class="s208">building custom classifiers using, </a><a href="#bookmark290" class="a">Building a Custom </a><a href="#bookmark246" class="a">Classifier in Keras with Transfer Learning</a><a href="#bookmark246" class="s208">-</a><a href="#bookmark290" class="a">Analyzing </a><a href="#bookmark290">the Results</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1335" class="s208">Create ML, </a>Approach 2: Use Create ML <a href="#bookmark107" class="s208">definition of, </a><a href="#bookmark107">Datasets</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark507" class="s208">effect of hyperparmeters on accuracy, </a><a href="#bookmark532" class="a">How </a><a href="#bookmark507" class="a">Hyperparameters Affect Accuracy</a><a href="#bookmark507" class="s208">-</a><a href="#bookmark532" class="a">Effect of </a><a href="#bookmark532">Change in Aspect Ratio on Transfer Learning</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark240" class="s208">fine tuning, </a>Fine Tuning<a href="#bookmark244" class="s208">-</a><a href="#bookmark244">How Much to Fine Tune</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark123" class="s208">GUI-based model training tools, </a><a href="#bookmark123">A continuously evolving landscape</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark237" class="s208">overview of, </a><a href="#bookmark237">Transfer Learning</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark509" class="s208">versus training from scratch, </a><a href="#bookmark509">Transfer Learning Versus Training from Scratch</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark406" class="s208">triplet loss function, </a><a href="#bookmark406">Siamese Networks for One-Shot Face Verification</a></p><p class="s3" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">U</p><p style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark908" class="s208">Uber, </a><a href="#bookmark908">Uber</a></p><p class="s2" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark734" class="s208">Ubuntu, </a>Installation <a href="#bookmark261" class="s208">underfitting, </a><a href="#bookmark261">Data Augmentation</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark348" class="s208">Uniform Manifold Approximation and Projection (UMAP), </a><a href="#bookmark348">Visualizing Image Clusters with t-SNE</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark86" class="s208">Universal Approximation Theorem, </a><a href="#bookmark86">A Glimmer of Hope</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1479" class="s208">updates, distributing, </a><a href="#bookmark1479">How Do I Update the Model on My Users’ Phones?</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1680" class="s208">USB accelerators, </a><a href="#bookmark1705" class="a">Google Coral USB Accelerator</a><a href="#bookmark1705" class="s208">, </a><a href="#bookmark1705">Speeding Up with the Google Coral USB Accelerator</a></p><p class="s3" style="padding-top: 12pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">V</p><p style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark276" class="s208">validation accuracy, </a><a href="#bookmark276">Start Training</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1877" class="s208">value function (V), </a><a href="#bookmark1877">Practical Deep Reinforcement Learning with DeepRacer</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1921" class="s208">value-based reinforcement learning, </a><a href="#bookmark1921">Value based</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1927" class="s208">vanilla policy gradient algorithm, </a><a href="#bookmark1927">Reinforcement Learning Algorithm in AWS DeepRacer</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark742" class="s208">versioning, </a>Training<a href="#bookmark774" class="s208">, </a>Data<a href="#bookmark988" class="s208">, </a>Model Versioning <a href="#bookmark771" class="s208">video datasets, </a><a href="#bookmark771">Data</a></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1498" class="s208">video segmentation, </a><a href="#bookmark1498">Real-Time Video Segmentation in YouTube Stories</a></p><p style="padding-top: 14pt;padding-left: 22pt;text-indent: -15pt;line-height: 157%;text-align: left;"><a href="#bookmark861" class="s208">visual recognition APIs (see also computer vision) accuracy, </a><a href="#bookmark861">Accuracy</a></p><p class="s2" style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark832" class="s208">available APIs, </a>The Landscape of Visual Recognition APIs<a href="#bookmark851" class="s208">- </a><a href="#bookmark851">What’s unique about this API?</a></p><p class="s2" style="padding-top: 14pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark864" class="s208">bias, </a>Bias<a href="#bookmark870" class="s208">-</a>Bias <a href="#bookmark858" class="s208">cost, </a><a href="#bookmark858">Cost</a></p><p class="s2" style="padding-left: 6pt;text-indent: 15pt;line-height: 209%;text-align: left;"><a href="#bookmark855" class="s208">service offerings, </a>Service Offerings <a href="#bookmark764" class="s208">VisualData.io, </a><a href="#bookmark764">Data</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;">visualizations</p><p class="s2" style="padding-top: 9pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark741" class="s208">real-time for training process, </a>Training <a href="#bookmark1147" class="s208">using GAN Lab, </a><a href="#bookmark1147">GAN Lab</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark347" class="s208">using t-SNE algorithm, </a><a href="#bookmark347">Visualizing Image Clusters with t-</a></p><p class="s2" style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark347" class="a">SNE</a><a href="#bookmark355" class="s208">-</a><a href="#bookmark347" class="a">V</a>isualizing Image Clusters with t-SNE <a href="#bookmark471" class="s208">using TensorBoard, </a>TensorBoard<a href="#bookmark476" class="s208">-</a><a href="#bookmark476">What-If Tool</a></p><p style="padding-left: 22pt;text-indent: 0pt;line-height: 17pt;text-align: left;"><a href="#bookmark608" class="s208">using TensorFlow profiler, </a><a href="#bookmark608">TensorFlow Profiler +</a></p><p style="padding-top: 3pt;padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark608">TensorBoard</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark485" class="s208">using tf-explain, </a><a href="#bookmark485">tf-explain</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-left: 22pt;text-indent: 0pt;text-align: left;"><a href="#bookmark476" class="s208">using What-If Tool, </a>What-If Tool<a href="#bookmark482" class="s208">-</a><a href="#bookmark482">What-If Tool</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">W</p><p style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1763" class="s208">Waymo, </a><a href="#bookmark1763">Deep Learning, Autonomous Driving, and the Data Problem</a></p><p class="s2" style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1319" class="s208">web UI-based tools, </a>Approach 1: Use Web UI-based Tools<a href="#bookmark1326" class="s208">- </a><a href="#bookmark1326">Approach 1: Use Web UI-based Tools</a></p><p style="padding-top: 14pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark759" class="s208">WebScraper.io, </a><a href="#bookmark759">Data</a></p><p class="s2" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark114" class="s208">weights, </a>Model Architecture <a href="#bookmark742" class="s208">Weights and Biases, </a><a href="#bookmark742">Training</a></p><p class="s2" style="padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark463" class="s208">What-If Tool, </a>Tools of the Trade<a href="#bookmark476" class="s208">, </a>What-If Tool<a href="#bookmark482" class="s208">-</a>What-If Tool <a href="#bookmark1635" class="s208">wildlife conservation, </a><a href="#bookmark1635">Wildlife conservation</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 15pt;text-align: left;">X</p><p class="s2" style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;line-height: 209%;text-align: left;"><a href="#bookmark1218" class="s208">Xcode, </a>Building a Real-Time Object Recognition App <a href="#bookmark1686" class="s208">Xilinx Zynq chips, </a><a href="#bookmark1686">FPGA + PYNQ</a></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 15pt;text-align: left;">Y</p><p style="padding-top: 8pt;padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark770" class="s208">YFCC100M, </a><a href="#bookmark770">Data</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1276" class="s208">YoPuppet, </a><a href="#bookmark1276">InstaSaber + YoPuppet</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;line-height: 122%;text-align: left;"><a href="#bookmark1498" class="s208">YouTube Stories, </a><a href="#bookmark1498">Real-Time Video Segmentation in YouTube Stories</a></p><p class="s3" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">About the Authors Primary Authors</p><p class="s1" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><b>Anirudh Koul </b>is a noted AI expert, a UN/TEDx speaker, and a former senior scientist at Microsoft AI &amp; Research, where he founded Seeing AI, often considered the most used technology among the blind community after the iPhone. Anirudh serves as the head of AI &amp; Research at Aira, recognized by <i>Time </i>magazine as one of the best inventions of 2018. With features shipped to a billion users, he brings over a decade of production-oriented applied research experience on petabyte-scale datasets. He has been developing technologies using AI techniques for augmented reality, robotics, speech, and productivity as well as accessibility. His work with AI for Good, which IEEE has called “life-changing,” has received awards from CES, FCC, MIT, Cannes Lions, and the American Council of the Blind; been showcased at events by UN, World Economic Forum, White House, House of Lords, Netflix, and National Geographic; and lauded by world leaders including Justin Trudeau and Theresa May.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><b>Siddha Ganju</b>, an AI researcher who <i>Forbes </i>featured in its “30 under 30” list, is a self-driving architect at Nvidia. As an AI advisor to NASA FDL, she helped build an automated meteor detection pipeline for the CAMS project at NASA, which discovered a comet. Previously at Deep Vision, she developed deep learning models for resource constraint edge devices. Her work ranges from visual question answering to generative adversarial networks to gathering insights from CERN’s petabyte-scale data and has been published at top-tier conferences including CVPR and NeurIPS. She has served as a featured jury member in several international tech competitions including CES. As an advocate for diversity and inclusion in technology, she speaks at schools and colleges to motivate and grow a new generation of technologists from all backgrounds.</p><p class="s3" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Meher Kasam <span class="s1">is a seasoned software developer with apps used by tens of millions of users every day. Currently an iOS developer at Square, and having previously worked at Microsoft and Amazon, he has shipped features for a range of apps from</span></p><p class="s1" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Square’s Point of Sale to the Bing iPhone app. During his time at Microsoft, he was the mobile development lead for the Seeing AI app, which has received widespread recognition and awards from Mobile World Congress, CES, FCC, and the American Council of the Blind, to name a few. A hacker at heart with a flair for fast prototyping, he’s won several hackathons and converted them to features shipped in widely used products. He also serves as a judge of international competitions including Global Mobile Awards and Edison Awards.</p><p class="s3" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Guest Authors Chapter 17</p><p class="s3" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Sunil Mallya <span class="s1">is a principal deep learning scientist at AWS focused on deep learning and reinforcement learning at AWS. Sunil works with AWS customers in various transformation and innovation initiatives across verticals by building models for cutting edge machine learning applications. He also led the science development for AWS DeepRacer. Prior to joining AWS, Sunil cofounded the neuroscience and machine learning–based image analysis and video thumbnail recommendation company Neon Labs. He has worked on building large-scale low-latency systems at Zynga and has an acute passion for serverless computing. He holds a master’s degree in computer science from Brown University.</span></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 16pt;text-align: left;">Chapter 16</p><p class="s3" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Aditya Sharma <a href="https://oreil.ly/CUU1v" class="s6" target="_blank">is a program manager at Microsoft where he works on the Azure Autonomous Driving team. His work focuses on helping autonomous driving companies scale their operations by leveraging the power of the cloud, greatly reducing their time to market. He is the lead PM for Project Road Runner, the team behind the </a><span class="s210">Autonomous Driving Cookbook</span><span class="s1">. He also leads the Deep Learning and Robotics chapter at the Microsoft Garage.</span></p><p class="s1" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Aditya holds a graduate degree from the Robotics Institute at Carnegie Mellon University.</p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 16pt;text-align: left;">Chapter 16</p><p class="s3" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Mitchell Spryn <span class="s1">graduated from the University of Alabama with a dual bachelor’s degree in electrical engineering and physics.</span></p><p class="s210" style="padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;"><a href="https://oreil.ly/CUU1v" class="s6" target="_blank">While at the university, Mitchell was involved in a variety of research projects ranging from wireless power transfer to autonomous robotics. He currently works at Microsoft as a data scientist, specializing in distributed relational databases. In addition to his work on databases, Mitchell continues to contribute to projects in the robotics space such as the AirSim simulator and the </a>Autonomous Driving Cookbook<span style=" color: #000;">.</span></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 16pt;text-align: left;">Chapter 15</p><p class="s3" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Sam Sterckval<span class="s1">, a Belgium-based electronics engineer, discovered his second passion (besides electronics) during his time in college — artificial intelligence. After graduation, Sam cofounded the company Edgise to combine these two passions — to bring artificial intelligence to the edge by designing custom hardware that can efficiently run complex AI models. Often considered the go-to person for edge AI in Belgium, Sam helps companies to build cognitive solutions that highly depend on low latency, privacy, and cost-effectiveness.</span></p><p class="s3" style="padding-left: 6pt;text-indent: 0pt;line-height: 16pt;text-align: left;">Chapter 10</p><p class="s3" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Zaid Alyafeai <a href="https://oreil.ly/TW_kA" class="s6" target="_blank">is known for his popular blogs and Google Colab Notebooks on TensorFlow.js and using deep learning within the browser to power interesting scenarios. He is also a writer for the official TensorFlow blog on Medium, with many GitHub projects with more than 1000 stars combined. When he is not building fancy web applications, he is conducting research in AI as a PhD student at KFUPM in Saudi Arabia. A teacher at heart, he also wrote a </a><span class="s210">reference book on advanced integration techniques</span><span class="s1">.</span></p><p class="s3" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Colophon</p><p class="s1" style="padding-top: 6pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">The animal on the cover of <i>Practical Deep Learning for Cloud, Mobile, and Edge </i>is the American peregrine falcon (<i>Falco peregrinus anatum</i>) or duck hawk, a subspecies of peregrine falcon, which is currently found in the Rocky Mountains. This subspecies has become extinct in eastern North America, but healthy hybrid populations now exist due to organized reintroductions.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Peregrine falcons worldwide, no matter the subspecies, share the characteristics of being a large, fast-flying bird of prey with a dark head and wings; pale, patterned undersides; yellow beak and legs; and large eyes set in a distinctive vertical stripe of eyeblack. Falcons can be discerned at a distance by their “bent” but otherwise sharply outlined wings. Females are noticeably larger than males, but both average about the size of an American crow, and make a distinctive, sharp, “kak kak kak” call when defending territory or nestlings.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Peregrines (named for their far-wandering habits outside nesting season) have established themselves on all continents except Antarctica. Their species success lies with their many adaptations for hunting birds, as well as their ability to adapt to varying nesting environments and prey. The best-known habit of the peregrine falcon is its hunting stoop or high-speed dive, in which it dives from a great height into a bird on or near the ground, reaching speeds of up to 200 mph by the time it crashes into its prey, many times killing it instantly. This makes it not only the fastest bird on earth, but the fastest member of the animal kingdom, and is why the peregrine is a favorite bird of falconers around the world.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">Peregrine falcons became a visible symbol of the US environmental movement in the 1960s, as widespread use of the pesticide DDT extirpated the birds across much of their former range before the chemical was banned (the birds consumed DDT through their prey, which had the effect of lethally thinning the shells of the falcon’s eggs). The US Environmental Protection Agency declared this falcon an endangered species in 1970.</p><p class="s1" style="padding-left: 6pt;text-indent: 0pt;line-height: 17pt;text-align: left;">However, the species has recovered due to the ban on DDT,</p><p class="s1" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">followed by a captive breeding program that reintroduced the species into their former range in the eastern US. With nest boxes added into the upper reaches of city skyscrapers, populations quickly became established, as the falcons raised their chicks on pigeons and other plentiful urban birds. The peregrine falcon was removed from the Endangered Species list in 1999. While the American peregrine falcon’s current conservation status is now designated as of Least Concern, many of the animals on O’Reilly covers are endangered; all of them are important to the world.</p><p class="s1" style="padding-top: 5pt;padding-left: 6pt;text-indent: 0pt;line-height: 109%;text-align: left;">The cover illustration is by Karen Montgomery, based on a black and white engraving from <i>British Birds</i>. The cover fonts are Gilroy Semibold and Guardian Sans. The text font is Adobe Minion Pro; the heading font is Adobe Myriad Condensed; and the code font is Dalton Maag’s Ubuntu Mono.</p><p style="padding-top: 3pt;padding-left: 59pt;text-indent: 0pt;text-align: left;"><a href="#bookmark14" class="s209">Preface</a></p><p style="padding-top: 6pt;padding-left: 89pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark16" class="s209">To the Backend/Frontend/Mobile Software Developer To the Data Scientist</a></p><p style="padding-left: 89pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark18" class="s209">To the Student To the Teacher</a></p><p style="padding-left: 89pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark20" class="s209">To the Robotics Enthusiast </a><a href="#bookmark21" class="s209">What to Expect in Each Chapter </a><a href="#bookmark23" class="s209">Conventions Used in This Book Using Code Examples</a></p><p style="padding-left: 89pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark26" class="s209">O’Reilly Online Learning How to Contact Us</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark28" class="s209">Acknowledgments</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark30" class="s209">Group Acknowledgments Personal Acknowledgments</a></p><ol id="l62"><li><p style="padding-left: 89pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark58" class="s209">Exploring the Landscape of Artificial </a><a href="#bookmark60" class="s209">Intelligence An Apology</a></p><p style="padding-top: 8pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark62" class="s209">The Real Introduction</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark64" class="s209">What Is AI?</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark70" class="s209">Motivating Examples</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark76" class="s209">A Brief History of AI Exciting Beginnings</a></p><p style="padding-top: 8pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark82" class="s209">The Cold and Dark Days A Glimmer of Hope</a></p><p style="padding-top: 3pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark92" class="s209">How Deep Learning Became a Thing</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark104" class="s209">Recipe for the Perfect Deep Learning Solution Datasets</a></p><p style="padding-top: 9pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark116" class="s209">Model Architecture </a><a href="#bookmark125" class="s209">Frameworks Hardware</a></p><p style="padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark132" class="s209">Responsible AI Bias</a></p><p style="padding-top: 9pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark144" class="s209">Accountability and Explainability Reproducibility</a></p><p style="padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark148" class="s209">Robustness Privacy</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark151" class="s209">Summary</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark152" class="s209">Frequently Asked Questions</a></p></li><li><p style="padding-top: 15pt;padding-left: 89pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark166" class="s209">What’s in the Picture: Image Classification with </a><a href="#bookmark168" class="s209">Keras Introducing Keras</a></p><p style="padding-top: 9pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark170" class="s209">Predicting an Image’s Category</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark185" class="s209">Investigating the Model ImageNet Dataset</a></p><p style="padding-top: 8pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark194" class="s209">Model Zoos</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 30pt;line-height: 187%;text-align: left;"><a href="#bookmark203" class="s209">Class Activation Maps Summary</a></p></li><li><p style="padding-top: 3pt;padding-left: 59pt;text-indent: 0pt;text-align: left;"><a href="#bookmark227" class="s209">Cats Versus Dogs: Transfer Learning in 30 Lines with Keras</a></p><p style="padding-top: 6pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark229" class="s209">Adapting Pretrained Models to New Tasks</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark231" class="s209">A Shallow Dive into Convolutional Neural Networks</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark239" class="s209">Transfer Learning Fine Tuning</a></p><p style="padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark242" class="s209">How Much to Fine Tune</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark245" class="s209">Building a Custom Classifier in Keras with Transfer Learning</a></p><p style="padding-left: 89pt;text-indent: 0pt;line-height: 32pt;text-align: left;"><a href="#bookmark251" class="s209">Organize the Data Build the Data Pipeline</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark256" class="s209">Number of Classes Batch Size</a></p><p style="padding-left: 89pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark266" class="s209">Data Augmentation Model Definition</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark268" class="s209">Train the Model</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark275" class="s209">Set Training Parameters Start Training</a></p><p style="padding-left: 89pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark282" class="s209">Test the Model </a><a href="#bookmark291" class="s209">Analyzing the Results </a><a href="#bookmark296" class="s209">Further Reading Summary</a></p></li><li><p style="padding-left: 59pt;text-indent: 0pt;text-align: left;"><a href="#bookmark323" class="s209">Building a Reverse Image Search Engine: Understanding Embeddings</a></p><p style="padding-top: 3pt;padding-left: 89pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark332" class="s209">Image Similarity </a><a href="#bookmark337" class="s209">Feature Extraction Similarity Search</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark346" class="s209">Visualizing Image Clusters with t-SNE</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark359" class="s209">Improving the Speed of Similarity Search Length of Feature Vectors</a></p><p style="padding-top: 8pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark365" class="s209">Reducing Feature-Length with PCA</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark373" class="s209">Scaling Similarity Search with Approximate Nearest Neighbors</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark378" class="s209">Approximate Nearest-Neighbor Benchmark Which Library Should I Use?</a></p><p style="padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark383" class="s209">Creating a Synthetic Dataset Brute Force</a></p><p style="padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark388" class="s209">Annoy NGT</a></p><p style="padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark390" class="s209">Faiss</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark393" class="s209">Improving Accuracy with Fine Tuning</a></p><p style="padding-top: 6pt;padding-left: 89pt;text-indent: 30pt;line-height: 187%;text-align: left;"><a href="#bookmark402" class="s209">Fine Tuning Without Fully Connected Layers Siamese Networks for One-Shot Face Verification</a></p><p style="padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark410" class="s209">Case Studies Flickr</a></p><p style="padding-top: 8pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark413" class="s209">Pinterest</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark416" class="s209">Celebrity Doppelgangers</a></p><p style="padding-top: 3pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark419" class="s209">Spotify</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 30pt;line-height: 187%;text-align: left;"><a href="#bookmark429" class="s209">Image Captioning Summary</a></p></li><li><p style="padding-left: 59pt;text-indent: 0pt;text-align: left;"><a href="#bookmark458" class="s209">From Novice to Master Predictor: Maximizing Convolutional Neural Network Accuracy</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark461" class="s209">Tools of the </a><a href="#bookmark468" class="s209">Trade TensorFlow Datasets</a></p><p style="padding-top: 9pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark475" class="s209">TensorBoard What-If </a><a href="#bookmark484" class="s209">Tool tf-explain</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark488" class="s209">Common Techniques for Machine Learning Experimentation</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark490" class="s209">Data Inspection</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark495" class="s209">Breaking the Data: Train, Validation, Test Early Stopping</a></p><p style="padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark497" class="s209">Reproducible Experiments</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark502" class="s209">End-to-End Deep Learning Example Pipeline Basic Transfer Learning Pipeline</a></p><p style="padding-top: 8pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark504" class="s209">Basic Custom Network Pipeline</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark506" class="s209">How Hyperparameters Affect Accuracy</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark508" class="s209">Transfer Learning Versus Training from Scratch</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark511" class="s209">Effect of Number of Layers Fine-Tuned in Transfer Learning</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark514" class="s209">Effect of Data Size on Transfer Learning</a></p><p style="padding-top: 3pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark520" class="s209">Effect of Learning Rate </a><a href="#bookmark523" class="s209">Effect of Optimizers </a><a href="#bookmark526" class="s209">Effect of Batch Size Effect of Resizing</a></p><p style="padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark529" class="s209">Effect of Change in Aspect Ratio on Transfer Learning</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark535" class="s209">Tools to Automate Tuning for Maximum Accuracy Keras Tuner</a></p><p style="padding-top: 8pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark541" class="s209">AutoAugment AutoKeras</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark545" class="s209">Summary</a></p></li><li><p style="padding-top: 15pt;padding-left: 59pt;text-indent: 0pt;text-align: left;"><a href="#bookmark599" class="s209">Maximizing Speed and Performance of TensorFlow: A Handy Checklist</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark603" class="s209">GPU Starvation nvidia-smi</a></p><p style="padding-top: 9pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark607" class="s209">TensorFlow Profiler + TensorBoard</a></p><p style="padding-left: 89pt;text-indent: 0pt;line-height: 32pt;text-align: left;"><a href="#bookmark613" class="s209">How to Use This Checklist Performance Checklist</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark616" class="s209">Data Preparation Data Reading</a></p><p style="padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark618" class="s209">Data Augmentation Training</a></p><p style="padding-left: 89pt;text-indent: 30pt;line-height: 187%;text-align: left;"><a href="#bookmark620" class="s209">Inference Data Preparation</a></p><p style="padding-top: 3pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark624" class="s209">Store as TFRecords </a><a href="#bookmark626" class="s209">Reduce Size of Input Data Use TensorFlow Datasets</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark629" class="s209">Data Reading</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark634" class="s209">Use tf.data Prefetch Data</a></p><p style="padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark639" class="s209">Parallelize CPU Processing </a><a href="#bookmark642" class="s209">Parallelize I/O and Processing </a><a href="#bookmark644" class="s209">Enable Nondeterministic Ordering Cache Data</a></p><p style="padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark653" class="s209">Turn on Experimental Optimizations Autotune Parameter Values</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark656" class="s209">Data Augmentation</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark658" class="s209">Use GPU for Augmentation</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark663" class="s209">Training</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark667" class="s209">Use Automatic Mixed Precision Use Larger Batch Size</a></p><p style="padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark670" class="s209">Use Multiples of Eight</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark676" class="s209">Find the Optimal Learning Rate Use tf.function</a></p><p style="padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark678" class="s209">Overtrain, and Then Generalize</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark686" class="s209">Install an Optimized Stack for the Hardware</a></p><p style="padding-top: 3pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark691" class="s209">Optimize the Number of Parallel CPU Threads Use Better Hardware</a></p><p style="padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark693" class="s209">Distribute Training</a></p><p style="padding-left: 89pt;text-indent: 30pt;line-height: 32pt;text-align: left;"><a href="#bookmark703" class="s209">Examine Industry Benchmarks Inference</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark709" class="s209">Use an Efficient Model </a><a href="#bookmark713" class="s209">Quantize the Model Prune the Model</a></p><p style="padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark718" class="s209">Use Fused Operations Enable GPU Persistence</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark721" class="s209">Summary</a></p></li><li><p style="padding-top: 15pt;padding-left: 89pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark730" class="s209">Practical Tools, Tips, and </a><a href="#bookmark732" class="s209">Tricks Installation</a></p><p style="padding-top: 8pt;padding-left: 89pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark748" class="s209">Training </a><a href="#bookmark754" class="s209">Model </a><a href="#bookmark777" class="s209">Data Privacy</a></p><p style="padding-left: 89pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark789" class="s209">Education and Exploration One Last Question</a></p></li><li><p style="padding-left: 59pt;text-indent: 0pt;text-align: left;"><a href="#bookmark828" class="s209">Cloud APIs for Computer Vision: Up and Running in 15 Minutes</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark833" class="s209">The Landscape of Visual Recognition APIs Clarifai</a></p><p style="padding-top: 3pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark839" class="s209">Microsoft Cognitive Services </a><a href="#bookmark842" class="s209">Google Cloud Vision Amazon Rekognition</a></p><p style="padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark848" class="s209">IBM Watson Visual Recognition Algorithmia</a></p><p style="padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark854" class="s209">Comparing Visual Recognition APIs Service Offerings</a></p><p style="padding-top: 9pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark860" class="s209">Cost </a><a href="#bookmark863" class="s209">Accuracy Bias</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark871" class="s209">Getting Up and Running with Cloud APIs</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark874" class="s209">Training Our Own Custom Classifier</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark883" class="s209">Top Reasons Why Our Classifier Does Not Work Satisfactorily</a></p><p style="padding-left: 89pt;text-indent: 0pt;line-height: 32pt;text-align: left;"><a href="#bookmark890" class="s209">Comparing Custom Classification APIs Performance Tuning for Cloud APIs</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark897" class="s209">Effect of Resizing on Image Labeling APIs </a><a href="#bookmark899" class="s209">Effect of Compression on Image Labeling APIs Effect of Compression on OCR APIs</a></p><p style="padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark901" class="s209">Effect of Resizing on OCR APIs</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark903" class="s209">Case Studies</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark907" class="s209">The New York Times Uber</a></p><p style="padding-top: 3pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark912" class="s209">Giphy </a><a href="#bookmark914" class="s209">OmniEarth </a><a href="#bookmark916" class="s209">Photobucket Staples</a></p><p style="padding-left: 89pt;text-indent: 30pt;line-height: 187%;text-align: left;"><a href="#bookmark923" class="s209">InDro Robotics Summary</a></p></li><li><p style="padding-left: 59pt;text-indent: 0pt;text-align: left;"><a href="#bookmark955" class="s209">Scalable Inference Serving on Cloud with TensorFlow Serving and KubeFlow</a></p><p style="padding-top: 6pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark957" class="s209">Landscape of Serving AI Predictions</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark963" class="s209">Flask: Build Your Own Server Making a REST API with Flask</a></p><p style="padding-top: 8pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark968" class="s209">Deploying a Keras Model to Flask Pros of Using Flask</a></p><p style="padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark969" class="s209">Cons of Using Flask</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark971" class="s209">Desirable Qualities in a Production-Level Serving System</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark976" class="s209">High Availability Scalability</a></p><p style="padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark980" class="s209">Low Latency </a><a href="#bookmark983" class="s209">Geographic Availability </a><a href="#bookmark985" class="s209">Failure Handling Monitoring</a></p><p style="padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark987" class="s209">Model Versioning</a></p><p style="padding-top: 3pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark989" class="s209">A/B Testing</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark991" class="s209">Support for Multiple Machine Learning Libraries</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;text-align: justify;"><a href="#bookmark994" class="s209">Google Cloud ML Engine: A Managed Cloud AI Serving Stack</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: justify;"><a href="#bookmark999" class="s209">Pros of Using Cloud ML Engine </a><a href="#bookmark1000" class="s209">Cons of Using Cloud ML Engine Building a Classification API</a></p><p style="padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark1013" class="s209">TensorFlow Serving Installation</a></p><p style="padding-top: 8pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1014" class="s209">KubeFlow</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1022" class="s209">Pipelines </a><a href="#bookmark1025" class="s209">Fairing Installation</a></p><p style="padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark1032" class="s209">Price Versus Performance Considerations Cost Analysis of Inference-as-a-Service</a></p><p style="padding-top: 9pt;padding-left: 89pt;text-indent: 30pt;line-height: 187%;text-align: left;"><a href="#bookmark1037" class="s209">Cost Analysis of Building Your Own Stack Summary</a></p></li><li><p style="padding-left: 84pt;text-indent: -25pt;text-align: left;"><a href="#bookmark1065" class="s209">AI in the Browser with TensorFlow.js and ml5.js</a></p><p style="padding-top: 6pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1068" class="s209">JavaScript-Based Machine Learning Libraries: A Brief History</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1074" class="s209">ConvNetJS </a><a href="#bookmark1076" class="s209">Keras.js ONNX.js</a></p><p style="padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1080" class="s209">TensorFlow.js</a></p><p style="padding-top: 3pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1084" class="s209">TensorFlow.js Architecture</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1090" class="s209">Running Pretrained Models Using TensorFlow.js Model Conversion for the Browser</a></p><p style="padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark1095" class="s209">Training in the Browser Feature Extraction</a></p><p style="padding-top: 8pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1098" class="s209">Data Collection Training</a></p><p style="padding-left: 89pt;text-indent: 30pt;line-height: 187%;text-align: left;"><a href="#bookmark1104" class="s209">GPU Utilization ml5.js</a></p><p style="padding-left: 89pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1111" class="s209">PoseNet pix2pix</a></p><p style="padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark1124" class="s209">Benchmarking and Practical Considerations Model Size</a></p><p style="padding-top: 8pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1126" class="s209">Inference Time</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1131" class="s209">Case Studies</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1136" class="s209">Semi-Conductor </a><a href="#bookmark1139" class="s209">TensorSpace Metacar</a></p><p style="padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1144" class="s209">Airbnb’s Photo Classification GAN Lab</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1149" class="s209">Summary</a></p></li><li><p style="padding-top: 15pt;padding-left: 83pt;text-indent: -23pt;text-align: left;"><a href="#bookmark1183" class="s209">Real-Time Object Classification on iOS with Core ML</a></p><p style="padding-top: 3pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1190" class="s209">The Development Life Cycle for Artificial Intelligence on Mobile</a></p><p style="padding-left: 89pt;text-indent: 0pt;line-height: 32pt;text-align: left;"><a href="#bookmark1196" class="s209">A Brief History of Core ML Alternatives to Core ML</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1201" class="s209">TensorFlow Lite ML Kit</a></p><p style="padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1203" class="s209">Fritz</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark1208" class="s209">Apple’s Machine Learning Architecture Domain-Based Frameworks</a></p><p style="padding-top: 8pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1210" class="s209">ML Framework</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1211" class="s209">ML Performance Primitives</a></p><p style="padding-left: 89pt;text-indent: 0pt;line-height: 32pt;text-align: left;"><a href="#bookmark1225" class="s209">Building a Real-Time Object Recognition App Conversion to Core ML</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1229" class="s209">Conversion from Keras Conversion from TensorFlow</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1232" class="s209">Dynamic Model Deployment</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark1236" class="s209">On-Device Training Federated Learning</a></p><p style="padding-top: 8pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1238" class="s209">Performance Analysis</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1240" class="s209">Benchmarking Models on iPhones</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark1251" class="s209">Measuring Energy Impact Benchmarking Load</a></p><p style="padding-top: 8pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1256" class="s209">Reducing App Size</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1258" class="s209">Avoid Bundling the Model</a></p><p style="padding-top: 3pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1262" class="s209">Use Quantization Use Create ML</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1265" class="s209">Case Studies</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1270" class="s209">Magic Sudoku </a><a href="#bookmark1272" class="s209">Seeing AI HomeCourt</a></p><p style="padding-left: 89pt;text-indent: 30pt;line-height: 187%;text-align: left;"><a href="#bookmark1280" class="s209">InstaSaber + YoPuppet Summary</a></p></li><li><p style="padding-left: 89pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark1295" class="s209">Not Hotdog on iOS with Core ML and Create </a><a href="#bookmark1301" class="s209">ML Collecting Data</a></p><p style="padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1306" class="s209">Approach 1: Find or Collect a Dataset Approach 2: Fatkun Chrome Browser Extension</a></p><p style="padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1312" class="s209">Approach 3: Web Scraper Using Bing Image Search API</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1316" class="s209">Training Our Model</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1327" class="s209">Approach 1: Use Web UI-based Tools </a><a href="#bookmark1337" class="s209">Approach 2: Use Create ML Approach 3: Fine Tuning Using Keras</a></p><p style="padding-left: 89pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1343" class="s209">Model Conversion Using Core ML Tools Building the iOS App</a></p><p style="padding-left: 89pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1348" class="s209">Further Exploration Summary</a></p></li><li><p style="padding-left: 59pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1389" class="s209">Shazam for Food: Developing Android Apps with TensorFlow Lite and ML Kit</a></p><p style="padding-top: 3pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1394" class="s209">The Life Cycle of a Food Classifier App</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark1400" class="s209">An Overview of TensorFlow Lite TensorFlow Lite Architecture</a></p><p style="padding-top: 9pt;padding-left: 89pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1406" class="s209">Model Conversion to TensorFlow Lite Building a Real-Time Object Recognition App</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1421" class="s209">ML Kit + Firebase</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1427" class="s209">Object Classification in ML Kit </a><a href="#bookmark1429" class="s209">Custom Models in ML Kit Hosted Models</a></p><p style="padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1446" class="s209">A/B Testing Hosted Models Using the Experiment in Code</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1448" class="s209">TensorFlow Lite on iOS</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1450" class="s209">Performance Optimizations</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1454" class="s209">Quantizing with TensorFlow Lite Converter TensorFlow Model Optimization Toolkit</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1457" class="s209">Fritz</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1461" class="s209">A Holistic Look at the Mobile AI App Development Cycle</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1466" class="s209">How Do I Collect Initial Data? How Do I Label My Data?</a></p><p style="padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1468" class="s209">How Do I Train My Model?</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1470" class="s209">How Do I Convert the Model to a Mobile-Friendly Format?</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1471" class="s209">How Do I Make my Model Performant?</a></p><p style="padding-top: 3pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1472" class="s209">How Do I Build a Great UX for My Users?</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1473" class="s209">How Do I Make the Model Available to My Users?</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1476" class="s209">How Do I Measure the Success of My Model? How Do I Improve My Model?</a></p><p style="padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1478" class="s209">How Do I Update the Model on My Users’ Phones?</a></p><p style="padding-left: 89pt;text-indent: 0pt;line-height: 32pt;text-align: left;"><a href="#bookmark1484" class="s209">The Self-Evolving Model Case Studies</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;text-align: justify;"><a href="#bookmark1486" class="s209">Lose It!</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: justify;"><a href="#bookmark1492" class="s209">Portrait Mode on Pixel 3 Phones </a><a href="#bookmark1494" class="s209">Speaker Recognition by Alibaba Face Contours in ML Kit</a></p><p style="padding-left: 119pt;text-indent: 0pt;text-align: justify;"><a href="#bookmark1497" class="s209">Real-Time Video Segmentation in YouTube Stories</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1501" class="s209">Summary</a></p></li><li><p style="padding-top: 15pt;padding-left: 59pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1540" class="s209">Building the Purrfect Cat Locator App with TensorFlow Object Detection API</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark1544" class="s209">Types of Computer-Vision Tasks Classification</a></p><p style="padding-top: 9pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1548" class="s209">Localization </a><a href="#bookmark1551" class="s209">Detection Segmentation</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1557" class="s209">Approaches to Object Detection</a></p><p style="padding-top: 3pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1560" class="s209">Invoking Prebuilt Cloud-Based Object Detection APIs</a></p><p style="padding-top: 15pt;padding-left: 69pt;text-indent: 0pt;line-height: 135%;text-align: center;"><a href="#bookmark1567" class="s209">Reusing a Pretrained Model Obtaining the Model</a></p><p style="padding-top: 9pt;padding-left: 124pt;text-indent: 0pt;line-height: 187%;text-align: center;"><a href="#bookmark1571" class="s209">Test Driving Our Model Deploying to a Device</a></p><p style="padding-left: 52pt;text-indent: 0pt;text-align: center;"><a href="#bookmark1574" class="s209">Building a Custom Detector Without Any Code</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark1588" class="s209">The Evolution of Object Detection Performance Considerations</a></p><p style="padding-top: 8pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark1594" class="s209">Key Terms in Object Detection Intersection over Union</a></p><p style="padding-top: 8pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1600" class="s209">Mean Average Precision Non-Maximum Suppression</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1604" class="s209">Using the TensorFlow Object Detection API to Build Custom Models</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1610" class="s209">Data Collection </a><a href="#bookmark1615" class="s209">Labeling the Data Preprocessing the Data</a></p><p style="padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark1620" class="s209">Inspecting the Model Training</a></p><p style="padding-top: 8pt;padding-left: 89pt;text-indent: 30pt;line-height: 187%;text-align: left;"><a href="#bookmark1624" class="s209">Model Conversion Image Segmentation</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1628" class="s209">Case Studies</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1633" class="s209">Smart Refrigerator Crowd Counting</a></p><p style="padding-top: 3pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1641" class="s209">Face Detection in Seeing AI Autonomous Cars</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1644" class="s209">Summary</a></p></li><li><p style="padding-top: 15pt;padding-left: 59pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1666" class="s209">Becoming a Maker: Exploring Embedded AI at the Edge</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark1672" class="s209">Exploring the Landscape of Embedded AI Devices Raspberry Pi</a></p><p style="padding-top: 9pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1679" class="s209">Intel Movidius Neural Compute Stick </a><a href="#bookmark1682" class="s209">Google Coral USB Accelerator NVIDIA Jetson Nano</a></p><p style="padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1685" class="s209">FPGA + PYNQ</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1690" class="s209">Arduino</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1701" class="s209">A Qualitative Comparison of Embedded AI Devices Hands-On with the Raspberry Pi</a></p><p style="padding-left: 89pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1708" class="s209">Speeding Up with the Google Coral USB Accelerator Port to NVIDIA Jetson Nano</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1711" class="s209">Comparing the Performance of Edge Devices</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1714" class="s209">Case Studies</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1716" class="s209">JetBot</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1724" class="s209">Squatting for Metro Tickets Cucumber Sorter</a></p><p style="padding-left: 89pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1730" class="s209">Further Exploration Summary</a></p></li><li><p style="padding-top: 3pt;padding-left: 59pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1751" class="s209">Simulating a Self-Driving Car Using End-to-End Deep Learning with Keras</a></p><p style="padding-top: 6pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1755" class="s209">A Brief History of Autonomous Driving</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1758" class="s209">Deep Learning, Autonomous Driving, and the Data Problem</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1768" class="s209">The “Hello, World!” of Autonomous Driving: Steering Through a Simulated Environment</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1770" class="s209">Setup and Requirements</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark1778" class="s209">Data Exploration and Preparation Identifying the Region of Interest</a></p><p style="padding-top: 9pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1782" class="s209">Data Augmentation</a></p><p style="padding-left: 89pt;text-indent: 30pt;line-height: 32pt;text-align: left;"><a href="#bookmark1792" class="s209">Dataset Imbalance and Driving Strategies Training Our Autonomous Driving Model</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1797" class="s209">Drive Data Generator Model Definition</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1803" class="s209">Deploying Our Autonomous Driving Model</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark1811" class="s209">Further Exploration Expanding Our Dataset</a></p><p style="padding-top: 8pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1814" class="s209">Training on Sequential Data Reinforcement Learning</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1817" class="s209">Summary</a></p></li><li><p style="padding-top: 15pt;padding-left: 59pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1861" class="s209">Building an Autonomous Car in Under an Hour: Reinforcement Learning with AWS DeepRacer</a></p></li></ol></li></ol><p style="padding-top: 6pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1863" class="s209">A Brief Introduction to Reinforcement Learning</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1868" class="s209">Why Learn Reinforcement Learning with an Autonomous Car?</a></p><p style="padding-top: 3pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1874" class="s209">Practical Deep Reinforcement Learning with DeepRacer</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1885" class="s209">Building Our First Reinforcement Learning Step 1: Create Model</a></p><p style="padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1901" class="s209">Step 2: Configure Training Step 3: Model Training</a></p><p style="padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1904" class="s209">Step 4: Evaluating the Performance of the Model</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1908" class="s209">Reinforcement Learning in Action</a></p><p style="padding-top: 6pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1910" class="s209">How Does a Reinforcement Learning System Learn?</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1917" class="s209">Reinforcement Learning Theory</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1926" class="s209">Reinforcement Learning Algorithm in AWS DeepRacer</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1930" class="s209">Deep Reinforcement Learning Summary with DeepRacer as an Example</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1932" class="s209">Step 5: Improving Reinforcement Learning Models</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark1940" class="s209">Racing the AWS DeepRacer Car Building the Track</a></p><p style="padding-top: 8pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1943" class="s209">AWS DeepRacer Single-Turn Track Template Running the Model on AWS DeepRacer</a></p><p style="padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1945" class="s209">Driving the AWS DeepRacer Vehicle Autonomously</a></p><p style="padding-top: 15pt;padding-left: 119pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark1953" class="s209">Further Exploration DeepRacer League</a></p><p style="padding-top: 9pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1955" class="s209">Advanced AWS DeepRacer</a></p><p style="padding-top: 3pt;padding-left: 119pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1960" class="s209">AI Driving Olympics </a><a href="#bookmark1962" class="s209">DIY Robocars Roborace</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1966" class="s209">Summary</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: -30pt;line-height: 135%;text-align: left;"><a href="#bookmark1981" class="s209">A. A Crash Course in Convolutional Neural Networks Machine Learning</a></p><p style="padding-top: 8pt;padding-left: 89pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1986" class="s209">Perceptron </a><a href="#bookmark1990" class="s209">Activation Functions </a><a href="#bookmark1993" class="s209">Neural Networks Backpropagation</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark1995" class="s209">Shortcoming of Neural Networks</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark1999" class="s209">Desired Properties of an Image Classifier Convolution</a></p><p style="padding-left: 89pt;text-indent: 0pt;text-align: left;"><a href="#bookmark2001" class="s209">Pooling</a></p><p style="padding-top: 15pt;padding-left: 89pt;text-indent: 0pt;line-height: 187%;text-align: left;"><a href="#bookmark2006" class="s209">Structure of a CNN Further Exploration</a></p><p style="padding-left: 59pt;text-indent: 0pt;text-align: left;"><a href="#bookmark2009" class="s209">Index</a></p></body></html>
